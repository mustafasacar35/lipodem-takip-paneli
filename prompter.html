<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompter + Kamera (Pro)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.08);
      --radius:14px;

      --sentA:#fef9c3;
      --sentB:#e5e7eb;
      --paren:#93c5fd;
      --quote:#a7f3d0;

      --guide: rgba(255,255,255,.55);

      /* ✅ Pro band varsayılanları (JS güncelliyor) */
      --bandTop: 38;      /* % */
      --bandBottom: 62;   /* % */
      --shadeAlpha: .55;  /* 0..0.85 */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      display:grid;
      grid-template-columns: 420px 1fr;
      grid-template-rows: 1fr;
      gap:16px;
      padding:16px;
      height:100vh;
      align-items:stretch;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
      height:100%;
      min-height:0;
      transition: opacity .15s ease;
    }

    textarea{
      width:100%;
      flex:1;
      min-height:220px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:12px;
      outline:none;
      line-height:1.4;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row label{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
      user-select:none;
    }
    input[type="range"]{ width:220px; }
    select{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      outline:none;
    }
    .val{
      font-variant-numeric:tabular-nums;
      color:var(--text);
      opacity:.9;
    }
    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.12s;
      user-select:none;
    }
    button:hover{ border-color:rgba(255,255,255,.18); }
    button.primary{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.35);
    }
    button.danger{
      background:rgba(248,113,113,.14);
      border-color:rgba(248,113,113,.28);
    }
    button.small{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .stage{
      position:relative;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
      min-width:0;
      height:100%;
      min-height:0;
      transition: filter .15s ease, background .15s ease;
    }

    /* Kamera */
    .cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
      z-index:0;
      background:#000;
    }
    .stage.camOn{ background:#000; }
    .stage.camOn .cam{ display:block; }

    /* Scrollbar */
    .viewport{
      position:absolute;
      inset:0;
      padding:48px 64px;
      overflow-y: scroll;
      overflow-x: hidden;
      scrollbar-gutter: stable;
      z-index:5;
    }

    .content{
      white-space: pre-wrap;
      font-size:42px;
      line-height:1.35;
      letter-spacing:.2px;
      text-shadow:0 2px 16px rgba(0,0,0,.45);
    }

    .sentence.sA{ color: var(--sentA); }
    .sentence.sB{ color: var(--sentB); }
    .paren{ color: var(--paren); }
    .quote{ color: var(--quote); }
    .content strong{ font-weight: 800; }
    .content em{ font-style: italic; opacity: .95; }

    .mirror .content{
      transform: scaleX(-1);
      transform-origin: center;
    }

    .topbar{
      position:absolute;
      top:12px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      pointer-events:none;
      z-index:12;
    }
    .pill{
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    .pad{ height: 0px; }

    /* Odak / karartma */
    body.dim .panel{ opacity:.18; }

    /* Metin okunurluğu için perde */
    .glass{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:4;
      background:rgba(0,0,0,.25);
      transition:opacity .12s ease;
    }
    .stage.glassOn .glass{ opacity:1; }

    /* ✅ Pro Mod: Okuma Şeridi (Band) - şerit dışını karartır */
    .bandShade{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:6;
      transition:opacity .12s ease;
      background:
        linear-gradient(to bottom,
          rgba(0,0,0,var(--shadeAlpha)) 0%,
          rgba(0,0,0,var(--shadeAlpha)) calc(var(--bandTop) * 1%),
          rgba(0,0,0,0)               calc(var(--bandTop) * 1%),
          rgba(0,0,0,0)               calc(var(--bandBottom) * 1%),
          rgba(0,0,0,var(--shadeAlpha)) calc(var(--bandBottom) * 1%),
          rgba(0,0,0,var(--shadeAlpha)) 100%);
    }
    .bandFrame{
      position:absolute;
      left:0;
      right:0;
      top:50%;
      height:20%;
      pointer-events:none;
      opacity:0;
      z-index:7;
      transition:opacity .12s ease;
      border-top:1px solid rgba(255,255,255,.22);
      border-bottom:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 22px rgba(255,255,255,.10) inset;
      background: linear-gradient(to bottom, rgba(255,255,255,.045), rgba(255,255,255,0));
    }
    .stage.bandOn .bandShade,
    .stage.bandOn .bandFrame{ opacity:1; }

    /* Vignette */
    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      z-index:8;
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,0) 30%,
          rgba(0,0,0,.35) 70%,
          rgba(0,0,0,.70) 100%);
    }
    .stage.vignetteOn .vignette{ opacity:1; }

    /* Okuma çizgisi */
    .guideLine{
      position:absolute;
      left:0;
      right:0;
      top:50%;
      height:3px;
      background:var(--guide);
      box-shadow: 0 0 18px rgba(255,255,255,.28);
      opacity:0;
      transition: opacity .12s ease;
      pointer-events:none;
      z-index:9;
    }
    .stage.guideOn .guideLine{ opacity:1; }

    /* tam ekran */
    .stage:fullscreen .viewport{ padding:72px 96px; }
    .stage:fullscreen{
      border-radius:0;
      border:none;
      background:#000;
    }

    a.dl{
      color:#c7d2fe;
      text-decoration:none;
      border:1px solid rgba(199,210,254,.25);
      padding:8px 10px;
      border-radius:10px;
      display:none;
    }
    a.dl.show{ display:inline-flex; }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; height:auto; }
      .stage{ height:60vh; min-height:60vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <strong>Prompter + Kamera (Pro)</strong>
        <span class="hint">Space: Duraklat • ↑↓: Basılı tut sar • ←→: Hız • F: Tam ekran</span>
      </div>

      <textarea id="input" placeholder="Metni buraya yapıştır..."></textarea>

      <div class="row">
        <button id="startBtn" class="primary">Başlat</button>
        <button id="pauseBtn">Duraklat</button>
        <button id="stopBtn" class="danger">Durdur</button>
        <button id="fsBtn">Tam Ekran (F)</button>
      </div>

      <div class="row">
        <label>
          Hız
          <input id="speed" type="range" min="0" max="300" step="1" value="80" />
          <span class="val" id="speedVal">80 px/sn</span>
        </label>
      </div>

      <div class="row">
        <label>
          Yazı Boyutu
          <input id="fontSize" type="range" min="20" max="80" step="1" value="42" />
          <span class="val" id="fontVal">42 px</span>
        </label>
      </div>

      <div class="row"><label><input id="altSent" type="checkbox" /> Cümleleri iki renk yap</label></div>
      <div class="row"><label><input id="parenOn" type="checkbox" /> Parantez içi mavi</label></div>
      <div class="row"><label><input id="quoteOn" type="checkbox" /> Tırnak içi renk</label></div>
      <div class="row"><label><input id="mdOn" type="checkbox" /> **Kalın** / *İtalik* (markdown)</label></div>
      <div class="row"><label><input id="dimOn" type="checkbox" /> Sol paneli soluklaştır (odak)</label></div>
      <div class="row"><label><input id="mirror" type="checkbox" /> Ayna modu</label></div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);width:100%;margin:2px 0;">

      <div class="row"><label><input id="vignetteOn" type="checkbox" /> Vignette</label></div>
      <div class="row"><label><input id="guideOn" type="checkbox" /> Okuma çizgisi</label></div>
      <div class="row"><label><input id="glassOn" type="checkbox" /> Okunurluk perdesi (kamera üstüne)</label></div>

      <!-- ✅ Pro Mod -->
      <div class="row">
        <label><input id="proMode" type="checkbox" /> Pro Mod (tek tık ayar)</label>
      </div>

      <div class="row">
        <label><input id="bandOn" type="checkbox" /> Okuma şeridi (band)</label>
      </div>

      <div class="row">
        <label>
          Band Yüksekliği
          <input id="bandH" type="range" min="10" max="50" step="1" value="24" />
          <span class="val" id="bandHVal">%24</span>
        </label>
      </div>

      <div class="row">
        <label>
          Dış Karartma
          <input id="bandShade" type="range" min="0" max="85" step="1" value="55" />
          <span class="val" id="bandShadeVal">%55</span>
        </label>
      </div>

      <div class="row">
        <label>
          Çizgi Konumu
          <input id="guidePos" type="range" min="10" max="90" step="1" value="50" />
          <span class="val" id="guidePosVal">%50</span>
        </label>
      </div>

      <div class="row">
        <label>
          Çizgi Kalınlığı
          <input id="guideThick" type="range" min="1" max="10" step="1" value="3" />
          <span class="val" id="guideThickVal">3 px</span>
        </label>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);width:100%;margin:2px 0;">

      <div class="row">
        <label><input id="camOn" type="checkbox" /> Kamera önizleme</label>
        <label>Yön:
          <select id="camFacing">
            <option value="user">Ön kamera</option>
            <option value="environment">Arka kamera</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label><input id="camAudio" type="checkbox" checked /> Ses kaydı</label>
        <button id="recBtn">Kayıt Başlat</button>
        <a id="dl" class="dl" href="#" download="kayit.webm">Kaydı indir</a>
        <button id="shareBtn" style="display:none;">Paylaş</button>
      </div>

      <div class="row">
        <button id="holdUp" class="small">▲ Yukarı (Basılı tut)</button>
        <button id="holdDown" class="small">▼ Aşağı (Basılı tut)</button>
      </div>

      <div class="hint">
        iPhone için: Kamera sadece HTTPS sayfada açılır. En iyi kullanım: Tam ekran + Pro Mod + Band.
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="topbar">
        <div class="pill" id="statusPill">Hazır</div>
        <div class="pill" id="posPill">0%</div>
      </div>

      <video id="cam" class="cam" playsinline muted></video>

      <div class="glass"></div>

      <!-- ✅ Pro overlay -->
      <div class="bandShade" id="bandShadeLayer"></div>
      <div class="bandFrame" id="bandFrame"></div>

      <div class="vignette"></div>
      <div class="guideLine" id="guideLine"></div>

      <div class="viewport" id="viewport">
        <div class="pad" id="padTop"></div>
        <div class="content" id="content"></div>
        <div class="pad" id="padBottom"></div>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById('input');
    const viewport = document.getElementById('viewport');
    const stage = document.getElementById('stage');
    const camEl = document.getElementById('cam');

    const padTop = document.getElementById('padTop');
    const padBottom = document.getElementById('padBottom');
    const content = document.getElementById('content');

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fsBtn = document.getElementById('fsBtn');

    const speed = document.getElementById('speed');
    const speedVal = document.getElementById('speedVal');

    const fontSize = document.getElementById('fontSize');
    const fontVal = document.getElementById('fontVal');

    const altSent = document.getElementById('altSent');
    const parenOn = document.getElementById('parenOn');
    const quoteOn = document.getElementById('quoteOn');
    const mdOn = document.getElementById('mdOn');
    const dimOn = document.getElementById('dimOn');
    const mirror = document.getElementById('mirror');

    const vignetteOn = document.getElementById('vignetteOn');
    const guideOn = document.getElementById('guideOn');
    const guidePos = document.getElementById('guidePos');
    const guidePosVal = document.getElementById('guidePosVal');
    const guideThick = document.getElementById('guideThick');
    const guideThickVal = document.getElementById('guideThickVal');
    const guideLine = document.getElementById('guideLine');
    const glassOn = document.getElementById('glassOn');

    // ✅ Pro Mod kontrolleri
    const proMode = document.getElementById('proMode');
    const bandOn = document.getElementById('bandOn');
    const bandH = document.getElementById('bandH');
    const bandHVal = document.getElementById('bandHVal');
    const bandShade = document.getElementById('bandShade');
    const bandShadeVal = document.getElementById('bandShadeVal');
    const bandFrame = document.getElementById('bandFrame');

    const camOn = document.getElementById('camOn');
    const camFacing = document.getElementById('camFacing');
    const camAudio = document.getElementById('camAudio');
    const recBtn = document.getElementById('recBtn');
    const dl = document.getElementById('dl');
    const shareBtn = document.getElementById('shareBtn');

    const statusPill = document.getElementById('statusPill');
    const posPill = document.getElementById('posPill');

    let rafId = null;
    let running = false;
    let paused = false;

    let manualDir = 0;
    const manualSpeed = 420;
    let lastTs = 0;

    // Kamera / kayıt
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let lastBlob = null;

    function setStatus(t){ statusPill.textContent = t; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[ch]));
    }

    function updateBandVars(){
      const pos = Number(guidePos.value);     // 10..90
      const h = Number(bandH.value);          // 10..50 (%)
      const top = clamp(pos - (h/2), 0, 100);
      const bottom = clamp(pos + (h/2), 0, 100);

      const shadePct = Number(bandShade.value);  // 0..85
      const alpha = clamp(shadePct / 100, 0, 0.85);

      stage.style.setProperty('--bandTop', String(top));
      stage.style.setProperty('--bandBottom', String(bottom));
      stage.style.setProperty('--shadeAlpha', String(alpha));

      // bandFrame konum/ölçü
      bandFrame.style.top = `${top}%`;
      bandFrame.style.height = `${bottom - top}%`;
    }

    function updateUI(){
      speedVal.textContent = `${speed.value} px/sn`;
      fontVal.textContent = `${fontSize.value} px`;
      content.style.fontSize = `${fontSize.value}px`;
      pauseBtn.textContent = paused ? 'Devam' : 'Duraklat';

      stage.classList.toggle('mirror', mirror.checked);
      document.body.classList.toggle('dim', dimOn.checked);

      stage.classList.toggle('vignetteOn', vignetteOn.checked);
      stage.classList.toggle('guideOn', guideOn.checked);
      stage.classList.toggle('glassOn', glassOn.checked);

      stage.classList.toggle('camOn', camOn.checked);

      // pro band
      stage.classList.toggle('bandOn', bandOn.checked);

      guidePosVal.textContent = `%${guidePos.value}`;
      guideThickVal.textContent = `${guideThick.value} px`;
      guideLine.style.top = `${guidePos.value}%`;
      guideLine.style.height = `${guideThick.value}px`;

      bandHVal.textContent = `%${bandH.value}`;
      bandShadeVal.textContent = `%${bandShade.value}`;
      updateBandVars();

      fsBtn.textContent = document.fullscreenElement ? 'Tam Ekrandan Çık (F)' : 'Tam Ekran (F)';
    }

    function updatePadding(){
      const h = viewport.clientHeight;
      padTop.style.height = `${h}px`;
      padBottom.style.height = `${h}px`;
    }

    function maxScroll(){
      return Math.max(0, viewport.scrollHeight - viewport.clientHeight);
    }

    function updateProgress(){
      const m = maxScroll();
      const pct = m ? (viewport.scrollTop / m) * 100 : 0;
      posPill.textContent = `${clamp(pct,0,100).toFixed(0)}%`;
    }

    function splitSentencesKeepingSpaces(text){
      const re = /[^.!?…]+[.!?…]*\s*/g;
      const parts = text.match(re);
      return parts && parts.length ? parts : [text];
    }

    function applyMarkdown(s){
      s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      s = s.replace(/\*(?!\*)([^*]+?)\*/g, "<em>$1</em>");
      return s;
    }
    function applyParen(s){
      return s.replace(/\([^)]*\)/g, m => `<span class="paren">${m}</span>`);
    }
    function applyQuotes(s){
      s = s.replace(/"([^"]+)"/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/'([^']+)'/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/“([^”]+)”/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/‘([^’]+)’/g, m => `<span class="quote">${m}</span>`);
      return s;
    }

    function renderText(){
      const text = input.value || "";
      if (!text.trim()){
        content.textContent = "";
        return;
      }

      const useAlt = altSent.checked;
      const useParenOpt = parenOn.checked;
      const useQuoteOpt = quoteOn.checked;
      const useMd = mdOn.checked;

      if (!useAlt && !useParenOpt && !useQuoteOpt && !useMd){
        content.textContent = text;
        return;
      }

      const segs = splitSentencesKeepingSpaces(text);
      let html = "";

      for (let i = 0; i < segs.length; i++){
        let s = escapeHtml(segs[i]);

        if (useMd) s = applyMarkdown(s);
        if (useParenOpt) s = applyParen(s);
        if (useQuoteOpt) s = applyQuotes(s);

        if (useAlt){
          const cls = (i % 2 === 0) ? "sA" : "sB";
          html += `<span class="sentence ${cls}">${s}</span>`;
        } else {
          html += s;
        }
      }

      content.innerHTML = html;
    }

    function preview(){
      renderText();
      updatePadding();
      viewport.scrollTop = viewport.clientHeight;
      setStatus('Hazır');
      updateProgress();
    }

    function ensureLoop(){
      if (rafId) return;
      lastTs = 0;
      rafId = requestAnimationFrame(tick);
    }

    function stopLoopIfIdle(){
      if (running || manualDir !== 0) return;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      lastTs = 0;
    }

    function tick(ts){
      if (!rafId) return;

      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      let delta = 0;

      if (running && !paused){
        delta += Number(speed.value) * dt;
      }
      if (manualDir !== 0){
        delta += manualDir * manualSpeed * dt;
      }

      if (delta !== 0){
        const m = maxScroll();
        const next = clamp(viewport.scrollTop + delta, 0, m);
        viewport.scrollTop = next;
        updateProgress();

        if (running && !paused && delta > 0 && next >= m - 1){
          running = false;
          paused = false;
          setStatus('Bitti');
          pauseBtn.textContent = 'Duraklat';
          stopLoopIfIdle();
          return;
        }
      }

      if (running || manualDir !== 0){
        rafId = requestAnimationFrame(tick);
      } else {
        stopLoopIfIdle();
      }
    }

    function start(){
      renderText();
      updatePadding();

      if (!input.value.trim()){
        setStatus('Metin boş');
        content.textContent = "";
        posPill.textContent = "0%";
        return;
      }

      viewport.scrollTop = 0;
      running = true;
      paused = false;
      setStatus('Oynatılıyor');
      updateUI();
      updateProgress();
      ensureLoop();
    }

    function togglePause(){
      if (!running) return;
      paused = !paused;
      setStatus(paused ? 'Duraklatıldı' : 'Oynatılıyor');
      updateUI();
      ensureLoop();
    }

    function stop(){
      running = false;
      paused = false;
      manualDir = 0;
      setStatus('Durduruldu');
      updateUI();
      preview();
      stopLoopIfIdle();
    }

    function adjustSpeed(delta){
      const v = Number(speed.value);
      speed.value = String(clamp(v + delta, Number(speed.min), Number(speed.max)));
      updateUI();
    }

    async function toggleFullscreen(){
      try{
        if (!document.fullscreenElement){
          await stage.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      }catch(e){
        console.warn(e);
      }
      updateUI();
    }

    // ✅ Pro preset (tek tık)
    function applyProPreset(){
      // okunurluk / fokus
      bandOn.checked = true;
      vignetteOn.checked = true;
      guideOn.checked = true;
      glassOn.checked = true;
      dimOn.checked = true;

      guidePos.value = "45";
      guideThick.value = "2";
      bandH.value = "24";
      bandShade.value = "55";

      updateUI();
    }

    // ---- Kamera ----
    async function startCamera(){
      try{
        await stopCamera();

        const constraints = {
          video: { facingMode: camFacing.value },
          audio: camAudio.checked
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        camEl.srcObject = stream;
        await camEl.play();

        setStatus('Kamera açık');
      }catch(err){
        console.error(err);
        setStatus('Kamera açılamadı (HTTPS + izin kontrol)');
        camOn.checked = false;
        updateUI();
      }
    }

    async function stopCamera(){
      if (mediaRecorder && mediaRecorder.state !== 'inactive'){
        try{ mediaRecorder.stop(); }catch(_){}
      }
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      camEl.srcObject = null;
    }

    function pickMimeType(){
      const candidates = [
        'video/webm;codecs=vp9,opus',
        'video/webm;codecs=vp8,opus',
        'video/webm',
        'video/mp4'
      ];
      for (const t of candidates){
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)){
          return t;
        }
      }
      return '';
    }

    async function startRecording(){
      if (!window.MediaRecorder){
        setStatus('Kayıt desteklenmiyor');
        return;
      }

      if (!stream){
        camOn.checked = true;
        updateUI();
        await startCamera();
        if (!stream) return;
      }

      recordedChunks = [];
      lastBlob = null;
      dl.classList.remove('show');
      shareBtn.style.display = 'none';

      const mimeType = pickMimeType();
      try{
        mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
      }catch(e){
        mediaRecorder = new MediaRecorder(stream);
      }

      mediaRecorder.ondataavailable = (ev) => {
        if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
      };

      mediaRecorder.onstop = async () => {
        lastBlob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' });
        const url = URL.createObjectURL(lastBlob);

        const ext = (lastBlob.type.includes('mp4')) ? 'mp4' : 'webm';
        dl.download = `kayit.${ext}`;
        dl.href = url;
        dl.classList.add('show');

        try{
          const file = new File([lastBlob], `kayit.${ext}`, { type: lastBlob.type || 'video/webm' });
          if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
            shareBtn.style.display = 'inline-flex';
            shareBtn.onclick = async () => {
              try{ await navigator.share({ files:[file], title:'Kayıt' }); }catch(_){}
            };
          }
        }catch(_){}

        setStatus('Kayıt hazır');
        recBtn.textContent = 'Kayıt Başlat';
      };

      mediaRecorder.start(250);
      setStatus('Kayıt alınıyor…');
      recBtn.textContent = 'Kayıt Durdur';
    }

    function stopRecording(){
      if (mediaRecorder && mediaRecorder.state !== 'inactive'){
        mediaRecorder.stop();
        setStatus('Kayıt işleniyor…');
      }
    }

    // --- Eventler ---
    speed.addEventListener('input', updateUI);
    fontSize.addEventListener('input', () => { updateUI(); updatePadding(); });

    mirror.addEventListener('change', updateUI);
    dimOn.addEventListener('change', () => document.body.classList.toggle('dim', dimOn.checked));

    altSent.addEventListener('change', () => { renderText(); updatePadding(); updateProgress(); });
    parenOn.addEventListener('change', () => { renderText(); updatePadding(); updateProgress(); });
    quoteOn.addEventListener('change', () => { renderText(); updatePadding(); updateProgress(); });
    mdOn.addEventListener('change', () => { renderText(); updatePadding(); updateProgress(); });

    vignetteOn.addEventListener('change', updateUI);
    guideOn.addEventListener('change', updateUI);
    guidePos.addEventListener('input', updateUI);
    guideThick.addEventListener('input', updateUI);
    glassOn.addEventListener('change', updateUI);

    // Pro
    proMode.addEventListener('change', () => {
      if (proMode.checked) applyProPreset();
      updateUI();
    });
    bandOn.addEventListener('change', updateUI);
    bandH.addEventListener('input', updateUI);
    bandShade.addEventListener('input', updateUI);

    startBtn.addEventListener('click', start);
    pauseBtn.addEventListener('click', togglePause);
    stopBtn.addEventListener('click', stop);
    fsBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', () => updateUI());

    input.addEventListener('input', () => {
      if (!running){
        preview();
      } else {
        const keep = viewport.scrollTop;
        renderText();
        updatePadding();
        viewport.scrollTop = clamp(keep, 0, maxScroll());
        updateProgress();
      }
    });

    viewport.addEventListener('scroll', () => updateProgress(), { passive:true });

    // Basılı tut sarma
    function bindHold(btn, dir){
      const startHold = (e) => { e.preventDefault(); manualDir = dir; ensureLoop(); };
      const stopHold = () => { manualDir = 0; stopLoopIfIdle(); };
      btn.addEventListener('pointerdown', startHold);
      btn.addEventListener('pointerup', stopHold);
      btn.addEventListener('pointercancel', stopHold);
      btn.addEventListener('pointerleave', stopHold);
    }
    bindHold(document.getElementById('holdUp'), -1);
    bindHold(document.getElementById('holdDown'), +1);

    // Kamera toggle / yön değişimi
    camOn.addEventListener('change', async () => {
      updateUI();
      if (camOn.checked){
        // Kamera açılırken Pro Mod açıksa otomatik pro preset uygula
        if (proMode.checked) applyProPreset();
        await startCamera();
      } else {
        await stopCamera();
      }
    });

    camFacing.addEventListener('change', async () => {
      if (camOn.checked) await startCamera();
    });

    camAudio.addEventListener('change', async () => {
      if (camOn.checked && (!mediaRecorder || mediaRecorder.state === 'inactive')) await startCamera();
    });

    // Kayıt butonu
    recBtn.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') stopRecording();
      else await startRecording();
    });

    // Klavye
    window.addEventListener('keydown', (e) => {
      const tag = document.activeElement?.tagName?.toLowerCase();
      if (tag === 'textarea' || tag === 'input' || tag === 'button' || tag === 'select') return;

      if (e.code === 'Space'){ e.preventDefault(); togglePause(); return; }
      if (e.code === 'KeyF'){ e.preventDefault(); toggleFullscreen(); return; }

      if (e.code === 'ArrowUp'){ e.preventDefault(); manualDir = -1; ensureLoop(); return; }
      if (e.code === 'ArrowDown'){ e.preventDefault(); manualDir = +1; ensureLoop(); return; }

      if (e.code === 'ArrowRight'){ e.preventDefault(); adjustSpeed(+5); return; }
      if (e.code === 'ArrowLeft'){ e.preventDefault(); adjustSpeed(-5); return; }
    });

    window.addEventListener('keyup', (e) => {
      if (e.code === 'ArrowUp' && manualDir === -1){ manualDir = 0; stopLoopIfIdle(); }
      if (e.code === 'ArrowDown' && manualDir === +1){ manualDir = 0; stopLoopIfIdle(); }
    });

    window.addEventListener('resize', () => {
      const keep = viewport.scrollTop;
      updatePadding();
      viewport.scrollTop = clamp(keep, 0, maxScroll());
      updateProgress();
      updateUI();
    });

    // ilk durum
    updateUI();
    preview();
  </script>
</body>
</html>
