<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔗 Manuel Eşleştirme Paneli</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box.total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-box.matched {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .stat-box.unmatched {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            outline: none;
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .food-card {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .food-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .food-card.matched {
            border-color: #28a745;
            background: #f0fff4;
        }

        .food-card.matched::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .food-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .food-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .meta-tag {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 20px;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tarif-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .tarif-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .tarif-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .tarif-item.selected {
            border-color: #28a745;
            background: #f0fff4;
        }

        .tarif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .tarif-name {
            font-size: 12px;
            color: #333;
            word-break: break-word;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .current-match {
            background: #fff3cd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ffc107;
        }

        .current-match strong {
            color: #856404;
        }

        /* Tab Styles */
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Test Önizleme Paneli */
        .preview-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            max-height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: auto;
            display: none;
            z-index: 999;
        }

        .preview-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Sıralama Kontrolleri */
        .sort-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-controls span {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .sort-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Action Butonları (Düzenle/Sil) */
        .food-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .action-btn {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .edit-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 2px 4px;
            font-size: 14px;
            min-width: auto;
            line-height: 1;
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: scale(1.1);
        }

        .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 2px 4px;
            font-size: 14px;
            min-width: auto;
            line-height: 1;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: scale(1.1);
        }

        /* Düzenleme Modali */
        .edit-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .edit-modal-overlay.active {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .edit-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .edit-modal-body {
            padding: 25px;
        }

        .edit-modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }

        .save-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .modal-close {
            background: white;
            color: #667eea;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            transform: rotate(90deg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .sort-controls {
                justify-content: center;
            }

            .edit-modal-content {
                width: 95%;
                max-height: 95vh;
            }
        }

        @media (max-width: 576px) {
            .sort-btn {
                font-size: 11px;
                padding: 6px 12px;
            }

            .action-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            .edit-modal-body {
                padding: 15px;
            }
        }

        .preview-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .preview-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .preview-body {
            padding: 15px;
        }

        .preview-input {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-bottom: 15px;
            outline: none;
        }

        .match-result {
            margin-bottom: 15px;
        }

        .match-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .match-badge.manuel {
            background: #007bff;
            color: white;
        }

        .match-badge.yasak {
            background: #dc3545;
            color: white;
        }

        .match-badge.otomatik {
            background: #28a745;
            color: white;
        }

        .match-badge.none {
            background: #6c757d;
            color: white;
        }

        .match-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .match-card-preview {
            position: relative;
            width: 80px;
        }

        .match-card-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .match-card-preview .card-name {
            font-size: 10px;
            text-align: center;
            margin-top: 3px;
            color: #666;
            word-break: break-word;
        }

        .preview-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .preview-section:last-child {
            border-bottom: none;
        }

        .preview-section h4 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .preview-info {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        .toggle-preview-btn {
            position: fixed;
            right: 20px;
            top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 998;
            transition: all 0.2s;
        }

        .toggle-preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <!-- Test Önizleme Toggle Button -->
    <button class="toggle-preview-btn" onclick="togglePreview()">
        🔍 Test Önizleme
    </button>
    
    <!-- Debug Test Button -->
    <button style="position: fixed; bottom: 20px; right: 20px; background: #ff6b6b; color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; z-index: 998; font-size: 12px;" onclick="testSearch()">
        🐛 Test Arama
    </button>

    <!-- Test Önizleme Paneli -->
    <div class="preview-panel" id="previewPanel">
        <div class="preview-header">
            <h3>🔍 Canlı Test Önizleme</h3>
            <button class="preview-close" onclick="togglePreview()">×</button>
        </div>
        <div class="preview-body">
            <input type="text" 
                   class="preview-input" 
                   id="previewInput" 
                   placeholder="Yemek adını yazın..."
                   oninput="updatePreview()">
            
            <div id="previewResults"></div>
        </div>
    </div>

    <!-- Bildirim Container -->
    <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>

    <div class="container">
        <h1>🔗 Manuel Eşleştirme Paneli</h1>

        <div style="text-align: center; margin-bottom: 15px;">
            <button class="btn btn-save" onclick="refreshData(event)" style="padding: 8px 20px;" id="btnRefreshData">
                🔄 GitHub'dan Güncel Veriyi Çek
            </button>
            <button class="btn" onclick="openTokenModal()" style="padding: 8px 20px; background: #ffc107; color: #000; margin-left: 10px;">
                🔑 GitHub Token
            </button>
        </div>

        <div class="stats">
            <div class="stat-box total">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Toplam Yemek</div>
            </div>
            <div class="stat-box matched">
                <div class="stat-number" id="matchedCount">0</div>
                <div class="stat-label">Eşleştirilmiş</div>
            </div>
            <div class="stat-box unmatched">
                <div class="stat-number" id="unmatchedCount">0</div>
                <div class="stat-label">Eşleştirilmemiş</div>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" data-filter="all">Tümü</button>
            <button class="filter-btn" data-filter="matched">Eşleştirilmiş</button>
            <button class="filter-btn" data-filter="unmatched">Eşleştirilmemiş</button>
            <button class="filter-btn" onclick="openAddFoodModal()" style="margin-left: auto; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; font-weight: 600;">
                ➕ Yeni Yemek Ekle
            </button>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="🔍 Yemek ara...">
        </div>

        <!-- Sıralama Kontrolleri -->
        <div class="sort-controls">
            <span>📊 Sırala:</span>
            <button class="sort-btn" data-sort="calories">🔥 Kalori</button>
            <button class="sort-btn" data-sort="protein">🥩 Protein</button>
            <button class="sort-btn" data-sort="carbs">🍞 Karb</button>
            <button class="sort-btn" data-sort="fat">🧈 Yağ</button>
            <button class="sort-btn" data-sort="name">📝 İsim</button>
            <button class="sort-btn" onclick="resetSort()">↻ Sıfırla</button>
        </div>

        <div id="foodGrid" class="food-grid">
            <div class="loading">Yemekler yükleniyor...</div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="matchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Eşleştirme Yönetimi</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>

            <!-- Tab Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e9ecef; flex-wrap: wrap;">
                <button class="tab-btn active" onclick="switchTab('manuel')" id="tabManuel">
                    📝 Manuel Eşleştirme (Tarif Kartları)
                </button>
                <button class="tab-btn" onclick="switchTab('yasak')" id="tabYasak">
                    🚫 Eşleşme Yasakları (Tarif Kartları)
                </button>
                <button class="tab-btn" onclick="switchTab('yemekEslestirme')" id="tabYemekEslestirme">
                    🍽️ Yemek Veritabanı Eşleştirme
                </button>
                <button class="tab-btn" onclick="switchTab('yemekYasak')" id="tabYemekYasak">
                    ⛔ Yemek Veritabanı Yasakları
                </button>
            </div>

            <!-- Tab: Manuel Eşleştirme -->
            <div id="tabContentManuel" class="tab-content active">
                <!-- Eşleşme Bilgileri -->
                <div id="matchInfoPanel" style="display: none; background: #e7f3ff; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">ℹ️</span>
                        <strong style="color: #1976D2; font-size: 16px;">Bu Yemek Şu Kartlarla Eşleşmiş:</strong>
                    </div>
                    <div id="matchInfoContent" style="margin-left: 34px;"></div>
                </div>
                
                <div class="current-match" id="currentMatch" style="display: none;">
                    <strong>Mevcut Manuel Eşleştirme:</strong> <span id="currentMatchName"></span>
                </div>

                <!-- Arama Kutusu -->
                <div style="margin-bottom: 15px;">
                    <input type="text" 
                           id="searchTarifManuel" 
                           placeholder="🔍 Tarif kartlarında ara..." 
                           oninput="filterTarifKartlari()"
                           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
                    <button class="btn" onclick="clearManuelSelection()" style="background: #6c757d; color: white; padding: 6px 15px; font-size: 13px;">
                        🗑️ Seçimi Temizle
                    </button>
                    <span id="selectionCount" style="color: #667eea; font-weight: bold; line-height: 32px;"></span>
                </div>

                <div class="tarif-grid" id="tarifGrid">
                    <div class="loading">Tarif kartları yükleniyor...</div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeModal()">İptal</button>
                    <button class="btn" onclick="deleteManuelMatch(event)" style="background: #dc3545; color: white;" id="btnDeleteManuel">
                        ❌ Eşleştirmeyi Kaldır
                    </button>
                    <button class="btn btn-save" onclick="saveManuelMatch(event)" id="btnSaveManuel">
                        💾 GitHub'a Kaydet
                    </button>
                </div>
            </div>

            <!-- Tab: Eşleşme Yasakları -->
            <div id="tabContentYasak" class="tab-content" style="display: none;">
                <div class="current-match" id="currentYasak" style="display: none;">
                    <strong>Mevcut Yasaklar:</strong> <span id="currentYasakName"></span>
                </div>

                <!-- Arama Kutusu -->
                <div style="margin-bottom: 15px;">
                    <input type="text" 
                           id="searchTarifYasak" 
                           placeholder="🔍 Tarif kartlarında ara..." 
                           oninput="filterTarifKartlariYasak()"
                           style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
                    <button class="btn" onclick="clearYasakSelection()" style="background: #6c757d; color: white; padding: 6px 15px; font-size: 13px;">
                        🗑️ Seçimi Temizle
                    </button>
                    <span id="yasakCount" style="color: #dc3545; font-weight: bold; line-height: 32px;"></span>
                </div>

                <div class="tarif-grid" id="tarifGridYasak">
                    <div class="loading">Tarif kartları yükleniyor...</div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeModal()">İptal</button>
                    <button class="btn" onclick="deleteYasakMatch(event)" style="background: #6c757d; color: white;" id="btnDeleteYasak">
                        ❌ Yasağı Kaldır
                    </button>
                    <button class="btn" style="background: #dc3545; color: white;" onclick="saveYasakMatch(event)" id="btnSaveYasak">
                        🚫 Yasak Olarak Kaydet
                    </button>
                </div>
            </div>

            <!-- Tab: Yemek Veritabanı Eşleştirme -->
            <div id="tabContentYemekEslestirme" class="tab-content" style="display: none;">
                <div style="background: #e7f3ff; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">ℹ️</span>
                        <strong style="color: #1976D2; font-size: 16px;">Yemek Veritabanı Manuel Eşleştirme</strong>
                    </div>
                    <p style="margin: 0 0 10px 34px; color: #555; font-size: 14px;">
                        Şablonlardaki yemek adlarını <code>food_list.json</code> veritabanındaki yemeklerle manuel olarak eşleştirin.
                    </p>
                    <ul style="margin: 0 0 0 50px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li>"tahin ekmeği (1 dilim)" → "Tahin ekmeği" (parantez içi kaldırıldı)</li>
                        <li>"kaşar peyniri (50g)" → "Kaşar peyniri" (gram bilgisi kaldırıldı)</li>
                        <li>Bu eşleştirmeler <code>patient_nutrition.html</code>'de role, dietType, category bilgilerini almak için kullanılır</li>
                    </ul>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Şablondaki Yemek Adı:</label>
                        <input type="text" 
                               id="yemekEslestirmeArama" 
                               placeholder="Örn: tahin ekmeği (1 dilim)"
                               style="width: 100%; padding: 10px; border: 2px solid #2196F3; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="flex: 1; position: relative;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Hedef Yemek (food_list.json):</label>
                        <input type="text" 
                               id="yemekEslestirmeHedef" 
                               placeholder="🔍 Yemek ara ve seç..."
                               autocomplete="off"
                               oninput="filterYemekEslestirmeDropdown(this.value)"
                               onfocus="showYemekEslestirmeDropdown()"
                               style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 8px; font-size: 14px;">
                        <!-- Akıllı dropdown -->
                        <div id="yemekEslestirmeDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: white; border: 2px solid #28a745; border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000;">
                            <!-- JavaScript ile dolacak -->
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-save" onclick="saveYemekEslestirme()">
                        ✅ Eşleştirmeyi Ekle
                    </button>
                    <button class="btn btn-cancel" onclick="clearYemekEslestirmeForm()">
                        🗑️ Formu Temizle
                    </button>
                </div>

                <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-top: 0;">📋 Mevcut Eşleştirmeler</h3>
                    <div id="yemekEslestirmeList" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading">Eşleştirmeler yükleniyor...</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Yemek Veritabanı Yasakları -->
            <div id="tabContentYemekYasak" class="tab-content" style="display: none;">
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">⚠️</span>
                        <strong style="color: #856404; font-size: 16px;">Yemek Veritabanı Yasak Eşleştirmeler</strong>
                    </div>
                    <p style="margin: 0 0 10px 34px; color: #555; font-size: 14px;">
                        Şablonlardaki yemeklerin <code>food_list.json</code>'daki hangi yemeklerle eşleşMEMESİ gerektiğini belirleyin.
                    </p>
                    <ul style="margin: 0 0 0 50px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li>"zeytin" → "Zeytinli meze", "Zeytinli salata" 🚫 (çok genel kelime)</li>
                        <li>"tavuk" → "Tavuklu hünkar beğendi" 🚫 (sadece tavuk arıyoruz)</li>
                        <li>Fuzzy matching yanlış eşleştirmeleri önler</li>
                    </ul>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Arama Terimi:</label>
                        <input type="text" 
                               id="yemekYasakArama" 
                               placeholder="Örn: zeytin"
                               style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">Yasaklı Yemekler (food_list.json):</label>
                    <div style="position: relative;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1; position: relative;">
                                <input type="text" 
                                       id="yemekYasakHedef" 
                                       placeholder="🔍 Yemek ara ve seç..."
                                       autocomplete="off"
                                       oninput="filterYemekYasakDropdown(this.value)"
                                       onfocus="showYemekYasakDropdown()"
                                       style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px;">
                                <!-- Akıllı dropdown -->
                                <div id="yemekYasakDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: white; border: 2px solid #dc3545; border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000;">
                                    <!-- JavaScript ile dolacak -->
                                </div>
                            </div>
                            <button class="btn" onclick="addYemekYasakItemManual()" style="background: #dc3545; color: white;">
                                ➕ Manuel Ekle
                            </button>
                        </div>
                    </div>
                    <div id="yemekYasakItems" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 50px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <span style="color: #999; font-size: 13px;">Yasaklı yemekleri yukarıdan seçin veya arayın...</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Yasak Nedeni (Opsiyonel):</label>
                    <textarea 
                        id="yemekYasakNeden" 
                        placeholder="Örn: Sadece 'zeytin' kelimesi bileşik yemeklerle eşleşmemeli"
                        style="width: 100%; padding: 10px; border: 2px solid #6c757d; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="saveYemekYasak()" style="background: #dc3545; color: white;">
                        🚫 Yasağı Ekle
                    </button>
                    <button class="btn btn-cancel" onclick="clearYemekYasakForm()">
                        🗑️ Formu Temizle
                    </button>
                </div>

                <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-top: 0;">📋 Mevcut Yasaklar</h3>
                    <div id="yemekYasakList" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading">Yasaklar yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub Token Modal -->
    <div class="modal" id="tokenModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>🔑 GitHub Token Gerekli</h2>
                <button class="close-btn" onclick="closeTokenModal()">×</button>
            </div>
            
            <div style="padding: 20px 0;">
                <p style="margin-bottom: 15px; color: #666; line-height: 1.6;">
                    GitHub'a kaydetmek için bir <strong>Personal Access Token</strong> gerekiyor.
                </p>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Token Nasıl Alınır?</strong>
                    <ol style="margin: 10px 0 0 20px; font-size: 13px; color: #666;">
                        <li>GitHub → Settings → Developer settings</li>
                        <li>Personal access tokens → Tokens (classic)</li>
                        <li>Generate new token (classic)</li>
                        <li>İzinler: <code>repo</code> (tüm kutucukları işaretle)</li>
                        <li>Token'ı kopyala ve aşağıya yapıştır</li>
                    </ol>
                </div>

                <input type="password" 
                       id="githubTokenInput" 
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                       style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-cancel" onclick="closeTokenModal()" style="flex: 1;">
                        İptal
                    </button>
                    <button class="btn btn-save" onclick="saveToken()" style="flex: 1;">
                        💾 Token'ı Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDatabase = [];
        let tarifKartlari = [];
        let manuelEslestirmeler = {};
        let eslesmemeKurallari = {}; // Yasak kuralları (tarif kartları)
        let yemekVeritabaniEslestirme = {}; // Yemek veritabanı eşleştirmeleri (YENİ)
        let yemekVeritabaniYasaklar = {}; // Yemek veritabanı yasakları (YENİ)
        let currentYemekYasakItems = []; // Geçici yasak liste
        let currentFood = null;
        let selectedTarifler = []; // Manuel eşleştirme için seçili tarifler
        let selectedYasaklar = []; // Yasak kuralları için seçili tarifler
        let currentFilter = 'all';
        let currentTab = 'manuel'; // 'manuel', 'yasak', 'yemekEslestirme', 'yemekYasak'
        let currentSort = null; // Sıralama: {field: 'calories', direction: 'asc'}
        let editingFood = null; // Düzenlenen yemek
        let displayedFoods = []; // Gösterilen yemeklerin listesi

        // GitHub Config
        const GITHUB_OWNER = 'mustafasacar35';
        const GITHUB_REPO = 'lipodem-takip-paneli'; // ✅ Ana repo
        const GITHUB_BRANCH = 'main';
        const MANUEL_FILE_PATH = 'data/manuel_eslestirmeler.json';
        const YASAK_FILE_PATH = 'data/eslesmeme_kurallari.json';
        const FOOD_LIST_FILE_PATH = 'food_list.json'; // Yemek listesi dosyası

        // Token'ı localStorage'dan al
        function getGithubToken() {
            return localStorage.getItem('github_token');
        }

        // Token'ı kaydet
        function saveToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                alert('Lütfen bir token girin!');
                return;
            }
            localStorage.setItem('github_token', token);
            closeTokenModal();
            alert('✅ Token kaydedildi! Artık GitHub\'a kaydedebilirsiniz.');
        }

        // Token modal'ını aç
        function openTokenModal() {
            document.getElementById('tokenModal').classList.add('active');
            const currentToken = getGithubToken();
            if (currentToken) {
                document.getElementById('githubTokenInput').value = currentToken;
            }
        }

        // Token modal'ını kapat
        function closeTokenModal() {
            document.getElementById('tokenModal').classList.remove('active');
        }

        // ✅ Bildirim göster
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const bgColors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            notification.style.cssText = `
                background: ${bgColors[type] || bgColors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                min-width: 300px;
                max-width: 500px;
                font-size: 14px;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
                cursor: pointer;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">${icons[type] || icons.info}</span>
                    <span>${message}</span>
                </div>
            `;
            
            // Tıklayınca kapat
            notification.onclick = () => notification.remove();
            
            container.appendChild(notification);
            
            // 5 saniye sonra otomatik kapat
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Tab değiştir
        function switchTab(tab) {
            currentTab = tab;
            
            // Tab butonlarını güncelle
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Tüm tab content'leri gizle
            document.getElementById('tabContentManuel').style.display = 'none';
            document.getElementById('tabContentYasak').style.display = 'none';
            document.getElementById('tabContentYemekEslestirme').style.display = 'none';
            document.getElementById('tabContentYemekYasak').style.display = 'none';
            
            // Seçili tab'ı göster
            if (tab === 'manuel') {
                document.getElementById('tabManuel').classList.add('active');
                document.getElementById('tabContentManuel').style.display = 'block';
            } else if (tab === 'yasak') {
                document.getElementById('tabYasak').classList.add('active');
                document.getElementById('tabContentYasak').style.display = 'block';
                displayTarifKartlariYasak();
            } else if (tab === 'yemekEslestirme') {
                document.getElementById('tabYemekEslestirme').classList.add('active');
                document.getElementById('tabContentYemekEslestirme').style.display = 'block';
                renderYemekEslestirmeList();
            } else if (tab === 'yemekYasak') {
                document.getElementById('tabYemekYasak').classList.add('active');
                document.getElementById('tabContentYemekYasak').style.display = 'block';
                renderYemekYasakList();
            }
        }

        // Normalize fonksiyonu
        function normalizeText(str) {
            if (!str) return '';
            return str.toLowerCase()
                .replace(/ç/g, 'c')
                .replace(/ğ/g, 'g')
                .replace(/ı/g, 'i')
                .replace(/i̇/g, 'i')
                .replace(/ö/g, 'o')
                .replace(/ş/g, 's')
                .replace(/ü/g, 'u')
                .replace(/[^a-z0-9]/g, '');
        }

        // Akıllı arama fonksiyonu (fuzzy search)
        function smartSearch(searchTerm, targetText) {
            if (!searchTerm || !targetText) return false;
            
            const search = normalizeText(searchTerm);
            const target = normalizeText(targetText);
            
            // 1. Tam eşleşme veya içeriyor mu?
            if (target.includes(search)) return true;
            
            // 2. Kelime kelime eşleşme - HER KELİME BAŞLANGIÇ OLARAK EŞLEŞMELI (SIRASIZ)
            // ⚠️ ÖNEMLİ: Normalizasyon yapmadan ÖNCE split yap!
            const searchWords = searchTerm.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            if (searchWords.length > 1) {
                // Hedef metni ÖNCE alt çizgi ve boşluklara göre parçala, SONRA normalize et
                const targetWords = targetText.split(/[_\s]+/).map(w => normalizeText(w));
                
                // Her arama kelimesini normalize et ve kontrol et
                const allWordsFound = searchWords.every(searchWord => {
                    const normalizedSearchWord = normalizeText(searchWord);
                    return targetWords.some(targetWord => targetWord.startsWith(normalizedSearchWord));
                });
                
                if (allWordsFound) return true;
            }
            
            // 3. Başlangıç eşleşmesi (tek kelime için)
            if (target.startsWith(search)) return true;
            
            return false;
        }

        // 🐛 Test fonksiyonu
        function testSearch() {
            const tests = [
                { search: "lor sal", target: "lor_peyniri_salatasi" },
                { search: "keto ko", target: "keto_kofte" },
                { search: "keto ko", target: "ketojenik_kofte" },
                { search: "keto ko", target: "ketojenik_ispanakli_borek" },
                { search: "tav gu", target: "tavuk_guvec" },
            ];
            
            console.log("=== ARAMA TESTLERİ ===");
            tests.forEach(test => {
                const result = smartSearch(test.search, test.target);
                const searchWords = normalizeText(test.search).split(/\s+/);
                const targetWords = normalizeText(test.target).split(/[_\s]+/);
                
                console.log(`\n"${test.search}" → "${test.target}"`);
                console.log(`  Arama kelimeleri: [${searchWords.join(', ')}]`);
                console.log(`  Hedef kelimeler: [${targetWords.join(', ')}]`);
                console.log(`  Sonuç: ${result ? '✅ BULUNDU' : '❌ BULUNAMADI'}`);
            });
            
            alert("Test sonuçları Console'da! (F12 > Console)");
        }

        // Quantity ve parantez temizleme (yemek-alternatif-bulucu-v2.html ile aynı)
        function cleanYemekAdi(yemekAdi) {
            let cleaned = yemekAdi;
            
            // 1. Quantity removal (baştan) - DETAYLI
            cleaned = cleaned.replace(/^\d+\.\s*/g, ''); // "1. "
            cleaned = cleaned.replace(/^\d+\s*adet\s*/gi, ''); // "1 adet"
            cleaned = cleaned.replace(/^\d+\s*dilim\s*/gi, ''); // "1 dilim"
            cleaned = cleaned.replace(/^\d+\s*gram\s*/gi, ''); // "1 gram"
            cleaned = cleaned.replace(/^\d+\s*gr\.?\s*/gi, ''); // "1 gr"
            cleaned = cleaned.replace(/^\d+\s*ml\s*/gi, ''); // "1 ml"
            cleaned = cleaned.replace(/^\d+\s*porsiyon\s*/gi, ''); // "1 porsiyon"
            cleaned = cleaned.replace(/^\(\s*\d+\s*porsiyon\s*\)\s*/gi, ''); // "(1 porsiyon)"
            
            // ✅ YENİ: Başındaki tek başına sayı + birim (tatlı kaşığı, yemek kaşığı, vb.)
            cleaned = cleaned.replace(/^\d+\s+(tatlı|yemek|çorba|çay)\s+kaşığı\s+/gi, ''); // "1 tatlı kaşığı"
            cleaned = cleaned.replace(/^\d+\s+(su\s+)?bardağı\s+/gi, ''); // "1 bardak", "1 su bardağı"
            cleaned = cleaned.replace(/^\d+\s+/g, ''); // Son çare: Başındaki sayıyı sil (eğer yukarıdakiler yakalamadıysa)
            
            // 2. Parantez içindekiler
            cleaned = cleaned.replace(/\([^)]*\)/g, '');
            
            return cleaned.trim();
        }

        // Tarif kartlarını bul (yemek-alternatif-bulucu-v2.html mantığı)
        function findTarifKartlari(yemekAdi) {
            if (!yemekAdi) return { matched: [], sources: [], blocked: false, blockReason: null };
            
            const cleanedYemekAdi = cleanYemekAdi(yemekAdi);
            const normalized = normalizeText(cleanedYemekAdi);
            
            let manuelMatches = [];
            let otomatikMatches = [];
            let sources = [];
            
            // ÖNCE: Manuel eşleştirme kontrolü
            let manuelMatch = manuelEslestirmeler[yemekAdi] || 
                            manuelEslestirmeler[normalized] ||
                            manuelEslestirmeler[cleanedYemekAdi] ||
                            manuelEslestirmeler[normalizeText(yemekAdi)];
            
            if (manuelMatch) {
                if (typeof manuelMatch === 'object' && manuelMatch.kartlar) {
                    manuelMatches = manuelMatch.kartlar;
                } else if (typeof manuelMatch === 'string') {
                    manuelMatches = [manuelMatch];
                }
                
                if (manuelMatches.length > 0) {
                    sources.push('manuel');
                }
            }
            
            // SONRA: Otomatik eşleştirme (AKILLI ALGORİTMA)
            for (const tarif of tarifKartlari) {
                const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                const tarifNormalized = normalizeText(tarifName);
                const tarifWords = tarifNormalized.split('_').filter(w => w.length > 0);
                
                const yemekWords = normalized.split('_').filter(w => w.length > 0);
                
                // 1. TAM EŞLEŞME - En yüksek öncelik
                if (tarifNormalized === normalized) {
                    otomatikMatches.push(tarif.name);
                    continue;
                }
                
                // 2. YEMEK KELİMELERİ TARİF İÇİNDE TAM GEÇİYOR MU?
                // Örnek: "pankek" yemeği için "pankek.jpg" eşleşsin ama "karnabahar_pankek.jpg" eşleşmesin
                // Ancak "karnabahar pankek" yemeği için "karnabahar_pankek.jpg" eşleşsin
                
                const allYemekWordsInTarif = yemekWords.every(word => tarifWords.includes(word));
                const allTarifWordsInYemek = tarifWords.every(word => yemekWords.includes(word));
                
                // 3. İKİ YÖNLÜ TAM KELİME EŞLEŞMESİ
                // Yemekteki tüm kelimeler tarifteyse VE tarifteki tüm kelimeler yemekteyse → Eşleş
                if (allYemekWordsInTarif && allTarifWordsInYemek) {
                    otomatikMatches.push(tarif.name);
                    continue;
                }
                
                // 4. YEMEK = TAM BİR KELİME (tek kelime yemekler için)
                // Örnek: "pankek" yemeği sadece "pankek.jpg" ile eşleşsin
                if (yemekWords.length === 1 && tarifWords.length === 1 && yemekWords[0] === tarifWords[0]) {
                    otomatikMatches.push(tarif.name);
                    continue;
                }
                
                // 5. ÇOK KELİMELİ YEMEKLER İÇİN: Yemekteki tüm kelimeler tarifteyse
                // Örnek: "kiymali karnabahar" için "kiymali_karnabahar_pankek.jpg" eşleşebilir
                // ANCAK tarifte fazladan kelime varsa eşleşme skoru düşük olmalı
                if (yemekWords.length >= 2 && allYemekWordsInTarif) {
                    // Tarifte fazladan kelime yoksa veya sadece 1 fazla kelime varsa eşleş
                    const extraWords = tarifWords.length - yemekWords.length;
                    if (extraWords <= 1) {
                        otomatikMatches.push(tarif.name);
                    }
                }
            }
            
            if (otomatikMatches.length > 0) {
                sources.push('otomatik');
            }
            
            // Tüm eşleşmeleri source bilgisiyle birlikte hazırla
            const matchedWithSource = [];
            
            // Manuel eşleşmeleri ekle
            manuelMatches.forEach(kartAdi => {
                matchedWithSource.push({ name: kartAdi, source: 'manuel' });
            });
            
            // Otomatik eşleşmeleri ekle (sadece manuel'de yoksa)
            otomatikMatches.forEach(kartAdi => {
                if (!manuelMatches.includes(kartAdi)) {
                    matchedWithSource.push({ name: kartAdi, source: 'otomatik' });
                }
            });
            
            // Yasak kontrolü
            const allMatchNames = matchedWithSource.map(m => m.name);
            const yasakCheck = checkYasakKurallar(yemekAdi, allMatchNames);
            
            // Yasak kuralı var mı kontrol et (eşleşme olsun olmasın)
            const yasakData = getYasakKurallar(yemekAdi);
            
            if (yasakCheck.blocked) {
                return { 
                    matched: [], 
                    sources: [], 
                    blocked: true, 
                    blockReason: yasakCheck.reason, 
                    attempted: allMatchNames,
                    yasakCount: yasakData ? yasakData.length : 0
                };
            }
            
            return { 
                matched: matchedWithSource, 
                sources: sources, 
                blocked: false,
                yasakCount: yasakData ? yasakData.length : 0, // Yasak sayısını her zaman ekle
                // Geriye dönük uyumluluk için
                source: sources.length > 0 ? sources[0] : 'none'
            };
        }

        // Yasak kuralları kontrolü
        function checkYasakKurallar(yemekAdi, tarifKartlari) {
            if (!Array.isArray(tarifKartlari) || tarifKartlari.length === 0) {
                return { blocked: false };
            }
            
            const yasakListesi = getYasakKurallar(yemekAdi);
            if (!yasakListesi || yasakListesi.length === 0) return { blocked: false };
            
            // Her tarif kartını yasak listesiyle karşılaştır
            for (const tarifAdi of tarifKartlari) {
                const tarifNormalized = normalizeText(tarifAdi.replace(/\.(jpg|jpeg|png)$/i, ''));
                
                for (const yasak of yasakListesi) {
                    const yasakNormalized = normalizeText(yasak.replace(/\.(jpg|jpeg|png)$/i, ''));
                    
                    if (tarifNormalized === yasakNormalized || tarifNormalized.includes(yasakNormalized)) {
                        return { 
                            blocked: true, 
                            reason: `"${tarifAdi}" yasak listede: "${yasak}"`,
                            blockedCard: tarifAdi,
                            yasakRule: yasak
                        };
                    }
                }
            }
            
            return { blocked: false };
        }
        
        // Yemek için yasak kurallarını al (helper fonksiyon)
        function getYasakKurallar(yemekAdi) {
            const cleanedYemekAdi = cleanYemekAdi(yemekAdi);
            const normalized = normalizeText(cleanedYemekAdi);
            
            // Boşluklu lowercase version (JSON'daki key formatı) - TEMİZLENMİŞ metinle!
            const lowercaseSpaced = cleanedYemekAdi.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                .replace(/ş/g, 's').replace(/Ş/g, 'S')
                .replace(/ı/g, 'i').replace(/İ/g, 'I')
                .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                .trim();
            
            // Farklı key'leri dene (JSON'daki key'ler boşluklu ve lowercase)
            let yasakData = eslesmemeKurallari[yemekAdi] ||           // Orijinal
                            eslesmemeKurallari[lowercaseSpaced] ||     // Boşluklu lowercase (JSON formatı!)
                            eslesmemeKurallari[normalized] ||          // Alt çizgili
                            eslesmemeKurallari[cleanedYemekAdi] ||     // Temizlenmiş
                            eslesmemeKurallari[normalizeText(yemekAdi)]; // Normalize orijinal
            
            // Eğer bulunamazsa, tüm key'leri kontrol et (fuzzy match)
            if (!yasakData) {
                const allKeys = Object.keys(eslesmemeKurallari);
                for (const key of allKeys) {
                    const keyNormalized = normalizeText(key);
                    if (keyNormalized === normalized || 
                        key.toLowerCase() === lowercaseSpaced.toLowerCase()) {
                        yasakData = eslesmemeKurallari[key];
                        console.log(`✅ Fuzzy match: "${yemekAdi}" → "${key}"`);
                        break;
                    }
                }
            }
            
            if (!yasakData) return null;
            
            // Yasak listesini al (eski ve yeni format desteği)
            if (Array.isArray(yasakData)) {
                return yasakData;
            } else if (typeof yasakData === 'object' && yasakData.yasakliKartlar) {
                return yasakData.yasakliKartlar;
            }
            
            return null;
        }

        // Önizleme panelini toggle
        function togglePreview() {
            const panel = document.getElementById('previewPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                document.getElementById('previewInput').focus();
            }
        }

        // Önizlemeyi güncelle
        function updatePreview() {
            const yemekAdi = document.getElementById('previewInput').value.trim();
            const resultsDiv = document.getElementById('previewResults');
            
            if (!yemekAdi) {
                resultsDiv.innerHTML = '<div class="preview-info" style="text-align: center; color: #999;">Bir yemek adı yazın...</div>';
                return;
            }
            
            const result = findTarifKartlari(yemekAdi);
            const cleanedName = cleanYemekAdi(yemekAdi);
            const normalizedName = normalizeText(cleanedName);
            
            let html = '';
            
            // 1. Temizlenmiş isim bilgisi
            if (cleanedName !== yemekAdi) {
                html += `
                    <div class="preview-section">
                        <h4>📝 Temizlenmiş İsim</h4>
                        <div class="preview-info">
                            <strong>Orijinal:</strong> ${yemekAdi}<br>
                            <strong>Temizlenmiş:</strong> ${cleanedName}<br>
                            <strong>Normalize:</strong> ${normalizedName}
                        </div>
                    </div>
                `;
            }
            
            // 2. Eşleştirme durumu
            html += '<div class="preview-section"><h4>🎯 Eşleştirme Durumu</h4>';
            
            if (result.blocked) {
                html += `
                    <span class="match-badge yasak">🚫 YASAK KURAL</span>
                    <div class="preview-info">
                        <strong>Kaynak:</strong> ${result.source === 'manuel-blocked' ? 'Manuel Eşleştirme (Engellendi)' : 'Otomatik Eşleştirme (Engellendi)'}<br>
                        <strong>Engellenen Kart:</strong> ${result.attempted ? result.attempted.join(', ') : 'N/A'}<br>
                        <strong>Sebep:</strong> ${result.blockReason || 'Yasak listede'}
                    </div>
                `;
            } else if (result.source === 'manuel') {
                html += `
                    <span class="match-badge manuel">🔵 MANUEL EŞLEŞTIRME</span>
                    <div class="preview-info">
                        <strong>Kaynak:</strong> manuel_eslestirmeler.json<br>
                        <strong>Eşleşen Kart Sayısı:</strong> ${result.matched.length}
                    </div>
                `;
            } else if (result.source === 'otomatik') {
                html += `
                    <span class="match-badge otomatik">🟢 OTOMATİK EŞLEŞTIRME</span>
                    <div class="preview-info">
                        <strong>Kaynak:</strong> Regex/İsim benzerliği<br>
                        <strong>Eşleşen Kart Sayısı:</strong> ${result.matched.length}
                    </div>
                `;
            } else {
                html += `
                    <span class="match-badge none">❌ EŞLEŞME YOK</span>
                    <div class="preview-info">
                        Hiçbir tarif kartı bulunamadı.
                    </div>
                `;
            }
            
            html += '</div>';
            
            // 3. Eşleşen kartları göster
            if (result.matched && result.matched.length > 0) {
                html += '<div class="preview-section"><h4>🎴 Eşleşen Kartlar</h4><div class="match-cards">';
                
                result.matched.forEach(kartAdi => {
                    const imageUrl = `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${kartAdi}`;
                    const displayName = kartAdi.replace(/\.(jpg|jpeg|png)$/i, '');
                    
                    html += `
                        <div class="match-card-preview">
                            <img src="${imageUrl}" alt="${displayName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23ddd%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3E📷%3C/text%3E%3C/svg%3E'">
                            <div class="card-name">${displayName}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // 4. Debug bilgileri
            html += `
                <div class="preview-section">
                    <h4>🔍 Debug Bilgileri</h4>
                    <div class="preview-info" style="font-size: 11px;">
                        <strong>Manuel Eşleştirme:</strong> ${Object.keys(manuelEslestirmeler).length} adet<br>
                        <strong>Yasak Kurallar:</strong> ${Object.keys(eslesmemeKurallari).length} adet<br>
                        <strong>Tarif Kartları:</strong> ${tarifKartlari.length} adet<br>
                        <strong>Aranan Key'ler:</strong><br>
                        - ${yemekAdi}<br>
                        - ${cleanedName}<br>
                        - ${normalizedName}
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // Yemekleri yükle
        async function loadFoodData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json');
                const data = await response.json();
                
                foodDatabase = [];
                if (data.categories && Array.isArray(data.categories)) {
                    data.categories.forEach(category => {
                        if (category.items && Array.isArray(category.items)) {
                            foodDatabase.push(...category.items);
                        }
                    });
                }
                
                console.log('✅ Yemek veritabanı yüklendi:', foodDatabase.length, 'yemek');
                
                await loadTarifKartlari();
                await loadManuelEslestirmeler();
                await loadEslesmemeKurallari();
                await loadYemekVeritabaniEslestirme();
                await loadYemekVeritabaniYasaklar();
                
                displayFoods();
            } catch (error) {
                console.error('❌ Veritabanı hatası:', error);
                document.getElementById('foodGrid').innerHTML = '<div class="loading">❌ Veritabanı yüklenemedi</div>';
            }
        }

        // Tarif kartlarını yükle
        async function loadTarifKartlari() {
            try {
                // Yöntem 1: list.json dosyası (EN İYİ - rate limit yok, CORS yok)
                let response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Array kontrolü ve format tespiti
                    if (Array.isArray(data)) {
                        tarifKartlari = data
                            .map(item => {
                                // String ise direkt kullan
                                if (typeof item === 'string') return item;
                                // Object ise name veya filename özelliğini al
                                if (typeof item === 'object') return item.name || item.filename || item.file || null;
                                return null;
                            })
                            .filter(name => name && typeof name === 'string' && name.match(/\.(jpg|jpeg|png)$/i))
                            .map(name => ({
                                name: name,
                                type: 'file',
                                download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}`
                            }));
                        
                        console.log('✅ Tarif kartları list.json ile yüklendi:', tarifKartlari.length, 'kart');
                        return;
                    }
                }
                
                console.warn(`⚠️ list.json yüklenemedi (${response.status}), GitHub API deneniyor...`);
                
                // Yöntem 2: GitHub API (token gerekebilir)
                response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli/contents/tarifler');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        tarifKartlari = data.filter(file => 
                            file.type === 'file' && 
                            (file.name.endsWith('.jpg') || file.name.endsWith('.jpeg') || file.name.endsWith('.png'))
                        );
                        console.log('✅ Tarif kartları GitHub API ile yüklendi:', tarifKartlari.length, 'kart');
                        return;
                    }
                }
                
                throw new Error('Tüm yöntemler başarısız');
                
            } catch (error) {
                console.error('❌ Tarif kartları yüklenemedi:', error.message);
                
                // FALLBACK: Manuel eşleştirmelerden tarif listesini çıkar
                console.log('📦 Fallback: Manuel eşleştirmelerden tarif listesi oluşturuluyor...');
                
                // Manuel eşleştirmeleri bekle
                if (Object.keys(manuelEslestirmeler).length === 0) {
                    await loadManuelEslestirmeler();
                }
                
                // Manuel eşleştirmelerdeki tüm kartları topla
                const uniqueTarifler = new Set();
                Object.values(manuelEslestirmeler).forEach(eslestirme => {
                    if (eslestirme && typeof eslestirme === 'object' && eslestirme.kartlar) {
                        eslestirme.kartlar.forEach(kart => uniqueTarifler.add(kart));
                    } else if (typeof eslestirme === 'string') {
                        uniqueTarifler.add(eslestirme);
                    }
                });
                
                tarifKartlari = [...uniqueTarifler].map(name => ({
                    name: name,
                    type: 'file',
                    download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}`
                }));
                
                console.log('✅ Fallback tarif kartları yüklendi:', tarifKartlari.length, 'kart (manuel eşleştirmelerden)');
            }
        }

        // Manuel eşleştirmeleri yükle
        async function loadManuelEslestirmeler() {
            try {
                // Cache bypass için timestamp ekle
                const timestamp = new Date().getTime();
                const manuelUrl = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data/manuel_eslestirmeler.json?t=${timestamp}`;
                console.log('📥 Manuel eşleştirmeler yükleniyor:', manuelUrl);
                const response = await fetch(manuelUrl, {
                    cache: 'no-store' // Cache'i tamamen devre dışı bırak
                });
                if (response.ok) {
                    const data = await response.json();
                    manuelEslestirmeler = data.eslestirmeler || data;
                    console.log('✅ Manuel eşleştirmeler yüklendi:', Object.keys(manuelEslestirmeler).length, 'adet');
                }
            } catch (error) {
                console.warn('⚠️ Manuel eşleştirmeler yüklenemedi:', error);
            }
        }

        // Yasak kurallarını yükle
        async function loadEslesmemeKurallari() {
            try {
                // Cache bypass için timestamp ekle
                const timestamp = new Date().getTime();
                const yasakUrl = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data/eslesmeme_kurallari.json?t=${timestamp}`;
                console.log('📥 Yasak kurallar yükleniyor:', yasakUrl);
                const response = await fetch(yasakUrl, {
                    cache: 'no-store' // Cache'i tamamen devre dışı bırak
                });
                if (response.ok) {
                    const data = await response.json();
                    
                    // İç içe yapıyı kontrol et
                    if (data.kurallar && data.kurallar.eslesmemeKurallari) {
                        // Yeni format: kurallar.eslesmemeKurallari
                        eslesmemeKurallari = data.kurallar.eslesmemeKurallari;
                    } else if (data.kurallar) {
                        // Eski format: kurallar
                        eslesmemeKurallari = data.kurallar;
                    } else if (data.eslesmemeKurallari) {
                        // Direkt eslesmemeKurallari
                        eslesmemeKurallari = data.eslesmemeKurallari;
                    } else {
                        // Direkt data
                        eslesmemeKurallari = data;
                    }
                    
                    console.log('✅ Yasak kurallar yüklendi:', Object.keys(eslesmemeKurallari).length, 'adet');
                    console.log('📋 Yasak key\'leri:', Object.keys(eslesmemeKurallari));
                    
                    // 🐛 DEBUG: İlk 3 kuralı detaylı göster
                    Object.keys(eslesmemeKurallari).slice(0, 3).forEach(key => {
                        console.log(`   → "${key}":`, eslesmemeKurallari[key]);
                    });
                }
            } catch (error) {
                console.warn('⚠️ Yasak kurallar yüklenemedi:', error);
            }
        }

        // Yemek veritabanı eşleştirmelerini yükle
        async function loadYemekVeritabaniEslestirme() {
            try {
                const timestamp = new Date().getTime();
                const url = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data/yemek_veritabani_eslestirme.json?t=${timestamp}`;
                console.log('📥 Yemek veritabanı eşleştirmeleri yükleniyor:', url);
                const response = await fetch(url, { cache: 'no-store' });
                if (response.ok) {
                    const data = await response.json();
                    yemekVeritabaniEslestirme = data.eslestirmeler || data;
                    console.log('✅ Yemek veritabanı eşleştirmeleri yüklendi:', Object.keys(yemekVeritabaniEslestirme).length, 'adet');
                }
            } catch (error) {
                console.warn('⚠️ Yemek veritabanı eşleştirmeleri yüklenemedi:', error);
                yemekVeritabaniEslestirme = {};
            }
        }

        // Yemek veritabanı yasaklarını yükle
        async function loadYemekVeritabaniYasaklar() {
            try {
                const timestamp = new Date().getTime();
                const url = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data/yemek_veritabani_yasaklar.json?t=${timestamp}`;
                console.log('📥 Yemek veritabanı yasakları yükleniyor:', url);
                const response = await fetch(url, { cache: 'no-store' });
                if (response.ok) {
                    const data = await response.json();
                    yemekVeritabaniYasaklar = data.yasaklar || data;
                    console.log('✅ Yemek veritabanı yasakları yüklendi:', Object.keys(yemekVeritabaniYasaklar).length, 'adet');
                }
            } catch (error) {
                console.warn('⚠️ Yemek veritabanı yasakları yüklenemedi:', error);
                yemekVeritabaniYasaklar = {};
            }
        }

        // İstatistikleri güncelle
        function updateStats() {
            const totalCount = foodDatabase.length;
            const matchedCount = foodDatabase.filter(food => {
                const matchResult = findTarifKartlari(food.name);
                return matchResult.matched.length > 0;
            }).length;
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('matchedCount').textContent = matchedCount;
            document.getElementById('unmatchedCount').textContent = totalCount - matchedCount;
        }

        // 🔧 GitHub API - Dosya Güncelleme Fonksiyonu
        async function updateGithubFile(filePath, content, commitMessage) {
            const token = getGithubToken();
            if (!token) {
                alert('❌ GitHub token gerekli! Lütfen önce token girin.');
                openTokenModal();
                throw new Error('GitHub token gerekli');
            }

            try {
                // 1. Dosyanın mevcut SHA'sını al
                const getUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}?ref=${GITHUB_BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                }

                // 2. Dosyayı güncelle veya oluştur
                const putUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}`;
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: btoa(unescape(encodeURIComponent(content))), // UTF-8 base64 encode
                        sha: sha,
                        branch: GITHUB_BRANCH
                    })
                });

                if (!putResponse.ok) {
                    const error = await putResponse.json();
                    throw new Error(error.message || 'GitHub API hatası');
                }

                return await putResponse.json();
            } catch (error) {
                console.error('GitHub API Hatası:', error);
                throw error;
            }
        }

        // 🔧 food_list.json'u GitHub'a kaydet
        async function saveFoodListToGithub(updatedDatabase, commitMessage) {
            try {
                // Kategorilere göre grupla (orijinal format)
                const categories = {};
                
                updatedDatabase.forEach(food => {
                    const categoryName = food.category || 'Diğer';
                    if (!categories[categoryName]) {
                        categories[categoryName] = {
                            name: categoryName,
                            items: []
                        };
                    }
                    categories[categoryName].items.push(food);
                });

                // JSON formatı oluştur
                const jsonContent = JSON.stringify({
                    version: "3.0",
                    lastUpdated: new Date().toISOString(),
                    categories: Object.values(categories)
                }, null, 2);

                // GitHub'a kaydet
                await updateGithubFile(FOOD_LIST_FILE_PATH, jsonContent, commitMessage);
                
                return true;
            } catch (error) {
                console.error('food_list.json kaydetme hatası:', error);
                throw error;
            }
        }

        // Yemekleri göster
        function displayFoods() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredFoods = foodDatabase.filter(food => {
                const matchSearch = !searchTerm || food.name.toLowerCase().includes(searchTerm);
                
                // Tüm eşleştirme türlerini kontrol et (manuel + otomatik)
                const matchResult = findTarifKartlari(food.name);
                const hasMatch = matchResult.matched.length > 0;
                
                if (currentFilter === 'matched') return matchSearch && hasMatch;
                if (currentFilter === 'unmatched') return matchSearch && !hasMatch;
                return matchSearch;
            });

            // Gösterilen yemekleri kaydet (sıralama için)
            displayedFoods = [...filteredFoods];

            // Eğer sıralama aktifse, yeniden sırala
            if (currentSort) {
                displayedFoods.sort((a, b) => {
                    let aVal, bVal;

                    if (currentSort.field === 'name') {
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                    } else {
                        aVal = a[currentSort.field] || 0;
                        bVal = b[currentSort.field] || 0;
                    }

                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                filteredFoods = displayedFoods;
            }

            // İstatistikleri güncelle
            updateStats();

            const grid = document.getElementById('foodGrid');
            if (filteredFoods.length === 0) {
                grid.innerHTML = '<div class="loading">Sonuç bulunamadı</div>';
                return;
            }

            grid.innerHTML = filteredFoods.map((food, index) => {
                // Tüm eşleştirme türlerini kontrol et
                const matchResult = findTarifKartlari(food.name);
                const hasMatch = matchResult.matched.length > 0;
                const matchClass = hasMatch ? 'matched' : '';
                
                // 🐛 DEBUG: Her yemek için yasak kontrolü
                const yasakTest = getYasakKurallar(food.name);
                if (yasakTest) {
                    console.log(`✅ YASAK BULUNDU: "${food.name}" → ${yasakTest.length} kart`, yasakTest);
                }
                
                // Debug: Yasak sayısını kontrol et
                if (matchResult.yasakCount > 0) {
                    console.log(`🔍 ${food.name} → Yasak Count: ${matchResult.yasakCount}`, matchResult);
                }
                
                // Eşleştirme rozetlerini hazırla - sağ alt köşe için
                let matchBadges = '';
                if (matchResult.sources && matchResult.sources.length > 0) {
                    const badges = [];
                    
                    // Manuel eşleşme sayısını hesapla
                    if (matchResult.sources.includes('manuel')) {
                        const manuelCount = matchResult.matched.filter(m => m.source === 'manuel').length;
                        badges.push(`<span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold;">🔵 MANUEL ${manuelCount}</span>`);
                    }
                    
                    // Otomatik eşleşme sayısını hesapla
                    if (matchResult.sources.includes('otomatik')) {
                        const otoCount = matchResult.matched.filter(m => m.source === 'otomatik').length;
                        badges.push(`<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold;">🟢 OTO ${otoCount}</span>`);
                    }
                    
                    matchBadges = badges.join(' ');
                }
                
                // Yasak rozetini göster (eşleşme engellenmişse VEYA yasak kural varsa)
                if (matchResult.blocked && matchResult.yasakCount > 0) {
                    // Tüm eşleşmeler yasaklanmış
                    matchBadges = `<span onclick="event.stopPropagation(); openYasakModalFromBadge(this.closest('.food-card'))" style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; cursor: pointer;">🚫 YASAK ${matchResult.yasakCount}</span>`;
                } else if (!matchResult.blocked && matchResult.yasakCount > 0) {
                    // Yasak kural var ama eşleşme engellenmiyor (yasak liste eşleşmemiş)
                    const yasakBadge = `<span onclick="event.stopPropagation(); openYasakModalFromBadge(this.closest('.food-card'))" style="background: #ffc107; color: black; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; cursor: pointer;">⚠️ YASAK ${matchResult.yasakCount}</span>`;
                    matchBadges = matchBadges ? `${matchBadges} ${yasakBadge}` : yasakBadge;
                }
                
                // Food objesini güvenli şekilde encode et
                const foodData = btoa(encodeURIComponent(JSON.stringify(food)));
                
                // Makro bilgilerini hazırla - tek satırda
                const macrosHTML = `
                    <div class="food-macros-inline" style="font-size: 10px; color: #555; margin-top: 6px; padding: 4px 6px; background: rgba(255,255,255,0.9); border-radius: 4px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-around; gap: 8px; align-items: center;">
                            <span title="Kalori" style="font-weight: 600;">🔥${Math.round(food.calories || 0)}</span>
                            <span title="Karbonhidrat" style="font-weight: 600;">🍞${Math.round(food.carbs || 0)}g</span>
                            <span title="Protein" style="font-weight: 600;">🥩${Math.round(food.protein || 0)}g</span>
                            <span title="Yağ" style="font-weight: 600;">🧈${Math.round(food.fat || 0)}g</span>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="food-card ${matchClass}" data-food="${foodData}">
                        <div style="cursor: pointer;" onclick="openMatchModalFromCard(this.closest('.food-card'))">
                            <div class="food-name">${food.name}</div>
                            ${macrosHTML}
                            <div class="food-meta" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 4px;">
                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                    ${food.category ? `<span class="meta-tag">📂 ${food.category}</span>` : ''}
                                    ${food.mealType ? `<span class="meta-tag">🍽️ ${food.mealType}</span>` : ''}
                                    ${food.keto ? '<span class="meta-tag">🥗 Keto</span>' : food.lowcarb ? '<span class="meta-tag">🥗 LowCarb</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 4px; margin-left: auto;">
                                    ${matchBadges}
                                </div>
                            </div>
                        </div>
                        <div class="food-card-actions">
                            <button class="action-btn edit-btn" onclick="event.stopPropagation(); openEditModalFromCard(this.closest('.food-card'))" title="Düzenle">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteFoodFromCard(this.closest('.food-card'))" title="Sil">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Kart üzerinden modal aç (data attribute'dan)
        function openMatchModalFromCard(element) {
            try {
                const foodData = element.getAttribute('data-food');
                const food = JSON.parse(decodeURIComponent(atob(foodData)));
                openMatchModal(food);
            } catch (error) {
                console.error('Food data parse hatası:', error);
                alert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
            }
        }

        // Yasak badge'e tıklayınca yasak sekmesini aç
        function openYasakModalFromBadge(element) {
            try {
                const foodData = element.getAttribute('data-food');
                const food = JSON.parse(decodeURIComponent(atob(foodData)));
                openMatchModal(food);
                // Yasak sekmesine geç
                switchTab('yasak');
            } catch (error) {
                console.error('Food data parse hatası:', error);
                alert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
            }
        }

        // Modal aç
        function openMatchModal(food) {
            currentFood = food;
            selectedTarifler = []; // Array'i sıfırla
            selectedYasaklar = []; // Array'i sıfırla
            
            document.getElementById('modalTitle').textContent = `Eşleştirme: ${food.name}`;
            document.getElementById('matchModal').classList.add('active');
            
            // Varsayılan olarak manuel eşleştirme tabını aç
            switchTab('manuel');
            
            // TÜM eşleşmeleri kontrol et ve göster
            const matchResult = findTarifKartlari(food.name);
            const matchInfoPanel = document.getElementById('matchInfoPanel');
            const matchInfoContent = document.getElementById('matchInfoContent');
            
            if (matchResult.matched.length > 0) {
                let infoHTML = '<ul style="margin: 5px 0; padding-left: 20px;">';
                
                // Manuel eşleşmeleri göster
                const manuelMatches = matchResult.matched.filter(m => m.source === 'manuel');
                if (manuelMatches.length > 0) {
                    infoHTML += '<li><span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">🔵 MANUEL</span> ';
                    infoHTML += manuelMatches.map(m => m.name.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ') + '</li>';
                }
                
                // Otomatik eşleşmeleri göster
                const otoMatches = matchResult.matched.filter(m => m.source === 'otomatik');
                if (otoMatches.length > 0) {
                    infoHTML += '<li><span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">🟢 OTOMATİK</span> ';
                    infoHTML += otoMatches.map(m => m.name.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ') + '</li>';
                }
                
                if (matchResult.blocked) {
                    infoHTML += '<li><span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">🚫 YASAK</span> ';
                    const yasakKey = Object.keys(eslesmemeKurallari).find(key => normalizeText(key) === normalizeText(food.name));
                    if (yasakKey && eslesmemeKurallari[yasakKey]) {
                        const yasakData = eslesmemeKurallari[yasakKey];
                        const yasaklar = yasakData.yasakliKartlar || [];
                        infoHTML += yasaklar.map(y => y.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ') + '</li>';
                    }
                }
                
                infoHTML += '</ul>';
                matchInfoContent.innerHTML = infoHTML;
                matchInfoPanel.style.display = 'block';
            } else {
                matchInfoPanel.style.display = 'none';
            }
            
            // Mevcut eşleştirmeleri (MANUEL veya OTOMATİK) selectedTarifler'e ekle
            if (matchResult.matched.length > 0) {
                matchResult.matched.forEach(match => {
                    const name = match.name || match; // Geriye dönük uyumluluk
                    const tarif = tarifKartlari.find(t => 
                        normalizeText(t.name) === normalizeText(name) ||
                        t.name === name ||
                        t.name.replace(/\.(jpg|jpeg|png)$/i, '') === name.replace(/\.(jpg|jpeg|png)$/i, '')
                    );
                    if (tarif && !selectedTarifler.find(t => t.name === tarif.name)) {
                        selectedTarifler.push(tarif);
                    }
                });
            }
            
            // Manuel eşleştirme bilgisi göster
            const normalized = normalizeText(food.name);
            let currentMatchData = manuelEslestirmeler[food.name] || 
                                   manuelEslestirmeler[normalized] ||
                                   manuelEslestirmeler[Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalized)];
            
            if (currentMatchData) {
                let matchNames = [];
                if (typeof currentMatchData === 'object' && currentMatchData.kartlar) {
                    matchNames = currentMatchData.kartlar;
                } else if (typeof currentMatchData === 'string') {
                    matchNames = [currentMatchData];
                }
                
                document.getElementById('currentMatch').style.display = 'block';
                document.getElementById('currentMatchName').textContent = matchNames.map(n => n.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ');
            } else {
                document.getElementById('currentMatch').style.display = 'none';
            }
            
            displayTarifKartlari();
        }

        // Tarif kartlarını modal'da göster
        function displayTarifKartlari(filteredList = null) {
            const grid = document.getElementById('tarifGrid');
            const searchTerm = document.getElementById('searchTarifManuel')?.value.toLowerCase() || '';
            
            if (tarifKartlari.length === 0) {
                grid.innerHTML = '<div class="loading">Tarif kartı bulunamadı</div>';
                return;
            }

            // Filtreleme: Akıllı arama ile
            let displayList = filteredList || tarifKartlari;
            if (searchTerm) {
                displayList = displayList.filter(tarif => {
                    const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    return smartSearch(searchTerm, tarifName);
                });
            }

            // ✨ SEÇİLİ KARTLARI HER ZAMAN BAŞA EKLE (aramada yoksa bile!)
            // 1. Seçili kartları al
            const selectedCards = selectedTarifler.slice(); // Kopyasını al
            
            // 2. Seçili olmayanları filtrele
            const unselectedCards = displayList.filter(tarif => 
                !selectedTarifler.some(t => t.name === tarif.name)
            );
            
            // 3. Seçili kartlar + seçili olmayanlar
            displayList = [...selectedCards, ...unselectedCards];

            if (displayList.length === 0) {
                grid.innerHTML = '<div class="loading">Arama sonucu bulunamadı</div>';
                return;
            }

            grid.innerHTML = displayList.map((tarif) => {
                const imageUrl = tarif.download_url || 
                                `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${tarif.name}`;
                const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                
                // Yemek verisini bul (makrolar için) - daha esnek eşleştirme
                const foodData = foodDatabase.find(food => {
                    const foodNameNormalized = normalizeText(food.name || '');
                    const tarifNameNormalized = normalizeText(tarifName);
                    
                    // Tam eşleşme
                    if (foodNameNormalized === tarifNameNormalized) return true;
                    
                    // Alt çizgi ve boşluk farklılıklarını göz ardı et
                    const foodNameClean = foodNameNormalized.replace(/_/g, '');
                    const tarifNameClean = tarifNameNormalized.replace(/_/g, '');
                    if (foodNameClean === tarifNameClean) return true;
                    
                    // Kelime bazında eşleşme
                    if (foodNameNormalized.includes(tarifNameNormalized) || tarifNameNormalized.includes(foodNameNormalized)) return true;
                    
                    return false;
                });
                
                // Seçili mi kontrol et
                const isSelected = selectedTarifler.some(t => t.name === tarif.name);
                const selectedClass = isSelected ? 'selected' : '';
                
                // Makrolar her zaman göster - foodData yoksa da placeholder göster
                let macrosHTML = '';
                if (foodData && (foodData.calories || foodData.carbs || foodData.protein || foodData.fat)) {
                    macrosHTML = `
                        <div class="food-macros" style="font-size: 10px; color: #444; margin-top: 4px; padding: 4px; background: rgba(255,255,255,0.95); border-radius: 4px; border: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; text-align: center;">
                                <span title="Kalori" style="font-weight: 500;">🔥${Math.round(foodData.calories || 0)}</span>
                                <span title="Karbonhidrat" style="font-weight: 500;">🍞${Math.round(foodData.carbs || 0)}g</span>
                                <span title="Protein" style="font-weight: 500;">🥩${Math.round(foodData.protein || 0)}g</span>
                                <span title="Yağ" style="font-weight: 500;">🧈${Math.round(foodData.fat || 0)}g</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Eşleşme yoksa veya makro bilgisi yoksa
                    macrosHTML = `
                        <div class="food-macros" style="font-size: 9px; color: #999; margin-top: 4px; padding: 3px; background: rgba(240,240,240,0.5); border-radius: 4px; text-align: center;">
                            Makro bilgisi bulunamadı
                        </div>
                    `;
                }
                
                return `
                    <div class="tarif-item ${selectedClass}" data-tarif-name="${tarif.name}" onclick="selectTarifByName('${tarif.name}')">
                        <img src="${imageUrl}" alt="${tarifName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3E📷%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarifName}</div>
                        ${macrosHTML}
                    </div>
                `;
            }).join('');
            
            // Seçim sayısını güncelle
            updateSelectionCount();
        }

        // Arama filtresi (Manuel eşleştirme)
        function filterTarifKartlari() {
            displayTarifKartlari();
        }

        // Seçimi temizle (Manuel)
        function clearManuelSelection() {
            selectedTarifler = [];
            displayTarifKartlari();
        }

        // Tarif seç (çoklu seçim) - İsme göre
        function selectTarifByName(tarifName) {
            const tarif = tarifKartlari.find(t => t.name === tarifName);
            if (!tarif) {
                console.error('Tarif bulunamadı:', tarifName);
                return;
            }
            
            const tarifItem = document.querySelector(`.tarif-item[data-tarif-name="${tarifName}"]`);
            if (!tarifItem) {
                console.error('Tarif elementi bulunamadı:', tarifName);
                return;
            }
            
            // Zaten seçili mi kontrol et
            const existingIndex = selectedTarifler.findIndex(t => t.name === tarif.name);
            
            if (existingIndex > -1) {
                // Zaten seçili, kaldır
                selectedTarifler.splice(existingIndex, 1);
                tarifItem.classList.remove('selected');
            } else {
                // Seçili değil, ekle
                selectedTarifler.push(tarif);
                tarifItem.classList.add('selected');
            }
            
            // Seçim sayısını göster
            updateSelectionCount();
        }
        
        // Eski fonksiyon - geriye dönük uyumluluk için
        function selectTarif(index) {
            const tarif = tarifKartlari[index];
            if (tarif) {
                selectTarifByName(tarif.name);
            }
        }
        
        // Seçim sayısını güncelle
        function updateSelectionCount() {
            const countElement = document.getElementById('selectionCount');
            if (countElement) {
                countElement.textContent = selectedTarifler.length > 0 
                    ? `${selectedTarifler.length} tarif seçildi` 
                    : '';
            }
        }

        // Yasak kuralları sekmesi için tarif kartlarını göster
        function displayTarifKartlariYasak() {
            console.log('🔍 displayTarifKartlariYasak çağrıldı');
            console.log('📦 tarifKartlari.length:', tarifKartlari.length);
            console.log('🍽️ currentFood:', currentFood);
            
            const grid = document.getElementById('tarifGridYasak');
            const searchTerm = document.getElementById('searchTarifYasak')?.value.toLowerCase() || '';
            
            if (!tarifKartlari || tarifKartlari.length === 0) {
                console.error('❌ tarifKartlari boş veya tanımsız!');
                grid.innerHTML = '<div class="loading">Tarif kartları yükleniyor... Lütfen bekleyin.</div>';
                return;
            }

            // ✅ DÜZELTME: getYasakKurallar() fonksiyonunu kullan (fuzzy matching ile)
            const existingYasaklar = getYasakKurallar(currentFood.name) || [];
            
            console.log('🚫 Bulunan yasaklar:', existingYasaklar);

            // Mevcut yasakları seçili olarak işaretle (sadece ilk açılışta)
            if (selectedYasaklar.length === 0 && existingYasaklar.length > 0) {
                existingYasaklar.forEach(name => {
                    const tarif = tarifKartlari.find(t => 
                        normalizeText(t.name) === normalizeText(name) ||
                        t.name === name ||
                        t.name.replace(/\.(jpg|jpeg|png)$/i, '') === name.replace(/\.(jpg|jpeg|png)$/i, '')
                    );
                    if (tarif && !selectedYasaklar.find(t => t.name === tarif.name)) {
                        selectedYasaklar.push(tarif);
                        console.log('✅ Yasak seçildi:', tarif.name);
                    }
                });
            }

            // Mevcut yasak bilgisini göster
            if (existingYasaklar.length > 0) {
                document.getElementById('currentYasak').style.display = 'block';
                document.getElementById('currentYasakName').textContent = existingYasaklar.map(n => n.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ');
            } else {
                document.getElementById('currentYasak').style.display = 'none';
            }

            // Filtreleme: Akıllı arama ile
            let displayList = tarifKartlari;
            if (searchTerm) {
                displayList = displayList.filter(tarif => {
                    const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    return smartSearch(searchTerm, tarifName);
                });
            }

            // ✨ SEÇİLİ KARTLARI HER ZAMAN BAŞA EKLE (aramada yoksa bile!)
            // 1. Seçili kartları al
            const selectedYasakCards = selectedYasaklar.slice(); // Kopyasını al
            
            // 2. Seçili olmayanları filtrele
            const unselectedYasakCards = displayList.filter(tarif => 
                !selectedYasaklar.some(t => t.name === tarif.name)
            );
            
            // 3. Seçili kartlar + seçili olmayanlar
            displayList = [...selectedYasakCards, ...unselectedYasakCards];

            if (displayList.length === 0) {
                grid.innerHTML = '<div class="loading">Arama sonucu bulunamadı</div>';
                return;
            }

            grid.innerHTML = displayList.map((tarif) => {
                const imageUrl = tarif.download_url || 
                                `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${tarif.name}`;
                const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                
                // Yemek verisini bul (makrolar için) - daha esnek eşleştirme
                const foodData = foodDatabase.find(food => {
                    const foodNameNormalized = normalizeText(food.name || '');
                    const tarifNameNormalized = normalizeText(tarifName);
                    
                    // Tam eşleşme
                    if (foodNameNormalized === tarifNameNormalized) return true;
                    
                    // Alt çizgi ve boşluk farklılıklarını göz ardı et
                    const foodNameClean = foodNameNormalized.replace(/_/g, '');
                    const tarifNameClean = tarifNameNormalized.replace(/_/g, '');
                    if (foodNameClean === tarifNameClean) return true;
                    
                    // Kelime bazında eşleşme
                    if (foodNameNormalized.includes(tarifNameNormalized) || tarifNameNormalized.includes(foodNameNormalized)) return true;
                    
                    return false;
                });
                
                // Seçili mi kontrol et
                const isSelected = selectedYasaklar.some(t => t.name === tarif.name);
                const selectedClass = isSelected ? 'selected' : '';
                
                // Makrolar her zaman göster
                let macrosHTML = '';
                if (foodData && (foodData.calories || foodData.carbs || foodData.protein || foodData.fat)) {
                    macrosHTML = `
                        <div class="food-macros" style="font-size: 10px; color: #444; margin-top: 4px; padding: 4px; background: rgba(255,255,255,0.95); border-radius: 4px; border: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; text-align: center;">
                                <span title="Kalori" style="font-weight: 500;">🔥${Math.round(foodData.calories || 0)}</span>
                                <span title="Karbonhidrat" style="font-weight: 500;">🍞${Math.round(foodData.carbs || 0)}g</span>
                                <span title="Protein" style="font-weight: 500;">🥩${Math.round(foodData.protein || 0)}g</span>
                                <span title="Yağ" style="font-weight: 500;">🧈${Math.round(foodData.fat || 0)}g</span>
                            </div>
                        </div>
                    `;
                } else {
                    macrosHTML = `
                        <div class="food-macros" style="font-size: 9px; color: #999; margin-top: 4px; padding: 3px; background: rgba(240,240,240,0.5); border-radius: 4px; text-align: center;">
                            Makro bilgisi bulunamadı
                        </div>
                    `;
                }
                
                return `
                    <div class="tarif-item ${selectedClass}" data-tarif-name="${tarif.name}" onclick="selectYasakByName('${tarif.name}')" style="${isSelected ? 'border-color: #dc3545;' : ''}">
                        <img src="${imageUrl}" alt="${tarifName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3E📷%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarifName}</div>
                        ${macrosHTML}
                    </div>
                `;
            }).join('');
            
            updateYasakCount();
        }

        // Arama filtresi (Yasak kuralları)
        function filterTarifKartlariYasak() {
            displayTarifKartlariYasak();
        }

        // Seçimi temizle (Yasak)
        function clearYasakSelection() {
            selectedYasaklar = [];
            displayTarifKartlariYasak();
        }

        // Yasak seç (çoklu seçim) - İsme göre
        function selectYasakByName(tarifName) {
            const tarif = tarifKartlari.find(t => t.name === tarifName);
            if (!tarif) {
                console.error('Tarif bulunamadı:', tarifName);
                return;
            }
            
            const tarifItem = document.querySelector(`#tarifGridYasak .tarif-item[data-tarif-name="${tarifName}"]`);
            if (!tarifItem) {
                console.error('Tarif elementi bulunamadı:', tarifName);
                return;
            }
            
            // Zaten seçili mi kontrol et
            const existingIndex = selectedYasaklar.findIndex(t => t.name === tarif.name);
            
            if (existingIndex > -1) {
                // Zaten seçili, kaldır
                selectedYasaklar.splice(existingIndex, 1);
                tarifItem.classList.remove('selected');
                tarifItem.style.borderColor = '';
            } else {
                // Seçili değil, ekle
                selectedYasaklar.push(tarif);
                tarifItem.classList.add('selected');
                tarifItem.style.borderColor = '#dc3545';
            }
            
            updateYasakCount();
        }
        
        // Eski fonksiyon - geriye dönük uyumluluk için
        function selectYasak(index) {
            const tarif = tarifKartlari[index];
            if (tarif) {
                selectYasakByName(tarif.name);
            }
        }

        // Yasak sayısını güncelle
        function updateYasakCount() {
            const countElement = document.getElementById('yasakCount');
            if (countElement) {
                countElement.textContent = selectedYasaklar.length > 0 
                    ? `${selectedYasaklar.length} kart yasaklanacak` 
                    : '';
            }
        }

        // Modal kapat
        function closeModal() {
            document.getElementById('matchModal').classList.remove('active');
            currentFood = null;
            selectedTarifler = [];
            selectedYasaklar = [];
            currentTab = 'manuel';
            switchTab('manuel');
        }

        // GitHub'dan güncel veri çek
        async function refreshData(evt) {
            const btn = evt?.target || document.getElementById('btnRefreshData');
            const originalText = btn ? btn.textContent : '';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Yükleniyor...';
            }
            
            try {
                await loadManuelEslestirmeler();
                await loadEslesmemeKurallari();
                displayFoods();
                
                if (btn) {
                    btn.textContent = '✅ Güncellendi!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Veri yenileme hatası:', error);
                btn.textContent = '❌ Hata oluştu';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // GitHub'a dosya yükle/güncelle
        async function updateGithubFile(filePath, content, commitMessage) {
            const token = getGithubToken();
            if (!token) {
                openTokenModal();
                throw new Error('GitHub token gerekli');
            }

            try {
                // 1. Dosyanın mevcut SHA'sını al
                const getUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}?ref=${GITHUB_BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                } else if (getResponse.status === 401) {
                    throw new Error('❌ GitHub Token Hatası!\n\nToken geçersiz veya yetkisiz.\n\nLütfen yeni token oluşturun:\n1. github.com → Settings → Developer settings\n2. Personal access tokens → Tokens (classic)\n3. Generate new token (classic)\n4. "repo" iznini seçin (tam erişim)\n5. Token\'ı kopyalayıp bu sayfadaki 🔑 butonundan girin');
                }

                // 2. Dosyayı güncelle veya oluştur
                const putUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}`;
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: btoa(unescape(encodeURIComponent(content))), // UTF-8 base64 encode
                        sha: sha,
                        branch: GITHUB_BRANCH
                    })
                });

                if (!putResponse.ok) {
                    const error = await putResponse.json();
                    if (putResponse.status === 401) {
                        throw new Error('❌ GitHub Token Hatası!\n\nToken geçersiz veya yetkisiz.\n\nLütfen yeni token oluşturun:\n1. github.com → Settings → Developer settings\n2. Personal access tokens → Tokens (classic)\n3. Generate new token (classic)\n4. "repo" iznini seçin (tam erişim)\n5. Token\'ı kopyalayıp bu sayfadaki 🔑 butonundan girin');
                    }
                    throw new Error(error.message || 'GitHub API hatası');
                }

                return await putResponse.json();
            } catch (error) {
                console.error('GitHub API Hatası:', error);
                throw error;
            }
        }

        // Manuel eşleştirmeyi SİL ve GitHub'a kaydet
        async function deleteManuelMatch(evt) {
            if (!currentFood) return;

            const cleanedName = cleanYemekAdi(currentFood.name);
            const normalizedKey = normalizeText(cleanedName);
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                .replace(/ş/g, 's').replace(/Ş/g, 'S')
                .replace(/ı/g, 'i').replace(/İ/g, 'I')
                .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                .trim();

            const candidateKeys = [
                currentFood.name,
                cleanedName,
                lowercaseSpaced,
                normalizedKey,
                normalizeText(currentFood.name)
            ].filter(Boolean);

            let actualKey = candidateKeys.find(key => manuelEslestirmeler[key]);

            if (!actualKey) {
                const normalized = normalizeText(currentFood.name);
                actualKey = Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalized) || null;
            }

            if (!actualKey || !manuelEslestirmeler[actualKey]) {
                alert('Bu yemek için mevcut bir manuel eşleştirme yok!');
                return;
            }

            if (!confirm(`"${currentFood.name}" için manuel eşleştirmeyi silmek istediğinize emin misiniz?`)) {
                return;
            }

            const btn = evt?.target || document.getElementById('btnDeleteManuel');
            const originalText = btn ? btn.textContent : '';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Siliniyor...';
            }

            try {
                // Eşleştirmeyi sil
                delete manuelEslestirmeler[actualKey];

                // JSON'u oluştur
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    eslestirmeler: manuelEslestirmeler
                }, null, 2);

                // GitHub'a kaydet
                await updateGithubFile(
                    MANUEL_FILE_PATH,
                    jsonContent,
                    `Manuel eşleştirme silindi: ${currentFood.name}`
                );

                console.log(`✅ Manuel eşleştirme silindi: "${currentFood.name}" → key: "${actualKey}"`);
                
                // ✅ Bildirim göster
                showNotification(
                    `<strong>Manuel Eşleştirme Silindi!</strong><br>
                    📁 Dosya: <code>manuel_eslestirmeler.json</code><br>
                    🗑️ Yemek: ${currentFood.name}`,
                    'info'
                );
                
                if (btn) {
                    btn.textContent = '✅ Silindi!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        closeModal();
                        displayFoods();
                    }, 1500);
                } else {
                    closeModal();
                    displayFoods();
                }

            } catch (error) {
                console.error('Silme hatası:', error);
                
                // ❌ Hata bildirimi
                showNotification(
                    `<strong>Silme Hatası!</strong><br>${error.message}`,
                    'error'
                );
                
                if (btn) {
                    btn.textContent = '❌ Hata!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            }
        }

        // Manuel eşleştirmeyi GitHub'a kaydet
        async function saveManuelMatch(evt) {
            if (!currentFood || selectedTarifler.length === 0) {
                alert('Lütfen en az bir tarif kartı seçin!');
                return;
            }

            const btn = evt?.target || document.getElementById('btnSaveManuel');
            const originalText = btn ? btn.textContent : '';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Kaydediliyor...';
            }

            try {
                const normalizedKey = normalizeText(currentFood.name);
                
                // Yeni eşleştirme objesi
                const matchData = {
                    orijinalMetin: currentFood.name,
                    kartlar: selectedTarifler.map(t => t.name),
                    eklemeTarihi: new Date().toISOString()
                };

                // Mevcut verileri güncelle
                manuelEslestirmeler[normalizedKey] = matchData;

                // JSON'u oluştur
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    eslestirmeler: manuelEslestirmeler
                }, null, 2);

                // GitHub'a kaydet
                const tarifNames = selectedTarifler.map(t => t.name.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ');
                await updateGithubFile(
                    MANUEL_FILE_PATH,
                    jsonContent,
                    `Manuel eşleştirme: ${currentFood.name} → ${tarifNames}`
                );

                console.log('✅ GitHub\'a kaydedildi:', currentFood.name, '→', tarifNames);
                
                // ✅ Bildirim göster
                showNotification(
                    `<strong>Manuel Eşleştirme Kaydedildi!</strong><br>
                    📁 Dosya: <code>manuel_eslestirmeler.json</code><br>
                    🍽️ Yemek: ${currentFood.name}<br>
                    📋 Tarifler: ${tarifNames}<br>
                    📊 Toplam: ${selectedTarifler.length} tarif`,
                    'success'
                );
                
                if (btn) {
                    btn.textContent = '✅ Kaydedildi!';
                    setTimeout(async () => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        
                        // Manuel eşleştirmeleri GitHub'dan yeniden yükle
                        await loadManuelEslestirmeler();
                        
                        closeModal();
                        displayFoods(); // Ekranı güncelle
                    }, 1500);
                } else {
                    await loadManuelEslestirmeler();
                    closeModal();
                    displayFoods();
                }

            } catch (error) {
                console.error('Kayıt hatası:', error);
                
                // ❌ Hata bildirimi
                showNotification(
                    `<strong>Kayıt Hatası!</strong><br>${error.message}`,
                    'error'
                );
                if (btn) {
                    btn.textContent = '❌ Hata!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
                alert(`❌ Kayıt hatası:\n${error.message}\n\nToken geçerli mi kontrol edin.`);
            }
        }

        // Yasak kuralını SİL ve GitHub'a kaydet
        async function deleteYasakMatch(evt) {
            if (!currentFood) return;

            // ✅ DÜZELTME: Yasak kuralını bulmak için fuzzy matching kullan
            const existingYasaklar = getYasakKurallar(currentFood.name);
            
            if (!existingYasaklar || existingYasaklar.length === 0) {
                alert('Bu yemek için mevcut bir yasak kuralı yok!');
                return;
            }

            if (!confirm(`"${currentFood.name}" için yasak kuralını silmek istediğinize emin misiniz?`)) {
                return;
            }

            const btn = evt?.target || document.getElementById('btnDeleteYasak');
            const originalText = btn ? btn.textContent : '';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Siliniyor...';
            }

            try {
                // ✅ DÜZELTME: Gerçek key'i bul ve sil
                const cleanedYemekAdi = cleanYemekAdi(currentFood.name);
                const normalized = normalizeText(cleanedYemekAdi);
                const lowercaseSpaced = cleanedYemekAdi.toLowerCase() // ✅ FIX: cleanedYemekAdi kullan
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                    .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                    .replace(/ş/g, 's').replace(/Ş/g, 'S')
                    .replace(/ı/g, 'i').replace(/İ/g, 'I')
                    .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                    .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                    .trim();
                
                // Gerçek key'i bul ve tüm varyantları listede tut
                let actualKey = null;
                const keysToRemove = new Set();
                const keysToTry = [currentFood.name, cleanedYemekAdi, lowercaseSpaced, normalized, normalizeText(currentFood.name)];

                for (const key of keysToTry) {
                    if (key && eslesmemeKurallari[key]) {
                        if (!actualKey) actualKey = key;
                        keysToRemove.add(key);
                    }
                }

                // Fuzzy match ile key bul (ve aynı normalized değere sahip diğerleri)
                const allKeys = Object.keys(eslesmemeKurallari);
                for (const key of allKeys) {
                    const keyNormalized = normalizeText(key);
                    if (keyNormalized === normalized || key.toLowerCase() === lowercaseSpaced.toLowerCase()) {
                        if (!actualKey) {
                            actualKey = key;
                            console.log(`✅ Fuzzy match için silme: "${currentFood.name}" → "${key}"`);
                        }
                        keysToRemove.add(key);
                    }
                }

                if (!actualKey) {
                    throw new Error('Yasak kuralı anahtarı bulunamadı!');
                }

                console.log(`🗑️ Silinecek anahtarlar: ${Array.from(keysToRemove).join(', ') || actualKey}`);
                
                // ✅ ÖNCE: Local kopyasından sil (JSON oluşturmak için)
                const updatedEslesmemeKurallari = { ...eslesmemeKurallari };
                keysToRemove.forEach(key => delete updatedEslesmemeKurallari[key]);

                // JSON'u oluştur - Doğru iç içe yapı ile (save ile aynı format)
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    kurallar: {
                        version: "1.0",
                        sonGuncelleme: new Date().toISOString(),
                        eslesmemeKurallari: updatedEslesmemeKurallari
                    }
                }, null, 2);

                // GitHub'a kaydet
                await updateGithubFile(
                    YASAK_FILE_PATH,
                    jsonContent,
                    `Yasak kuralı silindi: ${currentFood.name}`
                );
                
                console.log('✅ GitHub\'a kaydedildi, şimdi local objeden siliniyor');
                
                // ✅ SONRA: Başarılı olduysa local objeden de sil
                keysToRemove.forEach(key => delete eslesmemeKurallari[key]);

                console.log('✅ Yasak kuralı silindi:', currentFood.name);
                
                // ✅ Bildirim göster
                showNotification(
                    `<strong>Yasak Kuralı Silindi!</strong><br>
                    📁 Dosya: <code>eslesmeme_kurallari.json</code><br>
                    🗑️ Yemek: ${currentFood.name}`,
                    'info'
                );
                
                if (btn) {
                    btn.textContent = '✅ Silindi!';
                    setTimeout(async () => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        
                        console.log('🔄 Yenileme başlıyor...');
                        
                        // ✅ Seçili yasakları temizle
                        selectedYasaklar = [];
                        console.log('✅ selectedYasaklar temizlendi');
                        
                        // ✅ Yasak kurallarını GitHub'dan yeniden yükle
                        console.log("⏳ GitHub'dan yükleniyor...");
                        await loadEslesmemeKurallari();
                        // ✅ CDN gecikmesi olsa bile silinen anahtarları tekrar kaldır
                        keysToRemove.forEach(key => {
                            if (eslesmemeKurallari[key]) {
                                console.log(`♻️ Yeniden temizlendi: ${key}`);
                                delete eslesmemeKurallari[key];
                            }
                        });
                        console.log("✅ GitHub'dan yüklendi, eslesmemeKurallari:", Object.keys(eslesmemeKurallari).length, 'adet');
                        
                        // ✅ Ana sayfadaki badge'leri güncelle
                        console.log('🔄 Ana sayfa yenileniyor...');
                        displayFoods();
                        
                        // ✅ Modal'ı kapat
                        console.log('✅ Modal kapatılıyor...');
                        closeModal();
                        
                        console.log('✅ Tüm işlemler tamamlandı!');
                    }, 1500);
                } else {
                    selectedYasaklar = [];
                    await loadEslesmemeKurallari();
                    keysToRemove.forEach(key => delete eslesmemeKurallari[key]);
                    displayFoods();
                    closeModal();
                }

            } catch (error) {
                console.error('Silme hatası:', error);
                
                // ❌ Hata bildirimi
                showNotification(
                    `<strong>Silme Hatası!</strong><br>${error.message}`,
                    'error'
                );
                if (btn) {
                    btn.textContent = '❌ Hata!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            }
        }

        // Yasak kuralını GitHub'a kaydet
        async function saveYasakMatch(evt) {
            if (!currentFood || selectedYasaklar.length === 0) {
                alert('Lütfen en az bir tarif kartı seçin!');
                return;
            }

            const btn = evt?.target || document.getElementById('btnSaveYasak');
            const originalText = btn ? btn.textContent : '';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Kaydediliyor...';
            }

            try {
                // ✅ DÜZELTME: Parantez ve quantity'yi temizleyerek key oluştur
                const cleanedName = cleanYemekAdi(currentFood.name);
                const lowercaseSpaced = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                    .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                    .replace(/ş/g, 's').replace(/Ş/g, 'S')
                    .replace(/ı/g, 'i').replace(/İ/g, 'I')
                    .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                    .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                    .trim();
                
                console.log(`💾 Kaydedilecek key: "${lowercaseSpaced}" (orijinal: "${currentFood.name}")`);
                
                // Yeni yasak kuralı objesi
                const yasakData = {
                    orijinalMetin: currentFood.name,
                    yasakliKartlar: selectedYasaklar.map(t => t.name),
                    eklemeTarihi: new Date().toISOString()
                };

                // Mevcut verileri güncelle
                eslesmemeKurallari[lowercaseSpaced] = yasakData;

                // JSON'u oluştur - Doğru iç içe yapı ile
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    kurallar: {
                        version: "1.0",
                        sonGuncelleme: new Date().toISOString(),
                        eslesmemeKurallari: eslesmemeKurallari
                    }
                }, null, 2);

                // GitHub'a kaydet
                const yasakNames = selectedYasaklar.map(t => t.name.replace(/\.(jpg|jpeg|png)$/i, '')).join(', ');
                await updateGithubFile(
                    YASAK_FILE_PATH,
                    jsonContent,
                    `Eşleşme yasağı: ${currentFood.name} ⛔ ${yasakNames}`
                );

                console.log('✅ Yasak GitHub\'a kaydedildi:', currentFood.name, '⛔', yasakNames);
                
                // ✅ Bildirim göster
                showNotification(
                    `<strong>Eşleşme Yasağı Kaydedildi!</strong><br>
                    📁 Dosya: <code>eslesmeme_kurallari.json</code><br>
                    🍽️ Yemek: ${currentFood.name}<br>
                    🚫 Yasaklanan: ${yasakNames}<br>
                    📊 Toplam: ${selectedYasaklar.length} kart`,
                    'warning'
                );
                
                if (btn) {
                    btn.textContent = '✅ Kaydedildi!';
                    setTimeout(async () => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        
                        // ✅ Seçili yasakları temizle
                        selectedYasaklar = [];
                        
                        // ✅ Yasak kurallarını GitHub'dan yeniden yükle (cache bypass ile)
                        await loadEslesmemeKurallari();
                        
                        // ✅ Ana sayfadaki badge'leri güncelle
                        displayFoods();
                        
                        // ✅ Modal'ı kapat
                        closeModal();
                    }, 1500);
                } else {
                    selectedYasaklar = [];
                    await loadEslesmemeKurallari();
                    displayFoods();
                    closeModal();
                }

            } catch (error) {
                console.error('Kayıt hatası:', error);
                
                // ❌ Hata bildirimi
                showNotification(
                    `<strong>Kayıt Hatası!</strong><br>${error.message}`,
                    'error'
                );
                
                if (btn) {
                    btn.textContent = '❌ Hata!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
                alert(`❌ Kayıt hatası:\n${error.message}\n\nToken geçerli mi kontrol edin.`);
            }
        }

        // ESKİ saveMatch fonksiyonunu kaldırdık, artık saveManuelMatch ve saveYasakMatch var

        // Filtre butonları
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                displayFoods();
            });
        });

        // Arama
        document.getElementById('searchInput').addEventListener('input', displayFoods);

        // ESC ile modal kapat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeTokenModal();
            }
        });

        // Modal dışına tıklayınca kapat
        document.getElementById('matchModal').addEventListener('click', (e) => {
            if (e.target.id === 'matchModal') {
                closeModal();
            }
        });

        document.getElementById('tokenModal').addEventListener('click', (e) => {
            if (e.target.id === 'tokenModal') {
                closeTokenModal();
            }
        });

        // 🔄 SIRALAMA FONKSİYONLARI
        document.querySelectorAll('[data-sort]').forEach(btn => {
            btn.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                sortFoods(sortField);
            });
        });

        function sortFoods(field) {
            if (displayedFoods.length === 0) return;

            // Aynı alana tıklandıysa yönü değiştir
            if (currentSort && currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = { field: field, direction: 'asc' };
            }

            // Sıralama butonlarını güncelle
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sort === field) {
                    btn.classList.add('active');
                    // Ok işareti ekle
                    const baseText = btn.textContent.split(' ')[0] + ' ' + btn.textContent.split(' ').slice(1).join(' ').replace('▲', '').replace('▼', '');
                    btn.textContent = baseText + (currentSort.direction === 'asc' ? ' ▲' : ' ▼');
                } else {
                    // Diğer butonlardan okları kaldır
                    btn.textContent = btn.textContent.replace(' ▲', '').replace(' ▼', '');
                }
            });

            // Sırala
            displayedFoods.sort((a, b) => {
                let aVal, bVal;

                if (field === 'name') {
                    aVal = a.name.toLowerCase();
                    bVal = b.name.toLowerCase();
                } else {
                    aVal = a[field] || 0;
                    bVal = b[field] || 0;
                }

                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Yeniden göster
            displayFoods();
        }

        function resetSort() {
            currentSort = null;

            // Buton durumlarını sıfırla
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent = btn.textContent.replace(' ▲', '').replace(' ▼', '');
            });

            // Orijinal sıralamaya dön
            displayFoods();
        }

        // ✏️ DÜZENLEME FONKSİYONLARI
        function openEditModalFromCard(cardElement) {
            try {
                const foodData = cardElement.getAttribute('data-food');
                const food = JSON.parse(decodeURIComponent(atob(foodData)));
                openEditModal(food);
            } catch (error) {
                console.error('Food data parse hatası:', error);
                alert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
            }
        }

        // 🧮 Kalori Otomatik Hesaplama Fonksiyonu
        function calculateCalories() {
            const protein = parseFloat(document.getElementById('edit_protein').value) || 0;
            const carbs = parseFloat(document.getElementById('edit_carbs').value) || 0;
            const fat = parseFloat(document.getElementById('edit_fat').value) || 0;
            
            // Kalori formülü: (Karbonhidrat × 4) + (Protein × 4) + (Yağ × 9)
            const calories = (carbs * 4) + (protein * 4) + (fat * 9);
            
            document.getElementById('edit_calories').value = calories.toFixed(1);
        }

        function openEditModal(food) {
            editingFood = food;

            // Kategori dropdown'ını doldur
            populateCategoryDropdown();

            // Form alanlarını doldur
            document.getElementById('edit_name').value = food.name || '';
            document.getElementById('edit_protein').value = food.protein || 0;
            document.getElementById('edit_carbs').value = food.carbs || 0;
            document.getElementById('edit_fat').value = food.fat || 0;
            
            // Kaloriyi otomatik hesapla
            calculateCalories();
            
            document.getElementById('edit_category').value = food.category || '';
            document.getElementById('edit_role').value = food.role || '';
            
            // MealType checkbox'ları ayarla
            document.getElementById('edit_mealType_breakfast').checked = false;
            document.getElementById('edit_mealType_lunch').checked = false;
            document.getElementById('edit_mealType_dinner').checked = false;
            
            if (food.mealType) {
                const mealTypes = Array.isArray(food.mealType) ? food.mealType : [food.mealType];
                mealTypes.forEach(type => {
                    const checkbox = document.getElementById(`edit_mealType_${type}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // DietTypes checkbox'ları ayarla
            document.getElementById('edit_dietType_ketojenik').checked = false;
            document.getElementById('edit_dietType_akdeniz').checked = false;
            document.getElementById('edit_dietType_vegan').checked = false;
            document.getElementById('edit_dietType_glutensiz').checked = false;
            
            if (food.dietTypes && Array.isArray(food.dietTypes)) {
                food.dietTypes.forEach(type => {
                    const checkbox = document.getElementById(`edit_dietType_${type}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Miktar ve porsiyon alanları
            document.getElementById('edit_minQuantity').value = food.minQuantity || '';
            document.getElementById('edit_maxQuantity').value = food.maxQuantity || '';
            document.getElementById('edit_step').value = food.step || '';
            document.getElementById('edit_portionMultiplier').value = food.multiplier || food.portionMultiplier || 1;
            
            // Sezon alanları - seasonRange parse et
            let seasonMin = '';
            let seasonMax = '';
            if (food.seasonRange) {
                try {
                    const seasonArray = JSON.parse(food.seasonRange);
                    seasonMin = seasonArray[0] || '';
                    seasonMax = seasonArray[1] || '';
                } catch (e) {
                    console.warn('seasonRange parse hatası:', e);
                }
            }
            document.getElementById('edit_seasonMin').value = seasonMin;
            document.getElementById('edit_seasonMax').value = seasonMax;
            
            // Boolean checkbox'lar
            document.getElementById('edit_keto').checked = food.keto || false;
            document.getElementById('edit_lowcarb').checked = food.lowcarb || false;
            document.getElementById('edit_portionFixed').checked = food.portionFixed || false;
            document.getElementById('edit_fillerLunch').checked = food.fillerLunch || false;
            document.getElementById('edit_fillerDinner').checked = food.fillerDinner || false;
            document.getElementById('edit_isReversedSeason').checked = food.isReversedSeason || false;
            
            // Etiket alanları
            document.getElementById('edit_tags').value = food.tags ? food.tags.join(', ') : '';
            document.getElementById('edit_compatibilityTags').value = food.compatibilityTags ? food.compatibilityTags.join(', ') : '';
            document.getElementById('edit_incompatibilityTags').value = food.incompatibilityTags ? food.incompatibilityTags.join(', ') : '';
            document.getElementById('edit_notes').value = food.notes || '';

            document.getElementById('editModal').classList.add('active');
        }
        
        // Kategori dropdown'ını food_list.json'dan doldur
        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('edit_category');
            const uniqueCategories = new Set();
            
            // food_list.json'daki tüm kategorileri topla
            foodDatabase.forEach(food => {
                if (food.category) {
                    uniqueCategories.add(food.category);
                }
            });
            
            // Dropdown'ı temizle ve yeniden doldur
            categorySelect.innerHTML = '<option value="">-- Kategori Seçin --</option>';
            [...uniqueCategories].sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // 🆕 Yeni Yemek Ekle Modal'ını Aç
        function openAddFoodModal() {
            editingFood = null; // Yeni ekleme modu
            
            // Modal başlığını değiştir
            document.getElementById('editModalTitle').textContent = '➕ Yeni Yemek Ekle';
            
            // Kategori dropdown'ını doldur
            populateCategoryDropdown();
            
            // Tüm form alanlarını temizle
            document.getElementById('edit_name').value = '';
            document.getElementById('edit_protein').value = 0;
            document.getElementById('edit_carbs').value = 0;
            document.getElementById('edit_fat').value = 0;
            document.getElementById('edit_calories').value = 0;
            document.getElementById('edit_category').value = '';
            document.getElementById('edit_role').value = '';
            
            // MealType checkbox'ları temizle
            document.getElementById('edit_mealType_breakfast').checked = false;
            document.getElementById('edit_mealType_lunch').checked = false;
            document.getElementById('edit_mealType_dinner').checked = false;
            
            // DietTypes checkbox'ları temizle
            document.getElementById('edit_dietType_ketojenik').checked = false;
            document.getElementById('edit_dietType_akdeniz').checked = false;
            document.getElementById('edit_dietType_vegan').checked = false;
            document.getElementById('edit_dietType_glutensiz').checked = false;
            
            // Diğer alanları temizle
            document.getElementById('edit_minQuantity').value = '';
            document.getElementById('edit_maxQuantity').value = '';
            document.getElementById('edit_step').value = '';
            document.getElementById('edit_portionMultiplier').value = 1;
            document.getElementById('edit_seasonMin').value = '';
            document.getElementById('edit_seasonMax').value = '';
            
            // Boolean checkbox'ları temizle
            document.getElementById('edit_keto').checked = false;
            document.getElementById('edit_lowcarb').checked = false;
            document.getElementById('edit_portionFixed').checked = false;
            document.getElementById('edit_fillerLunch').checked = false;
            document.getElementById('edit_fillerDinner').checked = false;
            document.getElementById('edit_isReversedSeason').checked = false;
            
            // Etiket alanlarını temizle
            document.getElementById('edit_tags').value = '';
            document.getElementById('edit_compatibilityTags').value = '';
            document.getElementById('edit_incompatibilityTags').value = '';
            document.getElementById('edit_notes').value = '';
            
            // Modal'ı aç
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingFood = null;
            // Başlığı varsayılana döndür
            document.getElementById('editModalTitle').textContent = '🍽️ Yemek Düzenle';
        }

        async function saveFoodEdit() {
            // editingFood null ise yeni ekleme modundayız

            // Token kontrolü
            const token = getGithubToken();
            if (!token) {
                if (!confirm('❌ GitHub token bulunamadı!\n\nDeğişiklikler sadece tarayıcıda kalacak (sayfa yenilenince kaybolacak).\n\nGitHub\'a kaydetmek için token girmek ister misiniz?')) {
                    return;
                }
                openTokenModal();
                return;
            }

            // Form verilerini al
            const mealTypeArray = [];
            if (document.getElementById('edit_mealType_breakfast').checked) mealTypeArray.push('breakfast');
            if (document.getElementById('edit_mealType_lunch').checked) mealTypeArray.push('lunch');
            if (document.getElementById('edit_mealType_dinner').checked) mealTypeArray.push('dinner');
            
            const dietTypesArray = [];
            if (document.getElementById('edit_dietType_ketojenik').checked) dietTypesArray.push('ketojenik');
            if (document.getElementById('edit_dietType_akdeniz').checked) dietTypesArray.push('akdeniz');
            if (document.getElementById('edit_dietType_vegan').checked) dietTypesArray.push('vegan');
            if (document.getElementById('edit_dietType_glutensiz').checked) dietTypesArray.push('glutensiz');
            
            // Yeni ekleme mi yoksa düzenleme mi?
            const isNewFood = !editingFood;
            const originalFoodName = isNewFood ? null : editingFood.name;
            
            const updatedFood = {
                ...(editingFood || {}), // Yeni ekleme ise boş obje
                name: document.getElementById('edit_name').value.trim(),
                calories: parseFloat(document.getElementById('edit_calories').value) || 0,
                protein: parseFloat(document.getElementById('edit_protein').value) || 0,
                carbs: parseFloat(document.getElementById('edit_carbs').value) || 0,
                fat: parseFloat(document.getElementById('edit_fat').value) || 0,
                category: document.getElementById('edit_category').value.trim(),
                role: document.getElementById('edit_role').value.trim(),
                mealType: mealTypeArray,
                dietTypes: dietTypesArray,
                minQuantity: parseFloat(document.getElementById('edit_minQuantity').value) || undefined,
                maxQuantity: parseFloat(document.getElementById('edit_maxQuantity').value) || undefined,
                step: parseFloat(document.getElementById('edit_step').value) || undefined,
                multiplier: parseFloat(document.getElementById('edit_portionMultiplier').value) || 1,
                seasonRange: (() => {
                    const min = parseInt(document.getElementById('edit_seasonMin').value);
                    const max = parseInt(document.getElementById('edit_seasonMax').value);
                    if (min && max) return `[${min},${max}]`;
                    return undefined;
                })(),
                keto: document.getElementById('edit_keto').checked,
                lowcarb: document.getElementById('edit_lowcarb').checked,
                portionFixed: document.getElementById('edit_portionFixed').checked,
                fillerLunch: document.getElementById('edit_fillerLunch').checked,
                fillerDinner: document.getElementById('edit_fillerDinner').checked,
                isReversedSeason: document.getElementById('edit_isReversedSeason').checked,
                tags: document.getElementById('edit_tags').value.split(',').map(k => k.trim()).filter(k => k),
                compatibilityTags: document.getElementById('edit_compatibilityTags').value.split(',').map(k => k.trim()).filter(k => k),
                incompatibilityTags: document.getElementById('edit_incompatibilityTags').value.split(',').map(k => k.trim()).filter(k => k),
                notes: document.getElementById('edit_notes').value.trim()
            };

            // Modal'ı kapat ve loading göster
            closeEditModal();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">⏳</div>
                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">GitHub'a kaydediliyor...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">Lütfen bekleyin</div>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;"></div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                if (isNewFood) {
                    // 🆕 Yeni yemek ekleme
                    // Aynı isimde yemek var mı kontrol et
                    const existingFood = foodDatabase.find(f => f.name === updatedFood.name);
                    if (existingFood) {
                        document.body.removeChild(loadingDiv);
                        alert('❌ Bu isimde bir yemek zaten mevcut!\n\nLütfen farklı bir isim kullanın.');
                        openAddFoodModal(); // Formu tekrar aç
                        // Girilen değerleri geri yükle
                        document.getElementById('edit_name').value = updatedFood.name;
                        return;
                    }
                    
                    // Yeni yemeği veritabanına ekle
                    foodDatabase.push(updatedFood);
                    
                    // GitHub'a kaydet
                    await saveFoodListToGithub(
                        foodDatabase,
                        `Yeni yemek eklendi: ${updatedFood.name}`
                    );
                    
                    // Loading'i kaldır
                    document.body.removeChild(loadingDiv);
                    
                    console.log('✅ Yeni yemek GitHub\'a eklendi:', updatedFood.name);
                    alert(`✅ Başarılı!\n\n"${updatedFood.name}" yemeği GitHub'a eklendi.\n\nDeğişiklik food_list.json dosyasına yazıldı.`);
                } else {
                    // ✏️ Mevcut yemek düzenleme
                    const index = foodDatabase.findIndex(f => f.name === originalFoodName);
                    if (index !== -1) {
                        foodDatabase[index] = updatedFood;
                    }

                    // GitHub'a kaydet
                    await saveFoodListToGithub(
                        foodDatabase,
                        `Yemek güncellendi: ${updatedFood.name}`
                    );

                    // Loading'i kaldır
                    document.body.removeChild(loadingDiv);
                    
                    console.log('✅ Yemek GitHub\'da güncellendi:', updatedFood.name);
                    alert(`✅ Başarılı!\n\n"${updatedFood.name}" yemeği GitHub'da güncellendi.\n\nDeğişiklik food_list.json dosyasına yazıldı.`);
                }

                // İstatistikleri ve ekranı yenile
                updateStats();
                displayFoods();

            } catch (error) {
                // Loading'i kaldır
                document.body.removeChild(loadingDiv);

                console.error('GitHub kaydetme hatası:', error);
                
                // Token hatası mı kontrol et
                if (error.message.includes('Token Hatası') || error.message.includes('401')) {
                    alert(error.message);
                    openTokenModal(); // Token modalını aç
                } else {
                    alert(`❌ GitHub'a kaydedilemedi!\n\nHata: ${error.message}\n\n💡 İpucu: Token'ınızın "repo" iznine sahip olduğundan emin olun.`);
                }
            }
        }

        // 🗑️ SİLME FONKSİYONU
        function deleteFoodFromCard(cardElement) {
            try {
                const foodData = cardElement.getAttribute('data-food');
                const food = JSON.parse(decodeURIComponent(atob(foodData)));
                deleteFood(food);
            } catch (error) {
                console.error('Food data parse hatası:', error);
                alert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
            }
        }

        async function deleteFood(food) {
            if (!confirm(`❌ "${food.name}" yemeğini silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                return;
            }

            // Token kontrolü
            const token = getGithubToken();
            if (!token) {
                if (!confirm('❌ GitHub token bulunamadı!\n\nDeğişiklik sadece tarayıcıda kalacak (sayfa yenilenince geri gelecek).\n\nGitHub\'dan kalıcı silmek için token girmek ister misiniz?')) {
                    // Token istemiyorsa sadece tarayıcıda sil
                    const index = foodDatabase.findIndex(f => f.name === food.name);
                    if (index !== -1) {
                        foodDatabase.splice(index, 1);
                    }
                    updateStats();
                    displayFoods();
                    return;
                }
                openTokenModal();
                return;
            }

            // Loading göster
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">🗑️</div>
                    <div style="font-size: 18px; font-weight: 600; color: #dc3545;">GitHub'dan siliniyor...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">Lütfen bekleyin</div>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;"></div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // Veritabanından sil
                const index = foodDatabase.findIndex(f => f.name === food.name);
                if (index !== -1) {
                    foodDatabase.splice(index, 1);
                }

                // GitHub'a kaydet
                await saveFoodListToGithub(
                    foodDatabase,
                    `Yemek silindi: ${food.name}`
                );

                // Loading'i kaldır
                document.body.removeChild(loadingDiv);

                console.log('✅ Yemek GitHub\'dan silindi:', food.name);
                alert(`✅ Başarılı!\n\n"${food.name}" yemeği GitHub'dan kalıcı olarak silindi.\n\nDeğişiklik food_list.json dosyasına yazıldı.`);

                // İstatistikleri ve ekranı yenile
                updateStats();
                displayFoods();

            } catch (error) {
                // Loading'i kaldır
                document.body.removeChild(loadingDiv);

                console.error('GitHub silme hatası:', error);
                
                // Token hatası mı kontrol et
                if (error.message.includes('Token Hatası') || error.message.includes('401')) {
                    alert(error.message);
                    openTokenModal(); // Token modalını aç
                } else {
                    alert(`❌ GitHub'dan silinemedi!\n\nHata: ${error.message}\n\n💡 İpucu: Token'ınızın "repo" iznine sahip olduğundan emin olun.`);
                }
            }
        }

        // ESC ile modalları kapat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeTokenModal();
                closeEditModal();
            }
        });

        // ========================================
        // YENİ: Akıllı Dropdown Fonksiyonları
        // ========================================

        // Yemek Eşleştirme Dropdown
        function renderYemekEslestirmeList() {
            const container = document.getElementById('yemekEslestirmeList');
            if (!container) return;

            if (Object.keys(yemekVeritabaniEslestirme).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Henüz eşleştirme yok</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            Object.entries(yemekVeritabaniEslestirme).forEach(([key, value]) => {
                const orijinal = value.orijinalMetin || key;
                const hedef = value.hedefYemek || value;
                const notlar = value.notlar || '';
                
                html += `
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="margin-bottom: 5px;">
                                <strong style="color: #2196F3;">${orijinal}</strong>
                                <span style="color: #999; margin: 0 8px;">→</span>
                                <strong style="color: #28a745;">${hedef}</strong>
                            </div>
                            ${notlar ? `<div style="font-size: 12px; color: #666;">📝 ${notlar}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn" onclick="editYemekEslestirme('${key}')" style="background: #ffc107; color: #000; padding: 6px 12px; font-size: 12px;">
                                ✏️ Düzenle
                            </button>
                            <button class="btn" onclick="deleteYemekEslestirme('${key}')" style="background: #dc3545; color: white; padding: 6px 12px; font-size: 12px;">
                                🗑️ Sil
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Yemek yasak listesini render et
        function renderYemekYasakList() {
            const container = document.getElementById('yemekYasakList');
            if (!container) return;

            if (Object.keys(yemekVeritabaniYasaklar).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Henüz yasak yok</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            Object.entries(yemekVeritabaniYasaklar).forEach(([key, value]) => {
                const orijinal = value.orijinalMetin || key;
                const yasaklar = value.yasakliYemekler || [];
                const neden = value.neden || '';
                
                html += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <strong style="color: #856404;">${orijinal}</strong>
                                ${neden ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">💬 ${neden}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px;">
                                <button class="btn" onclick="editYemekYasak('${key}')" style="background: #ffc107; color: #000; padding: 6px 12px; font-size: 12px;">
                                    ✏️ Düzenle
                                </button>
                                <button class="btn" onclick="deleteYemekYasak('${key}')" style="background: #dc3545; color: white; padding: 6px 12px; font-size: 12px;">
                                    🗑️ Sil
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                            ${yasaklar.map(y => `<span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">🚫 ${y}</span>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Yemek eşleştirmeyi kaydet
        async function saveYemekEslestirme() {
            const aramaTxt = document.getElementById('yemekEslestirmeArama').value.trim();
            const hedefTxt = document.getElementById('yemekEslestirmeHedef').value.trim();

            if (!aramaTxt || !hedefTxt) {
                alert('⚠️ Lütfen her iki alanı da doldurun!');
                return;
            }

            // Normalize key
            const key = normalizeText(aramaTxt);

            // Yeni eşleştirme objesi
            yemekVeritabaniEslestirme[key] = {
                orijinalMetin: aramaTxt,
                hedefYemek: hedefTxt,
                eklemeTarihi: new Date().toISOString(),
                notlar: `"${aramaTxt}" → "${hedefTxt}" eşleştirildi`
            };

            // GitHub'a kaydet
            const jsonData = {
                version: "1.0",
                aciklama: "Şablonlardaki yemek adlarını food_list.json'daki yemeklerle manuel eşleştir",
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: yemekVeritabaniEslestirme
            };

            try {
                await updateGithubFile(
                    'data/yemek_veritabani_eslestirme.json',
                    JSON.stringify(jsonData, null, 2),
                    `Yemek eşleştirme eklendi: ${aramaTxt} → ${hedefTxt}`
                );

                showNotification(`✅ Eşleştirme kaydedildi: ${aramaTxt} → ${hedefTxt}`, 'success');
                clearYemekEslestirmeForm();
                await loadYemekVeritabaniEslestirme();
                renderYemekEslestirmeList();
            } catch (error) {
                console.error('Kayıt hatası:', error);
                showNotification('❌ Kayıt başarısız!', 'error');
            }
        }

        // Yemek yasağı kaydet
        async function saveYemekYasak() {
            const aramaTxt = document.getElementById('yemekYasakArama').value.trim();
            const nedenTxt = document.getElementById('yemekYasakNeden').value.trim();

            if (!aramaTxt || currentYemekYasakItems.length === 0) {
                alert('⚠️ Lütfen arama terimini ve en az bir yasaklı yemek ekleyin!');
                return;
            }

            // Normalize key
            const key = normalizeText(aramaTxt);

            // Yeni yasak objesi
            yemekVeritabaniYasaklar[key] = {
                orijinalMetin: aramaTxt,
                yasakliYemekler: currentYemekYasakItems,
                eklemeTarihi: new Date().toISOString(),
                neden: nedenTxt || `"${aramaTxt}" bu yemeklerle eşleşmemeli`
            };

            // GitHub'a kaydet
            const jsonData = {
                version: "1.0",
                aciklama: "Şablonlardaki yemeklerin food_list.json'da yanlış eşleşmesini önlemek için yasaklar",
                sonGuncelleme: new Date().toISOString(),
                yasaklar: yemekVeritabaniYasaklar
            };

            try {
                await updateGithubFile(
                    'data/yemek_veritabani_yasaklar.json',
                    JSON.stringify(jsonData, null, 2),
                    `Yemek yasağı eklendi: ${aramaTxt} (${currentYemekYasakItems.length} yasak)`
                );

                showNotification(`🚫 Yasak kaydedildi: ${aramaTxt}`, 'success');
                clearYemekYasakForm();
                await loadYemekVeritabaniYasaklar();
                renderYemekYasakList();
            } catch (error) {
                console.error('Kayıt hatası:', error);
                showNotification('❌ Kayıt başarısız!', 'error');
            }
        }

        // ========================================
        // YENİ: Akıllı Dropdown Fonksiyonları
        // ========================================

        // Yemek Eşleştirme Dropdown
        function showYemekEslestirmeDropdown() {
            const dropdown = document.getElementById('yemekEslestirmeDropdown');
            if (!dropdown) return;
            filterYemekEslestirmeDropdown('');
            dropdown.style.display = 'block';
        }

        function hideYemekEslestirmeDropdown() {
            const dropdown = document.getElementById('yemekEslestirmeDropdown');
            if (dropdown) dropdown.style.display = 'none';
        }

        function filterYemekEslestirmeDropdown(searchText) {
            const dropdown = document.getElementById('yemekEslestirmeDropdown');
            if (!dropdown || !foodDatabase || foodDatabase.length === 0) return;

            const search = searchText.toLowerCase().trim();
            
            let filtered = foodDatabase;
            if (search) {
                filtered = foodDatabase.filter(food => 
                    food.name.toLowerCase().includes(search)
                );
            }

            filtered = filtered.slice(0, 50);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">Sonuç bulunamadı</div>';
                dropdown.style.display = 'block';
                return;
            }

            let html = filtered.map(food => `
                <div onclick="selectYemekEslestirmeHedef('${food.name.replace(/'/g, "\\'")}')" 
                     style="padding: 10px; cursor: pointer; background: white; color: #333; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#e6f7e6'"
                     onmouseout="this.style.background='white'">
                    <strong>${food.name}</strong>
                    <span style="font-size: 11px; color: #999; margin-left: 8px;">
                        (${food.calories} kcal, P: ${food.protein}g, C: ${food.carbs}g, F: ${food.fat}g)
                    </span>
                </div>
            `).join('');

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectYemekEslestirmeHedef(yemekAdi) {
            document.getElementById('yemekEslestirmeHedef').value = yemekAdi;
            hideYemekEslestirmeDropdown();
        }

        // Sayfa dışına tıklanınca dropdown kapat
        document.addEventListener('click', (e) => {
            const inputEslestirme = document.getElementById('yemekEslestirmeHedef');
            const dropdownEslestirme = document.getElementById('yemekEslestirmeDropdown');
            
            if (dropdownEslestirme && inputEslestirme && !dropdownEslestirme.contains(e.target) && e.target !== inputEslestirme) {
                hideYemekEslestirmeDropdown();
            }
        });

        // ========================================
        // Yemek Yasak Dropdown (MEVCUT)
        // ========================================

        // Yasak listesine item ekle (manuel veya dropdown)
        function addYemekYasakItemManual() {
            const hedefTxt = document.getElementById('yemekYasakHedef').value.trim();
            if (!hedefTxt) {
                alert('⚠️ Lütfen yasaklı yemek adını girin!');
                return;
            }

            addYemekYasakItemFromText(hedefTxt);
        }

        function addYemekYasakItemFromText(yemekAdi) {
            if (!yemekAdi) return;

            if (currentYemekYasakItems.includes(yemekAdi)) {
                showNotification(`⚠️ "${yemekAdi}" zaten eklendi!`, 'warning');
                return;
            }

            currentYemekYasakItems.push(yemekAdi);
            renderYemekYasakItems();
            document.getElementById('yemekYasakHedef').value = '';
            hideYemekYasakDropdown();
            showNotification(`✅ "${yemekAdi}" eklendi`, 'success');
        }

        // Dropdown göster/gizle
        function showYemekYasakDropdown() {
            const dropdown = document.getElementById('yemekYasakDropdown');
            if (!dropdown) return;

            // İlk açılışta tüm yemekleri göster
            filterYemekYasakDropdown('');
            dropdown.style.display = 'block';
        }

        function hideYemekYasakDropdown() {
            const dropdown = document.getElementById('yemekYasakDropdown');
            if (dropdown) dropdown.style.display = 'none';
        }

        // Dropdown filtrele
        function filterYemekYasakDropdown(searchText) {
            const dropdown = document.getElementById('yemekYasakDropdown');
            if (!dropdown || !foodDatabase || foodDatabase.length === 0) return;

            const search = searchText.toLowerCase().trim();
            
            // Filtreleme
            let filtered = foodDatabase;
            if (search) {
                filtered = foodDatabase.filter(food => 
                    food.name.toLowerCase().includes(search)
                );
            }

            // Maksimum 50 sonuç göster (performans için)
            filtered = filtered.slice(0, 50);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">Sonuç bulunamadı</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Dropdown HTML oluştur
            let html = filtered.map(food => {
                const isAdded = currentYemekYasakItems.includes(food.name);
                const bgColor = isAdded ? '#f0f0f0' : 'white';
                const textColor = isAdded ? '#999' : '#333';
                const cursor = isAdded ? 'not-allowed' : 'pointer';
                const checkmark = isAdded ? '✓ ' : '';

                return `
                    <div onclick="${isAdded ? '' : `addYemekYasakItemFromText('${food.name.replace(/'/g, "\\'")}')`}" 
                         style="padding: 10px; cursor: ${cursor}; background: ${bgColor}; color: ${textColor}; border-bottom: 1px solid #eee; transition: background 0.2s;"
                         onmouseover="if(!${isAdded}) this.style.background='#ffe6e6'"
                         onmouseout="this.style.background='${bgColor}'">
                        ${checkmark}<strong>${food.name}</strong>
                        <span style="font-size: 11px; color: #999; margin-left: 8px;">
                            (${food.calories} kcal, P: ${food.protein}g, C: ${food.carbs}g, F: ${food.fat}g)
                        </span>
                    </div>
                `;
            }).join('');

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        // Sayfa dışına tıklanınca dropdown kapat
        document.addEventListener('click', (e) => {
            const input = document.getElementById('yemekYasakHedef');
            const dropdown = document.getElementById('yemekYasakDropdown');
            
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                hideYemekYasakDropdown();
            }
        });

        // Yasak listesine item ekle (ESKİ FONKSİYON - YENİ İSİM)
        function addYemekYasakItem() {
            addYemekYasakItemManual();
        }

        // Yasak item'ları render et
        function renderYemekYasakItems() {
            const container = document.getElementById('yemekYasakItems');
            if (!container) return;

            if (currentYemekYasakItems.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 13px;">Yasaklı yemekleri yukarıdan ekleyin...</span>';
                return;
            }

            container.innerHTML = currentYemekYasakItems.map((item, index) => `
                <span style="background: #dc3545; color: white; padding: 6px 12px; border-radius: 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                    ${item}
                    <button onclick="removeYemekYasakItem(${index})" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 0;">×</button>
                </span>
            `).join('');
        }

        // Yasak item'ı sil
        function removeYemekYasakItem(index) {
            currentYemekYasakItems.splice(index, 1);
            renderYemekYasakItems();
        }

        // Eşleştirmeyi düzenle
        function editYemekEslestirme(key) {
            const item = yemekVeritabaniEslestirme[key];
            if (!item) return;

            // Tab'a geç (zaten açık olmalı)
            switchTab('yemekEslestirme');

            // Formu doldur
            document.getElementById('yemekEslestirmeArama').value = item.orijinalMetin || key;
            document.getElementById('yemekEslestirmeHedef').value = item.hedefYemek || item;

            // Scroll to form
            document.getElementById('yemekEslestirmeArama').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('yemekEslestirmeArama').focus();
        }

        // Yasağı düzenle
        function editYemekYasak(key) {
            const item = yemekVeritabaniYasaklar[key];
            if (!item) return;

            // Tab'a geç
            switchTab('yemekYasak');

            // Formu doldur
            document.getElementById('yemekYasakArama').value = item.orijinalMetin || key;
            document.getElementById('yemekYasakNeden').value = item.neden || '';
            
            // Yasak itemları doldur
            currentYemekYasakItems = [...(item.yasakliYemekler || [])];
            renderYemekYasakItems();

            // Scroll to form
            document.getElementById('yemekYasakArama').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('yemekYasakArama').focus();
        }

        // Eşleştirmeyi sil
        async function deleteYemekEslestirme(key) {
            if (!confirm(`"${yemekVeritabaniEslestirme[key]?.orijinalMetin}" eşleştirmesini silmek istediğinize emin misiniz?`)) {
                return;
            }

            delete yemekVeritabaniEslestirme[key];

            const jsonData = {
                version: "1.0",
                aciklama: "Şablonlardaki yemek adlarını food_list.json'daki yemeklerle manuel eşleştir",
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: yemekVeritabaniEslestirme
            };

            try {
                await updateGithubFile(
                    'data/yemek_veritabani_eslestirme.json',
                    JSON.stringify(jsonData, null, 2),
                    `Yemek eşleştirme silindi: ${key}`
                );

                showNotification('✅ Eşleştirme silindi', 'success');
                await loadYemekVeritabaniEslestirme();
                renderYemekEslestirmeList();
            } catch (error) {
                console.error('Silme hatası:', error);
                showNotification('❌ Silme başarısız!', 'error');
            }
        }

        // Yasağı sil
        async function deleteYemekYasak(key) {
            if (!confirm(`"${yemekVeritabaniYasaklar[key]?.orijinalMetin}" yasağını silmek istediğinize emin misiniz?`)) {
                return;
            }

            delete yemekVeritabaniYasaklar[key];

            const jsonData = {
                version: "1.0",
                aciklama: "Şablonlardaki yemeklerin food_list.json'da yanlış eşleşmesini önlemek için yasaklar",
                sonGuncelleme: new Date().toISOString(),
                yasaklar: yemekVeritabaniYasaklar
            };

            try {
                await updateGithubFile(
                    'data/yemek_veritabani_yasaklar.json',
                    JSON.stringify(jsonData, null, 2),
                    `Yemek yasağı silindi: ${key}`
                );

                showNotification('✅ Yasak silindi', 'success');
                await loadYemekVeritabaniYasaklar();
                renderYemekYasakList();
            } catch (error) {
                console.error('Silme hatası:', error);
                showNotification('❌ Silme başarısız!', 'error');
            }
        }

        // Form temizleme
        function clearYemekEslestirmeForm() {
            document.getElementById('yemekEslestirmeArama').value = '';
            document.getElementById('yemekEslestirmeHedef').value = '';
        }

        function clearYemekYasakForm() {
            document.getElementById('yemekYasakArama').value = '';
            document.getElementById('yemekYasakHedef').value = '';
            document.getElementById('yemekYasakNeden').value = '';
            currentYemekYasakItems = [];
            renderYemekYasakItems();
        }

        // ========================================
        // YENİ FONKSYONLAR SONU
        // ========================================

        // Başlat
        loadFoodData();
    </script>

    <!-- Düzenleme Modali -->
    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2 id="editModalTitle">🍽️ Yemek Düzenle</h2>
                <button class="modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="edit-modal-body">
                <form id="editForm" onsubmit="event.preventDefault(); saveFoodEdit();">
                    <div class="form-group">
                        <label>Yemek Adı *</label>
                        <input type="text" id="edit_name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Kalori (kcal) *</label>
                            <input type="number" id="edit_calories" step="0.1" readonly style="background: #f0f0f0; cursor: not-allowed;" title="Otomatik hesaplanır: (Karb×4) + (Protein×4) + (Yağ×9)">
                        </div>
                        <div class="form-group">
                            <label>Protein (g) *</label>
                            <input type="number" id="edit_protein" step="0.1" required oninput="calculateCalories()">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Karbonhidrat (g) *</label>
                            <input type="number" id="edit_carbs" step="0.1" required oninput="calculateCalories()">
                        </div>
                        <div class="form-group">
                            <label>Yağ (g) *</label>
                            <input type="number" id="edit_fat" step="0.1" required oninput="calculateCalories()">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Kategori *</label>
                            <select id="edit_category" required>
                                <option value="">-- Kategori Seçin --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rol *</label>
                            <select id="edit_role" required>
                                <option value="">-- Rol Seçin --</option>
                                <option value="mainDish">Ana Yemek</option>
                                <option value="sideDish">Yan Yemek</option>
                                <option value="drink">İçecek</option>
                                <option value="supplement">Takviye</option>
                                <option value="snack">Atıştırmalık</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Öğün Tipi (Birden fazla seçilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_mealType_breakfast" value="breakfast">
                                🌅 Kahvaltı
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_mealType_lunch" value="lunch">
                                ☀️ Öğle
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_mealType_dinner" value="dinner">
                                🌙 Akşam
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Porsiyon Çarpanı</label>
                            <input type="number" id="edit_portionMultiplier" step="0.1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Diyet Tipleri (Birden fazla seçilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_dietType_ketojenik" value="ketojenik">
                                🥗 Ketojenik
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_dietType_akdeniz" value="akdeniz">
                                🌊 Akdeniz
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_dietType_vegan" value="vegan">
                                🌱 Vegan
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_dietType_glutensiz" value="glutensiz">
                                🌾 Glutensiz
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Min Miktar</label>
                            <input type="number" id="edit_minQuantity" step="0.1" placeholder="Minimum porsiyon">
                        </div>
                        <div class="form-group">
                            <label>Max Miktar</label>
                            <input type="number" id="edit_maxQuantity" step="0.1" placeholder="Maksimum porsiyon">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Adım (Step)</label>
                            <input type="number" id="edit_step" step="0.1" placeholder="Artış miktarı">
                        </div>
                        <div class="form-group">
                            <label>Porsiyon Çarpanı</label>
                            <input type="number" id="edit_portionMultiplier" step="0.1" value="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Sezon Başlangıç (Ay)</label>
                            <input type="number" id="edit_seasonMin" min="1" max="12" placeholder="1-12">
                        </div>
                        <div class="form-group">
                            <label>Sezon Bitiş (Ay)</label>
                            <input type="number" id="edit_seasonMax" min="1" max="12" placeholder="1-12">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>🏷️ Özel Özellikler</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_keto">
                                🥗 Keto
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_lowcarb">
                                📉 Düşük Karb
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_portionFixed">
                                🔒 Porsiyon Sabit
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_fillerLunch">
                                🍽️ Öğle Dolgu
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_fillerDinner">
                                🌙 Akşam Dolgu
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="edit_isReversedSeason">
                                🔄 Ters Sezon
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>🏷️ Etiketler (Tags) - virgülle ayırın</label>
                        <input type="text" id="edit_tags" placeholder="ör: domates, meyve, salata">
                    </div>

                    <div class="form-group">
                        <label>✅ Uyumluluk Etiketleri (compatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="edit_compatibilityTags" placeholder="ör: tavuk, zeytinyağı">
                    </div>

                    <div class="form-group">
                        <label>❌ Uyumsuzluk Etiketleri (incompatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="edit_incompatibilityTags" placeholder="ör: süt, peynir">
                    </div>

                    <div class="form-group">
                        <label>📝 Notlar</label>
                        <textarea id="edit_notes" placeholder="Ek bilgiler, özel notlar..."></textarea>
                    </div>
                </form>
            </div>
            <div class="edit-modal-footer">
                <button class="cancel-btn" type="button" onclick="closeEditModal()">İptal</button>
                <button class="save-btn" type="button" onclick="saveFoodEdit()">💾 Kaydet</button>
            </div>
        </div>
    </div>

</body>
</html>
