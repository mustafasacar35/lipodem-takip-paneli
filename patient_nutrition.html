<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Beslenme Planım">
    <meta name="application-name" content="Beslenme Planım">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="./logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="./logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png">
    <link rel="manifest" href="./manifest.json">

    <title>Beslenme Planım - Lipodem Takip</title>
    
    <!-- Nutrition Data Manager -->
    <script src="nutrition_data_manager.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iOS PWA için güvenli alan ayarları - Minimal padding */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: calc(2px + env(safe-area-inset-top, 0px)) !important;
            }
        }

        /* iPhone kamera çentiği altından başlasın */
        @media only screen and (max-device-width: 812px) {
            .header {
                padding-top: env(safe-area-inset-top, 6px) !important;
            }
        }

        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none; /* Mobil cihazlarda pull-to-refresh'i engelle */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
            touch-action: manipulation; /* Hızlı dokunma tepkisi - iOS'ta 300ms gecikmesini kaldır */
            -webkit-user-select: none; /* iOS'ta metin seçimini engelle */
            -webkit-touch-callout: none; /* iOS'ta uzun basma menüsünü engelle */
            user-select: none; /* Genel metin seçimini engelle */
            
            /* iOS Safe Area desteği - Sadece yanlar ve alt */
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header - Mobil Optimize */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            min-height: 44px;
            
            /* iOS kamera çentiği için minimal margin */
            margin-top: 0px;
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0; /* Overflow için */
        }

        .patient-info h2 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .patient-info p {
            display: none; /* Mobilde "Beslenme Programı" yazısını gizle */
        }

        .header-right {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap; /* Butonlar her zaman yan yana */
        }

        /* Header butonları - İkonik yuvarlak */
        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            
            /* iOS için minimum dokunma alanı */
            min-width: 44px;
            min-height: 44px;
            touch-action: manipulation;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.05);
        }

        /* Geri Butonu - Mobil versiyondan dönüş */
        .btn-back {
            background: rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.8);
            color: white;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none; /* Varsayılan gizli */
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-back:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        /* Mobil Versiyon iFrame Container */
        .mobile-iframe-container {
            display: none;
            position: fixed;
            top: 52px; /* Header yüksekliği + biraz margin */
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 999;
        }

        .mobile-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .btn-header span {
            display: none; /* Mobilde metin gizle, sadece ikon */
        }

        /* Main Container */
        .main-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 10px 12px;
            
            /* Safe area için padding - sadır üst kısım */
            padding-top: max(10px, calc(10px + env(safe-area-inset-top, 0px)));
        }

        /* Tabs Container - Mobil Optimize */
        .tabs-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap; /* Responsive - ikinci satıra geçebilir */
        }

        .tabs-container {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scroll-behavior: smooth; /* Akıcı kaydırma */
            padding: 2px;
            flex: 1;
            min-width: 0;
        }

        .tabs-container::-webkit-scrollbar {
            height: 4px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .tab {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: auto;
            font-size: 13px;
        }

        .tab:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102,126,234,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .tab-close {
            margin-left: 6px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.8;
        }

        .tab-close:hover {
            opacity: 1;
            background: rgba(255,255,255,0.5);
        }

        /* Yeni Hafta Ekle Butonu - Sadece Artı İkon */
        .btn-add-week {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-add-week:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76,175,80,0.4);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .week-content {
            display: none;
        }

        .week-content.active {
            display: block;
        }

        /* Week Header - Mobil Optimize (Aktif Hafta Başlığı Kaldırıldı) */
        .week-header {
            display: none; /* Aktif hafta için ayrı başlık yok - tab zaten belirgin */
        }

        /* Week Macros - İnce Bant */
        .week-macros {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .week-macros .macro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .week-macros .label {
            font-size: 10px;
            opacity: 0.7;
            font-weight: 500;
        }

        .week-macros .value {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
        }

        .week-info p {
            color: #666;
            font-size: 14px;
        }

        .week-stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-box .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-box .value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-top: 3px;
        }

        /* Day Cards */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
        }

        .day-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .day-date {
            font-size: 12px;
            color: #666;
        }

        .btn-refresh-day {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .btn-refresh-day::before {
            content: "↻";
            font-size: 14px;
            font-weight: bold;
            display: block;
        }

        .btn-refresh-day:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #5a3a7c 100%);
        }

        .btn-refresh-day:hover::before {
            animation: spin 0.6s ease-in-out;
        }

        .btn-delete-day {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        .btn-delete-day:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.5);
        }

        .btn-delete-day:active {
            transform: scale(0.95);
        }

        .btn-template-edit {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
        }

        .btn-template-edit:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.5);
        }

        .btn-template-edit:active {
            transform: scale(0.95);
        }

        .btn-food-admin {
            background: linear-gradient(135deg, #FF6B6B 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        .btn-food-admin:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.5);
        }

        .btn-food-admin:active {
            transform: scale(0.95);
        }

        .day-macros {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .macro {
            flex: 1;
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .macro .label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }

        .macro .value {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-top: 2px;
        }

        .meals-list {
            margin-top: 10px;
        }

        .meal-item {
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .meal-item-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .meal-item-content {
            padding: 10px;
        }

        .meal-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .meal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .meal-table thead {
            background: #f8f9fa;
        }

        .meal-table th {
            padding: 6px 4px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .meal-table td {
            padding: 6px 4px;
            color: #666;
            border-bottom: 1px solid #f1f3f5;
        }

        .meal-table tbody tr:last-child td {
            border-bottom: none;
        }

        .meal-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Tarif Badge Styles */
        .tarif-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }

        .tarif-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea87a 100%);
        }

        .tarif-badge:active {
            transform: translateY(0);
        }

        /* Refresh Food Button - Yuvarlak İkon (Dönen Ok Animasyonu) */
        .btn-refresh-food {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 12px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .btn-refresh-food::before {
            content: "↻";
            font-size: 14px;
            font-weight: bold;
            display: block;
        }

        .btn-refresh-food:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(0, 123, 255, 0.5);
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }

        .btn-refresh-food:hover::before {
            animation: spin 0.6s ease-in-out;
        }

        .btn-refresh-food:active {
            transform: scale(1.0);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Diyet Tipi Rozetleri (Keto/Lowcarb) */
        .diet-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            white-space: nowrap;
        }

        .diet-badge-keto {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }

        .diet-badge-lowcarb {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            box-shadow: 0 1px 3px rgba(255, 193, 7, 0.3);
        }

        /* Genel Rozet Stilleri */
        .food-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            white-space: nowrap;
        }

        .badge-role {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
        }

        .badge-category {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
        }

        .badge-season {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            box-shadow: 0 1px 3px rgba(6, 182, 212, 0.3);
        }

        .badge-mealtype {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3);
        }

        .badge-tags {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            box-shadow: 0 1px 3px rgba(236, 72, 153, 0.3);
        }

        .meal-foods {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }

        .btn-add-day {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-add-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Template Selection */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .template-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-item:hover {
            border-color: #667eea;
            background: #e7f0ff;
        }

        .template-item.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-item.used-template {
            background: #d4edda;
            border-color: #28a745;
        }

        .template-item.used-template:hover {
            background: #c3e6cb;
            border-color: #28a745;
        }

        .template-item.used-template.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .template-macros {
            font-size: 11px;
            opacity: 0.8;
        }

        .btn-sort {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-sort:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-sort:active {
            transform: translateY(0);
        }

        .template-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .template-table th,
        .template-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: left;
        }

        .template-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .template-table th:hover {
            background: #5568d3;
        }

        .template-table th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
            font-size: 0.8em;
        }

        .template-table th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        .template-table th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        .template-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-table tbody tr:hover {
            background: #f8f9fa;
        }

        .template-table tbody tr.selected {
            background: #cff4fc;
            border-left: 4px solid #0dcaf0;
        }

        .template-table tbody tr.used-template {
            background: #d4edda;
        }

        .template-table .meal-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .template-selected-days {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 11px;
            font-weight: 600;
        }

        .template-item:not(.selected) .template-selected-days {
            border-top-color: #dee2e6;
            color: #0d6efd;
        }

        /* Selected Templates Band */
        #selectedTemplatesBand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .selected-day-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #055160;
            background: #cff4fc;
            border: 2px solid #0dcaf0;
            position: relative;
        }

        .selected-day-badge .order-number {
            background: rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .selected-day-badge .remove-badge {
            background: rgba(255, 255, 255, 0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .selected-day-badge .remove-badge:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            .tabs-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            .days-grid {
                grid-template-columns: 1fr;
            }

            .week-stats {
                flex-direction: column;
                gap: 10px;
            }

            .header-right {
                gap: 5px; /* Mobilde butonlar yine yan yana, sadece gap küçülüyor */
            }

            .btn-header {
                width: 32px; /* Mobilde biraz daha küçük */
                height: 32px;
                font-size: 16px;
            }
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Message */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            animation: slideInUp 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Admin Modal Tab Styles */
        .admin-tab-btn {
            flex: 1;
            min-width: 180px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .admin-tab-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .admin-tab-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #adminTabContent {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            min-height: 400px;
        }

        /* ============================================
           🔗 ADMIN MODAL: TARIF KARTLARI GRID SİSTEMİ
           ============================================ */
        
        /* Seçili Tarif Kartları Listesi */
        .selected-tarif-list {
            background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .selected-tarif-list-title {
            font-size: 14px;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-tarif-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-tarif-tag {
            background: white;
            border: 1px solid #28a745;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 13px;
            color: #28a745;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .selected-tarif-tag:hover {
            background: #fff5f5;
            border-color: #dc3545;
            color: #dc3545;
        }

        .selected-tarif-tag .remove-icon {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .selected-tarif-empty {
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        /* Search Input - Güzelleştirilmiş */
        .tarif-search-container {
            margin-bottom: 20px;
        }

        .tarif-search-input {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .tarif-search-input:focus {
            outline: none;
            border-color: #764ba2;
            background: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .tarif-search-input::placeholder {
            color: #999;
            font-weight: 400;
        }

        /* Tarif Kartları Grid */
        .tarif-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .tarif-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .tarif-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .tarif-item.selected {
            border-color: #28a745;
            background: #f0fff4;
        }

        .tarif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .tarif-name {
            font-size: 12px;
            color: #333;
            word-break: break-word;
            font-weight: 500;
        }

        /* Seçili Kartlar Sayacı */
        .admin-selected-count {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .admin-selected-count.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Yükleme Animasyonu */
        .admin-loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .admin-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Kart Bulunamadı */
        .admin-no-results {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 15px;
        }

        .admin-no-results::before {
            content: '🔍';
            display: block;
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* ========================================
           TAB 3 & TAB 4: YEMEK VERİTABANI STİLLERİ
           ======================================== */
        
        /* Yemek listesi item (Tab 3 - Tek seçim) */
        .food-db-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-db-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .food-db-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Yasak yemek item (Tab 4 - Çoklu seçim) */
        .food-ban-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }

        .food-ban-item:hover {
            border-color: #f44336;
            transform: translateX(5px);
        }

        .food-ban-item.selected {
            border-color: #f44336;
            background: #fff3f3;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }
    </style>
</head>
<body>
    <!-- iOS Safe Area Spacer - iPhone için üst boşluk -->
    <div style="
        height: env(safe-area-inset-top, 0px);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: sticky;
        top: 0;
        z-index: 1001;
        pointer-events: none;
    "></div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <!-- Geri Butonu - Mobil versiyondan dönüş için -->
            <button class="btn-back" id="btnBack" onclick="closeMobileVersion()" title="Geri Dön">
                ◀
            </button>
            <div class="patient-info">
                <h2 id="headerPatientName">Yükleniyor...</h2>
                <p id="patientStats">Beslenme Programı</p>
            </div>
        </div>
        <div class="header-right">
            <!-- Mobil Versiyon Butonu (Alternatif Arama) -->
            <button class="btn-header" onclick="openMobileVersion()" title="Alternatif Yemek Arama">
                �
            </button>
            <!-- Ayarlar Butonu - Sadece İkon -->
            <button class="btn-header" onclick="openSettings()" title="Ayarlar">
                ⚙️
            </button>
            <!-- Çıkış Butonu - Sadece İkon -->
            <button class="btn-header" onclick="logout()" title="Çıkış">
                🚪
            </button>
        </div>
    </div>

    <!-- Mobil Versiyon iFrame Container -->
    <div class="mobile-iframe-container" id="mobileIframeContainer">
        <iframe id="mobileIframe" src=""></iframe>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Tabs -->
        <div class="tabs-wrapper">
            <div class="tabs-container" id="tabsContainer">
                <!-- Tabs will be generated here -->
                <!-- Yeni Hafta Ekle butonu renderTabs() içinde dinamik oluşturulacak -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <div class="loading">
                <div class="spinner"></div>
                <p>Yükleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Add Day Modal -->
    <div class="modal" id="addDayModal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Gün Ekle (Çoklu Seçim Yapabilirsiniz)</h3>
                <button class="modal-close" onclick="closeModal('addDayModal')">&times;</button>
            </div>
            
            <!-- Otomatik Haftalık Planlama Butonu -->
            <div style="margin-bottom: 20px;">
                <button 
                    onclick="openAutoWeekPlanModal()" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';"
                >
                    <span style="font-size: 24px;">🤖</span>
                    <span>OTOMATIK HAFTALIK PLAN OLUŞTUR</span>
                    <span style="font-size: 24px;">✨</span>
                </button>
                <small style="display: block; text-align: center; color: #666; margin-top: 8px;">
                    Hedef kaloriye en uygun menülerle otomatik haftalık plan oluşturur
                </small>
            </div>
            
            <!-- Akıllı Arama Filtreleri -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #28a745;">
                            ✅ İstenen Yemekler (virgülle ayırın)
                        </label>
                        <input 
                            type="text" 
                            id="wantedFoodsFilter" 
                            placeholder="örn: lupin, poğaça" 
                            style="width: 100%; padding: 8px; border: 2px solid #28a745; border-radius: 6px;"
                            oninput="applySmartFilter()"
                        >
                        <small style="color: #666; display: block; margin-top: 3px;">
                            Tüm kelimeleri içeren yemekleri gösterir
                        </small>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #dc3545;">
                            ❌ İstenmeyen Yemekler (virgülle ayırın)
                        </label>
                        <input 
                            type="text" 
                            id="unwantedFoodsFilter" 
                            placeholder="örn: zeytin, peynir" 
                            style="width: 100%; padding: 8px; border: 2px solid #dc3545; border-radius: 6px;"
                            oninput="applySmartFilter()"
                        >
                        <small style="color: #666; display: block; margin-top: 3px;">
                            Bu kelimeleri içeren yemekleri gizler
                        </small>
                    </div>
                </div>
                <div id="filterStats" style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px; font-size: 13px; color: #666;">
                    <span id="visibleCount">0</span> / <span id="totalCount">0</span> menü gösteriliyor
                </div>
            </div>
            
            <!-- Menü Tablosu -->
            <div class="form-group">
                <div id="dayTemplateTable" style="overflow-x: auto;">
                    <!-- Table will be loaded here -->
                </div>
            </div>
            <button class="btn-primary" onclick="saveMultipleDaysToWeek()" id="saveMultipleDaysBtn" style="display: none;">Seçilen Günleri Kaydet</button>
        </div>
```
    </div>

    <!-- Auto Week Plan Modal -->
    <div class="modal" id="autoWeekPlanModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>🤖 Otomatik Haftalık Plan</h3>
                <button class="modal-close" onclick="closeModal('autoWeekPlanModal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <p style="margin: 0; color: #1976d2; font-size: 14px;">
                    ℹ️ Bu özellik, hedef kaloriye en uygun menüleri seçerek otomatik olarak haftalık plan oluşturur. 
                    Mevcut haftaya kalan günler + tam 1 hafta doldurulur.
                </p>
            </div>
            
            <!-- Hasta Bilgileri Önizleme ve Düzenleme -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea;">👤 Hasta Bilgileri</h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Kilo (kg)</label>
                        <input type="number" id="autoPlanWeight" placeholder="70" step="0.1" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Boy (cm)</label>
                        <input type="number" id="autoPlanHeight" placeholder="170" step="1" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Aktivite Seviyesi</label>
                        <select id="autoPlanActivity" onchange="updateAutoPlanCalories()">
                            <option value="1">Hareketsiz</option>
                            <option value="2">Az Hareketli</option>
                            <option value="3" selected>Orta Hareketli</option>
                            <option value="4">Çok Hareketli</option>
                            <option value="5">Profesyonel Sporcu</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Diyet Tipi</label>
                        <select id="autoPlanDietType" onchange="updateAutoPlanCalories()">
                            <option value="eliminasyonlu-ketojenik">Eliminasyonlu Ketojenik</option>
                            <option value="ketojenik" selected>Ketojenik</option>
                            <option value="lowcarb">Low Carb</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>İstenmeyen Yemekler (virgülle ayırın)</label>
                    <input type="text" id="autoPlanDislikedFoods" placeholder="örn: zeytin, peynir">
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 2px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #667eea;">🎯 Hedef Kalori:</span>
                        <span id="autoPlanTargetCalories" style="font-size: 24px; font-weight: 700; color: #667eea;">0</span>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Menüler bu hedef kaloriye en yakın olanlardan seçilecek
                    </small>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" onclick="closeModal('autoWeekPlanModal')" style="flex: 1;">İptal</button>
                <button class="btn-primary" onclick="generateAutoWeekPlan()" style="flex: 2;">
                    ✨ Otomatik Plan Oluştur
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Hasta Ayarları</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <!-- Kişisel Bilgiler -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">👤 Kişisel Bilgiler</h4>
                
                <!-- Ad, Soyad -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Ad *</label>
                        <input type="text" id="patientName" placeholder="örn: Ayşe" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Soyad *</label>
                        <input type="text" id="patientSurname" placeholder="örn: Yılmaz" required>
                    </div>
                </div>
                
                <!-- Yaş, Cinsiyet -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Yaş *</label>
                        <input type="number" id="patientAge" placeholder="örn: 35" min="1" max="150" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Cinsiyet *</label>
                        <select id="patientGender" required>
                            <option value="">Seçiniz</option>
                            <option value="Kadın">Kadın</option>
                            <option value="Erkek">Erkek</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Kilo, Boy -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Kilo (kg) *</label>
                        <input type="number" id="patientWeight" placeholder="örn: 70" step="0.1" min="20" max="300" required oninput="calculateBMI(); updateMacroDisplay();">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Boy (cm) *</label>
                        <input type="number" id="patientHeight" placeholder="örn: 170" min="50" max="250" required oninput="calculateBMI()">
                    </div>
                </div>
                
                <!-- BMI, Aktivite -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>BMI (otomatik hesaplanır)</label>
                        <input type="text" id="patientBMI" readonly style="background: #f5f5f5; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Aktivite Seviyesi *</label>
                        <select id="patientActivity" onchange="updateMacroDisplay()" required>
                            <option value="1">1 - Hareketsiz</option>
                            <option value="2">2 - Az Hareketli</option>
                            <option value="3" selected>3 - Orta Hareketli</option>
                            <option value="4">4 - Çok Hareketli</option>
                            <option value="5">5 - Son Derece Aktif</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Kullanıcı Adı ve Şifre -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 16px;">🔐 Giriş Bilgileri</h4>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Kullanıcı Adı (değiştirilemez)</label>
                    <input type="text" id="patientUsername" readonly style="background: #f5f5f5; cursor: not-allowed;">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label>Yeni Şifre (opsiyonel)</label>
                    <input type="password" id="patientPassword" placeholder="Boş bırakılırsa değişmez" minlength="4">
                    <small style="color: #6c757d; font-size: 12px;">En az 4 karakter. Boş bırakılırsa mevcut şifreniz korunur.</small>
                </div>
            </div>

            <!-- Beslenme Ayarları -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">🍽️ Beslenme Ayarları</h4>
                
                <div class="form-group">
                    <label>Diyet Türü</label>
                    <select id="dietType" onchange="updateMacroDisplay()">
                        <option value="">Tümü</option>
                        <option value="eliminasyonlu-ketojenik">Eliminasyonlu Ketojenik</option>
                        <option value="ketojenik">Ketojenik</option>
                        <option value="lowcarb">Düşük Karbonhidrat</option>
                        <option value="mediterranean">Akdeniz Diyeti</option>
                        <option value="vegan">Vegan</option>
                    </select>
                </div>

                <!-- Önerilen Makro Hesaplaması -->
                <div id="macroDisplay" style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 14px;">📊 Önerilen Makrolar</h4>
                    <div id="macroDetails" style="font-size: 13px; color: #333;"></div>
                </div>

                <div class="form-group">
                    <label>
                        Kalori Toleransı (%)
                        <span style="color: #666; font-size: 12px; display: block;">Şablon filtrelemede ±% sapma oranı (admin varsayılanı: <span id="adminDefaultTolerance">5</span>%)</span>
                    </label>
                    <input type="number" id="calorieTolerancePercent" placeholder="örn: 10" min="0" max="50" step="1" oninput="updateToleranceInfo()">
                </div>

                <div class="form-group">
                    <label>
                        Hedef Kalori (günlük)
                        <span id="toleranceInfo" style="color: #666; font-size: 12px; display: block;">Min ve Max otomatik ±%5 tolerans ile ayarlanır</span>
                    </label>
                    <input type="number" id="targetCalories" placeholder="örn: 1000" oninput="updateCalorieRange()">
                </div>

                <div class="form-group">
                    <label>Günlük Kalori Hedefi (Min)</label>
                    <input type="number" id="minCalories" placeholder="Otomatik hesaplanır" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Günlük Kalori Hedefi (Max)</label>
                    <input type="number" id="maxCalories" placeholder="Otomatik hesaplanır" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Sevmediğim Yemekler (virgülle ayırın)</label>
                    <textarea id="dislikedFoods" rows="4" placeholder="örn: ıspanak, patlıcan, enginar"></textarea>
                </div>
            </div>

            <button class="btn-primary" onclick="saveSettings()">💾 Kaydet</button>
        </div>
    </div>

    <!-- Toast Message -->
    <div class="toast" id="toast"></div>

    <!-- Admin Matching Modal (4 Tab) -->
    <div class="modal" id="adminMatchingModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>⚙️ Eşleştirme Yönetimi</h2>
                <button class="close-btn" onclick="closeAdminMatchingModal()">×</button>
            </div>

            <!-- Tab Butonları -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="admin-tab-btn active" onclick="switchAdminTab('tarifManuel')" id="tabBtnTarifManuel">
                    📝 Tarif Kartları Eşleştirme
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('tarifYasak')" id="tabBtnTarifYasak">
                    🚫 Tarif Kartları Yasakları
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('yemekEslestirme')" id="tabBtnYemekEslestirme">
                    ✅ Yemek Veritabanı Eşleştirme
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('yemekYasak')" id="tabBtnYemekYasak">
                    🚫 Yemek Veritabanı Yasakları
                </button>
            </div>

            <!-- Tab İçerikleri -->
            <div id="adminTabContent">
                <!-- Yükleniyor... -->
                <div style="text-align: center; padding: 40px; color: #999;">
                    Yükleniyor...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // � UTF-8 ENCODING HELPER (TÜRKÇE KARAKTER KORUMA)
        // ========================================
        
        /**
         * UTF-8 string'i Base64'e çevir (GitHub API için)
         * TÜRKÇE KARAKTER KORUMA: Doğru encoding yöntemi
         * @param {string} str - Base64'e çevrilecek string
         * @returns {string} - Base64 encoded string
         */
        function encodeBase64UTF8(str) {
            // 🔥 DOĞRU YÖNTEM: UTF-8 → percent-encoding → binary → base64
            // Bu GitHub API'nin de kullandığı standart yöntemdir
            
            try {
                // 1. UTF-8 stringi percent-encode'la (%C3%BC gibi)
                const percentEncoded = encodeURIComponent(str);
                
                // 2. Percent-encoded stringi binary'ye çevir
                // %XX formatındaki byte'ları gerçek karakterlere çevir
                const binaryString = percentEncoded.replace(/%([0-9A-F]{2})/g, (match, hex) => {
                    return String.fromCharCode(parseInt(hex, 16));
                });
                
                // 3. Binary stringi Base64'e çevir
                return btoa(binaryString);
                
            } catch (error) {
                console.error('❌ Base64 encoding hatası:', error);
                // Fallback: Direkt btoa (sadece ASCII için)
                try {
                    return btoa(str);
                } catch (e) {
                    console.error('❌ Fallback encoding da başarısız:', e);
                    return '';
                }
            }
        }

        /**
         * Base64'ü UTF-8 string'e çevir (GitHub API'den okurken)
         * TÜRKÇE KARAKTER KORUMA: Doğru decoding yöntemi
         * @param {string} base64Str - Base64 encoded string
         * @returns {string} - UTF-8 decoded string
         */
        function decodeBase64UTF8(base64Str) {
            // 🔥 DOĞRU YÖNTEM: base64 → binary → percent-encoding → UTF-8
            // encodeBase64UTF8'in tam tersi işlem
            
            try {
                // 1. Base64'ü binary stringe çevir
                const binaryString = atob(base64Str);
                
                // 2. Binary string'deki her byte'ı %XX formatına çevir
                let percentEncoded = '';
                for (let i = 0; i < binaryString.length; i++) {
                    const byte = binaryString.charCodeAt(i);
                    percentEncoded += '%' + ('0' + byte.toString(16).toUpperCase()).slice(-2);
                }
                
                // 3. Percent-encoded stringi UTF-8'e decode et
                return decodeURIComponent(percentEncoded);
                
            } catch (error) {
                console.error('❌ Base64 decoding hatası:', error);
                // Fallback: Direkt atob (sadece ASCII için)
                try {
                    return atob(base64Str);
                } catch (e) {
                    console.error('❌ Fallback decoding da başarısız:', e);
                    return '';
                }
            }
        }
        
        console.log('✅ UTF-8 encoding helper yüklendi');
        
        // ========================================
        // �🔐 GLOBAL ADMIN FONKSİYONLARI (EN ÜST - ÖNCE YÜKLENSİN)
        // ========================================
        
        /**
         * 🔍 DEBUG: Admin yetkilendirme durumunu kontrol et
         * Console'dan çağırılabilir: checkAdminStatus()
         */
        window.checkAdminStatus = function() {
            console.log('=== 🔍 ADMIN YETKİLENDİRME DURUMU ===');
            console.log('1. AdminAuth:', typeof AdminAuth !== 'undefined' && AdminAuth.getSession ? AdminAuth.getSession() : 'undefined');
            console.log('2. GH_ADMINS:', window.GH_ADMINS);
            console.log('3. currentPatient:', window.currentPatient);
            console.log('4. isUserAdmin():', window.isUserAdmin ? window.isUserAdmin() : 'function not found');
            console.log('5. Admin buton sayısı:', document.querySelectorAll('.btn-admin-edit').length);
            console.log('6. Görünür admin butonları:', document.querySelectorAll('.btn-admin-edit:not([style*="display: none"])').length);
            console.log('=====================================');
        };
        
        /**
         * Kullanıcının admin yetkisi var mı kontrol et
         * @returns {boolean} Admin ise true
         */
        window.isUserAdmin = function() {
            // 1. Global admin kontrolü (AdminAuth - eski sistem)
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession && AdminAuth.getSession()) {
                console.log('🔑 Global admin girişi tespit edildi');
                return true;
            }
            
            // 2. patientAdmins listesi (admins.js - merkezi yetkilendirme)
            const patientAdmins = window.GH_ADMINS?.patientAdmins || [];
            if (window.currentPatient && window.currentPatient.username && patientAdmins.includes(window.currentPatient.username)) {
                console.log('🔑 Merkezi admin yetkisi tespit edildi:', window.currentPatient.username);
                return true;
            }
            
            // 3. Hasta dosyasında isAdmin (kişisel yetki)
            if (window.currentPatient && window.currentPatient.isAdmin === true) {
                console.log('🔑 Hasta bazlı admin yetkisi tespit edildi:', window.currentPatient.name);
                return true;
            }
            
            return false;
        };
        
        console.log('✅ Global admin fonksiyonları yüklendi');
        
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        
        window.currentPatient = null;
        let currentPatient = window.currentPatient; // Local alias
        
        let patientData = null; // Hasta bilgileri (kilo, aktivite vs)
        let weeks = [];
        let currentWeekIndex = 0;
        let activeWeekIndex = 0;
        let dayTemplates = [];
        let mealTemplates = [];
        let settings = {
            dietType: 'ketojenik', // Varsayılan ketojenik
            targetCalories: 1000,
            minCalories: 950,
            maxCalories: 1050,
            dislikedFoods: [],
            personalInfo: {
                weight: 70,
                height: 170,
                age: 35,
                activity: 3
            }
        };
        let appSettings = null; // Admin ayarlarından gelecek diyet formülleri
        
        // Food Alternative System Variables
        let manuelEslestirmeler = {}; // Manuel eşleştirmeler - tarif kartları için (data/manuel_eslestirmeler.json)
        let eslesmemeKurallari = {}; // Yasak eşleştirme kuralları - tarif kartları için (data/eslesmeme_kurallari.json)
        let yemekVeritabaniEslestirme = {}; // Yemek veritabanı manuel eşleştirme (data/yemek_veritabani_eslestirme.json)
        let yemekVeritabaniYasaklar = {}; // Yemek veritabanı yasak eşleştirme (data/yemek_veritabani_yasaklar.json)
        
        // Tab 3 & Tab 4: Seçili yemekler (ARRAY formatı - çoklu seçim için)
        let selectedFoodMatches = []; // Tab 3: Yemek veritabanı eşleştirme (ÇOK SEÇİMLİ - checkbox)
        let selectedBannedFoods = []; // Tab 4: Yemek veritabanı yasakları (ÇOK SEÇİMLİ - checkbox)

        // ========================================
        // 🔐 YETKİLENDİRME SİSTEMİ
        // ========================================
        
        /**
         * Admin config dosyasını yükle (admins.js)
         */
        async function loadAdminsConfig() {
            try {
                console.log('📥 Admin config yükleniyor...');
                
                // Method 1: Script tag ile direkt yükle (en güvenilir)
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'settings/admins.js?t=' + Date.now();
                    script.onload = () => {
                        if (window.GH_ADMINS) {
                            console.log('✅ Admin config yüklendi:', {
                                adminCount: window.GH_ADMINS.admins?.length || 0,
                                patientAdminCount: window.GH_ADMINS.patientAdmins?.length || 0
                            });
                            resolve();
                        } else {
                            reject(new Error('GH_ADMINS tanımlı değil'));
                        }
                    };
                    script.onerror = () => reject(new Error('admins.js yüklenemedi'));
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.warn('⚠️ admins.js yüklenemedi:', error);
                // Varsayılan değer
                window.GH_ADMINS = { admins: [], patientAdmins: [] };
            }
        }
        
        /**
         * Admin özelliklerini göster/gizle
         */
        function toggleAdminFeatures() {
            const isAdmin = window.isUserAdmin();
            
            // Admin butonlarını göster/gizle
            const adminButtons = document.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = isAdmin ? 'inline-block' : 'none';
            });
            
            console.log(isAdmin ? '✅ Admin özellikleri aktif' : '🔒 Admin özellikleri gizli');
        }
        
        /**
         * Yemek adını temizle (miktar, parantez, özel karakterleri kaldır)
         * @param {string} name - Temizlenecek yemek adı
         * @returns {string} - Temizlenmiş yemek adı
         */
        function cleanFoodName(name) {
            if (!name) return '';
            
            let cleaned = name;
            
            // 1. Miktarları temizle (100 gr, 1 porsiyon, vb.)
            cleaned = cleaned.replace(/\d+\s*(gr|gram|porsiyon|adet|su bardağı|çorba kaşığı|tatlı kaşığı|ml)/gi, '');
            
            // 2. Parantez içindeki açıklamaları kaldır
            cleaned = cleaned.replace(/\([^)]*\)/g, '');
            
            // 3. Özel karakterleri temizle
            cleaned = cleaned.replace(/[^\wçğıöşüÇĞİÖŞÜ\s]/gi, '');
            
            // 4. Fazla boşlukları temizle
            cleaned = cleaned.trim().replace(/\s+/g, ' ');
            
            return cleaned;
        }
        
        
        /**
         * Admin yemek düzenleme modalını aç
         * @param {number} weekIndex - Hafta indexi
         * @param {number} dayIndex - Gün indexi
         * @param {number} mealIndex - Öğün indexi
         * @param {number} foodIndex - Yemek indexi
         */
        window.openAdminFoodEditModal = function(weekIndex, dayIndex, mealIndex, foodIndex) {
            const week = weeks[weekIndex];
            if (!week) return;
            
            const day = week.days[dayIndex];
            if (!day) return;
            
            const meal = (day.meals || day.ogunler || [])[mealIndex];
            if (!meal) return;
            
            const food = (meal.yemekler || [])[foodIndex];
            if (!food) return;
            
            const foodName = food.foodName || food.name || 'İsimsiz Yemek';
            
            // ✅ Global currentFoodName'i set et (manuel eşleştirmeler için)
            currentFoodName = foodName;
            
            // ✅ MANUEL EŞLEŞTİRMELERİ KORUYALIM (GitHub'dan yüklenen verileri silme!)
            // renderTarifManuelTab zaten boşsa otomatik eşleşenleri yükler
            
            // Admin modalını aç ve seçili yemeği göster
            const adminModal = document.getElementById('adminFoodModal');
            if (adminModal) {
                // Seçili yemek bilgisini modal'a aktar
                window.selectedFoodForAdmin = {
                    weekIndex, dayIndex, mealIndex, foodIndex,
                    foodName, food
                };
                
                // Modal başlığına yemek adını yaz
                const modalFoodName = document.getElementById('modal_food_name');
                if (modalFoodName) {
                    modalFoodName.textContent = foodName;
                }
                
                // TÜM TABLARA YEMEK ADINI DOLDUR (güvenli şekilde)
                const manuelYemekAdi = document.getElementById('admin_manuel_yemek_adi');
                const yasakYemekAdi = document.getElementById('admin_yasak_yemek_adi');
                const dbYemekAdi = document.getElementById('admin_db_yemek_adi');
                const dbYasakYemekAdi = document.getElementById('admin_db_yasak_yemek_adi');
                const dbEkleYemekAdi = document.getElementById('admin_db_ekle_yemek_adi');
                
                if (manuelYemekAdi) manuelYemekAdi.value = foodName;
                if (yasakYemekAdi) yasakYemekAdi.value = foodName;
                if (dbYemekAdi) dbYemekAdi.value = foodName;
                if (dbYasakYemekAdi) dbYasakYemekAdi.value = foodName;
                if (dbEkleYemekAdi) dbEkleYemekAdi.value = foodName;
                
                // 5. TAB: food_list.json'da ara ve DOLDUR
                const dbYemek = foodData.find(f => 
                    cleanFoodName(f.name).toLowerCase() === cleanFoodName(foodName).toLowerCase()
                );
                
                // ✅ GÜVENLI ELEMENT DOLDURMA FONKSİYONU
                const safeSetValue = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value;
                };
                const safeSetChecked = (id, checked) => {
                    const el = document.getElementById(id);
                    if (el) el.checked = checked;
                };
                
                if (dbYemek) {
                    // ✅ VERİTABANINDA VAR - TÜM PARAMETRELERİ DOLDUR
                    console.log('✅ Yemek veritabanında bulundu, tüm parametreler dolduruluyor:', dbYemek.name);
                    
                    // Temel bilgiler
                    safeSetValue('admin_db_ekle_kalori', dbYemek.calories || 0);
                    safeSetValue('admin_db_ekle_protein', dbYemek.protein || 0);
                    safeSetValue('admin_db_ekle_karb', dbYemek.carbs || 0);
                    safeSetValue('admin_db_ekle_yag', dbYemek.fat || 0);
                    safeSetValue('admin_db_ekle_kategori', dbYemek.category || '');
                    safeSetValue('admin_db_ekle_rol', dbYemek.role || '');
                    
                    // Öğün tipleri
                    safeSetChecked('admin_mealType_breakfast', (dbYemek.mealType || dbYemek.mealTypes || []).includes('breakfast'));
                    safeSetChecked('admin_mealType_lunch', (dbYemek.mealType || dbYemek.mealTypes || []).includes('lunch'));
                    safeSetChecked('admin_mealType_dinner', (dbYemek.mealType || dbYemek.mealTypes || []).includes('dinner'));
                    
                    // Porsiyon
                    safeSetValue('admin_db_ekle_portion', dbYemek.portionMultiplier || dbYemek.multiplier || 1);
                    safeSetValue('admin_db_ekle_portion2', dbYemek.portionMultiplier || dbYemek.multiplier || 1);
                    
                    // Diyet tipleri
                    const dietTypes = dbYemek.dietTypes || [];
                    safeSetChecked('admin_dietType_ketojenik', dietTypes.includes('ketojenik'));
                    safeSetChecked('admin_dietType_akdeniz', dietTypes.includes('akdeniz'));
                    safeSetChecked('admin_dietType_vegan', dietTypes.includes('vegan'));
                    safeSetChecked('admin_dietType_glutensiz', dietTypes.includes('glutensiz'));
                    
                    // Min/Max/Step
                    safeSetValue('admin_db_ekle_min', dbYemek.minQuantity || '');
                    safeSetValue('admin_db_ekle_max', dbYemek.maxQuantity || '');
                    safeSetValue('admin_db_ekle_step', dbYemek.step || '');
                    
                    // Sezon
                    if (dbYemek.seasonRange) {
                        try {
                            const season = JSON.parse(dbYemek.seasonRange);
                            safeSetValue('admin_db_ekle_season_min', season[0] || '');
                            safeSetValue('admin_db_ekle_season_max', season[1] || '');
                        } catch (e) {
                            safeSetValue('admin_db_ekle_season_min', '');
                            safeSetValue('admin_db_ekle_season_max', '');
                        }
                    } else {
                        safeSetValue('admin_db_ekle_season_min', '');
                        safeSetValue('admin_db_ekle_season_max', '');
                    }
                    
                    // Özel özellikler
                    safeSetChecked('admin_keto', dbYemek.keto || false);
                    safeSetChecked('admin_lowcarb', dbYemek.lowcarb || false);
                    safeSetChecked('admin_portionFixed', dbYemek.portionFixed || false);
                    safeSetChecked('admin_fillerLunch', dbYemek.fillerLunch || false);
                    safeSetChecked('admin_fillerDinner', dbYemek.fillerDinner || false);
                    safeSetChecked('admin_reversedSeason', dbYemek.isReversedSeason || false);
                    
                    // Etiketler
                    safeSetValue('admin_db_ekle_tags', (dbYemek.tags || []).join(', '));
                    safeSetValue('admin_db_ekle_compat', (dbYemek.compatibilityTags || []).join(', '));
                    safeSetValue('admin_db_ekle_incompat', (dbYemek.incompatibilityTags || []).join(', '));
                    
                    // Notlar
                    safeSetValue('admin_db_ekle_notes', dbYemek.notes || '');
                    
                } else {
                    // ⚠️ VERİTABANINDA YOK - Menü kartındaki makroları doldur, geri kalan boş
                    console.log('⚠️ Yemek veritabanında bulunamadı, menü kartı makroları kullanılıyor:', foodName);
                    
                    // Temel makrolar (menü kartından - sadece varsa)
                    safeSetValue('admin_db_ekle_protein', food.protein || 0);
                    safeSetValue('admin_db_ekle_karb', food.carbs || food.karbonhidrat || 0);
                    safeSetValue('admin_db_ekle_yag', food.fat || food.yag || 0);
                    
                    // Kalori otomatik hesapla
                    if (typeof calculateKaloriForAddFood === 'function') {
                        calculateKaloriForAddFood();
                    }
                    
                    // Kategori ve Rol: Sadece menü kartında VARSA ekle, YOKSA BOŞ BIRAK
                    safeSetValue('admin_db_ekle_kategori', food.category || '');
                    safeSetValue('admin_db_ekle_rol', food.role || '');
                    
                    // Geri kalan tüm alanları temizle
                    safeSetChecked('admin_mealType_breakfast', false);
                    safeSetChecked('admin_mealType_lunch', false);
                    safeSetChecked('admin_mealType_dinner', false);
                    safeSetValue('admin_db_ekle_portion', 1);
                    safeSetValue('admin_db_ekle_portion2', 1);
                    safeSetChecked('admin_dietType_ketojenik', false);
                    safeSetChecked('admin_dietType_akdeniz', false);
                    safeSetChecked('admin_dietType_vegan', false);
                    safeSetChecked('admin_dietType_glutensiz', false);
                    safeSetValue('admin_db_ekle_min', '');
                    safeSetValue('admin_db_ekle_max', '');
                    safeSetValue('admin_db_ekle_step', '');
                    safeSetValue('admin_db_ekle_season_min', '');
                    safeSetValue('admin_db_ekle_season_max', '');
                    safeSetChecked('admin_keto', false);
                    safeSetChecked('admin_lowcarb', false);
                    safeSetChecked('admin_portionFixed', false);
                    safeSetChecked('admin_fillerLunch', false);
                    safeSetChecked('admin_fillerDinner', false);
                    safeSetChecked('admin_reversedSeason', false);
                    safeSetValue('admin_db_ekle_tags', '');
                    safeSetValue('admin_db_ekle_compat', '');
                    safeSetValue('admin_db_ekle_incompat', '');
                    safeSetValue('admin_db_ekle_notes', '');
                }
                
                // Manuel Eşleştirme tab'ını aç
                switchAdminTab('manuel');
                
                // Modal'ı göster
                adminModal.style.display = 'block';
                console.log('📝 Admin modal açıldı:', { weekIndex, dayIndex, mealIndex, foodIndex, foodName, dbYemek: !!dbYemek });
            } else {
                // Modal henüz yüklenmemişse geçici alert
                alert(`🔧 Admin Düzenleme\n\nYemek: ${foodName}\n\n⚠️ Admin modal henüz yüklenmedi. Sayfa yenilendiğinde kullanılabilir olacak.`);
            }
        };
        
        let tarifKartlari = []; // Tarif kartları listesi (tarifler/list.json)
        let foodData = []; // Yemek veritabanı (food_list.json)
        
        // 🔗 Admin Modal: Seçili Tarif Kartları & Manuel Eşleştirmeler
        let selectedTarifKartlari = []; // Tab 1-2 için seçili kartlar
        let manualMatches = {}; // Manuel eşleştirmeler: { "yemekAdı": ["tarif1", "tarif2", ...] }
        let currentFoodName = ''; // Seçili yemek adı (modal açıldığında set edilir)
        
        // Eşleştirme kriterleri - VARSAYILAN DEĞERLER (mobil versiyonla aynı)
        let matchCriteria = {
            role: true,          // Role filtresi AÇIK (ana yemek → ana yemek)
            dietType: true,      // DietType filtresi AÇIK (keto → keto/lowcarb)
            category: false,     // Category filtresi KAPALI
            season: false,       // Season filtresi KAPALI
            mealType: false      // MealType filtresi KAPALI
        };
        
        // Similarity scoring kriterleri - VARSAYILAN (admin ayarlarından yüklenir)
        // Admin settings'den appSettings.scoreCriteria.activeByDefault gelecek
        // Mobil versiyondaki gibi butonlarla değiştirilebilir (calories, protein, carbs, fat)
        // Varsayılan: ['protein', 'fat'] - sadece protein ve yağ aktif
        let scoreBy = ['protein', 'fat'];

        // Makro Hesaplama Fonksiyonu
        function calculateMacros(weight, dietType, activityLevel) {
            if (!appSettings || !appSettings.dietFormulas) {
                console.warn('⚠️ Diyet formülleri yüklenmedi, varsayılan değerler kullanılıyor');
                // Varsayılan değerler
                const defaultFormulas = {
                    ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                    lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                    activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                };
                return calculateMacrosWithFormula(weight, dietType, activityLevel, defaultFormulas);
            }
            
            return calculateMacrosWithFormula(weight, dietType, activityLevel, appSettings.dietFormulas);
        }

        function calculateMacrosWithFormula(weight, dietType, activityLevel, formulas) {
            // Diyet türüne göre formülü seç
            let formula;
            if (dietType === 'ketojenik') {
                formula = formulas.ketojenik;
            } else if (dietType === 'lowcarb') {
                formula = formulas.lowcarb;
            } else {
                console.warn('⚠️ Bilinmeyen diyet türü:', dietType);
                return null;
            }

            // Aktivite çarpanını al
            const activityMultiplier = formulas.activityMultipliers[activityLevel] || 1.0;

            // Gram hesapla
            const carbGrams = weight * formula.carb;
            const proteinGrams = weight * formula.protein;
            const fatGrams = weight * formula.fat;

            // Kalori hesapla (karbonhidrat: 4 kcal/g, protein: 4 kcal/g, yağ: 9 kcal/g)
            const carbCal = carbGrams * 4;
            const proteinCal = proteinGrams * 4;
            const fatCal = fatGrams * 9;
            const totalBaseCal = carbCal + proteinCal + fatCal;

            // Aktivite çarpanını uygula
            const totalCal = totalBaseCal * activityMultiplier;

            return {
                carb: Math.round(carbGrams),
                protein: Math.round(proteinGrams),
                fat: Math.round(fatGrams),
                calories: Math.round(totalCal),
                activityMultiplier: activityMultiplier
            };
        }

        // Debug fonksiyonları - Console'da çalıştırın
        window.enableBadgeDebug = function() {
            window.debugBadges = true;
            console.log('🔍 Rozet debug modu AÇILDI');
        };
        
        window.disableBadgeDebug = function() {
            window.debugBadges = false;
            console.log('🔍 Rozet debug modu KAPANDI');
        };

        // Admin ayarlarını GitHub'dan yükle (mobil_versiyon_v1.html ile AYNI KAYNAK)
        async function loadAdminSettings() {
            try {
                // GitHub API ile çek (mobil versiyon mantığı)
                const REPO_OWNER = 'mustafasacar35';
                const REPO_NAME = 'lipodem-takip-paneli';
                const SETTINGS_PATH = 'settings/config.json';
                const SETTINGS_BRANCH = 'main';
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${SETTINGS_PATH}?ref=${SETTINGS_BRANCH}`);
                
                if (!response.ok) {
                    throw new Error(`Ayarlar yüklenemedi: ${response.status}`);
                }
                
                const data = await response.json();
                const decoded = decodeBase64UTF8((data.content || '').replace(/\n/g, ''));
                const parsed = JSON.parse(decoded);
                appSettings = parsed;
                
                // Rozet ayarlarını konsola yazdır
                console.log('🏷️ Hasta paneli - Rozet ayarları yüklendi:', appSettings?.badgeVisibility);
                if (appSettings?.badgeVisibility) {
                    const enabledBadges = Object.entries(appSettings.badgeVisibility)
                        .filter(([key, value]) => value)
                        .map(([key]) => key);
                    const disabledBadges = Object.entries(appSettings.badgeVisibility)
                        .filter(([key, value]) => !value)
                        .map(([key]) => key);
                    console.log('   ✅ Aktif rozetler:', enabledBadges);
                    console.log('   ❌ Kapalı rozetler:', disabledBadges);
                } else {
                    console.log('   ⚠️ badgeVisibility ayarları bulunamadı, varsayılan ayarlar kullanılacak');
                }

                // matchCriteria'yı filterCriteria'dan doldur (mobil versiyon mantığı)
                if (appSettings.filterCriteria) {
                    const filterCrit = appSettings.filterCriteria;
                        
                        // Role filtresi
                        if (filterCrit.role?.visible) {
                            if (filterCrit.role.mode === 'required') {
                                matchCriteria.role = true; // Zorunlu - her zaman aktif
                            } else {
                                // Opsiyonel - defaultState'den başlangıç değeri
                                matchCriteria.role = filterCrit.role.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.role = false; // Visible değilse pasif
                        }
                        
                        // DietType filtresi
                        if (filterCrit.dietType?.visible) {
                            if (filterCrit.dietType.mode === 'required') {
                                matchCriteria.dietType = true;
                            } else {
                                matchCriteria.dietType = filterCrit.dietType.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.dietType = false;
                        }
                        
                        // Category filtresi
                        if (filterCrit.category?.visible) {
                            if (filterCrit.category.mode === 'required') {
                                matchCriteria.category = true;
                            } else {
                                matchCriteria.category = filterCrit.category.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.category = false;
                        }
                        
                        // Season filtresi
                        if (filterCrit.season?.visible) {
                            if (filterCrit.season.mode === 'required') {
                                matchCriteria.season = true;
                            } else {
                                matchCriteria.season = filterCrit.season.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.season = false;
                        }
                        
                        // MealType filtresi
                        if (filterCrit.mealType?.visible) {
                            if (filterCrit.mealType.mode === 'required') {
                                matchCriteria.mealType = true;
                            } else {
                                matchCriteria.mealType = filterCrit.mealType.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.mealType = false;
                        }
                    }
                    
                    // 🔥 scoreBy parametresini admin ayarlarından yükle (mobil versiyon mantığı)
                    if (appSettings.scoreCriteria && Array.isArray(appSettings.scoreCriteria.activeByDefault)) {
                        scoreBy = [...appSettings.scoreCriteria.activeByDefault]; // Kopyala (referans değil)
                        console.log('✅ scoreBy admin ayarlarından yüklendi:', scoreBy);
                    } else {
                        console.warn('⚠️ appSettings.scoreCriteria bulunamadı, varsayılan kullanılıyor:', scoreBy);
                    }
                    
                    console.log('✅ Admin ayarları yüklendi:', appSettings);
                    console.log('✅ Match kriterleri:', matchCriteria);
                    console.log('✅ Benzerlik skoru kriterleri (scoreBy):', scoreBy);
            } catch (error) {
                console.warn('⚠️ Admin ayarları yüklenirken hata:', error);
                appSettings = {
                    calorieTolerancePercent: 5,
                    dietFormulas: {
                        ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                        lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                        activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                    }
                };
            }
        }

        // Manuel eşleştirmeler ve yasak kurallarını GitHub'dan yükle
        async function loadManuelEslestirmeler() {
            try {
                // 1️⃣ Manuel eşleştirmeleri yükle (tarif kartları için)
                const manuelResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json?t=' + Date.now());
                if (manuelResp.ok) {
                    const manuelData = await manuelResp.json();
                    manuelEslestirmeler = manuelData.eslestirmeler || manuelData;
                    manualMatches = manuelEslestirmeler; // ✅ Senkronize et
                    console.log('✅ Manuel eşleştirmeler yüklendi (tarif kartları):', Object.keys(manuelEslestirmeler).length);
                } else {
                    console.warn('⚠️ Manuel eşleştirmeler yüklenemedi');
                }

        // 2️⃣ Yasak kurallarını yükle (tarif kartları için)
        const yasakResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json?t=' + Date.now(), {
            cache: 'no-store' // Cache bypass
        });
        if (yasakResp.ok) {
            const data = await yasakResp.json();
            
            // ✅ eslestirme.html ile aynı fallback sistemi (4 kontrol)
            if (data.kurallar && data.kurallar.eslesmemeKurallari) {
                // Format 1: { kurallar: { eslesmemeKurallari: {...} } }
                eslesmemeKurallari = data.kurallar.eslesmemeKurallari;
            } else if (data.kurallar) {
                // Format 2: { kurallar: {...} }
                eslesmemeKurallari = data.kurallar;
            } else if (data.eslesmemeKurallari) {
                // Format 3: { eslesmemeKurallari: {...} }
                eslesmemeKurallari = data.eslesmemeKurallari;
            } else {
                // Format 4: Direkt root object
                eslesmemeKurallari = data;
            }
            
            console.log('✅ Yasak kuralları yüklendi (tarif kartları):', Object.keys(eslesmemeKurallari).length);
        } else {
            console.warn('⚠️ Yasak kuralları yüklenemedi');
        }                // 3️⃣ Yemek veritabanı manuel eşleştirmeleri yükle
                const yemekEslestirmeResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_eslestirme.json?t=' + Date.now());
                if (yemekEslestirmeResp.ok) {
                    const yemekEslestirmeData = await yemekEslestirmeResp.json();
                    yemekVeritabaniEslestirme = yemekEslestirmeData.eslestirmeler || yemekEslestirmeData;
                    console.log('✅ Yemek veritabanı eşleştirmeleri yüklendi:', Object.keys(yemekVeritabaniEslestirme).length);
                } else {
                    console.warn('⚠️ Yemek veritabanı eşleştirmeleri yüklenemedi');
                }

                // 4️⃣ Yemek veritabanı yasaklarını yükle
                const yemekYasaklarResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_yasaklar.json?t=' + Date.now());
                if (yemekYasaklarResp.ok) {
                    const yemekYasaklarData = await yemekYasaklarResp.json();
                    yemekVeritabaniYasaklar = yemekYasaklarData.yasaklar || yemekYasaklarData;
                    console.log('✅ Yemek veritabanı yasakları yüklendi:', Object.keys(yemekVeritabaniYasaklar).length);
                } else {
                    console.warn('⚠️ Yemek veritabanı yasakları yüklenemedi');
                }
            } catch (error) {
                console.error('❌ Manuel eşleştirmeler/yasak kuralları yüklenirken hata:', error);
            }
        }

        // Tarif kartlarını GitHub'dan yükle
        async function loadTarifKartlari() {
            try {
                // Önce list.json'dan yüklemeyi dene
                let response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        tarifKartlari = data
                            .map(item => (typeof item === 'string' ? item : item.name || item.filename || item.file || null))
                            .filter(name => name && name.match(/\.(jpg|jpeg|png)$/i))
                            .map(name => ({ 
                                name: name, 
                                type: 'file', 
                                download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` 
                            }));
                        console.log('✅ Tarif kartları list.json ile yüklendi:', tarifKartlari.length);
                        return;
                    }
                }
                throw new Error('list.json yüklenemedi');
            } catch (error) {
                console.error('❌ Tarif kartları yüklenemedi, fallback deneniyor:', error.message);
                
                // Fallback: Manuel eşleştirmelerden tarif kartlarını çıkar
                const uniqueTarifler = new Set();
                Object.values(manuelEslestirmeler).forEach(eslestirme => {
                    const kartlar = (typeof eslestirme === 'object' && eslestirme.kartlar) 
                        ? eslestirme.kartlar 
                        : (typeof eslestirme === 'string' ? [eslestirme] : []);
                    kartlar.forEach(kart => uniqueTarifler.add(kart));
                });
                
                tarifKartlari = [...uniqueTarifler].map(name => ({ 
                    name: name, 
                    type: 'file', 
                    download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` 
                }));
                console.log('✅ Fallback tarif kartları yüklendi:', tarifKartlari.length);
            }
        }

        // Yemek veritabanını yükle (food_list.json)
        async function loadFoodData() {
            // Zaten yüklenmişse tekrar yükleme (performance optimization)
            if (foodData.length > 0) {
                console.log('ℹ️ Yemek veritabanı zaten yüklenmiş:', foodData.length, 'yemek');
                return true;
            }
            
            try {
                console.log('📥 Yemek veritabanı yükleniyor...');
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                foodData = [];
                
                // food_list.json formatı: { categories: [ { items: [...] } ] }
                if (data.categories && Array.isArray(data.categories)) {
                    data.categories.forEach(category => {
                        if (category.items && Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                // Yemek objesini foodData'ya ekle
                                if (item.name) {
                                    foodData.push(item);
                                }
                            });
                        }
                    });
                }
                
                console.log(`✅ Yemek veritabanı yüklendi: ${foodData.length} yemek`);
                
                // DEBUG: İlk 3 yemek ve Mercimek kontrolü
                if (foodData.length > 0) {
                    console.log('📋 İlk 3 yemek:', foodData.slice(0, 3).map(f => f.name));
                    const mercimekler = foodData.filter(f => f.name.toLowerCase().includes('mercimek'));
                    console.log(`🔍 Mercimek içeren yemekler (${mercimekler.length}):`, mercimekler.map(f => f.name));
                }
                
                return true;
            } catch (error) {
                console.error('❌ Yemek veritabanı yüklenirken hata:', error);
                return false;
            }
        }

        // Türkçe karakter normalizasyonu (ç→c, ğ→g, ı→i, ö→o, ş→s, ü→u)
        function normalizeText(str) {
            if (!str) return '';
            
            // Manuel character mapping - her karakteri tek tek kontrol et
            const trMap = {
                'Ç': 'c', 'ç': 'c',
                'Ğ': 'g', 'ğ': 'g',
                'I': 'i', 'ı': 'i',
                'İ': 'i', 'i': 'i', 'í': 'i', 'ì': 'i', 'î': 'i', 'ï': 'i',  // Tüm i varyantları
                'Ö': 'o', 'ö': 'o',
                'Ş': 's', 'ş': 's',
                'Ü': 'u', 'ü': 'u'
            };
            
            let result = '';
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (trMap[char]) {
                    result += trMap[char];
                } else if (/[a-zA-Z0-9]/.test(char)) {
                    result += char.toLowerCase();
                }
                // Diğer karakterleri atla (boşluk, noktalama vs.)
            }
            
            return result;
        }

        // Levenshtein Distance (karakter değişim mesafesi)
        function levenshteinDistance(s1, s2) {
            const len1 = s1.length;
            const len2 = s2.length;
            const matrix = [];

            // Boş string kontrolü
            if (len1 === 0) return len2;
            if (len2 === 0) return len1;

            // Matris oluştur
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            // Mesafeyi hesapla
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // Silme
                        matrix[i][j - 1] + 1,      // Ekleme
                        matrix[i - 1][j - 1] + cost // Değiştirme
                    );
                }
            }

            return matrix[len1][len2];
        }

        // Benzerlik skoru hesapla (0-100%)
        function similarityScore(s1, s2) {
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 100;
            
            const distance = levenshteinDistance(longer, shorter);
            return ((longer.length - distance) / longer.length) * 100;
        }

        // 🔍 Akıllı fuzzy matching (eslestirme.html mantığı)
        function smartFuzzyMatch(searchName, targetName, threshold = 85) {
            const searchNorm = normalizeText(searchName);
            const targetNorm = normalizeText(targetName);

            // 1️⃣ Tam eşleşme
            if (searchNorm === targetNorm) return 100;

            // 2️⃣ İçeriyor mu? (substring)
            if (targetNorm.includes(searchNorm)) {
                // Ama çok kısa kelimeler için dikkatli ol
                // "zeytin" → "zeytinlimeze" ❌ (3 harf fark varsa ret)
                const lengthDiff = targetNorm.length - searchNorm.length;
                if (lengthDiff > 3) return 0; // Çok farklı uzunluk
                return 95;
            }

            // 3️⃣ Kelime kelime başlangıç eşleşmesi (eslestirme.html mantığı)
            const searchWords = searchName.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const targetWords = targetName.split(/[_\s]+/).filter(w => w.length > 0);

            if (searchWords.length > 1) {
                const allWordsFound = searchWords.every(searchWord => {
                    const normalizedSearchWord = normalizeText(searchWord);
                    return targetWords.some(targetWord => 
                        normalizeText(targetWord).startsWith(normalizedSearchWord)
                    );
                });

                if (allWordsFound) {
                    // Kelime sayısı eşitse daha yüksek skor
                    if (searchWords.length === targetWords.length) return 95;
                    return 88; // Fazla kelime var ama eşleşiyor
                }
            }

            // 4️⃣ Levenshtein distance (son çare)
            const score = similarityScore(searchNorm, targetNorm);
            
            // Ama çok kısa kelimeler için katı ol
            if (searchNorm.length < 5 && score < 95) return 0; // "zeytin" gibi
            
            return score;
        }

        // 🚀 İYİLEŞTİRİLMİŞ EŞLEŞTİRME SİSTEMİ (örnek_dosya.html mantığı)
        // Türkçe karakter normalize (örnek_dosya.html ile aynı)
        function normalizeTr(str) {
            return (str || '')
                .toString()
                .toLowerCase()
                .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
                .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i').replace(/i̇/g, 'i')
                .replace(/[_*\/()]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/[^a-z0-9\s]/g, '')
                .trim();
        }

        // Token tabanlı fuzzy matching (örnek_dosya.html mantığı)
        const unitStop = new Set([
            'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
            'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
            'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
            'yarim','ceyrek','lt','ml','cc','mg','mcg','litre'
        ]);
        const stopFillers = new Set(['ve','veya','ile','artı','arti','plus','ya','vs','vb']);
        
        function tokenize(text) {
            return normalizeTr(text)
                .replace(/\d+/g, ' ') // sayıları kaldır
                .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
                .split(/\s+/)
                .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));
        }

        function bestFoodFuzzyMatch(rawText, allFoodItems) {
            if (!rawText || !allFoodItems || allFoodItems.length === 0) return null;
            
            // Parçaları üret ("+", ",", "/", "(", ")", "-", "ile", "ve", "veya" ile böl)
            const parts = String(rawText)
                .split(/\+|\,|\/|\(|\)|\-|\bile\b|\bve\b|\bveya\b/gi)
                .map(p => p.trim())
                .filter(Boolean);
            
            let best = null;
            let bestScore = 0;
            
            const consider = (segment) => {
                const segTokens = tokenize(segment);
                if (!segTokens.length) return;
                
                for (const f of allFoodItems) {
                    const fTokens = tokenize(f.name);
                    if (!fTokens.length) continue;
                    
                    // Kesişim skoru
                    const setB = new Set(fTokens);
                    let overlap = 0;
                    let longHit = false;
                    
                    for (const t of segTokens) {
                        if (setB.has(t)) {
                            overlap++;
                            if (t.length >= 4) longHit = true;
                        }
                    }
                    
                    // Kabul kriteri: en az 2 kelime eşleşmesi veya tek ama uzun kelime eşleşmesi
                    const score = overlap + (longHit ? 0.5 : 0);
                    if (overlap >= 2 || (overlap >= 1 && longHit)) {
                        if (score > bestScore) { 
                            best = f; 
                            bestScore = score; 
                        }
                    }
                }
            };
            
            if (!parts.length) parts.push(rawText);
            parts.forEach(consider);
            
            return best;
        }

        // Yemek adını foodData'da bul (İYİLEŞTİRİLMİŞ: örnek_dosya.html mantığı + ROTASYON MODU)
        function findFoodInDatabase(searchName, weekIndex = 0) {
            if (!searchName || !foodData || foodData.length === 0) return null;

            const normalized = normalizeText(searchName);
            const normalizedTr = normalizeTr(searchName);

            // 1️⃣ MANUEL EŞLEŞTİRME (yemek_veritabani_eslestirme.json - ÇOK SEÇİMLİ + ROTASYON)
            if (yemekVeritabaniEslestirme && Object.keys(yemekVeritabaniEslestirme).length > 0) {
                const eslestirme = yemekVeritabaniEslestirme[normalized] || yemekVeritabaniEslestirme[normalizedTr];
                if (eslestirme) {
                    // YENİ FORMAT: hedefYemekler (array) + rotasyonModu
                    if (Array.isArray(eslestirme.hedefYemekler) && eslestirme.hedefYemekler.length > 0) {
                        let selectedFood = null;
                        
                        if (eslestirme.hedefYemekler.length === 1) {
                            // Tek yemek → direkt döndür
                            selectedFood = eslestirme.hedefYemekler[0];
                        } else {
                            // Çoklu yemek → rotasyon uygula
                            const rotasyonModu = eslestirme.rotasyonModu || 'sirayla'; // Default: sıralı
                            
                            if (rotasyonModu === 'rastgele') {
                                // Rastgele seçim
                                const randomIndex = Math.floor(Math.random() * eslestirme.hedefYemekler.length);
                                selectedFood = eslestirme.hedefYemekler[randomIndex];
                                console.log(`🎲 Rastgele seçim: "${searchName}" → "${selectedFood}" (${randomIndex + 1}/${eslestirme.hedefYemekler.length})`);
                            } else {
                                // Sıralı rotasyon (modulo ile)
                                const rotationIndex = weekIndex % eslestirme.hedefYemekler.length;
                                selectedFood = eslestirme.hedefYemekler[rotationIndex];
                                console.log(`🔄 Sıralı rotasyon: "${searchName}" → "${selectedFood}" (${rotationIndex + 1}/${eslestirme.hedefYemekler.length}) [Hafta: ${weekIndex + 1}]`);
                            }
                        }
                        
                        // foodData'da eşleşen yemeği bul
                        const mapped = foodData.find(f => normalizeText(f.name) === normalizeText(selectedFood));
                        if (mapped && !isFoodMatchForbidden(searchName, mapped.name)) {
                            console.log(`✅ Manuel eşleştirme (veritabanı): "${searchName}" → "${mapped.name}"`);
                            return mapped;
                        }
                    }
                    // ESKİ FORMAT: hedefYemek (string) - geriye dönük uyumluluk
                    else if (eslestirme.hedefYemek) {
                        const mapped = foodData.find(f => normalizeText(f.name) === normalizeText(eslestirme.hedefYemek));
                        if (mapped && !isFoodMatchForbidden(searchName, mapped.name)) {
                            console.log(`✅ Manuel eşleştirme (veritabanı - eski format): "${searchName}" → "${mapped.name}"`);
                            return mapped;
                        }
                    }
                }
            }

            // 2️⃣ TAM EŞLEŞTİRME (normalizeTr ile)
            let match = foodData.find(f => normalizeTr(f.name) === normalizedTr || normalizeText(f.name) === normalized);
            if (match && !isFoodMatchForbidden(searchName, match.name)) {
                console.log(`✅ Tam eşleşme: "${searchName}" → "${match.name}"`);
                return match;
            }

            // 3️⃣ PARANTEZ TEMİZLE
            const cleanName = searchName.replace(/\s*\([^)]*\)/g, '').trim();
            if (cleanName !== searchName) {
                const cleanNormalized = normalizeTr(cleanName);
                match = foodData.find(f => normalizeTr(f.name) === cleanNormalized);
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`✅ Parantez temizleme: "${searchName}" → "${match.name}"`);
                    return match;
                }
            }

            // 4️⃣ MİKTAR TEMİZLE (sayılar + birimler)
            const quantityCleanName = cleanName
                .replace(/^\d+\s*(gram|g|adet|dilim|ml|lt|porsiyon|su bardağı|kase|ölçek|cc|mg|litre)\s*/i, '')
                .replace(/^\d+\s*(tatlı|çorba|yemek)\s*kaşığı\s*/i, '')
                .replace(/\b\d+\s*(?:gr|g|ml|lt|cc|mg|adet|dilim|porsiyon|kase|ölçek)\b/gi, '')
                .trim();
            
            if (quantityCleanName && quantityCleanName !== cleanName) {
                const quantityNormalized = normalizeTr(quantityCleanName);
                
                // Tam eşleşme
                match = foodData.find(f => normalizeTr(f.name) === quantityNormalized);
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`✅ Miktar temizleme: "${searchName}" → "${match.name}"`);
                    return match;
                }
                
                // Food_list'teki parantezleri de temizle
                match = foodData.find(f => {
                    const foodClean = f.name.replace(/\s*\([^)]*\)/g, '').trim();
                    const foodQuantityClean = foodClean
                        .replace(/^\d+\s*(gram|g|adet|dilim|ml|lt|porsiyon|su bardağı|kase|ölçek|cc|mg|litre)\s*/i, '')
                        .replace(/^\d+\s*(tatlı|çorba|yemek)\s*kaşığı\s*/i, '')
                        .replace(/\b\d+\s*(?:gr|g|ml|lt|cc|mg|adet|dilim|porsiyon|kase|ölçek)\b/gi, '')
                        .trim();
                    return normalizeTr(foodQuantityClean) === quantityNormalized;
                });
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`✅ Miktar + parantez temizleme (çift yönlü): "${searchName}" → "${match.name}"`);
                    return match;
                }
            }

            // 5️⃣ İÇERİYOR MU? (substring) - örnek_dosya.html mantığı
            const searchForInclude = quantityCleanName || cleanName;
            const searchNormInclude = normalizeTr(searchForInclude);
            
            if (searchNormInclude) {
                match = foodData.find(f => {
                    if (isFoodMatchForbidden(searchName, f.name)) return false;
                    const fn = normalizeTr(f.name);
                    return fn.includes(searchNormInclude) || searchNormInclude.includes(fn);
                });
                if (match) {
                    console.log(`✅ İçeriyor eşleşmesi: "${searchName}" → "${match.name}"`);
                    return match;
                }
            }

            // 6️⃣ TOKEN TABANLI FUZZY MATCHING (örnek_dosya.html mantığı)
            const searchForFuzzy = quantityCleanName || cleanName;
            const fuzzyMatch = bestFoodFuzzyMatch(searchForFuzzy, foodData);
            
            if (fuzzyMatch && !isFoodMatchForbidden(searchName, fuzzyMatch.name)) {
                console.log(`✅ Token tabanlı fuzzy eşleşme: "${searchName}" → "${fuzzyMatch.name}"`);
                return fuzzyMatch;
            }

            console.log(`❌ Eşleşme bulunamadı: "${searchName}"`);
            return null;
        }

        // Yasak yemek eşleşmelerini kontrol et (yemek_veritabani_yasaklar.json)
        function isFoodMatchForbidden(searchName, targetFoodName) {
            if (!yemekVeritabaniYasaklar || Object.keys(yemekVeritabaniYasaklar).length === 0) {
                return false;
            }

            const searchNorm = normalizeText(searchName);
            const searchNormTr = normalizeTr(searchName);
            const targetNorm = normalizeText(targetFoodName);
            const targetNormTr = normalizeTr(targetFoodName);
            
            // 🔥 ÖNEMLİ: TAM EŞLEŞMELERİ HİÇBİR ZAMAN YASAKLAMA!
            // "Mercimek Çorbası" → "Mercimek Çorbası" = TAM EŞLEŞME → İZİN VER ✅
            if (searchNorm === targetNorm || searchNormTr === targetNormTr) {
                return false; // Tam eşleşme her zaman güvenli
            }
            
            // Yasak listesini kontrol et
            for (const [key, yasakObj] of Object.entries(yemekVeritabaniYasaklar)) {
                const yasakNorm = normalizeText(key);
                
                // Arama terimi yasak listesindeyse (EVET ama kısmi eşleşme)
                // Örnek: "çorba" (genel) → yasaklı, ama "Mercimek Çorbası" (özel) → izinli
                if (searchNorm === yasakNorm || searchNorm.includes(yasakNorm)) {
                    const yasakliYemekler = yasakObj.yasakliYemekler || [];
                    
                    // Hedef yemek yasaklı mı?
                    const isForbidden = yasakliYemekler.some(forbidden => 
                        normalizeText(forbidden) === targetNorm
                    );

                    if (isForbidden) {
                        console.log(`🚫 Yasak eşleşme: "${searchName}" → "${targetFoodName}" (${yasakObj.neden || 'manuel olarak yasaklanmış'})`);
                        return true;
                    }
                }
            }

            return false;
        }

        // Yemek adından tarif kartlarını bul (manuel eşleştirme öncelikli, yasak kuralları uygula)
        function findTarifKartlari(yemekAdi) {
            if (!tarifKartlari.length) return [];
            
            // Yemek adını temizle (parantez içi, miktar vs.)
            let cleanedYemekAdi = yemekAdi
                .replace(/\([^)]*\)/g,'')
                .replace(/^\d+\.\s*|^\d+\s*adet\s*|^\d+\s*dilim\s*|^\d+\s*gram\s*|^\d+\s*g\s*|^\d+\s*ml\s*|^\d+\s*porsiyon\s*|^\d+\s*su bardağı\s*|^\d+\s*(tatlı|çorba|yemek)\s*kaşığı\s*|^\d+\s*kase\s*/i, '')
                .trim();
            const normalizedCleaned = normalizeText(cleanedYemekAdi);
            
            // 1. Manuel eşleştirmelere bak
            let manuelData = manuelEslestirmeler[yemekAdi] || Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalizedCleaned);
            if (manuelData && manuelEslestirmeler[manuelData]) {
                manuelData = manuelEslestirmeler[manuelData];
            }

            if (manuelData) {
                const manuelTarifAdlari = (typeof manuelData === 'object' && manuelData.kartlar) 
                    ? manuelData.kartlar 
                    : (typeof manuelData === 'string' ? [manuelData] : []);
                
                const bulunanKartlar = manuelTarifAdlari.map(manuelTarifAdi => {
                    const foundTarif = tarifKartlari.find(tarif => {
                        const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                        const manuelName = (typeof manuelTarifAdi === 'string' ? manuelTarifAdi : '').replace(/\.(jpg|jpeg|png)$/i, '');
                        return normalizeText(tarifName) === normalizeText(manuelName) || tarifName === manuelName;
                    });
                    
                    // ✅ DÜZELTME: Eğer tarifKartlari string array ise, dosya adını direkt kullan
                    if (foundTarif) {
                        return foundTarif;
                    } else {
                        // Manuel eşleştirmede dosya adı varsa, onu kullan
                        const fileName = manuelTarifAdi.includes('.jpg') || manuelTarifAdi.includes('.png') 
                            ? manuelTarifAdi 
                            : `${manuelTarifAdi}.jpg`;
                        return {
                            file: fileName,
                            name: fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' '),
                            type: 'file',
                            download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}`
                        };
                    }
                }).filter(Boolean);
                
                if (bulunanKartlar.length > 0) {
                    console.log('✅ Manuel eşleştirme bulundu:', bulunanKartlar.map(k => k.file || k.name));
                    return bulunanKartlar;
                }
            }

            // 2. Otomatik eşleştirme (fuzzy matching)
            const potansiyelTarif = tarifKartlari.find(tarif => {
                const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                const tarifNormalized = normalizeText(tarifName);
                return tarifNormalized === normalizedCleaned || tarifNormalized.replace(/_/g, '') === normalizedCleaned;
            }) || tarifKartlari.find(tarif => {
                const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                const tarifNormalized = normalizeText(tarifName);
                return tarifNormalized.includes(normalizedCleaned) || normalizedCleaned.includes(tarifNormalized);
            });
            
            // 3. Yasak kurallarını kontrol et
            if (potansiyelTarif) {
                const tarifFile = potansiyelTarif.file || potansiyelTarif.name || '';
                
                // Yasak kurallarını al (eslestirme.html mantığı - object format)
                let yasakData = eslesmemeKurallari[yemekAdi] 
                    || eslesmemeKurallari[cleanedYemekAdi];
                
                // Object formatından array'e çevir (eslestirme.html mantığı)
                let yasakListesi = [];
                if (yasakData && typeof yasakData === 'object' && !Array.isArray(yasakData)) {
                    // GitHub format: { orijinalMetin, yasakliKartlar, eklemeTarihi }
                    yasakListesi = yasakData.yasakliKartlar || yasakData.kartlar || [];
                } else if (Array.isArray(yasakData)) {
                    // Eski format: direkt array
                    yasakListesi = yasakData;
                }
                
                // Yasak listesinde var mı kontrol et (dosya adı karşılaştırması)
                const isYasakli = yasakListesi.includes(tarifFile);
                
                if (isYasakli) {
                    console.log('⛔ Yasak kural nedeniyle kart gösterilmedi:', yemekAdi, '->', tarifFile);
                    return []; // Boş array döndür
                }
                
                console.log('✅ Otomatik eşleştirme bulundu:', tarifFile);
                return [potansiyelTarif];
            }
            
            return [];
        }

        // ===== YARDIMCI FONKSIYONLAR (Food Alternative System) =====

        // Diet type helper
        function getDietType(food) {
            return food.keto ? 'keto' : (food.lowcarb ? 'lowcarb' : 'other');
        }

        // Meal type helper functions
        function parseMealTypes(mealType) {
            if (!mealType) return [];
            if (typeof mealType === 'string') {
                return mealType.split(',').map(m => m.trim().toLowerCase()).filter(Boolean);
            }
            if (Array.isArray(mealType)) {
                return mealType.map(m => String(m).trim().toLowerCase()).filter(Boolean);
            }
            return [];
        }

        function hasMealTypeOverlap(refMealTypes, foodMealTypes) {
            // VEYA mantığı: En az bir öğün ortak olmalı
            if (!refMealTypes.length || !foodMealTypes.length) return false;
            return refMealTypes.some(refType => foodMealTypes.includes(refType));
        }

        // Role display helper
        function getRoleDisplayName(role) {
            if (!role || typeof role !== 'string') return role;
            const ROLE_DISPLAY_MAP = {
                'ana yemek': 'Ana Yemek',
                'salata': 'Salata',
                'çorba': 'Çorba',
                'tatlı': 'Tatlı',
                'içecek': 'İçecek',
                'ara öğün': 'Ara Öğün',
                'bread': 'Ekmek',
                'ekmek': 'Ekmek'
            };
            const normalized = role.toLowerCase();
            return ROLE_DISPLAY_MAP[normalized] || role;
        }

        // Rozet oluşturma fonksiyonu
        function generateFoodBadges(food) {
            let badgesHtml = '';
            
            // Admin settings'den rozet görünürlük ayarlarını al
            const badgeSettings = appSettings?.badgeVisibility || {
                role: true,
                dietType: true,
                category: false,
                season: false,
                mealType: false,
                tags: false
            };
            
            // Debug: Rozet ayarlarını kontrol et
            if (window.debugBadges || false) {
                console.log(`🔍 ${food.foodName || food.name} için rozet ayarları:`, badgeSettings);
            }

            // 🔍 foodData'dan zenginleştirilmiş bilgileri al (Hibrit eşleştirme)
            let enrichedFood = food;
            const foodName = food.foodName || food.name;
            
            if (foodName) {
                const matchedFood = findFoodInDatabase(foodName);
                
                if (matchedFood) {
                    // foodData'dan eksik bilgileri ekle
                    enrichedFood = { ...food, ...matchedFood };
                } else {
                    // Veritabanında bulunamadı - uyarı rozeti ekle
                    badgesHtml += '<span class="food-badge" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);" title="Bu yemek veritabanında bulunamadı. Manuel eşleştirme ekleyebilirsiniz.">⚠️ Veritabanında Yok</span> ';
                }
            }

            // 1. Role Badge
            if (badgeSettings.role && enrichedFood.role) {
                const roleIcon = enrichedFood.role.toLowerCase().includes('ana') ? '🍖' :
                                enrichedFood.role.toLowerCase().includes('salata') ? '🥗' :
                                enrichedFood.role.toLowerCase().includes('çorba') ? '🍲' :
                                enrichedFood.role.toLowerCase().includes('tatlı') ? '🍰' :
                                enrichedFood.role.toLowerCase().includes('içecek') ? '🥤' :
                                enrichedFood.role.toLowerCase().includes('bread') ? '🍞' : '🍽️';
                badgesHtml += `<span class="food-badge badge-role" title="Rol: ${enrichedFood.role}">${roleIcon} ${getRoleDisplayName(enrichedFood.role)}</span> `;
            }

            // 2. DietType Badge
            if (badgeSettings.dietType) {
                const foodDietType = getDietType(enrichedFood);
                if (foodDietType === 'keto') {
                    badgesHtml += '<span class="diet-badge diet-badge-keto" title="Ketojenik">🥑 KETO</span> ';
                } else if (foodDietType === 'lowcarb') {
                    badgesHtml += '<span class="diet-badge diet-badge-lowcarb" title="Düşük Karbonhidrat">🌾 LOWCARB</span> ';
                }
            }

            // 3. Category Badge
            if (badgeSettings.category && enrichedFood.category) {
                const categoryIcon = enrichedFood.category.toLowerCase().includes('et') ? '🥩' :
                                    enrichedFood.category.toLowerCase().includes('sebze') ? '🥬' :
                                    enrichedFood.category.toLowerCase().includes('meyve') ? '🍎' :
                                    enrichedFood.category.toLowerCase().includes('tahıl') ? '🌾' : '📂';
                badgesHtml += `<span class="food-badge badge-category" title="Kategori: ${enrichedFood.category}">${categoryIcon} ${enrichedFood.category}</span> `;
            }

            // 4. Season Badge
            if (badgeSettings.season && enrichedFood.season) {
                const seasonIcon = enrichedFood.season.toLowerCase().includes('yaz') ? '☀️' :
                                  enrichedFood.season.toLowerCase().includes('kış') ? '❄️' :
                                  enrichedFood.season.toLowerCase().includes('ilkbahar') ? '🌸' :
                                  enrichedFood.season.toLowerCase().includes('sonbahar') ? '🍂' : '📅';
                badgesHtml += `<span class="food-badge badge-season" title="Mevsim: ${enrichedFood.season}">${seasonIcon} ${enrichedFood.season}</span> `;
            }

            // 5. MealType Badge
            if (badgeSettings.mealType && enrichedFood.mealType) {
                const mealTypes = parseMealTypes(enrichedFood.mealType);
                if (mealTypes.length > 0) {
                    const mealTypeStr = mealTypes.map(mt => {
                        const upper = mt.charAt(0).toUpperCase() + mt.slice(1);
                        return upper.replace('kahvalti', 'Kahvaltı')
                                  .replace('ogle', 'Öğle')
                                  .replace('aksam', 'Akşam')
                                  .replace('ara', 'Ara Öğün');
                    }).join(', ');
                    badgesHtml += `<span class="food-badge badge-mealtype" title="Öğün: ${mealTypeStr}">⏰ ${mealTypeStr}</span> `;
                }
            }

            // 6. Tags Badge
            if (badgeSettings.tags && enrichedFood.tags && enrichedFood.tags.length > 0) {
                const tagsStr = enrichedFood.tags.slice(0, 3).join(', ') + (enrichedFood.tags.length > 3 ? '...' : '');
                badgesHtml += `<span class="food-badge badge-tags" title="${enrichedFood.tags.join(', ')}">🏷️ ${tagsStr}</span> `;
            }

            return badgesHtml;
        }

        // Tag extraction for filtering
        function extractTagKeywords(food) {
            const keywords = new Set();
            if (!food) return keywords;
            
            // Admin ayarlarından tag exclusions al (filtrelenmeyecek tag'ler)
            const tagExclusions = appSettings?.tagExclusions || ['ekmek', 'ekmeği', 'çorba', 'çorbası', 'keto', 'lowcarb', 'salata', 'tatlı'];
            
            const sources = [];
            if (Array.isArray(food.tags)) sources.push(...food.tags);
            else if (typeof food.tags === 'string') sources.push(food.tags);

            sources.forEach(text => {
                if (!text) return;
                let value = '';
                if (typeof text === 'string') {
                    value = text;
                } else if (typeof text === 'number') {
                    value = String(text);
                } else if (text && typeof text === 'object') {
                    if (typeof text.name === 'string') value = text.name;
                    else if (typeof text.label === 'string') value = text.label;
                    else return;
                } else {
                    return;
                }

                const normalized = normalizeText(value);
                normalized.split(/[^a-z0-9]+/).forEach(token => {
                    if (token && token.length > 2) {
                        // Tag exclusions kontrolü - eğer exclude listesinde varsa ekleme
                        const isExcluded = tagExclusions.some(excluded => 
                            normalizeText(excluded) === token || token.includes(normalizeText(excluded))
                        );
                        if (!isExcluded) {
                            keywords.add(token);
                        }
                    }
                });
            });

            return keywords;
        }

        // Tag filter checker
        function shouldSkipTagFilter(food, refFood) {
            // Tag filtering'i devre dışı bırakılmışsa skip et
            if (!appSettings || !appSettings.enableTagFilter) return true;
            
            // Admin ayarlarından exempt role'leri al (varsayılan: soup, salad, bread)
            const tagExemptRoles = appSettings?.tagExemptions?.roles || ['soup', 'salad', 'bread'];
            const roleNormalized = normalizeText(food.role || '');
            if (roleNormalized && tagExemptRoles.some(exempt => roleNormalized.includes(normalizeText(exempt)))) {
                return true;
            }
            
            // Admin ayarlarından exempt category'leri al (varsayılan: TOSTLAR)
            const tagExemptCategories = appSettings?.tagExemptions?.categories || ['TOSTLAR'];
            const categoryNormalized = normalizeText(food.category || '');
            if (categoryNormalized && tagExemptCategories.some(exempt => categoryNormalized.includes(normalizeText(exempt)))) {
                return true;
            }
            
            return false;
        }

        // Rotation indices generator
        function getRotatedAlternativeIndices(refFood, totalAlternatives) {
            if (!totalAlternatives || totalAlternatives <= 0) return [];
            
            // 🔥 ÖNCELİK SIRASI: Hasta özel ayarı > Admin default > 10
            let alternativeCount = 10; // Fallback
            
            // 1. Hasta bazlı alternatif sayısını kontrol et (mobil versiyon mantığı)
            try {
                if (patientData && patientData.alternativeCount != null && patientData.alternativeCount > 0) {
                    alternativeCount = patientData.alternativeCount;
                    console.log(`✅ HASTA ÖZEL AYARI KULLANILIYOR: ${alternativeCount}`);
                } else if (appSettings?.defaultAlternativeCount > 0) {
                    alternativeCount = appSettings.defaultAlternativeCount;
                    console.log(`📋 Admin default kullanılıyor: ${alternativeCount}`);
                } else {
                    console.log(`⚠️ Varsayılan kullanılıyor: ${alternativeCount}`);
                }
            } catch (error) {
                console.warn('⚠️ Alternatif sayısı alınamadı, varsayılan kullanılacak:', error);
            }
            
            // Rotation sistemi şimdilik basit - sıralı indices döndür
            // İleride localStorage ile rotation state takibi eklenebilir
            const indices = [];
            for (let i = 0; i < Math.min(alternativeCount, totalAlternatives); i++) {
                indices.push(i);
            }
            return indices;
        }

        // --- FOOD ALTERNATIVE SYSTEM: findAlternatives() Core Algorithm ---
        
        /**
         * findAlternatives - Referans yemeğe benzer alternatifler bulur
         * @param {Object} refFood - Referans yemek objesi
         * @param {Number} alternativeCount - Kaç alternatif döndürüleceği (default: 10)
         * @returns {Array} - Benzerlik skorlarıyla sıralanmış alternatif yemekler
         * 
         * Filtreleme kriterleri:
         * - role (exact match - required)
         * - category (exact match)
         * - seasonRange (exact match)
         * - mealType (OR logic - en az bir öğün ortak)
         * - dietType (keto/lowcarb hiyerarşisi)
         * - tag filtering (shouldSkipTagFilter ile exemptions)
         * 
         * Benzerlik skoru: 100 - ((|cal|/5 + |prot|*3 + |carb|*3 + |fat|*3) / 4)
         */
        function findAlternatives(refFood, alternativeCount = 10) {
            if (!refFood || !refFood.name) {
                console.warn('⚠️ findAlternatives: refFood geçersiz', refFood);
                return [];
            }

            // foodData yüklenmiş mi kontrol et
            if (!foodData || foodData.length === 0) {
                console.warn('⚠️ findAlternatives: foodData yüklenmemiş');
                return [];
            }

            const selectedDietType = getDietType(refFood);
            const selectedTagKeywords = extractTagKeywords(refFood);
            const refMealTypes = parseMealTypes(refFood.mealType);
            
            // 🔍 DEBUG: Filtreleme kriterleri
            console.log('🔍 findAlternatives DEBUG:', {
                refFoodName: refFood.name,
                refFoodRole: refFood.role,
                refFoodCategory: refFood.category,
                refFoodKeto: refFood.keto,
                refFoodLowcarb: refFood.lowcarb,
                matchCriteria: matchCriteria,
                scoreBy: scoreBy, // Hangi makrolar hesaba katılacak
                selectedDietType: selectedDietType,
                foodDataTotal: foodData.length
            });

            // 1️⃣ 5 KRİTER İLE FİLTRELEME (Admin ayarlarından gelen matchCriteria)
            let alternatives = foodData.filter(food => {
                // Kendisini hariç tut
                if (food.name === refFood.name) return false;

                // 🍞 ÖZEL DURUM: Ekmek için daha esnek filtreleme
                const isBread = normalizeText(refFood.role || '').includes('bread') || 
                                normalizeText(refFood.role || '').includes('ekmek');
                
                // Role kontrolü (matchCriteria.role true ise aktif)
                if (matchCriteria.role && !isBread && food.role !== refFood.role) {
                    return false;
                }
                
                // Ekmek için: Role yerine category kontrolü (EKMEK kategorisindeki her şey)
                if (isBread && matchCriteria.role) {
                    const foodIsBread = normalizeText(food.role || '').includes('bread') || 
                                       normalizeText(food.role || '').includes('ekmek') ||
                                       normalizeText(food.category || '').includes('ekmek') ||
                                       normalizeText(food.name || '').includes('ekmek');
                    if (!foodIsBread) return false;
                }

                // Category kontrolü (matchCriteria.category true ise aktif)
                if (matchCriteria.category && !isBread && refFood.category && food.category !== refFood.category) return false;

                // Season kontrolü (matchCriteria.season true ise aktif)
                if (matchCriteria.season) {
                    // İkisi de mevsimlik ise aynı mevsim olmalı
                    if (refFood.seasonRange && food.seasonRange) {
                        if (refFood.seasonRange !== food.seasonRange) {
                            return false;
                        }
                    }
                }

                // MealType kontrolü (matchCriteria.mealType true ise aktif)
                if (matchCriteria.mealType && refFood.mealType) {
                    const foodMealTypes = parseMealTypes(food.mealType);
                    // En az bir öğün ortak olmalı (OR LOGIC)
                    if (!hasMealTypeOverlap(refMealTypes, foodMealTypes)) {
                        return false;
                    }
                }

                // DietType kontrolü (matchCriteria.dietType true ise aktif)
                if (matchCriteria.dietType) {
                    const foodDietType = getDietType(food);
                    const refDietType = getDietType(refFood);
                    
                    // 🔍 DEBUG: İlk 3 yemek için diet type kontrolü göster
                    if (foodData.indexOf(food) < 3) {
                        console.log(`🔍 DietType Check (${food.name}):`, {
                            foodKeto: food.keto,
                            foodLowcarb: food.lowcarb,
                            foodDietType: foodDietType,
                            refKeto: refFood.keto,
                            refLowcarb: refFood.lowcarb,
                            refDietType: refDietType,
                            match: foodDietType === refDietType
                        });
                    }
                    
                    // AYNI DİYET TİPİ OLMALI (keto → keto, lowcarb → lowcarb, normal → normal)
                    if (foodDietType !== refDietType) {
                        return false;
                    }
                }

                return true;
            });
            
            console.log(`🔍 Filtre sonrası: ${alternatives.length} alternatif (foodData: ${foodData.length})`);
            
            // Role filtresi kontrolü
            if (matchCriteria.role) {
                const roleTypes = alternatives.reduce((acc, food) => {
                    acc[food.role] = (acc[food.role] || 0) + 1;
                    return acc;
                }, {});
                console.log(`✅ Role filtresi AKTIF - Sadece "${refFood.role}" alternatifleri:`, roleTypes);
            } else {
                console.log(`⚠️ Role filtresi PASİF - Tüm roller karışık`);
            }
            
            // DietType filtresi kontrolü
            if (matchCriteria.dietType) {
                const refDietType = getDietType(refFood);
                const dietTypes = alternatives.reduce((acc, food) => {
                    const dt = getDietType(food);
                    acc[dt] = (acc[dt] || 0) + 1;
                    return acc;
                }, {});
                console.log(`✅ DietType filtresi AKTIF - Sadece "${refDietType}" alternatifleri:`, dietTypes);
            } else {
                console.log(`⚠️ DietType filtresi PASİF - Tüm diyet tipleri karışık`);
            }

            // 2️⃣ TAG FİLTRELEME (mobil versiyon mantığı - enableTagFilter kontrolü)
            if (appSettings?.enableTagFilter && selectedTagKeywords.size > 0 && !shouldSkipTagFilter(refFood)) {
                const filteredByTags = alternatives.filter(food => {
                    // Salata/çorba gibi roller tag filter'dan muaf
                    if (shouldSkipTagFilter(food)) return true;

                    const alternativeKeywords = extractTagKeywords(food);
                    // Eğer alternatifin tag'lerinden biri ref food'un tag'leriyle eşleşiyorsa RED
                    for (const keyword of alternativeKeywords) {
                        if (selectedTagKeywords.has(keyword)) return false;
                    }
                    return true;
                });

                // Eğer tag filtrelemesi sonucu alternatif kaldıysa kullan
                if (filteredByTags.length > 0) {
                    console.log(`🏷️ Tag filtreleme: ${alternatives.length} → ${filteredByTags.length} alternatif`);
                    alternatives = filteredByTags;
                } else {
                    console.log(`⚠️ Tag filtreleme sonuç bulamadı, tüm ${alternatives.length} alternatif korunuyor`);
                }
            } else {
                console.log(`ℹ️ Tag filtreleme atlandı (enableTagFilter: ${appSettings?.enableTagFilter}, keywords: ${selectedTagKeywords.size})`);
            }

            // 3️⃣ BENZERLİK SKORU HESAPLAMA (scoreBy array'ine göre dinamik)
            alternatives = alternatives.map(food => {
                let totalDiff = 0;
                let count = 0;
                
                // scoreBy array'i boşsa varsayılan olarak tüm makrolar kullanılır
                const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
                
                // Sadece scoreBy'da olan kriterler hesaplanır
                if (criteria.includes('calories')) {
                    totalDiff += Math.abs((food.calories || 0) - (refFood.calories || 0)) / 5;
                    count++;
                }
                
                if (criteria.includes('protein')) {
                    totalDiff += Math.abs((food.protein || 0) - (refFood.protein || 0)) * 3;
                    count++;
                }
                
                if (criteria.includes('carbs')) {
                    totalDiff += Math.abs((food.carbs || 0) - (refFood.carbs || 0)) * 3;
                    count++;
                }
                
                if (criteria.includes('fat')) {
                    totalDiff += Math.abs((food.fat || 0) - (refFood.fat || 0)) * 3;
                    count++;
                }

                // Benzerlik skoru: 100 - (toplam fark / kriter sayısı)
                const similarity = Math.round(Math.max(0, 100 - (count > 0 ? totalDiff / count : 0)));

                return { ...food, similarity };
            });

            // 4️⃣ BENZERLİĞE GÖRE SIRALA (en yüksek benzerlik önce)
            alternatives.sort((a, b) => b.similarity - a.similarity);
            
            // 🔍 DEBUG: Benzerlik skoru hesaplama detayları
            const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
            console.log(`📊 Benzerlik skorları (aktif kriterler: ${criteria.join(', ')}):`, {
                toplam_alternatif: alternatives.length,
                scoreBy_array: scoreBy,
                kullanilan_kriterler: criteria,
                referans_makrolar: {
                    protein: refFood.protein,
                    fat: refFood.fat,
                    carbs: refFood.carbs,
                    calories: refFood.calories
                }
            });
            
            // İlk 5 alternatifi göster
            alternatives.slice(0, 5).forEach((alt, idx) => {
                console.log(`  ${idx + 1}. ${alt.name} - Skor: ${alt.similarity}% (P:${alt.protein}g, Y:${alt.fat}g, K:${alt.carbs}g, Cal:${alt.calories})`);
            });

            // 5️⃣ ROTASYON İLE LİMİTLEME
            const totalAlternatives = alternatives.length;
            const rotationIndices = getRotatedAlternativeIndices(refFood, totalAlternatives);

            // rotationIndices kullanarak istenen sayıda alternatif seç
            const selectedAlternatives = rotationIndices
                .slice(0, alternativeCount)
                .map(index => alternatives[index])
                .filter(Boolean); // undefined olanları temizle

            console.log(`✅ findAlternatives: "${refFood.name}" için ${selectedAlternatives.length}/${totalAlternatives} alternatif bulundu`);
            return selectedAlternatives;
        }

        // 🔄 Gün toplamlarını yeniden hesapla (öğün ve gün makroları)
        function recalculateDayMacros(day) {
            const ogunler = day.meals || day.ogunler || [];
            
            // Gün toplamlarını sıfırla
            let totalKalori = 0;
            let totalProtein = 0;
            let totalKarb = 0;
            let totalYag = 0;
            
            // Her öğünü dolaş ve toplamları hesapla
            ogunler.forEach(meal => {
                // Öğün toplamlarını sıfırla
                let ogunKalori = 0;
                let ogunProtein = 0;
                let ogunKarb = 0;
                let ogunYag = 0;
                
                // Öğündeki yemekleri topla
                if (meal.yemekler && meal.yemekler.length > 0) {
                    meal.yemekler.forEach(food => {
                        ogunKalori += food.calories || food.kalori || 0;
                        ogunProtein += food.protein || 0;
                        ogunKarb += food.carbs || food.karb || 0;
                        ogunYag += food.fat || food.yag || 0;
                    });
                }
                
                // Öğün toplamlarını kaydet (meal object'inde)
                meal.totalCalories = Math.round(ogunKalori);
                meal.totalProtein = Math.round(ogunProtein);
                meal.totalCarbs = Math.round(ogunKarb);
                meal.totalFat = Math.round(ogunYag);
                
                // Günlük toplama ekle
                totalKalori += ogunKalori;
                totalProtein += ogunProtein;
                totalKarb += ogunKarb;
                totalYag += ogunYag;
            });
            
            // Gün toplamlarını güncelle
            day.totalMacros = {
                kalori: Math.round(totalKalori),
                protein: Math.round(totalProtein),
                karb: Math.round(totalKarb),
                yag: Math.round(totalYag)
            };
            day.totalCalories = Math.round(totalKalori);
            
            console.log(`✅ Gün makroları yeniden hesaplandı: ${totalKalori} kcal (P: ${totalProtein}g, K: ${totalKarb}g, Y: ${totalYag}g)`);
        }

        // 🔄 Tek bir yemek için alternatif bulma ve değiştirme
        async function refreshFoodInMeal(weekIndex, dayIndex, ogunIndex, yemekIndex) {
            try {
                console.log(`🔄 Yemek yenileniyor: Week ${weekIndex}, Day ${dayIndex}, Öğün ${ogunIndex}, Yemek ${yemekIndex}`);
                
                // 1️⃣ Mevcut yemeği al (weeks yapısı kontrol et)
                const week = weeks[weekIndex];
                if (!week || !week.days || !week.days[dayIndex]) {
                    console.error('❌ Hafta veya gün bulunamadı!');
                    return;
                }
                
                const day = week.days[dayIndex];
                const ogunler = day.meals || day.ogunler || [];
                
                if (!ogunler[ogunIndex] || !ogunler[ogunIndex].yemekler || !ogunler[ogunIndex].yemekler[yemekIndex]) {
                    console.error('❌ Yemek bulunamadı!');
                    return;
                }
                
                const currentFood = ogunler[ogunIndex].yemekler[yemekIndex];
                if (!currentFood) {
                    console.error('❌ Yemek bulunamadı!');
                    return;
                }
                
                console.log(`📌 Mevcut yemek: ${currentFood.foodName}`);
                
                // 🔍 Hibrit eşleştirme ile foodData'dan role bilgisini al (ROTASYON MOD: weekIndex ekle)
                const matchedFood = findFoodInDatabase(currentFood.foodName, weekIndex);
                
                if (matchedFood) {
                    console.log(`✅ foodData'da bulundu - Role: ${matchedFood.role}`);
                } else {
                    console.warn(`⚠️ foodData'da bulunamadı: ${currentFood.foodName}`);
                    // Role filtresi aktifken foodData'da olmayan yemekler için alternatif bulunamaz
                    if (matchCriteria.role) {
                        alert('❌ Bu yemek veritabanında bulunamadı.\n\nÇözüm:\n1. Yemek adını kontrol edin\n2. Admin panelden manuel eşleştirme ekleyin\n3. Role filtresini geçici kapatın');
                        return;
                    }
                }
                
                // Admin ayarlarından alternatif sayısını al (varsayılan 10)
                const alternativeCount = appSettings?.defaultAlternativeCount || 10;
                
                // 2️⃣ Alternatif bul - role bilgisini foodData'dan kullan
                // 🔥 ÖNEMLİ: keto ve lowcarb boolean'larını da ekle (getDietType için gerekli!)
                // 🔥 BUGFIX: foodData'da yoksa settings'den diyet tipini al (hastanın diyet ayarı)
                const patientDietType = settings?.dietType || 'ketojenik';
                const inferredKeto = matchedFood?.keto ?? currentFood.keto ?? (patientDietType === 'ketojenik');
                const inferredLowcarb = matchedFood?.lowcarb ?? currentFood.lowcarb ?? (patientDietType === 'lowcarb');
                
                const alternatives = findAlternatives({
                    name: currentFood.foodName,
                    calories: currentFood.kalori,
                    protein: currentFood.protein,
                    carbs: currentFood.karb,
                    fat: currentFood.yag,
                    role: matchedFood?.role || currentFood.role || 'mainDish',
                    category: matchedFood?.category || currentFood.category || '',
                    seasonRange: matchedFood?.seasonRange || currentFood.seasonRange || '',
                    mealType: matchedFood?.mealType || currentFood.mealType || '',
                    dietType: matchedFood?.dietType || currentFood.dietType || '',
                    tags: matchedFood?.tags || currentFood.tags || '',
                    // 🔥 BUGFIX: getDietType() boolean kontrol yapar + settings'den çıkarsama yap!
                    keto: inferredKeto,
                    lowcarb: inferredLowcarb
                }, alternativeCount);
                
                if (!alternatives || alternatives.length === 0) {
                    // Detaylı hata mesajı hazırla
                    const refDietType = getDietType({
                        keto: inferredKeto,
                        lowcarb: inferredLowcarb
                    });
                    
                    // foodData'daki role ve dietType dağılımını göster
                    const roleStats = foodData.reduce((acc, f) => {
                        acc[f.role] = (acc[f.role] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const targetRole = matchedFood?.role || currentFood.role || 'mainDish';
                    const sameRoleFoods = foodData.filter(f => f.role === targetRole);
                    const sameRoleDietStats = sameRoleFoods.reduce((acc, f) => {
                        const dt = getDietType(f);
                        acc[dt] = (acc[dt] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const errorDetails = [
                        `Yemek: ${currentFood.foodName}`,
                        `Role: ${targetRole}`,
                        `DietType: ${refDietType} (keto:${inferredKeto}, lowcarb:${inferredLowcarb}) [foodData: keto=${matchedFood?.keto}, lowcarb=${matchedFood?.lowcarb}]`,
                        `Category: ${matchedFood?.category || currentFood.category || 'Belirsiz'}`,
                        `Hasta diyet tipi: ${settings?.dietType || 'Belirsiz'}`,
                        ``,
                        `Aktif Filtreler:`,
                        `  - Role: ${matchCriteria.role ? 'AÇIK' : 'KAPALI'}`,
                        `  - DietType: ${matchCriteria.dietType ? 'AÇIK' : 'KAPALI'}`,
                        `  - Category: ${matchCriteria.category ? 'AÇIK' : 'KAPALI'}`,
                        `  - Season: ${matchCriteria.season ? 'AÇIK' : 'KAPALI'}`,
                        `  - MealType: ${matchCriteria.mealType ? 'AÇIK' : 'KAPALI'}`,
                        ``,
                        `foodData İstatistikleri:`,
                        `  - Toplam yemek: ${foodData.length}`,
                        `  - "${targetRole}" role: ${sameRoleFoods.length} adet`,
                        `  - "${targetRole}" + DietType dağılımı:`,
                        `    ${JSON.stringify(sameRoleDietStats)}`,
                        ``,
                        `Olası nedenler:`,
                        `1. DietType boolean'ları eksik (keto/lowcarb property yok)`,
                        `2. Role eşleşmiyor ("${targetRole}" için ${sameRoleFoods.length} adet var)`,
                        `3. Tag filtreleme çok kısıtlayıcı`,
                        `4. Yemek veritabanında yok`
                    ];
                    
                    console.error('❌ ALTERNATİF BULUNAMADI - DETAYLAR:\n' + errorDetails.join('\n'));
                    alert('❌ Bu yemek için alternatif bulunamadı!\n\nDetaylar için Console (F12) kontrol edin.');
                    return;
                }
                
                console.log(`✅ ${alternatives.length} alternatif bulundu`);
                
                // 3️⃣ Rotasyon tracking (localStorage ile - mobil versiyon mantığı)
                const foodNameNormalized = normalizeText(currentFood.foodName);
                const rotationKey = `foodRotation_${foodNameNormalized}`;
                
                // LocalStorage'dan rotasyon state'i al
                let rotationState = {};
                try {
                    const stored = localStorage.getItem(rotationKey);
                    if (stored) {
                        rotationState = JSON.parse(stored);
                    }
                } catch (error) {
                    console.warn('⚠️ Rotasyon state okunamadı:', error);
                }
                
                // Rotasyon index'i artır
                let currentIndex = rotationState.index || 0;
                currentIndex = (currentIndex + 1) % alternatives.length;
                
                // Yeni state'i kaydet
                rotationState.index = currentIndex;
                rotationState.lastUpdated = new Date().toISOString();
                try {
                    localStorage.setItem(rotationKey, JSON.stringify(rotationState));
                } catch (error) {
                    console.warn('⚠️ Rotasyon state kaydedilemedi:', error);
                }
                
                // Seçilen alternatif
                const selectedAlternative = alternatives[currentIndex];
                
                console.log(`🔄 Seçilen alternatif (${currentIndex + 1}/${alternatives.length}): ${selectedAlternative.name} (Benzerlik: ${selectedAlternative.similarity}%)`);
                
                // 4️⃣ Yemeği güncelle (yeni alternatifle değiştir)
                ogunler[ogunIndex].yemekler[yemekIndex] = {
                    foodName: selectedAlternative.name,
                    kalori: selectedAlternative.calories,
                    protein: selectedAlternative.protein,
                    karb: selectedAlternative.carbs,
                    yag: selectedAlternative.fat,
                    role: selectedAlternative.role,
                    category: selectedAlternative.category,
                    seasonRange: selectedAlternative.seasonRange,
                    mealType: selectedAlternative.mealType,
                    dietType: selectedAlternative.dietType,
                    tags: selectedAlternative.tags
                    // refreshIndex KALDIRILDI - localStorage kullanıyoruz
                };
                
                // meals veya ogunler olarak kaydet (her iki formatta da çalışsın)
                if (day.meals) {
                    day.meals = ogunler;
                } else {
                    day.ogunler = ogunler;
                }
                
                // 🔥 ÖNEMLİ: Öğün ve gün toplamlarını yeniden hesapla
                recalculateDayMacros(day);
                
                // 5️⃣ Weeks array'i kaydet (localStorage + GitHub)
                await saveWeeks();
                
                // 6️⃣ UI'ı güncelle
                renderWeekContent();
                
                console.log(`✅ Yemek başarıyla değiştirildi: ${selectedAlternative.name}`);
                
            } catch (error) {
                console.error('❌ refreshFoodInMeal hatası:', error);
                alert('❌ Yemek değiştirilemedi! Hata: ' + error.message);
            }
        }

        // Initialize
        async function init() {
            console.log('🚀 Başlatılıyor...');
            
            // Admin config yükle (patientAdmins listesi için)
            await loadAdminsConfig();
            
            // Admin ayarlarını yükle
            await loadAdminSettings();
            
            // Manuel eşleştirmeleri ve yasak kurallarını yükle
            await loadManuelEslestirmeler();
            
            // Tarif kartlarını yükle
            await loadTarifKartlari();
            
            // Yemek veritabanını yükle
            await loadFoodData();
            
            // Check if PatientAuth is available
            if (typeof PatientAuth === 'undefined') {
                console.error('❌ PatientAuth bulunamadı!');
                showErrorPage('Kimlik doğrulama sistemi yüklenemedi');
                return;
            }

            // Check if user is logged in
            const session = PatientAuth.getSession();
            if (!session) {
                console.warn('⚠️ Session bulunamadı, giriş sayfasına yönlendiriliyor');
                window.location.href = 'login.html';
                return;
            }

            console.log('✅ Session bulundu:', session);

            // Set current patient info (window.currentPatient'a da ata)
            currentPatient = window.currentPatient = {
                id: session.patientId || session.id,
                name: session.name || 'Hasta',
                username: session.username || ''
            };

            // Header'ı hemen güncelle (loadPatientData detaylı bilgi yüklenince tekrar güncelleyecek)
            document.getElementById('headerPatientName').textContent = currentPatient.name;

            // Hasta bilgilerini yükle (kilo, aktivite vs) - header'daki ad burada güncellenir
            await loadPatientData();

            // Load templates
            await loadTemplates();

            // Load data from GitHub (with localStorage cache fallback)
            await loadDataFromGitHub();

            // Admin UI'yi başlat
            initAdminUI();

            // Render UI
            renderTabs();
            renderWeekContent();
        }

        // Show error page
        function showErrorPage(message) {
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">${message}</h3>
                    <p style="color: #666; margin-bottom: 20px;">Lütfen sayfayı yenileyin veya giriş sayfasına dönün.</p>
                    <button onclick="window.location.href='login.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Giriş Sayfasına Dön
                    </button>
                </div>
            `;
        }

        // Hasta bilgilerini yükle (hastalar/ klasöründen)
        async function loadPatientData() {
            try {
                // currentPatient.id zaten patient_ öneki içeriyor, temizle
                const cleanId = currentPatient.id.replace(/^patient_/i, '');
                const patientFileName = `hastalar/patient_${cleanId}.json`;
                const cachedDataKey = `patient_data_${cleanId}`;
                
                console.log('🔍 Hasta verisi yükleniyor:', patientFileName);
                
                // ÖNCELİK 1: GitHub'dan çek (cache bypass için timestamp)
                const timestamp = new Date().getTime();
                const response = await fetch(`${patientFileName}?t=${timestamp}`);
                
                if (response.ok) {
                    // GitHub'da var - HER ZAMAN ÖNCE GITHUB!
                    patientData = await response.json();
                    localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    console.log('✅ Hasta bilgileri GitHub\'dan yüklendi:', patientData);
                    
                    // 🔐 isAdmin alanını currentPatient'a ekle (window'a da senkronize et)
                    if (patientData.isAdmin === true) {
                        currentPatient.isAdmin = true;
                        window.currentPatient.isAdmin = true;
                        console.log('🔑 Hasta dosyasında admin yetkisi bulundu');
                    }
                    
                    // Weeks verisini yükle
                    if (patientData.weeks && Array.isArray(patientData.weeks)) {
                        weeks = patientData.weeks;
                        console.log('✅ Hafta verileri yüklendi:', weeks.length, 'hafta');
                    } else {
                        // weeks undefined bırak, loadDataFromGitHub() varsayılan oluşturacak
                        weeks = undefined;
                        console.log('⚠️ Hafta verisi bulunamadı (GitHub\'da yok)');
                    }
                } else {
                    // ÖNCELİK 2: GitHub'da yoksa localStorage'dan yükle
                    const cachedData = localStorage.getItem(cachedDataKey);
                    if (cachedData) {
                        patientData = JSON.parse(cachedData);
                        console.log('⚠️ GitHub erişilemiyor, localStorage kullanıldı:', patientData);
                        
                        // Weeks verisini yükle
                        if (patientData.weeks && Array.isArray(patientData.weeks)) {
                            weeks = patientData.weeks;
                            console.log('✅ Hafta verileri localStorage\'dan yüklendi:', weeks.length, 'hafta');
                        } else {
                            weeks = undefined;
                        }
                    } else {
                        // Hiçbir yerde yok - varsayılan değerler
                        console.warn('⚠️ Hasta dosyası bulunamadı, varsayılan değerler kullanılacak');
                        patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                        weeks = undefined;
                    }
                }
                
                // Header'daki hasta adını güncelle
                const fullName = patientData.personalInfo?.name && patientData.personalInfo?.surname
                    ? `${patientData.personalInfo.name} ${patientData.personalInfo.surname}`
                    : patientData.personalInfo?.name || currentPatient.name || 'Hasta';
                document.getElementById('headerPatientName').textContent = fullName;
                
                // 🔐 Admin özelliklerini güncelle (hasta verisi yüklendikten sonra)
                toggleAdminFeatures();
                    
            } catch (error) {
                console.error('❌ Hasta bilgileri yüklenirken hata:', error);
                patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                weeks = undefined; // undefined bırak, varsayılan hafta loadDataFromGitHub() içinde oluşturulacak
                // Hata durumunda da header'ı güncelle
                document.getElementById('headerPatientName').textContent = currentPatient.name || 'Hasta';
            }
        }

        // Makro gösterimini güncelle
        function updateMacroDisplay() {
            const dietType = document.getElementById('dietType').value;
            const macroDisplay = document.getElementById('macroDisplay');
            const macroDetails = document.getElementById('macroDetails');

            if (!dietType || (dietType !== 'ketojenik' && dietType !== 'lowcarb' && dietType !== 'eliminasyonlu-ketojenik')) {
                macroDisplay.style.display = 'none';
                return;
            }

            // Form'dan güncel değerleri al - eğer form boşsa patientData'dan çek
            let weight = parseFloat(document.getElementById('patientWeight').value);
            let activity = parseInt(document.getElementById('patientActivity').value);
            
            // Eğer form değerleri boşsa, patientData'dan çek
            if (!weight && patientData?.personalInfo?.weight) {
                weight = patientData.personalInfo.weight;
                document.getElementById('patientWeight').value = weight;
            }
            if (!activity && patientData?.personalInfo?.activity) {
                activity = patientData.personalInfo.activity;
                document.getElementById('patientActivity').value = activity;
            }
            
            // Hala değer yoksa varsayılanları kullan
            weight = weight || 70;
            activity = activity || 3;

            // Eliminasyonlu ketojenik için ketojenik formülünü kullan
            const calcDietType = dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : dietType;
            const macros = calculateMacros(weight, calcDietType, activity);

            if (macros) {
                macroDetails.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>Kilo:</strong> ${weight} kg | <strong>Aktivite:</strong> Seviye ${activity} (×${macros.activityMultiplier})
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Karbonhidrat</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.carb}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Protein</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.protein}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Yağ</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.fat}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Kalori</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.calories} kcal</div>
                        </div>
                    </div>
                `;
                macroDisplay.style.display = 'block';
                
                // Hesaplanan kaloriyi hedef kalori alanına yaz ve min/max'ı otomatik hesaplat
                document.getElementById('targetCalories').value = macros.calories;
                updateCalorieRange();
            } else {
                macroDisplay.style.display = 'none';
            }
        }

        // Hedef kaloriden min/max hesapla
        function updateCalorieRange() {
            const targetCalories = parseInt(document.getElementById('targetCalories').value) || 0;
            
            if (targetCalories > 0) {
                // Hasta kendi toleransını belirlediyse onu kullan, yoksa admin varsayılanını kullan
                let tolerancePercent = parseInt(document.getElementById('calorieTolerancePercent').value);
                if (!tolerancePercent || tolerancePercent < 0) {
                    tolerancePercent = appSettings?.calorieTolerancePercent || 5;
                }
                
                const tolerance = tolerancePercent / 100;
                
                const minCalories = Math.round(targetCalories * (1 - tolerance));
                const maxCalories = Math.round(targetCalories * (1 + tolerance));
                
                document.getElementById('minCalories').value = minCalories;
                document.getElementById('maxCalories').value = maxCalories;
                
                // Tolerans bilgisini güncelle
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ±%${tolerancePercent} tolerans ile ayarlanır`;
            } else {
                document.getElementById('minCalories').value = '';
                document.getElementById('maxCalories').value = '';
            }
        }

        // Tolerans değeri değiştiğinde bilgilendirme güncelle
        function updateToleranceInfo() {
            updateCalorieRange(); // Min/max'ı yeniden hesapla
            
            // Eğer gün ekleme modalı açıksa, şablonları yeniden yükle (dinamik filtreleme)
            const addDayModal = document.getElementById('addDayModal');
            if (addDayModal && addDayModal.style.display === 'flex') {
                console.log('🔄 Tolerans değişti, şablonlar yeniden yükleniyor...');
                loadDayTemplates();
            }
        }

        // Load Data from GitHub
        async function loadDataFromGitHub() {
            console.log('🔄 GitHub\'dan veriler yükleniyor...');
            
            try {
                // weeks loadPatientData() içinde yüklendi
                // SADECE undefined ise (GitHub'da hiç yoksa) varsayılan hafta oluştur
                if (weeks === undefined) {
                    console.log('⚠️ Hafta verisi bulunamadı, varsayılan hafta oluşturuluyor');
                    const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                    weeks = defaultWeeksData.weeks;
                    // Varsayılan haftayı kaydet
                    await saveWeeks();
                } else {
                    console.log('✅ Mevcut hafta verileri kullanılıyor:', weeks.length, 'hafta');
                }

                // Apply settings to form if modal is open
                applySettingsToForm();

                console.log('✅ Veriler başarıyla yüklendi');
                showToast('Veriler yüklendi');

            } catch (error) {
                console.error('❌ Veri yüklenirken hata:', error);
                
                // Hata durumunda SADECE undefined ise varsayılan hafta oluştur
                if (weeks === undefined) {
                    const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                    weeks = defaultWeeksData.weeks;
                }

                showToast('Önbellekten yüklendi', 'warning');
            }
        }

        // Load Templates from JSON
        async function loadTemplates() {
            try {
                console.log('📥 Şablonlar GitHub\'dan yükleniyor...');

                // Load day templates from GitHub
                const dayResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/gun-sablonlari-2025-10-25.json?t=' + Date.now());
                const dayData = await dayResponse.json();
                dayTemplates = dayData.templates || [];
                
                // 🔍 DEBUG: Şablon yükleme detayları
                console.log('📊 GitHub\'dan yüklenen şablon sayısı:', dayData.totalCount || dayTemplates.length);
                console.log('📋 Gerçek array uzunluğu:', dayTemplates.length);
                console.log('🆔 Şablon ID\'leri:', dayTemplates.map(t => `${t.id}: ${t.name}`));

                // Load meal templates from GitHub
                const mealResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/ogun-sablonlari-2025-09-25-2025-10-25%20(1).json');
                const mealData = await mealResponse.json();
                mealTemplates = mealData.templates || [];

                console.log('✅ Şablonlar yüklendi:', {
                    gunSablonlari: dayTemplates.length,
                    ogunSablonlari: mealTemplates.length
                });
            } catch (error) {
                console.error('❌ Şablonlar yüklenemedi:', error);
                showToast('Şablonlar yüklenemedi. Lütfen sayfayı yenileyin.', 'error');
                
                // Show error in UI
                const contentArea = document.getElementById('contentArea');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #dc3545; margin-bottom: 15px;">⚠️ Şablonlar Yüklenemedi</h3>
                            <p style="color: #666; margin-bottom: 20px;">Beslenme şablonları GitHub'dan yüklenemedi. Bu sayfa local file sisteminde çalışmaz.</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                                <strong>Çözüm:</strong><br>
                                1. Dosyaları bir web sunucusunda çalıştırın (XAMPP, WAMP, vb.)<br>
                                2. Ya da GitHub Pages'de deploy edin<br>
                                3. Ya da VS Code Live Server extension kullanın
                            </div>
                            <button onclick="location.reload()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                🔄 Sayfayı Yenile
                            </button>
                            <br><br>
                            <a href="mobil_versiyon_v1.html" style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; display: inline-block; margin-top: 10px;">
                                🍽️ Alternatif Yemeklere Git
                            </a>
                        </div>
                    `;
                }
            }
        }

        // Load Settings (for form display)
        function applySettingsToForm() {
            if (document.getElementById('dietType')) {
                // Hasta verilerinden bilgileri çek (patientData global olarak loadPatientData ile yüklendi)
                const personalInfo = patientData?.personalInfo || {};
                const settings = patientData?.settings || {};
                
                // Kişisel bilgiler - patientData'dan çek
                document.getElementById('patientName').value = personalInfo.name || '';
                document.getElementById('patientSurname').value = personalInfo.surname || '';
                document.getElementById('patientAge').value = personalInfo.age || 35;
                document.getElementById('patientGender').value = personalInfo.gender || '';
                document.getElementById('patientWeight').value = personalInfo.weight || 70;
                document.getElementById('patientHeight').value = personalInfo.height || 170;
                document.getElementById('patientActivity').value = personalInfo.activity || 3;
                
                // Aktivite seviyesi - personalInfo'dan veya settings'den al
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    activityLevelInput.value = personalInfo.activityLevel || settings.activityLevel || 3;
                }
                
                // Kullanıcı adı (readonly)
                const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                document.getElementById('patientUsername').value = session.username || '';
                
                // BMI hesapla
                calculateBMI();
                
                // Admin varsayılan toleransı göster
                const adminDefaultTolerance = appSettings?.calorieTolerancePercent || 5;
                document.getElementById('adminDefaultTolerance').textContent = adminDefaultTolerance;
                
                // Hasta kendi toleransını belirlediyse onu göster, yoksa admin varsayılanını kullan
                const patientTolerance = settings.calorieTolerancePercent || adminDefaultTolerance;
                document.getElementById('calorieTolerancePercent').value = patientTolerance;
                
                // Tolerans bilgisini göster
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ±%${patientTolerance} tolerans ile ayarlanır`;
                
                // Diyet ayarları - settings objesinden çek
                document.getElementById('dietType').value = settings.dietType || 'ketojenik';
                document.getElementById('targetCalories').value = settings.targetCalories || 1000;
                document.getElementById('minCalories').value = settings.minCalories || 950;
                document.getElementById('maxCalories').value = settings.maxCalories || 1050;
                document.getElementById('dislikedFoods').value = (settings.dislikedFoods || []).join(', ');
                
                // Makro gösterimini güncelle
                updateMacroDisplay();
            }
        }

        // BMI Hesaplama
        function calculateBMI() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const height = parseFloat(document.getElementById('patientHeight').value);
            
            if (weight > 0 && height > 0) {
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
                document.getElementById('patientBMI').value = bmi;
            } else {
                document.getElementById('patientBMI').value = '';
            }
        }

        // Save Settings - GitHub'a otomatik kaydet
        async function saveSettings() {
            const newSettings = {
                dietType: document.getElementById('dietType').value,
                calorieTolerancePercent: parseInt(document.getElementById('calorieTolerancePercent').value) || (appSettings?.calorieTolerancePercent || 5),
                targetCalories: parseInt(document.getElementById('targetCalories').value) || 1000,
                minCalories: parseInt(document.getElementById('minCalories').value) || 950,
                maxCalories: parseInt(document.getElementById('maxCalories').value) || 1050,
                dislikedFoods: document.getElementById('dislikedFoods').value
                    .split(',')
                    .map(f => f.trim().toLowerCase())
                    .filter(f => f),
                personalInfo: {
                    name: document.getElementById('patientName').value.trim(),
                    surname: document.getElementById('patientSurname').value.trim(),
                    age: parseInt(document.getElementById('patientAge').value) || 35,
                    gender: document.getElementById('patientGender').value,
                    weight: parseFloat(document.getElementById('patientWeight').value) || 70,
                    height: parseFloat(document.getElementById('patientHeight').value) || 170,
                    activity: parseInt(document.getElementById('patientActivity').value) || 3
                },
                password: document.getElementById('patientPassword').value.trim(), // Şifre varsa kaydet
                allergies: settings.allergies || [],
                preferences: settings.preferences || {
                    vegetarian: false,
                    vegan: false,
                    glutenFree: false,
                    dairyFree: false
                },
                activityLevel: settings.activityLevel || 'moderate',
                targetWeight: settings.targetWeight || 0,
                currentWeight: settings.currentWeight || 0,
                height: settings.height || 0,
                age: settings.age || 0,
                gender: settings.gender || ''
            };

            settings = newSettings;
            
            // patientData'yı da güncelle
            if (patientData) {
                patientData.personalInfo = {
                    ...patientData.personalInfo,
                    ...newSettings.personalInfo
                };
                
                // Aktivite seviyesi ekle
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    patientData.personalInfo.activityLevel = parseInt(activityLevelInput.value) || 3;
                }

                patientData.settings = newSettings;
                patientData.updatedAt = new Date().toISOString(); // Güncelleme zamanını kaydet
                
                // Şifre değiştirilmişse ÖNCE hash hesapla
                let finalPasswordHash = patientData.passwordHash;
                const newPassword = document.getElementById('patientPassword').value.trim();
                if (newPassword && newPassword.length > 0) {
                    // PatientAuth.hashPassword kullan
                    if (typeof PatientAuth !== 'undefined' && PatientAuth.hashPassword) {
                        finalPasswordHash = await PatientAuth.hashPassword(newPassword);
                        patientData.passwordHash = finalPasswordHash;
                        console.log('🔐 Yeni şifre hash hesaplandı:', finalPasswordHash.substring(0, 10) + '...');
                    } else {
                        console.warn('⚠️ PatientAuth bulunamadı, eski hash korunuyor');
                    }
                }
                
                // localStorage'a kaydet (hash güncellemesinden SONRA)
                const cleanId = currentPatient.id.replace(/^patient_/i, '');
                const cachedDataKey = `patient_data_${cleanId}`;
                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                console.log('💾 Ayarlar localStorage\'a kaydedildi (passwordHash:', patientData.passwordHash.substring(0, 10) + '...)');
                
                // Header'daki hasta adını hemen güncelle
                const fullName = patientData.personalInfo?.name && patientData.personalInfo?.surname
                    ? `${patientData.personalInfo.name} ${patientData.personalInfo.surname}`
                    : patientData.personalInfo?.name || currentPatient.name || 'Hasta';
                document.getElementById('headerPatientName').textContent = fullName;
                console.log('✅ Header güncellendi:', fullName);
                
                // Session'ı da güncelle (parent frame için)
                const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                session.name = patientData.personalInfo.name;
                session.surname = patientData.personalInfo.surname;
                localStorage.setItem('patient_session', JSON.stringify(session));
                
                // GitHub'a kaydet (update-patient API ile)
                try {
                    const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            patientId: currentPatient.id,
                            name: patientData.personalInfo.name,
                            surname: patientData.personalInfo.surname,
                            age: patientData.personalInfo.age,
                            gender: patientData.personalInfo.gender,
                            weight: patientData.personalInfo.weight,
                            height: patientData.personalInfo.height,
                            username: currentPatient.username,
                            passwordHash: finalPasswordHash,
                            settings: patientData.settings || {}
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        console.log('✅ Ayarlar GitHub\'a kaydedildi');
                        // Yeniden yükle ki değişiklikler anında görülsün
                        try { loadDayTemplates(); } catch (e) {}
                        showToast('✅ Ayarlar kaydedildi!');
                    } else {
                        console.warn('⚠️ GitHub kayıt hatası:', result.error);
                        showToast('✅ Ayarlar kaydedildi! (Senkronizasyon sonra yapılacak)', 'warning');
                    }
                } catch (error) {
                    console.warn('⚠️ GitHub bağlantı hatası:', error);
                    showToast('✅ Ayarlar kaydedildi! (Senkronizasyon sonra yapılacak)', 'warning');
                }
            } else {
                showToast('✅ Ayarlar kaydedildi!');
            }

            setTimeout(() => closeModal('settingsModal'), 1000);
        }

        // Load Weeks - removed, now using loadDataFromGitHub()

        // Save Weeks - LocalStorage'a kaydet
        async function saveWeeks() {
            try {
                // LocalStorage'a kaydet (anında senkronizasyon için)
                const cachedDataKey = `patient_data_${currentPatient.id}`;
                patientData.weeks = weeks;
                patientData.updatedAt = new Date().toISOString();
                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                console.log('💾 Haftalık planlar localStorage\'a kaydedildi');
                
                // GitHub'a kaydet (API üzerinden)
                const cleanId = currentPatient.id.replace(/^patient_/i, '');
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patientId: `patient_${cleanId}`,
                        weeks: weeks
                    })
                });

                if (response.ok) {
                    console.log('✅ Haftalık planlar GitHub\'a kaydedildi');
                } else {
                    const errorData = await response.json();
                    console.error('❌ GitHub\'a kaydetme hatası:', errorData);
                    
                    // Değişiklik bayrağı ekle (manuel senkronizasyon için)
                    const pendingChanges = JSON.parse(localStorage.getItem('pending_patient_changes') || '[]');
                    if (!pendingChanges.includes(currentPatient.id)) {
                        pendingChanges.push(currentPatient.id);
                        localStorage.setItem('pending_patient_changes', JSON.stringify(pendingChanges));
                    }
                }
            } catch (error) {
                console.error('❌ saveWeeks hatası:', error);
                
                // Hata durumunda değişiklik bayrağı ekle
                const pendingChanges = JSON.parse(localStorage.getItem('pending_patient_changes') || '[]');
                if (!pendingChanges.includes(currentPatient.id)) {
                    pendingChanges.push(currentPatient.id);
                    localStorage.setItem('pending_patient_changes', JSON.stringify(pendingChanges));
                }
            }
        }

        // Add New Week
        function addNewWeek() {
            const weekNumber = weeks.length + 1;
            const lastWeek = weeks[weeks.length - 1];
            
            // Yeni hafta her zaman Pazartesi'den başlamalı
            let startDate = new Date();
            if (lastWeek && lastWeek.days.length > 0) {
                // Son haftanın son gününden sonraki Pazartesi'yi bul
                const lastDay = lastWeek.days[lastWeek.days.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
                
                // Pazartesi'ye kadar ilerle
                while (startDate.getDay() !== 1) { // 1 = Pazartesi
                    startDate.setDate(startDate.getDate() + 1);
                }
            } else if (lastWeek && lastWeek.startDate) {
                startDate = new Date(lastWeek.startDate);
                startDate.setDate(startDate.getDate() + 7);
                
                // Pazartesi'ye ayarla
                while (startDate.getDay() !== 1) {
                    startDate.setDate(startDate.getDate() + 1);
                }
            } else {
                // İlk hafta: Bir sonraki Pazartesi
                while (startDate.getDay() !== 1) {
                    startDate.setDate(startDate.getDate() + 1);
                }
            }

            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            renderWeekContent();
            showToast('Yeni hafta eklendi');
        }

        // Remove Week
        function removeWeek(index) {
            if (weeks.length === 1) {
                showToast('En az bir hafta bulunmalıdır', 'error');
                return;
            }

            if (confirm('Bu haftayı silmek istediğinizden emin misiniz?')) {
                weeks.splice(index, 1);
                saveWeeks();
                
                if (currentWeekIndex >= weeks.length) {
                    currentWeekIndex = weeks.length - 1;
                }
                if (activeWeekIndex >= weeks.length) {
                    activeWeekIndex = weeks.length - 1;
                }
                
                renderTabs();
                renderWeekContent();
                showToast('Hafta silindi');
            }
        }

        // Render Tabs
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            // Hafta tablarını ekle
            weeks.forEach((week, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === activeWeekIndex ? 'active' : ''}`;
                tab.innerHTML = `
                    <span onclick="switchWeek(${index})">${week.name}</span>
                    ${weeks.length > 1 ? `<button class="tab-close" onclick="event.stopPropagation(); removeWeek(${index})">&times;</button>` : ''}
                `;
                container.appendChild(tab);
            });
            
            // Yeni Hafta Ekle butonu - Son hafta tabından sonra
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-week';
            addBtn.onclick = addNewWeek; // ✅ Doğru fonksiyon adı
            addBtn.title = 'Yeni Hafta Ekle';
            addBtn.innerHTML = '➕';
            container.appendChild(addBtn);

            // Aktif tab'ı ortala
            setTimeout(() => {
                const activeTab = container.querySelector('.tab.active');
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 50);
        }

        // Switch Week
        function switchWeek(index) {
            currentWeekIndex = index;
            activeWeekIndex = index;
            renderTabs();
            renderWeekContent();
        }

        // Render Week Content
        function renderWeekContent() {
            const contentArea = document.getElementById('contentArea');
            const week = weeks[activeWeekIndex];
            
            // currentWeekIndex'i senkronize tut
            currentWeekIndex = activeWeekIndex;

            if (!week) {
                contentArea.innerHTML = '<div class="empty-state"><h3>Hafta bulunamadı</h3></div>';
                return;
            }

            // Calculate totals - güncel makro değerlerini kullan
            const totalCalories = week.days.reduce((sum, day) => {
                // totalMacros.kalori veya totalCalories'den al
                return sum + (day.totalMacros?.kalori || day.totalCalories || 0);
            }, 0);
            const avgCalories = week.days.length > 0 ? Math.round(totalCalories / week.days.length) : 0;
            
            // Hafta makroları için ortalama hesapla
            const avgProtein = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.protein || 0), 0) / week.days.length) : 0;
            const avgCarbs = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.karb || 0), 0) / week.days.length) : 0;
            const avgFat = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.yag || 0), 0) / week.days.length) : 0;

            let html = `
                <div class="week-macros">
                    <div class="macro-item">
                        <div class="label">Ort. Kalori</div>
                        <div class="value">${avgCalories}</div>
                    </div>
                    <div class="macro-item">
                        <div class="label">Ort. Protein</div>
                        <div class="value">${avgProtein}g</div>
                    </div>
                    <div class="macro-item">
                        <div class="label">Ort. Karb</div>
                        <div class="value">${avgCarbs}g</div>
                    </div>
                    <div class="macro-item">
                        <div class="label">Ort. Yağ</div>
                        <div class="value">${avgFat}g</div>
                    </div>
                </div>
            `;

            if (week.days.length === 0) {
                html += `
                    <div class="empty-state">
                        <h3>Henüz gün eklenmemiş</h3>
                        <p>Beslenme programınızı oluşturmaya başlamak için gün ekleyin</p>
                    </div>
                `;
            } else {
                html += '<div class="days-grid">';
                week.days.forEach((day, dayIndex) => {
                    html += renderDayCard(day, dayIndex);
                });
                html += '</div>';
            }

            html += `<button class="btn-add-day" onclick="openAddDayModal()">➕ Gün Ekle</button>`;

            contentArea.innerHTML = html;
            
            // 🔐 Admin özelliklerini güncelle (render sonrası)
            toggleAdminFeatures();
        }

        // Render Day Card
        function renderDayCard(day, dayIndex) {
            const macros = day.totalMacros || { kalori: 0, protein: 0, karb: 0, yag: 0 };
            
            // Öğünleri meals veya ogunler'den al
            const ogunler = day.meals || day.ogunler || [];
            
            let mealsHtml = '';
            if (ogunler && ogunler.length > 0) {
                ogunler.forEach((meal, ogunIndex) => {
                    // Öğün makrolarını hesapla
                    let ogunKalori = 0;
                    let ogunProtein = 0;
                    let ogunKarb = 0;
                    let ogunYag = 0;
                    
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach(food => {
                            ogunKalori += food.calories || food.kalori || 0;
                            ogunProtein += food.protein || 0;
                            ogunKarb += food.carbs || food.karb || 0;
                            ogunYag += food.fat || food.yag || 0;
                        });
                    }
                    
                    // Günlük kalori içindeki yüzde hesapla
                    const gunlukKalori = macros.kalori || 1;
                    const ogunYuzde = gunlukKalori > 0 ? Math.round((ogunKalori / gunlukKalori) * 100) : 0;
                    
                    // Öğün kartı - üst bant ile
                    mealsHtml += `
                        <div class="meal-item">
                            <div class="meal-item-header">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <span style="font-weight: 600;">${meal.ogunAdi}</span>
                                    <span style="font-size: 11px; opacity: 0.9;">
                                        ${Math.round(ogunKalori)} kcal 
                                        (P: ${Math.round(ogunProtein)}g, K: ${Math.round(ogunKarb)}g, Y: ${Math.round(ogunYag)}g) 
                                        • ${ogunYuzde}% günlük
                                    </span>
                                </div>
                            </div>
                            <div class="meal-item-content">
                                <table class="meal-table">
                                    <thead>
                                        <tr>
                                            <th>Yemek</th>
                                            <th>Kalori</th>
                                            <th>Karb</th>
                                            <th>Protein</th>
                                            <th>Yağ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Yemek satırları
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach((food, yemekIndex) => {
                            // JSON'dan gelen alanlar: calories, protein, carbs, fat
                            const kalori = food.calories || food.kalori || 0;
                            const protein = food.protein || 0;
                            const karb = food.carbs || food.karb || 0;
                            const yag = food.fat || food.yag || 0;
                            
                            // Tarif kartlarını bul
                            const tarifKartlari = findTarifKartlari(food.foodName || food.name || '');
                            let tarifBadgesHtml = '';
                            if (tarifKartlari.length > 0) {
                                tarifKartlari.forEach((tarif, index) => {
                                    const tarifLabel = tarifKartlari.length > 1 ? `Tarif ${index + 1}` : 'Tarif';
                                    tarifBadgesHtml += `<span class="tarif-badge" onclick="openPdfModal('${tarif.download_url}')" title="Tarif kartını görüntüle">📖 ${tarifLabel}</span> `;
                                });
                            }
                            
                            // Rozetleri oluştur (admin settings'den gelen görünürlük ayarlarına göre)
                            const foodBadgesHtml = generateFoodBadges(food);
                            
                            // 🔐 Admin ikonu (sadece admin kullanıcılar görebilir - yuvarlak ikonik buton)
                            const adminIconHtml = window.isUserAdmin() 
                                ? `<button class="btn-food-admin admin-only" onclick="openAdminFoodEditModal(${currentWeekIndex}, ${dayIndex}, ${ogunIndex}, ${yemekIndex})" title="Admin: Yemek eşleştirmelerini düzenle">
                                    ⚙️
                                  </button>` 
                                : '';
                            
                            mealsHtml += `
                                <tr>
                                    <td>
                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                                <span>${food.foodName || 'İsimsiz Yemek'}</span>
                                            </div>
                                            <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                                                ${foodBadgesHtml}
                                                ${tarifBadgesHtml}
                                                ${adminIconHtml}
                                                <button class="btn-refresh-food" onclick="refreshFoodInMeal(${currentWeekIndex}, ${dayIndex}, ${ogunIndex}, ${yemekIndex})" title="Alternatif yemek bul">
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${Math.round(kalori)}</td>
                                    <td>${Math.round(karb)}g</td>
                                    <td>${Math.round(protein)}g</td>
                                    <td>${Math.round(yag)}g</td>
                                </tr>
                            `;
                        });
                    } else {
                        mealsHtml += `
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">Yemek yok</td>
                            </tr>
                        `;
                    }
                    
                    mealsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }

            // 🔐 Şablon düzenleme butonu (sadece admin + templateId varsa) - İKONİK VERSİYON
            const templateEditBtn = (window.isUserAdmin() && day.templateId) 
                ? `<button class="btn-template-edit admin-only" onclick="openTemplateEditModal('${day.templateId}')" title="Admin: Bu şablonu düzenle">
                    ✏️
                  </button>` 
                : '';
            
            return `
                <div class="day-card">
                    <div class="day-header">
                        <div class="day-name">${day.gunAdi || 'Gün'}</div>
                        <div class="day-date">${formatDate(day.date)}</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${templateEditBtn}
                            <button class="btn-refresh-day" onclick="refreshDayTemplate(${dayIndex})" title="Farklı şablon ile değiştir"></button>
                            <button class="btn-delete-day" onclick="deleteDay(${dayIndex})" title="Bu günü sil">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="day-macros">
                        <div class="macro">
                            <div class="label">Kalori</div>
                            <div class="value">${macros.kalori}</div>
                        </div>
                        <div class="macro">
                            <div class="label">Protein</div>
                            <div class="value">${macros.protein}g</div>
                        </div>
                        <div class="macro">
                            <div class="label">Karb</div>
                            <div class="value">${macros.karb}g</div>
                        </div>
                        <div class="macro">
                            <div class="label">Yağ</div>
                            <div class="value">${macros.yag}g</div>
                        </div>
                    </div>
                    <div class="meals-list">
                        ${mealsHtml}
                    </div>
                </div>
            `;
        }

        // Open Add Day Modal
        function openAddDayModal() {
            // Önce hafta dolu mu kontrol et
            const currentWeek = weeks[currentWeekIndex];
            
            // Eğer haftada 7 gün varsa yeni hafta aç
            if (currentWeek.days.length >= 7) {
                // Yeni hafta bilgilerini hesapla
                const nextWeekNumber = weeks.length + 1;
                const lastWeek = weeks[weeks.length - 1];
                let nextStartDate = new Date();
                
                if (lastWeek && lastWeek.startDate) {
                    nextStartDate = new Date(lastWeek.startDate);
                    nextStartDate.setDate(nextStartDate.getDate() + 7);
                }
                
                // Bitiş tarihini hesapla (başlangıç + 6 gün)
                const nextEndDate = new Date(nextStartDate);
                nextEndDate.setDate(nextEndDate.getDate() + 6);
                
                // Tarih formatla (3-9 Kasım 2025)
                const startDay = nextStartDate.getDate();
                const endDay = nextEndDate.getDate();
                const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                                   'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                const month = monthNames[nextStartDate.getMonth()];
                const year = nextStartDate.getFullYear();
                
                const dateRange = `${startDay}-${endDay} ${month} ${year}`;
                const message = `Bu haftanın günleri tamamlanmış (7 gün). Yeni bir hafta (${nextWeekNumber}. hafta - ${dateRange}) oluşturmak ister misiniz?`;
                
                const confirmNewWeek = confirm(message);
                if (confirmNewWeek) {
                    addNewWeek();
                    // Yeni hafta oluşturulduktan sonra modal'ı aç
                    setTimeout(() => {
                        openAddDayModalAfterWeekCheck();
                    }, 100);
                    return;
                } else {
                    return; // İptal edildi
                }
            }
            
            openAddDayModalAfterWeekCheck();
        }

        // Hafta kontrolü sonrası modal açma
        function openAddDayModalAfterWeekCheck() {
            const modal = document.getElementById('addDayModal');
            modal.classList.add('active');
            
            // Seçimleri sıfırla
            selectedTemplates = [];
            
            // Akıllı filtreleri sıfırla
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            if (wantedInput) wantedInput.value = '';
            if (unwantedInput) unwantedInput.value = '';

            // Load filtered templates
            loadDayTemplates();
        }

        // Open Auto Week Plan Modal
        function openAutoWeekPlanModal() {
            // Hasta bilgilerini FORM inputlarından al (settings modal'daki veriler)
            const weightInput = document.getElementById('patientWeight');
            const heightInput = document.getElementById('patientHeight');
            const activityInput = document.getElementById('activityLevel');
            const dietTypeInput = document.getElementById('dietType');
            const dislikedFoodsInput = document.getElementById('dislikedFoods');
            
            // Hasta kayıt bilgilerinden de al
            const personalInfo = patientData?.personalInfo || {};
            
            // Modal'a doldur (öncelik: form input > personalInfo > varsayılan)
            document.getElementById('autoPlanWeight').value = weightInput?.value || personalInfo.weight || 70;
            document.getElementById('autoPlanHeight').value = heightInput?.value || personalInfo.height || 170;
            document.getElementById('autoPlanActivity').value = activityInput?.value || personalInfo.activityLevel || settings.activityLevel || '3';
            document.getElementById('autoPlanDietType').value = dietTypeInput?.value || settings.dietType || 'ketojenik';
            document.getElementById('autoPlanDislikedFoods').value = dislikedFoodsInput?.value || (settings.dislikedFoods || []).join(', ');
            
            // Hedef kaloriyi hesapla ve göster
            updateAutoPlanCalories();
            
            // Modal'ı aç
            document.getElementById('autoWeekPlanModal').classList.add('active');
        }

        // Hedef kaloriyi hesapla ve göster
        function updateAutoPlanCalories() {
            const weight = parseFloat(document.getElementById('autoPlanWeight').value) || 70;
            const height = parseFloat(document.getElementById('autoPlanHeight').value) || 170;
            const activity = parseInt(document.getElementById('autoPlanActivity').value) || 3;
            const dietType = document.getElementById('autoPlanDietType').value || 'ketojenik';
            
            console.log('📊 Kalori Hesaplama:', { weight, height, activity, dietType });
            
            // Admin settings'teki formülü kullan
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activity] || 1.0;
            const dietFormula = appSettings?.dietFormulas?.[dietType] || appSettings?.dietFormulas?.ketojenik;
            
            console.log('⚙️ Formül:', { activityMultiplier, dietFormula });
            
            if (dietFormula) {
                // Aktivite çarpanını da dahil et
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                
                // Kalori hesaplama: (P*4) + (K*4) + (Y*9)
                const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
                
                console.log('🎯 Hedef Kalori:', targetCalories);
                
                document.getElementById('autoPlanTargetCalories').textContent = targetCalories + ' kcal';
            } else {
                // Fallback basit hesaplama
                const targetCalories = Math.round(weight * 22 * activityMultiplier);
                document.getElementById('autoPlanTargetCalories').textContent = targetCalories + ' kcal';
            }
        }

        // Otomatik haftalık plan oluştur
        async function generateAutoWeekPlan() {
            const weight = parseFloat(document.getElementById('autoPlanWeight').value);
            const height = parseFloat(document.getElementById('autoPlanHeight').value);
            const activity = parseInt(document.getElementById('autoPlanActivity').value);
            const dietType = document.getElementById('autoPlanDietType').value;
            const dislikedFoods = document.getElementById('autoPlanDislikedFoods').value
                .split(',')
                .map(f => f.trim())
                .filter(f => f.length > 0);
            
            // Hedef kaloriyi admin settings formülüyle hesapla
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activity] || 1.0;
            const dietFormula = appSettings?.dietFormulas?.[dietType] || appSettings?.dietFormulas?.ketojenik;
            
            let targetCalories;
            if (dietFormula) {
                // Aktivite çarpanını da dahil et
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            } else {
                targetCalories = Math.round(weight * 22 * activityMultiplier);
            }
            
            console.log('🎯 Hedef Kalori:', targetCalories);
            console.log('📊 Toplam Şablon:', dayTemplates.length);
            
            // 🔍 Mevcut haftada manuel eklenmiş günleri kontrol et
            const currentWeek = weeks[currentWeekIndex];
            const existingDays = currentWeek.days || [];
            
            if (existingDays.length > 0) {
                // Manuel günler var - kullanıcıya sor
                const lastDay = existingDays[existingDays.length - 1];
                const lastDate = new Date(lastDay.date);
                const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                const lastDayName = dayNames[lastDate.getDay()];
                
                const confirmMessage = `📅 Bu haftada ${existingDays.length} gün manuel eklenmiş (Son: ${lastDayName}).\n\n` +
                    `🔄 Tüm haftayı yeniden planlayayım mı?\n` +
                    `   (Mevcut günler silinir, 7 günlük yeni plan oluşturulur)\n\n` +
                    `✅ Sadece eksik günleri tamamlayayım mı?\n` +
                    `   (${lastDayName} sonrası Pazar'a kadar olan günler eklenir)\n\n` +
                    `"OK" = Yeniden Planla | "İptal" = Eksik Günleri Tamamla`;
                
                const shouldReset = confirm(confirmMessage);
                
                if (shouldReset) {
                    // Yeniden planlama - mevcut günleri temizle
                    console.log('🔄 Hafta yeniden planlanıyor - mevcut günler temizleniyor...');
                    currentWeek.days = [];
                } else {
                    // Eksik günleri tamamlama
                    console.log('✅ Eksik günler tamamlanıyor...');
                }
            }
            
            // Son N haftada kullanılan şablonları topla (N = admin ayarlarından)
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            // Mevcut hafta dahil, son N haftayı kontrol et
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(day => {
                        if (day.templateId) {
                            recentlyUsedTemplateIds.add(day.templateId);
                        }
                    });
                }
            }
            
            console.log(`📅 Son ${templateReuseWeeks} haftada kullanılan şablon sayısı: ${recentlyUsedTemplateIds.size}`);
            
            // Şablonları filtrele
            const dietTypeFilter = dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : dietType;
            
            let availableTemplates = dayTemplates.filter(template => {
                // Son N haftada kullanılmış mı?
                if (recentlyUsedTemplateIds.has(template.id)) {
                    return false;
                }
                
                // Diyet tipi kontrolü - template.dietType undefined olabilir
                if (template.dietType && template.dietType !== dietTypeFilter) {
                    return false;
                }
                
                // İstenmeyen yemekler - sadece varsa kontrol et
                if (dislikedFoods.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => {
                            const foodName = yemek.foodName || yemek.originalText || '';
                            return dislikedFoods.some(disliked => 
                                foodName.toLowerCase().includes(disliked.toLowerCase())
                            );
                        })
                    );
                    if (hasDislikedFood) return false;
                }
                
                return true;
            });
            
            console.log(`✅ Filtrelenmiş Şablon (Son ${templateReuseWeeks} hafta hariç):`, availableTemplates.length);
            
            // Eğer kullanılabilir şablon kalmadıysa, tüm şablonları kullan (başa dön)
            if (availableTemplates.length === 0) {
                console.log('⚠️ Kullanılmamış şablon kalmadı, tüm şablonları kullanıma açıyoruz...');
                
                availableTemplates = dayTemplates.filter(template => {
                    // Sadece diyet tipi ve istenmeyen yemek kontrolü
                    if (template.dietType && template.dietType !== dietTypeFilter) {
                        return false;
                    }
                    
                    if (dislikedFoods.length > 0 && template.ogunler) {
                        const hasDislikedFood = template.ogunler.some(ogun => 
                            ogun.yemekler && ogun.yemekler.some(yemek => {
                                const foodName = yemek.foodName || yemek.originalText || '';
                                return dislikedFoods.some(disliked => 
                                    foodName.toLowerCase().includes(disliked.toLowerCase())
                                );
                            })
                        );
                        if (hasDislikedFood) return false;
                    }
                    
                    return true;
                });
                
                console.log('✅ Tüm uygun şablonlar:', availableTemplates.length);
                
                if (availableTemplates.length === 0) {
                    showToast('⚠️ Uygun menü bulunamadı. İstenmeyen yemekleri azaltmayı deneyin.', 'error');
                    return;
                }
            }
            
            // Hedef kaloriye göre mutlak değer farkıyla sırala (GÜNCEL hedef kaloriye göre)
            availableTemplates.sort((a, b) => {
                const diffA = Math.abs((a.totalMacros?.kalori || 0) - targetCalories);
                const diffB = Math.abs((b.totalMacros?.kalori || 0) - targetCalories);
                return diffA - diffB;
            });
            
            // Başlangıç tarihini belirle
            let startDate = new Date();
            
            if (existingDays.length > 0) {
                // Mevcut günler var - son günden sonraki günü başlat
                const lastDay = existingDays[existingDays.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
            } else if (currentWeek.startDate) {
                // Haftanın başlangıç tarihinden başla
                startDate = new Date(currentWeek.startDate);
            }
            
            console.log('📅 Başlangıç Tarihi:', startDate.toLocaleDateString('tr-TR'));
            console.log('📅 Gün:', ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][startDate.getDay()]);
            console.log('📊 Mevcut haftada gün sayısı:', existingDays.length);
            
            // Gün sayısı hesaplama
            const currentDayOfWeek = startDate.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
            
            let totalDays;
            if (existingDays.length === 0) {
                // Hafta boş - ilk hafta kuralı
                if (currentDayOfWeek === 1) {
                    // Pazartesi - tam hafta
                    totalDays = 7;
                    console.log('✅ Pazartesi başlangıcı - 7 gün eklenecek');
                } else {
                    // Diğer günler - o haftanın kalanı + tam hafta
                    const daysUntilMonday = currentDayOfWeek === 0 ? 1 : (8 - currentDayOfWeek);
                    totalDays = daysUntilMonday + 7;
                    console.log(`✅ ${['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][currentDayOfWeek]} başlangıcı - ${daysUntilMonday} + 7 = ${totalDays} gün eklenecek`);
                }
            } else {
                // Mevcut günler var - kullanıcı "eksik günleri tamamla" seçmiş
                // Son günden Pazar'a kadar olan günleri ekle
                const lastDayOfWeek = (startDate.getDay() + 6) % 7; // Cumartesi için 6
                if (currentDayOfWeek === 0) {
                    // Pazar'dayız, hafta tamamlandı
                    totalDays = 0;
                    console.log('✅ Hafta zaten tamamlanmış (Pazar)');
                } else {
                    // Pazar'a kadar kalan günler
                    totalDays = 7 - currentDayOfWeek;
                    console.log(`✅ Eksik günler tamamlanıyor - ${totalDays} gün eklenecek (${['', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][currentDayOfWeek]} → Pazar)`);
                }
            }
            
            console.log('📊 Eklenecek Gün Sayısı:', totalDays);
            
            if (totalDays === 0) {
                showToast('✅ Hafta zaten tamamlanmış!', 'success');
                return;
            }
            
            // Günleri oluştur
            const gunAdlari = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            const newDays = [];
            for (let i = 0; i < totalDays && i < availableTemplates.length; i++) {
                const template = availableTemplates[i];
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + i);
                
                // Şablon verilerini tam olarak kopyala
                const dayData = {
                    date: dayDate.toISOString().split('T')[0],
                    gunAdi: gunAdlari[dayDate.getDay()],
                    templateId: template.id,
                    templateName: template.name,
                    meals: template.ogunler ? JSON.parse(JSON.stringify(template.ogunler)) : [],
                    totalMacros: template.totalMacros ? JSON.parse(JSON.stringify(template.totalMacros)) : {
                        kalori: 0,
                        protein: 0,
                        karb: 0,
                        yag: 0
                    }
                };
                
                console.log(`📝 Gün ${i+1}:`, dayDate.toLocaleDateString('tr-TR'), '-', dayData.gunAdi, '-', template.name, '-', template.totalMacros?.kalori, 'kcal');
                
                newDays.push(dayData);
            }
            
            // Mevcut haftaya ekle
            currentWeek.days.push(...newDays);
            
            // Modal'ları kapat
            closeModal('autoWeekPlanModal');
            closeModal('addDayModal');
            
            // Sayfayı yenile
            renderWeekContent();
            
            // Verileri kaydet
            saveWeeks();
            
            // Bildirim göster
            showToast(`✨ ${newDays.length} günlük otomatik plan oluşturuldu! Hedef: ${targetCalories} kcal`, 'success');
        }

        // Global variables for sorting
        let currentSortField = null;
        let currentSortDirection = null;
        let filteredTemplates = [];

        // Load Day Templates with Filters
        function loadDayTemplates() {
            const tableContainer = document.getElementById('dayTemplateTable');
            tableContainer.innerHTML = '<div style="padding: 20px; text-align: center;">Şablonlar yükleniyor...</div>';

            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }

            // Filter templates based on settings
            filteredTemplates = dayTemplates.filter(template => {
                // Diet type filter (eliminasyonlu-ketojenik ve ketojenik aynı kabul edilir)
                const currentDietType = document.getElementById('dietType')?.value || settings.dietType;
                if (currentDietType && template.dietType) {
                    const settingsDiet = currentDietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : currentDietType;
                    if (template.dietType !== settingsDiet) {
                        return false;
                    }
                }

                // Calorie filter - GÜNCEL min ve max değerlerini kullan
                const calories = template.totalMacros?.kalori || 0;
                
                // Input'lardan güncel değerleri al
                const minCaloriesInput = parseInt(document.getElementById('minCalories')?.value) || 0;
                const maxCaloriesInput = parseInt(document.getElementById('maxCalories')?.value) || 9999;
                
                if (minCaloriesInput > 0 && calories < minCaloriesInput) {
                    return false;
                }
                
                if (maxCaloriesInput > 0 && maxCaloriesInput < 9999 && calories > maxCaloriesInput) {
                    return false;
                }

                // Disliked foods filter
                const dislikedFoodsValue = document.getElementById('dislikedFoods')?.value || '';
                const dislikedFoodsList = dislikedFoodsValue
                    .split(',')
                    .map(f => f.trim().toLowerCase())
                    .filter(f => f);
                    
                if (dislikedFoodsList.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => 
                            dislikedFoodsList.some(disliked => 
                                yemek.foodName.toLowerCase().includes(disliked)
                            )
                        )
                    );
                    if (hasDislikedFood) return false;
                }

                return true;
            });

            if (filteredTemplates.length === 0) {
                tableContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Filtrelerinize uygun şablon bulunamadı</div>';
                return;
            }
            
            // Hesaplanan tolerans ve hedef kaloriyi kullanarak filtre bilgisini güncelle
            const inputMin = parseInt(document.getElementById('minCalories')?.value) || 0;
            const inputMax = parseInt(document.getElementById('maxCalories')?.value) || 0;

            // Tolerans: hasta ayarı varsa onu kullan, yoksa input veya admin default
            let tolerancePercent = parseInt(document.getElementById('calorieTolerancePercent')?.value);
            if (!tolerancePercent || isNaN(tolerancePercent)) {
                tolerancePercent = (patientData && patientData.settings && patientData.settings.calorieTolerancePercent) || appSettings?.calorieTolerancePercent || 5;
            }

            // Hedef kaloriyi belirle: input varsa kullan, yoksa hasta bilgileri ve formül üzerinden hesapla
            let targetCalories = parseInt(document.getElementById('targetCalories')?.value) || 0;
            if (!targetCalories || targetCalories === 0) {
                const weight = parseFloat((patientData && patientData.personalInfo && patientData.personalInfo.weight) || document.getElementById('patientWeight')?.value) || 70;
                const activityLevel = parseInt((patientData && patientData.personalInfo && patientData.personalInfo.activityLevel) || document.getElementById('activityLevel')?.value) || 3;
                const dietType = document.getElementById('dietType')?.value || (settings && settings.dietType) || 'ketojenik';
                const dietFormula = (appSettings && appSettings.dietFormulas && appSettings.dietFormulas[dietType]) || (appSettings && appSettings.dietFormulas && appSettings.dietFormulas['ketojenik']) || { protein: 0.8, carb: 0.3, fat: 1.2 };
                const activityMultiplier = (appSettings && appSettings.dietFormulas && appSettings.dietFormulas.activityMultipliers && appSettings.dietFormulas.activityMultipliers[activityLevel]) || 1.0;
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            }

            const tol = (tolerancePercent || 5) / 100;
            const computedMin = Math.round(targetCalories * (1 - tol));
            const computedMax = Math.round(targetCalories * (1 + tol));

            const minCal = inputMin > 0 ? inputMin : computedMin;
            const maxCal = inputMax > 0 ? inputMax : computedMax;

            // Güncelleme: filtre istatistiklerini kullanıcıya göster
            const statsEl = document.getElementById('filterStats');
            if (statsEl) {
                statsEl.textContent = `${filteredTemplates.length}/${dayTemplates.length} (Kalori Toleransı (%${tolerancePercent}))`;
            }

            // Render table
            renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Render template table
        function renderTemplateTable(templates, usedTemplateIds) {
            const tableContainer = document.getElementById('dayTemplateTable');
            const isAdmin = window.isUserAdmin();
            
            // Sıralama ok işaretlerini belirle
            const getSortIcon = (field) => {
                if (currentSortField === field) {
                    return currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc';
                }
                return 'sortable';
            };
            
            let tableHTML = `
                <table class="template-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Menüler</th>
                            <th style="width: 45%;">Öğünler</th>
                            <th style="width: 10%;" class="${getSortIcon('calories')}" onclick="toggleSort('calories')">Kalori</th>
                            <th style="width: 10%;" class="${getSortIcon('karb')}" onclick="toggleSort('karb')">Karb (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('protein')}" onclick="toggleSort('protein')">Protein (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('yag')}" onclick="toggleSort('yag')">Yağ (g)</th>
                            ${isAdmin ? '<th style="width: 8%;">İşlem</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            templates.forEach((template, index) => {
                const macros = template.totalMacros || {};
                const isUsed = usedTemplateIds.has(template.id);
                const isSelected = selectedTemplates.some(st => st.templateId === template.id);
                
                // Yemek listesini oluştur (öğünlere göre)
                let mealsHTML = '';
                if (template.ogunler && template.ogunler.length > 0) {
                    const mealsList = template.ogunler.map((ogun, ogunIndex) => {
                        const foodNames = ogun.yemekler ? ogun.yemekler.map(y => y.foodName || y.originalText || '?').join(', ') : '';
                        // Öğün adını al (ogunAdi veya mealName)
                        let mealDisplayName = ogun.ogunAdi || ogun.mealName || 'Öğün';
                        
                        // İlk harfi büyük yap
                        mealDisplayName = mealDisplayName.charAt(0).toUpperCase() + mealDisplayName.slice(1);
                        
                        return `<strong>${mealDisplayName}:</strong> ${foodNames}`;
                    }).join('<br>');
                    mealsHTML = mealsList;
                }
                
                // Row classes
                let rowClass = '';
                if (isSelected) rowClass += ' selected';
                if (isUsed) rowClass += ' used-template';
                
                // Admin düzenle butonu
                const adminActionBtn = isAdmin ? `
                    <td style="text-align: center;">
                        <button class="btn-admin-edit" onclick="event.stopPropagation(); openTemplateEditModal('${template.id}')" title="Şablonu Düzenle">
                            ✏️
                        </button>
                    </td>
                ` : '';
                
                tableHTML += `
                    <tr class="${rowClass}" data-template-id="${template.id}" onclick="selectTemplate('${template.id}')" style="cursor: pointer;">
                        <td>${template.name || `Şablon ${index + 1}`}</td>
                        <td class="meal-cell">${mealsHTML || 'Yemek bilgisi yok'}</td>
                        <td style="text-align: center;">${Math.round(macros.kalori || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.karb || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.protein || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.yag || 0)}</td>
                        ${adminActionBtn}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            
            // Total count'u güncelle
            const totalElement = document.getElementById('totalCount');
            if (totalElement) {
                totalElement.textContent = templates.length;
            }
            
            // Akıllı filtreyi uygula (varsa)
            applySmartFilter();
        }

        // Akıllı filtreleme fonksiyonu
        function applySmartFilter() {
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            
            if (!wantedInput || !unwantedInput) return;
            
            const wantedText = wantedInput.value.trim().toLowerCase();
            const unwantedText = unwantedInput.value.trim().toLowerCase();
            
            // Virgülle ayrılmış kelimeleri al
            const wantedKeywords = wantedText ? wantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            const unwantedKeywords = unwantedText ? unwantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            
            const rows = document.querySelectorAll('.template-table tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const mealCell = row.querySelector('.meal-cell');
                if (!mealCell) return;
                
                const mealText = mealCell.textContent.toLowerCase();
                let shouldShow = true;
                
                // Pozitif filtreleme: TÜM istenen kelimeleri içermeli
                if (wantedKeywords.length > 0) {
                    const hasAllKeywords = wantedKeywords.every(keyword => mealText.includes(keyword));
                    if (!hasAllKeywords) {
                        shouldShow = false;
                    }
                }
                
                // Negatif filtreleme: HİÇBİR istenmeyen kelimeyi içermemeli
                if (shouldShow && unwantedKeywords.length > 0) {
                    const hasAnyUnwanted = unwantedKeywords.some(keyword => mealText.includes(keyword));
                    if (hasAnyUnwanted) {
                        shouldShow = false;
                    }
                }
                
                // Satırı göster/gizle
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // İstatistiği güncelle
            const statsElement = document.getElementById('visibleCount');
            const totalElement = document.getElementById('totalCount');
            if (statsElement) {
                statsElement.textContent = visibleCount;
            }
            if (totalElement) {
                totalElement.textContent = rows.length;
            }
        }

        // Toggle sort - başlığa tıklandığında sıralama yönünü değiştir
        function toggleSort(field) {
            // Aynı alana tekrar tıklanırsa yönü değiştir, farklı alana tıklanırsa artan sıralama yap
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            sortTemplates(field, currentSortDirection);
        }

        // Sort templates
        function sortTemplates(field, direction) {
            currentSortField = field;
            currentSortDirection = direction;
            
            const sortedTemplates = [...filteredTemplates].sort((a, b) => {
                let aValue, bValue;
                
                switch(field) {
                    case 'calories':
                        aValue = a.totalMacros?.kalori || 0;
                        bValue = b.totalMacros?.kalori || 0;
                        break;
                    case 'karb':
                        aValue = a.totalMacros?.karb || 0;
                        bValue = b.totalMacros?.karb || 0;
                        break;
                    case 'protein':
                        aValue = a.totalMacros?.protein || 0;
                        bValue = b.totalMacros?.protein || 0;
                        break;
                    case 'yag':
                        aValue = a.totalMacros?.yag || 0;
                        bValue = b.totalMacros?.yag || 0;
                        break;
                }
                
                if (direction === 'asc') {
                    return aValue - bValue;
                } else {
                    return bValue - aValue;
                }
            });
            
            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(sortedTemplates, usedTemplateIds);
        }

        // Reset sorting
        function resetTemplates() {
            currentSortField = null;
            currentSortDirection = null;
            
            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Multiple template selection
        let selectedTemplates = []; // Array of {templateId, order}

        function selectTemplate(templateId) {
            const template = dayTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            // Zaten seçili mi kontrol et
            const existingIndex = selectedTemplates.findIndex(st => st.templateId === templateId);
            
            if (existingIndex !== -1) {
                // Seçimi kaldır
                selectedTemplates.splice(existingIndex, 1);
            } else {
                // Seçime ekle
                selectedTemplates.push({
                    templateId: templateId,
                    template: template,
                    order: selectedTemplates.length + 1
                });
            }
            
            // UI'yi güncelle
            updateTemplateSelectionUI();
        }

        function updateTemplateSelectionUI() {
            // Tablo satırlarını güncelle
            const rows = document.querySelectorAll('.template-table tbody tr');
            rows.forEach(row => {
                const templateId = row.getAttribute('data-template-id');
                const isSelected = selectedTemplates.some(st => st.templateId === templateId);
                
                if (isSelected) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
            
            // Kaydet butonunu göster/gizle
            const saveBtn = document.getElementById('saveMultipleDaysBtn');
            if (selectedTemplates.length > 0) {
                saveBtn.style.display = 'block';
                saveBtn.textContent = `${selectedTemplates.length} Günü Kaydet`;
            } else {
                saveBtn.style.display = 'none';
            }
        }

        function updateSelectedTemplatesBand() {
            // Bu fonksiyon artık kullanılmıyor ama uyumluluk için boş bırakılıyor
        }

        function removeSelectedTemplate(index) {
            selectedTemplates.splice(index, 1);
            updateTemplateSelectionUI();
        }

        // Old single selection function - kept for compatibility
        let selectedTemplateId = null;

        function selectTemplateSingle(templateId) {
            selectedTemplateId = templateId;
            
            // Update UI
            const items = document.querySelectorAll('.template-item');
            items.forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // Save Day to Week
        function saveDayToWeek() {
            if (!selectedTemplateId) {
                showToast('Lütfen bir şablon seçin', 'error');
                return;
            }

            const dayName = document.getElementById('daySelect').value;
            const dayDate = document.getElementById('dayDate').value;
            const template = dayTemplates.find(t => t.id === selectedTemplateId);

            if (!template) {
                showToast('Şablon bulunamadı', 'error');
                return;
            }

            // Kullanıcının seçtiği gün adını kullan (şablonun gün adını değil)
            const newDay = {
                id: Date.now(),
                gunAdi: dayName,  // Kullanıcının seçtiği gün
                date: dayDate,
                templateId: template.id,
                templateName: template.name,
                totalCalories: template.totalCalories || 0,
                totalMacros: template.totalMacros || {},
                ogunler: template.ogunler || []
            };

            // Pazartesi günü eklendiyse ÖNCE yeni hafta kontrolü yap
            const shouldCreateNewWeek = checkShouldCreateNewWeek(dayName);
            
            if (shouldCreateNewWeek) {
                // Yeni hafta oluştur ve Pazartesi'yi oraya ekle
                const created = promptNewWeekCreation();
                if (created) {
                    // Yeni haftaya ekle
                    weeks[activeWeekIndex].days.push(newDay);
                    saveWeeks();
                    renderWeekContent();
                    closeModal('addDayModal');
                    showToast('Gün yeni haftaya eklendi');
                    return;
                }
            }

            // Normal akış - mevcut haftaya ekle
            weeks[activeWeekIndex].days.push(newDay);
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast('Gün eklendi');
        }

        // Save Multiple Days to Week
        function saveMultipleDaysToWeek() {
            if (selectedTemplates.length === 0) {
                showToast('Lütfen en az bir şablon seçin', 'error');
                return;
            }

            const currentWeek = weeks[currentWeekIndex];
            let startDate = new Date();
            
            // Başlangıç tarihini belirle
            if (currentWeek.days.length > 0) {
                const lastDay = currentWeek.days[currentWeek.days.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
            } else if (currentWeek.startDate) {
                startDate = new Date(currentWeek.startDate);
            }

            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            let addedCount = 0;
            let currentWeekForAdding = currentWeekIndex;
            
            // Seçilen şablonları sırayla ekle
            for (let i = 0; i < selectedTemplates.length; i++) {
                const st = selectedTemplates[i];
                const template = st.template;
                
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayName = dayNames[date.getDay()];
                const dateStr = date.toISOString().split('T')[0];
                
                const newDay = {
                    id: Date.now() + i,
                    gunAdi: dayName,
                    date: dateStr,
                    templateId: template.id,
                    templateName: template.name,
                    totalCalories: template.totalCalories || 0,
                    totalMacros: template.totalMacros || {},
                    ogunler: template.ogunler || []
                };
                
                // Pazartesi günü mü ve yeni hafta gerekli mi kontrol et
                if (dayName === 'Pazartesi' && i > 0) {
                    const shouldCreateNewWeek = checkShouldCreateNewWeekForDate(currentWeekForAdding);
                    
                    if (shouldCreateNewWeek) {
                        // Yeni hafta oluştur (sessizce, confirm sorma)
                        const newWeekCreated = createNewWeekSilently(date);
                        if (newWeekCreated) {
                            currentWeekForAdding = weeks.length - 1;
                        }
                    }
                }
                
                weeks[currentWeekForAdding].days.push(newDay);
                addedCount++;
            }
            
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast(`${addedCount} gün başarıyla eklendi`);
            
            // Seçimleri temizle
            selectedTemplates = [];
        }

        // Check if new week should be created for specific week index
        function checkShouldCreateNewWeekForDate(weekIndex) {
            const targetWeek = weeks[weekIndex];
            
            // İlk hafta mı?
            if (weekIndex === 0) {
                const firstMondayIndex = targetWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                if (firstMondayIndex === -1) return false;
                
                const daysAfterFirstMonday = targetWeek.days.length - firstMondayIndex;
                if (daysAfterFirstMonday < 7) return false;
                
                return true;
            }
            
            return true;
        }

        // Create new week silently (without confirm)
        function createNewWeekSilently(startDate) {
            const weekNumber = weeks.length + 1;
            
            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            return true;
        }

        // Refresh Day Template - Kullanılmamış şablonlardan en yakın kalorili olanı seç
        function refreshDayTemplate(dayIndex) {
            const currentWeek = weeks[currentWeekIndex];
            const day = currentWeek.days[dayIndex];
            
            if (!day) {
                showToast('Gün bulunamadı', 'error');
                return;
            }
            
            // Hasta verilerinden bilgileri çek (patientData.settings'den)
            const weight = patientData?.personalInfo?.weight || 70;
            const activityLevel = patientData?.personalInfo?.activity || 3;
            const dietType = patientData?.settings?.dietType || 'ketojenik';
            
            // Admin ayarlarından formül al
            const dietFormula = appSettings?.dietFormulas?.[dietType] || { protein: 0.8, carb: 0.3, fat: 1.2 };
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activityLevel] || 1.0;
            
            const protein = weight * dietFormula.protein * activityMultiplier;
            const carb = weight * dietFormula.carb * activityMultiplier;
            const fat = weight * dietFormula.fat * activityMultiplier;
            const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            
            // Son N haftada kullanılan şablonları topla
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(d => {
                        if (d.templateId) {
                            recentlyUsedTemplateIds.add(d.templateId);
                        }
                    });
                }
            }
            
            // Kullanılmamış şablonları filtrele
            let unusedTemplates = dayTemplates.filter(t => {
                // Son N haftada kullanılmış mı?
                if (recentlyUsedTemplateIds.has(t.id)) {
                    return false;
                }
                // Diyet tipi uygun mu?
                if (t.dietType && t.dietType !== dietType) {
                    return false;
                }
                return true;
            });
            
            // Eğer kullanılmamış şablon kalmadıysa, tüm şablonları kullan (başa dön)
            if (unusedTemplates.length === 0) {
                console.log('⚠️ Refresh için kullanılmamış şablon kalmadı, tüm şablonları kullanıma açıyoruz...');
                
                unusedTemplates = dayTemplates.filter(t => {
                    // Sadece diyet tipi kontrolü
                    if (t.dietType && t.dietType !== dietType) {
                        return false;
                    }
                    return true;
                });
                
                if (unusedTemplates.length === 0) {
                    showToast('Diyet tipine uygun şablon bulunamadı', 'error');
                    return;
                }
            }
            
            // GÜNCEL hedef kaloriye göre MUTLAK FARK ARTACAK ŞEKİLDE sırala
            // Yön önemli değil (+ veya -), sadece mutlak farkın büyüklüğü önemli
            // Örnek: 980 (fark:20), 970 (fark:30), 1040 (fark:40), 950 (fark:50)...
            unusedTemplates.sort((a, b) => {
                const diffA = Math.abs((a.totalMacros?.kalori || 0) - targetCalories);
                const diffB = Math.abs((b.totalMacros?.kalori || 0) - targetCalories);
                return diffA - diffB; // En yakından en uzağa (mutlak fark)
            });
            
            console.log(`📊 Kalori mutlak fark sıralaması (Hedef: ${targetCalories} kcal):`,
                unusedTemplates.slice(0, 10).map((t, i) => {
                    const diff = (t.totalMacros?.kalori || 0) - targetCalories;
                    const absDiff = Math.abs(diff);
                    return `${i + 1}. ${t.name}: ${t.totalMacros?.kalori} kcal (${diff >= 0 ? '+' : ''}${diff} kcal, mutlak: ${absDiff})`;
                })
            );
            
            // Mevcut şablonun alternatifler listesindeki index'ini bul
            if (!day.refreshIndex) {
                day.refreshIndex = 0; // İlk tıklama
            }
            
            // 10 alternatif döngüsü (sırayla geç)
            const totalAlternatives = Math.min(10, unusedTemplates.length);
            day.refreshIndex = (day.refreshIndex + 1) % totalAlternatives;
            
            // Döngüsel seçim (10'dan fazla şablon varsa tekrar başa dön)
            const templateIndex = day.refreshIndex % unusedTemplates.length;
            const newTemplate = unusedTemplates[templateIndex];
            
            const calorieDiff = Math.abs((newTemplate.totalMacros?.kalori || 0) - targetCalories);
            console.log(`🔄 Refresh (${day.refreshIndex + 1}/10): Hedef ${targetCalories} kcal, Seçilen: ${newTemplate.name} (${newTemplate.totalMacros?.kalori} kcal, Fark: ${calorieDiff} kcal)`);
            
            // Günü güncelle
            day.templateId = newTemplate.id;
            day.templateName = newTemplate.name;
            day.meals = newTemplate.ogunler ? JSON.parse(JSON.stringify(newTemplate.ogunler)) : [];
            day.ogunler = day.meals; // Geriye dönük uyumluluk
            day.totalMacros = newTemplate.totalMacros ? JSON.parse(JSON.stringify(newTemplate.totalMacros)) : {
                kalori: 0,
                protein: 0,
                karb: 0,
                yag: 0
            };
            
            // Kaydet ve göster
            saveWeeks();
            renderWeekContent();
            showToast(`${day.gunAdi}: ${newTemplate.name} (${day.refreshIndex + 1}/10)`, 'success');
            
            console.log(`🔄 ${day.gunAdi} güncellendi: ${newTemplate.name} (${newTemplate.totalMacros?.kalori} kcal)`);
        }

        // Delete Day - Günü sil
        async function deleteDay(dayIndex) {
            const currentWeek = weeks[currentWeekIndex];
            const day = currentWeek.days[dayIndex];
            
            if (!day) {
                showToast('Gün bulunamadı', 'error');
                return;
            }
            
            // Onay iste
            const confirmDelete = confirm(`"${day.gunAdi}" gününü silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`);
            
            if (!confirmDelete) {
                console.log('❌ Silme işlemi iptal edildi');
                return;
            }
            
            // Günü sil
            currentWeek.days.splice(dayIndex, 1);
            
            console.log(`🗑️ ${day.gunAdi} silindi`);
            
            // Kaydet ve göster
            await saveWeeks();
            renderWeekContent();
            showToast(`${day.gunAdi} günü silindi`, 'success');
        }

        // Check Should Create New Week
        function checkShouldCreateNewWeek(dayName) {
            // Pazartesi günü mü?
            if (dayName !== 'Pazartesi') return false;
            
            const currentWeek = weeks[currentWeekIndex];
            
            // İlk hafta mı?
            if (currentWeekIndex === 0) {
                // İlk haftada: İlk Pazartesi'den sonra 7 gün (Pazartesi-Pazar) tamamlanmış mı kontrol et
                
                // İlk Pazartesi'nin index'ini bul
                const firstMondayIndex = currentWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                
                if (firstMondayIndex === -1) {
                    // Henüz hiç Pazartesi yok (bu eklenen ilk Pazartesi)
                    // Yeni hafta açma
                    return false;
                }
                
                // İlk Pazartesi'den sonraki gün sayısı
                const daysAfterFirstMonday = currentWeek.days.length - firstMondayIndex;
                
                // İlk Pazartesi'den sonra 7 gün tamamlandı mı? (Pazartesi dahil)
                if (daysAfterFirstMonday < 7) {
                    // Henüz 7 gün tamamlanmadı, yeni hafta açma
                    return false;
                }
                
                // 7 gün tamamlandı ve şimdi ikinci Pazartesi geldi - yeni hafta sor
                return true;
            }
            
            // İlk haftadan sonraki haftalar için: Her Pazartesi yeni hafta
            return true;
        }

        // Prompt New Week Creation
        function promptNewWeekCreation() {
            const currentWeek = weeks[currentWeekIndex];
            const nextWeekNumber = weeks.length + 1;
            
            // Son eklenen günün tarihini al (henüz eklenmedi, bu yüzden son gün bir önceki)
            const lastDay = currentWeek.days[currentWeek.days.length - 1];
            const lastDate = new Date(lastDay.date);
            
            // Bir sonraki Pazartesi (bir gün sonrası)
            const nextMonday = new Date(lastDate);
            nextMonday.setDate(nextMonday.getDate() + 1);
            
            // Bir sonraki Pazar (6 gün sonra)
            const nextSunday = new Date(nextMonday);
            nextSunday.setDate(nextSunday.getDate() + 6);
            
            // Türkçe tarih formatı
            const startStr = formatDateTurkish(nextMonday);
            const endStr = formatDateTurkish(nextSunday);
            
            const message = `${nextWeekNumber}. hafta eklenecek (${startStr} - ${endStr}). Eklemek ister misiniz?`;
            
            if (confirm(message)) {
                addNewWeekFromDate(nextMonday);
                return true; // Yeni hafta oluşturuldu
            }
            return false; // İptal edildi
        }

        // Add New Week From Specific Date
        function addNewWeekFromDate(startDate) {
            const weekNumber = weeks.length + 1;

            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            renderWeekContent();
            showToast('Yeni hafta eklendi');
        }

        // Format Date Turkish
        function formatDateTurkish(date) {
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                           'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openSettings() {
            // Hafta numarasına göre otomatik diyet türü öner
            const weekNumber = currentWeekIndex + 1;
            let suggestedDiet = 'ketojenik'; // Varsayılan
            
            if (weekNumber >= 1 && weekNumber <= 2) {
                suggestedDiet = 'eliminasyonlu-ketojenik';
            } else if (weekNumber >= 3 && weekNumber <= 9) {
                suggestedDiet = 'ketojenik';
            } else if (weekNumber >= 10 && weekNumber <= 14) {
                suggestedDiet = 'lowcarb';
            }
            
            // Eğer kullanıcı daha önce ayar yapmamışsa, öneriyi kullan
            if (!settings.dietType || settings.dietType === '') {
                settings.dietType = suggestedDiet;
            }
            
            applySettingsToForm();
            document.getElementById('settingsModal').classList.add('active');
            
            // Hafta bazlı öneriyi göster
            if (weekNumber <= 14) {
                console.log(`📋 ${weekNumber}. hafta için önerilen diyet: ${suggestedDiet}`);
            }
        }

        // Download All Data (for GitHub upload)
        function downloadAllData() {
            if (!currentPatient) {
                showToast('Hasta bilgisi bulunamadı', 'error');
                return;
            }

            // Download both settings and weeks
            NutritionDataManager.downloadAllData(
                currentPatient.id,
                currentPatient.name,
                { settings: settings },
                weeks
            );

            showToast('Veriler indirildi! Lütfen nutrition/ klasörüne yükleyin.');
        }

        // Logout
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                PatientAuth.logout();
                window.location.href = 'login.html';
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        /**
         * 🔔 Şablon düzenleme modalı için özel bildirim
         * Modal içinde kısa süreliğine görünür, fade-out animasyonuyla kaybolur
         * @param {string} message - Bildirim mesajı
         * @param {string} type - success, error, warning, info
         */
        function showTemplateEditNotification(message, type = 'success') {
            // Bildirim container'ı oluştur (yoksa)
            let notifContainer = document.getElementById('templateEditNotifContainer');
            if (!notifContainer) {
                notifContainer = document.createElement('div');
                notifContainer.id = 'templateEditNotifContainer';
                notifContainer.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    z-index: 10002;
                    pointer-events: none;
                `;
                document.body.appendChild(notifContainer);
            }
            
            // Renk seçimi
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            
            // Bildirim elementi
            const notif = document.createElement('div');
            notif.style.cssText = `
                background: ${colors[type] || colors.success};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                opacity: 0;
                transform: translateX(100px);
                transition: all 0.3s ease;
                pointer-events: auto;
            `;
            notif.textContent = message;
            
            notifContainer.appendChild(notif);
            
            // Fade-in animasyonu
            setTimeout(() => {
                notif.style.opacity = '1';
                notif.style.transform = 'translateX(0)';
            }, 10);
            
            // 2 saniye sonra fade-out ve kaldır
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(100px)';
                
                setTimeout(() => {
                    notif.remove();
                }, 300);
            }, 2000);
        }

        // ========================================
        // ADMIN MATCHING MODAL FONKSİYONLARI
        // ========================================

        // Admin kontrolü
        function checkAdminPermission() {
            // AdminAuth varsa session kontrolü yap
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession) {
                const session = AdminAuth.getSession();
                if (session && session.username) {
                    console.log('✅ Admin kullanıcı:', session.username);
                    return true;
                }
            }
            return false;
        }

        // ========================================
        // ADMIN FONKSİYONLARI
        // ========================================

        // Admin yetkisi kontrolü
        function checkAdminPermission() {
            // AdminAuth yüklü mü?
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession) {
                const session = AdminAuth.getSession();
                if (session && session.username) {
                    console.log('👑 Admin oturum bulundu:', session.username);
                    return true;
                }
            }
            
            // Fallback: localStorage'dan kontrol (eski sistem)
            try {
                const userRole = localStorage.getItem('userRole');
                if (userRole === 'admin') {
                    console.log('👑 Admin (localStorage)');
                    return true;
                }
            } catch (e) {
                console.warn('localStorage kontrolü başarısız:', e);
            }
            
            return false;
        }

        // Admin butonunu göster/gizle
        function initAdminUI() {
            const isAdmin = checkAdminPermission();
            const adminBtn = document.getElementById('adminMatchingBtn');
            
            if (isAdmin && adminBtn) {
                adminBtn.style.display = 'inline-block';
                console.log('👑 Admin UI aktif');
            } else {
                console.log('👤 Normal kullanıcı - Admin özellikleri gizli');
            }
            
            // 🔐 Admin özelliklerini göster/gizle (yemek satırlarındaki ⚙️ ikonları)
            toggleAdminFeatures();
        }

        // Admin modal aç
        function openAdminMatchingModal() {
            if (!checkAdminPermission()) {
                showToast('❌ Bu özellik sadece admin kullanıcılar içindir!', 'error');
                return;
            }

            const modal = document.getElementById('adminMatchingModal');
            if (modal) {
                modal.style.display = 'flex';
                // İlk tab'ı yükle
                switchAdminTab('tarifManuel');
            }
        }

        // Admin modal kapat
        function closeAdminMatchingModal() {
            const modal = document.getElementById('adminMatchingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Tab değiştir (5 TAB MODAL için)
        function switchAdminTab(tabName) {
            console.log('🔄 Tab değiştir:', tabName);
            
            // Tüm tab içeriklerini gizle
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Tüm tab butonlarını pasif yap
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#ccc';
                btn.style.color = '#666';
            });
            
            // Seçili tab'ı göster
            const tabId = `admin-tab-${tabName}`;
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                console.log(`✅ Tab içeriği gösteriliyor: ${tabId}`);
                tabContent.style.display = 'block';
            } else {
                console.error(`❌ Tab içeriği bulunamadı: ${tabId}`);
            }
            
            // Seçili butonun stilini güncelle
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (tabName === 'manuel') {
                    activeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                } else if (tabName === 'yasak') {
                    activeBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
                } else if (tabName === 'db-eslestirme') {
                    activeBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)';
                } else if (tabName === 'db-yasak') {
                    activeBtn.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                } else if (tabName === 'db-ekle') {
                    activeBtn.style.background = 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)';
                } else if (tabName === 'github-settings') {
                    activeBtn.style.background = 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)';
                }
                activeBtn.style.color = 'white';
            }
            
            // Tab'a özel render fonksiyonlarını çağır
            setTimeout(() => {
                if (tabName === 'manuel') {
                    console.log('📝 Manuel eşleştirme tab\'ı render ediliyor...');
                    renderTarifManuelTab();
                } else if (tabName === 'yasak') {
                    console.log('🚫 Yasak kuralları tab\'ı render ediliyor...');
                    renderTarifYasakTab();
                } else if (tabName === 'db-eslestirme') {
                    console.log('🍽️ Veritabanı eşleştirme tab\'ı render ediliyor...');
                    renderYemekEslestirmeTab();
                } else if (tabName === 'db-yasak') {
                    console.log('⛔ Veritabanı yasakları tab\'ı render ediliyor...');
                    renderYemekYasakTab();
                }
            }, 100);
        }

        // Placeholder render fonksiyonları (sonra doldurulacak)
        function renderTarifManuelTab() {
            console.log('🎬 renderTarifManuelTab çağrıldı');
            
            // ✅ DOĞRU DIV: admin-tab-manuel (statik HTML modal içinde)
            const content = document.getElementById('admin-tab-manuel');
            if (!content) {
                console.error('❌ admin-tab-manuel div bulunamadı!');
                return;
            }
            
            console.log('✅ admin-tab-manuel div bulundu, içerik render ediliyor...');
            
            // Seçili yemek adını al
            const foodName = window.selectedFoodForAdmin?.foodName || currentFoodName || '';
            
            // � HER TAB AÇILIŞINDA GÜNCEL VERİYİ YENİLE (GitHub'dan yüklenmiş son hali)
            console.log('🔄 Manuel eşleştirmeler güncelleniyor (GitHub son hali)...');
            
            // Manuel eşleştirmeler varsa kullan, yoksa otomatik eşleşenleri bul
            if (manuelEslestirmeler[foodName]) {
                // GitHub'dan yüklenmiş manuel eşleştirme var
                const manuelData = manuelEslestirmeler[foodName];
                manualMatches[foodName] = (typeof manuelData === 'object' && manuelData.kartlar) 
                    ? manuelData.kartlar 
                    : (Array.isArray(manuelData) ? manuelData : []);
                console.log('✅ GitHub\'dan manuel eşleştirme yüklendi:', manualMatches[foodName]);
            } else if (!manualMatches[foodName]) {
                // GitHub'da yok ve local state'de de yok → Otomatik eşleşenleri bul
                console.log('🔍 Otomatik eşleşen kartlar aranıyor:', foodName);
                
                const autoMatchedCards = findTarifKartlari(foodName);
                
                if (autoMatchedCards && autoMatchedCards.length > 0) {
                    manualMatches[foodName] = autoMatchedCards.map(card => {
                        const fileName = typeof card === 'string' 
                            ? card 
                            : (card.file || card.name || '');
                        
                        return fileName.match(/\.(jpg|jpeg|png)$/i) 
                            ? fileName 
                            : `${fileName}.jpg`;
                    }).filter(Boolean);
                    
                    console.log('✅ Otomatik eşleşen kartlar yüklendi:', manualMatches[foodName]);
                } else {
                    manualMatches[foodName] = [];
                    console.log('ℹ️ Otomatik eşleşme bulunamadı');
                }
            } else {
                console.log('ℹ️ Local state\'de manuel eşleştirmeler var:', manualMatches[foodName]);
            }
            
            // HTML render
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">📝 Manuel Eşleştirme (Tarif Kartları)</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        Menü kartındaki "<strong>${foodName}</strong>" yemeğini tarif kartlarıyla eşleştirin.
                        <br><small>💡 İpucu: "dom çor" yazarak "domates çorbası" kartını bulabilirsiniz.</small>
                    </p>
                    
                    <!-- Seçili Tarif Kartları Listesi -->
                    <div class="selected-tarif-list" id="selectedTarifList">
                        <div class="selected-tarif-list-title">
                            ✅ Seçili Tarif Kartları
                        </div>
                        <div class="selected-tarif-tags" id="selectedTarifTags">
                            <span class="selected-tarif-empty">Henüz kart seçilmedi. Aşağıdaki kartlardan tıklayarak seçin.</span>
                        </div>
                    </div>
                    
                    <!-- Search Input -->
                    <div class="tarif-search-container">
                        <input type="text" 
                               class="tarif-search-input" 
                               id="tarifSearchInput" 
                               placeholder="🔍 Tarif kartı ara... (örn: dom çor, kuru fas)"
                               oninput="searchTarifCards(this.value)"
                               autocomplete="off">
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">
                            💡 İpucu: Kısaltmalar kullanabilirsiniz (dom çor, çor dom, vs.)
                        </p>
                    </div>
                    
                    <!-- Tarif Kartları Grid -->
                    <div class="tarif-grid" id="tarifCardsGrid">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Tarif kartları yükleniyor...
                        </div>
                    </div>
                    
                    <!-- Kaydet Butonu -->
                    <div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button onclick="saveManualMatches()" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            💾 Eşleştirmeyi Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            console.log('✅ HTML render edildi, şimdi tarif kartları yüklenecek...');
            
            // Tarif kartlarını yükle ve render et
            loadAndRenderTarifCards();
        }

        function renderTarifYasakTab() {
            console.log('🎬 renderTarifYasakTab çağrıldı');
            
            const content = document.getElementById('admin-tab-yasak');
            if (!content) {
                console.error('❌ admin-tab-yasak div bulunamadı!');
                return;
            }
            
            console.log('✅ admin-tab-yasak div bulundu, içerik render ediliyor...');
            
            // 🔄 HER TAB AÇILIŞINDA GÜNCEL VERİYİ YENİLE (GitHub'dan yüklenmiş son hali)
            console.log('🔄 Yasak kuralları güncelleniyor (GitHub son hali)...');
            
            // Yemek adını temizle (eslestirme.html mantığı ile aynı key'i kullan)
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                .replace(/ş/g, 's').replace(/Ş/g, 'S')
                .replace(/ı/g, 'i').replace(/İ/g, 'I')
                .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                .trim();
            
            // GitHub'dan yüklenmiş yasak kurallarını al (hem orijinal hem temizlenmiş key ile)
            let yasakData = eslesmemeKurallari[currentFoodName] || eslesmemeKurallari[lowercaseSpaced];
            let currentBanned = [];
            
            if (yasakData && typeof yasakData === 'object' && !Array.isArray(yasakData)) {
                // GitHub format: { orijinalMetin, yasakliKartlar, eklemeTarihi }
                currentBanned = yasakData.yasakliKartlar || yasakData.kartlar || [];
                console.log('✅ GitHub\'dan yasak kuralı yüklendi:', currentBanned);
            } else if (Array.isArray(yasakData)) {
                // Eski format: direkt array
                currentBanned = yasakData;
                console.log('✅ Eski formatta yasak kuralı yüklendi:', currentBanned);
            } else {
                console.log('ℹ️ Yasak kuralı bulunamadı');
            }
            
            // Local state'i güncelle (array olarak sakla)
            eslesmemeKurallari[currentFoodName] = currentBanned;
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #f44336; font-size: 20px;">
                        🚫 Yasak Tarif Kartları
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> için <strong>yanlış</strong> eşleşecek tarif kartlarını seçin
                    </p>
                    
                    <!-- Seçili Yasak Kartlar (Badge'ler) -->
                    <div id="selectedBannedTags" style="min-height: 50px; background: #fff3f3; border: 2px dashed #f44336; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input -->
                    <input 
                        type="text" 
                        id="bannedSearchInput" 
                        placeholder="🔍 Tarif kartı ara..." 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #f44336; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchBannedCards(this.value)"
                    />
                    
                    <!-- Tarif Kartları Grid -->
                    <div id="bannedCardsGrid" class="tarif-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveBannedMatches()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    💾 Yasak Kurallarını Kaydet
                </button>
            `;
            
            console.log('✅ HTML render edildi, şimdi yasak kartları yüklenecek...');
            
            // Tarif kartlarını yükle ve render et
            loadAndRenderBannedCards();
        }

        // ========================================
        // TAB 3: YEMEK VERİTABANI MANUEL EŞLEŞTİRME
        // ========================================
        function renderYemekEslestirmeTab() {
            console.log('🎬 renderYemekEslestirmeTab çağrıldı');
            
            const content = document.getElementById('admin-tab-db-eslestirme');
            if (!content) {
                console.error('❌ admin-tab-db-eslestirme div bulunamadı!');
                return;
            }
            
            // 🔄 GitHub'dan yüklenmiş manuel eşleştirmeleri al
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                .trim();
            
            let currentManuelMatch = null;
            if (yemekVeritabaniEslestirme[currentFoodName]) {
                currentManuelMatch = yemekVeritabaniEslestirme[currentFoodName];
            } else if (yemekVeritabaniEslestirme[lowercaseSpaced]) {
                currentManuelMatch = yemekVeritabaniEslestirme[lowercaseSpaced];
            }
            
            // Önceden eşleştirilmiş yemekler (ARRAY formatı - yeni sistem)
            let previousMatchedFoods = [];
            if (currentManuelMatch) {
                // YENİ FORMAT: hedefYemekler (array)
                if (Array.isArray(currentManuelMatch.hedefYemekler)) {
                    previousMatchedFoods = currentManuelMatch.hedefYemekler;
                    console.log(`✅ GitHub'dan manuel eşleştirmeler yüklendi (${previousMatchedFoods.length} yemek):`, previousMatchedFoods);
                }
                // ESKİ FORMAT: hedefYemek (string) - geriye dönük uyumluluk
                else if (currentManuelMatch.hedefYemek) {
                    previousMatchedFoods = [currentManuelMatch.hedefYemek];
                    console.log('✅ GitHub\'dan manuel eşleştirme yüklendi (eski format):', currentManuelMatch.hedefYemek);
                }
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea; font-size: 20px;">
                        🍽️ Yemek Veritabanı Manuel Eşleştirme (ÇOK SEÇİMLİ)
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> için <strong>food_list.json</strong>'da hangi yemekler kullanılsın?
                        <br><small style="color: #999;">💡 Birden fazla yemek seçerseniz, haftalık menüde <strong>sırayla</strong> rotasyon yapılır.</small>
                    </p>
                    
                    <!-- Seçili Yemekler (ÇOK SEÇİMLİ - Checkboxlar ile) -->
                    <div id="selectedFoodMatch" style="min-height: 80px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border: 2px dashed #667eea; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input (Akıllı Fuzzy Search) -->
                    <input 
                        type="text" 
                        id="foodDbSearchInput" 
                        placeholder="🔍 Yemek ara... (örn: mer çor → Mercimek Çorbası)" 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchFoodDatabase(this.value)"
                    />
                    
                    <!-- Yemek Listesi (food_list.json) - CHECKBOX ile çoklu seçim -->
                    <div id="foodDatabaseList" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Yemekler yükleniyor...
                        </div>
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveYemekEslestirme()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    💾 Manuel Eşleştirmeleri Kaydet
                </button>
            `;
            
            console.log('✅ HTML render edildi, şimdi yemek veritabanı yüklenecek...');
            
            // food_list.json yükle ve render et (ARRAY parametresi)
            loadAndRenderFoodDatabase(previousMatchedFoods);
        }
        
        // ========================================
        // TAB 4: YEMEK VERİTABANI YASAKLARI
        // ========================================
        function renderYemekYasakTab() {
            console.log('🎬 renderYemekYasakTab çağrıldı');
            
            const content = document.getElementById('admin-tab-db-yasak');
            if (!content) {
                console.error('❌ admin-tab-db-yasak div bulunamadı!');
                return;
            }
            
            // 🔄 GitHub'dan yüklenmiş yasak kurallarını al
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                .trim();
            
            let currentYasakData = null;
            if (yemekVeritabaniYasaklar[currentFoodName]) {
                currentYasakData = yemekVeritabaniYasaklar[currentFoodName];
            } else if (yemekVeritabaniYasaklar[lowercaseSpaced]) {
                currentYasakData = yemekVeritabaniYasaklar[lowercaseSpaced];
            }
            
            // Önceden yasaklanmış yemekler
            let previousBannedFoods = [];
            if (currentYasakData && currentYasakData.yasaklananYemekler) {
                previousBannedFoods = currentYasakData.yasaklananYemekler;
                console.log('✅ GitHub\'dan yasak kuralları yüklendi:', previousBannedFoods);
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #ff9800; font-size: 20px;">
                        🚫 Yemek Veritabanı Yasakları
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> için <strong>food_list.json</strong>'da hangi yemekler kullanılmasın?
                        <br><small style="color: #999;">⚠️ Seçtiğiniz yemekler, bu menü kartı için asla kullanılmayacak.</small>
                    </p>
                    
                    <!-- Seçili Yasak Yemekler (Çoklu Seçim - Badge'ler) -->
                    <div id="selectedBannedFoods" style="min-height: 80px; background: #fff8e1; border: 2px dashed #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input (Akıllı Fuzzy Search) -->
                    <input 
                        type="text" 
                        id="foodBanSearchInput" 
                        placeholder="🔍 Yasak yemek ara... (örn: kab çek → Kabak Çekirdekli Kraker)" 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #ff9800; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchBannedFoods(this.value)"
                    />
                    
                    <!-- Yemek Listesi (food_list.json - Çoklu Seçim) -->
                    <div id="foodBanList" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Yemekler yükleniyor...
                        </div>
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveYemekYasaklar()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    💾 Yasak Kurallarını Kaydet
                </button>
            `;
            
            console.log('✅ HTML render edildi, şimdi yasak yemekler yüklenecek...');
            
            // food_list.json yükle ve render et
            loadAndRenderBannedFoods(previousBannedFoods);
        }

        // ========================================
        // TAB 1: TARİF KARTLARI - AKILLI SEARCH FONKSİYONLARI
        // ========================================
        
        // Tarif kartlarını yükle ve render et
        async function loadAndRenderTarifCards() {
            console.log('📥 loadAndRenderTarifCards başladı');
            
            try {
                // ✅ GitHub Raw URL kullan (CORS hatası önlemek için)
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json?t=' + Date.now());
                console.log('📡 Fetch response:', response.status, response.ok);
                
                if (!response.ok) throw new Error('Tarif listesi yüklenemedi');
                
                const tarifList = await response.json();
                console.log('📋 Tarif listesi alındı:', tarifList.length, 'item');
                
                // Global array'e kaydet
                tarifKartlari = tarifList.map(item => {
                    // String mi object mi kontrol et
                    const fileName = typeof item === 'string' ? item : (item.file || item.name || item);
                    
                    // Dosya adından isim çıkar: "domates_corbasi.jpg" → "domates çorbası"
                    const displayName = fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return {
                        file: fileName,  // "kabak_sote.jpg" (alt çizgili, uzantılı)
                        name: displayName,  // "kabak sote" (boşluklu, uzantısız - görüntüleme için)
                        tags: (typeof item === 'object' && item.tags) ? item.tags : [],
                        imagePath: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}` // ✅ GitHub Raw URL
                    };
                });
                
                console.log('✅ tarifKartlari global array:', tarifKartlari.length, 'kart');
                console.log('📋 İlk 3 kart:', tarifKartlari.slice(0, 3).map(t => t.name));
                
                // İlk render (seçililer üstte)
                renderTarifKartlari(tarifKartlari);
                
            } catch (error) {
                console.error('❌ Tarif kartları yüklenirken hata:', error);
                const grid = document.getElementById('tarifCardsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            ❌ Tarif kartları yüklenemedi!<br>
                            <small>${error.message}</small>
                        </div>
                    `;
                } else {
                    console.error('❌ Grid element bulunamadı!');
                }
            }
        }
        
        // Fuzzy search - "dom çor" → "domates çorbası"
        function searchTarifCards(query) {
            if (!query || query.trim() === '') {
                // Boşsa tüm kartları göster (seçililer üstte)
                renderTarifKartlari(tarifKartlari);
                return;
            }
            
            const normalizedQuery = normalizeTr(query);
            const queryTokens = normalizedQuery.split(/\s+/).filter(t => t.length > 0);
            
            // Fuzzy match: Her query token'ı tarif adında var mı?
            const filtered = tarifKartlari.filter(tarif => {
                const normalizedName = normalizeTr(tarif.name);
                
                // Tüm query token'ları tarif adında olmalı
                return queryTokens.every(token => {
                    // Token tam eşleşme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kısaltma: "dom" → "domates", "çor" → "çorbası"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderTarifKartlari(filtered);
        }
        
        // Tarif kartlarını ekranda göster (seçililer üstte)
        function renderTarifKartlari(tarifler) {
            console.log('🔍 renderTarifKartlari çağrıldı:', {
                tariflerCount: tarifler?.length,
                currentFoodName: currentFoodName,
                gridElement: document.getElementById('tarifCardsGrid')
            });
            
            const grid = document.getElementById('tarifCardsGrid');
            if (!grid) {
                console.error('❌ Grid element bulunamadı! ID: tarifCardsGrid');
                return;
            }
            
            if (!tarifler || tarifler.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; grid-column: 1 / -1;">
                        🔍 Eşleşen tarif bulunamadı
                    </div>
                `;
                return;
            }
            
            // Seçili kartlar üstte, seçili olmayanlar altta
            // ✅ Object → Array dönüşümü (GitHub JSON format: {kartlar: [...], guncellemeTarihi: ...})
            let currentMatchData = manualMatches[currentFoodName] || [];
            const currentMatches = Array.isArray(currentMatchData) 
                ? currentMatchData 
                : (currentMatchData.kartlar || []);
            
            console.log('� Mevcut eşleştirmeler (array):', currentMatches);
            console.log('🔍 DEBUG - currentFoodName:', currentFoodName);
            
            const sorted = [...tarifler].sort((a, b) => {
                const aSelected = currentMatches.includes(a.file);
                const bSelected = currentMatches.includes(b.file);
                console.log(`🔍 DEBUG - Kart: "${a.file}", selected: ${aSelected}`);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return 0;
            });
            
            console.log('✅ Render ediliyor:', sorted.length, 'kart');
            
            grid.innerHTML = sorted.map(tarif => {
                const isSelected = currentMatches.includes(tarif.file);
                return `
                    <div class="tarif-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleTarifSelection('${tarif.file.replace(/'/g, "\\'")}')">
                        <img src="${tarif.imagePath}" 
                             alt="${tarif.name}"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-size=\\'14\\'%3E${tarif.name.slice(0,2)}%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarif.name}</div>
                    </div>
                `;
            }).join('');
            
            console.log('✅ Grid innerHTML set edildi');
            
            // Seçili kartları güncelle (YENI!)
            updateSelectedTarifList();
        }
        
        // Kart seçim toggle
        function toggleTarifSelection(tarifName) {
            // ✅ Object → Array dönüşümü
            if (!manualMatches[currentFoodName]) {
                manualMatches[currentFoodName] = [];
            }
            
            // GitHub format ise array'e çevir
            let currentArray = Array.isArray(manualMatches[currentFoodName])
                ? manualMatches[currentFoodName]
                : (manualMatches[currentFoodName].kartlar || []);
            
            const index = currentArray.indexOf(tarifName);
            
            if (index === -1) {
                // Ekle
                currentArray.push(tarifName);
            } else {
                // Çıkar
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet (array formatında)
            manualMatches[currentFoodName] = currentArray;
            
            // Search input değerini koru
            const searchInput = document.getElementById('tarifSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            // Yeniden render (search varsa filtrelenmiş, yoksa tam liste)
            if (currentQuery) {
                searchTarifCards(currentQuery);
            } else {
                renderTarifKartlari(tarifKartlari);
            }
            
            // Seçili kartları güncelle (YENI!)
            updateSelectedTarifList();
        }
        
        // Seçili tarif kartları listesini güncelle (YENI FONKSIYON!)
        function updateSelectedTarifList() {
            const container = document.getElementById('selectedTarifTags');
            if (!container) return;
            
            // ✅ Object → Array dönüşümü
            let selectedData = manualMatches[currentFoodName] || [];
            const selectedCards = Array.isArray(selectedData) 
                ? selectedData 
                : (selectedData.kartlar || []);
            
            if (selectedCards.length === 0) {
                container.innerHTML = '<span class="selected-tarif-empty">Henüz kart seçilmedi. Aşağıdaki kartlardan tıklayarak seçin.</span>';
            } else {
                container.innerHTML = selectedCards.filter(Boolean).map(cardFile => {
                    // Dosya adından okunabilir isim oluştur: "kabak_sote.jpg" → "kabak sote"
                    const displayName = (cardFile || '').replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return `
                        <span class="selected-tarif-tag">
                            ${displayName}
                            <span class="remove-icon" onclick="removeManualMatch('${(cardFile || '').replace(/'/g, "\\'")}')">×</span>
                        </span>
                    `;
                }).join('');
            }
        }
        
        // Manuel eşleştirme sil (badge × butonu)
        function removeManualMatch(matchName) {
            if (!manualMatches[currentFoodName]) return;
            
            // ✅ Object → Array dönüşümü
            let currentArray = Array.isArray(manualMatches[currentFoodName])
                ? manualMatches[currentFoodName]
                : (manualMatches[currentFoodName].kartlar || []);
            
            const index = currentArray.indexOf(matchName);
            if (index !== -1) {
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet
            manualMatches[currentFoodName] = currentArray;
            
            // Seçili kartları güncelle
            updateSelectedTarifList();
            
            // Grid'i yeniden render et (selected state'i güncelle)
            const searchInput = document.getElementById('tarifSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            if (currentQuery) {
                searchTarifCards(currentQuery);
            } else {
                renderTarifKartlari(tarifKartlari);
            }
        }
        
        // ========================================
        // GITHUB KAYIT FONKSİYONLARI
        // ========================================
        
        /**
         * Dosyayı GitHub'a kaydet (PUT API)
         * @param {string} filePath - Dosya yolu (örn: 'data/manuel_eslestirmeler.json')
         * @param {string} content - Dosya içeriği (JSON.stringify ile)
         * @param {string} commitMessage - Commit mesajı
         */
        async function saveToGitHub(filePath, content, commitMessage) {
            const GITHUB_TOKEN = localStorage.getItem('github_token');
            
            if (!GITHUB_TOKEN) {
                throw new Error('GitHub token bulunamadı! Lütfen Admin Modal > Tab 6\'dan token girin.');
            }
            
            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const BRANCH = 'main';
            
            try {
                // 1. Mevcut dosyanın SHA'sını al (güncelleme için gerekli)
                const getUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    console.log(`✅ Dosya SHA alındı: ${sha.slice(0, 7)}`);
                }
                
                // 2. İçeriği Base64'e çevir (✅ TÜRKÇE KARAKTER KORUYAN)
                const contentBase64 = encodeBase64UTF8(content);
                
                // 3. Dosyayı GitHub'a kaydet (PUT)
                const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: contentBase64,
                        sha: sha, // Güncelleme için gerekli (yoksa null olur - yeni dosya)
                        branch: BRANCH
                    })
                });
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub kayıt hatası: ${errorData.message}`);
                }
                
                const result = await putResponse.json();
                console.log('✅ GitHub\'a kaydedildi:', result.commit.sha.slice(0, 7));
                
                return result;
                
            } catch (error) {
                console.error('❌ saveToGitHub hatası:', error);
                throw error;
            }
        }
        
        // Manuel eşleştirmeleri kaydet
        async function saveManualMatches() {
            if (!currentFoodName) {
                alert('❌ Menü kartı seçilmedi!');
                return;
            }
            
            const matches = manualMatches[currentFoodName] || [];
            
            // 🔍 Otomatik eşleşen kartları kontrol et
            const autoMatchedCards = findTarifKartlari(currentFoodName);
            const autoMatchedNames = autoMatchedCards.map(card => card.name);
            
            // Otomatik eşleşenlerle karşılaştır
            const isSameAsAuto = 
                matches.length === autoMatchedNames.length &&
                matches.every(m => autoMatchedNames.includes(m)) &&
                autoMatchedNames.every(a => matches.includes(a));
            
            if (isSameAsAuto) {
                alert(`ℹ️ Seçilen kartlar otomatik eşleşenlerle aynı.\n\nManuel kayıt yapılmadı (zaten otomatik eşleşiyor).`);
                return;
            }
            
            if (matches.length === 0) {
                // Kullanıcı tüm kartları kaldırmış - bu da bir manuel seçim
                const confirmDelete = confirm(`⚠️ Hiç kart seçilmedi.\n\n"${currentFoodName}" için tüm eşleştirmeleri kaldırmak istediğinizi onaylıyor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut manuel_eslestirmeler.json'u yükle
                const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json?t=' + Date.now())
                    .then(r => r.ok ? r.json() : { eslestirmeler: {} })
                    .catch(() => ({ eslestirmeler: {} }));
                
                const eslestirmeler = currentData.eslestirmeler || currentData;
                
                // Güncelle veya ekle
                if (matches.length === 0) {
                    // Boş eşleştirme: Sil
                    delete eslestirmeler[currentFoodName];
                } else {
                    // Yeni eşleştirme: Ekle/Güncelle
                    eslestirmeler[currentFoodName] = {
                        kartlar: matches,
                        guncellemeTarihi: new Date().toISOString()
                    };
                }
                
                // GitHub'a kaydet (data/manuel_eslestirmeler.json)
                await saveToGitHub(
                    'data/manuel_eslestirmeler.json',
                    JSON.stringify({ eslestirmeler }, null, 2),
                    `Manuel eşleştirme güncellendi: ${currentFoodName} (${matches.length} tarif)`
                );
                
                // Global state'i güncelle
                manuelEslestirmeler = eslestirmeler;
                
                alert(`✅ ${matches.length} tarif eşleştirildi ve GitHub'a kaydedildi!\n\n${matches.join('\n')}`);
                
                // ✅ SAYFAYI DİNAMİK OLARAK YENİLE (değişiklik anında görünsün)
                console.log('🔄 Manuel eşleştirme kaydedildi, sayfa yenileniyor...');
                renderWeekContent(); // Haftalık menüyü yenile
                
            } catch (error) {
                console.error('Kaydetme hatası:', error);
                alert('❌ Kaydetme sırasında hata:\n' + error.message);
            }
        }

        // ========================================
        // 🚫 YASAK KARTLAR FONKSİYONLARI (TAB 2)
        // ========================================

        // Yasak kartları yükle ve render et
        async function loadAndRenderBannedCards() {
            console.log('📥 loadAndRenderBannedCards başladı');
            
            // Tarif kartları zaten loadTarifKartlari() ile yüklendi
            if (tarifKartlari.length === 0) {
                console.warn('⚠️ Tarif kartları henüz yüklenmemiş, yükleniyor...');
                await loadTarifKartlari();
            }
            
            console.log('📋 Tarif kartları hazır:', tarifKartlari.length);
            
            // Yasak kartları render et
            renderBannedKartlari(tarifKartlari);
            
            // Seçili yasak kartları güncelle
            updateSelectedBannedList();
        }

        // Yasak kartlarını grid'e render et
        function renderBannedKartlari(tarifler) {
            const grid = document.getElementById('bannedCardsGrid');
            if (!grid) {
                console.error('❌ bannedCardsGrid bulunamadı!');
                return;
            }
            
            // Seçili kartlar üstte, seçili olmayanlar altta
            // ✅ Object → Array dönüşümü
            let currentBannedData = eslesmemeKurallari[currentFoodName] || [];
            const currentBanned = Array.isArray(currentBannedData) 
                ? currentBannedData 
                : (currentBannedData.kartlar || currentBannedData.yasakKartlar || []);
            
            console.log('📋 Mevcut yasaklar (array):', currentBanned);
            
            const sorted = [...tarifler].sort((a, b) => {
                const aBanned = currentBanned.includes(a.file);
                const bBanned = currentBanned.includes(b.file);
                if (aBanned && !bBanned) return -1;
                if (!aBanned && bBanned) return 1;
                return 0;
            });
            
            grid.innerHTML = sorted.map(tarif => {
                const isBanned = currentBanned.includes(tarif.file);
                return `
                    <div class="tarif-item ${isBanned ? 'selected' : ''}" 
                         style="border-color: ${isBanned ? '#f44336' : '#ddd'}"
                         onclick="toggleBannedSelection('${tarif.file.replace(/'/g, "\\'")}')">
                        <img src="${tarif.imagePath}" 
                             alt="${tarif.name}"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-size=\\'14\\'%3E${tarif.name.slice(0,2)}%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarif.name}</div>
                    </div>
                `;
            }).join('');
        }

        // Yasak kart seçim toggle
        function toggleBannedSelection(tarifName) {
            // ✅ Object → Array dönüşümü
            if (!eslesmemeKurallari[currentFoodName]) {
                eslesmemeKurallari[currentFoodName] = [];
            }
            
            // GitHub format ise array'e çevir
            let currentArray = Array.isArray(eslesmemeKurallari[currentFoodName])
                ? eslesmemeKurallari[currentFoodName]
                : (eslesmemeKurallari[currentFoodName].kartlar || eslesmemeKurallari[currentFoodName].yasakKartlar || []);
            
            const index = currentArray.indexOf(tarifName);
            
            if (index === -1) {
                // Ekle
                currentArray.push(tarifName);
            } else {
                // Çıkar
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet (array formatında)
            eslesmemeKurallari[currentFoodName] = currentArray;
            
            // Search input değerini koru
            const searchInput = document.getElementById('bannedSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            // Grid'i yeniden render et
            if (currentQuery) {
                searchBannedCards(currentQuery);
            } else {
                renderBannedKartlari(tarifKartlari);
            }
            
            // Seçili kartları güncelle
            updateSelectedBannedList();
        }

        // Yasak kartları ara
        function searchBannedCards(query) {
            if (!query || query.trim() === '') {
                renderBannedKartlari(tarifKartlari);
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            const filtered = tarifKartlari.filter(tarif => 
                tarif.name.toLowerCase().includes(lowerQuery)
            );
            
            renderBannedKartlari(filtered);
        }

        // Seçili yasak kartları listesini güncelle
        function updateSelectedBannedList() {
            const container = document.getElementById('selectedBannedTags');
            if (!container) return;
            
            // ✅ Object → Array dönüşümü
            let bannedData = eslesmemeKurallari[currentFoodName] || [];
            const bannedCards = Array.isArray(bannedData) 
                ? bannedData 
                : (bannedData.kartlar || bannedData.yasakKartlar || []);
            
            if (bannedCards.length === 0) {
                container.innerHTML = '<span class="selected-tarif-empty">Henüz yasak kart seçilmedi. Aşağıdaki kartlardan tıklayarak yasak olarak işaretleyin.</span>';
            } else {
                container.innerHTML = bannedCards.filter(Boolean).map(cardFile => {
                    const displayName = (cardFile || '').replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return `
                        <span class="selected-tarif-tag" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">
                            ${displayName}
                            <span class="remove-icon" onclick="removeBannedMatch('${(cardFile || '').replace(/'/g, "\\'")}')">×</span>
                        </span>
                    `;
                }).join('');
            }
        }

        // Yasak eşleştirme sil (badge × butonu)
        function removeBannedMatch(matchName) {
            if (!eslesmemeKurallari[currentFoodName]) return;
            
            // ✅ Object → Array dönüşümü
            let currentArray = Array.isArray(eslesmemeKurallari[currentFoodName])
                ? eslesmemeKurallari[currentFoodName]
                : (eslesmemeKurallari[currentFoodName].kartlar || eslesmemeKurallari[currentFoodName].yasakKartlar || []);
            
            const index = currentArray.indexOf(matchName);
            if (index !== -1) {
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet
            eslesmemeKurallari[currentFoodName] = currentArray;
            
            // Seçili kartları güncelle
            updateSelectedBannedList();
            
            // Grid'i yeniden render et
            const searchInput = document.getElementById('bannedSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            if (currentQuery) {
                searchBannedCards(currentQuery);
            } else {
                renderBannedKartlari(tarifKartlari);
            }
        }

        // Yasak kurallarını GitHub'a kaydet
        async function saveBannedMatches() {
            if (!currentFoodName) {
                alert('❌ Menü kartı seçilmedi!');
                return;
            }
            
            // Local'deki seçili yasak kartları al
            let banned = eslesmemeKurallari[currentFoodName];
            
            // ✅ Object formatındaysa array'e çevir
            if (banned && typeof banned === 'object' && !Array.isArray(banned)) {
                banned = banned.yasakliKartlar || banned.kartlar || [];
            }
            
            banned = banned || [];
            
            if (banned.length === 0) {
                const confirmDelete = confirm(`⚠️ Hiç yasak kart seçilmedi.\n\n"${currentFoodName}" için tüm yasak kurallarını kaldırmak istediğinizi onaylıyor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut eslesmeme_kurallari.json'u GitHub'dan yükle
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json?t=' + Date.now());
                let currentData = {};
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // ✅ eslestirme.html ile aynı fallback sistemi
                    if (data.kurallar && data.kurallar.eslesmemeKurallari) {
                        currentData = data.kurallar.eslesmemeKurallari;
                    } else if (data.kurallar) {
                        currentData = data.kurallar;
                    } else if (data.eslesmemeKurallari) {
                        currentData = data.eslesmemeKurallari;
                    } else {
                        currentData = data;
                    }
                }
                
                // Yemek adını temizle (eslestirme.html mantığı)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '') // Parantez içlerini kaldır
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '') // Miktar ön eklerini kaldır
                    .trim();
                
                const lowercaseSpaced = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                    .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                    .replace(/ş/g, 's').replace(/Ş/g, 'S')
                    .replace(/ı/g, 'i').replace(/İ/g, 'I')
                    .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                    .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                    .trim();
                
                console.log(`💾 Kaydedilecek key: "${lowercaseSpaced}" (orijinal: "${currentFoodName}")`);
                
                // Mevcut tüm kuralları koru
                let updatedEslesmemeKurallari = { ...currentData };
                
                if (banned.length === 0) {
                    // Yasak kart yoksa sil
                    delete updatedEslesmemeKurallari[lowercaseSpaced];
                    console.log(`🗑️ Yasak kuralı silindi: ${lowercaseSpaced}`);
                } else {
                    // Yeni yasak kuralı ekle (eslestirme.html formatı)
                    updatedEslesmemeKurallari[lowercaseSpaced] = {
                        orijinalMetin: currentFoodName,
                        yasakliKartlar: banned,
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`✅ Yasak kuralı eklendi: ${lowercaseSpaced} → ${banned.length} kart`);
                }
                
                // ✅ eslestirme.html ile AYNI FORMAT (nested structure)
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    kurallar: {
                        version: "1.0",
                        sonGuncelleme: new Date().toISOString(),
                        eslesmemeKurallari: updatedEslesmemeKurallari
                    }
                }, null, 2);
                
                const commitMsg = banned.length === 0 
                    ? `Yasak kuralı silindi: ${currentFoodName}`
                    : `Eşleşme yasağı: ${currentFoodName} ⛔ ${banned.join(', ')}`;
                
                // GitHub'a kaydet
                await saveToGitHub('data/eslesmeme_kurallari.json', jsonContent, commitMsg);
                
                console.log('✅ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i güncelle (object formatında tut - eslestirme.html mantığı)
                if (banned.length === 0) {
                    delete eslesmemeKurallari[lowercaseSpaced];
                } else {
                    eslesmemeKurallari[lowercaseSpaced] = {
                        orijinalMetin: currentFoodName,
                        yasakliKartlar: banned,
                        eklemeTarihi: new Date().toISOString()
                    };
                }
                
                // ✅ SAYFAYI DİNAMİK OLARAK YENİLE (değişiklik anında görünsün)
                console.log('🔄 Yasak kuralları kaydedildi, sayfa yenileniyor...');
                renderWeekContent(); // Haftalık menüyü yenile
                
                alert(`✅ Yasak kuralları kaydedildi!\n\n${banned.length} yasak kart: ${banned.join(', ')}`);
                
            } catch (error) {
                console.error('❌ Yasak kuralları kaydedilirken hata:', error);
                alert(`❌ Kaydetme hatası:\n\n${error.message}`);
            }
        }

        // ========================================
        // TAB 3 & TAB 4: YEMEK VERİTABANI FONKSİYONLARI
        // ========================================

        // Global state - Tab 3 & 4 (ÜSTTE TANINLI - mükerrer tanım silindi)

        // ========================================
        // TAB 3: Yemek Veritabanı Manuel Eşleştirme
        // ========================================

        async function loadAndRenderFoodDatabase(previousMatchedFoods = []) {
            console.log('📥 loadAndRenderFoodDatabase başladı');
            
            // foodData yüklenmiş mi kontrol et
            if (foodData.length === 0) {
                console.log('📥 foodData yükleniyor...');
                await loadFoodData();
            }
            
            // Önceki seçimleri set et (ARRAY formatı)
            if (previousMatchedFoods && Array.isArray(previousMatchedFoods)) {
                selectedFoodMatches = previousMatchedFoods;
            } else if (previousMatchedFoods) {
                // Geriye dönük uyumluluk: String ise array'e çevir
                selectedFoodMatches = [previousMatchedFoods];
            }
            
            // Tüm yemekleri göster
            renderFoodDatabaseList(foodData);
            updateSelectedFoodMatches();
        }

        // Yemek veritabanı arama (akıllı fuzzy search)
        function searchFoodDatabase(query) {
            if (!query || query.trim() === '') {
                // Boş arama: Tüm yemekleri göster
                renderFoodDatabaseList(foodData);
                return;
            }
            
            const tokens = query.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            
            const filtered = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                return tokens.every(token => {
                    // Token tam eşleşme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kısaltma: "mer" → "mercimek", "çor" → "çorbası"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderFoodDatabaseList(filtered);
        }

        // Yemekleri listele (seçili en üstte, CHECKBOX ile çoklu seçim)
        function renderFoodDatabaseList(foods) {
            const list = document.getElementById('foodDatabaseList');
            if (!list) return;
            
            if (!foods || foods.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        🔍 Eşleşen yemek bulunamadı
                    </div>
                `;
                return;
            }
            
            // Seçili yemekler üstte
            const sorted = [...foods].sort((a, b) => {
                const aSelected = selectedFoodMatches.includes(a.name);
                const bSelected = selectedFoodMatches.includes(b.name);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return a.name.localeCompare(b.name, 'tr');
            });
            
            list.innerHTML = sorted.map(food => {
                const isSelected = selectedFoodMatches.includes(food.name);
                return `
                    <div class="food-db-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleFoodMatch('${food.name.replace(/'/g, "\\'")}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                               style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"
                               onclick="event.stopPropagation(); toggleFoodMatch('${food.name.replace(/'/g, "\\'")}')">
                        <div style="flex: 1;">
                            <strong style="color: ${isSelected ? '#667eea' : '#333'}; font-size: 14px;">${food.name}</strong>
                            <br><small style="color: #999; font-size: 12px;">
                                ${food.calories || 0} kcal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Checkbox toggle (Tab 4 ile aynı mantık - çoklu seçim)
        function toggleFoodMatch(foodName) {
            const index = selectedFoodMatches.indexOf(foodName);
            if (index === -1) {
                selectedFoodMatches.push(foodName); // Ekle
            } else {
                selectedFoodMatches.splice(index, 1); // Çıkar
            }
            updateSelectedFoodMatches();
            
            // Arama input değerini koru
            const searchInput = document.getElementById('foodDbSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            
            // Listeyi güncelle (seçililer üste çıksın)
            searchFoodDatabase(searchValue || '');
        }

        // Tüm seçimleri temizle
        window.clearFoodMatches = function() {
            selectedFoodMatches = [];
            updateSelectedFoodMatches();
            
            // Listeyi yenile
            const searchInput = document.getElementById('foodDbSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            searchFoodDatabase(searchValue || '');
        };

        // Seçili yemekleri güncelle (çoklu badge gösterimi - Tab 4 ile aynı mantık)
        function updateSelectedFoodMatches() {
            const container = document.getElementById('selectedFoodMatch');
            if (!container) return;
            
            if (selectedFoodMatches.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <span style="font-size: 14px;">Henüz yemek seçilmedi</span>
                        <br><small style="font-size: 12px;">Aşağıdan bir veya birden fazla yemek seçin</small>
                    </div>
                `;
            } else {
                const badgesHtml = selectedFoodMatches.map(name => `
                    <span class="food-match-badge" style="display: inline-block; background: #667eea; color: white; padding: 8px 12px; border-radius: 20px; margin: 5px; font-size: 13px;">
                        ✅ ${name}
                    </span>
                `).join('');
                
                container.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #667eea; font-size: 14px;">
                                📌 Seçili Yemekler (${selectedFoodMatches.length})
                            </strong>
                            <button onclick="clearFoodMatches()" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ❌ Tümünü Temizle
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${badgesHtml}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <small style="color: #999; font-size: 11px;">
                                ℹ️ Rotasyon Modu: <strong style="color: #667eea;">Sıralı</strong> (1→2→3→1...)
                                <br>Menü oluştururken sistem yukarıdaki yemekleri sırayla kullanacak.
                            </small>
                        </div>
                    </div>
                `;
            }
        }

        // Kaydet: Tab 3 - Yemek Veritabanı Eşleştirme (ARRAY formatı + rotasyonModu)
        async function saveYemekEslestirme() {
            if (!currentFoodName) {
                alert('❌ Menü kartı seçilmedi!');
                return;
            }
            
            if (selectedFoodMatches.length === 0) {
                const confirmDelete = confirm(`⚠️ Hiç yemek seçilmedi.\n\n"${currentFoodName}" için manuel eşleştirmeyi kaldırmak istediğinizi onaylıyor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut yemek_veritabani_eslestirme.json'u yükle
                const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_eslestirme.json?t=' + Date.now())
                    .then(r => r.ok ? r.json() : { eslestirmeler: {} })
                    .catch(() => ({ eslestirmeler: {} }));
                
                const eslestirmeler = currentData.eslestirmeler || currentData;
                
                // Key normalizasyonu (eslestirme.html mantığı)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '')
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '')
                    .trim();
                
                const normalizedKey = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                    .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                    .trim();
                
                console.log(`💾 Kaydedilecek key: "${normalizedKey}" (orijinal: "${currentFoodName}")`);
                
                // Güncelle veya sil
                if (selectedFoodMatches.length === 0) {
                    delete eslestirmeler[normalizedKey];
                    console.log(`🗑️ Manuel eşleştirme silindi: ${normalizedKey}`);
                } else {
                    eslestirmeler[normalizedKey] = {
                        orijinalMetin: currentFoodName,
                        hedefYemekler: selectedFoodMatches, // ✅ ARRAY formatı
                        rotasyonModu: 'sirayla', // ✅ Sıralı rotasyon (default)
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`✅ Manuel eşleştirme eklendi: ${normalizedKey} → [${selectedFoodMatches.join(', ')}]`);
                }
                
                // GitHub'a kaydet
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    eslestirmeler: eslestirmeler
                }, null, 2);
                
                const commitMsg = selectedFoodMatches.length > 0
                    ? `Yemek eşleştirme: ${currentFoodName} → ${selectedFoodMatches.length} alternatif`
                    : `Yemek eşleştirme silindi: ${currentFoodName}`;
                
                await saveToGitHub('data/yemek_veritabani_eslestirme.json', jsonContent, commitMsg);
                
                console.log('✅ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i güncelle
                yemekVeritabaniEslestirme = eslestirmeler;
                
                // Sayfa yenile
                console.log('🔄 Yemek eşleştirme kaydedildi, sayfa yenileniyor...');
                renderWeekContent();
                
                alert(selectedFoodMatches.length > 0
                    ? `✅ Manuel eşleştirme kaydedildi!\n\n${currentFoodName} → ${selectedFoodMatches.length} alternatif yemek\n\n${selectedFoodMatches.join('\n')}\n\n⚙️ Rotasyon: Sıralı (1→2→3→1...)`
                    : `✅ Manuel eşleştirme kaldırıldı!\n\n${currentFoodName}`
                );
                
            } catch (error) {
                console.error('❌ Kaydetme hatası:', error);
                alert(`❌ Kaydetme hatası:\n\n${error.message}`);
            }
        }

        // ========================================
        // TAB 4: Yemek Veritabanı Yasakları
        // ========================================

        async function loadAndRenderBannedFoods(previousBannedFoods = []) {
            console.log('📥 loadAndRenderBannedFoods başladı');
            
            // foodData yüklenmiş mi kontrol et
            if (foodData.length === 0) {
                console.log('📥 foodData yükleniyor...');
                await loadFoodData();
            }
            
            // Önceki seçimleri set et
            selectedBannedFoods = previousBannedFoods || [];
            
            // Tüm yemekleri göster
            renderBannedFoodsList(foodData);
            updateSelectedBannedFoods();
        }

        // Yasak yemek arama (akıllı fuzzy search)
        function searchBannedFoods(query) {
            if (!query || query.trim() === '') {
                // Boş arama: Tüm yemekleri göster
                renderBannedFoodsList(foodData);
                return;
            }
            
            const tokens = query.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            
            const filtered = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                return tokens.every(token => {
                    // Token tam eşleşme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kısaltma: "kab" → "kabak", "çek" → "çekirdekli"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderBannedFoodsList(filtered);
        }

        // Yasak yemekleri listele (seçililer en üstte + checkbox)
        function renderBannedFoodsList(foods) {
            const list = document.getElementById('foodBanList');
            if (!list) return;
            
            if (!foods || foods.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        🔍 Eşleşen yemek bulunamadı
                    </div>
                `;
                return;
            }
            
            // Seçililer üstte
            const sorted = [...foods].sort((a, b) => {
                const aSelected = selectedBannedFoods.includes(a.name);
                const bSelected = selectedBannedFoods.includes(b.name);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return a.name.localeCompare(b.name, 'tr');
            });
            
            list.innerHTML = sorted.map(food => {
                const isSelected = selectedBannedFoods.includes(food.name);
                return `
                    <div class="food-ban-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleBannedFood('${food.name.replace(/'/g, "\\'")}')">
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''}
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;"
                               onclick="event.stopPropagation(); toggleBannedFood('${food.name.replace(/'/g, "\\'")}')">
                        <div style="flex: 1;">
                            <strong style="color: ${isSelected ? '#f44336' : '#333'}; font-size: 14px;">${food.name}</strong>
                            <br><small style="color: #999; font-size: 12px;">
                                ${food.calories || 0} kcal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Yasak yemek toggle (checkbox mantığı)
        function toggleBannedFood(foodName) {
            const index = selectedBannedFoods.indexOf(foodName);
            
            if (index === -1) {
                // Ekle
                selectedBannedFoods.push(foodName);
            } else {
                // Çıkar
                selectedBannedFoods.splice(index, 1);
            }
            
            updateSelectedBannedFoods();
            
            // Arama input değerini koru
            const searchInput = document.getElementById('foodBanSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            
            // Listeyi güncelle (seçililer üste çıksın)
            searchBannedFoods(searchValue || '');
        }

        // Seçili yasak yemekleri güncelle (üst kısım - badge'ler)
        function updateSelectedBannedFoods() {
            const container = document.getElementById('selectedBannedFoods');
            if (!container) return;
            
            if (selectedBannedFoods.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <span style="font-size: 14px;">Henüz yasak yemek seçilmedi</span>
                        <br><small style="font-size: 12px;">Aşağıdan bir veya birden fazla yemek seçin</small>
                    </div>
                `;
            } else {
                const badgesHtml = selectedBannedFoods.map(foodName => `
                    <span class="banned-food-badge" 
                          style="display: inline-block; background: white; border: 2px solid #f44336; color: #f44336; padding: 8px 12px; border-radius: 20px; margin: 5px; font-size: 13px; font-weight: 500;">
                        🚫 ${foodName}
                    </span>
                `).join('');
                
                container.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #ff9800; font-size: 14px;">
                                🚫 Yasaklı Yemekler (${selectedBannedFoods.length})
                            </strong>
                            <button onclick="clearAllBannedFoods()" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ❌ Tümünü Temizle
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${badgesHtml}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <small style="color: #999; font-size: 11px;">
                                ⚠️ Bu yemekler "${currentFoodName}" için asla kullanılmayacak.
                            </small>
                        </div>
                    </div>
                `;
            }
        }
        
        // Tüm yasak yemekleri temizle
        window.clearAllBannedFoods = function() {
            selectedBannedFoods = [];
            updateSelectedBannedFoods();
            
            // Listeyi yenile
            const searchInput = document.getElementById('foodBanSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            searchBannedFoods(searchValue || '');
        };

        // Kaydet: Tab 4 - Yemek Veritabanı Yasakları
        async function saveYemekYasaklar() {
            if (!currentFoodName) {
                alert('❌ Menü kartı seçilmedi!');
                return;
            }
            
            if (selectedBannedFoods.length === 0) {
                const confirmDelete = confirm(`⚠️ Hiç yasak yemek seçilmedi.\n\n"${currentFoodName}" için yasak kurallarını kaldırmak istediğinizi onaylıyor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut yemek_veritabani_yasaklar.json'u yükle
                const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_yasaklar.json?t=' + Date.now())
                    .then(r => r.ok ? r.json() : { yasaklar: {} })
                    .catch(() => ({ yasaklar: {} }));
                
                const yasaklar = currentData.yasaklar || currentData;
                
                // Key normalizasyonu (eslestirme.html mantığı)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '')
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardağı|kase|ml|lt)\s*/i, '')
                    .trim();
                
                const normalizedKey = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
                    .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
                    .trim();
                
                console.log(`💾 Kaydedilecek key: "${normalizedKey}" (orijinal: "${currentFoodName}")`);
                
                // Güncelle veya sil
                if (selectedBannedFoods.length === 0) {
                    delete yasaklar[normalizedKey];
                    console.log(`🗑️ Yasak kuralı silindi: ${normalizedKey}`);
                } else {
                    yasaklar[normalizedKey] = {
                        orijinalMetin: currentFoodName,
                        yasaklananYemekler: selectedBannedFoods,
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`✅ Yasak kuralı eklendi: ${normalizedKey} → ${selectedBannedFoods.length} yemek`);
                }
                
                // GitHub'a kaydet
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    yasaklar: yasaklar
                }, null, 2);
                
                const commitMsg = selectedBannedFoods.length > 0
                    ? `Yemek yasakları: ${currentFoodName} ⛔ ${selectedBannedFoods.join(', ')}`
                    : `Yemek yasakları silindi: ${currentFoodName}`;
                
                await saveToGitHub('data/yemek_veritabani_yasaklar.json', jsonContent, commitMsg);
                
                console.log('✅ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i güncelle
                yemekVeritabaniYasaklar = yasaklar;
                
                // Sayfa yenile
                console.log('🔄 Yemek yasakları kaydedildi, sayfa yenileniyor...');
                renderWeekContent();
                
                alert(selectedBannedFoods.length > 0
                    ? `✅ Yasak kuralları kaydedildi!\n\n${selectedBannedFoods.length} yasak yemek:\n${selectedBannedFoods.join('\n')}`
                    : `✅ Yasak kuralları kaldırıldı!\n\n${currentFoodName}`
                );
                
            } catch (error) {
                console.error('❌ Kaydetme hatası:', error);
                alert(`❌ Kaydetme hatası:\n\n${error.message}`);
            }
        }

        // ========================================
        // 🔍 ROL & KATEGORİ UYUMSUZLUK KONTROL ARACI
        // ========================================
        
        /**
         * Tüm haftalardaki yemeklerin rol/kategori değerlerini food_list.json ile karşılaştır
         * Console'dan çağırılabilir: checkRoleCategoryMismatches()
         */
        window.checkRoleCategoryMismatches = async function() {
            console.log('=== 🔍 ROL & KATEGORİ UYUMSUZLUK KONTROLÜ ===');
            
            // food_list.json yüklenmemişse yükle
            if (!foodData || foodData.length === 0) {
                console.log('📥 food_list.json yükleniyor...');
                await loadFoodData();
            }
            
            const mismatches = [];
            const missing = [];
            const correct = [];
            
            // Tüm haftaları tara
            weeks.forEach((week, wIdx) => {
                week.days.forEach((day, dIdx) => {
                    const meals = day.meals || day.ogunler || [];
                    meals.forEach((meal, mIdx) => {
                        const foods = meal.yemekler || [];
                        foods.forEach((food, fIdx) => {
                            const foodName = food.foodName || food.name;
                            if (!foodName) return;
                            
                            // food_list.json'da bul
                            const dbFood = findFoodInDatabase(foodName);
                            
                            if (!dbFood) {
                                // Veritabanında yok
                                missing.push({
                                    location: `Hafta ${wIdx + 1} > ${day.name} > ${meal.ogunAdi || meal.name}`,
                                    foodName: foodName,
                                    menuRole: food.role || '(boş)',
                                    menuCategory: food.category || '(boş)'
                                });
                            } else {
                                // Veritabanında var - karşılaştır
                                const roleMatch = (food.role || '') === (dbFood.role || '');
                                const categoryMatch = (food.category || '') === (dbFood.category || '');
                                
                                if (!roleMatch || !categoryMatch) {
                                    // Uyumsuzluk var
                                    mismatches.push({
                                        location: `Hafta ${wIdx + 1} > ${day.name} > ${meal.ogunAdi || meal.name}`,
                                        foodName: foodName,
                                        menuRole: food.role || '(boş)',
                                        dbRole: dbFood.role || '(boş)',
                                        roleMatch: roleMatch ? '✅' : '❌',
                                        menuCategory: food.category || '(boş)',
                                        dbCategory: dbFood.category || '(boş)',
                                        categoryMatch: categoryMatch ? '✅' : '❌',
                                        weekIdx: wIdx,
                                        dayIdx: dIdx,
                                        mealIdx: mIdx,
                                        foodIdx: fIdx
                                    });
                                } else {
                                    // Her şey uyumlu
                                    correct.push({ foodName, location: `Hafta ${wIdx + 1} > ${day.name}` });
                                }
                            }
                        });
                    });
                });
            });
            
            console.log('\n📊 SONUÇLAR:');
            console.log(`✅ Uyumlu yemekler: ${correct.length}`);
            console.log(`❌ Uyumsuz yemekler: ${mismatches.length}`);
            console.log(`⚠️ Veritabanında bulunamayan: ${missing.length}`);
            
            if (mismatches.length > 0) {
                console.log('\n❌ UYUMSUZLUKLAR:');
                console.table(mismatches);
            }
            
            if (missing.length > 0) {
                console.log('\n⚠️ VERİTABANINDA BULUNAMAYAN:');
                console.table(missing);
            }
            
            // Otomatik düzeltme fonksiyonu
            window.fixAllRoleCategoryMismatches = function() {
                console.log('🔧 Tüm uyumsuzluklar düzeltiliyor...');
                
                let fixedCount = 0;
                mismatches.forEach(mismatch => {
                    const week = weeks[mismatch.weekIdx];
                    const day = week.days[mismatch.dayIdx];
                    const meal = (day.meals || day.ogunler)[mismatch.mealIdx];
                    const food = meal.yemekler[mismatch.foodIdx];
                    
                    const dbFood = findFoodInDatabase(mismatch.foodName);
                    if (dbFood) {
                        food.role = dbFood.role || '';
                        food.category = dbFood.category || '';
                        fixedCount++;
                    }
                });
                
                console.log(`✅ ${fixedCount} uyumsuzluk düzeltildi!`);
                renderWeekContent();
                
                // Hafta verilerini kaydet
                saveWeeks(); // ✅ Doğru fonksiyon adı
            };
            
            if (mismatches.length > 0) {
                console.log('\n💡 Tüm uyumsuzlukları otomatik düzeltmek için: fixAllRoleCategoryMismatches()');
            }
        };

        // ========================================
        // ADMIN FONKSİYONLARI SONU
        // ========================================

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
        
        // Admin UI'yi başlat (biraz gecikmeyle - AdminAuth yüklensin diye)
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(initAdminUI, 500);
        });
    </script>
    <script src="auth.js"></script>
    <script>
        // Check if PatientAuth is loaded
        if (typeof PatientAuth === 'undefined') {
            console.error('❌ PatientAuth yüklenemedi!');
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545;">Kimlik doğrulama sistemi yüklenemedi</h3>
                    <p>Lütfen sayfayı yenileyin veya giriş sayfasına dönün.</p>
                    <button onclick="window.location.href='login.html'" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Giriş Sayfasına Dön
                    </button>
                </div>
            `;
        }

        // PDF Modal Functions
        function openPdfModal(pdfUrl) {
            const modal = document.getElementById('pdfModal');
            const imgViewer = document.getElementById('pdfImageViewer');
            const iframeViewer = document.getElementById('pdfIframeViewer');
            const errorMessage = document.getElementById('pdfErrorMessage');
            const directLink = document.getElementById('pdfDirectLink');
            
            // Reset viewers
            imgViewer.style.display = 'none';
            iframeViewer.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Dosya uzantısını kontrol et
            const fileExt = pdfUrl.toLowerCase().split('.').pop().split('?')[0];
            
            if (fileExt === 'jpg' || fileExt === 'jpeg' || fileExt === 'png' || fileExt === 'gif' || fileExt === 'webp') {
                // Resim dosyası - direkt göster
                imgViewer.src = pdfUrl;
                imgViewer.style.display = 'block';
            } else if (fileExt === 'pdf') {
                // PDF dosyası - iframe ile deneme (GitHub raw PDF'ler genelde çalışmaz)
                // Önce iframe dene, yüklenemezse hata mesajı göster
                iframeViewer.src = pdfUrl;
                iframeViewer.style.display = 'block';
                
                // 2 saniye sonra yükleme kontrolü
                setTimeout(() => {
                    // Eğer iframe yüklenmediyse hata mesajı göster
                    try {
                        // iframe contentDocument erişilebilir mi kontrol et
                        const iframeDoc = iframeViewer.contentDocument || iframeViewer.contentWindow.document;
                        if (!iframeDoc) throw new Error('Cannot access iframe');
                    } catch (error) {
                        // GitHub X-Frame-Options engeli - hata mesajı göster
                        iframeViewer.style.display = 'none';
                        errorMessage.style.display = 'block';
                        directLink.href = pdfUrl;
                    }
                }, 2000);
            } else {
                // Bilinmeyen format - direkt link göster
                errorMessage.style.display = 'block';
                directLink.href = pdfUrl;
            }
            
            // Modal'ı göster
            modal.style.display = 'block';
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const imgViewer = document.getElementById('pdfImageViewer');
            const iframeViewer = document.getElementById('pdfIframeViewer');
            
            modal.style.display = 'none';
            imgViewer.src = '';
            iframeViewer.src = '';
        }

        // Mobil Versiyon Toggle Functions
        function openMobileVersion() {
            const mobileContainer = document.getElementById('mobileIframeContainer');
            const mainContainer = document.getElementById('mainContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const btnBack = document.getElementById('btnBack');
            
            // iframe URL'ini set et - lokal dosya
            mobileIframe.src = 'mobil_versiyon_v1.html';
            
            // Ana içeriği gizle, mobil versiyonu göster
            mainContainer.style.display = 'none';
            mobileContainer.style.display = 'block';
            btnBack.style.display = 'flex';
            
            console.log('� Alternatif yemek arama sayfası açıldı');
        }

        function closeMobileVersion() {
            const mobileContainer = document.getElementById('mobileIframeContainer');
            const mainContainer = document.getElementById('mainContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const btnBack = document.getElementById('btnBack');
            
            // iframe'i temizle
            mobileIframe.src = '';
            
            // Mobil versiyonu gizle, ana içeriği göster
            mobileContainer.style.display = 'none';
            mainContainer.style.display = 'flex';
            btnBack.style.display = 'none';
            
            console.log('◀ Ana sayfaya dönüldü');
        }
    </script>

    <!-- 🔧 ADMIN YEMEK EŞLEŞTİRME MODALI (5 TAB) -->
    <div id="adminFoodModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 12px; max-height: 90vh; overflow-y: auto;">
            
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #FF6B6B; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 24px; font-weight: 700;">
                    <span id="modal_food_name"></span>
                </h2>
                <button onclick="closeAdminFoodModal()" style="background: #f44336; color: white; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; border-radius: 6px;">✖ Kapat</button>
            </div>

            <!-- Tab Navigation -->
            <div class="admin-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 5px; flex-wrap: wrap;">
                <button class="admin-tab-btn active" data-tab="manuel" onclick="switchAdminTab('manuel')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    📝 Manuel Eşleştirme
                </button>
                <button class="admin-tab-btn" data-tab="yasak" onclick="switchAdminTab('yasak')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    🚫 Eşleşme Yasakları
                </button>
                <button class="admin-tab-btn" data-tab="db-eslestirme" onclick="switchAdminTab('db-eslestirme')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    🍽️ Yemek Veritabanı Eşleştirme
                </button>
                <button class="admin-tab-btn" data-tab="db-yasak" onclick="switchAdminTab('db-yasak')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    ⛔ Yemek Veritabanı Yasakları
                </button>
                <button class="admin-tab-btn" data-tab="db-ekle" onclick="switchAdminTab('db-ekle')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    ➕ Veritabanına Ekle
                </button>
                <button class="admin-tab-btn" data-tab="github-settings" onclick="switchAdminTab('github-settings')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    🔑 GitHub Token
                </button>
            </div>

            <!-- Tab 1: Manuel Eşleştirme (Tarif Kartları) -->
            <div id="admin-tab-manuel" class="admin-tab-content" style="display: block;">
                <h3 style="color: #667eea; margin-bottom: 15px;">📝 Manuel Eşleştirme (Tarif Kartları)</h3>
                <p style="color: #666; margin-bottom: 20px;">Menü kartındaki yemek adını, tarif kartlarındaki bir yemekle manuel olarak eşleştirin.</p>
                
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Menü Kartındaki Yemek Adı:</label>
                    <input type="text" id="admin_manuel_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Tarif Kartındaki Yemek Adı (Eşleştirilecek):</label>
                    <input type="text" id="admin_manuel_tarif_adi" placeholder="Örn: Kuru Fasulye" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveManuelEslestirme()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        💾 Manuel Eşleştirmeyi Kaydet
                    </button>
                </div>
                
                <!-- Mevcut Eşleştirmeler -->
                <div id="admin_manuel_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Manuel Eşleştirmeler:</h4>
                    <p style="color: #999;">Yükleniyor...</p>
                </div>
            </div>

            <!-- Tab 2: Eşleşme Yasakları (Tarif Kartları) -->
            <div id="admin-tab-yasak" class="admin-tab-content" style="display: none;">
                <h3 style="color: #f44336; margin-bottom: 15px;">🚫 Eşleşme Yasakları (Tarif Kartları)</h3>
                <p style="color: #666; margin-bottom: 20px;">Menü kartındaki yemek adının, tarif kartlarındaki belirli yemeklerle eşleşmesini yasaklayın.</p>
                
                <div style="background: #fff3f3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Menü Kartındaki Yemek Adı:</label>
                    <input type="text" id="admin_yasak_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Yasaklanacak Tarif Kartı Adı:</label>
                    <input type="text" id="admin_yasak_tarif_adi" placeholder="Örn: Mercimek Çorbası" style="width: 100%; padding: 12px; border: 2px solid #f44336; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveYasakKurali()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        🚫 Yasak Kuralını Kaydet
                    </button>
                </div>
                
                <div id="admin_yasak_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Yasak Kuralları:</h4>
                    <p style="color: #999;">Yükleniyor...</p>
                </div>
            </div>

            <!-- Tab 3: Yemek Veritabanı Eşleştirme -->
            <div id="admin-tab-db-eslestirme" class="admin-tab-content" style="display: none;">
                <h3 style="color: #4caf50; margin-bottom: 15px;">🍽️ Yemek Veritabanı Eşleştirme</h3>
                <p style="color: #666; margin-bottom: 20px;">Menü kartındaki yemek adını, food_list.json veritabanındaki bir yemekle eşleştirin.</p>
                
                <div style="background: #f1f8f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Menü Kartındaki Yemek Adı:</label>
                    <input type="text" id="admin_db_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Veritabanındaki Yemek Adı (food_list.json):</label>
                    <input type="text" id="admin_db_eslestirme_adi" placeholder="Örn: Kuru Fasulye (Zeytinyağlı)" style="width: 100%; padding: 12px; border: 2px solid #4caf50; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveDbEslestirme()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        💾 Veritabanı Eşleştirmesini Kaydet
                    </button>
                </div>
                
                <div id="admin_db_eslestirme_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Veritabanı Eşleştirmeleri:</h4>
                    <p style="color: #999;">Yükleniyor...</p>
                </div>
            </div>

            <!-- Tab 4: Yemek Veritabanı Yasakları -->
            <div id="admin-tab-db-yasak" class="admin-tab-content" style="display: none;">
                <h3 style="color: #ff9800; margin-bottom: 15px;">⛔ Yemek Veritabanı Yasakları</h3>
                <p style="color: #666; margin-bottom: 20px;">Menü kartındaki yemek adının, food_list.json veritabanındaki belirli yemeklerle eşleşmesini yasaklayın.</p>
                
                <div style="background: #fff8e1; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Menü Kartındaki Yemek Adı:</label>
                    <input type="text" id="admin_db_yasak_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Yasaklanacak Veritabanı Yemek Adı:</label>
                    <input type="text" id="admin_db_yasak_adi" placeholder="Örn: Mercimek Çorbası (Zeytinyağlı)" style="width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveDbYasakKurali()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        ⛔ Veritabanı Yasak Kuralını Kaydet
                    </button>
                </div>
                
                <div id="admin_db_yasak_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Veritabanı Yasak Kuralları:</h4>
                    <p style="color: #999;">Yükleniyor...</p>
                </div>
            </div>

            <!-- Tab 5: Veritabanına Ekle -->
            <div id="admin-tab-db-ekle" class="admin-tab-content" style="display: none;">
                <form id="addFoodForm" onsubmit="event.preventDefault(); saveYeniYemek();" style="max-height: 70vh; overflow-y: auto; padding-right: 15px;">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yemek Adı *</label>
                        <input type="text" id="admin_db_ekle_yemek_adi" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; background: #fff;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kalori (kcal) *</label>
                            <input type="number" id="admin_db_ekle_kalori" step="0.1" readonly required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; background: #f0f0f0; cursor: not-allowed;" title="Otomatik hesaplanır: (Karb×4) + (Protein×4) + (Yağ×9)">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Protein (g) *</label>
                            <input type="number" id="admin_db_ekle_protein" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Karbonhidrat (g) *</label>
                            <input type="number" id="admin_db_ekle_karb" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yağ (g) *</label>
                            <input type="number" id="admin_db_ekle_yag" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kategori *</label>
                            <select id="admin_db_ekle_kategori" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                                <option value="">-- Kategori Seçin --</option>
                                <option value="KAHVALTI">KAHVALTI</option>
                                <option value="ÖĞLEN">ÖĞLEN</option>
                                <option value="AKŞAM">AKŞAM</option>
                                <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                                <option value="ÇORBALAR">ÇORBALAR</option>
                                <option value="SALATALAR">SALATALAR</option>
                                <option value="ANA YEMEKLER">ANA YEMEKLER</option>
                                <option value="TOSTLAR">TOSTLAR</option>
                                <option value="TATLILAR">TATLILAR</option>
                                <option value="İÇECEKLER">İÇECEKLER</option>
                                <option value="ATIŞTIRILMALIKLAR">ATIŞTIRILMALIKLAR</option>
                                <option value="EKMEKLER">EKMEKLER</option>
                                <option value="PİLAVLAR">PİLAVLAR</option>
                                <option value="DİĞER">DİĞER</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rol *</label>
                            <select id="admin_db_ekle_rol" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                                <option value="">-- Rol Seçin --</option>
                                <option value="mainDish">Ana Yemek (mainDish)</option>
                                <option value="sideDish">Yan Yemek (sideDish)</option>
                                <option value="drink">İçecek (drink)</option>
                                <option value="supplement">Takviye (supplement)</option>
                                <option value="snack">Atıştırmalık (snack)</option>
                                <option value="soup">Çorba (soup)</option>
                                <option value="salad">Salata (salad)</option>
                                <option value="bread">Ekmek (bread)</option>
                                <option value="dessert">Tatlı (dessert)</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Öğün Tipi (Birden fazla seçilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_breakfast" value="breakfast">
                                🌅 Kahvaltı
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_lunch" value="lunch">
                                ☀️ Öğle
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_dinner" value="dinner">
                                🌙 Akşam
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porsiyon Çarpanı</label>
                        <input type="number" id="admin_db_ekle_portion" step="0.1" value="1" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Diyet Tipleri (Birden fazla seçilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_ketojenik" value="ketojenik">
                                🥗 Ketojenik
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_akdeniz" value="akdeniz">
                                🌊 Akdeniz
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_vegan" value="vegan">
                                🌱 Vegan
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_glutensiz" value="glutensiz">
                                🌾 Glutensiz
                            </label>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Min Miktar</label>
                            <input type="number" id="admin_db_ekle_min" step="0.1" placeholder="Minimum porsiyon" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Max Miktar</label>
                            <input type="number" id="admin_db_ekle_max" step="0.1" placeholder="Maksimum porsiyon" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Adım (Step)</label>
                            <input type="number" id="admin_db_ekle_step" step="0.1" placeholder="Artış miktarı" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porsiyon Çarpanı</label>
                            <input type="number" id="admin_db_ekle_portion2" step="0.1" value="1" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Sezon Başlangıç (Ay)</label>
                            <input type="number" id="admin_db_ekle_season_min" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Sezon Bitiş (Ay)</label>
                            <input type="number" id="admin_db_ekle_season_max" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">🏷️ Özel Özellikler</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_keto">
                                🥗 Keto
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_lowcarb">
                                📉 Düşük Karb
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_portionFixed">
                                🔒 Porsiyon Sabit
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_fillerLunch">
                                🍽️ Öğle Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_fillerDinner">
                                🌙 Akşam Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_reversedSeason">
                                🔄 Ters Sezon
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">🏷️ Etiketler (Tags) - virgülle ayırın</label>
                        <input type="text" id="admin_db_ekle_tags" placeholder="ör: domates, meyve, salata" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">✅ Uyumluluk Etiketleri (compatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="admin_db_ekle_compat" placeholder="ör: tavuk, zeytinyağı" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">❌ Uyumsuzluk Etiketleri (incompatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="admin_db_ekle_incompat" placeholder="ör: süt, peynir" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">📝 Notlar</label>
                        <textarea id="admin_db_ekle_notes" placeholder="Ek bilgiler, özel notlar..." style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="closeAdminFoodModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            İptal
                        </button>
                        <button type="submit" style="flex: 2; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            💾 Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab 6: GitHub Token Ayarları -->
            <div id="admin-tab-github-settings" class="admin-tab-content" style="display: none;">
                <h3 style="color: #2196f3; margin-bottom: 15px;">🔑 GitHub Token Ayarları</h3>
                <p style="color: #666; margin-bottom: 20px;">food_list.json'a yemek eklemek/düzenlemek için GitHub Personal Access Token gereklidir.</p>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">📚 Token Nasıl Alınır?</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #555;">
                        <li>GitHub'da <a href="https://github.com/settings/tokens" target="_blank" style="color: #2196f3; text-decoration: underline;">Settings → Developer Settings → Personal Access Tokens</a> sayfasına gidin</li>
                        <li>"Generate new token" (Classic) butonuna tıklayın</li>
                        <li>Token adı: "Lipodem Takip Paneli"</li>
                        <li>Yetki seçimi: <strong>repo</strong> (tüm repo yetkisi)</li>
                        <li>"Generate token" butonuna tıklayın</li>
                        <li>Token'ı kopyalayıp aşağıya yapıştırın</li>
                    </ol>
                    <p style="margin: 10px 0 0 0; font-size: 13px; color: #ff6b6b;">
                        ⚠️ <strong>Önemli:</strong> Token sadece bir kez gösterilir! Kopyalamayı unutmayın!
                    </p>
                </div>
                
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">GitHub Personal Access Token:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="password" id="github_token_input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="flex: 1; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; font-family: monospace;">
                        <button onclick="toggleTokenVisibility()" style="background: #6c757d; color: white; border: none; padding: 12px 20px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            �️ Göster
                        </button>
                    </div>
                    
                    <div id="token_status" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                        <!-- Token durumu buraya gelecek -->
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveGithubToken()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            💾 Token'ı Kaydet
                        </button>
                        <button onclick="testGithubToken()" style="flex: 1; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            🧪 Token'ı Test Et
                        </button>
                        <button onclick="clearGithubToken()" style="background: #f44336; color: white; border: none; padding: 15px 20px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            🗑️ Temizle
                        </button>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">🔒 Güvenlik Notu</h4>
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        Token tarayıcınızın localStorage'ında saklanır. Sadece sizin bilgisayarınızda kalır, sunucuya gönderilmez. 
                        Yine de token'ınızı kimseyle paylaşmayın ve düzenli olarak yenileyin.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // �🔧 ADMIN MODAL FONKSİYONLARI
        
        // GitHub Token Fonksiyonları
        function toggleTokenVisibility() {
            const input = document.getElementById('github_token_input');
            const btn = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '🙈 Gizle';
            } else {
                input.type = 'password';
                btn.textContent = '👁️ Göster';
            }
        }
        
        function saveGithubToken() {
            const token = document.getElementById('github_token_input').value.trim();
            
            if (!token) {
                showTokenStatus('⚠️ Lütfen token girin!', 'error');
                return;
            }
            
            // Token formatı kontrolü (ghp_ ile başlamalı)
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showTokenStatus('⚠️ Geçersiz token formatı! Token "ghp_" veya "github_pat_" ile başlamalıdır.', 'error');
                return;
            }
            
            // localStorage'a kaydet
            try {
                localStorage.setItem('github_token', token);
                showTokenStatus('✅ Token başarıyla kaydedildi!', 'success');
                console.log('✅ GitHub token kaydedildi');
            } catch (error) {
                showTokenStatus('❌ Token kaydedilemedi: ' + error.message, 'error');
                console.error('❌ Token kaydetme hatası:', error);
            }
        }
        
        async function testGithubToken() {
            const token = localStorage.getItem('github_token');
            
            if (!token) {
                showTokenStatus('⚠️ Önce token kaydedin!', 'error');
                return;
            }
            
            showTokenStatus('🔄 Token test ediliyor...', 'info');
            
            try {
                // GitHub API'ye basit bir istek at
                const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showTokenStatus(`✅ Token geçerli! Repo erişimi başarılı.\n\nRepo: ${data.full_name}\nSon güncelleme: ${new Date(data.updated_at).toLocaleString('tr-TR')}`, 'success');
                } else if (response.status === 401) {
                    showTokenStatus('❌ Token geçersiz veya süresi dolmuş!', 'error');
                } else if (response.status === 404) {
                    showTokenStatus('❌ Repo bulunamadı! Token\'ın repo erişim yetkisi var mı kontrol edin.', 'error');
                } else {
                    showTokenStatus(`❌ Test başarısız: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showTokenStatus('❌ Test hatası: ' + error.message, 'error');
                console.error('❌ Token test hatası:', error);
            }
        }
        
        function clearGithubToken() {
            if (confirm('🗑️ GitHub token\'ını silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!')) {
                localStorage.removeItem('github_token');
                document.getElementById('github_token_input').value = '';
                showTokenStatus('✅ Token silindi!', 'success');
                console.log('🗑️ GitHub token silindi');
            }
        }
        
        function showTokenStatus(message, type) {
            const statusDiv = document.getElementById('token_status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            // Renk ayarları
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            }
            
            // 5 saniye sonra gizle (success/info için)
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Sayfa yüklendiğinde mevcut token'ı göster
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                document.getElementById('github_token_input').value = savedToken;
                showTokenStatus('ℹ️ Kayıtlı token bulundu. Test edebilir veya değiştirebilirsiniz.', 'info');
            }
        });
        
        // ❌ ESKİ switchAdminTab fonksiyonu KALDIRILDI (line 5512'deki yeni versiyonu kullan)
        // Çünkü renderTarifManuelTab() gibi fonksiyonları çağırmıyordu!
        
        function closeAdminFoodModal() {
            const modal = document.getElementById('adminFoodModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 💾 KAYDETME FONKSİYONLARI (Placeholder - GitHub API ile entegre edilecek)
        
        function saveManuelEslestirme() {
            const menuYemek = document.getElementById('admin_manuel_yemek_adi').value;
            const tarifYemek = document.getElementById('admin_manuel_tarif_adi').value;
            
            if (!tarifYemek.trim()) {
                alert('⚠️ Lütfen tarif kartındaki yemek adını girin!');
                return;
            }
            
            console.log('📝 Manuel Eşleştirme:', { menuYemek, tarifYemek });
            alert('✅ Manuel eşleştirme kaydedildi!\n\n' + 
                  'Menü: ' + menuYemek + '\n' + 
                  'Tarif: ' + tarifYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/manuel_eslestirmeler.json'a kaydet
        }
        
        function saveYasakKurali() {
            const menuYemek = document.getElementById('admin_yasak_yemek_adi').value;
            const tarifYemek = document.getElementById('admin_yasak_tarif_adi').value;
            
            if (!tarifYemek.trim()) {
                alert('⚠️ Lütfen yasaklanacak tarif kartı adını girin!');
                return;
            }
            
            console.log('🚫 Yasak Kuralı:', { menuYemek, tarifYemek });
            alert('✅ Yasak kuralı kaydedildi!\n\n' +
                  'Menü: ' + menuYemek + '\n' +
                  'Yasak Tarif: ' + tarifYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/eslesmeme_kurallari.json'a kaydet
        }
        
        function saveDbEslestirme() {
            const menuYemek = document.getElementById('admin_db_yemek_adi').value;
            const dbYemek = document.getElementById('admin_db_eslestirme_adi').value;
            
            if (!dbYemek.trim()) {
                alert('⚠️ Lütfen veritabanındaki yemek adını girin!');
                return;
            }
            
            console.log('🍽️ Veritabanı Eşleştirme:', { menuYemek, dbYemek });
            alert('✅ Veritabanı eşleştirmesi kaydedildi!\n\n' +
                  'Menü: ' + menuYemek + '\n' +
                  'Veritabanı: ' + dbYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/yemek_veritabani_eslestirme.json'a kaydet
        }
        
        function saveDbYasakKurali() {
            const menuYemek = document.getElementById('admin_db_yasak_yemek_adi').value;
            const dbYemek = document.getElementById('admin_db_yasak_adi').value;
            
            if (!dbYemek.trim()) {
                alert('⚠️ Lütfen yasaklanacak veritabanı yemek adını girin!');
                return;
            }
            
            console.log('⛔ Veritabanı Yasak Kuralı:', { menuYemek, dbYemek });
            alert('✅ Veritabanı yasak kuralı kaydedildi!\n\n' +
                  'Menü: ' + menuYemek + '\n' +
                  'Yasak Veritabanı: ' + dbYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/yemek_veritabani_yasaklar.json'a kaydet
        }
        
        // Kalori otomatik hesaplama (Tab 5 için)
        function calculateKaloriForAddFood() {
            const protein = parseFloat(document.getElementById('admin_db_ekle_protein').value) || 0;
            const karb = parseFloat(document.getElementById('admin_db_ekle_karb').value) || 0;
            const yag = parseFloat(document.getElementById('admin_db_ekle_yag').value) || 0;
            
            // Kalori = (Protein × 4) + (Karb × 4) + (Yağ × 9)
            const kalori = (protein * 4) + (karb * 4) + (yag * 9);
            
            document.getElementById('admin_db_ekle_kalori').value = kalori.toFixed(1);
        }
        
        function saveYeniYemek() {
            // Tüm form verilerini topla
            const yemekAdi = document.getElementById('admin_db_ekle_yemek_adi').value;
            const kalori = parseFloat(document.getElementById('admin_db_ekle_kalori').value);
            const protein = parseFloat(document.getElementById('admin_db_ekle_protein').value);
            const karb = parseFloat(document.getElementById('admin_db_ekle_karb').value);
            const yag = parseFloat(document.getElementById('admin_db_ekle_yag').value);
            const kategori = document.getElementById('admin_db_ekle_kategori').value;
            const rol = document.getElementById('admin_db_ekle_rol').value;
            
            // Zorunlu alanları kontrol et
            if (!yemekAdi || !kalori || !protein || !karb || !yag || !kategori || !rol) {
                alert('⚠️ Lütfen zorunlu alanları doldurun (Yemek Adı, Makrolar, Kategori, Rol)!');
                return;
            }
            
            // Öğün tipleri
            const mealTypes = [];
            if (document.getElementById('admin_mealType_breakfast').checked) mealTypes.push('breakfast');
            if (document.getElementById('admin_mealType_lunch').checked) mealTypes.push('lunch');
            if (document.getElementById('admin_mealType_dinner').checked) mealTypes.push('dinner');
            
            // Diyet tipleri
            const dietTypes = [];
            if (document.getElementById('admin_dietType_ketojenik').checked) dietTypes.push('ketojenik');
            if (document.getElementById('admin_dietType_akdeniz').checked) dietTypes.push('akdeniz');
            if (document.getElementById('admin_dietType_vegan').checked) dietTypes.push('vegan');
            if (document.getElementById('admin_dietType_glutensiz').checked) dietTypes.push('glutensiz');
            
            // Özel özellikler
            const ozelOzellikler = {
                keto: document.getElementById('admin_keto').checked,
                lowcarb: document.getElementById('admin_lowcarb').checked,
                portionFixed: document.getElementById('admin_portionFixed').checked,
                fillerLunch: document.getElementById('admin_fillerLunch').checked,
                fillerDinner: document.getElementById('admin_fillerDinner').checked,
                isReversedSeason: document.getElementById('admin_reversedSeason').checked
            };
            
            // Etiketler
            const tags = document.getElementById('admin_db_ekle_tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            const compatibilityTags = document.getElementById('admin_db_ekle_compat').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            const incompatibilityTags = document.getElementById('admin_db_ekle_incompat').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            
            // Sezon range
            const seasonMin = parseInt(document.getElementById('admin_db_ekle_season_min').value);
            const seasonMax = parseInt(document.getElementById('admin_db_ekle_season_max').value);
            const seasonRange = (seasonMin && seasonMax) ? `[${seasonMin},${seasonMax}]` : undefined;
            
            // Yeni yemek objesi oluştur (food_list.json formatında - TAM PARAMETRELER)
            const yeniYemek = {
                name: yemekAdi,
                category: kategori,
                calories: kalori,
                protein: protein,
                carbs: karb,
                fat: yag,
                multiplier: parseFloat(document.getElementById('admin_db_ekle_portion').value) || 1,
                role: rol
            };
            
            // Opsiyonel parametreler - sadece dolu olanları ekle
            const minQuantity = parseFloat(document.getElementById('admin_db_ekle_min').value);
            if (!isNaN(minQuantity) && minQuantity > 0) yeniYemek.minQuantity = minQuantity;
            
            const maxQuantity = parseFloat(document.getElementById('admin_db_ekle_max').value);
            if (!isNaN(maxQuantity) && maxQuantity > 0) yeniYemek.maxQuantity = maxQuantity;
            
            const step = parseFloat(document.getElementById('admin_db_ekle_step').value);
            if (!isNaN(step) && step > 0) yeniYemek.step = step;
            
            // Öğün tipleri (boş array bile ekle - JSON formatı için gerekli)
            yeniYemek.mealType = mealTypes;
            
            // Diyet tipleri (boş array bile ekle)
            if (dietTypes.length > 0) yeniYemek.dietTypes = dietTypes;
            
            // Boolean özellikler (her zaman ekle - JSON formatı için gerekli)
            yeniYemek.keto = ozelOzellikler.keto;
            yeniYemek.lowcarb = ozelOzellikler.lowcarb;
            yeniYemek.portionFixed = ozelOzellikler.portionFixed;
            yeniYemek.fillerLunch = ozelOzellikler.fillerLunch;
            yeniYemek.fillerDinner = ozelOzellikler.fillerDinner;
            yeniYemek.isReversedSeason = ozelOzellikler.isReversedSeason;
            
            // Etiketler (boş array bile ekle - JSON formatı için gerekli)
            yeniYemek.tags = tags;
            yeniYemek.compatibilityTags = compatibilityTags;
            yeniYemek.incompatibilityTags = incompatibilityTags;
            
            // Sezon range (varsa ekle)
            if (seasonRange) yeniYemek.seasonRange = seasonRange;
            
            // Notlar (varsa ekle)
            const notes = document.getElementById('admin_db_ekle_notes').value.trim();
            if (notes) yeniYemek.notes = notes;
            
            console.log('➕ Yeni Yemek (food_list.json formatı):', JSON.stringify(yeniYemek, null, 2));
            
            // GitHub API ile kaydet
            saveFoodToGitHub(yeniYemek);
        }
        
        // GitHub'a yemek kaydetme fonksiyonu
        async function saveFoodToGitHub(yemekObj) {
            try {
                const GITHUB_TOKEN = localStorage.getItem('github_token');
                if (!GITHUB_TOKEN) {
                    alert('⚠️ GitHub token bulunamadı!\n\nLütfen önce GitHub token\'ınızı ayarlayın.');
                    return;
                }
                
                const OWNER = 'mustafasacar35';
                const REPO = 'lipodem-takip-paneli';
                const BRANCH = 'main';
                const FILE_PATH = 'food_list.json';
                
                // 1. Mevcut dosyayı çek
                console.log('📥 food_list.json çekiliyor...');
                const getResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!getResponse.ok) {
                    throw new Error(`Dosya çekilemedi: ${getResponse.status} ${getResponse.statusText}`);
                }
                
                const fileData = await getResponse.json();
                const currentContent = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
                const currentJson = JSON.parse(currentContent);
                
                // 2. Yemeği kategoriye ekle veya güncelle
                console.log('🔍 Kategori bulunuyor:', yemekObj.category);
                
                let categoryFound = false;
                let foodUpdated = false;
                
                // Kategorilerde ara
                for (let cat of currentJson.categories) {
                    if (cat.name === yemekObj.category) {
                        categoryFound = true;
                        
                        // Aynı isimde yemek var mı kontrol et
                        const existingIndex = cat.items.findIndex(item => item.name === yemekObj.name);
                        
                        if (existingIndex !== -1) {
                            // GÜNCELLEME
                            cat.items[existingIndex] = yemekObj;
                            foodUpdated = true;
                            console.log('✏️ Mevcut yemek güncellendi:', yemekObj.name);
                        } else {
                            // YENİ EKLEME
                            cat.items.push(yemekObj);
                            console.log('➕ Yeni yemek kategoriye eklendi:', yemekObj.name);
                        }
                        break;
                    }
                }
                
                // Kategori yoksa yeni kategori oluştur
                if (!categoryFound) {
                    console.log('🆕 Yeni kategori oluşturuluyor:', yemekObj.category);
                    currentJson.categories.push({
                        name: yemekObj.category,
                        items: [yemekObj]
                    });
                }
                
                // 3. Metadata güncelle
                currentJson.lastUpdated = new Date().toISOString();
                
                // 4. JSON'u string'e çevir (✅ TÜRKÇE KARAKTER KORUYAN)
                const updatedContent = JSON.stringify(currentJson, null, 2);
                const encodedContent = encodeBase64UTF8(updatedContent);
                
                // 5. GitHub'a commit et
                console.log('💾 GitHub\'a kaydediliyor...');
                const commitMessage = foodUpdated 
                    ? `Yemek güncellendi: ${yemekObj.name}`
                    : `Yeni yemek eklendi: ${yemekObj.name}`;
                
                const putResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: commitMessage,
                            content: encodedContent,
                            sha: fileData.sha,
                            branch: BRANCH
                        })
                    }
                );
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub commit başarısız: ${putResponse.status} - ${errorData.message}`);
                }
                
                const commitData = await putResponse.json();
                console.log('✅ GitHub\'a kaydedildi:', commitData.commit.sha);
                
                // ✅ Başarı mesajı (toast - daha az invasive)
                showToast(`✅ ${foodUpdated ? 'Yemek güncellendi' : 'Yeni yemek eklendi'}: ${yemekObj.name}`, 'success');
                
                // 🔄 foodData'yı ANINDA yenile (GitHub'dan değil, local'de güncelle - daha hızlı)
                await updateLocalFoodData(yemekObj);
                
                // 🎨 Render'ı ANINDA güncelle (kullanıcı değişikliği görsün)
                renderWeekContent();
                
                // 📋 selectedFoodForAdmin varsa (menü kartından açıldıysa) o kartı da güncelle
                if (window.selectedFoodForAdmin) {
                    const { weekIndex, dayIndex, mealIndex, foodIndex } = window.selectedFoodForAdmin;
                    updateFoodInMenu(weekIndex, dayIndex, mealIndex, foodIndex, yemekObj);
                }
                
                // 🚪 Modal'ı kapat
                closeAdminFoodModal();
                
            } catch (error) {
                console.error('❌ GitHub kaydetme hatası:', error);
                alert(`❌ Kaydetme başarısız!\n\n${error.message}\n\nLütfen GitHub token\'ınızı kontrol edin.`);
            }
        }
        
        /**
         * 🔄 Local foodData'yı güncelle (GitHub'dan yeniden yüklemeden)
         * Performance optimization - ANINDA güncelleme için
         */
        async function updateLocalFoodData(yemekObj) {
            try {
                // foodData'da ara
                const existingIndex = foodData.findIndex(f => 
                    normalizeTr(f.name) === normalizeTr(yemekObj.name)
                );
                
                if (existingIndex !== -1) {
                    // GÜNCELLEME - mevcut yemeği değiştir
                    foodData[existingIndex] = { ...foodData[existingIndex], ...yemekObj };
                    console.log('🔄 Local foodData güncellendi:', yemekObj.name);
                } else {
                    // YENİ EKLEME - array'e ekle
                    foodData.push(yemekObj);
                    console.log('➕ Local foodData\'ya eklendi:', yemekObj.name);
                }
                
                console.log(`✅ Local foodData güncel (${foodData.length} yemek)`);
            } catch (error) {
                console.warn('⚠️ Local foodData güncellenemedi, GitHub\'dan yüklenecek:', error);
                // Fallback: GitHub'dan yeniden yükle
                foodData = [];
                await loadFoodData();
            }
        }
        
        /**
         * 🎨 Menü kartında yemeği ANINDA güncelle (render beklemeden)
         * Kullanıcı değişikliği hemen görsün
         */
        function updateFoodInMenu(weekIndex, dayIndex, mealIndex, foodIndex, yemekObj) {
            try {
                const week = weeks[weekIndex];
                if (!week) return;
                
                const day = week.days[dayIndex];
                if (!day) return;
                
                const meal = (day.meals || day.ogunler || [])[mealIndex];
                if (!meal) return;
                
                const food = (meal.yemekler || [])[foodIndex];
                if (!food) return;
                
                // Yemek bilgilerini güncelle (SADECE makroları - isim değişmez)
                food.calories = yemekObj.calories || food.calories || 0;
                food.kalori = yemekObj.calories || food.kalori || 0;
                food.protein = yemekObj.protein || food.protein || 0;
                food.carbs = yemekObj.carbs || food.carbs || 0;
                food.karbonhidrat = yemekObj.carbs || food.karbonhidrat || 0;
                food.fat = yemekObj.fat || food.fat || 0;
                food.yag = yemekObj.fat || food.yag || 0;
                food.category = yemekObj.category || food.category;
                food.role = yemekObj.role || food.role;
                
                // eslesenYemek objesi varsa (foodData'dan geliyorsa) güncelle
                if (food.eslesenYemek) {
                    food.eslesenYemek = { ...food.eslesenYemek, ...yemekObj };
                }
                
                console.log('🎨 Menü kartı güncellendi:', {
                    weekIndex, dayIndex, mealIndex, foodIndex,
                    yemek: food.foodName || food.name,
                    yeniMakrolar: {
                        kalori: food.calories,
                        protein: food.protein,
                        karb: food.carbs,
                        yag: food.fat
                    }
                });
                
                // Render'ı tetikle (değişiklikler görünsün)
                renderWeekContent();
                
            } catch (error) {
                console.error('❌ Menü kartı güncellenemedi:', error);
                // Fallback: Full render yap
                renderWeekContent();
            }
        }
        
        // ========================================
        // 📝 TEMPLATE EDIT MODAL FUNCTIONS
        // ========================================
        
        let currentEditingTemplate = null; // Düzenlenmekte olan şablon
        
        /**
         * Şablon düzenleme modalını aç
         * @param {string} templateId - Düzenlenecek şablon ID
         */
        window.openTemplateEditModal = function(templateId) {
            const template = dayTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('❌ Şablon bulunamadı!');
                return;
            }
            
            currentEditingTemplate = JSON.parse(JSON.stringify(template)); // Deep copy
            
            // Modal'ı göster
            const modal = document.getElementById('templateEditModal');
            if (modal) {
                // Şablon adını göster
                document.getElementById('templateEditName').textContent = template.name || 'İsimsiz Şablon';
                
                // Öğünleri render et
                renderTemplateEditContent();
                
                // 🔑 Token'ı otomatik yükle (varsa)
                const savedToken = localStorage.getItem('github_token');
                const tokenInput = document.getElementById('templateGithubToken');
                if (savedToken && tokenInput) {
                    tokenInput.value = savedToken;
                    console.log('✅ GitHub token otomatik yüklendi');
                }
                
                modal.style.display = 'block';
                console.log('📝 Template edit modal açıldı:', templateId);
            } else {
                alert('⚠️ Template edit modal yüklenemedi!');
            }
        };
        
        /**
         * Şablon düzenleme modalını kapat
         */
        window.closeTemplateEditModal = function() {
            const modal = document.getElementById('templateEditModal');
            if (modal) {
                modal.style.display = 'none';
                currentEditingTemplate = null;
            }
        };
        
        /**
         * 🔑 GitHub Token yönetimi - Şablon modalı için
         */
        window.toggleTemplateTokenVisibility = function() {
            const tokenInput = document.getElementById('templateGithubToken');
            if (!tokenInput) return;
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
            } else {
                tokenInput.type = 'password';
            }
        };
        
        window.loadTemplateTokenFromStorage = function() {
            const token = localStorage.getItem('github_token');
            const tokenInput = document.getElementById('templateGithubToken');
            
            if (token) {
                tokenInput.value = token;
                alert('✅ Token localStorage\'dan yüklendi!');
            } else {
                alert('⚠️ localStorage\'da github_token bulunamadı!\n\nLütfen token girin ve tarayıcınızda kaydedin.');
            }
        };
        
        /**
         * Şablon içeriğini render et (öğünler + yemekler)
         */
        function renderTemplateEditContent() {
            if (!currentEditingTemplate) return;
            
            const container = document.getElementById('templateEditContent');
            if (!container) return;
            
            let html = '';
            
            // Öğünleri döngüyle işle
            (currentEditingTemplate.ogunler || []).forEach((ogun, ogunIndex) => {
                const ogunAdi = ogun.ogunAdi || ogun.mealName || `Öğün ${ogunIndex + 1}`;
                const yemekler = ogun.yemekler || [];
                
                // Öğün toplamlarını hesapla
                const ogunTotals = yemekler.reduce((acc, y) => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                    return acc;
                }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
                
                html += `
                    <div class="template-edit-ogun" style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">
                            🍽️ ${ogunAdi.charAt(0).toUpperCase() + ogunAdi.slice(1)}
                            <span style="float: right; font-size: 13px; font-weight: normal; color: #666;">
                                ${Math.round(ogunTotals.kalori)} kcal | 
                                P: ${Math.round(ogunTotals.protein)}g | 
                                K: ${Math.round(ogunTotals.karb)}g | 
                                Y: ${Math.round(ogunTotals.yag)}g
                            </span>
                        </h4>
                        
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #e3f2fd;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Yemek Adı</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 80px;">Kalori</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Protein</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Karb</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Yağ</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 180px;">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                yemekler.forEach((yemek, yemekIndex) => {
                    const isFirst = yemekIndex === 0;
                    const isLast = yemekIndex === yemekler.length - 1;
                    
                    html += `
                        <tr style="background: white;">
                            <td style="padding: 8px; border: 1px solid #ddd;">${yemek.foodName || 'İsimsiz Yemek'}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.calories || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.protein || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.carbs || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.fat || 0)}</td>
                            <td style="padding: 6px; text-align: center; border: 1px solid #ddd;">
                                <button onclick="editTemplateFood(${ogunIndex}, ${yemekIndex})" style="background: #2196F3; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 12px;" title="Düzenle">
                                    ✏️
                                </button>
                                <button onclick="deleteTemplateFood(${ogunIndex}, ${yemekIndex})" style="background: #f44336; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 12px;" title="Sil">
                                    🗑️
                                </button>
                                <button onclick="moveTemplateFoodUp(${ogunIndex}, ${yemekIndex})" ${isFirst ? 'disabled' : ''} style="background: ${isFirst ? '#ccc' : '#ff9800'}; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: ${isFirst ? 'not-allowed' : 'pointer'}; border-radius: 4px; font-size: 12px;" title="Yukarı Taşı">
                                    ⬆️
                                </button>
                                <button onclick="moveTemplateFoodDown(${ogunIndex}, ${yemekIndex})" ${isLast ? 'disabled' : ''} style="background: ${isLast ? '#ccc' : '#ff9800'}; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: ${isLast ? 'not-allowed' : 'pointer'}; border-radius: 4px; font-size: 12px;" title="Aşağı Taşı">
                                    ⬇️
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    // Araya satır ekleme butonu (son satır hariç)
                    if (!isLast) {
                        html += `
                            <tr style="background: #f0f0f0;">
                                <td colspan="6" style="padding: 4px; text-align: center; border: 1px solid #ddd;">
                                    <button onclick="insertTemplateFoodBetween(${ogunIndex}, ${yemekIndex})" style="background: #4CAF50; color: white; border: none; padding: 4px 12px; cursor: pointer; border-radius: 4px; font-size: 11px;" title="Araya Yemek Ekle">
                                        ➕ Araya Ekle
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            // Gün toplamları
            const gunTotals = (currentEditingTemplate.ogunler || []).reduce((acc, ogun) => {
                (ogun.yemekler || []).forEach(y => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                });
                return acc;
            }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            
            // Makro kaloriler (protein: 4 kcal/g, karb: 4 kcal/g, yağ: 9 kcal/g)
            const proteinKcal = gunTotals.protein * 4;
            const karbKcal = gunTotals.karb * 4;
            const yagKcal = gunTotals.yag * 9;
            const totalMacroKcal = proteinKcal + karbKcal + yagKcal;
            
            // Yüzde oranları
            const proteinPercent = totalMacroKcal > 0 ? ((proteinKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            const karbPercent = totalMacroKcal > 0 ? ((karbKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            const yagPercent = totalMacroKcal > 0 ? ((yagKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            
            html += `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">📊 Günlük Toplam</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">KALORI</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.kalori)} <span style="font-size: 14px; font-weight: normal;">kcal</span></div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #f44336;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">PROTEIN</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.protein)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${proteinPercent}% • ${Math.round(proteinKcal)} kcal</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #2196F3;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">KARBONHIDRAT</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.karb)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${karbPercent}% • ${Math.round(karbKcal)} kcal</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #4CAF50;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">YAĞ</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.yag)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${yagPercent}% • ${Math.round(yagKcal)} kcal</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        /**
         * Yemek satırını sil
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.deleteTemplateFood = function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler) return;
            
            const yemekAdi = ogun.yemekler[yemekIndex]?.foodName || 'Bu yemek';
            
            if (confirm(`🗑️ "${yemekAdi}" silinecek. Emin misiniz?`)) {
                // 1️⃣ Veriyi sil
                ogun.yemekler.splice(yemekIndex, 1);
                
                // 2️⃣ Modal'ı ANINDA güncelle
                renderTemplateEditContent();
                
                // 3️⃣ Bildirim göster
                showTemplateEditNotification('🗑️ Silindi: ' + yemekAdi, 'success');
                
                console.log('🗑️ Yemek silindi:', yemekAdi);
            }
        };
        
        /**
         * Yemeği yukarı taşı
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.moveTemplateFoodUp = function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate || yemekIndex === 0) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler) return;
            
            // 1️⃣ Array'de yer değiştir
            const temp = ogun.yemekler[yemekIndex];
            ogun.yemekler[yemekIndex] = ogun.yemekler[yemekIndex - 1];
            ogun.yemekler[yemekIndex - 1] = temp;
            
            // 2️⃣ Modal'ı ANINDA güncelle
            renderTemplateEditContent();
            
            // 3️⃣ Bildirim göster
            showTemplateEditNotification('⬆️ Yemek yukarı taşındı', 'success');
            
            console.log('⬆️ Yemek yukarı taşındı');
        };
        
        /**
         * Yemeği aşağı taşı
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.moveTemplateFoodDown = function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler || yemekIndex === ogun.yemekler.length - 1) return;
            
            // 1️⃣ Array'de yer değiştir
            const temp = ogun.yemekler[yemekIndex];
            ogun.yemekler[yemekIndex] = ogun.yemekler[yemekIndex + 1];
            ogun.yemekler[yemekIndex + 1] = temp;
            
            // 2️⃣ Modal'ı ANINDA güncelle
            renderTemplateEditContent();
            
            // 3️⃣ Bildirim göster
            showTemplateEditNotification('⬇️ Yemek aşağı taşındı', 'success');
            
            console.log('⬇️ Yemek aşağı taşındı');
        };
        
        /**
         * İki yemek arasına yeni yemek ekle
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} afterIndex - Hangi yemekten sonra eklenecek
         */
        window.insertTemplateFoodBetween = function(ogunIndex, afterIndex) {
            if (!currentEditingTemplate) return;
            
            // Yemek ekleme popup'ını aç
            openFoodSearchPopup(ogunIndex, afterIndex + 1, 'insert');
        };
        
        /**
         * Yemeği düzenle
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        // Global state for food editing
        let currentEditingFoodState = {
            ogunIndex: null,
            yemekIndex: null,
            originalFoodName: null,
            originalFood: null
        };
        
        /**
         * Yemek düzenleme modalını aç
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.editTemplateFood = function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun) return;
            
            const food = ogun.yemekler[yemekIndex];
            if (!food) return;
            
            const foodName = food.foodName || food.name || 'İsimsiz Yemek';
            
            // Global state'i kaydet
            currentEditingFoodState = {
                ogunIndex,
                yemekIndex,
                originalFoodName: foodName,
                originalFood: JSON.parse(JSON.stringify(food)) // Deep copy
            };
            
            // food_list.json'da bu yemeği bul (zenginleştirilmiş veriler için)
            const dbFood = findFoodInDatabase(foodName);
            
            // Modal başlığını güncelle
            document.getElementById('editFoodModalTitle').textContent = foodName;
            
            // Formları doldur
            document.getElementById('editFoodName').value = foodName;
            
            if (dbFood) {
                // ✅ VERİTABANINDA VAR - TÜM PARAMETRELERİ DOLDUR
                console.log('✅ Yemek veritabanında bulundu:', dbFood.name);
                document.getElementById('editFoodCalories').value = dbFood.calories || 0;
                document.getElementById('editFoodProtein').value = dbFood.protein || 0;
                document.getElementById('editFoodCarbs').value = dbFood.carbs || 0;
                document.getElementById('editFoodFat').value = dbFood.fat || 0;
                document.getElementById('editFoodCategory').value = dbFood.category || '';
                document.getElementById('editFoodRole').value = dbFood.role || '';
                
                // Öğün tipleri
                const mealTypes = dbFood.mealType || dbFood.mealTypes || [];
                document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
                document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
                document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
                
                // Porsiyon
                document.getElementById('editFoodPortion').value = dbFood.portionMultiplier || dbFood.multiplier || 1;
                
                // Diyet tipleri
                const dietTypes = dbFood.dietTypes || [];
                document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
                document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
                document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
                document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
                
                // Min/Max/Step
                document.getElementById('editFoodMin').value = dbFood.minQuantity || '';
                document.getElementById('editFoodMax').value = dbFood.maxQuantity || '';
                document.getElementById('editFoodStep').value = dbFood.step || '';
                
                // Sezon
                if (dbFood.seasonRange) {
                    try {
                        const season = JSON.parse(dbFood.seasonRange);
                        document.getElementById('editFoodSeasonMin').value = season[0] || '';
                        document.getElementById('editFoodSeasonMax').value = season[1] || '';
                    } catch (e) {
                        document.getElementById('editFoodSeasonMin').value = '';
                        document.getElementById('editFoodSeasonMax').value = '';
                    }
                } else {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
                
                // Özel özellikler
                document.getElementById('editFoodKeto').checked = dbFood.keto || false;
                document.getElementById('editFoodLowCarb').checked = dbFood.lowcarb || false;
                document.getElementById('editFoodPortionFixed').checked = dbFood.portionFixed || false;
                document.getElementById('editFoodFillerLunch').checked = dbFood.fillerLunch || false;
                document.getElementById('editFoodFillerDinner').checked = dbFood.fillerDinner || false;
                document.getElementById('editFoodReversedSeason').checked = dbFood.isReversedSeason || false;
                
                // Etiketler
                document.getElementById('editFoodTags').value = (dbFood.tags || []).join(', ');
                document.getElementById('editFoodCompat').value = (dbFood.compatibilityTags || []).join(', ');
                document.getElementById('editFoodIncompat').value = (dbFood.incompatibilityTags || []).join(', ');
                
                // Notlar
                document.getElementById('editFoodNotes').value = dbFood.notes || '';
            } else {
                // ⚠️ VERİTABANINDA YOK - Şablondaki değerleri doldur
                console.log('⚠️ Yemek veritabanında bulunamadı, şablon değerleri kullanılıyor');
                document.getElementById('editFoodCalories').value = food.calories || food.kalori || 0;
                document.getElementById('editFoodProtein').value = food.protein || 0;
                document.getElementById('editFoodCarbs').value = food.carbs || food.karbonhidrat || 0;
                document.getElementById('editFoodFat').value = food.fat || food.yag || 0;
                document.getElementById('editFoodCategory').value = food.category || '';
                document.getElementById('editFoodRole').value = food.role || '';
                
                // Diğer tüm alanları sıfırla
                document.getElementById('editMealType_breakfast').checked = false;
                document.getElementById('editMealType_lunch').checked = false;
                document.getElementById('editMealType_dinner').checked = false;
                document.getElementById('editFoodPortion').value = 1;
                document.getElementById('editDietType_ketojenik').checked = false;
                document.getElementById('editDietType_akdeniz').checked = false;
                document.getElementById('editDietType_vegan').checked = false;
                document.getElementById('editDietType_glutensiz').checked = false;
                document.getElementById('editFoodMin').value = '';
                document.getElementById('editFoodMax').value = '';
                document.getElementById('editFoodStep').value = '';
                document.getElementById('editFoodSeasonMin').value = '';
                document.getElementById('editFoodSeasonMax').value = '';
                document.getElementById('editFoodKeto').checked = false;
                document.getElementById('editFoodLowCarb').checked = false;
                document.getElementById('editFoodPortionFixed').checked = false;
                document.getElementById('editFoodFillerLunch').checked = false;
                document.getElementById('editFoodFillerDinner').checked = false;
                document.getElementById('editFoodReversedSeason').checked = false;
                document.getElementById('editFoodTags').value = '';
                document.getElementById('editFoodCompat').value = '';
                document.getElementById('editFoodIncompat').value = '';
                document.getElementById('editFoodNotes').value = '';
            }
            
            // food_list.json kaydetme checkbox'ı varsayılan kapalı
            document.getElementById('saveFoodToDatabase').checked = false;
            
            // Modalı göster
            document.getElementById('templateFoodEditModal').style.display = 'block';
        };
        
        /**
         * Yemek düzenleme modalını kapat
         */
        window.closeTemplateFoodEditModal = function() {
            document.getElementById('templateFoodEditModal').style.display = 'none';
            currentEditingFoodState = { ogunIndex: null, yemekIndex: null, originalFoodName: null, originalFood: null };
            
            // Arama dropdown'unu kapat
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * Yemek arama (akıllı search - dropdown)
         * @param {string} query - Arama terimi
         */
        window.searchFoodForEdit = function(query) {
            const resultsContainer = document.getElementById('editFoodSearchResults');
            if (!resultsContainer) return;
            
            // Boş arama - dropdown'u gizle
            if (!query || query.trim().length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Fuzzy search (normalizeTr kullanarak)
            const normalizedQuery = normalizeTr(query);
            const tokens = tokenize(query);
            
            let matches = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                // 1. Tam eşleşme
                if (normalizedName === normalizedQuery) return true;
                
                // 2. İçeriyor mu?
                if (normalizedName.includes(normalizedQuery)) return true;
                
                // 3. Token bazlı eşleşme
                const foodTokens = tokenize(food.name);
                return tokens.some(t => foodTokens.some(ft => ft.includes(t) || t.includes(ft)));
            });
            
            // İlk 10 sonucu göster
            matches = matches.slice(0, 10);
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">Sonuç bulunamadı</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            // Sonuçları render et
            let html = '';
            matches.forEach(food => {
                html += `
                    <div onclick="selectFoodForEdit('${food.name.replace(/'/g, "\\'")}')" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${food.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${Math.round(food.calories || 0)} kcal | 
                            P: ${Math.round(food.protein || 0)}g | 
                            K: ${Math.round(food.carbs || 0)}g | 
                            Y: ${Math.round(food.fat || 0)}g
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        };
        
        /**
         * Arama sonucundan yemek seç
         * @param {string} foodName - Seçilen yemek adı
         */
        window.selectFoodForEdit = function(foodName) {
            // Formu yeni yemeğin bilgileriyle doldur
            const dbFood = findFoodInDatabase(foodName);
            
            if (dbFood) {
                document.getElementById('editFoodName').value = dbFood.name;
                document.getElementById('editFoodCalories').value = dbFood.calories || 0;
                document.getElementById('editFoodProtein').value = dbFood.protein || 0;
                document.getElementById('editFoodCarbs').value = dbFood.carbs || 0;
                document.getElementById('editFoodFat').value = dbFood.fat || 0;
                document.getElementById('editFoodCategory').value = dbFood.category || '';
                document.getElementById('editFoodRole').value = dbFood.role || '';
                
                // Öğün tipleri
                const mealTypes = dbFood.mealType || dbFood.mealTypes || [];
                document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
                document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
                document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
                
                // Porsiyon
                document.getElementById('editFoodPortion').value = dbFood.portionMultiplier || dbFood.multiplier || 1;
                
                // Diyet tipleri
                const dietTypes = dbFood.dietTypes || [];
                document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
                document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
                document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
                document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
                
                // Min/Max/Step
                document.getElementById('editFoodMin').value = dbFood.minQuantity || '';
                document.getElementById('editFoodMax').value = dbFood.maxQuantity || '';
                document.getElementById('editFoodStep').value = dbFood.step || '';
                
                // Sezon
                if (dbFood.seasonRange) {
                    try {
                        const season = JSON.parse(dbFood.seasonRange);
                        document.getElementById('editFoodSeasonMin').value = season[0] || '';
                        document.getElementById('editFoodSeasonMax').value = season[1] || '';
                    } catch (e) {
                        document.getElementById('editFoodSeasonMin').value = '';
                        document.getElementById('editFoodSeasonMax').value = '';
                    }
                } else {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
                
                // Özel özellikler
                document.getElementById('editFoodKeto').checked = dbFood.keto || false;
                document.getElementById('editFoodLowCarb').checked = dbFood.lowcarb || false;
                document.getElementById('editFoodPortionFixed').checked = dbFood.portionFixed || false;
                document.getElementById('editFoodFillerLunch').checked = dbFood.fillerLunch || false;
                document.getElementById('editFoodFillerDinner').checked = dbFood.fillerDinner || false;
                document.getElementById('editFoodReversedSeason').checked = dbFood.isReversedSeason || false;
                
                // Etiketler
                document.getElementById('editFoodTags').value = (dbFood.tags || []).join(', ');
                document.getElementById('editFoodCompat').value = (dbFood.compatibilityTags || []).join(', ');
                document.getElementById('editFoodIncompat').value = (dbFood.incompatibilityTags || []).join(', ');
                
                // Notlar
                document.getElementById('editFoodNotes').value = dbFood.notes || '';
            }
            
            // Dropdown'u kapat
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * Düzenlenen yemeği kaydet
         * 3 SENARYO:
         * A) Aynı yemek + parametre değişikliği → food_list.json + şablon güncelle
         * B) Farklı yemek seçimi → Sadece şablonu değiştir
         * C) Farklı yemek + parametre değişikliği → food_list.json + şablon güncelle
         */
        window.saveEditedTemplateFood = async function() {
            const { ogunIndex, yemekIndex, originalFoodName, originalFood } = currentEditingFoodState;
            
            if (ogunIndex === null || yemekIndex === null) return;
            
            // Formdan TÜM değerleri al
            const newFoodName = document.getElementById('editFoodName').value.trim();
            const newCalories = parseFloat(document.getElementById('editFoodCalories').value) || 0;
            const newProtein = parseFloat(document.getElementById('editFoodProtein').value) || 0;
            const newCarbs = parseFloat(document.getElementById('editFoodCarbs').value) || 0;
            const newFat = parseFloat(document.getElementById('editFoodFat').value) || 0;
            const newCategory = document.getElementById('editFoodCategory').value.trim();
            const newRole = document.getElementById('editFoodRole').value.trim();
            
            // Öğün tipleri
            const newMealTypes = [];
            if (document.getElementById('editMealType_breakfast').checked) newMealTypes.push('breakfast');
            if (document.getElementById('editMealType_lunch').checked) newMealTypes.push('lunch');
            if (document.getElementById('editMealType_dinner').checked) newMealTypes.push('dinner');
            
            // Porsiyon
            const newPortion = parseFloat(document.getElementById('editFoodPortion').value) || 1;
            
            // Diyet tipleri
            const newDietTypes = [];
            if (document.getElementById('editDietType_ketojenik').checked) newDietTypes.push('ketojenik');
            if (document.getElementById('editDietType_akdeniz').checked) newDietTypes.push('akdeniz');
            if (document.getElementById('editDietType_vegan').checked) newDietTypes.push('vegan');
            if (document.getElementById('editDietType_glutensiz').checked) newDietTypes.push('glutensiz');
            
            // Min/Max/Step
            const newMin = document.getElementById('editFoodMin').value.trim();
            const newMax = document.getElementById('editFoodMax').value.trim();
            const newStep = document.getElementById('editFoodStep').value.trim();
            
            // Sezon
            const newSeasonMin = document.getElementById('editFoodSeasonMin').value.trim();
            const newSeasonMax = document.getElementById('editFoodSeasonMax').value.trim();
            const newSeasonRange = (newSeasonMin && newSeasonMax) ? JSON.stringify([parseInt(newSeasonMin), parseInt(newSeasonMax)]) : '';
            
            // Özel özellikler
            const newKeto = document.getElementById('editFoodKeto').checked;
            const newLowCarb = document.getElementById('editFoodLowCarb').checked;
            const newPortionFixed = document.getElementById('editFoodPortionFixed').checked;
            const newFillerLunch = document.getElementById('editFoodFillerLunch').checked;
            const newFillerDinner = document.getElementById('editFoodFillerDinner').checked;
            const newReversedSeason = document.getElementById('editFoodReversedSeason').checked;
            
            // Etiketler
            const newTags = document.getElementById('editFoodTags').value.split(',').map(t => t.trim()).filter(t => t);
            const newCompat = document.getElementById('editFoodCompat').value.split(',').map(t => t.trim()).filter(t => t);
            const newIncompat = document.getElementById('editFoodIncompat').value.split(',').map(t => t.trim()).filter(t => t);
            
            // Notlar
            const newNotes = document.getElementById('editFoodNotes').value.trim();
            
            const saveToDB = document.getElementById('saveFoodToDatabase').checked;
            
            if (!newFoodName) {
                alert('⚠️ Yemek adı boş olamaz!');
                return;
            }
            
            // İsim normalizasyonu
            const originalNormalized = normalizeTr(originalFoodName);
            const newNormalized = normalizeTr(newFoodName);
            const isSameFood = originalNormalized === newNormalized;
            
            // Parametre değişikliği var mı?
            const hasParameterChange = 
                newCalories !== (originalFood.calories || originalFood.kalori || 0) ||
                newProtein !== (originalFood.protein || 0) ||
                newCarbs !== (originalFood.carbs || originalFood.karbonhidrat || 0) ||
                newFat !== (originalFood.fat || originalFood.yag || 0);
            
            console.log('🔍 Kaydetme senaryosu:', {
                isSameFood,
                hasParameterChange,
                saveToDB,
                originalFoodName,
                newFoodName
            });
            
            // Yeni yemek objesi (TÜM parametrelerle)
            const updatedFood = {
                foodName: newFoodName,
                name: newFoodName,
                calories: newCalories,
                kalori: newCalories,
                protein: newProtein,
                carbs: newCarbs,
                karbonhidrat: newCarbs,
                fat: newFat,
                yag: newFat,
                category: newCategory,
                role: newRole,
                mealType: newMealTypes,
                mealTypes: newMealTypes,
                portionMultiplier: newPortion,
                multiplier: newPortion,
                dietTypes: newDietTypes,
                minQuantity: newMin,
                maxQuantity: newMax,
                step: newStep,
                seasonRange: newSeasonRange,
                keto: newKeto,
                lowcarb: newLowCarb,
                portionFixed: newPortionFixed,
                fillerLunch: newFillerLunch,
                fillerDinner: newFillerDinner,
                isReversedSeason: newReversedSeason,
                tags: newTags,
                compatibilityTags: newCompat,
                incompatibilityTags: newIncompat,
                notes: newNotes
            };
            
            // 📝 Şablonu güncelle (HER ZAMAN)
            currentEditingTemplate.ogunler[ogunIndex].yemekler[yemekIndex] = updatedFood;
            
            // 🔄 ANINDA modal'ı güncelle (kullanıcı değişikliği görsün)
            renderTemplateEditContent();
            
            // 🔔 Bildirim göster (modal içinde)
            showTemplateEditNotification('✏️ Yemek güncellendi!', 'success');
            
            // Dinamik makro hesaplaması
            recalculateTemplateMacros();
            
            // 📊 SENARYO KONTROLÜ
            if (isSameFood && hasParameterChange && saveToDB) {
                // SENARYO A: Aynı yemek + parametre değişikliği + DB kayıt istendi
                console.log('✅ SENARYO A: food_list.json + şablon güncelleniyor');
                await updateFoodInDatabase(newFoodName, updatedFood);
                showToast('✅ Yemek ve food_list.json güncellendi!');
            } else if (!isSameFood && !hasParameterChange) {
                // SENARYO B: Farklı yemek seçimi (parametre değişikliği yok)
                console.log('✅ SENARYO B: Sadece şablon güncellendi');
                showToast('✅ Şablonda yemek değiştirildi!');
            } else if (!isSameFood && hasParameterChange && saveToDB) {
                // SENARYO C: Farklı yemek + parametre değişikliği + DB kayıt istendi
                console.log('✅ SENARYO C: Yeni yemek parametreleri food_list.json\'a kaydediliyor');
                await updateFoodInDatabase(newFoodName, updatedFood);
                showToast('✅ Yeni yemek food_list.json\'a kaydedildi!');
            } else {
                // Diğer durumlar: Sadece şablon güncellendi
                console.log('✅ Sadece şablon güncellendi');
                showToast('✅ Şablonda değişiklik kaydedildi!');
            }
            
            // Modalı kapat
            closeTemplateFoodEditModal();
        };
        
        /**
         * food_list.json'da yemek güncelle (GitHub API)
         * @param {string} foodName - Yemek adı
         * @param {object} foodData - Yemek parametreleri
         */
        async function updateFoodInDatabase(foodName, updatedFoodData) {
            try {
                console.log('📝 food_list.json güncelleme başladı:', foodName);
                
                // GitHub token kontrolü
                const GITHUB_TOKEN = localStorage.getItem('github_token');
                if (!GITHUB_TOKEN) {
                    throw new Error('GitHub token bulunamadı! Lütfen Admin Modal > Tab 6\'dan token girin.');
                }
                
                const REPO_OWNER = 'mustafasacar35';
                const REPO_NAME = 'lipodem-takip-paneli';
                const FILE_PATH = 'food_list.json';
                const BRANCH = 'main';
                
                // 1️⃣ Mevcut food_list.json'u GitHub'dan çek
                const getUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`food_list.json okunamadı: ${getResponse.status}`);
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // 2️⃣ Base64'ten decode et ve parse et
                const decoded = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
                const foodList = JSON.parse(decoded);
                
                console.log('✅ food_list.json yüklendi, kategoriler:', foodList.categories.length);
                
                // 3️⃣ Yemeği bul ve güncelle (categories array içinde items)
                let foodFound = false;
                const normalizedSearchName = normalizeTr(foodName);
                
                for (const category of foodList.categories) {
                    if (!category.items || !Array.isArray(category.items)) continue;
                    
                    const foodIndex = category.items.findIndex(f => 
                        normalizeTr(f.name) === normalizedSearchName
                    );
                    
                    if (foodIndex !== -1) {
                        // Yemek bulundu - tüm parametreleri güncelle
                        const existingFood = category.items[foodIndex];
                        
                        category.items[foodIndex] = {
                            ...existingFood,
                            name: updatedFoodData.name,
                            calories: updatedFoodData.calories,
                            protein: updatedFoodData.protein,
                            carbs: updatedFoodData.carbs,
                            fat: updatedFoodData.fat,
                            category: updatedFoodData.category,
                            role: updatedFoodData.role,
                            keto: updatedFoodData.keto,
                            lowcarb: updatedFoodData.lowcarb,
                            portionFixed: updatedFoodData.portionFixed,
                            fillerLunch: updatedFoodData.fillerLunch,
                            fillerDinner: updatedFoodData.fillerDinner
                        };
                        
                        foodFound = true;
                        console.log(`✅ Yemek güncellendi: "${foodName}" (Kategori: ${category.name})`);
                        break;
                    }
                }
                
                if (!foodFound) {
                    console.warn(`⚠️ Yemek food_list.json'da bulunamadı: "${foodName}"`);
                    console.warn('💡 Yemek eklemek için Admin Modal > Tab 5\'i kullanın');
                    return; // Yemek yoksa ekleme yapma (güvenlik)
                }
                
                // 4️⃣ JSON'u Base64'e çevir (✅ TÜRKÇE KARAKTER KORUYAN)
                const updatedContent = JSON.stringify(foodList, null, 2);
                const contentBase64 = encodeBase64UTF8(updatedContent);
                
                // 5️⃣ GitHub'a commit et
                const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
                const commitMessage = `🔄 Yemek güncellendi: ${foodName} (Şablon düzenleme)`;
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: contentBase64,
                        sha: sha,
                        branch: BRANCH
                    })
                });
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub commit hatası: ${errorData.message}`);
                }
                
                const result = await putResponse.json();
                console.log('✅ food_list.json GitHub\'a kaydedildi:', result.commit.sha.slice(0, 7));
                
                // 6️⃣ Lokal foodData cache'ini güncelle (sayfa yenilenmeden)
                const foodInCache = foodData.find(f => normalizeTr(f.name) === normalizedSearchName);
                if (foodInCache) {
                    Object.assign(foodInCache, {
                        name: foodData.name,
                        calories: foodData.calories,
                        protein: foodData.protein,
                        carbs: foodData.carbs,
                        fat: foodData.fat,
                        category: foodData.category,
                        role: foodData.role,
                        keto: foodData.keto,
                        lowcarb: foodData.lowcarb,
                        portionFixed: foodData.portionFixed,
                        fillerLunch: foodData.fillerLunch,
                        fillerDinner: foodData.fillerDinner
                    });
                    console.log('✅ Lokal cache güncellendi');
                }
                
            } catch (error) {
                console.error('❌ food_list.json güncellenemedi:', error);
                alert(`⚠️ food_list.json güncellenemedi:\n${error.message}\n\nŞablon değişikliği kaydedildi ama veritabanı güncellenmedi.`);
                throw error;
            }
        }
        
        /**
         * Şablon makrolarını yeniden hesapla
         * currentEditingTemplate içindeki tüm öğünlerin yemeklerini toplayarak
         * toplam kalori, protein, karbonhidrat, yağ hesaplar
         */
        function recalculateTemplateMacros() {
            if (!currentEditingTemplate || !currentEditingTemplate.ogunler) return;
            
            let totalCalories = 0;
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            
            currentEditingTemplate.ogunler.forEach(ogun => {
                if (ogun.yemekler && Array.isArray(ogun.yemekler)) {
                    ogun.yemekler.forEach(yemek => {
                        totalCalories += parseFloat(yemek.calories || yemek.kalori || 0);
                        totalProtein += parseFloat(yemek.protein || 0);
                        totalCarbs += parseFloat(yemek.carbs || yemek.karbonhidrat || 0);
                        totalFat += parseFloat(yemek.fat || yemek.yag || 0);
                    });
                }
            });
            
            // Şablon objesine kaydet
            currentEditingTemplate.totalCalories = Math.round(totalCalories);
            currentEditingTemplate.totalProtein = Math.round(totalProtein);
            currentEditingTemplate.totalCarbs = Math.round(totalCarbs);
            currentEditingTemplate.totalFat = Math.round(totalFat);
            
            console.log('📊 Makrolar yeniden hesaplandı:', {
                kalori: currentEditingTemplate.totalCalories,
                protein: currentEditingTemplate.totalProtein,
                karb: currentEditingTemplate.totalCarbs,
                yag: currentEditingTemplate.totalFat
            });
        }
        
        // ========================================
        // 🗑️ ESKİ YOL: Food Search Popup (Deprecated - Yeni sistem: templateFoodEditModal)
        // ========================================
        
        // Food search popup state
        let foodSearchState = {
            ogunIndex: null,
            yemekIndex: null,
            mode: null // 'edit' veya 'insert'
        };
        
        /**
         * Yemek arama popup'ını aç
         * @param {number} ogunIndex - Öğün indexi
         * @param {number} yemekIndex - Yemek indexi
         * @param {string} mode - 'edit' veya 'insert'
         */
        function openFoodSearchPopup(ogunIndex, yemekIndex, mode) {
            foodSearchState = { ogunIndex, yemekIndex, mode };
            
            // Popup'ı göster
            const popup = document.getElementById('foodSearchPopup');
            if (popup) {
                // Search input'u temizle
                document.getElementById('templateFoodSearch').value = '';
                document.getElementById('templateFoodSearchResults').innerHTML = '<p style="color: #666; text-align: center;">Yemek aramak için yukarıya yazın...</p>';
                
                popup.style.display = 'block';
                
                // Auto-focus search input
                setTimeout(() => {
                    document.getElementById('templateFoodSearch').focus();
                }, 100);
            }
        }
        
        /**
         * Yemek arama popup'ını kapat
         */
        window.closeFoodSearchPopup = function() {
            const popup = document.getElementById('foodSearchPopup');
            if (popup) {
                popup.style.display = 'none';
                foodSearchState = { ogunIndex: null, yemekIndex: null, mode: null };
            }
        };
        
        /**
         * Yemek ara (fuzzy search)
         * @param {string} query - Arama terimi
         */
        window.searchTemplateFoods = function(query) {
            const resultsContainer = document.getElementById('templateFoodSearchResults');
            if (!resultsContainer) return;
            
            // Boş arama
            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = '<p style="color: #666; text-align: center;">En az 2 karakter girin...</p>';
                return;
            }
            
            // foodData yüklenmemişse
            if (!foodData || foodData.length === 0) {
                resultsContainer.innerHTML = '<p style="color: #f44336; text-align: center;">⚠️ Yemek veritabanı yüklenmedi!</p>';
                return;
            }
            
            const queryNorm = normalizeTr(query.trim());
            const queryTokens = tokenize(query);
            
            // Fuzzy search ile eşleşenleri bul
            let matches = [];
            
            foodData.forEach(food => {
                const foodNorm = normalizeTr(food.name);
                const foodTokens = tokenize(food.name);
                
                let score = 0;
                
                // 1. Tam eşleşme
                if (foodNorm === queryNorm) {
                    score = 1000;
                }
                // 2. Substring eşleşme
                else if (foodNorm.includes(queryNorm) || queryNorm.includes(foodNorm)) {
                    score = 900;
                }
                // 3. Token eşleşme
                else {
                    const setFood = new Set(foodTokens);
                    let overlap = 0;
                    
                    queryTokens.forEach(t => {
                        if (setFood.has(t)) overlap++;
                        else {
                            // Partial token match (başlangıç eşleşmesi)
                            for (const ft of foodTokens) {
                                if (ft.startsWith(t) || t.startsWith(ft)) {
                                    overlap += 0.5;
                                    break;
                                }
                            }
                        }
                    });
                    
                    if (overlap > 0) {
                        score = overlap * 100;
                    }
                }
                
                if (score > 0) {
                    matches.push({ food, score });
                }
            });
            
            // Skorlara göre sırala
            matches.sort((a, b) => b.score - a.score);
            
            // İlk 20 sonucu göster
            matches = matches.slice(0, 20);
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<p style="color: #ff9800; text-align: center;">❌ Eşleşen yemek bulunamadı</p>';
                return;
            }
            
            // Sonuçları render et
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            matches.forEach(({ food, score }) => {
                html += `
                    <div onclick="selectFoodFromSearch('${food.name.replace(/'/g, "\\'")}') "style="padding: 10px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; background: white; transition: all 0.2s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${food.name}</div>
                        <div style="font-size: 12px; color: #666; display: flex; gap: 15px;">
                            <span>🔥 ${Math.round(food.calories || 0)} kcal</span>
                            <span>🥩 P: ${Math.round(food.protein || 0)}g</span>
                            <span>🍞 K: ${Math.round(food.carbs || 0)}g</span>
                            <span>🧈 Y: ${Math.round(food.fat || 0)}g</span>
                        </div>
                        ${food.category ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">📂 ${food.category}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        };
        
        /**
         * Arama sonuçlarından yemek seç
         * @param {string} foodName - Seçilen yemek adı
         */
        window.selectFoodFromSearch = function(foodName) {
            if (!currentEditingTemplate || foodSearchState.ogunIndex === null) return;
            
            // Yemeği foodData'dan bul
            const food = foodData.find(f => f.name === foodName);
            if (!food) {
                alert('❌ Yemek bulunamadı!');
                return;
            }
            
            const { ogunIndex, yemekIndex, mode } = foodSearchState;
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            
            if (!ogun || !ogun.yemekler) {
                alert('❌ Öğün bulunamadı!');
                return;
            }
            
            // Yeni yemek objesi oluştur
            const newFood = {
                foodName: food.name,
                calories: food.calories || 0,
                protein: food.protein || 0,
                carbs: food.carbs || 0,
                fat: food.fat || 0,
                eslesenYemek: food // Orijinal food objesi
            };
            
            if (mode === 'edit') {
                // Mevcut yemeği değiştir
                ogun.yemekler[yemekIndex] = newFood;
                console.log('✏️ Yemek güncellendi:', foodName);
                
                // 🔔 Bildirim göster
                showTemplateEditNotification('✏️ Yemek güncellendi: ' + foodName, 'success');
            } else if (mode === 'insert') {
                // Belirtilen pozisyona ekle
                ogun.yemekler.splice(yemekIndex, 0, newFood);
                console.log('➕ Yemek eklendi:', foodName, 'Pozisyon:', yemekIndex);
                
                // 🔔 Bildirim göster
                showTemplateEditNotification('➕ Yemek eklendi: ' + foodName, 'success');
            }
            
            // 🔄 Popup'ı kapat ve modal'ı ANINDA güncelle
            closeFoodSearchPopup();
            renderTemplateEditContent();
        };
        
        /**
         * Kaydet modalını aç
         */
        window.openSaveTemplateModal = function() {
            const modal = document.getElementById('saveTemplateModal');
            if (modal) {
                // Mevcut şablon adını göster
                const currentName = currentEditingTemplate?.name || 'İsimsiz Şablon';
                document.getElementById('saveTemplateCurrentName').textContent = currentName;
                
                // Otomatik şablon adı öner (yeni şablon için)
                const nextNumber = getNextTemplateNumber();
                document.getElementById('saveTemplateNewName').value = `Menü ${nextNumber}`;
                
                // Default: Üzerine yaz
                document.getElementById('saveMode_overwrite').checked = true;
                document.getElementById('newNameContainer').style.display = 'none';
                
                modal.style.display = 'block';
            }
        };
        
        /**
         * Kaydet modalını kapat
         */
        window.closeSaveTemplateModal = function() {
            const modal = document.getElementById('saveTemplateModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        /**
         * Save mode değiştiğinde (radio button)
         */
        window.toggleSaveMode = function() {
            const overwriteMode = document.getElementById('saveMode_overwrite').checked;
            const newNameContainer = document.getElementById('newNameContainer');
            
            if (newNameContainer) {
                newNameContainer.style.display = overwriteMode ? 'none' : 'block';
            }
        };
        
        /**
         * Sonraki şablon numarasını bul
         * @returns {number} - Sonraki şablon numarası
         */
        function getNextTemplateNumber() {
            if (!dayTemplates || dayTemplates.length === 0) return 1;
            
            // Mevcut şablon adlarından en büyük numarayı bul
            let maxNumber = 0;
            
            dayTemplates.forEach(template => {
                const name = template.name || '';
                // "Menü 21", "Menu 5" gibi formatları yakala
                const match = name.match(/(?:Menü|Menu)\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > maxNumber) maxNumber = num;
                }
            });
            
            return maxNumber + 1;
        }
        
        /**
         * Şablonu kaydet (GitHub'a yaz)
         */
        window.saveTemplate = async function() {
            if (!currentEditingTemplate) {
                alert('❌ Düzenlenen şablon bulunamadı!');
                return;
            }
            
            const overwriteMode = document.getElementById('saveMode_overwrite').checked;
            let templateName;
            let isNewTemplate = false;
            
            if (overwriteMode) {
                // Üzerine yaz
                templateName = currentEditingTemplate.name;
            } else {
                // Yeni şablon
                templateName = document.getElementById('saveTemplateNewName').value.trim();
                
                if (!templateName) {
                    alert('⚠️ Lütfen yeni şablon adını girin!');
                    return;
                }
                
                // Yeni ID oluştur
                currentEditingTemplate.id = `day_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                currentEditingTemplate.name = templateName;
                isNewTemplate = true;
            }
            
            // Total macros'u güncelle
            const gunTotals = (currentEditingTemplate.ogunler || []).reduce((acc, ogun) => {
                (ogun.yemekler || []).forEach(y => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                });
                return acc;
            }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            
            currentEditingTemplate.totalCalories = gunTotals.kalori;
            currentEditingTemplate.totalMacros = gunTotals;
            
            console.log('💾 Şablon GitHub\'a kaydediliyor:', currentEditingTemplate);
            
            // GitHub'a kaydet
            try {
                await saveTemplateToGitHub(currentEditingTemplate, isNewTemplate);
                
                // ✅ Başarı mesajı
                showToast(`✅ Şablon kaydedildi: ${templateName}`, 'success');
                
                // 📊 Şablonları yeniden yükle
                await loadDayTemplates();
                
                // 🔄 Haftalık içeriği yenile (render'daki değişiklikleri göster)
                renderWeekContent();
                
                // 🚪 Modal'ları kapat
                closeSaveTemplateModal();
                closeTemplateEditModal();
                
                // 📋 Template listesini yenile
                renderTemplateTable(dayTemplates, new Set());
                
                console.log('✅ Şablon başarıyla kaydedildi ve render güncellendi');
                
            } catch (error) {
                console.error('❌ GitHub kaydetme hatası:', error);
                alert(`❌ Kaydetme başarısız!\n\n${error.message}\n\nLütfen GitHub token'ınızı kontrol edin.`);
            }
        };
        
        /**
         * Şablonu GitHub'a kaydet (gun-sablonlari.json)
         * @param {Object} template - Kaydedilecek şablon
         * @param {boolean} isNew - Yeni şablon mu?
         */
        async function saveTemplateToGitHub(template, isNew) {
            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const FILE_PATH = 'gun-sablonlari-2025-10-25.json';
            const BRANCH = 'main';
            
            // 🔑 GitHub token kontrolü (önce modal'dan, sonra localStorage'dan)
            let token = document.getElementById('templateGithubToken')?.value?.trim();
            
            if (!token) {
                // Fallback: localStorage'dan dene
                token = localStorage.getItem('github_token');
            }
            
            if (!token) {
                throw new Error('❌ GitHub token bulunamadı!\n\nLütfen modal altındaki alana token girin veya localStorage\'a github_token ekleyin.');
            }
            
            // Token'ı localStorage'a kaydet (gelecek kullanımlar için)
            localStorage.setItem('github_token', token);
            console.log('✅ GitHub token localStorage\'a kaydedildi');
            
            // Mevcut dosyayı çek
            const getResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getResponse.ok) {
                throw new Error(`Dosya okunamadı: ${getResponse.status} ${getResponse.statusText}`);
            }
            
            const fileData = await getResponse.json();
            const currentContent = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
            const currentData = JSON.parse(currentContent);
            
            // 🔧 FIX: ogunler array'indeki değişiklikleri foods array'ine SENKRONIZE ET
            // Bu sayede modal'da silinen yemekler JSON'dan da silinir
            if (template.ogunler && Array.isArray(template.ogunler)) {
                template.foods = [];
                template.ogunler.forEach(ogun => {
                    if (ogun.yemekler && Array.isArray(ogun.yemekler)) {
                        ogun.yemekler.forEach(yemek => {
                            // Her yemeği foods array'ine ekle (ogunTipi bilgisiyle)
                            template.foods.push({
                                ...yemek,
                                ogunTipi: ogun.ogunAdi || ogun.originalTitle || 'öğle'
                            });
                        });
                    }
                });
                console.log(`✅ foods array senkronize edildi: ${template.foods.length} yemek`);
            }
            
            // Şablonları güncelle
            if (isNew) {
                // Yeni şablon ekle
                currentData.templates.push(template);
                currentData.totalCount = currentData.templates.length;
            } else {
                // Mevcut şablonu güncelle
                const index = currentData.templates.findIndex(t => t.id === template.id);
                if (index === -1) {
                    throw new Error('Güncellenecek şablon bulunamadı!');
                }
                currentData.templates[index] = template;
            }
            
            // Export date güncelle
            currentData.exportDate = new Date().toISOString();
            
            // JSON'a çevir (pretty print)
            const newContent = JSON.stringify(currentData, null, 2);
            
            // ✅ TÜRKÇE KARAKTER KORUYAN ENCODING
            const newContentBase64 = encodeBase64UTF8(newContent);
            
            // GitHub'a gönder
            const commitMessage = isNew 
                ? `Yeni şablon eklendi: ${template.name}` 
                : `Şablon güncellendi: ${template.name}`;
            
            const putResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: newContentBase64,
                    sha: fileData.sha,
                    branch: BRANCH
                })
            });
            
            if (!putResponse.ok) {
                const errorData = await putResponse.json();
                throw new Error(`GitHub commit başarısız: ${errorData.message || putResponse.statusText}`);
            }
            
            const commitData = await putResponse.json();
            console.log('✅ GitHub commit başarılı:', commitData.commit.sha);
        }
    </script>
    
    <!-- 📝 TEMPLATE EDIT MODAL -->
    <div id="templateEditModal" class="modal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
        <div class="modal-content" style="background-color: #fff; margin: 2% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1000px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 20px;">📝 Şablon Düzenle: <span id="templateEditName">-</span></h3>
                <button onclick="closeTemplateEditModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 6px; transition: all 0.2s;">
                    ✖ Kapat
                </button>
            </div>
            
            <!-- Modal Body -->
            <div id="templateEditContent" style="padding: 20px; max-height: 600px; overflow-y: auto;">
                <!-- Öğünler ve yemekler buraya gelecek -->
            </div>
            
            <!-- Modal Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px;">
                <!-- GitHub Token Girişi -->
                <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #856404;">
                        🔑 GitHub Token <span style="color: #dc3545;">*</span>
                        <span style="font-weight: normal; font-size: 12px; color: #666;">(Şablonu kaydetmek için gerekli)</span>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input 
                            type="password" 
                            id="templateGithubToken" 
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                        />
                        <button 
                            onclick="toggleTemplateTokenVisibility()" 
                            style="background: #6c757d; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            👁️ Göster
                        </button>
                        <button 
                            onclick="loadTemplateTokenFromStorage()" 
                            style="background: #17a2b8; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            💾 Yükle
                        </button>
                    </div>
                    <small style="color: #856404; display: block; margin-top: 5px;">
                        💡 Token localStorage'da kayıtlı değilse <a href="https://github.com/settings/tokens" target="_blank" style="color: #007bff;">GitHub</a>'dan oluşturun
                    </small>
                </div>
                
                <!-- Butonlar -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeTemplateEditModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        ❌ İptal
                    </button>
                    <button onclick="openSaveTemplateModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        💾 Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- � YEMEK DÜZENLEME MODALI -->
    <div id="templateFoodEditModal" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 2% auto; padding: 0; border-radius: 12px; width: 95%; max-width: 900px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); max-height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 18px;">✏️ Yemek Düzenle: <span id="editFoodModalTitle">-</span></h3>
            </div>
            
            <!-- Body - Scrollable -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Yemek Adı + Akıllı Search -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        🍽️ Yemek Adı <span style="color: #FF6B6B;">*</span>
                    </label>
                    <div style="position: relative;">
                        <input type="text" id="editFoodName" placeholder="Yemek adı yazın veya arayın..." oninput="searchFoodForEdit(this.value)" autocomplete="off" style="width: 100%; padding: 12px; font-size: 15px; border: 2px solid #FF6B6B; border-radius: 8px; box-sizing: border-box;">
                        <!-- Arama sonuçları dropdown -->
                        <div id="editFoodSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #FF6B6B; border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    <p style="margin: 6px 0 0 0; font-size: 12px; color: #666;">💡 İsim değiştirerek başka yemek seçebilirsiniz</p>
                </div>
                
                <!-- Makrolar -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">⚡ Kalori (kcal) *</label>
                        <input type="number" id="editFoodCalories" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🥩 Protein (g) *</label>
                        <input type="number" id="editFoodProtein" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🌾 Karbonhidrat (g) *</label>
                        <input type="number" id="editFoodCarbs" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🧈 Yağ (g) *</label>
                        <input type="number" id="editFoodFat" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                </div>
                
                <!-- Kategori & Rol -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">📂 Kategori *</label>
                        <select id="editFoodCategory" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Kategori Seçin --</option>
                            <option value="KAHVALTI">KAHVALTI</option>
                            <option value="ÖĞLEN">ÖĞLEN</option>
                            <option value="AKŞAM">AKŞAM</option>
                            <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                            <option value="ÇORBALAR">ÇORBALAR</option>
                            <option value="SALATALAR">SALATALAR</option>
                            <option value="ANA YEMEKLER">ANA YEMEKLER</option>
                            <option value="TOSTLAR">TOSTLAR</option>
                            <option value="TATLILAR">TATLILAR</option>
                            <option value="İÇECEKLER">İÇECEKLER</option>
                            <option value="ATIŞTIRILMALIKLAR">ATIŞTIRILMALIKLAR</option>
                            <option value="EKMEKLER">EKMEKLER</option>
                            <option value="PİLAVLAR">PİLAVLAR</option>
                            <option value="DİĞER">DİĞER</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">🎭 Rol *</label>
                        <select id="editFoodRole" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Rol Seçin --</option>
                            <option value="mainDish">Ana Yemek (mainDish)</option>
                            <option value="sideDish">Yan Yemek (sideDish)</option>
                            <option value="drink">İçecek (drink)</option>
                            <option value="supplement">Takviye (supplement)</option>
                            <option value="snack">Atıştırmalık (snack)</option>
                            <option value="soup">Çorba (soup)</option>
                            <option value="salad">Salata (salad)</option>
                            <option value="bread">Ekmek (bread)</option>
                            <option value="dessert">Tatlı (dessert)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Öğün Tipi -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">⏰ Öğün Tipi (Birden fazla seçilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_breakfast" value="breakfast" style="width: 18px; height: 18px;">
                            🌅 Kahvaltı
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_lunch" value="lunch" style="width: 18px; height: 18px;">
                            ☀️ Öğle
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_dinner" value="dinner" style="width: 18px; height: 18px;">
                            🌙 Akşam
                        </label>
                    </div>
                </div>
                
                <!-- Porsiyon Çarpanı -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📏 Porsiyon Çarpanı</label>
                    <input type="number" id="editFoodPortion" step="0.1" value="1" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <!-- Diyet Tipleri -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">🥑 Diyet Tipleri (Birden fazla seçilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_ketojenik" value="ketojenik" style="width: 18px; height: 18px;">
                            🥗 Ketojenik
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_akdeniz" value="akdeniz" style="width: 18px; height: 18px;">
                            🌊 Akdeniz
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_vegan" value="vegan" style="width: 18px; height: 18px;">
                            🌱 Vegan
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_glutensiz" value="glutensiz" style="width: 18px; height: 18px;">
                            🌾 Glutensiz
                        </label>
                    </div>
                </div>
                
                <!-- Gelişmiş Ayarlar (Collapsible) -->
                <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">⚙️ Gelişmiş Ayarlar</summary>
                    
                    <!-- Min/Max/Step -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Min Miktar</label>
                            <input type="number" id="editFoodMin" step="0.1" placeholder="Min porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Max Miktar</label>
                            <input type="number" id="editFoodMax" step="0.1" placeholder="Max porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Adım (Step)</label>
                            <input type="number" id="editFoodStep" step="0.1" placeholder="Artış miktarı" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- Sezon -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Başlangıç (Ay)</label>
                            <input type="number" id="editFoodSeasonMin" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Bitiş (Ay)</label>
                            <input type="number" id="editFoodSeasonMax" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- Özel Özellikler -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #666; font-size: 13px;">🏷️ Özel Özellikler</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodKeto" style="width: 16px; height: 16px;">
                                🥗 Keto
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodLowCarb" style="width: 16px; height: 16px;">
                                📉 Düşük Karb
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodPortionFixed" style="width: 16px; height: 16px;">
                                🔒 Porsiyon Sabit
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerLunch" style="width: 16px; height: 16px;">
                                🍽️ Öğle Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerDinner" style="width: 16px; height: 16px;">
                                🌙 Akşam Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodReversedSeason" style="width: 16px; height: 16px;">
                                🔄 Ters Sezon
                            </label>
                        </div>
                    </div>
                    
                    <!-- Etiketler -->
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">🏷️ Etiketler (Tags) - virgülle ayırın</label>
                        <input type="text" id="editFoodTags" placeholder="ör: domates, meyve, salata" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">✅ Uyumluluk Etiketleri (compatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="editFoodCompat" placeholder="ör: tavuk, zeytinyağı" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">❌ Uyumsuzluk Etiketleri (incompatibilityTags) - virgülle ayırın</label>
                        <input type="text" id="editFoodIncompat" placeholder="ör: süt, peynir" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">📝 Notlar</label>
                        <textarea id="editFoodNotes" placeholder="Ek bilgiler, özel notlar..." style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box; min-height: 60px; resize: vertical;"></textarea>
                    </div>
                </details>
            </div>
            
            <!-- Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 10px; justify-content: space-between; flex-shrink: 0; border-top: 1px solid #ddd;">
                <button onclick="closeTemplateFoodEditModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    ❌ İptal
                </button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; cursor: pointer;">
                        <input type="checkbox" id="saveFoodToDatabase" style="width: 16px; height: 16px;">
                        <span>💾 food_list.json'a da kaydet</span>
                    </label>
                    <button onclick="saveEditedTemplateFood()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        ✅ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- �🔍 FOOD SEARCH POPUP -->
    <div id="foodSearchPopup" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
            <!-- Popup Header -->
            <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">🔍 Yemek Ara</h3>
                <button onclick="closeFoodSearchPopup()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; font-size: 14px; cursor: pointer; border-radius: 4px;">
                    ✖ Kapat
                </button>
            </div>
            
            <!-- Search Input -->
            <div style="padding: 15px 20px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                <input type="text" id="templateFoodSearch" placeholder="Yemek adı yazın (örn: mercimek çorbası)" oninput="searchTemplateFoods(this.value)" style="width: 100%; padding: 12px; font-size: 15px; border: 2px solid #4CAF50; border-radius: 8px; box-sizing: border-box;">
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">💡 İpucu: "mer çor" gibi kısaltmalar da çalışır</p>
            </div>
            
            <!-- Search Results -->
            <div id="templateFoodSearchResults" style="padding: 15px 20px; min-height: 200px; max-height: 450px; overflow-y: auto;">
                <p style="color: #666; text-align: center;">Yemek aramak için yukarıya yazın...</p>
            </div>
        </div>
    </div>
    
    <!-- 💾 SAVE TEMPLATE MODAL -->
    <div id="saveTemplateModal" class="modal" style="display: none; position: fixed; z-index: 10003; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 10% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 550px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0;">
                <h3 style="margin: 0; font-size: 18px;">💾 Şablonu Kaydet</h3>
            </div>
            
            <!-- Body -->
            <div style="padding: 25px;">
                <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                    Mevcut şablon: <strong id="saveTemplateCurrentName">-</strong>
                </p>
                
                <!-- Kayıt seçenekleri -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Option 1: Üzerine Yaz -->
                    <label style="display: flex; align-items: start; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                        <input type="radio" name="saveMode" id="saveMode_overwrite" onchange="toggleSaveMode()" checked style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">📝 Mevcut Şablonu Güncelle</div>
                            <div style="font-size: 13px; color: #666;">Değişiklikler mevcut şablonun üzerine yazılacak</div>
                        </div>
                    </label>
                    
                    <!-- Option 2: Yeni Şablon -->
                    <label style="display: flex; align-items: start; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                        <input type="radio" name="saveMode" id="saveMode_new" onchange="toggleSaveMode()" style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">✨ Yeni Şablon Olarak Kaydet</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 10px;">Mevcut şablon korunacak, yeni şablon oluşturulacak</div>
                            
                            <!-- Yeni şablon adı input (hidden by default) -->
                            <div id="newNameContainer" style="display: none;">
                                <input type="text" id="saveTemplateNewName" placeholder="Örn: Menü 21" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #4CAF50; border-radius: 6px; box-sizing: border-box;">
                                <p style="margin: 6px 0 0 0; font-size: 11px; color: #999;">💡 Sıra numarası otomatik önerildi</p>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSaveTemplateModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    ❌ İptal
                </button>
                <button onclick="saveTemplate()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    💾 Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- PDF/Tarif Kartı Modal -->
    <div id="pdfModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 0; border: none; width: 90%; max-width: 900px; border-radius: 12px; max-height: 95vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700;">📖 Tarif Kartı</h3>
                <button onclick="closePdfModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: all 0.2s;">
                    ✖ Kapat
                </button>
            </div>
            
            <!-- PDF Viewer -->
            <div style="height: calc(95vh - 80px); background: #f0f0f0;">
                <img id="pdfImageViewer" src="" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                <iframe id="pdfIframeViewer" src="" style="width: 100%; height: 100%; border: none; display: none;"></iframe>
                <div id="pdfErrorMessage" style="display: none; padding: 40px; text-align: center; color: #666;">
                    <p style="font-size: 16px; margin-bottom: 15px;">⚠️ Tarif kartı bu pencerede görüntülenemiyor.</p>
                    <a id="pdfDirectLink" href="" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        🔗 Yeni Sekmede Aç
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Service Worker Kaydı -->
    <script>
        // Service Worker ve PWA Kurulumu  
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // GitHub Pages için relative path
                const swPath = './service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .then(function(registration) {
                        console.log('✅ Service Worker kaydedildi:', registration.scope);
                        
                        // iOS Safe Area kontrolü
                        const safeAreaTop = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top');
                        console.log('📱 iOS Safe Area Top:', safeAreaTop || 'Yok');
                    })
                    .catch(function(error) {
                        console.log('❌ Service Worker kayıt hatası:', error);
                    });
            });
        }

        // PWA yükleme promptunu yakalama
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Otomatik banner'ı engelle
            e.preventDefault();
            deferredPrompt = e;
            
            // İsteğe bağlı: Özel install butonu gösterebilirsiniz
            console.log('💫 PWA yüklenebilir durumda');
            
            // Otomatik olarak install prompt göster (iPhone için)
            if (window.DeviceMotionEvent !== undefined && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS cihaz
                setTimeout(() => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('✅ PWA yüklemesi kabul edildi');
                            } else {
                                console.log('❌ PWA yüklemesi reddedildi');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 2000);
            }
        });

        // PWA başarıyla yüklendiğinde
        window.addEventListener('appinstalled', (evt) => {
            console.log('🎉 PWA başarıyla yüklendi!');
        });

        // Offline/Online durumu kontrol et
        window.addEventListener('online', () => {
            console.log('🌐 İnternet bağlantısı aktif');
        });
        
        window.addEventListener('offline', () => {
            console.log('📱 Offline modda çalışıyor');
        });
    </script>

</body>
</html>

