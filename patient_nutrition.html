<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Beslenme Planƒ±m">
    <meta name="application-name" content="Beslenme Planƒ±m">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="./logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="./logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png">
    <link rel="manifest" href="./manifest-patient-nutrition.json">

    <title>Beslenme Planƒ±m - Lipodem Takip</title>
    
    <!-- Authentication System -->
    <script src="./auth.js"></script>
    
    <!-- Template Manager for Lazy Loading -->
    <script src="./template_manager.js"></script>
    
    <!-- Nutrition Data Manager -->
    <script src="./nutrition_data_manager.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- OneSignal Config (Bildirim i√ßin) -->
    <script src="./onesignal_config.js"></script>
    
    <!-- OneSignal SDK v16 -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        // OneSignal v16 - Hasta bildirimleri i√ßin geli≈ümi≈ü yapƒ±landƒ±rma
        // üî• DOMAIN BAZLI APP ID SE√áƒ∞Mƒ∞ (GitHub Pages vs Vercel vs Localhost)
        const isGitHubPages = window.location.hostname.includes('github.io');
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Localhost i√ßin de Vercel App ID kullan (allowLocalhostAsSecureOrigin ile)
        const ONESIGNAL_APP_ID = isGitHubPages 
            ? "45686db4-9813-42ef-939d-1402fe1622f7"  // ‚úÖ GitHub Pages App ID
            : "109f129c-cd73-4708-ba9a-b3c8103c52dc"; // ‚úÖ Vercel App ID (localhost i√ßin de)
        
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            console.log('üîî OneSignal v16 yapƒ±landƒ±rmasƒ± ba≈ülatƒ±lƒ±yor (HASTA)...');
            console.log('üîç DEBUG: OneSignal init VERSION 3.0 (LOCALHOST + PATIENT + AUTO PROMPT)');
            console.log('üîî OneSignal App ID:', ONESIGNAL_APP_ID, '(Domain:', window.location.hostname + ')');
            console.log('üåê Localhost mode:', isLocalhost);
            
            try {
                await OneSignal.init({
                    appId: ONESIGNAL_APP_ID,
                    allowLocalhostAsSecureOrigin: true, // ‚úÖ Localhost i√ßin kritik
                    serviceWorkerPath: 'OneSignalSDKWorker.js',
                    serviceWorkerParam: { scope: '/' },
                    
                    // T√ºrk√ße bildirim prompt mesajlarƒ±
                    promptOptions: {
                        slidedown: {
                            enabled: true,
                            actionMessage: "Mesajlarƒ±nƒ±zdan haberdar olmak ister misiniz?",
                            acceptButtonText: "Bildirimleri A√ß",
                            cancelButtonText: "Sonra",
                            categories: {
                                tags: {
                                    updateMessage: "Bildirim tercihlerinizi g√ºncelleyin",
                                    confirmButtonText: "Kaydet"
                                }
                            }
                        },
                        native: {
                            enabled: true,
                            autoPrompt: false
                        },
                        customlink: {
                            enabled: true,
                            style: "button",
                            size: "medium",
                            color: {
                                button: '#667eea',
                                text: '#ffffff'
                            },
                            text: {
                                subscribe: "Bildirimleri A√ß",
                                unsubscribe: "Bildirimleri Kapat",
                                explanation: "Yeni mesajlardan haberdar olun"
                            },
                            unsubscribeEnabled: true
                        }
                    },
                    
                    // Ho≈ü geldiniz bildirimi
                    welcomeNotification: {
                        disable: false,
                        title: "Lip√∂dem Merkezi",
                        message: "Abone olduƒüunuz i√ßin te≈üekk√ºrler! Artƒ±k mesajlarƒ±nƒ±zdan haberdar olacaksƒ±nƒ±z. üéâ"
                    },
                    
                    // Notification clicked event i√ßin T√ºrk√ße mesajlar
                    notifyButton: {
                        enable: false
                    }
                });
                
                console.log('‚úÖ OneSignal SDK y√ºklendi (HASTA)');
                
                // Bildirim izni kontrol
                const permission = await OneSignal.Notifications.permission;
                console.log('üì± Bildirim izni:', permission);
                
                // ƒ∞zin verilmemi≈üse OTOMATIK ƒ∞STE (iPhone i√ßin kritik)
                if (permission === false || !permission) {
                    console.log('üîî Bildirim izni YOK - otomatik isteniyor...');
                    
                    // Bildirim banner g√∂ster
                    showNotificationBanner();
                    
                } else if (permission === true) {
                    console.log('‚úÖ Bildirim izni VAR - push subscription aktif ediliyor...');
                    
                    // Push subscription (background bildirimler i√ßin)
                    const isPushSupported = await OneSignal.Notifications.isPushSupported();
                    console.log('üì≤ Push destekleniyor mu:', isPushSupported);
                    
                    if (isPushSupported) {
                        const isOptedIn = await OneSignal.User.PushSubscription.optedIn;
                        console.log('üîÑ Push subscription durumu:', isOptedIn ? 'Aktif' : 'Pasif');
                        
                        if (!isOptedIn) {
                            await OneSignal.User.PushSubscription.optIn();
                            console.log('‚úÖ Push subscription aktif edildi');
                        }
                    }
                }
                
                // Kullanƒ±cƒ± login bilgisi al (auth.js'den)
                let patientId = localStorage.getItem('currentUser');
                const patientName = localStorage.getItem('patientName') || 'Hasta';
                
                // currentUser JSON object ise parse et ve sadece ID'yi al
                try {
                    const parsed = JSON.parse(patientId);
                    if (parsed && typeof parsed === 'object') {
                        // Eski format temizliƒüi - sadece patient_XXXXX ID'sini kullan
                        patientId = null;
                        console.warn('‚ö†Ô∏è currentUser JSON object formatƒ±nda (eski veri), temizlendi');
                    }
                } catch (e) {
                    // JSON deƒüilse string olarak kullan (doƒüru format)
                }
                
                if (patientId && patientId.startsWith('patient_')) {
                    console.log('üë§ Hasta ID:', patientId);
                    
                    try {
                        // √ñnce mevcut user ID'yi kontrol et (v16: property, not function)
                        const currentExternalId = OneSignal.User.externalId;
                        
                        // Eƒüer farklƒ± bir user ID varsa logout yap
                        if (currentExternalId && currentExternalId !== patientId) {
                            console.log('üîÑ Farklƒ± kullanƒ±cƒ± tespit edildi, logout yapƒ±lƒ±yor...', currentExternalId, '->', patientId);
                            await OneSignal.logout();
                            await new Promise(resolve => setTimeout(resolve, 500)); // Logout'un tamamlanmasƒ± i√ßin bekle
                            console.log('‚úÖ Logout tamamlandƒ±');
                        } else if (currentExternalId === patientId) {
                            console.log('‚ÑπÔ∏è Zaten aynƒ± kullanƒ±cƒ± ile login olunmu≈ü:', patientId);
                            // Aynƒ± user zaten login - tekrar login yapma
                            return;
                        }
                        
                        // CRITICAL: External User ID set et (bildirim almak i√ßin)
                        await OneSignal.login(patientId);
                        console.log('‚úÖ OneSignal login (External ID set):', patientId);
                        
                        // User tag ekle (admin deƒüil, hasta)
                        await OneSignal.User.addTag('user_type', 'patient');
                        await OneSignal.User.addTag('patient_id', patientId);
                        await OneSignal.User.addTag('patient_name', patientName);
                        console.log('üè∑Ô∏è Hasta tag eklendi:', patientId, patientName);
                    } catch (loginError) {
                        console.error('‚ùå OneSignal login hatasƒ±:', loginError);
                        console.error('Hata detayƒ±:', loginError.message || loginError);
                    }
                }
                
                // Subscription ID al (OneSignal v16 - Player ID yerine)
                const subscriptionId = OneSignal.User.PushSubscription.id;
                const token = OneSignal.User.PushSubscription.token;
                console.log('üÜî OneSignal Subscription ID:', subscriptionId || 'Hen√ºz olu≈ümadƒ±');
                console.log('üîë Push Token:', token ? 'Mevcut' : 'Yok');
                
                // Foreground notification handler (v16'da otomatik g√∂steriliyor)
                OneSignal.Notifications.addEventListener('foregroundWillDisplay', (event) => {
                    console.log('üì¨ Foreground bildirim alƒ±ndƒ± (uygulama a√ßƒ±k):', event);
                    // event.preventDefault() artƒ±k desteklenmiyor - bildirimler otomatik g√∂steriliyor
                });
                
                console.log('‚úÖ OneSignal v16 yapƒ±landƒ±rmasƒ± tamamlandƒ± (HASTA)');
                
            } catch (error) {
                console.error('‚ùå OneSignal init hatasƒ± (HASTA):', error);
            }
        });
        
        // Global error handler - OneSignal SessionManager hatalarƒ±nƒ± suppress et
        window.addEventListener('unhandledrejection', function(event) {
            // SessionManager hatalarƒ±nƒ± sessizce yakala
            if (event.reason && event.reason.stack && 
                (event.reason.stack.includes('SessionManager') || 
                 event.reason.stack.includes('handleOnFocus') ||
                 event.reason.stack.includes('handleOnBlur'))) {
                console.log('‚ÑπÔ∏è OneSignal SessionManager hatasƒ± suppress edildi (zararsƒ±z)');
                event.preventDefault();
            }
        });
        
        // Bildirim izin banner g√∂ster (iPhone i√ßin)
        function showNotificationBanner() {
            const banner = document.createElement('div');
            banner.id = 'notification-permission-banner';
            banner.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    <p style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">üîî Yeni mesajlardan haberdar olun</p>
                    <button onclick="enableNotifications()" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; margin-right: 10px;">Bildirimleri A√ß</button>
                    <button onclick="closeBanner()" style="background: transparent; color: white; border: 1px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer;">≈ûimdi Deƒüil</button>
                </div>
            `;
            document.body.insertBefore(banner, document.body.firstChild);
        }
        
        // Bildirim izni iste
        async function enableNotifications() {
            try {
                console.log('üîî Kullanƒ±cƒ± bildirim iznine tƒ±kladƒ± - izin isteniyor...');
                const result = await OneSignal.Notifications.requestPermission();
                console.log('üìù ƒ∞zin sonucu:', result);
                
                if (result) {
                    // Push subscription aktif et
                    await OneSignal.User.PushSubscription.optIn();
                    console.log('‚úÖ Push subscription aktif edildi');
                    
                    // Banner kapat
                    closeBanner();
                    
                    // Ba≈üarƒ± mesajƒ±
                    alert('‚úÖ Bildirimler a√ßƒ±ldƒ±! Artƒ±k yeni mesajlardan haberdar olacaksƒ±nƒ±z.');
                } else {
                    alert('‚ùå Bildirim izni reddedildi. Tarayƒ±cƒ± ayarlarƒ±ndan a√ßabilirsiniz.');
                }
            } catch (error) {
                console.error('‚ùå Bildirim izin hatasƒ±:', error);
                alert('‚ùå Bildirim izni alƒ±namadƒ±: ' + error.message);
            }
        }
        
        // Banner kapat
        function closeBanner() {
            const banner = document.getElementById('notification-permission-banner');
            if (banner) banner.remove();
            
            // 1 saat sonra tekrar g√∂ster
            setTimeout(() => {
                const permission = OneSignal.Notifications.permission;
                if (!permission) showNotificationBanner();
            }, 3600000);
        }
    </script>
    
    <!-- Chat Manager -->
    <script src="chat_manager.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iPhone i√ßin header kamera √ßentiƒüi tam altƒ±ndan ba≈ülasƒ±n */
        @media only screen and (max-device-width: 812px) {
            .header {
                padding-top: env(safe-area-inset-top, 0px) !important;
                margin-top: 0px !important;
            }
        }

        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none; /* Mobil cihazlarda pull-to-refresh'i engelle */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
            touch-action: manipulation; /* Hƒ±zlƒ± dokunma tepkisi - iOS'ta 300ms gecikmesini kaldƒ±r */
            -webkit-user-select: none; /* iOS'ta metin se√ßimini engelle */
            -webkit-touch-callout: none; /* iOS'ta uzun basma men√ºs√ºn√º engelle */
            user-select: none; /* Genel metin se√ßimini engelle */
            
            /* iOS Safe Area desteƒüi - Sadece yanlar ve alt */
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header - Mobil Optimize */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            min-height: 44px;
            
            /* iOS kamera √ßentiƒüi i√ßin minimal margin */
            margin-top: 0px;
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0; /* Overflow i√ßin */
        }

        .patient-info h2 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .patient-info p {
            display: none; /* Mobilde "Beslenme Programƒ±" yazƒ±sƒ±nƒ± gizle */
        }

        .header-right {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap; /* Butonlar her zaman yan yana */
        }

        /* Header butonlarƒ± - ƒ∞konik yuvarlak */
        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            
            /* iOS i√ßin minimum dokunma alanƒ± */
            min-width: 44px;
            min-height: 44px;
            touch-action: manipulation;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.05);
        }

        /* Geri Butonu - Mobil versiyondan d√∂n√º≈ü */
        .btn-back {
            background: rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.8);
            color: white;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none; /* Varsayƒ±lan gizli */
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-back:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        /* Mobil Versiyon iFrame Container */
        .mobile-iframe-container {
            display: none;
            position: fixed;
            top: 52px; /* Header y√ºksekliƒüi + biraz margin */
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 999;
        }

        .mobile-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .btn-header span {
            display: none; /* Mobilde metin gizle, sadece ikon */
        }

        /* Main Container */
        .main-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 10px 12px;
            
            /* Safe area i√ßin padding - sadƒ±r √ºst kƒ±sƒ±m */
            padding-top: max(10px, calc(10px + env(safe-area-inset-top, 0px)));
        }

        /* Tabs Container - Mobil Optimize */
        .tabs-wrapper {
            display: grid; /* ‚úÖ Grid layout - daha g√º√ßl√º kontrol */
            grid-template-columns: 1fr auto; /* Hafta se√ßici esnek, butonlar sabit */
            gap: 6px;
            margin-bottom: 10px;
            align-items: center;
            width: 100%; /* T√ºm geni≈üliƒüi kullan */
        }
        
        /* Hafta Se√ßici Dropdown - Responsive Geni≈ülik */
        .week-selector {
            position: relative;
            width: 100%; /* Grid cell'in tamamƒ±nƒ± kapla */
            min-width: 0; /* Grid item i√ßin gerekli */
        }
        
        .week-selector-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px; /* 10px'den k√º√ß√ºlt√ºld√º */
            padding: 8px 12px; /* 10px 14px'den k√º√ß√ºlt√ºld√º */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
            transition: all 0.3s;
            width: 100%;
            min-width: 0; /* Flex shrink i√ßin gerekli */
            box-sizing: border-box; /* Padding dahil geni≈ülik hesabƒ± */
        }
        
        .week-selector-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .week-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .week-selector-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .week-dropdown-item {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .week-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .week-dropdown-item:hover {
            background: linear-gradient(135deg, #667eea15, #764ba215);
        }
        
        .week-dropdown-item.active {
            background: linear-gradient(135deg, #667eea25, #764ba225);
            font-weight: 600;
            color: #667eea;
        }
        
        .week-item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .week-item-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .week-item-date {
            font-size: 11px;
            color: #999;
        }
        
        .week-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .week-item-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .week-item-actions .btn-edit {
            background: #ffc107;
            color: #333;
        }
        
        .week-item-actions .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .week-item-actions button:hover {
            transform: scale(1.1);
        }
        
        /* Hafta i≈ülem butonlarƒ± - Grid i√ßinde sabit geni≈ülik */
        .week-actions {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-self: end; /* Grid cell'de saƒüa hizala */
        }
        
        /* Minimal ƒ∞kon Butonlarƒ± - Outline Style */
        .week-action-btn {
            min-width: 28px;
            max-width: 28px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1.5px solid #667eea;
            background: transparent;
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            flex-shrink: 0;
        }

        .week-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }

        .week-action-btn:active {
            transform: translateY(0);
        }

        .week-delete-btn {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .week-delete-btn:hover {
            background: #ff6b6b;
            color: white;
            box-shadow: 0 3px 8px rgba(255, 107, 107, 0.3);
        }

        .week-day-btn {
            border-color: #48c774;
            color: #48c774;
        }

        .week-day-btn:hover {
            background: #48c774;
            color: white;
            box-shadow: 0 3px 8px rgba(72, 199, 116, 0.3);
        }

        .tabs-container {
            display: none; /* Eski tab sistemi gizli */
        }

        .tab {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: auto;
            font-size: 13px;
        }

        .tab:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102,126,234,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .tab-close {
            margin-left: 6px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.8;
        }

        .tab-close:hover {
            opacity: 1;
            background: rgba(255,255,255,0.5);
        }

        /* Yeni Hafta Ekle Butonu - Sadece Artƒ± ƒ∞kon */
        .btn-add-week {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-add-week:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76,175,80,0.4);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .week-content {
            display: none;
        }

        .week-content.active {
            display: block;
        }

        /* Week Header - Mobil Optimize (Aktif Hafta Ba≈ülƒ±ƒüƒ± Kaldƒ±rƒ±ldƒ±) */
        .week-header {
            display: none; /* Aktif hafta i√ßin ayrƒ± ba≈ülƒ±k yok - tab zaten belirgin */
        }

        /* Week Macros - ƒ∞nce Bant */
        .week-macros {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .week-macros .macro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .week-macros .label {
            font-size: 10px;
            opacity: 0.7;
            font-weight: 500;
        }

        .week-macros .value {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
        }

        .week-info p {
            color: #666;
            font-size: 14px;
        }

        .week-stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-box .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-box .value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-top: 3px;
        }

        /* Day Cards */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        /* Bug√ºn√ºn tarihi vurgusu */
        .day-card.today-highlight {
            border: 3px solid #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .day-card.today-highlight:hover {
            border-color: #218838;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
        }

        .day-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .day-date {
            font-size: 12px;
            color: #666;
        }

        .btn-refresh-day {
            width: 32px;
            height: 32px;
            padding: 0;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .btn-refresh-day::before {
            content: "‚Üª";
            font-size: 16px;
            font-weight: bold;
            display: block;
        }

        .btn-refresh-day:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #5a3a7c 100%);
        }

        .btn-refresh-day:active {
            transform: scale(0.95);
        }

        .btn-refresh-day:hover::before {
            animation: spin 0.6s ease-in-out;
        }

        .btn-delete-day {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        .btn-delete-day:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.5);
        }

        .btn-delete-day:active {
            transform: scale(0.95);
        }

        .btn-template-edit {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
        }

        .btn-template-edit:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.5);
        }
        

        .btn-template-edit:active {
            transform: scale(0.95);
        }

        .btn-food-admin {
            background: linear-gradient(135deg, #FF6B6B 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        .btn-food-admin:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.5);
        }

        .btn-food-admin:active {
            transform: scale(0.95);
        }
        
        /* G√ºn kartƒ± tablo ba≈ülƒ±ƒüƒ± */
        .day-table-header {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 4px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .day-table-header > div {
            text-align: center;
            padding: 0 2px;
        }
        
        .day-table-header > div:first-child {
            text-align: left;
            padding-left: 4px;
        }
        
        /* G√ºn makrolarƒ± kompakt - tek satƒ±r */
        .day-macros-compact {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 6px 4px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .day-macros-compact > div {
            color: #333;
            font-weight: 600;
            text-align: center;
            padding: 0 2px;
        }
        
        .day-macros-compact > div:first-child {
            text-align: left;
            padding-left: 4px;
        }
        
        /* Haftalƒ±k ƒ∞statistikler - Tablo Benzeri */
        .week-stats-header {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 6px 4px;
            border-radius: 6px 6px 0 0;
            border-bottom: 1px solid #dee2e6;
            margin-top: 10px;
        }
        
        .week-stats-values {
            display: flex;
            align-items: center;
            background: white;
            padding: 6px 4px;
            border-radius: 0 0 6px 6px;
            border: 1px solid #dee2e6;
            border-top: none;
            margin-bottom: 10px;
        }

        .meals-list {
            margin-top: 10px;
        }

        .meal-item {
            background: white;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
            border: 2px solid #667eea;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
        }

        .meal-item-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 4px;
            border-bottom: 2px solid #5a3a7c;
        }
        
        .meal-item-header > div {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .meal-item-header > div > div {
            text-align: center;
            padding: 0 2px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .meal-item-header > div > div:first-child {
            text-align: left;
            padding-left: 4px;
            color: white;
        }

        .meal-item-content {
            padding: 10px;
        }

        .meal-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .meal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            table-layout: fixed;
        }

        .meal-table thead {
            background: #f8f9fa;
        }

        .meal-table th {
            padding: 6px 4px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .meal-table td {
            padding: 6px 2px;
            color: #666;
            border-bottom: 1px solid #f1f3f5;
            vertical-align: top;
        }

        .meal-table tbody tr:last-child td {
            border-bottom: none;
        }

        .meal-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Tarif Badge Styles */
        .tarif-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }

        .tarif-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea87a 100%);
        }

        .tarif-badge:active {
            transform: translateY(0);
        }

        /* Refresh Food Button - Pill tarzƒ± rozet gibi */
        .btn-refresh-food,
        .btn-change-food {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.3);
        }

        .btn-refresh-food:hover,
        .btn-change-food:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 123, 255, 0.4);
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }

        .btn-refresh-food:active,
        .btn-change-food:active {
            transform: translateY(0);
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        
        .toast-notification.success {
            border-left: 4px solid #28a745;
        }
        
        .toast-notification.error {
            border-left: 4px solid #dc3545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        /* Food Selector Modal */
        .food-selector-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            padding: 20px;
            overflow: auto;
        }
        
        .food-selector-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .food-selector-iframe-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-close-btn {
            position: absolute;
            top: max(40px, env(safe-area-inset-top, 10px) + 30px); /* ‚úÖ iPhone safe area + 30px */
            right: 10px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-close-btn:hover {
            background: rgba(200, 35, 51, 1);
            transform: scale(1.1);
        }
        
        .food-selector-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Diyet Tipi Rozetleri (Keto/Lowcarb) */
        .diet-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            white-space: nowrap;
        }

        .diet-badge-keto {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }

        .diet-badge-lowcarb {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            box-shadow: 0 1px 3px rgba(255, 193, 7, 0.3);
        }

        /* Genel Rozet Stilleri */
        .food-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        /* Admin i√ßin tƒ±klanabilir rozet hover efekti */
        .food-badge[onclick] {
            cursor: pointer;
        }
        
        .food-badge[onclick]:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        .badge-role {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
        }

        .badge-category {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
        }

        .badge-season {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            box-shadow: 0 1px 3px rgba(6, 182, 212, 0.3);
        }

        .badge-mealtype {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3);
        }

        .badge-tags {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            box-shadow: 0 1px 3px rgba(236, 72, 153, 0.3);
        }

        .meal-foods {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }

        .btn-add-day {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-add-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 14px;
        }

        /* üéØ BO≈û HAFTA B√úY√úK BUTON STƒ∞LLERƒ∞ */
        .empty-week-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 20px;
        }

        .empty-week-card {
            background: white;
            border-radius: 20px;
            padding: 48px 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-week-icon {
            font-size: 64px;
            margin-bottom: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .empty-week-title {
            color: #2d3748;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .empty-week-description {
            color: #718096;
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .empty-week-auto-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px 36px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .empty-week-auto-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .empty-week-auto-btn:active {
            transform: translateY(0);
        }

        .empty-week-auto-btn .btn-icon {
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .empty-week-divider {
            margin: 24px 0;
            position: relative;
            text-align: center;
        }

        .empty-week-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
        }

        .empty-week-divider span {
            background: white;
            padding: 0 16px;
            color: #a0aec0;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }

        .empty-week-manual-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .empty-week-manual-btn:hover {
            background: #f7fafc;
            transform: translateY(-1px);
        }

        .empty-week-manual-btn:active {
            transform: translateY(0);
        }

        /* Mobil responsive */
        @media (max-width: 768px) {
            .empty-week-card {
                padding: 36px 24px;
            }

            .empty-week-icon {
                font-size: 48px;
            }

            .empty-week-title {
                font-size: 20px;
            }

            .empty-week-description {
                font-size: 14px;
            }

            .empty-week-auto-btn {
                padding: 16px 28px;
                font-size: 15px;
            }

            .empty-week-manual-btn {
                padding: 12px 24px;
                font-size: 14px;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Template Selection */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .template-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-item:hover {
            border-color: #667eea;
            background: #e7f0ff;
        }

        .template-item.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-item.used-template {
            background: #d4edda;
            border-color: #28a745;
        }

        .template-item.used-template:hover {
            background: #c3e6cb;
            border-color: #28a745;
        }

        .template-item.used-template.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .template-macros {
            font-size: 11px;
            opacity: 0.8;
        }

        .btn-sort {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-sort:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-sort:active {
            transform: translateY(0);
        }

        .template-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .template-table th,
        .template-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: left;
        }

        .template-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .template-table th:hover {
            background: #5568d3;
        }

        .template-table th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.8em;
        }

        .template-table th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        .template-table th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        .template-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-table tbody tr:hover {
            background: #f8f9fa;
        }

        .template-table tbody tr.selected {
            background: #cff4fc;
            border-left: 4px solid #0dcaf0;
        }

        .template-table tbody tr.used-template {
            background: #d4edda;
        }

        .template-table .meal-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .template-selected-days {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 11px;
            font-weight: 600;
        }

        .template-item:not(.selected) .template-selected-days {
            border-top-color: #dee2e6;
            color: #0d6efd;
        }

        /* Selected Templates Band */
        #selectedTemplatesBand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .selected-day-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #055160;
            background: #cff4fc;
            border: 2px solid #0dcaf0;
            position: relative;
        }

        .selected-day-badge .order-number {
            background: rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .selected-day-badge .remove-badge {
            background: rgba(255, 255, 255, 0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .selected-day-badge .remove-badge:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            /* ‚úÖ GRID LAYOUT KORUNUR - FLEX'E D√ñNMEZ */
            .tabs-wrapper {
                display: grid !important;
                grid-template-columns: 1fr auto !important; /* Hafta se√ßici esnek, butonlar sabit */
                gap: 4px !important;
                align-items: center !important;
            }

            .days-grid {
                grid-template-columns: 1fr;
            }

            .week-stats {
                flex-direction: column;
                gap: 10px;
            }

            .header-right {
                gap: 5px; /* Mobilde butonlar yine yan yana, sadece gap k√º√ß√ºl√ºyor */
            }

            .btn-header {
                width: 32px; /* Mobilde biraz daha k√º√ß√ºk */
                height: 32px;
                font-size: 16px;
            }
            
            /* Modal tam ekran */
            #addDayModal .modal-content {
                width: 100% !important;
                height: 100vh !important;
                max-width: 100% !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* ‚úÖ Week selector - GRID i√ßinde tam geni≈ülik */
            .week-selector {
                width: 100% !important;
                min-width: 0 !important;
            }
            
            .week-selector-button {
                padding: 6px 8px !important;
                font-size: 12px !important;
                width: 100% !important;
            }
            
            /* ‚úÖ Week actions - GRID i√ßinde saƒüa hizalƒ± */
            .week-actions {
                display: flex !important;
                gap: 4px !important;
                justify-self: end !important;
            }
            
            /* ƒ∞kon butonlar mobilde k√º√ß√ºl√ºr */
            .week-action-btn {
                min-width: 28px !important;
                max-width: 28px !important;
                width: 28px !important;
                height: 28px !important;
            }
            
            /* G√ºn ekle butonu - mor renk */
            .week-actions .btn-add-day-top {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                font-weight: 600 !important;
                border: none !important;
            }
            
            /* Mobilde minimal kenarlƒ±k padding - EKSTRA AZALTILDI */
            .main-container {
                padding: 5px !important; /* 10px'den 5px'e */
            }
            
            .day-card {
                padding: 5px !important; /* 8px'den 5px'e */
                margin-bottom: 8px !important; /* Kartlar arasƒ± bo≈üluk azalt */
            }
            
            .meal-item {
                margin-bottom: 6px !important; /* √ñƒü√ºnler arasƒ± bo≈üluk azalt */
            }
            
            .meal-item-content {
                padding: 3px !important; /* 5px'den 3px'e */
            }
            
            table th,
            table td {
                padding: 3px 1px !important; /* 4px 2px'den 3px 1px'e */
                font-size: 11px !important; /* Yazƒ± boyutu k√º√ß√ºlt */
            }
            
            /* Rozet boyutlarƒ±nƒ± k√º√ß√ºlt */
            .food-badge {
                padding: 1px 6px !important;
                font-size: 9px !important;
            }
            
            .btn-refresh-food {
                padding: 3px 8px !important;
                font-size: 10px !important;
            }
            
            /* Mobilde g√ºn tablo ba≈ülƒ±ƒüƒ± ve makrolar */
            .day-table-header {
                padding: 4px 6px !important;
                font-size: 11px !important;
            }
            
            .day-macros-compact {
                padding: 4px 6px !important;
                font-size: 11px !important;
            }
            
            /* ƒ∞kon Butonlarƒ± Mobil */
            .week-actions {
                gap: 6px;
            }
            
            .week-action-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }
        
        /* ‚úÖ √áok k√º√ß√ºk ekranlar - AYRI MEDIA QUERY (nested deƒüil) */
        @media (max-width: 380px) {
            .tabs-wrapper {
                grid-template-columns: 1fr auto !important;
            }
            
            .week-selector {
                width: 100% !important;
                min-width: 0 !important;
            }
            
            .week-selector-button {
                font-size: 11px !important;
                padding: 6px 8px !important;
            }
            
            .week-action-btn {
                min-width: 26px !important;
                max-width: 26px !important;
                width: 26px !important;
                height: 26px !important;
            }
        }
        
        /* ‚úÖ Ekstra k√º√ß√ºk ekranlar - AYRI MEDIA QUERY (nested deƒüil) */
        @media (max-width: 320px) {
            .tabs-wrapper {
                grid-template-columns: 1fr auto !important;
            }
            
            .week-selector {
                width: 100% !important;
                min-width: 0 !important;
            }
            
            .week-selector-button {
                font-size: 10px !important;
                padding: 5px 6px !important;
            }
            
            .week-action-btn {
                min-width: 24px !important;
                max-width: 24px !important;
                width: 24px !important;
                height: 24px !important;
            }
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Message */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            animation: slideInUp 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Admin Modal Tab Styles */
        .admin-tab-btn {
            flex: 1;
            min-width: 180px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .admin-tab-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .admin-tab-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #adminTabContent {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            min-height: 400px;
        }

        /* ============================================
           üîó ADMIN MODAL: TARIF KARTLARI GRID Sƒ∞STEMƒ∞
           ============================================ */
        
        /* Se√ßili Tarif Kartlarƒ± Listesi */
        .selected-tarif-list {
            background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .selected-tarif-list-title {
            font-size: 14px;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-tarif-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-tarif-tag {
            background: white;
            border: 1px solid #28a745;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 13px;
            color: #28a745;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .selected-tarif-tag:hover {
            background: #fff5f5;
            border-color: #dc3545;
            color: #dc3545;
        }

        .selected-tarif-tag .remove-icon {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .selected-tarif-empty {
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        /* Search Input - G√ºzelle≈ütirilmi≈ü */
        .tarif-search-container {
            margin-bottom: 20px;
        }

        .tarif-search-input {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .tarif-search-input:focus {
            outline: none;
            border-color: #764ba2;
            background: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .tarif-search-input::placeholder {
            color: #999;
            font-weight: 400;
        }

        /* Tarif Kartlarƒ± Grid */
        .tarif-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .tarif-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .tarif-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .tarif-item.selected {
            border-color: #28a745;
            background: #f0fff4;
        }

        .tarif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .tarif-name {
            font-size: 12px;
            color: #333;
            word-break: break-word;
            font-weight: 500;
        }

        /* Se√ßili Kartlar Sayacƒ± */
        .admin-selected-count {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .admin-selected-count.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Y√ºkleme Animasyonu */
        .admin-loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .admin-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Kart Bulunamadƒ± */
        .admin-no-results {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 15px;
        }

        .admin-no-results::before {
            content: 'üîç';
            display: block;
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* ========================================
           TAB 3 & TAB 4: YEMEK VERƒ∞TABANI STƒ∞LLERƒ∞
           ======================================== */
        
        /* Yemek listesi item (Tab 3 - Tek se√ßim) */
        .food-db-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-db-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .food-db-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Yasak yemek item (Tab 4 - √áoklu se√ßim) */
        .food-ban-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }

        .food-ban-item:hover {
            border-color: #f44336;
            transform: translateX(5px);
        }

        .food-ban-item.selected {
            border-color: #f44336;
            background: #fff3f3;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        /* === CHAT WIDGET STILLER === */
        #chatWidget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        #chatButton {
            background: #25D366; /* WhatsApp ye≈üil */
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        #chatButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
            background: #128C7E; /* WhatsApp koyu ye≈üil */
        }

        #chatButton .badge {
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        #chatBox {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-width: calc(100vw - 40px);
            height: 500px;
            max-height: 70vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        #chatBox.open {
            display: flex;
        }

        .chat-header {
            background: #128C7E; /* WhatsApp koyu ye≈üil */
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f7fa;
            min-height: 0; /* Flex child i√ßin √∂nemli - scroll √ßalƒ±≈ümasƒ± i√ßin */
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #DCF8C6; /* WhatsApp a√ßƒ±k ye≈üil */
            color: #000;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Tarih ayƒ±rƒ±cƒ± (WhatsApp tarzƒ±) */
        .date-separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-separator::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: #e0e0e0;
        }

        .date-separator span {
            background: #f5f7fa;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            position: relative;
            z-index: 1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Mesaj i√ßeriƒüi ve zaman (WhatsApp tarzƒ±) */
        #chatMessages .message-bubble {
            position: relative;
            padding-bottom: 20px !important;
        }

        .message-content {
            display: inline;
            word-wrap: break-word;
        }

        .message-time-inline {
            position: absolute;
            bottom: 3px;
            right: 8px;
            font-size: 9px; /* √áok k√º√ß√ºk WhatsApp gibi */
            color: rgba(0,0,0,0.45);
            white-space: nowrap;
        }

        .message.sent .message-time-inline {
            color: rgba(0,0,0,0.45); /* Ye≈üil balonlarda koyu */
        }

        .message-time {
            display: none;
        }

        /* WhatsApp g√∂r√ºld√º tiki */
        .message-checkmark {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            vertical-align: middle;
        }

        .message-checkmark.read {
            color: #34B7F1; /* WhatsApp mavi */
        }

        .message-checkmark.sent {
            color: rgba(0,0,0,0.45);
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            color: #128C7E; /* WhatsApp koyu ye≈üil */
            margin-bottom: 4px;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 14px;
            outline: none;
            transition: border 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #sendButton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s;
        }

        #sendButton:hover {
            transform: scale(1.1);
        }

        #sendButton:active {
            transform: scale(0.95);
        }

        .no-messages {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        /* Mobil Responsive */
        @media (max-width: 480px) {
            #chatBox {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 80px;
                height: 60vh;
            }

            #chatWidget {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <!-- Geri Butonu - Mobil versiyondan d√∂n√º≈ü i√ßin -->
            <button class="btn-back" id="btnBack" onclick="closeMobileVersion()" title="Geri D√∂n">
                ‚óÄ
            </button>
            <div class="patient-info">
                <h2 id="headerPatientName">Y√ºkleniyor...</h2>
                <p id="patientStats">Beslenme Programƒ±</p>
            </div>
        </div>
        <div class="header-right">
            <!-- Mobil Versiyon Butonu (Alternatif Arama) -->
            <button class="btn-header" onclick="openMobileVersion()" title="Alternatif Yemek Arama">
                ÔøΩ
            </button>
            <!-- Ayarlar Butonu - Sadece ƒ∞kon -->
            <button class="btn-header" onclick="openSettings()" title="Ayarlar">
                ‚öôÔ∏è
            </button>
            <!-- √áƒ±kƒ±≈ü Butonu - Net G√∂r√ºn√ºm -->
            <button class="btn-header" onclick="logout()" title="√áƒ±kƒ±≈ü" style="background: rgba(255,0,0,0.2); border-color: rgba(255,0,0,0.5);">
                ‚ùå
            </button>
        </div>
    </div>

    <!-- Mobil Versiyon iFrame Container -->
    <div class="mobile-iframe-container" id="mobileIframeContainer">
        <iframe id="mobileIframe" src=""></iframe>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Tabs - TEK SATIR -->
        <div class="tabs-wrapper">
            <!-- Hafta Se√ßici Dropdown -->
            <div class="week-selector">
                <button class="week-selector-button" onclick="toggleWeekDropdown()">
                    <span id="currentWeekDisplay">Hafta 1</span>
                    <span>‚ñº</span>
                </button>
                <div class="week-selector-dropdown" id="weekDropdown">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
            
            <!-- Hafta ƒ∞≈ülem Butonlarƒ± - Minimal ƒ∞konlar -->
            <div class="week-actions">
                <button class="week-action-btn" onclick="addNewWeek()" title="Yeni Hafta Ekle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="week-action-btn week-delete-btn" onclick="deleteCurrentWeek()" title="Mevcut Haftayƒ± Sil">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <button class="week-action-btn week-day-btn" onclick="openAddDayModal()" title="G√ºn ≈ûablonu Ekle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                        <line x1="12" y1="14" x2="12" y2="18"></line>
                        <line x1="10" y1="16" x2="14" y2="16"></line>
                    </svg>
                </button>
                <button class="week-action-btn week-measurement-btn" onclick="openMeasurementsModal()" title="V√ºcut √ñl√ß√ºmleri" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                        <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                        <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </button>
                <button class="week-action-btn week-pdf-btn" id="pdfExportBtn" onclick="exportWeekToPDF()" title="Haftalƒ±k PDF ƒ∞ndir" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </button>
            </div>
            
            <!-- Eski tab container (gizli) -->
            <div class="tabs-container" id="tabsContainer" style="display: none;">
                <!-- Tabs will be generated here -->
                <!-- Yeni Hafta Ekle butonu renderTabs() i√ßinde dinamik olu≈üturulacak -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <div class="loading">
                <div class="spinner"></div>
                <p>Y√ºkleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Add Day Modal -->
    <div class="modal" id="addDayModal">
        <div class="modal-content" style="max-width: 1400px; width: 95%; height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h3>üçΩÔ∏è G√ºn Ekle</h3>
                <button class="modal-close" onclick="closeModal('addDayModal')">&times;</button>
            </div>
            
            <!-- Kompakt Filtreleme: 2 Satƒ±r -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; flex-shrink: 0;">
                <!-- Satƒ±r 1: ƒ∞stenen/ƒ∞stenmeyen Yemekler -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <input 
                        type="text" 
                        id="wantedFoodsFilter" 
                        placeholder="‚úÖ ƒ∞stenen yemekler (virg√ºlle ayƒ±rƒ±n)" 
                        style="width: 100%; padding: 6px 10px; border: 2px solid #28a745; border-radius: 6px; font-size: 12px; color: #28a745; font-weight: 500;"
                        oninput="applySmartFilter()"
                    >
                    <input 
                        type="text" 
                        id="unwantedFoodsFilter" 
                        placeholder="‚ùå ƒ∞stenmeyen yemekler (virg√ºlle ayƒ±rƒ±n)" 
                        style="width: 100%; padding: 6px 10px; border: 2px solid #dc3545; border-radius: 6px; font-size: 12px; color: #dc3545; font-weight: 500;"
                        oninput="applySmartFilter()"
                    >
                </div>
                
                <!-- Satƒ±r 2: Filtreler + ƒ∞statistik + Otomatik Plan Butonu -->
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #667eea15, #764ba215); border: 2px solid #667eea; border-radius: 8px;">
                    <!-- ƒ∞statistik (Sol) -->
                    <div style="font-size: 11px; color: #666; font-weight: 600; white-space: nowrap; margin-right: auto;">
                        <span id="filteredTemplateCount" style="color: #667eea; font-weight: 700;">0</span>/<span id="totalTemplateCount">0</span>
                    </div>
                    
                    <!-- Hedef Kalori -->
                    <div style="display: flex; align-items: center; gap: 3px;">
                        <label style="font-size: 10px; font-weight: 600; color: #667eea;">üéØ</label>
                        <input 
                            type="number" 
                            id="templateTargetCalories"
                            placeholder="1500"
                            style="width: 70px; padding: 4px 6px; border: 2px solid #667eea; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"
                            oninput="updateCalorieRangeFromTarget()"
                        >
                    </div>
                    
                    <!-- Min-Max -->
                    <div style="display: flex; align-items: center; gap: 3px;">
                        <input 
                            type="number" 
                            id="minCalorieInput" 
                            placeholder="Min"
                            style="width: 70px; padding: 4px 6px; border: 2px solid #667eea; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"
                            oninput="applyDietAndCalorieFilter()"
                        >
                        <span style="color: #667eea; font-weight: bold; font-size: 10px;">‚Äî</span>
                        <input 
                            type="number" 
                            id="maxCalorieInput" 
                            placeholder="Max"
                            style="width: 70px; padding: 4px 6px; border: 2px solid #667eea; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"
                            oninput="applyDietAndCalorieFilter()"
                        >
                    </div>
                    
                    <!-- Tolerans -->
                    <div style="display: flex; align-items: center; gap: 3px;">
                        <span style="color: #ddd;">‚îÇ</span>
                        <input 
                            type="number" 
                            id="calorieToleranceInput" 
                            min="0" 
                            max="50" 
                            step="5"
                            style="width: 50px; padding: 4px 6px; border: 2px solid #667eea; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"
                            oninput="updateCalorieRangeFromTarget()"
                        >
                        <span style="font-size: 10px; color: #667eea; font-weight: 600;">%</span>
                        <button 
                            onclick="saveCalorieToleranceToPatient()" 
                            style="padding: 4px 7px; background: #28a745; color: white; border: none; border-radius: 3px; font-size: 10px; cursor: pointer;"
                            title="Toleransƒ± Kaydet"
                        >üíæ</button>
                    </div>
                    
                    <!-- Diyet T√ºr√º -->
                    <select 
                        id="templateDietTypeFilter" 
                        style="padding: 4px 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; min-width: 140px;"
                        onchange="applyDietAndCalorieFilter()"
                    ></select>
                    
                    <!-- Butonlar Aynƒ± Satƒ±rda -->
                    <div style="display: flex; gap: 8px; margin-left: auto; align-items: center;">
                        <!-- G√ºn√º Kaydet Butonu (ye≈üil) -->
                        <button 
                            class="btn-primary" 
                            onclick="saveMultipleDaysToWeek()" 
                            id="saveMultipleDaysBtn" 
                            style="display: none; padding: 5px 10px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 5px; font-size: 10px; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 6px rgba(40,167,69,0.3);"
                            title="Se√ßilen G√ºnleri Kaydet"
                        >‚úÖ Kaydet</button>
                        
                        <!-- Otomatik Plan Butonu (mor) -->
                        <button 
                            onclick="openAutoWeekPlanModal()" 
                            style="padding: 5px 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 5px; font-size: 10px; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 6px rgba(102,126,234,0.3);"
                            title="Otomatik Haftalƒ±k Plan Olu≈ütur"
                        >ü§ñ Otomatik Plan</button>
                    </div>
                </div>
            </div>
            
            <!-- Men√º Tablosu (Scrollable) -->
            <div class="form-group" style="flex: 1; overflow-y: auto; margin: 0;">
                <div id="dayTemplateTable" style="overflow-x: auto;">
                    <!-- Table will be loaded here -->
                </div>
            </div>
            
            <div style="flex-shrink: 0; padding-top: 10px; border-top: 1px solid #e0e0e0; display: none;">
                <!-- Buton √ºste ta≈üƒ±ndƒ± -->
            </div>
        </div>
```
    </div>

    <!-- Auto Week Plan Modal -->
    <div class="modal" id="autoWeekPlanModal">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 style="font-size: 18px;">ü§ñ Otomatik Haftalƒ±k Plan</h3>
                <button class="modal-close" onclick="closeModal('autoWeekPlanModal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 12px; padding: 10px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 4px;">
                <p style="margin: 0; color: #1976d2; font-size: 12px;">
                    ‚ÑπÔ∏è Hedef kaloriye en uygun men√ºleri se√ßerek otomatik plan olu≈üturur.
                </p>
            </div>
            
            <!-- Kompakt Hasta Bilgileri -->
            <div style="margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 14px;">üë§ Hasta Bilgileri</h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 3px;">Mevcut Kilo (kg)</label>
                        <input type="number" id="autoPlanWeight" placeholder="70" step="0.1" style="padding: 7px; font-size: 13px;" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 3px;">Hedef Kilo (kg)</label>
                        <input type="number" id="autoPlanTargetWeight" placeholder="65" step="0.1" style="padding: 7px; font-size: 13px;" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 3px;">Boy (cm)</label>
                        <input type="number" id="autoPlanHeight" placeholder="170" step="1" style="padding: 7px; font-size: 13px;" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 3px;">Hedef Ayarƒ±</label>
                        <select id="autoPlanGoalPct" style="padding: 7px; font-size: 12px;" onchange="updateAutoPlanCalories()">
                            <option value="-30">-30% (Sƒ±kƒ± A√ßƒ±k)</option>
                            <option value="-20">-20% (A√ßƒ±k)</option>
                            <option value="-10">-10% (Hafif A√ßƒ±k)</option>
                            <option value="0" selected>0% (S√ºrd√ºrme)</option>
                            <option value="10">+10% (Hafif Fazla)</option>
                            <option value="20">+20% (Kas Kazanƒ±mƒ±)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 3px;">Aktivite</label>
                        <select id="autoPlanActivity" style="padding: 7px; font-size: 12px;" onchange="updateAutoPlanCalories()">
                            <option value="1">Hareketsiz</option>
                            <option value="2">Az Hareketli</option>
                            <option value="3" selected>Orta</option>
                            <option value="4">Hareketli</option>
                            <option value="5">Pro Sporcu</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label id="autoPlanDietTypeLabel" style="font-size: 12px; margin-bottom: 3px;">Diyet Tipi</label>
                        <select id="autoPlanDietType" style="padding: 7px; font-size: 12px;" onchange="updateAutoPlanCalories()">
                            <option value="eliminasyonlu_ketojenik">Elim. Keto</option>
                            <option value="ketojenik">Ketojenik</option>
                            <option value="dusuk_karb">D√º≈ü√ºk Karb</option>
                            <option value="akdeniz">Akdeniz</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin: 10px 0 0 0;">
                    <label style="font-size: 12px; margin-bottom: 3px;">ƒ∞stenmeyen Yemekler</label>
                    <input type="text" id="autoPlanDislikedFoods" placeholder="√∂rn: zeytin, peynir" style="padding: 7px; font-size: 13px;">
                </div>
                
                <div style="margin-top: 10px; padding: 12px; background: white; border-radius: 6px; border: 2px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #667eea; font-size: 13px;">üéØ Hedef Kalori:</span>
                        <span id="autoPlanTargetCalories" style="font-size: 20px; font-weight: 700; color: #667eea;">0</span>
                    </div>
                    <div id="autoPlanMacrosDisplay" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: space-between;">
                        <div style="flex: 1; min-width: 80px; padding: 6px; background: #fff3e0; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #e65100; font-weight: 600; text-transform: uppercase;">Protein</div>
                            <div id="autoPlanProtein" style="font-size: 14px; font-weight: 700; color: #e65100;">0g</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; padding: 6px; background: #e3f2fd; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #1976d2; font-weight: 600; text-transform: uppercase;">Karb</div>
                            <div id="autoPlanCarb" style="font-size: 14px; font-weight: 700; color: #1976d2;">0g</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; padding: 6px; background: #fff9c4; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #f57f17; font-weight: 600; text-transform: uppercase;">Yaƒü</div>
                            <div id="autoPlanFat" style="font-size: 14px; font-weight: 700; color: #f57f17;">0g</div>
                        </div>
                    </div>
                </div>
                
                <!-- Kilo Projeksiyonu -->
                <div id="weightProjectionContainer" style="margin-top: 12px; padding: 12px; background: #f0f4ff; border-radius: 6px; display: none;">
                    <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #667eea;">üìâ Kilo Projeksiyonu</h5>
                    <div id="weightProjectionSummary" style="font-size: 12px; color: #555; margin-bottom: 8px; line-height: 1.5;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    <div id="weightProjectionList" style="font-size: 11px; color: #666; max-height: 150px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px;">
                        <!-- Haftalƒ±k detaylar -->
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button class="btn-secondary" onclick="closeModal('autoWeekPlanModal')" style="flex: 1; padding: 10px; font-size: 14px;">ƒ∞ptal</button>
                <button class="btn-primary" onclick="generateAutoWeekPlan()" style="flex: 2; padding: 10px; font-size: 14px;">
                    ‚ú® Olu≈ütur
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Hasta Ayarlarƒ±</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <!-- Ki≈üisel Bilgiler -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">üë§ Ki≈üisel Bilgiler</h4>
                
                <!-- Ad, Soyad -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Ad *</label>
                        <input type="text" id="patientName" placeholder="√∂rn: Ay≈üe" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Soyad *</label>
                        <input type="text" id="patientSurname" placeholder="√∂rn: Yƒ±lmaz" required>
                    </div>
                </div>
                
                <!-- Ya≈ü, Cinsiyet -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Ya≈ü *</label>
                        <input type="number" id="patientAge" placeholder="√∂rn: 35" min="1" max="150" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Cinsiyet *</label>
                        <select id="patientGender" required>
                            <option value="">Se√ßiniz</option>
                            <option value="Kadƒ±n">Kadƒ±n</option>
                            <option value="Erkek">Erkek</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Kilo, Boy -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Kilo (kg) *</label>
                        <input type="number" id="patientWeight" placeholder="√∂rn: 70" step="0.1" min="20" max="300" required oninput="calculateBMI(); updateMacroDisplay();">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Boy (cm) *</label>
                        <input type="number" id="patientHeight" placeholder="√∂rn: 170" min="50" max="250" required oninput="calculateBMI()">
                    </div>
                </div>
                
                <!-- BMI, Aktivite -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>BMI (otomatik hesaplanƒ±r)</label>
                        <input type="text" id="patientBMI" readonly style="background: #f5f5f5; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Aktivite Seviyesi *</label>
                        <select id="patientActivity" onchange="updateMacroDisplay()" required>
                            <option value="1">1 - Hareketsiz</option>
                            <option value="2">2 - Az Hareketli</option>
                            <option value="3" selected>3 - Orta Hareketli</option>
                            <option value="4">4 - √áok Hareketli</option>
                            <option value="5">5 - Son Derece Aktif</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Kullanƒ±cƒ± Adƒ± ve ≈ûifre -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 16px;">üîê Giri≈ü Bilgileri</h4>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Kullanƒ±cƒ± Adƒ± (deƒüi≈ütirilemez)</label>
                    <input type="text" id="patientUsername" readonly style="background: #f5f5f5; cursor: not-allowed;">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label>Yeni ≈ûifre (opsiyonel)</label>
                    <input type="password" id="patientPassword" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa deƒüi≈ümez" minlength="4">
                    <small style="color: #6c757d; font-size: 12px;">En az 4 karakter. Bo≈ü bƒ±rakƒ±lƒ±rsa mevcut ≈üifreniz korunur.</small>
                </div>
            </div>

            <!-- Beslenme Ayarlarƒ± -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">üçΩÔ∏è Beslenme Ayarlarƒ±</h4>
                
                <div class="form-group">
                    <label id="dietTypeLabel">Diyet T√ºr√º</label>
                    <select id="dietType" onchange="updateMacroDisplay()">
                        <option value="">T√ºm√º</option>
                        <option value="eliminasyonlu-ketojenik">Eliminasyonlu Ketojenik</option>
                        <option value="ketojenik">Ketojenik</option>
                        <option value="lowcarb">D√º≈ü√ºk Karbonhidrat</option>
                        <option value="mediterranean">Akdeniz Diyeti</option>
                        <option value="vegan">Vegan</option>
                    </select>
                </div>

                <!-- √ñnerilen Makro Hesaplamasƒ± -->
                <div id="macroDisplay" style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 14px;">üìä √ñnerilen Makrolar</h4>
                    <div id="macroDetails" style="font-size: 13px; color: #333;"></div>
                </div>

                <div class="form-group">
                    <label>
                        Kalori Toleransƒ± (%)
                        <span style="color: #666; font-size: 12px; display: block;">≈ûablon filtrelemede ¬±% sapma oranƒ± (admin varsayƒ±lanƒ±: <span id="adminDefaultTolerance">5</span>%)</span>
                    </label>
                    <input type="number" id="calorieTolerance" placeholder="√∂rn: 10" min="0" max="50" step="1" oninput="updateToleranceInfo()">
                </div>

                <div class="form-group">
                    <label>
                        Hedef Kalori (g√ºnl√ºk)
                        <span id="toleranceInfo" style="color: #666; font-size: 12px; display: block;">Min ve Max otomatik ¬±%5 tolerans ile ayarlanƒ±r</span>
                    </label>
                    <input type="number" id="targetCalories" placeholder="√∂rn: 1000" oninput="updateCalorieRange()">
                </div>

                <div class="form-group">
                    <label>G√ºnl√ºk Kalori Hedefi (Min)</label>
                    <input type="number" id="minCalories" placeholder="Otomatik hesaplanƒ±r" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>G√ºnl√ºk Kalori Hedefi (Max)</label>
                    <input type="number" id="maxCalories" placeholder="Otomatik hesaplanƒ±r" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Sevmediƒüim Yemekler (virg√ºlle ayƒ±rƒ±n)</label>
                    <textarea id="dislikedFoods" rows="4" placeholder="√∂rn: ƒ±spanak, patlƒ±can, enginar"></textarea>
                </div>
            </div>

            <button class="btn-primary" onclick="saveSettings()">üíæ Kaydet</button>
        </div>
    </div>

    <!-- Toast Message -->
    <div class="toast" id="toast"></div>

    <!-- Admin Matching Modal (4 Tab) -->
    <div class="modal" id="adminMatchingModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>‚öôÔ∏è E≈üle≈ütirme Y√∂netimi</h2>
                <button class="close-btn" onclick="closeAdminMatchingModal()">√ó</button>
            </div>

            <!-- Tab Butonlarƒ± -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="admin-tab-btn active" onclick="switchAdminTab('tarifManuel')" id="tabBtnTarifManuel">
                    üìù Tarif Kartlarƒ± E≈üle≈ütirme
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('tarifYasak')" id="tabBtnTarifYasak">
                    üö´ Tarif Kartlarƒ± Yasaklarƒ±
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('yemekEslestirme')" id="tabBtnYemekEslestirme">
                    ‚úÖ Yemek Veritabanƒ± E≈üle≈ütirme
                </button>
                <button class="admin-tab-btn" onclick="switchAdminTab('yemekYasak')" id="tabBtnYemekYasak">
                    üö´ Yemek Veritabanƒ± Yasaklarƒ±
                </button>
            </div>

            <!-- Tab ƒ∞√ßerikleri -->
            <div id="adminTabContent">
                <!-- Y√ºkleniyor... -->
                <div style="text-align: center; padding: 40px; color: #999;">
                    Y√ºkleniyor...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ÔøΩ UTF-8 ENCODING HELPER (T√úRK√áE KARAKTER KORUMA)
        // ========================================
        
        /**
         * UTF-8 string'i Base64'e √ßevir (GitHub API i√ßin)
         * T√úRK√áE KARAKTER KORUMA: Doƒüru encoding y√∂ntemi
         * @param {string} str - Base64'e √ßevrilecek string
         * @returns {string} - Base64 encoded string
         */
        function encodeBase64UTF8(str) {
            // üî• DOƒûRU Y√ñNTEM: UTF-8 ‚Üí percent-encoding ‚Üí binary ‚Üí base64
            // Bu GitHub API'nin de kullandƒ±ƒüƒ± standart y√∂ntemdir
            
            try {
                // 1. UTF-8 stringi percent-encode'la (%C3%BC gibi)
                const percentEncoded = encodeURIComponent(str);
                
                // 2. Percent-encoded stringi binary'ye √ßevir
                // %XX formatƒ±ndaki byte'larƒ± ger√ßek karakterlere √ßevir
                const binaryString = percentEncoded.replace(/%([0-9A-F]{2})/g, (match, hex) => {
                    return String.fromCharCode(parseInt(hex, 16));
                });
                
                // 3. Binary stringi Base64'e √ßevir
                return btoa(binaryString);
                
            } catch (error) {
                console.error('‚ùå Base64 encoding hatasƒ±:', error);
                // Fallback: Direkt btoa (sadece ASCII i√ßin)
                try {
                    return btoa(str);
                } catch (e) {
                    console.error('‚ùå Fallback encoding da ba≈üarƒ±sƒ±z:', e);
                    return '';
                }
            }
        }

        /**
         * Base64'√º UTF-8 string'e √ßevir (GitHub API'den okurken)
         * T√úRK√áE KARAKTER KORUMA: Doƒüru decoding y√∂ntemi
         * @param {string} base64Str - Base64 encoded string
         * @returns {string} - UTF-8 decoded string
         */
        function decodeBase64UTF8(base64Str) {
            // üî• DOƒûRU Y√ñNTEM: base64 ‚Üí binary ‚Üí percent-encoding ‚Üí UTF-8
            // encodeBase64UTF8'in tam tersi i≈ülem
            
            try {
                // 1. Base64'√º binary stringe √ßevir
                const binaryString = atob(base64Str);
                
                // 2. Binary string'deki her byte'ƒ± %XX formatƒ±na √ßevir
                let percentEncoded = '';
                for (let i = 0; i < binaryString.length; i++) {
                    const byte = binaryString.charCodeAt(i);
                    percentEncoded += '%' + ('0' + byte.toString(16).toUpperCase()).slice(-2);
                }
                
                // 3. Percent-encoded stringi UTF-8'e decode et
                return decodeURIComponent(percentEncoded);
                
            } catch (error) {
                console.error('‚ùå Base64 decoding hatasƒ±:', error);
                // Fallback: Direkt atob (sadece ASCII i√ßin)
                try {
                    return atob(base64Str);
                } catch (e) {
                    console.error('‚ùå Fallback decoding da ba≈üarƒ±sƒ±z:', e);
                    return '';
                }
            }
        }
        
        console.log('‚úÖ UTF-8 encoding helper y√ºklendi');
        
        // ========================================
        // ÔøΩüîê GLOBAL ADMIN FONKSƒ∞YONLARI (EN √úST - √ñNCE Y√úKLENSƒ∞N)
        // ========================================
        
        /**
         * üîç DEBUG: Admin yetkilendirme durumunu kontrol et
         * Console'dan √ßaƒüƒ±rƒ±labilir: checkAdminStatus()
         */
        window.checkAdminStatus = function() {
            console.log('=== üîç ADMIN YETKƒ∞LENDƒ∞RME DURUMU ===');
            console.log('1. AdminAuth:', typeof AdminAuth !== 'undefined' && AdminAuth.getSession ? AdminAuth.getSession() : 'undefined');
            console.log('2. GH_ADMINS:', window.GH_ADMINS);
            console.log('3. currentPatient:', window.currentPatient);
            console.log('4. isUserAdmin():', window.isUserAdmin ? window.isUserAdmin() : 'function not found');
            console.log('5. Admin buton sayƒ±sƒ±:', document.querySelectorAll('.btn-admin-edit').length);
            console.log('6. G√∂r√ºn√ºr admin butonlarƒ±:', document.querySelectorAll('.btn-admin-edit:not([style*="display: none"])').length);
            console.log('=====================================');
        };
        
        /**
         * Kullanƒ±cƒ±nƒ±n admin yetkisi var mƒ± kontrol et
         * @returns {boolean} Admin ise true
         */
        window.isUserAdmin = function() {
            // 1. Global admin kontrol√º (AdminAuth - eski sistem)
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession && AdminAuth.getSession()) {
                console.log('üîë Global admin giri≈üi tespit edildi');
                return true;
            }
            
            // 2. patientAdmins listesi (admins.js - merkezi yetkilendirme)
            const patientAdmins = window.GH_ADMINS?.patientAdmins || [];
            if (window.currentPatient && window.currentPatient.username && patientAdmins.includes(window.currentPatient.username)) {
                console.log('üîë Merkezi admin yetkisi tespit edildi:', window.currentPatient.username);
                return true;
            }
            
            // 3. Hasta dosyasƒ±nda isAdmin (ki≈üisel yetki)
            if (window.currentPatient && window.currentPatient.isAdmin === true) {
                console.log('üîë Hasta bazlƒ± admin yetkisi tespit edildi:', window.currentPatient.name);
                return true;
            }
            
            return false;
        };
        
        console.log('‚úÖ Global admin fonksiyonlarƒ± y√ºklendi');
        
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        
        window.currentPatient = null;
        let currentPatient = window.currentPatient; // Local alias
        
        let patientData = null; // Hasta bilgileri (kilo, aktivite vs)
        let weeks = [];
        let currentWeekIndex = 0;
        let activeWeekIndex = 0;
        let dayTemplates = [];
        let mealTemplates = [];
        let settings = {
            dietType: 'ketojenik', // Varsayƒ±lan ketojenik
            targetCalories: 1000,
            minCalories: 950,
            maxCalories: 1050,
            dislikedFoods: [],
            personalInfo: {
                weight: 70,
                height: 170,
                age: 35,
                activity: 3
            }
        };
        let appSettings = null; // Admin ayarlarƒ±ndan gelecek diyet form√ºlleri
        
        /**
         * Hasta bilgilerine g√∂re hedef kalori ve makrolarƒ± hesapla
         * @param {object} personalInfo - Hasta ki≈üisel bilgileri (weight, height, age, gender, activity)
         * @param {string} dietType - Diyet tipi (ketojenik, lowcarb, d√º≈ü√ºkkalorili)
         * @returns {object} - {calories, protein, carbs, fat}
         */
        function calculateTargetMacros(personalInfo, dietType = 'ketojenik') {
            if (!personalInfo || !personalInfo.weight) {
                // Varsayƒ±lan deƒüerler
                return {
                    calories: 1000,
                    protein: 80,
                    carbs: 20,
                    fat: 70
                };
            }
            
            const { weight, height, age, gender, activity } = personalInfo;
            
            // BMR (Basal Metabolic Rate) - Harris-Benedict form√ºl√º
            let bmr;
            if (gender === 'Kadƒ±n' || gender === 'kadƒ±n' || gender === 'female') {
                bmr = 655 + (9.6 * weight) + (1.8 * (height || 165)) - (4.7 * (age || 35));
            } else {
                bmr = 66 + (13.7 * weight) + (5 * (height || 175)) - (6.8 * (age || 35));
            }
            
            // Aktivite fakt√∂r√º (1: sedanter, 2: hafif, 3: orta, 4: yoƒüun, 5: √ßok yoƒüun)
            const activityFactors = {
                1: 1.2,   // Hareketsiz
                2: 1.375, // Hafif egzersiz (1-3 g√ºn/hafta)
                3: 1.55,  // Orta egzersiz (3-5 g√ºn/hafta)
                4: 1.725, // Yoƒüun egzersiz (6-7 g√ºn/hafta)
                5: 1.9    // √áok yoƒüun (g√ºnde 2 kez, fiziksel i≈ü)
            };
            
            const activityLevel = activity || 3; // Varsayƒ±lan orta
            const tdee = bmr * (activityFactors[activityLevel] || 1.55);
            
            // Kilo kaybƒ± i√ßin %20-25 kalori a√ßƒ±ƒüƒ±
            let targetCalories = Math.round(tdee * 0.75); // %25 a√ßƒ±k
            
            // Minimum kalori kontrol√º (kadƒ±nlar i√ßin 1200, erkekler i√ßin 1500)
            const minCalories = (gender === 'Kadƒ±n' || gender === 'kadƒ±n') ? 1200 : 1500;
            if (targetCalories < minCalories) {
                targetCalories = minCalories;
            }
            
            // Diyet tipine g√∂re makro daƒüƒ±lƒ±mƒ±
            let protein, carbs, fat;
            
            if (dietType === 'ketojenik' || dietType === 'keto') {
                // Ketojenik: %75 yaƒü, %20 protein, %5 karbonhidrat
                protein = Math.round((targetCalories * 0.20) / 4);  // 1g protein = 4 kalori
                carbs = Math.round((targetCalories * 0.05) / 4);    // 1g karb = 4 kalori
                fat = Math.round((targetCalories * 0.75) / 9);      // 1g yaƒü = 9 kalori
            } else if (dietType === 'lowcarb' || dietType === 'd√º≈ü√ºk karbonhidrat') {
                // Low Carb: %40 yaƒü, %30 protein, %30 karbonhidrat
                protein = Math.round((targetCalories * 0.30) / 4);
                carbs = Math.round((targetCalories * 0.30) / 4);
                fat = Math.round((targetCalories * 0.40) / 9);
            } else {
                // Dengeli d√º≈ü√ºk kalorili: %30 yaƒü, %30 protein, %40 karbonhidrat
                protein = Math.round((targetCalories * 0.30) / 4);
                carbs = Math.round((targetCalories * 0.40) / 4);
                fat = Math.round((targetCalories * 0.30) / 9);
            }
            
            console.log('üßÆ Hedef makrolar hesaplandƒ±:', {
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                targetCalories,
                protein,
                carbs,
                fat,
                dietType
            });
            
            return {
                calories: targetCalories,
                protein,
                carbs,
                fat
            };
        }
        
        /**
         * Settings'i hasta verilerinden g√ºncelle
         */
        function updateSettingsFromPatient(patientData) {
            if (!patientData) return;
            
            const personalInfo = patientData.personalInfo || {};
            const dietType = patientData.settings?.dietType || patientData.dietType || 'ketojenik';
            
            // Hedef makrolarƒ± hesapla
            const targetMacros = calculateTargetMacros(personalInfo, dietType);
            
            // Settings'i g√ºncelle
            settings.targetCalories = targetMacros.calories;
            settings.targetProtein = targetMacros.protein;
            settings.targetCarbs = targetMacros.carbs;
            settings.targetFat = targetMacros.fat;
            settings.dietType = dietType;
            settings.personalInfo = personalInfo;
            
            // Tolerans aralƒ±klarƒ± (¬±5%)
            settings.minCalories = Math.round(targetMacros.calories * 0.95);
            settings.maxCalories = Math.round(targetMacros.calories * 1.05);
            
            console.log('‚úÖ Settings hasta verilerinden g√ºncellendi:', settings);
        }
        
        // Food Alternative System Variables
        let manuelEslestirmeler = {}; // Manuel e≈üle≈ütirmeler - tarif kartlarƒ± i√ßin (data/manuel_eslestirmeler.json)
        let eslesmemeKurallari = {}; // Yasak e≈üle≈ütirme kurallarƒ± - tarif kartlarƒ± i√ßin (data/eslesmeme_kurallari.json)
        let yemekVeritabaniEslestirme = {}; // Yemek veritabanƒ± manuel e≈üle≈ütirme (data/yemek_veritabani_eslestirme.json)
        let yemekVeritabaniYasaklar = {}; // Yemek veritabanƒ± yasak e≈üle≈ütirme (data/yemek_veritabani_yasaklar.json)
        
        // Tab 3 & Tab 4: Se√ßili yemekler (ARRAY formatƒ± - √ßoklu se√ßim i√ßin)
        let selectedFoodMatches = []; // Tab 3: Yemek veritabanƒ± e≈üle≈ütirme (√áOK SE√áƒ∞MLƒ∞ - checkbox)
        let selectedBannedFoods = []; // Tab 4: Yemek veritabanƒ± yasaklarƒ± (√áOK SE√áƒ∞MLƒ∞ - checkbox)

        // ========================================
        // üîê YETKƒ∞LENDƒ∞RME Sƒ∞STEMƒ∞
        // ========================================
        
        /**
         * Admin config dosyasƒ±nƒ± y√ºkle (admins.js)
         */
        async function loadAdminsConfig() {
            try {
                console.log('üì• Admin config y√ºkleniyor...');
                
                // Method 1: Script tag ile direkt y√ºkle (en g√ºvenilir)
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'settings/admins.js?t=' + Date.now();
                    script.onload = () => {
                        if (window.GH_ADMINS) {
                            console.log('‚úÖ Admin config y√ºklendi:', {
                                adminCount: window.GH_ADMINS.admins?.length || 0,
                                patientAdminCount: window.GH_ADMINS.patientAdmins?.length || 0
                            });
                            resolve();
                        } else {
                            console.warn('‚ö†Ô∏è GH_ADMINS tanƒ±mlƒ± deƒüil - fallback kullanƒ±lƒ±yor');
                            window.GH_ADMINS = { admins: [], patientAdmins: [] };
                            resolve(); // Reject yerine resolve
                        }
                    };
                    script.onerror = (error) => {
                        console.warn('‚ö†Ô∏è admins.js y√ºklenemedi:', error);
                        // Hata durumunda varsayƒ±lan deƒüer
                        window.GH_ADMINS = { admins: [], patientAdmins: [] };
                        resolve(); // Reject yerine resolve - uygulama a√ßƒ±lsƒ±n
                    };
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è admins.js y√ºkleme hatasƒ±:', error);
                // Varsayƒ±lan deƒüer
                window.GH_ADMINS = { admins: [], patientAdmins: [] };
                return Promise.resolve(); // Hata durumunda bile devam et
            }
        }
        
        /**
         * Admin √∂zelliklerini g√∂ster/gizle
         */
        function toggleAdminFeatures() {
            const isAdmin = window.isUserAdmin();
            
            // Admin butonlarƒ±nƒ± g√∂ster/gizle
            const adminButtons = document.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = isAdmin ? 'inline-block' : 'none';
            });
            
            // üìä Veritabanƒ± kontrol butonu y√∂netimi
            const existingDbCheckBtn = document.getElementById('btnDatabaseCheck');
            
            if (isAdmin) {
                // Admin ise: Buton yoksa olu≈ütur
                if (!existingDbCheckBtn) {
                    const headerRight = document.querySelector('.header-right');
                    if (headerRight) {
                        const dbCheckBtn = document.createElement('button');
                        dbCheckBtn.id = 'btnDatabaseCheck';
                        dbCheckBtn.className = 'btn-header admin-only';
                        dbCheckBtn.onclick = openDatabaseCheckModal;
                        dbCheckBtn.title = 'Veritabanƒ± Kontrol√º - T√ºm yemekleri kontrol et';
                        dbCheckBtn.innerHTML = 'üìä';
                        dbCheckBtn.style.background = 'rgba(255, 193, 7, 0.2)';
                        dbCheckBtn.style.borderColor = 'rgba(255, 193, 7, 0.5)';
                        
                        // Ayarlar butonundan √∂nce ekle
                        const settingsBtn = Array.from(headerRight.children).find(btn => 
                            btn.getAttribute('onclick')?.includes('openSettings')
                        );
                        if (settingsBtn) {
                            headerRight.insertBefore(dbCheckBtn, settingsBtn);
                        } else {
                            headerRight.appendChild(dbCheckBtn);
                        }
                        
                        console.log('üìä Veritabanƒ± kontrol butonu eklendi');
                    }
                }
            } else {
                // Admin deƒüilse: Buton varsa Sƒ∞L (gizleme deƒüil, tamamen kaldƒ±r)
                if (existingDbCheckBtn) {
                    existingDbCheckBtn.remove();
                    console.log('üîí Veritabanƒ± kontrol butonu kaldƒ±rƒ±ldƒ± (admin yetkisi yok)');
                }
            }
            
            console.log(isAdmin ? '‚úÖ Admin √∂zellikleri aktif' : 'üîí Admin √∂zellikleri gizli');
        }
        
        /**
         * Yemek adƒ±nƒ± temizle (miktar, parantez, √∂zel karakterleri kaldƒ±r)
         * @param {string} name - Temizlenecek yemek adƒ±
         * @returns {string} - Temizlenmi≈ü yemek adƒ±
         */
        function cleanFoodName(name) {
            if (!name) return '';
            
            let cleaned = name;
            
            // 1. Miktarlarƒ± temizle (100 gr, 1 porsiyon, vb.)
            cleaned = cleaned.replace(/\d+\s*(gr|gram|porsiyon|adet|su bardaƒüƒ±|√ßorba ka≈üƒ±ƒüƒ±|tatlƒ± ka≈üƒ±ƒüƒ±|ml)/gi, '');
            
            // 2. Parantez i√ßindeki a√ßƒ±klamalarƒ± kaldƒ±r
            cleaned = cleaned.replace(/\([^)]*\)/g, '');
            
            // 3. √ñzel karakterleri temizle
            cleaned = cleaned.replace(/[^\w√ßƒüƒ±√∂≈ü√º√áƒûƒ∞√ñ≈û√ú\s]/gi, '');
            
            // 4. Fazla bo≈üluklarƒ± temizle
            cleaned = cleaned.trim().replace(/\s+/g, ' ');
            
            return cleaned;
        }
        
        
        /**
         * Admin yemek d√ºzenleme modalƒ±nƒ± a√ß
         * @param {number} weekIndex - Hafta indexi
         * @param {number} dayIndex - G√ºn indexi
         * @param {number} mealIndex - √ñƒü√ºn indexi
         * @param {number} foodIndex - Yemek indexi
         */
        window.openAdminFoodEditModal = function(weekIndex, dayIndex, mealIndex, foodIndex) {
            const week = weeks[weekIndex];
            if (!week) return;
            
            const day = week.days[dayIndex];
            if (!day) return;
            
            const meal = (day.meals || day.ogunler || [])[mealIndex];
            if (!meal) return;
            
            const food = (meal.yemekler || [])[foodIndex];
            if (!food) return;
            
            const foodName = food.foodName || food.name || 'ƒ∞simsiz Yemek';
            
            // ‚úÖ Global currentFoodName'i set et (manuel e≈üle≈ütirmeler i√ßin)
            currentFoodName = foodName;
            
            // ‚úÖ MANUEL E≈ûLE≈ûTƒ∞RMELERƒ∞ KORUYALIM (GitHub'dan y√ºklenen verileri silme!)
            // renderTarifManuelTab zaten bo≈üsa otomatik e≈üle≈üenleri y√ºkler
            
            // Admin modalƒ±nƒ± a√ß ve se√ßili yemeƒüi g√∂ster
            const adminModal = document.getElementById('adminFoodModal');
            if (adminModal) {
                // Se√ßili yemek bilgisini modal'a aktar
                window.selectedFoodForAdmin = {
                    weekIndex, dayIndex, mealIndex, foodIndex,
                    foodName, food
                };
                
                // Modal ba≈ülƒ±ƒüƒ±na yemek adƒ±nƒ± yaz
                const modalFoodName = document.getElementById('modal_food_name');
                if (modalFoodName) {
                    modalFoodName.textContent = foodName;
                }
                
                // T√úM TABLARA YEMEK ADINI DOLDUR (g√ºvenli ≈üekilde)
                const manuelYemekAdi = document.getElementById('admin_manuel_yemek_adi');
                const yasakYemekAdi = document.getElementById('admin_yasak_yemek_adi');
                const dbYemekAdi = document.getElementById('admin_db_yemek_adi');
                const dbYasakYemekAdi = document.getElementById('admin_db_yasak_yemek_adi');
                const dbEkleYemekAdi = document.getElementById('admin_db_ekle_yemek_adi');
                
                if (manuelYemekAdi) manuelYemekAdi.value = foodName;
                if (yasakYemekAdi) yasakYemekAdi.value = foodName;
                if (dbYemekAdi) dbYemekAdi.value = foodName;
                if (dbYasakYemekAdi) dbYasakYemekAdi.value = foodName;
                if (dbEkleYemekAdi) dbEkleYemekAdi.value = foodName;
                
                // 5. TAB: food_list.json'da ara ve DOLDUR
                const dbYemek = foodData.find(f => 
                    cleanFoodName(f.name).toLowerCase() === cleanFoodName(foodName).toLowerCase()
                );
                
                // ‚úÖ G√úVENLI ELEMENT DOLDURMA FONKSƒ∞YONU
                const safeSetValue = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value;
                };
                const safeSetChecked = (id, checked) => {
                    const el = document.getElementById(id);
                    if (el) el.checked = checked;
                };
                
                if (dbYemek) {
                    // ‚úÖ VERƒ∞TABANINDA VAR - T√úM PARAMETRELERƒ∞ DOLDUR
                    console.log('‚úÖ Yemek veritabanƒ±nda bulundu, t√ºm parametreler dolduruluyor:', dbYemek.name);
                    
                    // Temel bilgiler
                    safeSetValue('admin_db_ekle_kalori', dbYemek.calories || 0);
                    safeSetValue('admin_db_ekle_protein', dbYemek.protein || 0);
                    safeSetValue('admin_db_ekle_karb', dbYemek.carbs || 0);
                    safeSetValue('admin_db_ekle_yag', dbYemek.fat || 0);
                    safeSetValue('admin_db_ekle_kategori', dbYemek.category || '');
                    safeSetValue('admin_db_ekle_rol', dbYemek.role || '');
                    
                    // √ñƒü√ºn tipleri
                    safeSetChecked('admin_mealType_breakfast', (dbYemek.mealType || dbYemek.mealTypes || []).includes('breakfast'));
                    safeSetChecked('admin_mealType_lunch', (dbYemek.mealType || dbYemek.mealTypes || []).includes('lunch'));
                    safeSetChecked('admin_mealType_dinner', (dbYemek.mealType || dbYemek.mealTypes || []).includes('dinner'));
                    
                    // Porsiyon
                    safeSetValue('admin_db_ekle_portion', dbYemek.portionMultiplier || dbYemek.multiplier || 1);
                    safeSetValue('admin_db_ekle_portion2', dbYemek.portionMultiplier || dbYemek.multiplier || 1);
                    
                    // Diyet tipleri
                    const dietTypes = dbYemek.dietTypes || [];
                    safeSetChecked('admin_dietType_ketojenik', dietTypes.includes('ketojenik'));
                    safeSetChecked('admin_dietType_akdeniz', dietTypes.includes('akdeniz'));
                    safeSetChecked('admin_dietType_vegan', dietTypes.includes('vegan'));
                    safeSetChecked('admin_dietType_glutensiz', dietTypes.includes('glutensiz'));
                    
                    // Min/Max/Step
                    safeSetValue('admin_db_ekle_min', dbYemek.minQuantity || '');
                    safeSetValue('admin_db_ekle_max', dbYemek.maxQuantity || '');
                    safeSetValue('admin_db_ekle_step', dbYemek.step || '');
                    
                    // Sezon
                    if (dbYemek.seasonRange) {
                        try {
                            const season = JSON.parse(dbYemek.seasonRange);
                            safeSetValue('admin_db_ekle_season_min', season[0] || '');
                            safeSetValue('admin_db_ekle_season_max', season[1] || '');
                        } catch (e) {
                            safeSetValue('admin_db_ekle_season_min', '');
                            safeSetValue('admin_db_ekle_season_max', '');
                        }
                    } else {
                        safeSetValue('admin_db_ekle_season_min', '');
                        safeSetValue('admin_db_ekle_season_max', '');
                    }
                    
                    // √ñzel √∂zellikler
                    safeSetChecked('admin_keto', dbYemek.keto || false);
                    safeSetChecked('admin_lowcarb', dbYemek.lowcarb || false);
                    safeSetChecked('admin_portionFixed', dbYemek.portionFixed || false);
                    safeSetChecked('admin_fillerLunch', dbYemek.fillerLunch || false);
                    safeSetChecked('admin_fillerDinner', dbYemek.fillerDinner || false);
                    safeSetChecked('admin_reversedSeason', dbYemek.isReversedSeason || false);
                    
                    // Etiketler
                    safeSetValue('admin_db_ekle_tags', (dbYemek.tags || []).join(', '));
                    safeSetValue('admin_db_ekle_compat', (dbYemek.compatibilityTags || []).join(', '));
                    safeSetValue('admin_db_ekle_incompat', (dbYemek.incompatibilityTags || []).join(', '));
                    
                    // Notlar
                    safeSetValue('admin_db_ekle_notes', dbYemek.notes || '');
                    
                } else {
                    // ‚ö†Ô∏è VERƒ∞TABANINDA YOK - Men√º kartƒ±ndaki makrolarƒ± doldur, DEFAULT DEƒûERLERLE
                    console.log('‚ö†Ô∏è Yemek veritabanƒ±nda bulunamadƒ±, men√º kartƒ± makrolarƒ± kullanƒ±lƒ±yor:', foodName);
                    
                    // Temel makrolar (men√º kartƒ±ndan - sadece varsa)
                    safeSetValue('admin_db_ekle_protein', food.protein || 0);
                    safeSetValue('admin_db_ekle_karb', food.carbs || food.karbonhidrat || 0);
                    safeSetValue('admin_db_ekle_yag', food.fat || food.yag || 0);
                    
                    // Kalori otomatik hesapla
                    if (typeof calculateKaloriForAddFood === 'function') {
                        calculateKaloriForAddFood();
                    }
                    
                    // Kategori ve Rol: Sadece men√º kartƒ±nda VARSA ekle, YOKSA BO≈û BIRAK
                    safeSetValue('admin_db_ekle_kategori', food.category || '');
                    safeSetValue('admin_db_ekle_rol', food.role || '');
                    
                    // DEFAULT DEƒûERLER
                    safeSetChecked('admin_mealType_breakfast', false);
                    safeSetChecked('admin_mealType_lunch', false);
                    safeSetChecked('admin_mealType_dinner', false);
                    safeSetValue('admin_db_ekle_portion', 1);
                    safeSetValue('admin_db_ekle_portion2', 1);
                    safeSetChecked('admin_dietType_ketojenik', false);
                    safeSetChecked('admin_dietType_akdeniz', false);
                    safeSetChecked('admin_dietType_vegan', false);
                    safeSetChecked('admin_dietType_glutensiz', false);
                    safeSetValue('admin_db_ekle_min', 1);
                    safeSetValue('admin_db_ekle_max', 1);
                    safeSetValue('admin_db_ekle_step', 1);
                    safeSetValue('admin_db_ekle_season_min', 1);
                    safeSetValue('admin_db_ekle_season_max', 12);
                    safeSetChecked('admin_keto', false);
                    safeSetChecked('admin_lowcarb', false);
                    safeSetChecked('admin_portionFixed', false);
                    safeSetChecked('admin_fillerLunch', false);
                    safeSetChecked('admin_fillerDinner', false);
                    safeSetChecked('admin_reversedSeason', false);
                    safeSetValue('admin_db_ekle_tags', '');
                    safeSetValue('admin_db_ekle_compat', '');
                    safeSetValue('admin_db_ekle_incompat', '');
                    safeSetValue('admin_db_ekle_notes', '');
                }
                
                // ‚úÖ Yemek veritabanƒ±nda YOKSA "Veritabanƒ±na Ekle" tabƒ±nƒ± a√ß
                if (!dbYemek) {
                    switchAdminTab('db-ekle');
                } else {
                    // Veritabanƒ±nda varsa Manuel tab'ƒ± a√ß
                    switchAdminTab('manuel');
                }
                
                // Modal'ƒ± g√∂ster
                adminModal.style.display = 'block';
                console.log('üìù Admin modal a√ßƒ±ldƒ±:', { weekIndex, dayIndex, mealIndex, foodIndex, foodName, dbYemek: !!dbYemek });
            } else {
                // Modal hen√ºz y√ºklenmemi≈üse ge√ßici alert
                alert(`üîß Admin D√ºzenleme\n\nYemek: ${foodName}\n\n‚ö†Ô∏è Admin modal hen√ºz y√ºklenmedi. Sayfa yenilendiƒüinde kullanƒ±labilir olacak.`);
            }
        };
        
        let tarifKartlari = []; // Tarif kartlarƒ± listesi (tarifler/list.json)
        let foodData = []; // Yemek veritabanƒ± (food_list.json)
        
        /**
         * Yemeƒüin food_list.json'da olup olmadƒ±ƒüƒ±nƒ± kontrol et
         * ƒ∞yile≈ütirilmi≈ü: Parantez i√ßi miktar farklarƒ±nƒ± g√∂z ardƒ± eder
         */
        function isFoodInDatabase(foodName) {
            if (!foodData || foodData.length === 0) {
                console.warn('‚ö†Ô∏è isFoodInDatabase: foodData y√ºklenmemi≈ü');
                return true; // Veritabanƒ± y√ºklenmemi≈üse uyarma
            }
            
            // ‚ö†Ô∏è SADECE GER√áEK VERƒ∞TABANI KONTROL√ú - E≈üle≈ütirme dosyalarƒ±nƒ± KULLANMA!
            // SADECE TAM E≈ûLE≈ûME - Parantez temizleme veya yakla≈üƒ±k e≈üle≈üme yapma!
            // √á√ºnk√º "ketojenik tost (2 ince dilim...)" ile "Ketojenik Tost (Ha≈üha≈ü Ezmesi...)" FARKLI yemeklerdir!
            
            const normalized = normalizeText(foodName);
            
            // SADECE tam e≈üle≈üme kontrol√º
            const found = foodData.some(food => normalizeText(food.name) === normalized);
            
            if (found) {
                console.log(`‚úÖ isFoodInDatabase: "${foodName}" ‚Üí BULUNDU (tam e≈üle≈üme)`);
            } else {
                console.log(`‚ùå isFoodInDatabase: "${foodName}" ‚Üí BULUNAMADI`);
            }
            
            return found;
        }
        
        /**
         * Yemeƒüin veritabanƒ± e≈üle≈ütirmesi var mƒ± kontrol et
         * @param {string} foodName - Yemek adƒ±
         * @returns {boolean|object} - E≈üle≈ütirme varsa e≈üle≈ütirme objesi, yoksa false
         */
        function getFoodDatabaseMapping(foodName) {
            if (!yemekVeritabaniEslestirme || Object.keys(yemekVeritabaniEslestirme).length === 0) {
                return false;
            }
            
            // Yemek adƒ±nƒ± temizle ve normalize et (kaydetme mantƒ±ƒüƒ±yla aynƒ±)
            const cleanedName = foodName
                .replace(/\s*\([^)]*\)/g, '') // Parantez i√ßini temizle
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '') // √ñl√ß√º birimini temizle
                .trim();
            
            const normalized = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G')
                .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                .trim();
            
            console.log(`üîç getFoodDatabaseMapping - Aranan: "${foodName}" ‚Üí Temiz: "${cleanedName}" ‚Üí Normal: "${normalized}"`);
            
            // JSON'daki key'lerle e≈üle≈ütir
            const mapping = Object.keys(yemekVeritabaniEslestirme).find(key => {
                const normalizedKey = key.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G')
                    .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                    .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                    .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                    .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                    .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                    .trim();
                const match = normalizedKey === normalized;
                if (match) {
                    console.log(`‚úÖ E≈ûLE≈ûME BULUNDU! Key: "${key}" ‚Üí Normal: "${normalizedKey}"`);
                }
                return match;
            });
            
            if (!mapping) {
                console.log(`‚ùå E≈üle≈üme bulunamadƒ±. Mevcut key'ler:`, Object.keys(yemekVeritabaniEslestirme));
            }
            
            return mapping ? yemekVeritabaniEslestirme[mapping] : false;
        }
        
        // üîó Admin Modal: Se√ßili Tarif Kartlarƒ± & Manuel E≈üle≈ütirmeler
        let selectedTarifKartlari = []; // Tab 1-2 i√ßin se√ßili kartlar
        let manualMatches = {}; // Manuel e≈üle≈ütirmeler: { "yemekAdƒ±": ["tarif1", "tarif2", ...] }
        let currentFoodName = ''; // Se√ßili yemek adƒ± (modal a√ßƒ±ldƒ±ƒüƒ±nda set edilir)
        
        // E≈üle≈ütirme kriterleri - VARSAYILAN DEƒûERLER (mobil versiyonla aynƒ±)
        let matchCriteria = {
            role: true,          // Role filtresi A√áIK (ana yemek ‚Üí ana yemek)
            dietType: true,      // DietType filtresi A√áIK (keto ‚Üí keto/lowcarb)
            category: false,     // Category filtresi KAPALI
            season: false,       // Season filtresi KAPALI
            mealType: false      // MealType filtresi KAPALI
        };
        
        // Similarity scoring kriterleri - VARSAYILAN (admin ayarlarƒ±ndan y√ºklenir)
        // Admin settings'den appSettings.scoreCriteria.activeByDefault gelecek
        // Mobil versiyondaki gibi butonlarla deƒüi≈ütirilebilir (calories, protein, carbs, fat)
        // Varsayƒ±lan: ['protein', 'fat'] - sadece protein ve yaƒü aktif
        let scoreBy = ['protein', 'fat'];

        // Makro Hesaplama Fonksiyonu
        function calculateMacros(weight, dietType, activityLevel) {
            if (!appSettings || !appSettings.dietFormulas) {
                console.warn('‚ö†Ô∏è Diyet form√ºlleri y√ºklenmedi, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor');
                // Varsayƒ±lan deƒüerler
                const defaultFormulas = {
                    ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                    lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                    activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                };
                return calculateMacrosWithFormula(weight, dietType, activityLevel, defaultFormulas);
            }
            
            return calculateMacrosWithFormula(weight, dietType, activityLevel, appSettings.dietFormulas);
        }

        function calculateMacrosWithFormula(weight, dietType, activityLevel, formulas) {
            // Diyet t√ºr√ºn√º normalize et
            const normalizedDietType = dietType ? dietType.replace(/[-_]/g, '-').toLowerCase() : '';
            
            // Diyet t√ºr√ºne g√∂re form√ºl√º se√ß
            let formula;
            if (normalizedDietType === 'ketojenik' || normalizedDietType === 'eliminasyonlu-ketojenik') {
                formula = formulas.ketojenik || formulas.eliminasyonlu_ketojenik;
            } else if (normalizedDietType === 'lowcarb' || normalizedDietType === 'dusuk-karb') {
                formula = formulas.lowcarb || formulas.dusuk_karb;
            } else if (normalizedDietType === 'akdeniz') {
                formula = formulas.akdeniz;
            } else {
                console.warn('‚ö†Ô∏è Bilinmeyen diyet t√ºr√º:', dietType, '‚Üí', normalizedDietType);
                // Fallback olarak ketojenik kullan
                formula = formulas.ketojenik;
            }
            
            if (!formula) {
                console.error('‚ùå Form√ºl bulunamadƒ±:', normalizedDietType);
                return null;
            }

            // Aktivite √ßarpanƒ±nƒ± al
            const activityMultiplier = formulas.activityMultipliers[activityLevel] || 1.0;

            // Gram hesapla
            const carbGrams = weight * formula.carb;
            const proteinGrams = weight * formula.protein;
            const fatGrams = weight * formula.fat;

            // Kalori hesapla (karbonhidrat: 4 kcal/g, protein: 4 kcal/g, yaƒü: 9 kcal/g)
            const carbCal = carbGrams * 4;
            const proteinCal = proteinGrams * 4;
            const fatCal = fatGrams * 9;
            const totalBaseCal = carbCal + proteinCal + fatCal;

            // Aktivite √ßarpanƒ±nƒ± uygula
            const totalCal = totalBaseCal * activityMultiplier;

            return {
                carb: Math.round(carbGrams),
                protein: Math.round(proteinGrams),
                fat: Math.round(fatGrams),
                calories: Math.round(totalCal),
                activityMultiplier: activityMultiplier
            };
        }

        // Debug fonksiyonlarƒ± - Console'da √ßalƒ±≈ütƒ±rƒ±n
        window.enableBadgeDebug = function() {
            window.debugBadges = true;
            console.log('üîç Rozet debug modu A√áILDI');
        };
        
        window.disableBadgeDebug = function() {
            window.debugBadges = false;
            console.log('üîç Rozet debug modu KAPANDI');
        };

        // Admin ayarlarƒ±nƒ± GitHub'dan y√ºkle (mobil_versiyon_v1.html ile AYNI KAYNAK)
        async function loadAdminSettings() {
            try {
                // GitHub API ile √ßek (mobil versiyon mantƒ±ƒüƒ±)
                const REPO_OWNER = 'mustafasacar35';
                const REPO_NAME = 'lipodem-takip-paneli';
                const SETTINGS_PATH = 'settings/config.json';
                const SETTINGS_BRANCH = 'main';
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${SETTINGS_PATH}?ref=${SETTINGS_BRANCH}`);
                
                if (!response.ok) {
                    throw new Error(`Ayarlar y√ºklenemedi: ${response.status}`);
                }
                
                const data = await response.json();
                const decoded = decodeBase64UTF8((data.content || '').replace(/\n/g, ''));
                const parsed = JSON.parse(decoded);
                appSettings = parsed;
                
                // üîç DEBUG: GitHub'dan y√ºklenen ham veri
                console.log('üì• GitHub config.json RAW:', {
                    scoringMode: parsed.scoringMode,
                    sensitivityDivider: parsed.sensitivityDivider,
                    badgeVisibility: parsed.badgeVisibility,
                    scoreCriteria: parsed.scoreCriteria
                });
                
                // Rozet ayarlarƒ±nƒ± konsola yazdƒ±r
                console.log('üè∑Ô∏è Hasta paneli - Rozet ayarlarƒ± y√ºklendi:', appSettings?.badgeVisibility);
                if (appSettings?.badgeVisibility) {
                    const enabledBadges = Object.entries(appSettings.badgeVisibility)
                        .filter(([key, value]) => value)
                        .map(([key]) => key);
                    const disabledBadges = Object.entries(appSettings.badgeVisibility)
                        .filter(([key, value]) => !value)
                        .map(([key]) => key);
                    console.log('   ‚úÖ Aktif rozetler:', enabledBadges);
                    console.log('   ‚ùå Kapalƒ± rozetler:', disabledBadges);
                } else {
                    console.log('   ‚ö†Ô∏è badgeVisibility ayarlarƒ± bulunamadƒ±, varsayƒ±lan ayarlar kullanƒ±lacak');
                }

                // matchCriteria'yƒ± filterCriteria'dan doldur (mobil versiyon mantƒ±ƒüƒ±)
                if (appSettings.filterCriteria) {
                    const filterCrit = appSettings.filterCriteria;
                        
                        // Role filtresi
                        if (filterCrit.role?.visible) {
                            if (filterCrit.role.mode === 'required') {
                                matchCriteria.role = true; // Zorunlu - her zaman aktif
                            } else {
                                // Opsiyonel - defaultState'den ba≈ülangƒ±√ß deƒüeri
                                matchCriteria.role = filterCrit.role.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.role = false; // Visible deƒüilse pasif
                        }
                        
                        // DietType filtresi
                        if (filterCrit.dietType?.visible) {
                            if (filterCrit.dietType.mode === 'required') {
                                matchCriteria.dietType = true;
                            } else {
                                matchCriteria.dietType = filterCrit.dietType.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.dietType = false;
                        }
                        
                        // Category filtresi
                        if (filterCrit.category?.visible) {
                            if (filterCrit.category.mode === 'required') {
                                matchCriteria.category = true;
                            } else {
                                matchCriteria.category = filterCrit.category.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.category = false;
                        }
                        
                        // Season filtresi
                        if (filterCrit.season?.visible) {
                            if (filterCrit.season.mode === 'required') {
                                matchCriteria.season = true;
                            } else {
                                matchCriteria.season = filterCrit.season.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.season = false;
                        }
                        
                        // MealType filtresi
                        if (filterCrit.mealType?.visible) {
                            if (filterCrit.mealType.mode === 'required') {
                                matchCriteria.mealType = true;
                            } else {
                                matchCriteria.mealType = filterCrit.mealType.defaultState === 'active';
                            }
                        } else {
                            matchCriteria.mealType = false;
                        }
                    }
                    
                    // üî• scoreBy parametresini admin ayarlarƒ±ndan y√ºkle (mobil versiyon mantƒ±ƒüƒ±)
                    if (appSettings.scoreCriteria && Array.isArray(appSettings.scoreCriteria.activeByDefault)) {
                        scoreBy = [...appSettings.scoreCriteria.activeByDefault]; // Kopyala (referans deƒüil)
                        console.log('‚úÖ scoreBy admin ayarlarƒ±ndan y√ºklendi:', scoreBy);
                    } else {
                        console.warn('‚ö†Ô∏è appSettings.scoreCriteria bulunamadƒ±, varsayƒ±lan kullanƒ±lƒ±yor:', scoreBy);
                    }
                    
                    console.log('‚úÖ Admin ayarlarƒ± y√ºklendi:', appSettings);
                    console.log('‚úÖ Match kriterleri:', matchCriteria);
                    console.log('‚úÖ Benzerlik skoru kriterleri (scoreBy):', scoreBy);
            } catch (error) {
                console.warn('‚ö†Ô∏è Admin ayarlarƒ± y√ºklenirken hata:', error);
                appSettings = {
                    calorieTolerancePercent: 5,
                    dietFormulas: {
                        eliminasyonlu_ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 }, // Ketojenik ile aynƒ±
                        ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                        dusuk_karb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                        lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                        akdeniz: { carb: 1.2, protein: 0.7, fat: 0.8 },
                        activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                    }
                };
            }
        }

        // Manuel e≈üle≈ütirmeler ve yasak kurallarƒ±nƒ± GitHub'dan y√ºkle
        async function loadManuelEslestirmeler() {
            try {
                // 1Ô∏è‚É£ Manuel e≈üle≈ütirmeleri y√ºkle (tarif kartlarƒ± i√ßin)
                const manuelResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json?t=' + Date.now());
                if (manuelResp.ok) {
                    const manuelData = await manuelResp.json();
                    manuelEslestirmeler = manuelData.eslestirmeler || manuelData;
                    manualMatches = manuelEslestirmeler; // ‚úÖ Senkronize et
                    console.log('‚úÖ Manuel e≈üle≈ütirmeler y√ºklendi (tarif kartlarƒ±):', Object.keys(manuelEslestirmeler).length);
                } else {
                    console.warn('‚ö†Ô∏è Manuel e≈üle≈ütirmeler y√ºklenemedi');
                }

        // 2Ô∏è‚É£ Yasak kurallarƒ±nƒ± y√ºkle (tarif kartlarƒ± i√ßin)
        const yasakResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json?t=' + Date.now(), {
            cache: 'no-store' // Cache bypass
        });
        if (yasakResp.ok) {
            const data = await yasakResp.json();
            
            // ‚úÖ eslestirme.html ile aynƒ± fallback sistemi (4 kontrol)
            if (data.kurallar && data.kurallar.eslesmemeKurallari) {
                // Format 1: { kurallar: { eslesmemeKurallari: {...} } }
                eslesmemeKurallari = data.kurallar.eslesmemeKurallari;
            } else if (data.kurallar) {
                // Format 2: { kurallar: {...} }
                eslesmemeKurallari = data.kurallar;
            } else if (data.eslesmemeKurallari) {
                // Format 3: { eslesmemeKurallari: {...} }
                eslesmemeKurallari = data.eslesmemeKurallari;
            } else {
                // Format 4: Direkt root object
                eslesmemeKurallari = data;
            }
            
            console.log('‚úÖ Yasak kurallarƒ± y√ºklendi (tarif kartlarƒ±):', Object.keys(eslesmemeKurallari).length);
        } else {
            console.warn('‚ö†Ô∏è Yasak kurallarƒ± y√ºklenemedi');
        }                // 3Ô∏è‚É£ Yemek veritabanƒ± manuel e≈üle≈ütirmeleri y√ºkle
                const yemekEslestirmeResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_eslestirme.json?t=' + Date.now());
                if (yemekEslestirmeResp.ok) {
                    const yemekEslestirmeData = await yemekEslestirmeResp.json();
                    yemekVeritabaniEslestirme = yemekEslestirmeData.eslestirmeler || yemekEslestirmeData;
                    console.log('‚úÖ Yemek veritabanƒ± e≈üle≈ütirmeleri y√ºklendi:', Object.keys(yemekVeritabaniEslestirme).length);
                } else {
                    console.warn('‚ö†Ô∏è Yemek veritabanƒ± e≈üle≈ütirmeleri y√ºklenemedi');
                }

                // 4Ô∏è‚É£ Yemek veritabanƒ± yasaklarƒ±nƒ± y√ºkle
                const yemekYasaklarResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_yasaklar.json?t=' + Date.now());
                if (yemekYasaklarResp.ok) {
                    const yemekYasaklarData = await yemekYasaklarResp.json();
                    yemekVeritabaniYasaklar = yemekYasaklarData.yasaklar || yemekYasaklarData;
                    console.log('‚úÖ Yemek veritabanƒ± yasaklarƒ± y√ºklendi:', Object.keys(yemekVeritabaniYasaklar).length);
                } else {
                    console.warn('‚ö†Ô∏è Yemek veritabanƒ± yasaklarƒ± y√ºklenemedi');
                }
            } catch (error) {
                console.error('‚ùå Manuel e≈üle≈ütirmeler/yasak kurallarƒ± y√ºklenirken hata:', error);
            }
        }

        // Tarif kartlarƒ±nƒ± GitHub'dan y√ºkle
        async function loadTarifKartlari() {
            try {
                // √ñnce list.json'dan y√ºklemeyi dene
                let response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        tarifKartlari = data
                            .map(item => (typeof item === 'string' ? item : item.name || item.filename || item.file || null))
                            .filter(name => name && name.match(/\.(jpg|jpeg|png)$/i))
                            .map(name => ({ 
                                name: name, 
                                type: 'file', 
                                download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` 
                            }));
                        console.log('‚úÖ Tarif kartlarƒ± list.json ile y√ºklendi:', tarifKartlari.length);
                        return;
                    }
                }
                throw new Error('list.json y√ºklenemedi');
            } catch (error) {
                console.error('‚ùå Tarif kartlarƒ± y√ºklenemedi, fallback deneniyor:', error.message);
                
                // Fallback: Manuel e≈üle≈ütirmelerden tarif kartlarƒ±nƒ± √ßƒ±kar
                const uniqueTarifler = new Set();
                Object.values(manuelEslestirmeler).forEach(eslestirme => {
                    const kartlar = (typeof eslestirme === 'object' && eslestirme.kartlar) 
                        ? eslestirme.kartlar 
                        : (typeof eslestirme === 'string' ? [eslestirme] : []);
                    kartlar.forEach(kart => uniqueTarifler.add(kart));
                });
                
                tarifKartlari = [...uniqueTarifler].map(name => ({ 
                    name: name, 
                    type: 'file', 
                    download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` 
                }));
                console.log('‚úÖ Fallback tarif kartlarƒ± y√ºklendi:', tarifKartlari.length);
            }
        }

        // Yemek veritabanƒ±nƒ± y√ºkle (food_list.json)
        async function loadFoodData() {
            // Zaten y√ºklenmi≈üse tekrar y√ºkleme (performance optimization)
            if (foodData.length > 0) {
                console.log('‚ÑπÔ∏è Yemek veritabanƒ± zaten y√ºklenmi≈ü:', foodData.length, 'yemek');
                return true;
            }
            
            try {
                console.log('üì• Yemek veritabanƒ± y√ºkleniyor...');
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                foodData = [];
                
                // food_list.json formatƒ±: { categories: [ { items: [...] } ] }
                if (data.categories && Array.isArray(data.categories)) {
                    data.categories.forEach(category => {
                        if (category.items && Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                // Yemek objesini foodData'ya ekle
                                if (item.name) {
                                    foodData.push(item);
                            }
                            });
                        }
                    });
                }
                
                console.log(`‚úÖ Yemek veritabanƒ± y√ºklendi: ${foodData.length} yemek`);
                
                // DEBUG: ƒ∞lk 3 yemek ve Mercimek kontrol√º
                if (foodData.length > 0) {
                    console.log('üìã ƒ∞lk 3 yemek:', foodData.slice(0, 3).map(f => f.name));
                    const mercimekler = foodData.filter(f => f.name.toLowerCase().includes('mercimek'));
                    console.log(`üîç Mercimek i√ßeren yemekler (${mercimekler.length}):`, mercimekler.map(f => f.name));
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Yemek veritabanƒ± y√ºklenirken hata:', error);
                return false;
            }
        }

        // T√ºrk√ße karakter normalizasyonu (√ß‚Üíc, ƒü‚Üíg, ƒ±‚Üíi, √∂‚Üío, ≈ü‚Üís, √º‚Üíu)
        function normalizeText(str) {
            if (!str) return '';
            
            // Manuel character mapping - her karakteri tek tek kontrol et
            const trMap = {
                '√á': 'c', '√ß': 'c',
                'ƒû': 'g', 'ƒü': 'g',
                'I': 'i', 'ƒ±': 'i',
                'ƒ∞': 'i', 'i': 'i', '√≠': 'i', '√¨': 'i', '√Æ': 'i', '√Ø': 'i',  // T√ºm i varyantlarƒ±
                '√ñ': 'o', '√∂': 'o',
                '≈û': 's', '≈ü': 's',
                '√ú': 'u', '√º': 'u'
            };
            
            let result = '';
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (trMap[char]) {
                    result += trMap[char];
                } else if (/[a-zA-Z0-9]/.test(char)) {
                    result += char.toLowerCase();
                }
                // Diƒüer karakterleri atla (bo≈üluk, noktalama vs.)
            }
            
            return result;
        }

        // Levenshtein Distance (karakter deƒüi≈üim mesafesi)
        function levenshteinDistance(s1, s2) {
            const len1 = s1.length;
            const len2 = s2.length;
            const matrix = [];

            // Bo≈ü string kontrol√º
            if (len1 === 0) return len2;
            if (len2 === 0) return len1;

            // Matris olu≈ütur
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            // Mesafeyi hesapla
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // Silme
                        matrix[i][j - 1] + 1,      // Ekleme
                        matrix[i - 1][j - 1] + cost // Deƒüi≈ütirme
                    );
                }
            }

            return matrix[len1][len2];
        }

        // Benzerlik skoru hesapla (0-100%)
        function similarityScore(s1, s2) {
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 100;
            
            const distance = levenshteinDistance(longer, shorter);
            return ((longer.length - distance) / longer.length) * 100;
        }

        // üîç Akƒ±llƒ± fuzzy matching (eslestirme.html mantƒ±ƒüƒ±)
        function smartFuzzyMatch(searchName, targetName, threshold = 85) {
            const searchNorm = normalizeText(searchName);
            const targetNorm = normalizeText(targetName);

            // 1Ô∏è‚É£ Tam e≈üle≈üme
            if (searchNorm === targetNorm) return 100;

            // 2Ô∏è‚É£ ƒ∞√ßeriyor mu? (substring)
            if (targetNorm.includes(searchNorm)) {
                // Ama √ßok kƒ±sa kelimeler i√ßin dikkatli ol
                // "zeytin" ‚Üí "zeytinlimeze" ‚ùå (3 harf fark varsa ret)
                const lengthDiff = targetNorm.length - searchNorm.length;
                if (lengthDiff > 3) return 0; // √áok farklƒ± uzunluk
                return 95;
            }

            // 3Ô∏è‚É£ Kelime kelime ba≈ülangƒ±√ß e≈üle≈ümesi (eslestirme.html mantƒ±ƒüƒ±)
            const searchWords = searchName.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const targetWords = targetName.split(/[_\s]+/).filter(w => w.length > 0);

            if (searchWords.length > 1) {
                const allWordsFound = searchWords.every(searchWord => {
                    const normalizedSearchWord = normalizeText(searchWord);
                    return targetWords.some(targetWord => 
                        normalizeText(targetWord).startsWith(normalizedSearchWord)
                    );
                });

                if (allWordsFound) {
                    // Kelime sayƒ±sƒ± e≈üitse daha y√ºksek skor
                    if (searchWords.length === targetWords.length) return 95;
                    return 88; // Fazla kelime var ama e≈üle≈üiyor
                }
            }

            // 4Ô∏è‚É£ Levenshtein distance (son √ßare)
            const score = similarityScore(searchNorm, targetNorm);
            
            // Ama √ßok kƒ±sa kelimeler i√ßin katƒ± ol
            if (searchNorm.length < 5 && score < 95) return 0; // "zeytin" gibi
            
            return score;
        }

        // üöÄ ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û E≈ûLE≈ûTƒ∞RME Sƒ∞STEMƒ∞ (√∂rnek_dosya.html mantƒ±ƒüƒ±)
        // T√ºrk√ße karakter normalize (√∂rnek_dosya.html ile aynƒ±)
        function normalizeTr(str) {
            return (str || '')
                .toString()
                .toLowerCase()
                .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
                .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i').replace(/iÃá/g, 'i')
                .replace(/[_*\/()]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/[^a-z0-9\s]/g, '')
                .trim();
        }

        // Token tabanlƒ± fuzzy matching (√∂rnek_dosya.html mantƒ±ƒüƒ±)
        const unitStop = new Set([
            'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
            'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
            'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
            'yarim','ceyrek','lt','ml','cc','mg','mcg','litre'
        ]);
        const stopFillers = new Set(['ve','veya','ile','artƒ±','arti','plus','ya','vs','vb']);
        
        function tokenize(text) {
            return normalizeTr(text)
                .replace(/\d+/g, ' ') // sayƒ±larƒ± kaldƒ±r
                .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
                .split(/\s+/)
                .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));
        }

        function bestFoodFuzzyMatch(rawText, allFoodItems) {
            if (!rawText || !allFoodItems || allFoodItems.length === 0) return null;
            
            // Par√ßalarƒ± √ºret ("+", ",", "/", "(", ")", "-", "ile", "ve", "veya" ile b√∂l)
            const parts = String(rawText)
                .split(/\+|\,|\/|\(|\)|\-|\bile\b|\bve\b|\bveya\b/gi)
                .map(p => p.trim())
                .filter(Boolean);
            
            let best = null;
            let bestScore = 0;
            
            const consider = (segment) => {
                const segTokens = tokenize(segment);
                if (!segTokens.length) return;
                
                for (const f of allFoodItems) {
                    const fTokens = tokenize(f.name);
                    if (!fTokens.length) continue;
                    
                    // Kesi≈üim skoru
                    const setB = new Set(fTokens);
                    let overlap = 0;
                    let longHit = false;
                    
                    for (const t of segTokens) {
                        if (setB.has(t)) {
                            overlap++;
                            if (t.length >= 4) longHit = true;
                        }
                    }
                    
                    // Kabul kriteri: en az 2 kelime e≈üle≈ümesi veya tek ama uzun kelime e≈üle≈ümesi
                    const score = overlap + (longHit ? 0.5 : 0);
                    if (overlap >= 2 || (overlap >= 1 && longHit)) {
                        if (score > bestScore) { 
                            best = f; 
                            bestScore = score; 
                        }
                    }
                }
            };
            
            if (!parts.length) parts.push(rawText);
            parts.forEach(consider);
            
            return best;
        }

        // Yemek adƒ±nƒ± foodData'da bul (ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û: √∂rnek_dosya.html mantƒ±ƒüƒ± + ROTASYON MODU)
        function findFoodInDatabase(searchName, weekIndex = 0) {
            if (!searchName || !foodData || foodData.length === 0) return null;

            const normalized = normalizeText(searchName);
            const normalizedTr = normalizeTr(searchName);
            
            console.log(`üîç findFoodInDatabase: "${searchName}" ‚Üí normalized: "${normalized}", normalizedTr: "${normalizedTr}"`);

            // 1Ô∏è‚É£ MANUEL E≈ûLE≈ûTƒ∞RME (yemek_veritabani_eslestirme.json - √áOK SE√áƒ∞MLƒ∞ + ROTASYON)
            if (yemekVeritabaniEslestirme && Object.keys(yemekVeritabaniEslestirme).length > 0) {
                const eslestirme = yemekVeritabaniEslestirme[normalized] || yemekVeritabaniEslestirme[normalizedTr];
                if (eslestirme) {
                    // YENƒ∞ FORMAT: hedefYemekler (array) + rotasyonModu
                    if (Array.isArray(eslestirme.hedefYemekler) && eslestirme.hedefYemekler.length > 0) {
                        let selectedFood = null;
                        
                        if (eslestirme.hedefYemekler.length === 1) {
                            // Tek yemek ‚Üí direkt d√∂nd√ºr
                            selectedFood = eslestirme.hedefYemekler[0];
                        } else {
                            // √áoklu yemek ‚Üí rotasyon uygula
                            const rotasyonModu = eslestirme.rotasyonModu || 'sirayla'; // Default: sƒ±ralƒ±
                            
                            if (rotasyonModu === 'rastgele') {
                                // Rastgele se√ßim
                                const randomIndex = Math.floor(Math.random() * eslestirme.hedefYemekler.length);
                                selectedFood = eslestirme.hedefYemekler[randomIndex];
                            console.log(`üé≤ Rastgele se√ßim: "${searchName}" ‚Üí "${selectedFood}" (${randomIndex + 1}/${eslestirme.hedefYemekler.length})`);
                            } else {
                                // Sƒ±ralƒ± rotasyon (modulo ile)
                                const rotationIndex = weekIndex % eslestirme.hedefYemekler.length;
                                selectedFood = eslestirme.hedefYemekler[rotationIndex];
                            console.log(`üîÑ Sƒ±ralƒ± rotasyon: "${searchName}" ‚Üí "${selectedFood}" (${rotationIndex + 1}/${eslestirme.hedefYemekler.length}) [Hafta: ${weekIndex + 1}]`);
                            }
                        }
                        
                        // foodData'da e≈üle≈üen yemeƒüi bul
                        const mapped = foodData.find(f => normalizeText(f.name) === normalizeText(selectedFood));
                        if (mapped && !isFoodMatchForbidden(searchName, mapped.name)) {
                            console.log(`‚úÖ Manuel e≈üle≈ütirme (veritabanƒ±): "${searchName}" ‚Üí "${mapped.name}"`);
                            return mapped;
                        }
                    }
                    // ESKƒ∞ FORMAT: hedefYemek (string) - geriye d√∂n√ºk uyumluluk
                    else if (eslestirme.hedefYemek) {
                        const mapped = foodData.find(f => normalizeText(f.name) === normalizeText(eslestirme.hedefYemek));
                        if (mapped && !isFoodMatchForbidden(searchName, mapped.name)) {
                            console.log(`‚úÖ Manuel e≈üle≈ütirme (veritabanƒ± - eski format): "${searchName}" ‚Üí "${mapped.name}"`);
                            return mapped;
                        }
                    }
                }
            }

            // 2Ô∏è‚É£ TAM E≈ûLE≈ûTƒ∞RME (normalizeTr ile)
            let match = foodData.find(f => normalizeTr(f.name) === normalizedTr || normalizeText(f.name) === normalized);
            if (match && !isFoodMatchForbidden(searchName, match.name)) {
                console.log(`‚úÖ Tam e≈üle≈üme: "${searchName}" ‚Üí "${match.name}"`);
                return match;
            }

            // 3Ô∏è‚É£ PARANTEZ TEMƒ∞ZLE
            const cleanName = searchName.replace(/\s*\([^)]*\)/g, '').trim();
            if (cleanName !== searchName) {
                const cleanNormalized = normalizeTr(cleanName);
                match = foodData.find(f => normalizeTr(f.name) === cleanNormalized);
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`‚úÖ Parantez temizleme: "${searchName}" ‚Üí "${match.name}"`);
                    return match;
                }
            }

            // 4Ô∏è‚É£ Mƒ∞KTAR TEMƒ∞ZLE (sayƒ±lar + birimler)
            const quantityCleanName = cleanName
                .replace(/^\d+\s*(gram|g|adet|dilim|ml|lt|porsiyon|su bardaƒüƒ±|kase|√∂l√ßek|cc|mg|litre)\s*/i, '')
                .replace(/^\d+\s*(tatlƒ±|√ßorba|yemek)\s*ka≈üƒ±ƒüƒ±\s*/i, '')
                .replace(/\b\d+\s*(?:gr|g|ml|lt|cc|mg|adet|dilim|porsiyon|kase|√∂l√ßek)\b/gi, '')
                .trim();
            
            if (quantityCleanName && quantityCleanName !== cleanName) {
                const quantityNormalized = normalizeTr(quantityCleanName);
                
                // Tam e≈üle≈üme
                match = foodData.find(f => normalizeTr(f.name) === quantityNormalized);
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`‚úÖ Miktar temizleme: "${searchName}" ‚Üí "${match.name}"`);
                    return match;
                }
                
                // Food_list'teki parantezleri de temizle
                match = foodData.find(f => {
                    const foodClean = f.name.replace(/\s*\([^)]*\)/g, '').trim();
                    const foodQuantityClean = foodClean
                        .replace(/^\d+\s*(gram|g|adet|dilim|ml|lt|porsiyon|su bardaƒüƒ±|kase|√∂l√ßek|cc|mg|litre)\s*/i, '')
                        .replace(/^\d+\s*(tatlƒ±|√ßorba|yemek)\s*ka≈üƒ±ƒüƒ±\s*/i, '')
                        .replace(/\b\d+\s*(?:gr|g|ml|lt|cc|mg|adet|dilim|porsiyon|kase|√∂l√ßek)\b/gi, '')
                        .trim();
                    return normalizeTr(foodQuantityClean) === quantityNormalized;
                });
                if (match && !isFoodMatchForbidden(searchName, match.name)) {
                    console.log(`‚úÖ Miktar + parantez temizleme (√ßift y√∂nl√º): "${searchName}" ‚Üí "${match.name}"`);
                    return match;
                }
            }

            // 5Ô∏è‚É£ ƒ∞√áERƒ∞YOR MU? (substring) - √∂rnek_dosya.html mantƒ±ƒüƒ±
            const searchForInclude = quantityCleanName || cleanName;
            const searchNormInclude = normalizeTr(searchForInclude);
            
            if (searchNormInclude) {
                match = foodData.find(f => {
                    if (isFoodMatchForbidden(searchName, f.name)) return false;
                    const fn = normalizeTr(f.name);
                    return fn.includes(searchNormInclude) || searchNormInclude.includes(fn);
                });
                if (match) {
                    console.log(`‚úÖ ƒ∞√ßeriyor e≈üle≈ümesi: "${searchName}" ‚Üí "${match.name}"`);
                    return match;
                }
            }

            // 6Ô∏è‚É£ TOKEN TABANLI FUZZY MATCHING (√∂rnek_dosya.html mantƒ±ƒüƒ±)
            const searchForFuzzy = quantityCleanName || cleanName;
            const fuzzyMatch = bestFoodFuzzyMatch(searchForFuzzy, foodData);
            
            if (fuzzyMatch && !isFoodMatchForbidden(searchName, fuzzyMatch.name)) {
                console.log(`‚úÖ Token tabanlƒ± fuzzy e≈üle≈üme: "${searchName}" ‚Üí "${fuzzyMatch.name}"`);
                return fuzzyMatch;
            }

            console.log(`‚ùå E≈üle≈üme bulunamadƒ±: "${searchName}"`);
            return null;
        }

        // Yasak yemek e≈üle≈ümelerini kontrol et (yemek_veritabani_yasaklar.json)
        function isFoodMatchForbidden(searchName, targetFoodName) {
            if (!yemekVeritabaniYasaklar || Object.keys(yemekVeritabaniYasaklar).length === 0) {
                return false;
            }

            const searchNorm = normalizeText(searchName);
            const searchNormTr = normalizeTr(searchName);
            const targetNorm = normalizeText(targetFoodName);
            const targetNormTr = normalizeTr(targetFoodName);
            
            // üî• √ñNEMLƒ∞: TAM E≈ûLE≈ûMELERƒ∞ Hƒ∞√áBƒ∞R ZAMAN YASAKLAMA!
            // "Mercimek √áorbasƒ±" ‚Üí "Mercimek √áorbasƒ±" = TAM E≈ûLE≈ûME ‚Üí ƒ∞Zƒ∞N VER ‚úÖ
            if (searchNorm === targetNorm || searchNormTr === targetNormTr) {
                return false; // Tam e≈üle≈üme her zaman g√ºvenli
            }
            
            // Yasak listesini kontrol et
            for (const [key, yasakObj] of Object.entries(yemekVeritabaniYasaklar)) {
                const yasakNorm = normalizeText(key);
                
                // Arama terimi yasak listesindeyse (EVET ama kƒ±smi e≈üle≈üme)
                // √ñrnek: "√ßorba" (genel) ‚Üí yasaklƒ±, ama "Mercimek √áorbasƒ±" (√∂zel) ‚Üí izinli
                if (searchNorm === yasakNorm || searchNorm.includes(yasakNorm)) {
                    const yasakliYemekler = yasakObj.yasakliYemekler || [];
                    
                    // Hedef yemek yasaklƒ± mƒ±?
                    const isForbidden = yasakliYemekler.some(forbidden => 
                        normalizeText(forbidden) === targetNorm
                    );

                    if (isForbidden) {
                        console.log(`üö´ Yasak e≈üle≈üme: "${searchName}" ‚Üí "${targetFoodName}" (${yasakObj.neden || 'manuel olarak yasaklanmƒ±≈ü'})`);
                        return true;
                    }
                }
            }

            return false;
        }

        // Yemek adƒ±ndan tarif kartlarƒ±nƒ± bul (manuel e≈üle≈ütirme √∂ncelikli, yasak kurallarƒ± uygula)
        function findTarifKartlari(yemekAdi) {
            if (!tarifKartlari.length) return [];
            
            // Yemek adƒ±nƒ± temizle (parantez i√ßi, miktar vs.)
            let cleanedYemekAdi = yemekAdi
                .replace(/\([^)]*\)/g,'')
                .replace(/^\d+\.\s*|^\d+\s*adet\s*|^\d+\s*dilim\s*|^\d+\s*gram\s*|^\d+\s*g\s*|^\d+\s*ml\s*|^\d+\s*porsiyon\s*|^\d+\s*su bardaƒüƒ±\s*|^\d+\s*(tatlƒ±|√ßorba|yemek)\s*ka≈üƒ±ƒüƒ±\s*|^\d+\s*kase\s*/i, '')
                .trim();
            const normalizedCleaned = normalizeText(cleanedYemekAdi);
            
            // 1. Manuel e≈üle≈ütirmelere bak
            let manuelData = manuelEslestirmeler[yemekAdi] || Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalizedCleaned);
            if (manuelData && manuelEslestirmeler[manuelData]) {
                manuelData = manuelEslestirmeler[manuelData];
            }

            if (manuelData) {
                const manuelTarifAdlari = (typeof manuelData === 'object' && manuelData.kartlar) 
                    ? manuelData.kartlar 
                    : (typeof manuelData === 'string' ? [manuelData] : []);
                
                const bulunanKartlar = manuelTarifAdlari.map(manuelTarifAdi => {
                    const foundTarif = tarifKartlari.find(tarif => {
                        const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                        const manuelName = (typeof manuelTarifAdi === 'string' ? manuelTarifAdi : '').replace(/\.(jpg|jpeg|png)$/i, '');
                        return normalizeText(tarifName) === normalizeText(manuelName) || tarifName === manuelName;
                    });
                    
                    // ‚úÖ D√úZELTME: Eƒüer tarifKartlari string array ise, dosya adƒ±nƒ± direkt kullan
                    if (foundTarif) {
                        return foundTarif;
                    } else {
                        // Manuel e≈üle≈ütirmede dosya adƒ± varsa, onu kullan
                        const fileName = manuelTarifAdi.includes('.jpg') || manuelTarifAdi.includes('.png') 
                            ? manuelTarifAdi 
                            : `${manuelTarifAdi}.jpg`;
                        return {
                            file: fileName,
                            name: fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' '),
                            type: 'file',
                            download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}`
                        };
                    }
                }).filter(Boolean);
                
                if (bulunanKartlar.length > 0) {
                    console.log('‚úÖ Manuel e≈üle≈ütirme bulundu:', bulunanKartlar.map(k => k.file || k.name));
                    return bulunanKartlar;
                }
            }

            // 2. Otomatik e≈üle≈ütirme (fuzzy matching)
            const potansiyelTarif = tarifKartlari.find(tarif => {
                const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                const tarifNormalized = normalizeText(tarifName);
                return tarifNormalized === normalizedCleaned || tarifNormalized.replace(/_/g, '') === normalizedCleaned;
            }) || tarifKartlari.find(tarif => {
                const tarifName = (tarif.file || tarif.name || '').replace(/\.(jpg|jpeg|png)$/i, '');
                const tarifNormalized = normalizeText(tarifName);
                return tarifNormalized.includes(normalizedCleaned) || normalizedCleaned.includes(tarifNormalized);
            });
            
            // 3. Yasak kurallarƒ±nƒ± kontrol et
            if (potansiyelTarif) {
                const tarifFile = potansiyelTarif.file || potansiyelTarif.name || '';
                
                // Yasak kurallarƒ±nƒ± al (eslestirme.html mantƒ±ƒüƒ± - object format)
                let yasakData = eslesmemeKurallari[yemekAdi] 
                    || eslesmemeKurallari[cleanedYemekAdi];
                
                // Object formatƒ±ndan array'e √ßevir (eslestirme.html mantƒ±ƒüƒ±)
                let yasakListesi = [];
                if (yasakData && typeof yasakData === 'object' && !Array.isArray(yasakData)) {
                    // GitHub format: { orijinalMetin, yasakliKartlar, eklemeTarihi }
                    yasakListesi = yasakData.yasakliKartlar || yasakData.kartlar || [];
                } else if (Array.isArray(yasakData)) {
                    // Eski format: direkt array
                    yasakListesi = yasakData;
                }
                
                // Yasak listesinde var mƒ± kontrol et (dosya adƒ± kar≈üƒ±la≈ütƒ±rmasƒ±)
                const isYasakli = yasakListesi.includes(tarifFile);
                
                if (isYasakli) {
                    console.log('‚õî Yasak kural nedeniyle kart g√∂sterilmedi:', yemekAdi, '->', tarifFile);
                    return []; // Bo≈ü array d√∂nd√ºr
                }
                
                console.log('‚úÖ Otomatik e≈üle≈ütirme bulundu:', tarifFile);
                return [potansiyelTarif];
            }
            
            return [];
        }

        // ===== YARDIMCI FONKSIYONLAR (Food Alternative System) =====

        // Diet type helper
        function getDietType(food) {
            return food.keto ? 'keto' : (food.lowcarb ? 'lowcarb' : 'other');
        }

        // Meal type helper functions
        function parseMealTypes(mealType) {
            if (!mealType) return [];
            if (typeof mealType === 'string') {
                return mealType.split(',').map(m => m.trim().toLowerCase()).filter(Boolean);
            }
            if (Array.isArray(mealType)) {
                return mealType.map(m => String(m).trim().toLowerCase()).filter(Boolean);
            }
            return [];
        }

        function hasMealTypeOverlap(refMealTypes, foodMealTypes) {
            // VEYA mantƒ±ƒüƒ±: En az bir √∂ƒü√ºn ortak olmalƒ±
            if (!refMealTypes.length || !foodMealTypes.length) return false;
            return refMealTypes.some(refType => foodMealTypes.includes(refType));
        }

        // Role display helper
        function getRoleDisplayName(role) {
            if (!role || typeof role !== 'string') return role;
            const ROLE_DISPLAY_MAP = {
                'ana yemek': 'Ana Yemek',
                'salata': 'Salata',
                '√ßorba': '√áorba',
                'tatlƒ±': 'Tatlƒ±',
                'i√ßecek': 'ƒ∞√ßecek',
                'ara √∂ƒü√ºn': 'Ara √ñƒü√ºn',
                'bread': 'Ekmek',
                'ekmek': 'Ekmek'
            };
            const normalized = role.toLowerCase();
            return ROLE_DISPLAY_MAP[normalized] || role;
        }

        // Rozet olu≈üturma fonksiyonu
        function generateFoodBadges(food) {
            let badgesHtml = '';
            
            // Admin settings'den rozet g√∂r√ºn√ºrl√ºk ayarlarƒ±nƒ± al
            const badgeSettings = appSettings?.badgeVisibility || {
                role: false,
                dietType: false,
                category: false,
                season: false,
                mealType: false,
                tags: false
            };
            
            // Debug: Rozet ayarlarƒ±nƒ± kontrol et
            console.log(`üè∑Ô∏è Rozet ayarlarƒ± (${food.foodName || food.name}):`, badgeSettings);
            if (window.debugBadges || false) {
                console.log(`üîç ${food.foodName || food.name} i√ßin rozet ayarlarƒ±:`, badgeSettings);
            }

            // üîç foodData'dan zenginle≈ütirilmi≈ü bilgileri al (Hibrit e≈üle≈ütirme)
            let enrichedFood = food;
            const foodName = food.foodName || food.name;
            
            if (foodName) {
                const matchedFood = findFoodInDatabase(foodName);
                
                if (matchedFood) {
                    // ‚úÖ Veritabanƒ±nda VAR - foodData'dan eksik bilgileri ekle (rozet yok)
                    enrichedFood = { ...food, ...matchedFood };
                } else {
                    // ‚ö†Ô∏è Veritabanƒ±nda YOK - Manuel e≈üle≈ütirme kontrol√º yap
                    const dbMapping = getFoodDatabaseMapping(foodName);
                    const isAdmin = checkAdminPermission();
                    
                    if (dbMapping && isAdmin) {
                        // ‚úÖ Manuel e≈üle≈ütirme VAR - ye≈üil rozet g√∂ster (sadece admin g√∂rs√ºn)
                        badgesHtml += `<span class="food-badge" style="background: #28a745; color: white;" title="Bu yemek veritabanƒ±nda yok ama manuel e≈üle≈ütirme eklenmi≈ü.">‚úÖ E≈üle≈üti</span> `;
                    } else if (!dbMapping && isAdmin) {
                        // ‚ö†Ô∏è Manuel e≈üle≈ütirme YOK - kƒ±rmƒ±zƒ± uyarƒ± rozeti (sadece admin g√∂rs√ºn ve tƒ±klayabilsin)
                        const foodJson = JSON.stringify({
                            protein: food.protein || 0,
                            carbs: food.carbs || food.karbonhidrat || 0,
                            fat: food.fat || food.yag || 0,
                            category: food.category || '',
                            role: food.role || ''
                        }).replace(/"/g, '&quot;');
                        badgesHtml += `<span class="food-badge" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); cursor: pointer;" title="Bu yemek veritabanƒ±nda bulunamadƒ±. Manuel e≈üle≈ütirme ekleyebilirsiniz." onclick='openAdminMatchingModal("${foodName.replace(/'/g, "\\'")}",${foodJson.replace(/'/g, "\\'")})'>‚ö†Ô∏è Veritabanƒ±nda Yok</span> `;
                    }
                }
            }

            // 1. Role Badge
            if (badgeSettings.role && enrichedFood.role) {
                const roleIcon = enrichedFood.role.toLowerCase().includes('ana') ? 'üçñ' :
                                enrichedFood.role.toLowerCase().includes('salata') ? 'ü•ó' :
                                enrichedFood.role.toLowerCase().includes('√ßorba') ? 'üç≤' :
                                enrichedFood.role.toLowerCase().includes('tatlƒ±') ? 'üç∞' :
                                enrichedFood.role.toLowerCase().includes('i√ßecek') ? 'ü•§' :
                                enrichedFood.role.toLowerCase().includes('bread') ? 'üçû' : 'üçΩÔ∏è';
                badgesHtml += `<span class="food-badge badge-role" title="Rol: ${enrichedFood.role}">${roleIcon} ${getRoleDisplayName(enrichedFood.role)}</span> `;
            }

            // 2. DietType Badge
            if (badgeSettings.dietType) {
                const foodDietType = getDietType(enrichedFood);
                if (foodDietType === 'keto') {
                    badgesHtml += '<span class="diet-badge diet-badge-keto" title="Ketojenik">ü•ë KETO</span> ';
                } else if (foodDietType === 'lowcarb') {
                    badgesHtml += '<span class="diet-badge diet-badge-lowcarb" title="D√º≈ü√ºk Karbonhidrat">üåæ LOWCARB</span> ';
                }
            }

            // 3. Category Badge
            if (badgeSettings.category && enrichedFood.category) {
                const categoryIcon = enrichedFood.category.toLowerCase().includes('et') ? 'ü•©' :
                                    enrichedFood.category.toLowerCase().includes('sebze') ? 'ü•¨' :
                                    enrichedFood.category.toLowerCase().includes('meyve') ? 'üçé' :
                                    enrichedFood.category.toLowerCase().includes('tahƒ±l') ? 'üåæ' : 'üìÇ';
                badgesHtml += `<span class="food-badge badge-category" title="Kategori: ${enrichedFood.category}">${categoryIcon} ${enrichedFood.category}</span> `;
            }

            // 4. Season Badge
            if (badgeSettings.season && enrichedFood.season) {
                const seasonIcon = enrichedFood.season.toLowerCase().includes('yaz') ? '‚òÄÔ∏è' :
                                  enrichedFood.season.toLowerCase().includes('kƒ±≈ü') ? '‚ùÑÔ∏è' :
                                  enrichedFood.season.toLowerCase().includes('ilkbahar') ? 'üå∏' :
                                  enrichedFood.season.toLowerCase().includes('sonbahar') ? 'üçÇ' : 'üìÖ';
                badgesHtml += `<span class="food-badge badge-season" title="Mevsim: ${enrichedFood.season}">${seasonIcon} ${enrichedFood.season}</span> `;
            }

            // 5. MealType Badge
            if (badgeSettings.mealType && enrichedFood.mealType) {
                const mealTypes = parseMealTypes(enrichedFood.mealType);
                if (mealTypes.length > 0) {
                    const mealTypeStr = mealTypes.map(mt => {
                        const upper = mt.charAt(0).toUpperCase() + mt.slice(1);
                        return upper.replace('kahvalti', 'Kahvaltƒ±')
                                  .replace('ogle', '√ñƒüle')
                                  .replace('aksam', 'Ak≈üam')
                                  .replace('ara', 'Ara √ñƒü√ºn');
                    }).join(', ');
                    badgesHtml += `<span class="food-badge badge-mealtype" title="√ñƒü√ºn: ${mealTypeStr}">‚è∞ ${mealTypeStr}</span> `;
                }
            }

            // 6. Tags Badge
            if (badgeSettings.tags && enrichedFood.tags && enrichedFood.tags.length > 0) {
                const tagsStr = enrichedFood.tags.slice(0, 3).join(', ') + (enrichedFood.tags.length > 3 ? '...' : '');
                badgesHtml += `<span class="food-badge badge-tags" title="${enrichedFood.tags.join(', ')}">üè∑Ô∏è ${tagsStr}</span> `;
            }

            return badgesHtml;
        }

        // Tag extraction for filtering
        function extractTagKeywords(food) {
            const keywords = new Set();
            if (!food) return keywords;
            
            // Admin ayarlarƒ±ndan tag exclusions al (filtrelenmeyecek tag'ler)
            const tagExclusions = appSettings?.tagExclusions || ['ekmek', 'ekmeƒüi', '√ßorba', '√ßorbasƒ±', 'keto', 'lowcarb', 'salata', 'tatlƒ±'];
            
            const sources = [];
            if (Array.isArray(food.tags)) sources.push(...food.tags);
            else if (typeof food.tags === 'string') sources.push(food.tags);

            sources.forEach(text => {
                if (!text) return;
                let value = '';
                if (typeof text === 'string') {
                    value = text;
                } else if (typeof text === 'number') {
                    value = String(text);
                } else if (text && typeof text === 'object') {
                    if (typeof text.name === 'string') value = text.name;
                    else if (typeof text.label === 'string') value = text.label;
                    else return;
                } else {
                    return;
                }

                const normalized = normalizeText(value);
                normalized.split(/[^a-z0-9]+/).forEach(token => {
                    if (token && token.length > 2) {
                        // Tag exclusions kontrol√º - eƒüer exclude listesinde varsa ekleme
                        const isExcluded = tagExclusions.some(excluded => 
                            normalizeText(excluded) === token || token.includes(normalizeText(excluded))
                        );
                        if (!isExcluded) {
                            keywords.add(token);
                        }
                    }
                });
            });

            return keywords;
        }

        // Tag filter checker
        function shouldSkipTagFilter(food, refFood) {
            // Tag filtering'i devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈üsa skip et
            if (!appSettings || !appSettings.enableTagFilter) return true;
            
            // Admin ayarlarƒ±ndan exempt role'leri al (varsayƒ±lan: soup, salad, bread)
            const tagExemptRoles = appSettings?.tagExemptions?.roles || ['soup', 'salad', 'bread'];
            const roleNormalized = normalizeText(food.role || '');
            if (roleNormalized && tagExemptRoles.some(exempt => roleNormalized.includes(normalizeText(exempt)))) {
                return true;
            }
            
            // Admin ayarlarƒ±ndan exempt category'leri al (varsayƒ±lan: TOSTLAR)
            const tagExemptCategories = appSettings?.tagExemptions?.categories || ['TOSTLAR'];
            const categoryNormalized = normalizeText(food.category || '');
            if (categoryNormalized && tagExemptCategories.some(exempt => categoryNormalized.includes(normalizeText(exempt)))) {
                return true;
            }
            
            return false;
        }

        // Rotation indices generator
        function getRotatedAlternativeIndices(refFood, totalAlternatives) {
            if (!totalAlternatives || totalAlternatives <= 0) return [];
            
            // üî• √ñNCELƒ∞K SIRASI: Hasta √∂zel ayarƒ± > Admin default > 10
            let alternativeCount = 10; // Fallback
            
            // 1. Hasta bazlƒ± alternatif sayƒ±sƒ±nƒ± kontrol et (mobil versiyon mantƒ±ƒüƒ±)
            try {
                if (patientData && patientData.alternativeCount != null && patientData.alternativeCount > 0) {
                    alternativeCount = patientData.alternativeCount;
                    console.log(`‚úÖ HASTA √ñZEL AYARI KULLANILIYOR: ${alternativeCount}`);
                } else if (appSettings?.defaultAlternativeCount > 0) {
                    alternativeCount = appSettings.defaultAlternativeCount;
                    console.log(`üìã Admin default kullanƒ±lƒ±yor: ${alternativeCount}`);
                } else {
                    console.log(`‚ö†Ô∏è Varsayƒ±lan kullanƒ±lƒ±yor: ${alternativeCount}`);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Alternatif sayƒ±sƒ± alƒ±namadƒ±, varsayƒ±lan kullanƒ±lacak:', error);
            }
            
            // Rotation sistemi ≈üimdilik basit - sƒ±ralƒ± indices d√∂nd√ºr
            // ƒ∞leride localStorage ile rotation state takibi eklenebilir
            const indices = [];
            for (let i = 0; i < Math.min(alternativeCount, totalAlternatives); i++) {
                indices.push(i);
            }
            return indices;
        }

        // --- FOOD ALTERNATIVE SYSTEM: findAlternatives() Core Algorithm ---
        
        /**
         * findAlternatives - Referans yemeƒüe benzer alternatifler bulur
         * @param {Object} refFood - Referans yemek objesi
         * @param {Number} alternativeCount - Ka√ß alternatif d√∂nd√ºr√ºleceƒüi (default: 10)
         * @returns {Array} - Benzerlik skorlarƒ±yla sƒ±ralanmƒ±≈ü alternatif yemekler
         * 
         * Filtreleme kriterleri:
         * - role (exact match - required)
         * - category (exact match)
         * - seasonRange (exact match)
         * - mealType (OR logic - en az bir √∂ƒü√ºn ortak)
         * - dietType (keto/lowcarb hiyerar≈üisi)
         * - tag filtering (shouldSkipTagFilter ile exemptions)
         * 
         * Benzerlik skoru: 100 - ((|cal|/5 + |prot|*3 + |carb|*3 + |fat|*3) / 4)
         */
        function findAlternatives(refFood, alternativeCount = 10) {
            if (!refFood || !refFood.name) {
                console.warn('‚ö†Ô∏è findAlternatives: refFood ge√ßersiz', refFood);
                return [];
            }

            // foodData y√ºklenmi≈ü mi kontrol et
            if (!foodData || foodData.length === 0) {
                console.warn('‚ö†Ô∏è findAlternatives: foodData y√ºklenmemi≈ü');
                return [];
            }

            const selectedDietType = getDietType(refFood);
            const selectedTagKeywords = extractTagKeywords(refFood);
            const refMealTypes = parseMealTypes(refFood.mealType);
            
            // üîç DEBUG: Filtreleme kriterleri
            console.log('üîç findAlternatives DEBUG:', {
                refFoodName: refFood.name,
                refFoodRole: refFood.role,
                refFoodCategory: refFood.category,
                refFoodKeto: refFood.keto,
                refFoodLowcarb: refFood.lowcarb,
                matchCriteria: matchCriteria,
                scoreBy: scoreBy, // Hangi makrolar hesaba katƒ±lacak
                selectedDietType: selectedDietType,
                foodDataTotal: foodData.length
            });

            // 1Ô∏è‚É£ 5 KRƒ∞TER ƒ∞LE Fƒ∞LTRELEME (Admin ayarlarƒ±ndan gelen matchCriteria)
            let alternatives = foodData.filter(food => {
                // Kendisini hari√ß tut
                if (food.name === refFood.name) return false;

                // üçû √ñZEL DURUM: Ekmek i√ßin daha esnek filtreleme
                const isBread = normalizeText(refFood.role || '').includes('bread') || 
                                normalizeText(refFood.role || '').includes('ekmek');
                
                // Role kontrol√º (matchCriteria.role true ise aktif)
                if (matchCriteria.role && !isBread && food.role !== refFood.role) {
                    return false;
                }
                
                // Ekmek i√ßin: Role yerine category kontrol√º (EKMEK kategorisindeki her ≈üey)
                if (isBread && matchCriteria.role) {
                    const foodIsBread = normalizeText(food.role || '').includes('bread') || 
                                       normalizeText(food.role || '').includes('ekmek') ||
                                       normalizeText(food.category || '').includes('ekmek') ||
                                       normalizeText(food.name || '').includes('ekmek');
                    if (!foodIsBread) return false;
                }

                // Category kontrol√º (matchCriteria.category true ise aktif)
                if (matchCriteria.category && !isBread && refFood.category && food.category !== refFood.category) return false;

                // Season kontrol√º (matchCriteria.season true ise aktif)
                if (matchCriteria.season) {
                    // ƒ∞kisi de mevsimlik ise aynƒ± mevsim olmalƒ±
                    if (refFood.seasonRange && food.seasonRange) {
                        if (refFood.seasonRange !== food.seasonRange) {
                            return false;
                        }
                    }
                }

                // MealType kontrol√º (matchCriteria.mealType true ise aktif)
                if (matchCriteria.mealType && refFood.mealType) {
                    const foodMealTypes = parseMealTypes(food.mealType);
                    // En az bir √∂ƒü√ºn ortak olmalƒ± (OR LOGIC)
                    if (!hasMealTypeOverlap(refMealTypes, foodMealTypes)) {
                        return false;
                    }
                }

                // DietType kontrol√º (matchCriteria.dietType true ise aktif)
                if (matchCriteria.dietType) {
                    const foodDietType = getDietType(food);
                    const refDietType = getDietType(refFood);
                    
                    // üîç DEBUG: ƒ∞lk 3 yemek i√ßin diet type kontrol√º g√∂ster
                    if (foodData.indexOf(food) < 3) {
                        console.log(`üîç DietType Check (${food.name}):`, {
                            foodKeto: food.keto,
                            foodLowcarb: food.lowcarb,
                            foodDietType: foodDietType,
                            refKeto: refFood.keto,
                            refLowcarb: refFood.lowcarb,
                            refDietType: refDietType,
                            match: foodDietType === refDietType
                        });
                    }
                    
                    // AYNI Dƒ∞YET Tƒ∞Pƒ∞ OLMALI (keto ‚Üí keto, lowcarb ‚Üí lowcarb, normal ‚Üí normal)
                    if (foodDietType !== refDietType) {
                        return false;
                    }
                }

                return true;
            });
            
            console.log(`üîç Filtre sonrasƒ±: ${alternatives.length} alternatif (foodData: ${foodData.length})`);
            
            // Role filtresi kontrol√º
            if (matchCriteria.role) {
                const roleTypes = alternatives.reduce((acc, food) => {
                    acc[food.role] = (acc[food.role] || 0) + 1;
                    return acc;
                }, {});
                console.log(`‚úÖ Role filtresi AKTIF - Sadece "${refFood.role}" alternatifleri:`, roleTypes);
            } else {
                console.log(`‚ö†Ô∏è Role filtresi PASƒ∞F - T√ºm roller karƒ±≈üƒ±k`);
            }
            
            // DietType filtresi kontrol√º
            if (matchCriteria.dietType) {
                const refDietType = getDietType(refFood);
                const dietTypes = alternatives.reduce((acc, food) => {
                    const dt = getDietType(food);
                    acc[dt] = (acc[dt] || 0) + 1;
                    return acc;
                }, {});
                console.log(`‚úÖ DietType filtresi AKTIF - Sadece "${refDietType}" alternatifleri:`, dietTypes);
            } else {
                console.log(`‚ö†Ô∏è DietType filtresi PASƒ∞F - T√ºm diyet tipleri karƒ±≈üƒ±k`);
            }

            // 2Ô∏è‚É£ TAG Fƒ∞LTRELEME (mobil versiyon mantƒ±ƒüƒ± - enableTagFilter kontrol√º)
            if (appSettings?.enableTagFilter && selectedTagKeywords.size > 0 && !shouldSkipTagFilter(refFood)) {
                const filteredByTags = alternatives.filter(food => {
                    // Salata/√ßorba gibi roller tag filter'dan muaf
                    if (shouldSkipTagFilter(food)) return true;

                    const alternativeKeywords = extractTagKeywords(food);
                    // Eƒüer alternatifin tag'lerinden biri ref food'un tag'leriyle e≈üle≈üiyorsa RED
                    for (const keyword of alternativeKeywords) {
                        if (selectedTagKeywords.has(keyword)) return false;
                    }
                    return true;
                });

                // Eƒüer tag filtrelemesi sonucu alternatif kaldƒ±ysa kullan
                if (filteredByTags.length > 0) {
                    console.log(`üè∑Ô∏è Tag filtreleme: ${alternatives.length} ‚Üí ${filteredByTags.length} alternatif`);
                    alternatives = filteredByTags;
                } else {
                    console.log(`‚ö†Ô∏è Tag filtreleme sonu√ß bulamadƒ±, t√ºm ${alternatives.length} alternatif korunuyor`);
                }
            } else {
                console.log(`‚ÑπÔ∏è Tag filtreleme atlandƒ± (enableTagFilter: ${appSettings?.enableTagFilter}, keywords: ${selectedTagKeywords.size})`);
            }

            // 3Ô∏è‚É£ BENZERLƒ∞K SKORU HESAPLAMA (scoreBy array'ine g√∂re dinamik)
            alternatives = alternatives.map(food => {
                let totalDiff = 0;
                let count = 0;
                let diffDetails = {}; // Debug i√ßin detaylar
                
                // scoreBy array'i bo≈üsa varsayƒ±lan olarak t√ºm makrolar kullanƒ±lƒ±r
                const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
                
                // Scoring mode ve sensitivity divider al
                const scoringMode = appSettings?.scoringMode || 'simple';
                const sensitivityDivider = appSettings?.sensitivityDivider || 10;
                
                // MOD SE√áƒ∞Mƒ∞: Basit veya Geli≈ümi≈ü
                if (scoringMode === 'advanced') {
                    // üéØ GELƒ∞≈ûMƒ∞≈û MOD: Oran bazlƒ± + Kalori aƒüƒ±rlƒ±klƒ±
                    if (criteria.includes('protein')) {
                        const gramDiff = Math.abs((food.protein || 0) - (refFood.protein || 0));
                        const percentDiff = refFood.protein > 0 ? (gramDiff / refFood.protein) * 100 : 0;
                        const calorieWeight = 4; // 1g protein = 4 kcal
                        const loss = percentDiff * (calorieWeight / sensitivityDivider);
                        totalDiff += loss;
                        diffDetails.protein = loss;
                        count++;
                    }
                    
                    if (criteria.includes('carbs')) {
                        const gramDiff = Math.abs((food.carbs || 0) - (refFood.carbs || 0));
                        const percentDiff = refFood.carbs > 0 ? (gramDiff / refFood.carbs) * 100 : 0;
                        const calorieWeight = 4; // 1g karb = 4 kcal
                        const loss = percentDiff * (calorieWeight / sensitivityDivider);
                        totalDiff += loss;
                        diffDetails.carbs = loss;
                        count++;
                    }
                    
                    if (criteria.includes('fat')) {
                        const gramDiff = Math.abs((food.fat || 0) - (refFood.fat || 0));
                        const percentDiff = refFood.fat > 0 ? (gramDiff / refFood.fat) * 100 : 0;
                        const calorieWeight = 9; // 1g yaƒü = 9 kcal
                        const loss = percentDiff * (calorieWeight / sensitivityDivider);
                        totalDiff += loss;
                        diffDetails.fat = loss;
                        count++;
                    }
                    
                    if (criteria.includes('calories')) {
                        const calDiff = Math.abs((food.calories || 0) - (refFood.calories || 0));
                        const percentDiff = refFood.calories > 0 ? (calDiff / refFood.calories) * 100 : 0;
                        const loss = percentDiff / (sensitivityDivider / 10); // Kalori i√ßin daha d√º≈ü√ºk aƒüƒ±rlƒ±k
                        totalDiff += loss;
                        diffDetails.calories = loss;
                        count++;
                    }
                    
                    // Ortalama kayƒ±p
                    const avgLoss = count > 0 ? totalDiff / count : 0;
                    const similarity = Math.round(Math.max(0, 100 - avgLoss));
                    
                    return { ...food, similarity, _diffDetails: diffDetails, _totalDiff: totalDiff, _mode: 'advanced' };
                    
                } else {
                    // üìä BASƒ∞T MOD: Kalori bazlƒ± (gram √ó kalori katsayƒ±sƒ±)
                    if (criteria.includes('protein')) {
                        const gramDiff = Math.abs((food.protein || 0) - (refFood.protein || 0));
                        const calorieDiff = gramDiff * 4; // 1g protein = 4 kcal
                        totalDiff += calorieDiff;
                        diffDetails.protein = calorieDiff;
                        count++;
                    }
                    
                    if (criteria.includes('carbs')) {
                        const gramDiff = Math.abs((food.carbs || 0) - (refFood.carbs || 0));
                        const calorieDiff = gramDiff * 4; // 1g karb = 4 kcal
                        totalDiff += calorieDiff;
                        diffDetails.carbs = calorieDiff;
                        count++;
                    }
                    
                    if (criteria.includes('fat')) {
                        const gramDiff = Math.abs((food.fat || 0) - (refFood.fat || 0));
                        const calorieDiff = gramDiff * 9; // 1g yaƒü = 9 kcal
                        totalDiff += calorieDiff;
                        diffDetails.fat = calorieDiff;
                        count++;
                    }
                    
                    if (criteria.includes('calories')) {
                        const diff = Math.abs((food.calories || 0) - (refFood.calories || 0)) / 5;
                        totalDiff += diff;
                        diffDetails.calories = diff;
                        count++;
                    }
                    
                    // Benzerlik skoru: 100 - (ortalama kalori farkƒ± / 10)
                    const avgCalDiff = count > 0 ? totalDiff / count : 0;
                    const similarity = Math.round(Math.max(0, 100 - (avgCalDiff / 10)));
                    
                    return { ...food, similarity, _diffDetails: diffDetails, _totalDiff: totalDiff, _mode: 'simple' };
                }
            });

            // 4Ô∏è‚É£ BENZERLƒ∞ƒûE G√ñRE SIRALA (en y√ºksek benzerlik √∂nce)
            alternatives.sort((a, b) => b.similarity - a.similarity);
            
            // üîç DEBUG: Benzerlik skoru hesaplama detaylarƒ±
            const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
            const scoringMode = appSettings?.scoringMode || 'simple';
            console.log(`\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
            console.log(`üìä SKORLAMA MODU: ${scoringMode === 'advanced' ? 'üéØ Geli≈ümi≈ü (Oran+Kalori)' : 'üìä Basit (Kalori Bazlƒ±)'}`);
            if (scoringMode === 'advanced') {
                console.log(`üéöÔ∏è Hassasiyet: ${appSettings?.sensitivityDivider || 10}`);
            }
            console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);

            console.log(`üìä SKORLAMA: "${refFood.name}" i√ßin alternatifler`);
            console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
            console.log(`üéØ AKTƒ∞F KRƒ∞TERLER: ${criteria.join(', ')}`);
            console.log(`üìå REFERANS MAKROLAR:`);
            console.log(`   Protein: ${refFood.protein}g | Yaƒü: ${refFood.fat}g | Karb: ${refFood.carbs}g | Kalori: ${refFood.calories}`);
            console.log(`\nüèÜ EN ƒ∞Yƒ∞ 10 ALTERNATƒ∞F:`);
            
            // ƒ∞lk 10 alternatifi detaylƒ± g√∂ster
            alternatives.slice(0, 10).forEach((alt, idx) => {
                const proteinDiff = Math.abs(alt.protein - refFood.protein);
                const fatDiff = Math.abs(alt.fat - refFood.fat);
                const carbDiff = Math.abs(alt.carbs - refFood.carbs);
                const calDiff = Math.abs(alt.calories - refFood.calories);
                
                console.log(`   ${idx + 1}. ${alt.name.padEnd(35)} Skor:${String(alt.similarity).padStart(3)}%`);
                console.log(`      P:${String(alt.protein).padStart(4)}g (Œî${String(proteinDiff.toFixed(1)).padStart(5)}) | Y:${String(alt.fat).padStart(4)}g (Œî${String(fatDiff.toFixed(1)).padStart(5)}) | K:${String(alt.carbs).padStart(4)}g (Œî${String(carbDiff.toFixed(1)).padStart(5)}) | Cal:${String(alt.calories).padStart(4)} (Œî${String(calDiff.toFixed(0)).padStart(4)})`);
            });
            console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`);

            // 5Ô∏è‚É£ Lƒ∞Mƒ∞TLEME - Sadece ilk N alternatifi d√∂nd√ºr (ROTASYON KALDIRILDI!)
            // NOT: Rotasyon navigateFoodAlternative i√ßinde yapƒ±lacak, burada sabit sƒ±ra kullanƒ±lƒ±yor
            const selectedAlternatives = alternatives.slice(0, alternativeCount);

            console.log(`‚úÖ findAlternatives: "${refFood.name}" i√ßin ${selectedAlternatives.length}/${alternatives.length} alternatif bulundu (ROTASYONSUZ)`);
            return selectedAlternatives;
        }

        // üîÑ G√ºn toplamlarƒ±nƒ± yeniden hesapla (√∂ƒü√ºn ve g√ºn makrolarƒ±)
        function recalculateDayMacros(day) {
            const ogunler = day.meals || day.ogunler || [];
            
            // G√ºn toplamlarƒ±nƒ± sƒ±fƒ±rla
            let totalKalori = 0;
            let totalProtein = 0;
            let totalKarb = 0;
            let totalYag = 0;
            
            // Her √∂ƒü√ºn√º dola≈ü ve toplamlarƒ± hesapla
            ogunler.forEach(meal => {
                // √ñƒü√ºn toplamlarƒ±nƒ± sƒ±fƒ±rla
                let ogunKalori = 0;
                let ogunProtein = 0;
                let ogunKarb = 0;
                let ogunYag = 0;
                
                // √ñƒü√ºndeki yemekleri topla
                if (meal.yemekler && meal.yemekler.length > 0) {
                    meal.yemekler.forEach(food => {
                        ogunKalori += food.calories || food.kalori || 0;
                        ogunProtein += food.protein || 0;
                        ogunKarb += food.carbs || food.karb || 0;
                        ogunYag += food.fat || food.yag || 0;
                    });
                }
                
                // √ñƒü√ºn toplamlarƒ±nƒ± kaydet (meal object'inde)
                meal.totalCalories = Math.round(ogunKalori);
                meal.totalProtein = Math.round(ogunProtein);
                meal.totalCarbs = Math.round(ogunKarb);
                meal.totalFat = Math.round(ogunYag);
                
                // G√ºnl√ºk toplama ekle
                totalKalori += ogunKalori;
                totalProtein += ogunProtein;
                totalKarb += ogunKarb;
                totalYag += ogunYag;
            });
            
            // G√ºn toplamlarƒ±nƒ± g√ºncelle
            day.totalMacros = {
                kalori: Math.round(totalKalori),
                protein: Math.round(totalProtein),
                karb: Math.round(totalKarb),
                yag: Math.round(totalYag)
            };
            day.totalCalories = Math.round(totalKalori);
            
            console.log(`‚úÖ G√ºn makrolarƒ± yeniden hesaplandƒ±: ${totalKalori} kcal (P: ${totalProtein}g, K: ${totalKarb}g, Y: ${totalYag}g)`);
        }

        // üìä Yemek i√ßin alternatif sayƒ±sƒ±nƒ± ve mevcut index'i al (sadece localStorage'dan)
        function getAlternativeState(foodName, weekIndex) {
            const foodNameNormalized = normalizeText(foodName);
            const alternativesKey = `foodAlternatives_${foodNameNormalized}`;
            const rotationKey = `foodRotation_${foodNameNormalized}`;
            
            let total = 0;
            let currentIndex = 0;
            
            // localStorage'dan kayƒ±tlƒ± listeyi kontrol et
            try {
                const storedAlternatives = localStorage.getItem(alternativesKey);
                if (storedAlternatives) {
                    const storedList = JSON.parse(storedAlternatives);
                    total = storedList.length;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Alternatif listesi okunamadƒ±:', error);
            }
            
            // localStorage'dan mevcut index'i al
            try {
                const stored = localStorage.getItem(rotationKey);
                if (stored) {
                    const rotationState = JSON.parse(stored);
                    currentIndex = rotationState.index || 0;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Rotasyon state okunamadƒ±:', error);
            }
            
            return { total, currentIndex };
        }

        
        // ÔøΩ Toast notification g√∂ster
        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ÔøΩüîÑ Yemek alternatif se√ßicisini a√ß (mobil versiyon)
        window.openFoodAlternativeSelector = function(foodName, weekIndex, dayIndex, ogunIndex, yemekIndex) {
            // Pozisyon bilgisini localStorage'a kaydet
            const positionData = {
                weekIndex,
                dayIndex,
                ogunIndex,
                yemekIndex,
                originalFoodName: foodName,
                timestamp: Date.now()
            };
            localStorage.setItem('foodReplacementPosition', JSON.stringify(positionData));
            
            // O √∂ƒü√ºndeki mevcut kategorileri topla
            if (!weeks || weeks.length === 0) {
                console.error('‚ùå Hafta verisi tanƒ±mlƒ± deƒüil');
                showToast('L√ºtfen √∂nce hafta verilerini y√ºkleyin', 'error');
                return;
            }
            
            if (!weeks[weekIndex]) {
                console.error('‚ùå Hafta bulunamadƒ±, index:', weekIndex);
                showToast('Hafta bulunamadƒ±', 'error');
                return;
            }
            
            if (!weeks[weekIndex].days || !weeks[weekIndex].days[dayIndex]) {
                console.error('‚ùå G√ºn verisi bulunamadƒ±');
                showToast('G√ºn verisi bulunamadƒ±', 'error');
                return;
            }
            
            const currentDay = weeks[weekIndex].days[dayIndex];
            
            // üîç DEBUG: G√ºn verisini kontrol et
            console.log('üîç currentDay yapƒ±sƒ±:', currentDay);
            console.log('üîç currentDay.ogunler var mƒ±?', !!currentDay.ogunler);
            console.log('üîç currentDay.meals var mƒ±?', !!currentDay.meals);
            
            // √ñƒü√ºnler i√ßin hem ogunler hem meals alanƒ±nƒ± kontrol et (otomatik vs manuel planlama farkƒ±)
            const ogunler = currentDay.ogunler || currentDay.meals;
            
            if (!ogunler || !ogunler[ogunIndex]) {
                console.error('‚ùå √ñƒü√ºn verisi bulunamadƒ±');
                console.error('üìä Mevcut veri yapƒ±sƒ±:', {
                    currentDay: currentDay,
                    ogunler: ogunler,
                    ogunIndex: ogunIndex,
                    ogunlerLength: ogunler?.length
                });
                showToast('√ñƒü√ºn verisi bulunamadƒ±', 'error');
                return;
            }
            
            const currentOgun = ogunler[ogunIndex];
            
            const existingCategories = new Set();
            if (currentOgun.yemekler && Array.isArray(currentOgun.yemekler)) {
                currentOgun.yemekler.forEach(yemek => {
                    if (yemek.category) {
                        existingCategories.add(yemek.category);
                    }
                });
            }
            
            console.log('üö´ O √∂ƒü√ºnde mevcut kategoriler:', Array.from(existingCategories));
            
            // Se√ßili yemeƒüin makrolarƒ±nƒ± al (renderdaki deƒüerler)
            let foodMacros = null;
            if (currentOgun.yemekler && currentOgun.yemekler[yemekIndex]) {
                const selectedFood = currentOgun.yemekler[yemekIndex];
                foodMacros = {
                    calories: selectedFood.calories || selectedFood.kalori || 0,
                    protein: selectedFood.protein || 0,
                    carbs: selectedFood.carbs || selectedFood.karb || 0,
                    fat: selectedFood.fat || selectedFood.yag || 0
                };
                console.log('üìä Renderdaki yemek makrolarƒ±:', foodMacros);
            }
            
            // Modal'ƒ± a√ß
            const modal = document.getElementById('foodSelectorModal');
            const iframe = document.getElementById('foodSelectorIframe');
            
            // Mobil versiyonu iframe'e y√ºkle - foodName, excludeCategories ve macros parametreleri ile
            const encodedFoodName = encodeURIComponent(foodName);
            const encodedCategories = encodeURIComponent(Array.from(existingCategories).join(','));
            const encodedMacros = foodMacros ? encodeURIComponent(JSON.stringify(foodMacros)) : '';
            iframe.src = `mobil_versiyon_v1.html?food=${encodedFoodName}&mode=selector&excludeCategories=${encodedCategories}&macros=${encodedMacros}`;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Arka plan scroll'u engelle
        };
        
        // ‚ùå Modal'ƒ± kapat
        window.closeFoodSelectorModal = function() {
            const modal = document.getElementById('foodSelectorModal');
            const iframe = document.getElementById('foodSelectorIframe');
            
            modal.classList.remove('active');
            iframe.src = ''; // iframe'i temizle
            document.body.style.overflow = ''; // Scroll'u geri a√ß
        };
        
        // üì• Mobil versiyondan gelen yemek deƒüi≈üikliƒüini uygula
        window.replaceFoodFromSelector = function(newFoodData) {
            const positionData = JSON.parse(localStorage.getItem('foodReplacementPosition'));
            if (!positionData) {
                alert('‚ùå Pozisyon bilgisi bulunamadƒ±!');
                return;
            }
            
            const { weekIndex, dayIndex, ogunIndex, yemekIndex } = positionData;
            
            // Yemeƒüi deƒüi≈ütir
            const week = weeks[weekIndex];
            if (!week || !week.days || !week.days[dayIndex]) {
                alert('‚ùå Hafta veya g√ºn bulunamadƒ±!');
                return;
            }
            
            const day = week.days[dayIndex];
            const ogunler = day.meals || day.ogunler || [];
            if (!ogunler[ogunIndex] || !ogunler[ogunIndex].yemekler || !ogunler[ogunIndex].yemekler[yemekIndex]) {
                alert('‚ùå Yemek bulunamadƒ±!');
                return;
            }
            
            // Eski yemeƒüi yeni yemekle deƒüi≈ütir
            ogunler[ogunIndex].yemekler[yemekIndex] = {
                foodName: newFoodData.name,
                kalori: newFoodData.calories || 0,
                protein: newFoodData.protein || 0,
                karb: newFoodData.carbs || 0,
                yag: newFoodData.fat || 0,
                role: newFoodData.role,
                category: newFoodData.category
            };
            
            // Modal'ƒ± kapat
            closeFoodSelectorModal();
            
            // G√ºn√ºn makrolarƒ±nƒ± yeniden hesapla ve sayfayƒ± render et
            recalculateDayMacros(day);
            renderWeekContent();
            
            // Pozisyon bilgisini temizle
            localStorage.removeItem('foodReplacementPosition');
            
            console.log(`‚úÖ Yemek deƒüi≈ütirildi: ${positionData.originalFoodName} ‚Üí ${newFoodData.name}`);
            
            // Kullanƒ±cƒ±ya bilgi ver
            if (window.showNotification) {
                showNotification(`‚úÖ ${positionData.originalFoodName} yerine ${newFoodData.name} eklendi`, 'success');
            }
        };
        
        // ÔøΩ postMessage listener - iframe'den gelen mesajlarƒ± dinle (CORS g√ºvenli)
        window.addEventListener('message', function(event) {
            console.log('üì® postMessage alƒ±ndƒ±:', event.data);
            
            // REPLACE_FOOD mesajƒ±nƒ± kontrol et
            if (event.data && event.data.type === 'REPLACE_FOOD' && event.data.food) {
                console.log('‚úÖ REPLACE_FOOD mesajƒ± i≈üleniyor:', event.data.food.name);
                replaceFoodFromSelector(event.data.food);
            }
        });
        
        // ÔøΩüì¢ Toast notification g√∂ster
        window.showNotification = function(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };
        
        // üîÑ Yemek alternatifleri arasƒ±nda gezinme (ileri/geri) - ARTIK KULLANILMIYOR
        async function navigateFoodAlternative(weekIndex, dayIndex, ogunIndex, yemekIndex, direction = 1) {
            try {
                const week = weeks[weekIndex];
                if (!week || !week.days || !week.days[dayIndex]) return;
                
                const day = week.days[dayIndex];
                const ogunler = day.meals || day.ogunler || [];
                if (!ogunler[ogunIndex] || !ogunler[ogunIndex].yemekler || !ogunler[ogunIndex].yemekler[yemekIndex]) return;
                
                const currentFood = ogunler[ogunIndex].yemekler[yemekIndex];
                const foodNameNormalized = normalizeText(currentFood.foodName);
                const rotationKey = `foodRotation_${foodNameNormalized}`;
                const alternativesKey = `foodAlternatives_${foodNameNormalized}`;
                
                // √ñnce kayƒ±tlƒ± alternatif listesini kontrol et
                let alternatives = null;
                let currentIndex = 0;
                
                try {
                    const storedAlternatives = localStorage.getItem(alternativesKey);
                    const storedState = localStorage.getItem(rotationKey);
                    
                    if (storedAlternatives && storedState) {
                        alternatives = JSON.parse(storedAlternatives);
                        const rotationState = JSON.parse(storedState);
                        currentIndex = rotationState.index || 0;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Kayƒ±tlƒ± alternatifler okunamadƒ±:', error);
                }
                
                // Eƒüer kayƒ±tlƒ± alternatif yoksa, yeni liste olu≈ütur
                if (!alternatives) {
                    const matchedFood = findFoodInDatabase(currentFood.foodName, weekIndex);
                    
                    if (!matchedFood && matchCriteria.role) {
                        alert(`‚ùå Bu yemek veritabanƒ±nda bulunamadƒ±: "${currentFood.foodName}"\n\n‚ö†Ô∏è Alternatif bulunamƒ±yor.`);
                        return;
                    }
                    
                    const alternativeCount = appSettings?.defaultAlternativeCount || 10;
                    const patientDietType = settings?.dietType || 'ketojenik';
                    const inferredKeto = matchedFood?.keto ?? currentFood.keto ?? (patientDietType === 'ketojenik');
                    const inferredLowcarb = matchedFood?.lowcarb ?? currentFood.lowcarb ?? (patientDietType === 'lowcarb');
                    
                    // Orijinal yemeƒüi listeye dahil et
                    const originalFood = {
                        name: currentFood.foodName,
                        calories: currentFood.kalori || currentFood.calories || 0,
                        protein: currentFood.protein || 0,
                        carbs: currentFood.karb || currentFood.carbs || 0,
                        fat: currentFood.yag || currentFood.fat || 0,
                        role: matchedFood?.role || currentFood.role || 'mainDish',
                        category: matchedFood?.category || currentFood.category || ''
                    };
                    
                    // Alternatifleri bul
                    const foundAlternatives = findAlternatives({
                        name: currentFood.foodName,
                        calories: currentFood.kalori,
                        protein: currentFood.protein,
                        carbs: currentFood.karb,
                        fat: currentFood.yag,
                        role: matchedFood?.role || currentFood.role || 'mainDish',
                        category: matchedFood?.category || currentFood.category || '',
                        seasonRange: matchedFood?.seasonRange || currentFood.seasonRange || '',
                        mealType: matchedFood?.mealType || currentFood.mealType || '',
                        dietType: matchedFood?.dietType || currentFood.dietType || '',
                        tags: matchedFood?.tags || currentFood.tags || '',
                        keto: inferredKeto,
                        lowcarb: inferredLowcarb
                    }, alternativeCount);
                    
                    if (!foundAlternatives || foundAlternatives.length === 0) {
                        console.log('‚ùå Alternatif bulunamadƒ±');
                        return;
                    }
                    
                    // Orijinal yemek + alternatifler
                    alternatives = [originalFood, ...foundAlternatives];
                    
                    // Listeyi localStorage'a kaydet
                    try {
                        localStorage.setItem(alternativesKey, JSON.stringify(alternatives));
                        console.log(`üìã Alternatif listesi kaydedildi: ${alternatives.length} yemek`);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Alternatif listesi kaydedilemedi:', error);
                    }
                    
                    currentIndex = 0; // Orijinal yemekten ba≈üla
                }
                
                // ƒ∞leri veya geri git
                currentIndex += direction;
                
                // Sƒ±nƒ±rlama: 0 ile alternatives.length-1 arasƒ±nda
                if (currentIndex < 0) currentIndex = 0;
                if (currentIndex >= alternatives.length) currentIndex = alternatives.length - 1;
                
                // State'i kaydet
                try {
                    localStorage.setItem(rotationKey, JSON.stringify({
                        index: currentIndex,
                        totalAlternatives: alternatives.length
                    }));
                } catch (error) {
                    console.warn('‚ö†Ô∏è Rotasyon state kaydedilemedi:', error);
                }
                
                const selectedAlternative = alternatives[currentIndex];
                
                // üîç DETAYLI DEBUG: Se√ßilen alternatif ve sƒ±ralama
                console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                console.log(`${direction > 0 ? '‚û°Ô∏è ƒ∞LERƒ∞' : '‚¨ÖÔ∏è GERƒ∞'} - Alternatif ${currentIndex + 1}/${alternatives.length}`);
                console.log(`üìä SE√áƒ∞LEN: ${selectedAlternative.name}`);
                console.log(`   Makrolar: Kal:${selectedAlternative.calories} P:${selectedAlternative.protein}g Y:${selectedAlternative.fat}g K:${selectedAlternative.carbs}g`);
                console.log(`   Skor: ${selectedAlternative.similarity}%`);
                console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                console.log(`üîç T√úM ALTERNATƒ∞FLER (ilk 5):`);
                alternatives.slice(0, 5).forEach((alt, idx) => {
                    const isCurrent = idx === currentIndex;
                    console.log(`   ${isCurrent ? 'üëâ' : '  '} ${idx + 1}. ${alt.name} - Skor:${alt.similarity}% | P:${alt.protein}g Y:${alt.fat}g K:${alt.carbs}g Kal:${alt.calories}`);
                });
                console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`);
                
                // Yemeƒüi deƒüi≈ütir
                ogunler[ogunIndex].yemekler[yemekIndex] = {
                    foodName: selectedAlternative.name,
                    kalori: selectedAlternative.calories,
                    protein: selectedAlternative.protein,
                    karb: selectedAlternative.carbs,
                    yag: selectedAlternative.fat,
                    role: selectedAlternative.role,
                    category: selectedAlternative.category
                };
                
                // Makrolarƒ± yeniden hesapla
                recalculateDayMacros(dayIndex);
                
                // Kaydet ve UI'ƒ± g√ºncelle
                await saveWeeks();
                renderWeekContent();
                
            } catch (error) {
                console.error('‚ùå Alternatif gezinme hatasƒ±:', error);
            }
        }

        // üîÑ Tek bir yemek i√ßin alternatif bulma ve deƒüi≈ütirme
        async function refreshFoodInMeal(weekIndex, dayIndex, ogunIndex, yemekIndex) {
            try {
                console.log(`üîÑ Yemek yenileniyor: Week ${weekIndex}, Day ${dayIndex}, √ñƒü√ºn ${ogunIndex}, Yemek ${yemekIndex}`);
                
                // 1Ô∏è‚É£ Mevcut yemeƒüi al (weeks yapƒ±sƒ± kontrol et)
                const week = weeks[weekIndex];
                if (!week || !week.days || !week.days[dayIndex]) {
                    console.error('‚ùå Hafta veya g√ºn bulunamadƒ±!');
                    return;
                }
                
                const day = week.days[dayIndex];
                const ogunler = day.meals || day.ogunler || [];
                
                if (!ogunler[ogunIndex] || !ogunler[ogunIndex].yemekler || !ogunler[ogunIndex].yemekler[yemekIndex]) {
                    console.error('‚ùå Yemek bulunamadƒ±!');
                    return;
                }
                
                const currentFood = ogunler[ogunIndex].yemekler[yemekIndex];
                if (!currentFood) {
                    console.error('‚ùå Yemek bulunamadƒ±!');
                    return;
                }
                
                console.log(`üìå Mevcut yemek: ${currentFood.foodName}`);
                
                // üîç Hibrit e≈üle≈ütirme ile foodData'dan role bilgisini al (ROTASYON MOD: weekIndex ekle)
                const matchedFood = findFoodInDatabase(currentFood.foodName, weekIndex);
                
                if (matchedFood) {
                    console.log(`‚úÖ foodData'da bulundu - Role: ${matchedFood.role}, Category: ${matchedFood.category}`);
                } else {
                    console.warn(`‚ö†Ô∏è foodData'da bulunamadƒ±: ${currentFood.foodName}`);
                    // Role filtresi aktifken foodData'da olmayan yemekler i√ßin ALTERNATƒ∞F BULUNAMAZ
                    if (matchCriteria.role) {
                        alert(`‚ùå Bu yemek veritabanƒ±nda bulunamadƒ±: "${currentFood.foodName}"\n\n‚ö†Ô∏è Role filtresi aktif olduƒüu i√ßin alternatif bulunamƒ±yor.\n\n√á√∂z√ºm:\n1. Yemeƒüi food_list.json'a ekleyin\n2. Admin panelden manuel e≈üle≈ütirme ekleyin\n3. Role filtresini ge√ßici kapatƒ±n`);
                        return;
                    }
                    // Role filtresi kapalƒ±ysa da uyarƒ± ver ama devam et
                    console.error(`üö® ROLE Bƒ∞LGƒ∞Sƒ∞ ALINAMADI - Alternatifler yanlƒ±≈ü olabilir!`);
                }
                
                // Admin ayarlarƒ±ndan alternatif sayƒ±sƒ±nƒ± al (varsayƒ±lan 10)
                const alternativeCount = appSettings?.defaultAlternativeCount || 10;
                
                // 2Ô∏è‚É£ Alternatif bul - role bilgisini foodData'dan kullan
                // üî• √ñNEMLƒ∞: keto ve lowcarb boolean'larƒ±nƒ± da ekle (getDietType i√ßin gerekli!)
                // üî• BUGFIX: foodData'da yoksa settings'den diyet tipini al (hastanƒ±n diyet ayarƒ±)
                const patientDietType = settings?.dietType || 'ketojenik';
                const inferredKeto = matchedFood?.keto ?? currentFood.keto ?? (patientDietType === 'ketojenik');
                const inferredLowcarb = matchedFood?.lowcarb ?? currentFood.lowcarb ?? (patientDietType === 'lowcarb');
                
                const alternatives = findAlternatives({
                    name: currentFood.foodName,
                    calories: currentFood.kalori,
                    protein: currentFood.protein,
                    carbs: currentFood.karb,
                    fat: currentFood.yag,
                    role: matchedFood?.role || currentFood.role || 'mainDish',
                    category: matchedFood?.category || currentFood.category || '',
                    seasonRange: matchedFood?.seasonRange || currentFood.seasonRange || '',
                    mealType: matchedFood?.mealType || currentFood.mealType || '',
                    dietType: matchedFood?.dietType || currentFood.dietType || '',
                    tags: matchedFood?.tags || currentFood.tags || '',
                    // üî• BUGFIX: getDietType() boolean kontrol yapar + settings'den √ßƒ±karsama yap!
                    keto: inferredKeto,
                    lowcarb: inferredLowcarb
                }, alternativeCount);
                
                if (!alternatives || alternatives.length === 0) {
                    // Detaylƒ± hata mesajƒ± hazƒ±rla
                    const refDietType = getDietType({
                        keto: inferredKeto,
                        lowcarb: inferredLowcarb
                    });
                    
                    // foodData'daki role ve dietType daƒüƒ±lƒ±mƒ±nƒ± g√∂ster
                    const roleStats = foodData.reduce((acc, f) => {
                        acc[f.role] = (acc[f.role] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const targetRole = matchedFood?.role || currentFood.role || 'mainDish';
                    const sameRoleFoods = foodData.filter(f => f.role === targetRole);
                    const sameRoleDietStats = sameRoleFoods.reduce((acc, f) => {
                        const dt = getDietType(f);
                        acc[dt] = (acc[dt] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const errorDetails = [
                        `Yemek: ${currentFood.foodName}`,
                        `Role: ${targetRole}`,
                        `DietType: ${refDietType} (keto:${inferredKeto}, lowcarb:${inferredLowcarb}) [foodData: keto=${matchedFood?.keto}, lowcarb=${matchedFood?.lowcarb}]`,
                        `Category: ${matchedFood?.category || currentFood.category || 'Belirsiz'}`,
                        `Hasta diyet tipi: ${settings?.dietType || 'Belirsiz'}`,
                        ``,
                        `Aktif Filtreler:`,
                        `  - Role: ${matchCriteria.role ? 'A√áIK' : 'KAPALI'}`,
                        `  - DietType: ${matchCriteria.dietType ? 'A√áIK' : 'KAPALI'}`,
                        `  - Category: ${matchCriteria.category ? 'A√áIK' : 'KAPALI'}`,
                        `  - Season: ${matchCriteria.season ? 'A√áIK' : 'KAPALI'}`,
                        `  - MealType: ${matchCriteria.mealType ? 'A√áIK' : 'KAPALI'}`,
                        ``,
                        `foodData ƒ∞statistikleri:`,
                        `  - Toplam yemek: ${foodData.length}`,
                        `  - "${targetRole}" role: ${sameRoleFoods.length} adet`,
                        `  - "${targetRole}" + DietType daƒüƒ±lƒ±mƒ±:`,
                        `    ${JSON.stringify(sameRoleDietStats)}`,
                        ``,
                        `Olasƒ± nedenler:`,
                        `1. DietType boolean'larƒ± eksik (keto/lowcarb property yok)`,
                        `2. Role e≈üle≈ümiyor ("${targetRole}" i√ßin ${sameRoleFoods.length} adet var)`,
                        `3. Tag filtreleme √ßok kƒ±sƒ±tlayƒ±cƒ±`,
                        `4. Yemek veritabanƒ±nda yok`
                    ];
                    
                    console.error('‚ùå ALTERNATƒ∞F BULUNAMADI - DETAYLAR:\n' + errorDetails.join('\n'));
                    alert('‚ùå Bu yemek i√ßin alternatif bulunamadƒ±!\n\nDetaylar i√ßin Console (F12) kontrol edin.');
                    return;
                }
                
                console.log(`‚úÖ ${alternatives.length} alternatif bulundu`);
                
                // 3Ô∏è‚É£ Rotasyon tracking (localStorage ile - mobil versiyon mantƒ±ƒüƒ±)
                const foodNameNormalized = normalizeText(currentFood.foodName);
                const rotationKey = `foodRotation_${foodNameNormalized}`;
                
                // LocalStorage'dan rotasyon state'i al
                let rotationState = {};
                try {
                    const stored = localStorage.getItem(rotationKey);
                    if (stored) {
                        rotationState = JSON.parse(stored);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Rotasyon state okunamadƒ±:', error);
                }
                
                // Rotasyon index'i artƒ±r
                let currentIndex = rotationState.index || 0;
                currentIndex = (currentIndex + 1) % alternatives.length;
                
                // Yeni state'i kaydet
                rotationState.index = currentIndex;
                rotationState.lastUpdated = new Date().toISOString();
                try {
                    localStorage.setItem(rotationKey, JSON.stringify(rotationState));
                } catch (error) {
                    console.warn('‚ö†Ô∏è Rotasyon state kaydedilemedi:', error);
                }
                
                // Se√ßilen alternatif
                const selectedAlternative = alternatives[currentIndex];
                
                console.log(`üîÑ Se√ßilen alternatif (${currentIndex + 1}/${alternatives.length}): ${selectedAlternative.name} (Benzerlik: ${selectedAlternative.similarity}%)`);
                
                // 4Ô∏è‚É£ Yemeƒüi g√ºncelle (yeni alternatifle deƒüi≈ütir)
                ogunler[ogunIndex].yemekler[yemekIndex] = {
                    foodName: selectedAlternative.name,
                    kalori: selectedAlternative.calories,
                    protein: selectedAlternative.protein,
                    karb: selectedAlternative.carbs,
                    yag: selectedAlternative.fat,
                    role: selectedAlternative.role,
                    category: selectedAlternative.category,
                    seasonRange: selectedAlternative.seasonRange,
                    mealType: selectedAlternative.mealType,
                    dietType: selectedAlternative.dietType,
                    tags: selectedAlternative.tags
                    // refreshIndex KALDIRILDI - localStorage kullanƒ±yoruz
                };
                
                // meals veya ogunler olarak kaydet (her iki formatta da √ßalƒ±≈üsƒ±n)
                if (day.meals) {
                    day.meals = ogunler;
                } else {
                    day.ogunler = ogunler;
                }
                
                // üî• √ñNEMLƒ∞: √ñƒü√ºn ve g√ºn toplamlarƒ±nƒ± yeniden hesapla
                recalculateDayMacros(day);
                
                // 5Ô∏è‚É£ Weeks array'i kaydet (localStorage + GitHub)
                await saveWeeks();
                
                // 6Ô∏è‚É£ UI'ƒ± g√ºncelle
                renderWeekContent();
                
                console.log(`‚úÖ Yemek ba≈üarƒ±yla deƒüi≈ütirildi: ${selectedAlternative.name}`);
                
            } catch (error) {
                console.error('‚ùå refreshFoodInMeal hatasƒ±:', error);
                alert('‚ùå Yemek deƒüi≈ütirilemedi! Hata: ' + error.message);
            }
        }

        // Initialize
        async function init() {
            console.log('üöÄ Ba≈ülatƒ±lƒ±yor...');
            
            // Admin config y√ºkle (patientAdmins listesi i√ßin)
            await loadAdminsConfig();
            
            // Admin ayarlarƒ±nƒ± y√ºkle
            await loadAdminSettings();
            
            // PDF Export butonunun g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
            const pdfButton = document.getElementById('pdfExportBtn');
            if (pdfButton && appSettings?.featureVisibility?.pdfExportButton) {
                pdfButton.style.display = 'flex';
                console.log('‚úÖ PDF Export butonu g√∂steriliyor');
            } else {
                console.log('‚ùå PDF Export butonu gizli');
            }
            
            // Manuel e≈üle≈ütirmeleri ve yasak kurallarƒ±nƒ± y√ºkle
            await loadManuelEslestirmeler();
            
            // Tarif kartlarƒ±nƒ± y√ºkle
            await loadTarifKartlari();
            
            // Yemek veritabanƒ±nƒ± y√ºkle
            await loadFoodData();
            
            // Check if PatientAuth is available
            if (typeof PatientAuth === 'undefined') {
                console.error('‚ùå PatientAuth bulunamadƒ±!');
                showErrorPage('Kimlik doƒürulama sistemi y√ºklenemedi');
                return;
            }

            // Check if user is logged in
            const session = PatientAuth.getSession();
            if (!session) {
                console.warn('‚ö†Ô∏è Session bulunamadƒ±, giri≈ü sayfasƒ±na y√∂nlendiriliyor');
                window.location.href = 'login.html';
                return;
            }

            console.log('‚úÖ Session bulundu:', session);

            // Set current patient info (window.currentPatient'a da ata)
            currentPatient = window.currentPatient = {
                id: session.patientId || session.id,
                name: session.name || 'Hasta',
                username: session.username || '',
                isAdmin: session.isAdmin === true  // ‚úÖ Admin yetkisini session'dan al
            };
            
            // Admin yetkisi varsa logla
            if (currentPatient.isAdmin) {
                console.log('üëë Admin yetkili kullanƒ±cƒ± tespit edildi:', currentPatient.username);
            }

            // üîí Cihaz ge√ßerliliƒüini kontrol et (DeviceManager varsa)
            if (typeof DeviceManager !== 'undefined' && DeviceManager.checkDeviceValidity) {
                try {
                    const currentDeviceId = await DeviceManager.getDeviceId();
                    const isDeviceValid = await DeviceManager.checkDeviceValidity(currentPatient.id, currentDeviceId);
                    
                    if (!isDeviceValid) {
                        console.error('üö´ Cihaz ge√ßersiz - Admin tarafƒ±ndan resetlenmi≈ü');
                        // Logout ve login sayfasƒ±na y√∂nlendir
                        PatientAuth.logout();
                        alert('‚ö†Ô∏è Cihaz eri≈üimi iptal edildi.\n\nAdmin tarafƒ±ndan cihaz bilgileriniz sƒ±fƒ±rlanmƒ±≈ü.\nL√ºtfen tekrar giri≈ü yapƒ±n.');
                        window.location.href = 'login.html';
                        return;
                    }
                    console.log('‚úÖ Cihaz ge√ßerliliƒüi doƒürulandƒ±');
                } catch (error) {
                    console.error('‚ùå Cihaz ge√ßerlilik kontrol√º hatasƒ±:', error);
                    // Hata durumunda devam et (kullanƒ±cƒ±yƒ± logout etme)
                }
            }

            // Header'ƒ± hemen g√ºncelle (loadPatientData detaylƒ± bilgi y√ºklenince tekrar g√ºncelleyecek)
            document.getElementById('headerPatientName').textContent = currentPatient.name;

            // Hasta bilgilerini y√ºkle (kilo, aktivite vs) - header'daki ad burada g√ºncellenir
            await loadPatientData();

            // Load templates
            await loadTemplates();

            // Load data from GitHub (with localStorage cache fallback)
            await loadDataFromGitHub();
            
            // weeks kontrol√º - eƒüer hala undefined veya bo≈üsa varsayƒ±lan olu≈ütur
            if (!weeks || !Array.isArray(weeks) || weeks.length === 0) {
                console.warn('‚ö†Ô∏è weeks array bo≈ü veya undefined, varsayƒ±lan olu≈üturuluyor...');
                const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                weeks = defaultWeeksData.weeks;
            }

            // Admin UI'yi ba≈ülat
            initAdminUI();

            // Render UI
            renderTabs();
            renderWeekContent();
        }

        // Show error page
        function showErrorPage(message) {
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">${message}</h3>
                    <p style="color: #666; margin-bottom: 20px;">L√ºtfen sayfayƒ± yenileyin veya giri≈ü sayfasƒ±na d√∂n√ºn.</p>
                    <button onclick="window.location.href='login.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Giri≈ü Sayfasƒ±na D√∂n
                    </button>
                </div>
            `;
        }

        // Eski veri yapƒ±sƒ±nƒ± yeni yapƒ±ya d√∂n√º≈üt√ºr
        function migrateWeeksData(oldWeeks) {
            if (!oldWeeks || !Array.isArray(oldWeeks)) return [];
            
            return oldWeeks.map((week, index) => {
                // Eƒüer zaten yeni formattaysa (days property'si varsa) aynen d√∂nd√ºr
                if (week.days && Array.isArray(week.days)) {
                    // days var ama ogunler eksik olabilir - meals'den aktar
                    const migratedDays = week.days.map(day => {
                        if (!day.meals && day.ogunler) {
                            day.meals = day.ogunler;
                        } else if (!day.ogunler && day.meals) {
                            day.ogunler = day.meals;
                        }
                        return day;
                    });
                    return { ...week, days: migratedDays };
                }
                
                // Eski format (meals property'si var)
                console.log('üîÑ Eski veri formatƒ± tespit edildi, d√∂n√º≈üt√ºr√ºl√ºyor...', week);
                
                const today = new Date();
                const weekStartDate = week.startDate || today.toISOString().split('T')[0];
                
                return {
                    id: week.id || Date.now() + index,
                    name: week.name || `${index + 1}. Hafta`,
                    weekNumber: week.week || week.weekNumber || (index + 1),
                    startDate: weekStartDate,
                    endDate: week.endDate || new Date(new Date(weekStartDate).getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: week.status || 'active',
                    createdDate: week.createdDate || new Date().toISOString(),
                    days: [], // Eski meals verisini days'e d√∂n√º≈üt√ºrebiliriz ama ≈üimdilik bo≈ü bƒ±rakƒ±yoruz
                    weekStats: week.weekStats || {
                        totalDays: 0,
                        completedDays: 0,
                        averageCalories: 0,
                        averageProtein: 0,
                        averageCarb: 0,
                        averageFat: 0
                    },
                    notes: week.notes || ""
                };
            });
        }

        // Hasta bilgilerini y√ºkle (hastalar/ klas√∂r√ºnden)
        async function loadPatientData() {
            try {
                // currentPatient.id zaten patient_ √∂neki i√ßeriyor, temizle
                const cleanId = String(currentPatient.id).replace(/^patient_/i, '');
                const patientFileName = `hastalar/patient_${cleanId}.json`;
                const cachedDataKey = `patient_data_${cleanId}`;
                
                console.log('üîç Hasta verisi y√ºkleniyor:', patientFileName);
                
                // √ñNCELƒ∞K 1: GitHub'dan √ßek (cache bypass i√ßin timestamp)
                const timestamp = new Date().getTime();
                const response = await fetch(`${patientFileName}?t=${timestamp}`);
                
                if (response.ok) {
                    // GitHub'da var - HER ZAMAN √ñNCE GITHUB!
                    patientData = await response.json();
                    
                    // Session'dan username'i ekle (patientData'da yoksa)
                    const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                    if (!patientData.username && session.username) {
                        patientData.username = session.username;
                    }
                    
                    // üßπ localStorage quota y√∂netimi
                    try {
                        localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    } catch (quotaError) {
                        if (quotaError.name === 'QuotaExceededError') {
                            console.warn('‚ö†Ô∏è localStorage dolu, eski hasta verileri temizleniyor...');
                            // Eski hasta verilerini temizle (sadece patient_data_* anahtarlarƒ±)
                            const keysToRemove = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith('patient_data_') && key !== cachedDataKey) {
                                    keysToRemove.push(key);
                                }
                            }
                            keysToRemove.forEach(key => localStorage.removeItem(key));
                            console.log(`üóëÔ∏è ${keysToRemove.length} eski hasta verisi temizlendi`);
                            
                            // Tekrar dene
                            try {
                                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                                console.log('‚úÖ Temizlik sonrasƒ± hasta verisi kaydedildi');
                            } catch (retryError) {
                                console.error('‚ùå Temizlik sonrasƒ± kayƒ±t ba≈üarƒ±sƒ±z:', retryError);
                            }
                        } else {
                            throw quotaError;
                        }
                    }
                    
                    console.log('‚úÖ Hasta bilgileri GitHub\'dan y√ºklendi:', patientData);
                    
                    // üîê isAdmin alanƒ±nƒ± currentPatient'a ekle (window'a da senkronize et)
                    // √ñNEMLƒ∞: Her durumda set et (√∂nceki kullanƒ±cƒ±dan kalan deƒüeri temizle)
                    currentPatient.isAdmin = patientData.isAdmin === true;
                    window.currentPatient.isAdmin = patientData.isAdmin === true;
                    
                    if (patientData.isAdmin === true) {
                        console.log('üîë Hasta dosyasƒ±nda admin yetkisi bulundu');
                    } else {
                        console.log('üë§ Hasta dosyasƒ±nda admin yetkisi YOK (isAdmin: false)');
                    }
                    
                    // Weeks verisini y√ºkle
                    if (patientData.weeks && Array.isArray(patientData.weeks)) {
                        // Eski formatƒ± yeni formata d√∂n√º≈üt√ºr
                        weeks = migrateWeeksData(patientData.weeks);
                        console.log('‚úÖ Hafta verileri y√ºklendi ve migrate edildi:', weeks.length, 'hafta');
                    } else {
                        // weeks undefined bƒ±rak, loadDataFromGitHub() varsayƒ±lan olu≈üturacak
                        weeks = undefined;
                        console.log('‚ö†Ô∏è Hafta verisi bulunamadƒ± (GitHub\'da yok)');
                    }
                } else {
                    // √ñNCELƒ∞K 2: GitHub'da yoksa localStorage'dan y√ºkle
                    const cachedData = localStorage.getItem(cachedDataKey);
                    if (cachedData) {
                        patientData = JSON.parse(cachedData);
                        console.log('‚ö†Ô∏è GitHub eri≈üilemiyor, localStorage kullanƒ±ldƒ±:', patientData);
                        
                        // üîê isAdmin alanƒ±nƒ± currentPatient'a ekle (localStorage'dan y√ºklerken de)
                        currentPatient.isAdmin = patientData.isAdmin === true;
                        window.currentPatient.isAdmin = patientData.isAdmin === true;
                        
                        if (patientData.isAdmin === true) {
                            console.log('üîë localStorage: Admin yetkisi bulundu');
                        } else {
                            console.log('üë§ localStorage: Admin yetkisi YOK');
                        }
                        
                        // Weeks verisini y√ºkle
                        if (patientData.weeks && Array.isArray(patientData.weeks)) {
                            // Eski formatƒ± yeni formata d√∂n√º≈üt√ºr
                            weeks = migrateWeeksData(patientData.weeks);
                            console.log('‚úÖ Hafta verileri localStorage\'dan y√ºklendi ve migrate edildi:', weeks.length, 'hafta');
                        } else {
                            weeks = undefined;
                        }
                    } else {
                        // Hi√ßbir yerde yok - varsayƒ±lan deƒüerler
                        console.warn('‚ö†Ô∏è Hasta dosyasƒ± bulunamadƒ±, varsayƒ±lan deƒüerler kullanƒ±lacak');
                        patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                        weeks = undefined;
                        
                        // üîê Varsayƒ±lan: Admin yetkisi YOK
                        currentPatient.isAdmin = false;
                        window.currentPatient.isAdmin = false;
                    }
                }
                
                // Header'daki hasta adƒ±nƒ± g√ºncelle
                const fullName = patientData.personalInfo?.name && patientData.personalInfo?.surname
                    ? `${patientData.personalInfo.name} ${patientData.personalInfo.surname}`
                    : patientData.personalInfo?.name || currentPatient.name || 'Hasta';
                document.getElementById('headerPatientName').textContent = fullName;
                
                // ÔøΩ Hasta bazƒ±nda scoreBy ayarlarƒ±nƒ± y√ºkle (mobil_versiyon_v1.html ile senkronize)
                if (patientData.settings && patientData.settings.activeMacros) {
                    scoreBy = patientData.settings.activeMacros;
                    console.log('üìä Hasta bazƒ±nda scoreBy y√ºklendi:', scoreBy);
                } else {
                    // Varsayƒ±lan: protein ve yaƒü
                    scoreBy = ['protein', 'fat'];
                    console.log('üìä Varsayƒ±lan scoreBy kullanƒ±lƒ±yor:', scoreBy);
                }
                
                // Admin √∂zelliklerini g√ºncelle (hasta verisi y√ºklendikten sonra)
                toggleAdminFeatures();
                
                // Hasta verilerinden hedef makrolarƒ± hesapla ve settings'i g√ºncelle
                updateSettingsFromPatient(patientData);
                    
            } catch (error) {
                console.error('‚ùå Hasta bilgileri y√ºklenirken hata:', error);
                patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                weeks = undefined; // undefined bƒ±rak, varsayƒ±lan hafta loadDataFromGitHub() i√ßinde olu≈üturulacak
                // Hata durumunda da header'ƒ± g√ºncelle
                document.getElementById('headerPatientName').textContent = currentPatient.name || 'Hasta';
                // Varsayƒ±lan hasta verilerinden settings hesapla
                updateSettingsFromPatient(patientData);
            }
        }

        // Makro g√∂sterimini g√ºncelle
        function updateMacroDisplay() {
            const dietType = document.getElementById('dietType').value;
            const macroDisplay = document.getElementById('macroDisplay');
            const macroDetails = document.getElementById('macroDetails');

            if (!dietType || (dietType !== 'ketojenik' && dietType !== 'lowcarb' && dietType !== 'eliminasyonlu-ketojenik')) {
                macroDisplay.style.display = 'none';
                return;
            }

            // Form'dan g√ºncel deƒüerleri al - eƒüer form bo≈üsa patientData'dan √ßek
            let weight = parseFloat(document.getElementById('patientWeight').value);
            let activity = parseInt(document.getElementById('patientActivity').value);
            
            // Eƒüer form deƒüerleri bo≈üsa, patientData'dan √ßek
            if (!weight && patientData?.personalInfo?.weight) {
                weight = patientData.personalInfo.weight;
                document.getElementById('patientWeight').value = weight;
            }
            if (!activity && patientData?.personalInfo?.activity) {
                activity = patientData.personalInfo.activity;
                document.getElementById('patientActivity').value = activity;
            }
            
            // Hala deƒüer yoksa varsayƒ±lanlarƒ± kullan
            weight = weight || 70;
            activity = activity || 3;

            // Eliminasyonlu ketojenik i√ßin ketojenik form√ºl√ºn√º kullan
            const calcDietType = dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : dietType;
            const macros = calculateMacros(weight, calcDietType, activity);

            if (macros) {
                macroDetails.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>Kilo:</strong> ${weight} kg | <strong>Aktivite:</strong> Seviye ${activity} (√ó${macros.activityMultiplier})
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Karbonhidrat</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.carb}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Protein</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.protein}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Yaƒü</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.fat}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Kalori</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.calories} kcal</div>
                        </div>
                    </div>
                `;
                macroDisplay.style.display = 'block';
                
                // Hesaplanan kaloriyi hedef kalori alanƒ±na yaz ve min/max'ƒ± otomatik hesaplat
                document.getElementById('targetCalories').value = macros.calories;
                updateCalorieRange();
            } else {
                macroDisplay.style.display = 'none';
            }
        }

        // Hedef kaloriden min/max hesapla
        function updateCalorieRange() {
            const targetCalories = parseInt(document.getElementById('targetCalories').value) || 0;
            
            if (targetCalories > 0) {
                // Hasta kendi toleransƒ±nƒ± belirlediyse onu kullan, yoksa admin varsayƒ±lanƒ±nƒ± kullan
                let tolerancePercent = parseInt(document.getElementById('calorieTolerancePercent').value);
                if (!tolerancePercent || tolerancePercent < 0) {
                    tolerancePercent = appSettings?.calorieTolerancePercent || 5;
                }
                
                const tolerance = tolerancePercent / 100;
                
                const minCalories = Math.round(targetCalories * (1 - tolerance));
                const maxCalories = Math.round(targetCalories * (1 + tolerance));
                
                document.getElementById('minCalories').value = minCalories;
                document.getElementById('maxCalories').value = maxCalories;
                
                // Tolerans bilgisini g√ºncelle
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ¬±%${tolerancePercent} tolerans ile ayarlanƒ±r`;
            } else {
                document.getElementById('minCalories').value = '';
                document.getElementById('maxCalories').value = '';
            }
        }

        // Tolerans deƒüeri deƒüi≈ütiƒüinde bilgilendirme g√ºncelle
        function updateToleranceInfo() {
            updateCalorieRange(); // Min/max'ƒ± yeniden hesapla
            
            // Eƒüer g√ºn ekleme modalƒ± a√ßƒ±ksa, ≈üablonlarƒ± yeniden y√ºkle (dinamik filtreleme)
            const addDayModal = document.getElementById('addDayModal');
            if (addDayModal && addDayModal.style.display === 'flex') {
                console.log('üîÑ Tolerans deƒüi≈üti, ≈üablonlar yeniden y√ºkleniyor...');
                loadDayTemplates();
            }
        }

        // Load Data from GitHub
        async function loadDataFromGitHub() {
            console.log('üîÑ GitHub\'dan veriler y√ºkleniyor...');
            
            try {
                // weeks loadPatientData() i√ßinde y√ºklendi
                // SADECE undefined ise (GitHub'da hi√ß yoksa) varsayƒ±lan hafta olu≈ütur
                if (weeks === undefined) {
                    console.log('‚ö†Ô∏è Hafta verisi bulunamadƒ±, varsayƒ±lan hafta olu≈üturuluyor');
                    const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                    weeks = defaultWeeksData.weeks;
                    // Varsayƒ±lan haftayƒ± kaydet
                    await saveWeeks();
                } else {
                    console.log('‚úÖ Mevcut hafta verileri kullanƒ±lƒ±yor:', weeks.length, 'hafta');
                }

                // Apply settings to form if modal is open
                applySettingsToForm();

                console.log('‚úÖ Veriler ba≈üarƒ±yla y√ºklendi');
                showToast('Veriler y√ºklendi');

            } catch (error) {
                console.error('‚ùå Veri y√ºklenirken hata:', error);
                
                // Hata durumunda SADECE undefined ise varsayƒ±lan hafta olu≈ütur
                if (weeks === undefined) {
                    const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                    weeks = defaultWeeksData.weeks;
                }

                showToast('√ñnbellekten y√ºklendi', 'warning');
            }
        }

        // Load Templates from JSON (INDEX ONLY - Lazy Loading)
        async function loadTemplates() {
            try {
                console.log('üì• ≈ûablon index\'i GitHub\'dan y√ºkleniyor...');

                // Check if TemplateManager is loaded
                if (typeof TemplateManager === 'undefined') {
                    console.error('‚ùå TemplateManager tanƒ±mlƒ± deƒüil! template_manager.js y√ºklenmemi≈ü olabilir.');
                    console.error('üîç Script yolu kontrol: ./template_manager.js (relative path)');
                    console.error('‚ö†Ô∏è UYARI: Fallback sistem sadece 198 ≈üablon i√ßerir (999 yerine)!');
                    console.log('üîÑ Fallback: Eski sisteme ge√ßiliyor (gun-sablonlari-2025-10-25.json)...');
                    
                    // FALLBACK: Load old single file system (198 templates with FULL DATA)
                    const dayResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/gun-sablonlari-2025-10-25.json?t=' + Date.now());
                    const dayData = await dayResponse.json();
                    dayTemplates = dayData.templates || [];
                    
                    console.log('‚úÖ Eski sistemden y√ºklendi:', dayTemplates.length, '≈üablon (FULL DATA - ogunler dahil)');
                    console.warn('‚ö†Ô∏è Sadece', dayTemplates.length, '≈üablon y√ºklendi. 999 ≈üablon i√ßin template_manager.js gerekli!');
                } else {
                    // Load day template INDEX only (not full templates)
                    // This loads ~7 KB instead of 281 KB!
                    const dayTemplateIndex = await TemplateManager.loadIndex();
                    
                    // Store metadata in dayTemplates for filtering
                    // Full templates will be loaded on-demand in loadDayTemplates()
                    dayTemplates = dayTemplateIndex.templates || [];
                    
                    // üîç DEBUG: ≈ûablon y√ºkleme detaylarƒ±
                    console.log('üìä Index\'ten y√ºklenen ≈üablon sayƒ±sƒ±:', dayTemplateIndex.totalCount);
                    console.log('üìã Metadata array uzunluƒüu:', dayTemplates.length);
                    console.log('üíæ Index boyutu: ~7 KB (√∂nceden: 281 KB)');
                    console.log('ÔøΩ Full data lazy loading ile modal a√ßƒ±lƒ±nca y√ºklenecek');
                }
                // Load meal templates from GitHub (NOT CHANGED - different system)
                const mealResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/ogun-sablonlari-2025-09-25-2025-10-25%20(1).json');
                const mealData = await mealResponse.json();
                mealTemplates = mealData.templates || [];

                console.log('‚úÖ ≈ûablonlar y√ºklendi:', {
                    gunSablonlariIndex: dayTemplates.length,
                    ogunSablonlari: mealTemplates.length
                });
            } catch (error) {
                console.error('‚ùå ≈ûablonlar y√ºklenemedi:', error);
                showToast('≈ûablonlar y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.', 'error');
                
                // Show error in UI
                const contentArea = document.getElementById('contentArea');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è ≈ûablonlar Y√ºklenemedi</h3>
                            <p style="color: #666; margin-bottom: 20px;">Beslenme ≈üablonlarƒ± GitHub'dan y√ºklenemedi. Bu sayfa local file sisteminde √ßalƒ±≈ümaz.</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                                <strong>√á√∂z√ºm:</strong><br>
                                1. Dosyalarƒ± bir web sunucusunda √ßalƒ±≈ütƒ±rƒ±n (XAMPP, WAMP, vb.)<br>
                                2. Ya da GitHub Pages'de deploy edin<br>
                                3. Ya da VS Code Live Server extension kullanƒ±n
                            </div>
                            <button onclick="location.reload()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                üîÑ Sayfayƒ± Yenile
                            </button>
                            <br><br>
                            <a href="mobil_versiyon_v1.html" style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; display: inline-block; margin-top: 10px;">
                                üçΩÔ∏è Alternatif Yemeklere Git
                            </a>
                        </div>
                    `;
                }
            }
        }

        // Load Settings (for form display)
        function applySettingsToForm() {
            if (document.getElementById('dietType')) {
                console.log('üîç applySettingsToForm √ßalƒ±≈ütƒ±rƒ±lƒ±yor, patientData:', patientData);
                
                // Hasta verilerinden bilgileri √ßek (patientData global olarak loadPatientData ile y√ºklendi)
                const personalInfo = patientData?.personalInfo || {};
                const settings = patientData?.settings || {};
                
                console.log('üìã PersonalInfo:', personalInfo);
                console.log('‚öôÔ∏è Settings:', settings);
                
                // Ki≈üisel bilgiler - patientData'dan √ßek
                document.getElementById('patientName').value = personalInfo.name || '';
                document.getElementById('patientSurname').value = personalInfo.surname || '';
                document.getElementById('patientAge').value = personalInfo.age || 35;
                document.getElementById('patientGender').value = personalInfo.gender || '';
                document.getElementById('patientWeight').value = personalInfo.weight || 70;
                document.getElementById('patientHeight').value = personalInfo.height || 170;
                document.getElementById('patientActivity').value = personalInfo.activity || 3;
                
                console.log('‚úÖ Form dolduruldu - Ad:', document.getElementById('patientName').value, 
                           'Soyad:', document.getElementById('patientSurname').value,
                           'Ya≈ü:', document.getElementById('patientAge').value);
                
                // Aktivite seviyesi - personalInfo'dan veya settings'den al
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    activityLevelInput.value = personalInfo.activityLevel || settings.activityLevel || 3;
                }
                
                // Kullanƒ±cƒ± adƒ± (readonly)
                const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                const usernameField = document.getElementById('patientUsername');
                if (usernameField) {
                    // √ñncelik sƒ±rasƒ±: patientData.username > session.username > personalInfo.username
                    const username = patientData?.username || 
                                   session.username || 
                                   patientData?.personalInfo?.username || 
                                   '';
                    usernameField.value = username;
                    console.log('üìù Kullanƒ±cƒ± adƒ± ayarlara y√ºklendi:', username);
                }
                
                // BMI hesapla
                calculateBMI();
                
                // Admin varsayƒ±lan toleransƒ± g√∂ster
                const adminDefaultTolerance = appSettings?.calorieTolerancePercent || 5;
                document.getElementById('adminDefaultTolerance').textContent = adminDefaultTolerance;
                
                // Hasta kendi toleransƒ±nƒ± belirlediyse onu g√∂ster, yoksa admin varsayƒ±lanƒ±nƒ± kullan
                const patientTolerance = settings.calorieTolerance || adminDefaultTolerance;
                document.getElementById('calorieTolerance').value = patientTolerance;
                
                // Tolerans bilgisini g√∂ster
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ¬±%${patientTolerance} tolerans ile ayarlanƒ±r`;
                
                // Diyet ayarlarƒ± - settings objesinden √ßek
                document.getElementById('dietType').value = settings.dietType || 'ketojenik';
                document.getElementById('targetCalories').value = settings.targetCalories || 1000;
                
                // Makro alanlarƒ± varsa onlarƒ± da doldur
                if (document.getElementById('targetProtein')) {
                    document.getElementById('targetProtein').value = settings.targetProtein || 80;
                }
                if (document.getElementById('targetCarbs')) {
                    document.getElementById('targetCarbs').value = settings.targetCarbs || 20;
                }
                if (document.getElementById('targetFat')) {
                    document.getElementById('targetFat').value = settings.targetFat || 70;
                }
                
                document.getElementById('minCalories').value = settings.minCalories || 950;
                document.getElementById('maxCalories').value = settings.maxCalories || 1050;
                document.getElementById('dislikedFoods').value = (settings.dislikedFoods || []).join(', ');
                
                // Makro g√∂sterimini g√ºncelle
                updateMacroDisplay();
            }
        }

        // BMI Hesaplama
        function calculateBMI() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const height = parseFloat(document.getElementById('patientHeight').value);
            
            if (weight > 0 && height > 0) {
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
                document.getElementById('patientBMI').value = bmi;
            } else {
                document.getElementById('patientBMI').value = '';
            }
        }

        // Save Settings - GitHub'a otomatik kaydet
        async function saveSettings() {
            const targetCalories = parseInt(document.getElementById('targetCalories').value) || 1000;
            const targetProtein = parseInt(document.getElementById('targetProtein')?.value) || 80;
            const targetCarbs = parseInt(document.getElementById('targetCarbs')?.value) || 20;
            const targetFat = parseInt(document.getElementById('targetFat')?.value) || 70;
            const calorieTolerance = parseInt(document.getElementById('calorieTolerance')?.value) || (appSettings?.calorieTolerancePercent || 5);
            
            // Toleransa g√∂re min/max hesapla
            const toleranceDecimal = calorieTolerance / 100;
            const minCalories = Math.round(targetCalories * (1 - toleranceDecimal));
            const maxCalories = Math.round(targetCalories * (1 + toleranceDecimal));
            
            const newSettings = {
                dietType: document.getElementById('dietType').value,
                calorieTolerance: calorieTolerance,
                targetCalories: targetCalories,
                targetProtein: targetProtein,
                targetCarbs: targetCarbs,
                targetFat: targetFat,
                minCalories: minCalories,
                maxCalories: maxCalories,
                dislikedFoods: document.getElementById('dislikedFoods').value
                    .split(',')
                    .map(f => f.trim().toLowerCase())
                    .filter(f => f),
                personalInfo: {
                    name: document.getElementById('patientName').value.trim(),
                    surname: document.getElementById('patientSurname').value.trim(),
                    age: parseInt(document.getElementById('patientAge').value) || 35,
                    gender: document.getElementById('patientGender').value,
                    weight: parseFloat(document.getElementById('patientWeight').value) || 70,
                    height: parseFloat(document.getElementById('patientHeight').value) || 170,
                    activity: parseInt(document.getElementById('patientActivity').value) || 3
                },
                password: document.getElementById('patientPassword').value.trim(), // ≈ûifre varsa kaydet
                allergies: settings.allergies || [],
                preferences: settings.preferences || {
                    vegetarian: false,
                    vegan: false,
                    glutenFree: false,
                    dairyFree: false
                },
                activityLevel: settings.activityLevel || 'moderate',
                targetWeight: settings.targetWeight || 0,
                currentWeight: settings.currentWeight || 0,
                height: settings.height || 0,
                age: settings.age || 0,
                gender: settings.gender || ''
            };

            settings = newSettings;
            
            console.log('üíæ Settings g√ºncellendi:', {
                targetCalories,
                targetProtein,
                targetCarbs,
                targetFat,
                tolerance: calorieTolerance,
                minCalories,
                maxCalories
            });
            
            // patientData'yƒ± da g√ºncelle
            if (patientData) {
                patientData.personalInfo = {
                    ...patientData.personalInfo,
                    ...newSettings.personalInfo
                };
                
                // Aktivite seviyesi ekle
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    patientData.personalInfo.activityLevel = parseInt(activityLevelInput.value) || 3;
                }

                patientData.settings = newSettings;
                patientData.updatedAt = new Date().toISOString(); // G√ºncelleme zamanƒ±nƒ± kaydet
                
                // ≈ûifre deƒüi≈ütirilmi≈üse √ñNCE hash hesapla
                let finalPasswordHash = patientData.passwordHash;
                const newPassword = document.getElementById('patientPassword').value.trim();
                if (newPassword && newPassword.length > 0) {
                    // PatientAuth.hashPassword kullan
                    if (typeof PatientAuth !== 'undefined' && PatientAuth.hashPassword) {
                        finalPasswordHash = await PatientAuth.hashPassword(newPassword);
                        patientData.passwordHash = finalPasswordHash;
                        console.log('üîê Yeni ≈üifre hash hesaplandƒ±:', finalPasswordHash.substring(0, 10) + '...');
                    } else {
                        console.warn('‚ö†Ô∏è PatientAuth bulunamadƒ±, eski hash korunuyor');
                    }
                }
                
                // localStorage'a kaydet (hash g√ºncellemesinden SONRA)
                const cleanId = String(currentPatient.id).replace(/^patient_/i, '');
                const cachedDataKey = `patient_data_${cleanId}`;
                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                
                // passwordHash varsa logla
                if (patientData.passwordHash) {
                    console.log('üíæ Ayarlar localStorage\'a kaydedildi (passwordHash:', patientData.passwordHash.substring(0, 10) + '...)');
                } else {
                    console.log('üíæ Ayarlar localStorage\'a kaydedildi');
                }
                
                // Header'daki hasta adƒ±nƒ± hemen g√ºncelle
                const fullName = patientData.personalInfo?.name && patientData.personalInfo?.surname
                    ? `${patientData.personalInfo.name} ${patientData.personalInfo.surname}`
                    : patientData.personalInfo?.name || currentPatient.name || 'Hasta';
                document.getElementById('headerPatientName').textContent = fullName;
                console.log('‚úÖ Header g√ºncellendi:', fullName);
                
                // Session'ƒ± da g√ºncelle (parent frame i√ßin)
                const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                session.name = patientData.personalInfo.name;
                session.surname = patientData.personalInfo.surname;
                localStorage.setItem('patient_session', JSON.stringify(session));
                
                // GitHub'a kaydet (update-patient API ile)
                try {
                    const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                    
                    // Username'i farklƒ± kaynaklardan al
                    const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                    const username = patientData?.username || 
                                   currentPatient.username || 
                                   session.username || 
                                   patientData?.personalInfo?.username || 
                                   '';
                    
                    if (!username) {
                        console.error('‚ùå Username bulunamadƒ±, GitHub\'a kaydedilemez!');
                        showToast('‚ö†Ô∏è Kullanƒ±cƒ± adƒ± bulunamadƒ±! L√ºtfen yeniden giri≈ü yapƒ±n.', 'error');
                        return;
                    }
                    
                    // Tam hasta verisini hazƒ±rla
                    const fullPatientData = {
                        id: String(currentPatient.id).startsWith('patient_') 
                            ? currentPatient.id 
                            : `patient_${currentPatient.id}`,
                        username: username,
                        passwordHash: finalPasswordHash,
                        sessionDays: patientData.sessionDays || 365,
                        alternativeCount: patientData.alternativeCount || 10,
                        status: patientData.status || 'active',
                        isAdmin: patientData.isAdmin || false,
                        personalInfo: {
                            name: patientData.personalInfo.name || '',
                            surname: patientData.personalInfo.surname || '',
                            age: patientData.personalInfo.age || 35,
                            gender: patientData.personalInfo.gender || 'Kadƒ±n',
                            weight: patientData.personalInfo.weight || 70,
                            height: patientData.personalInfo.height || 170,
                            activity: patientData.personalInfo.activity || 3,
                            bmi: parseFloat(document.getElementById('patientBMI').value) || 0
                        },
                        settings: patientData.settings || {},
                        notes: patientData.notes || '',
                        progressLog: patientData.progressLog || [],
                        createdAt: patientData.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        weeks: weeks || []
                    };
                    
                    console.log('üì§ GitHub\'a g√∂nderilecek FULL veri:', fullPatientData);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(fullPatientData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        console.log('‚úÖ Ayarlar GitHub\'a kaydedildi');
                        // Yeniden y√ºkle ki deƒüi≈üiklikler anƒ±nda g√∂r√ºls√ºn
                        try { loadDayTemplates(); } catch (e) {}
                        showToast('‚úÖ Ayarlar kaydedildi!');
                    } else {
                        console.warn('‚ö†Ô∏è GitHub kayƒ±t hatasƒ±:', result.error);
                        showToast('‚úÖ Ayarlar kaydedildi! (Senkronizasyon sonra yapƒ±lacak)', 'warning');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è GitHub baƒülantƒ± hatasƒ±:', error);
                    showToast('‚úÖ Ayarlar kaydedildi! (Senkronizasyon sonra yapƒ±lacak)', 'warning');
                }
            } else {
                showToast('‚úÖ Ayarlar kaydedildi!');
            }

            // Hafta g√∂r√ºn√ºm√ºn√º yeniden render et (hedef deƒüerler g√ºncellensin)
            renderWeekContent();
            
            setTimeout(() => closeModal('settingsModal'), 1000);
        }

        // Load Weeks - removed, now using loadDataFromGitHub()

        // Save Weeks - LocalStorage'a kaydet
        async function saveWeeks() {
            try {
                // LocalStorage'a kaydet (anƒ±nda senkronizasyon i√ßin)
                const cachedDataKey = `patient_data_${currentPatient.id}`;
                patientData.weeks = weeks;
                patientData.updatedAt = new Date().toISOString();
                
                // QuotaExceededError √∂nlemek i√ßin try-catch
                try {
                    localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    console.log('üíæ Haftalƒ±k planlar localStorage\'a kaydedildi');
                } catch (quotaError) {
                    console.warn('‚ö†Ô∏è localStorage QuotaExceeded - eski cache temizleniyor...');
                    // Eski hasta cache'lerini temizle
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('patient_data_') && key !== cachedDataKey) {
                            localStorage.removeItem(key);
                            console.log('üóëÔ∏è Eski cache silindi:', key);
                        }
                    }
                    // Tekrar dene
                    try {
                        localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                        console.log('‚úÖ localStorage temizlendi ve tekrar kaydedildi');
                    } catch (e2) {
                        console.warn('‚ö†Ô∏è localStorage hala dolu - sadece GitHub\'a kaydediliyor');
                    }
                }
                
                // GitHub'a kaydet (API √ºzerinden)
                const cleanId = String(currentPatient.id).replace(/^patient_/i, '');
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patientId: `patient_${cleanId}`,
                        weeks: weeks
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Haftalƒ±k planlar GitHub\'a kaydedildi');
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå GitHub\'a kaydetme hatasƒ±:', errorData);
                    
                    // Deƒüi≈üiklik bayraƒüƒ± ekle (manuel senkronizasyon i√ßin)
                    const pendingChanges = JSON.parse(localStorage.getItem('pending_patient_changes') || '[]');
                    if (!pendingChanges.includes(currentPatient.id)) {
                        pendingChanges.push(currentPatient.id);
                        localStorage.setItem('pending_patient_changes', JSON.stringify(pendingChanges));
                    }
                }
            } catch (error) {
                console.error('‚ùå saveWeeks hatasƒ±:', error);
                
                // Hata durumunda deƒüi≈üiklik bayraƒüƒ± ekle
                const pendingChanges = JSON.parse(localStorage.getItem('pending_patient_changes') || '[]');
                if (!pendingChanges.includes(currentPatient.id)) {
                    pendingChanges.push(currentPatient.id);
                    localStorage.setItem('pending_patient_changes', JSON.stringify(pendingChanges));
                }
            }
        }

        // Hasta datasƒ±nƒ± GitHub'a kaydet (measurements, weeks, vb.)
        async function savePatientData() {
            try {
                // LocalStorage'a kaydet
                const cachedDataKey = `patient_data_${currentPatient.id}`;
                patientData.weeks = weeks;
                patientData.updatedAt = new Date().toISOString();
                
                // QuotaExceededError √∂nlemek i√ßin eski cache'i temizle
                try {
                    localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                    console.log('üíæ Hasta verileri localStorage\'a kaydedildi');
                } catch (quotaError) {
                    console.warn('‚ö†Ô∏è localStorage QuotaExceeded - sadece GitHub\'a kaydediliyor');
                }
                
                // GitHub'a kaydet (API √ºzerinden)
                const cleanId = String(currentPatient.id).replace(/^patient_/i, '');
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-patient';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patientId: `patient_${cleanId}`,
                        ...patientData // T√ºm hasta datasƒ±nƒ± g√∂nder
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Hasta verileri GitHub\'a kaydedildi');
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå GitHub\'a kaydetme hatasƒ±:', errorData);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå savePatientData hatasƒ±:', error);
                return false;
            }
        }

        // ============================================
        // üéØ HAFTA RENDER Sƒ∞STEMƒ∞ KALDIRILDI
        // ============================================
        // Not: Mevcut weeks.days[] sistemi zaten t√ºm verileri saklƒ±yor.
        // Ekstra weekRenders sistemi gereksiz olduƒüu i√ßin kaldƒ±rƒ±ldƒ±.

        // Add New Week
        function addNewWeek() {
            // Modal a√ßarak hafta bilgilerini al
            openAddWeekModal();
        }
        
        // Hafta ekleme/d√ºzenleme modalƒ±nƒ± a√ß
        function openAddWeekModal(weekIndexToEdit = null) {
            const modal = document.getElementById('addWeekModal');
            const isEditMode = weekIndexToEdit !== null;
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
            document.getElementById('addWeekModalTitle').textContent = isEditMode ? '‚úèÔ∏è Haftayƒ± D√ºzenle' : 'üìÖ Yeni Hafta Ekle';
            document.getElementById('saveWeekBtn').textContent = isEditMode ? '‚úÖ G√ºncelle' : '‚úÖ Kaydet';
            
            // Editing mode flag
            window._editingWeekIndex = weekIndexToEdit;
            
            if (isEditMode) {
                // D√ºzenleme modu: Mevcut hafta bilgilerini doldur
                const week = weeks[weekIndexToEdit];
                document.getElementById('weekNumberInput').value = week.weekNumber || (weekIndexToEdit + 1);
                document.getElementById('weekStartDateInput').value = week.startDate || '';
                document.getElementById('weekEndDateInput').value = week.endDate || '';
                document.getElementById('weekDietTypeInput').value = week.dietType || 'eliminasyonlu_ketojenik';
            } else {
                // Yeni hafta modu: Default deƒüerleri ayarla
                
                // En b√ºy√ºk hafta numarasƒ±nƒ± bul
                const maxWeekNumber = weeks.reduce((max, week) => {
                    const num = week.weekNumber || 0;
                    return num > max ? num : max;
                }, 0);
                
                const nextWeekNumber = maxWeekNumber + 1;
                document.getElementById('weekNumberInput').value = nextWeekNumber;
                
                // Diyet t√ºr√º default: Hafta numarasƒ±na g√∂re
                const defaultDietType = getDefaultDietTypeForWeek(nextWeekNumber);
                document.getElementById('weekDietTypeInput').value = defaultDietType;
                
                // Ba≈ülangƒ±√ß ve biti≈ü tarihini hesapla
                const lastWeek = weeks[weeks.length - 1];
                let startDate, endDate;
                
                if (weeks.length === 0 || nextWeekNumber === 1) {
                    // ƒ∞LK HAFTA: Bug√ºnden sonraki ilk Pazar'a kadar (yarƒ±m hafta olabilir)
                    startDate = new Date();
                    endDate = new Date();
                    
                    // Bug√ºn Pazar deƒüilse, sonraki Pazar'ƒ± bul
                    if (endDate.getDay() !== 0) { // 0 = Pazar
                        while (endDate.getDay() !== 0) {
                            endDate.setDate(endDate.getDate() + 1);
                        }
                    }
                    
                    // Eƒüer bug√ºn Pazar ise, 7 g√ºn sonraki Pazar
                    if (startDate.getDay() === 0) {
                        endDate.setDate(endDate.getDate() + 7);
                    }
                } else if (lastWeek && lastWeek.endDate) {
                    // SONRAKI HAFTALAR: Son haftanƒ±n biti≈ü tarihinden sonraki g√ºn ba≈ülar, 7 g√ºn sonra biter
                    startDate = new Date(lastWeek.endDate);
                    startDate.setDate(startDate.getDate() + 1); // Sonraki g√ºn (genelde Pazartesi)
                    
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 6); // 7 g√ºnl√ºk hafta
                } else {
                    // Fallback: Bug√ºnden 7 g√ºnl√ºk hafta
                    startDate = new Date();
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 6);
                }
                
                document.getElementById('weekStartDateInput').value = startDate.toISOString().split('T')[0];
                document.getElementById('weekEndDateInput').value = endDate.toISOString().split('T')[0];
            }
            
            modal.classList.add('active');
            modal.style.display = 'flex';
            
            // Takvimi render et
            setTimeout(() => renderWeekCalendar(), 100);
        }
        
        // Ba≈ülangƒ±√ß tarihine g√∂re biti≈ü tarihini otomatik g√ºncelle (kullanƒ±cƒ± manuel deƒüi≈ütirebilir)
        function updateWeekEndDate() {
            const startDateInput = document.getElementById('weekStartDateInput');
            const endDateInput = document.getElementById('weekEndDateInput');
            
            if (startDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6); // Varsayƒ±lan: 7 g√ºn
                endDateInput.value = endDate.toISOString().split('T')[0];
            }
        }
        
        // Takvim render et - se√ßilen tarih aralƒ±ƒüƒ±nƒ± sarƒ± arkaplan ile i≈üaretle
        function renderWeekCalendar() {
            const container = document.getElementById('weekCalendarContainer');
            if (!container) return;
            
            const startDateInput = document.getElementById('weekStartDateInput');
            const endDateInput = document.getElementById('weekEndDateInput');
            
            // Ba≈ülangƒ±√ß ve biti≈ü tarihlerini al - yoksa bug√ºn√º ve yarƒ±nƒ± kullan
            const startDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : new Date();
            const endDate = endDateInput.value ? new Date(endDateInput.value + 'T00:00:00') : null;
            
            // Ay ge√ßi≈üi kontrol√º - endDate null olabilir
            let needsTwoMonths = false;
            if (endDate) {
                needsTwoMonths = startDate.getMonth() !== endDate.getMonth() || startDate.getFullYear() !== endDate.getFullYear();
            }
            
            // Ba≈ülƒ±k olu≈ütur
            let html = '';
            
            if (endDate) {
                // G√ºn farkƒ± hesapla
                const dayDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                html += `
                    <div style="text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                        <strong style="color: #667eea; font-size: 13px;">üìÖ Se√ßili Aralƒ±k: ${dayDiff} G√ºn</strong>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            ${startDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' })} 
                            ‚Üí 
                            ${endDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' })}
                        </div>
                    </div>
                `;
            } else if (startDateInput.value) {
                // Sadece ba≈ülangƒ±√ß var
                html += `
                    <div style="text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                        <strong style="color: #667eea; font-size: 13px;">üìÖ Ba≈ülangƒ±√ß: ${startDate.toLocaleDateString('tr-TR')}</strong>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">Takvimden biti≈ü tarihi se√ßin</div>
                    </div>
                `;
            } else {
                // Hi√ßbiri yok
                html += `
                    <div style="text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                        <strong style="color: #999; font-size: 13px;">üìÖ Tarih Se√ßin</strong>
                        <div style="font-size: 11px; color: #aaa; margin-top: 4px;">ƒ∞lk tƒ±klama: Ba≈ülangƒ±√ß ‚Ä¢ ƒ∞kinci tƒ±klama: Biti≈ü</div>
                    </div>
                `;
            }
            
            // Takvim(ler) ekle
            html += '<div style="display: flex; gap: 15px; justify-content: center;">';
            
            if (needsTwoMonths && endDate) {
                // ƒ∞ki ay yan yana g√∂ster
                html += renderMonthCalendar(startDate, startDate, endDate, true);
                html += renderMonthCalendar(endDate, startDate, endDate, false);
            } else {
                // Tek ay g√∂ster - ba≈ülangƒ±√ß ayƒ± (veya bug√ºn√ºn ayƒ±)
                const displayDate = startDateInput.value ? startDate : new Date();
                html += renderMonthCalendar(displayDate, startDate, endDate, true);
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Tek bir ayƒ±n takvimini render et
        function renderMonthCalendar(monthDate, rangeStart, rangeEnd, isFirst) {
            const year = monthDate.getFullYear();
            const month = monthDate.getMonth();
            
            // Ay adlarƒ±
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                               'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const dayNames = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
            
            // Ayƒ±n ilk g√ºn√º ve g√ºn sayƒ±sƒ±
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // ƒ∞lk g√ºn√ºn haftanƒ±n hangi g√ºn√º olduƒüunu bul (Pazartesi = 0)
            let firstDayOfWeek = firstDay.getDay() - 1;
            if (firstDayOfWeek === -1) firstDayOfWeek = 6; // Pazar
            
            let html = `
                <div style="flex: 1; min-width: 220px; max-width: 280px;">
                    <div style="text-align: center; font-weight: 600; margin-bottom: 10px; color: #667eea; font-size: 14px;">
                        ${monthNames[month]} ${year}
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr>
            `;
            
            // G√ºn ba≈ülƒ±klarƒ±
            dayNames.forEach(day => {
                html += `<th style="padding: 5px; text-align: center; color: #666; font-weight: 600; font-size: 11px;">${day}</th>`;
            });
            
            html += '</tr></thead><tbody><tr>';
            
            // Bo≈ü h√ºcreler (ayƒ±n ba≈üƒ±ndaki bo≈üluklar)
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<td style="padding: 5px;"></td>';
            }
            
            // G√ºnler
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                
                // rangeEnd null olabilir - kontrol et
                const isInRange = rangeEnd ? (currentDate >= rangeStart && currentDate <= rangeEnd) : false;
                const isRangeStart = currentDate.toDateString() === rangeStart.toDateString();
                const isRangeEnd = rangeEnd ? (currentDate.toDateString() === rangeEnd.toDateString()) : false;
                
                let cellStyle = 'padding: 5px; text-align: center; border-radius: 4px; cursor: pointer; transition: all 0.2s;';
                let textStyle = '';
                let bgColor = 'transparent';
                
                if (isInRange) {
                    bgColor = '#ffd700';
                    cellStyle += ' background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); font-weight: 600;';
                    textStyle = 'color: #333;';
                    
                    if (isRangeStart) {
                        cellStyle += ' border: 2px solid #ff9800; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);';
                        textStyle += ' font-weight: 700;';
                    } else if (isRangeEnd) {
                        cellStyle += ' border: 2px solid #ff5722; box-shadow: 0 2px 4px rgba(255, 87, 34, 0.3);';
                        textStyle += ' font-weight: 700;';
                    }
                }
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                html += `<td style="${cellStyle}" 
                            onclick="selectCalendarDate('${dateStr}')" 
                            onmouseover="if(!this.style.background.includes('ffd700')) this.style.backgroundColor='#e0e0e0'" 
                            onmouseout="this.style.backgroundColor='${bgColor}'"
                            title="üìÖ ${currentDate.toLocaleDateString('tr-TR')}${isRangeStart ? ' (Ba≈ülangƒ±√ß)' : ''}${isRangeEnd ? ' (Biti≈ü)' : ''}">
                            <span style="${textStyle}">${day}</span>
                         </td>`;
                
                // Haftanƒ±n sonu - yeni satƒ±r
                if ((firstDayOfWeek + day) % 7 === 0) {
                    html += '</tr><tr>';
                }
            }
            
            html += '</tr></tbody></table></div>';
            return html;
        }
        
        // Takvimden tarih se√ß - akƒ±llƒ± ba≈ülangƒ±√ß/biti≈ü se√ßimi
        function selectCalendarDate(dateStr) {
            const startInput = document.getElementById('weekStartDateInput');
            const endInput = document.getElementById('weekEndDateInput');
            
            const selectedDate = new Date(dateStr + 'T00:00:00');
            
            if (!startInput.value || (startInput.value && endInput.value)) {
                // Hen√ºz ba≈ülangƒ±√ß yoksa veya her ikisi de doluysa -> ba≈ülangƒ±√ß tarihini set et
                startInput.value = dateStr;
                endInput.value = ''; // Biti≈ü tarihini temizle
                
                // Otomatik biti≈ü tarihi hesapla
                updateWeekEndDate();
            } else if (startInput.value && !endInput.value) {
                // Ba≈ülangƒ±√ß var, biti≈ü yok -> biti≈ü tarihini set et
                const startDate = new Date(startInput.value + 'T00:00:00');
                
                if (selectedDate < startDate) {
                    // Se√ßilen tarih ba≈ülangƒ±√ßtan √∂nceyse -> ba≈ülangƒ±√ß yap
                    endInput.value = startInput.value;
                    startInput.value = dateStr;
                } else {
                    // Normal durum -> biti≈ü yap
                    endInput.value = dateStr;
                }
            }
            
            // Takvimi yeniden render et
            renderWeekCalendar();
        }
        
        // Hafta numarasƒ±na g√∂re default diyet t√ºr√ºn√º belirle
        function getDefaultDietTypeForWeek(weekNumber) {
            if (weekNumber <= 2) {
                return 'eliminasyonlu_ketojenik'; // 1-2. haftalar
            } else if (weekNumber >= 3 && weekNumber <= 9) {
                return 'ketojenik'; // 3-9. haftalar
            } else if (weekNumber >= 10 && weekNumber <= 13) {
                return 'dusuk_karb'; // 10-13. haftalar (Low Carb)
            } else {
                return 'ketojenik'; // 14+ haftalar tekrar ketojenik
            }
        }
        
        // Modal'dan hafta kaydet
        async function saveWeekFromModal() {
            const weekNumber = parseInt(document.getElementById('weekNumberInput').value);
            const startDate = document.getElementById('weekStartDateInput').value;
            const endDate = document.getElementById('weekEndDateInput').value;
            const dietType = document.getElementById('weekDietTypeInput').value;
            const isEditMode = window._editingWeekIndex !== null;
            
            if (!weekNumber || !startDate || !endDate || !dietType) {
                showToast('‚ùå L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                return;
            }
            
            // Tarih kontrol√º - artƒ±k Pazartesi zorunluluƒüu yok
            const date = new Date(startDate + 'T00:00:00');
            
            if (isEditMode) {
                // D√ºzenleme modu: Mevcut haftayƒ± g√ºncelle
                const week = weeks[window._editingWeekIndex];
                week.weekNumber = weekNumber;
                week.name = `${weekNumber}. Hafta`;
                week.startDate = startDate;
                week.endDate = endDate;
                week.dietType = dietType;
                
                showToast('‚úÖ Hafta g√ºncellendi');
            } else {
                // Yeni hafta ekleme modu
                const newWeek = {
                    id: Date.now(),
                    name: `${weekNumber}. Hafta`,
                    weekNumber: weekNumber,
                    startDate: startDate,
                    endDate: endDate,
                    dietType: dietType,
                    days: []
                };
                
                weeks.push(newWeek);
                currentWeekIndex = weeks.length - 1;
                activeWeekIndex = weeks.length - 1;
                
                showToast('‚úÖ Yeni hafta eklendi');
            }
            
            await saveWeeks();
            renderTabs();
            renderWeekContent();
            renderWeekDropdown(); // Dropdown'u da g√ºncelle
            closeModal('addWeekModal');
            window._editingWeekIndex = null;
        }

        // Remove Week
        function removeWeek(index) {
            if (weeks.length === 1) {
                showToast('En az bir hafta bulunmalƒ±dƒ±r', 'error');
                return;
            }

            if (confirm('Bu haftayƒ± silmek istediƒüinizden emin misiniz?')) {
                weeks.splice(index, 1);
                saveWeeks();
                
                if (currentWeekIndex >= weeks.length) {
                    currentWeekIndex = weeks.length - 1;
                }
                if (activeWeekIndex >= weeks.length) {
                    activeWeekIndex = weeks.length - 1;
                }
                
                renderTabs();
                renderWeekContent();
                renderWeekDropdown(); // Dropdown'u da g√ºncelle
                showToast('Hafta silindi');
            }
        }
        
        // Mevcut haftayƒ± sil (buton i√ßin)
        function deleteCurrentWeek() {
            removeWeek(currentWeekIndex);
        }

        // Hafta Dropdown Toggle
        function toggleWeekDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            dropdown.classList.toggle('active');
            
            // Dropdown a√ßƒ±kken dƒ±≈üarƒ± tƒ±klanƒ±rsa kapat
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 10);
            }
        }
        
        function closeDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('weekDropdown');
            const button = document.querySelector('.week-selector-button');
            
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.classList.remove('active');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }
        
        // Hafta Dropdown ƒ∞√ßeriƒüini Render Et
        function renderWeekDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            dropdown.innerHTML = '';
            
            weeks.forEach((week, index) => {
                const item = document.createElement('div');
                item.className = `week-dropdown-item ${index === currentWeekIndex ? 'active' : ''}`;
                
                // Hafta tarih aralƒ±ƒüƒ±nƒ± hesapla
                let dateRange = 'Tarih belirlenmedi';
                if (week.startDate) {
                    const startDate = new Date(week.startDate);
                    const endDate = week.endDate ? new Date(week.endDate) : new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
                    const formatDate = (d) => {
                        const day = d.getDate().toString().padStart(2, '0');
                        const month = (d.getMonth() + 1).toString().padStart(2, '0');
                        const year = d.getFullYear();
                        return `${day}.${month}.${year}`;
                    };
                    dateRange = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                }
                
                // Diyet t√ºr√ºn√º g√∂ster
                let dietLabel = '';
                if (week.dietType) {
                    const dietMap = {
                        'eliminasyonlu_ketojenik': 'ü•ë Elim. Keto',
                        'ketojenik': 'ü•ë Keto',
                        'dusuk_karb': 'üçñ Low Carb',
                        'akdeniz': 'üåø Akdeniz'
                    };
                    dietLabel = `<small style="color: #667eea; font-size: 11px;">${dietMap[week.dietType] || ''}</small>`;
                }
                
                item.innerHTML = `
                    <div class="week-item-info" onclick="selectWeekFromDropdown(${index})" style="flex: 1;">
                        <div class="week-item-title">${week.name}</div>
                        <div class="week-item-date">${dateRange} ${dietLabel}</div>
                    </div>
                    <div class="week-item-actions" onclick="event.stopPropagation()" style="display: flex; gap: 4px;">
                        <button class="btn-edit" onclick="openAddWeekModal(${index})" title="Haftayƒ± D√ºzenle" style="background: #ffc107; color: white; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è</button>
                        ${weeks.length > 1 ? `<button class="btn-delete" onclick="removeWeek(${index})" title="Haftayƒ± Sil" style="background: #dc3545; color: white; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">üóëÔ∏è</button>` : ''}
                    </div>
                `;
                
                dropdown.appendChild(item);
            });
        }
        
        // Dropdown'dan hafta se√ß
        function selectWeekFromDropdown(index) {
            currentWeekIndex = index;
            activeWeekIndex = index;
            
            // Display g√ºncelle
            updateCurrentWeekDisplay();
            
            // Dropdown kapat
            const dropdown = document.getElementById('weekDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            
            // ƒ∞√ßeriƒüi render et
            renderWeekContent();
        }
        
        // Mevcut hafta display'ini g√ºncelle
        function updateCurrentWeekDisplay() {
            const week = weeks[currentWeekIndex];
            if (week) {
                document.getElementById('currentWeekDisplay').textContent = week.name;
            }
        }
        
        // Kƒ±sa tarih formatƒ±
        function formatDateShort(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}.${month}`;
        }

        // Render Tabs (Eski sistem - gizli tutuluyor ama √ßalƒ±≈üƒ±r durumda)
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            // Hafta tablarƒ±nƒ± ekle
            weeks.forEach((week, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === activeWeekIndex ? 'active' : ''}`;
                
                // Diyet t√ºr√ºn√º kƒ±sa g√∂ster
                let dietLabel = '';
                if (week.dietType) {
                    const dietMap = {
                        'eliminasyonlu_ketojenik': 'ü•ë Elim. Keto',
                        'ketojenik': 'ü•ë Keto',
                        'dusuk_karb': 'üçñ Low Carb',
                        'akdeniz': 'üåø Akdeniz'
                    };
                    dietLabel = dietMap[week.dietType] || '';
                }
                
                // Tarih aralƒ±ƒüƒ±nƒ± g√∂ster
                let dateRange = '';
                if (week.startDate) {
                    const startDate = new Date(week.startDate);
                    const endDate = week.endDate ? new Date(week.endDate) : new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
                    const formatDate = (d) => {
                        const day = d.getDate().toString().padStart(2, '0');
                        const month = (d.getMonth() + 1).toString().padStart(2, '0');
                        return `${day}.${month}`;
                    };
                    dateRange = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                }
                
                tab.innerHTML = `
                    <span onclick="switchWeek(${index})" style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <span>${week.name}</span>
                        ${dateRange ? `<small style="font-size: 9px; opacity: 0.7;">${dateRange}</small>` : ''}
                        ${dietLabel ? `<small style="font-size: 10px; opacity: 0.8;">${dietLabel}</small>` : ''}
                    </span>
                    <div style="display: flex; gap: 2px;">
                        <button class="tab-edit" onclick="event.stopPropagation(); openAddWeekModal(${index})" title="D√ºzenle" style="background: #ffc107; color: white; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è</button>
                        ${weeks.length > 1 ? `<button class="tab-close" onclick="event.stopPropagation(); removeWeek(${index})">&times;</button>` : ''}
                    </div>
                `;
                container.appendChild(tab);
            });
            
            // Yeni Hafta Ekle butonu - Son hafta tabƒ±ndan sonra
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-week';
            addBtn.onclick = addNewWeek;
            addBtn.title = 'Yeni Hafta Ekle';
            addBtn.innerHTML = '‚ûï';
            container.appendChild(addBtn);

            // Aktif tab'ƒ± ortala
            setTimeout(() => {
                const activeTab = container.querySelector('.tab.active');
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 50);
            
            // Dropdown'u da g√ºncelle
            renderWeekDropdown();
            updateCurrentWeekDisplay();
        }

        // Switch Week
        function switchWeek(index) {
            currentWeekIndex = index;
            activeWeekIndex = index;
            renderTabs();
            renderWeekContent();
        }

        // Render Week Content
        async function renderWeekContent() {
            const contentArea = document.getElementById('contentArea');
            
            // weeks array kontrol√º
            if (!weeks || !Array.isArray(weeks) || weeks.length === 0) {
                contentArea.innerHTML = '<div class="empty-state"><h3>Haftalƒ±k plan bulunamadƒ±. L√ºtfen sayfayƒ± yenileyin.</h3></div>';
                console.error('‚ùå Weeks array hatalƒ±:', weeks);
                return;
            }
            
            const week = weeks[activeWeekIndex];
            
            // currentWeekIndex'i senkronize tut
            currentWeekIndex = activeWeekIndex;

            if (!week || !week.days || !Array.isArray(week.days)) {
                contentArea.innerHTML = '<div class="empty-state"><h3>Hafta bulunamadƒ± veya g√ºnler tanƒ±mlƒ± deƒüil</h3></div>';
                console.error('‚ùå Hafta verisi hatalƒ±:', week);
                return;
            }

            // üéØ BO≈û HAFTA KONTROL√ú - B√ºy√ºk otomatik plan butonu g√∂ster
            if (week.days.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-week-container">
                        <div class="empty-week-card">
                            <div class="empty-week-icon">üìã</div>
                            <h3 class="empty-week-title">Bu Hafta Hen√ºz Planlanmamƒ±≈ü</h3>
                            <p class="empty-week-description">Otomatik plan olu≈üturarak hƒ±zlƒ±ca ba≈ülayabilirsiniz</p>
                            <button class="empty-week-auto-btn" onclick="openAutoWeekPlanModal()">
                                <span class="btn-icon">‚ú®</span>
                                <span class="btn-text">Otomatik Diyet Planla</span>
                            </button>
                            <div class="empty-week-divider">
                                <span>veya</span>
                            </div>
                            <button class="empty-week-manual-btn" onclick="openAddDayModal()">
                                <span class="btn-icon">‚ûï</span>
                                <span class="btn-text">Manuel G√ºn Ekle</span>
                            </button>
                        </div>
                    </div>
                `;
                console.log('‚ÑπÔ∏è Bo≈ü hafta i√ßin b√ºy√ºk butonlar g√∂steriliyor');
                return;
            }

            // Calculate totals - g√ºncel makro deƒüerlerini kullan
            const totalCalories = week.days.reduce((sum, day) => {
                // totalMacros.kalori veya totalCalories'den al
                return sum + (day.totalMacros?.kalori || day.totalCalories || 0);
            }, 0);
            const avgCalories = week.days.length > 0 ? Math.round(totalCalories / week.days.length) : 0;
            
            // Hafta makrolarƒ± i√ßin ortalama hesapla
            const avgProtein = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.protein || 0), 0) / week.days.length) : 0;
            const avgCarbs = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.karb || 0), 0) / week.days.length) : 0;
            const avgFat = week.days.length > 0 ? Math.round(week.days.reduce((sum, d) => sum + (d.totalMacros?.yag || 0), 0) / week.days.length) : 0;
            
            // Hedef makrolar - √ñNCE ayarlar sayfasƒ±ndan, yoksa settings'den al
            const targetCalInput = document.getElementById('targetCalories');
            const targetProtInput = document.getElementById('targetProtein');
            const targetCarbInput = document.getElementById('targetCarbs');
            const targetFatInput = document.getElementById('targetFat');
            
            const targetCal = targetCalInput?.value ? parseInt(targetCalInput.value) : (parseInt(settings?.targetCalories) || 1000);
            const targetProt = targetProtInput?.value ? parseInt(targetProtInput.value) : (parseInt(settings?.targetProtein) || 80);
            const targetCarb = targetCarbInput?.value ? parseInt(targetCarbInput.value) : (parseInt(settings?.targetCarbs) || 20);
            const targetFat = targetFatInput?.value ? parseInt(targetFatInput.value) : (parseInt(settings?.targetFat) || 70);

            let html = `
                <!-- Haftalƒ±k Ortala ma ve Hedef Makrolar - Tablo Stili -->
                <div class="week-stats-header">
                    <div style="flex: 1; font-weight: 600; padding-left: 4px;">Ortalama / Hedef</div>
                    <div style="width: 50px; text-align: center; font-weight: 600; font-size: 11px;">Kal</div>
                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 11px;">Karb</div>
                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 11px;">Prot</div>
                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 11px;">Yaƒü</div>
                </div>
                <div class="week-stats-values">
                    <div style="flex: 1; padding-left: 4px; color: #667eea; font-weight: 500; font-size: 12px;">Hafta ƒ∞statistikleri</div>
                    <div style="width: 50px; text-align: center; font-size: 12px;">
                        <div style="color: #667eea; font-weight: 600;">${avgCalories}</div>
                        <div style="color: #999; font-size: 10px;">${targetCal}</div>
                    </div>
                    <div style="width: 45px; text-align: center; font-size: 12px;">
                        <div style="color: #667eea; font-weight: 600;">${avgCarbs}</div>
                        <div style="color: #999; font-size: 10px;">${targetCarb}</div>
                    </div>
                    <div style="width: 45px; text-align: center; font-size: 12px;">
                        <div style="color: #667eea; font-weight: 600;">${avgProtein}</div>
                        <div style="color: #999; font-size: 10px;">${targetProt}</div>
                    </div>
                    <div style="width: 45px; text-align: center; font-size: 12px;">
                        <div style="color: #667eea; font-weight: 600;">${avgFat}</div>
                        <div style="color: #999; font-size: 10px;">${targetFat}</div>
                    </div>
                </div>
            `;

            if (week.days.length === 0) {
                html += `
                    <div class="empty-state">
                        <h3>Hen√ºz g√ºn eklenmemi≈ü</h3>
                        <p>Beslenme programƒ±nƒ±zƒ± olu≈üturmaya ba≈ülamak i√ßin g√ºn ekleyin</p>
                    </div>
                `;
            } else {
                html += '<div class="days-grid">';
                week.days.forEach((day, dayIndex) => {
                    html += renderDayCard(day, dayIndex);
                });
                html += '</div>';
            }

            // Alttaki g√ºn ekle butonu kaldƒ±rƒ±ldƒ± - artƒ±k √ºstte

            contentArea.innerHTML = html;
            
            // üîê Admin √∂zelliklerini g√ºncelle (render sonrasƒ±)
            toggleAdminFeatures();
            
            // üìÖ Bug√ºn√ºn tarihine scroll yap (mobilde)
            scrollToTodayIfExists();
        }
        
        // Bug√ºn√ºn tarihine scroll yapma fonksiyonu
        function scrollToTodayIfExists() {
            // Sadece mobilde √ßalƒ±≈üsƒ±n (ekran geni≈üliƒüi kontrol√º)
            if (window.innerWidth > 768) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const week = weeks[activeWeekIndex];
            if (!week || !week.days) return;
            
            // Bug√ºn√ºn tarihine sahip g√ºn kartƒ±nƒ± bul
            let todayDayIndex = -1;
            week.days.forEach((day, index) => {
                if (day.date) {
                    const dayDate = new Date(day.date);
                    dayDate.setHours(0, 0, 0, 0);
                    
                    if (dayDate.getTime() === today.getTime()) {
                        todayDayIndex = index;
                    }
                }
            });
            
            // Eƒüer bug√ºn bulunduysa, o g√ºn kartƒ±na scroll yap
            if (todayDayIndex >= 0) {
                setTimeout(() => {
                    const dayCards = document.querySelectorAll('.day-card');
                    if (dayCards[todayDayIndex]) {
                        dayCards[todayDayIndex].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        console.log('üìÖ Bug√ºn√ºn tarihine scroll yapƒ±ldƒ±:', todayDayIndex);
                    }
                }, 300); // Render tamamlandƒ±ktan sonra
            }
        }

        // Render Day Card
        function renderDayCard(day, dayIndex) {
            const macros = day.totalMacros || { kalori: 0, protein: 0, karb: 0, yag: 0 };
            
            // √ñƒü√ºnleri meals veya ogunler'den al
            const ogunler = day.meals || day.ogunler || [];
            
            let mealsHtml = '';
            
            if (ogunler && ogunler.length > 0) {
                ogunler.forEach((meal, ogunIndex) => {
                    // √ñƒü√ºn makrolarƒ±nƒ± hesapla
                    let ogunKalori = 0;
                    let ogunProtein = 0;
                    let ogunKarb = 0;
                    let ogunYag = 0;
                    
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach(food => {
                            ogunKalori += food.calories || food.kalori || 0;
                            ogunProtein += food.protein || 0;
                            ogunKarb += food.carbs || food.karb || 0;
                            ogunYag += food.fat || food.yag || 0;
                        });
                    }
                    
                    // G√ºnl√ºk kalori i√ßindeki y√ºzde hesapla
                    const gunlukKalori = macros.kalori || 1;
                    const ogunYuzde = gunlukKalori > 0 ? Math.round((ogunKalori / gunlukKalori) * 100) : 0;
                    
                    // √ñƒü√ºn kartƒ± - √ºst bant ile (s√ºtunlara hizalƒ±)
                    mealsHtml += `
                        <div class="meal-item">
                            <div class="meal-item-header">
                                <div style="display: flex; align-items: center; width: 100%;">
                                    <div style="flex: 1; font-weight: 600;">
                                        ${meal.ogunAdi} (${ogunYuzde}%)
                                    </div>
                                    <div style="width: 50px; text-align: center; font-weight: 600; font-size: 12px;">${Math.round(ogunKalori)}</div>
                                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 12px;">${Math.round(ogunKarb)}</div>
                                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 12px;">${Math.round(ogunProtein)}</div>
                                    <div style="width: 45px; text-align: center; font-weight: 600; font-size: 12px;">${Math.round(ogunYag)}</div>
                                </div>
                            </div>
                            <div class="meal-item-content">
                                <table class="meal-table">
                                    <tbody>
                    `;
                    
                    // Yemek satƒ±rlarƒ±
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach((food, yemekIndex) => {
                            // JSON'dan gelen alanlar: calories, protein, carbs, fat
                            const kalori = food.calories || food.kalori || 0;
                            const protein = food.protein || 0;
                            const karb = food.carbs || food.karb || 0;
                            const yag = food.fat || food.yag || 0;
                            
                            // Veritabanƒ± e≈üle≈ütirmesi var mƒ±?
                            const dbMapping = getFoodDatabaseMapping(food.foodName || food.name || '');
                            
                            // ‚úÖ FIX: Kƒ±rmƒ±zƒ± rozet sadece admin rol√ºne g√∂sterilsin
                            const isAdmin = checkAdminPermission();
                            
                            // Veritabanƒ± kontrol√º - E≈üle≈ütirme yoksa ve food_list.json'da da yoksa uyar (sadece admin'e)
                            const isNotInDatabase = !isFoodInDatabase(food.foodName || food.name || '');
                            
                            // DEBUG LOG
                            if (isNotInDatabase) {
                                console.log('üî¥ Veritabanƒ±nda YOK:', {
                                    foodName: food.foodName || food.name,
                                    isAdmin: isAdmin,
                                    dbMapping: !!dbMapping,
                                    rozetGorunecekMi: (isNotInDatabase && !dbMapping && isAdmin)
                                });
                            }
                            
                            const foodNameEscaped = (food.foodName || food.name || '').replace(/'/g, "\\'");
                            const foodJsonData = JSON.stringify({
                                protein: protein,
                                carbs: karb,
                                fat: yag,
                                category: food.category || '',
                                role: food.role || ''
                            }).replace(/"/g, '&quot;');
                            const dbWarningBadge = (isNotInDatabase && !dbMapping && isAdmin)
                                ? `<span class="food-badge" style="background: #dc3545; color: white; cursor: pointer;" title="Bu yemek veritabanƒ±nda bulunamadƒ±. Manuel e≈üle≈ütirme ekleyebilirsiniz." onclick='openAdminMatchingModal("${foodNameEscaped}",${foodJsonData})'>‚ö†Ô∏è Veritabanƒ±nda Yok</span> `
                                : '';
                            
                            // ‚úÖ E≈üle≈üti badge'i - Sadece veritabanƒ±nda YOKSA ve manuel e≈üle≈ütirme VARSA g√∂ster (sadece admin g√∂rs√ºn)
                            let dbMappingBadge = '';
                            if (isNotInDatabase && dbMapping && isAdmin) {
                                dbMappingBadge = `<span class="food-badge" style="background: #28a745; color: white;" title="Bu yemek veritabanƒ±nda yok ama manuel e≈üle≈ütirme eklenmi≈ü.">‚úÖ E≈üle≈üti</span> `;
                            }
                            
                            // Tarif kartlarƒ±nƒ± bul
                            const tarifKartlari = findTarifKartlari(food.foodName || food.name || '');
                            let tarifBadgesHtml = '';
                            if (tarifKartlari.length > 0) {
                                tarifKartlari.forEach((tarif, index) => {
                                    const tarifLabel = tarifKartlari.length > 1 ? `Tarif ${index + 1}` : 'Tarif';
                                    tarifBadgesHtml += `<span class="tarif-badge" onclick="openPdfModal('${tarif.download_url}')" title="Tarif kartƒ±nƒ± g√∂r√ºnt√ºle">${tarifLabel}</span> `;
                                });
                            }
                            
                            // Rozetleri olu≈ütur (admin settings'den gelen g√∂r√ºn√ºrl√ºk ayarlarƒ±na g√∂re)
                            const foodBadgesHtml = generateFoodBadges(food);
                            
                            // üîê Admin ikonu (sadece admin kullanƒ±cƒ±lar g√∂rebilir - yuvarlak ikonik buton)
                            const adminIconHtml = window.isUserAdmin() 
                                ? `<button class="btn-food-admin admin-only" onclick="openAdminFoodEditModal(${currentWeekIndex}, ${dayIndex}, ${ogunIndex}, ${yemekIndex})" title="Admin: Yemek e≈üle≈ütirmelerini d√ºzenle">
                                    ‚öôÔ∏è
                                  </button>` 
                                : '';
                            
                            // üîÑ Yemek deƒüi≈ütir butonu - Mobil versiyonu a√ßar
                            const changeFoodBtn = `<button class="btn-change-food" onclick="openFoodAlternativeSelector(\`${food.foodName}\`, ${currentWeekIndex}, ${dayIndex}, ${ogunIndex}, ${yemekIndex})" title="Alternatif yemek se√ß">
                                üîÑ Deƒüi≈ütir
                            </button>`;
                            
                            mealsHtml += `
                                <tr>
                                    <td style="padding: 4px; width: auto;">
                                        <div style="font-weight: 500; font-size: 13px; color: #333; margin-bottom: 4px;">
                                            ${food.foodName || 'ƒ∞simsiz Yemek'}
                                        </div>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                                            ${changeFoodBtn}
                                            ${dbWarningBadge}
                                            ${dbMappingBadge}
                                            ${foodBadgesHtml}
                                            ${tarifBadgesHtml}
                                            ${adminIconHtml}
                                        </div>
                                    </td>
                                    <td style="width: 50px; text-align: center; font-weight: 600; font-size: 12px; padding: 4px 2px;">${Math.round(kalori)}</td>
                                    <td style="width: 45px; text-align: center; font-weight: 600; font-size: 12px; padding: 4px 2px;">${Math.round(karb)}g</td>
                                    <td style="width: 45px; text-align: center; font-weight: 600; font-size: 12px; padding: 4px 2px;">${Math.round(protein)}g</td>
                                    <td style="width: 45px; text-align: center; font-weight: 600; font-size: 12px; padding: 4px 2px;">${Math.round(yag)}g</td>
                                </tr>
                            `;
                        });
                    } else {
                        mealsHtml += `
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">Yemek yok</td>
                            </tr>
                        `;
                    }
                    
                    mealsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }

            // üîê ≈ûablon d√ºzenleme butonu (sadece admin + templateId varsa) - ƒ∞KONƒ∞K VERSƒ∞YON
            const templateEditBtn = (window.isUserAdmin() && day.templateId) 
                ? `<button class="btn-template-edit admin-only" onclick="openTemplateEditModal('${day.templateId}')" title="Admin: Bu ≈üablonu d√ºzenle">
                    ‚úèÔ∏è
                  </button>` 
                : '';
            
            // Bug√ºn√ºn tarihini kontrol et
            const isToday = isTodayDate(day.date);
            const todayClass = isToday ? ' today-highlight' : '';
            
            return `
                <div class="day-card${todayClass}">
                    <div class="day-header">
                        <div class="day-name">${day.gunAdi || 'G√ºn'}${isToday ? ' üìÖ' : ''}</div>
                        <div class="day-date">${formatDate(day.date)}</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${templateEditBtn}
                            <button class="btn-refresh-day" onclick="refreshDayTemplate(${dayIndex})" title="Farklƒ± ≈üablon ile deƒüi≈ütir"></button>
                            <button class="btn-delete-day" onclick="deleteDay(${dayIndex})" title="Bu g√ºn√º sil">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tablo ba≈ülƒ±k bantƒ± -->
                    <div class="day-table-header">
                        <div style="flex: 1;">Yemek</div>
                        <div style="width: 50px;">Kal</div>
                        <div style="width: 45px;">Karb</div>
                        <div style="width: 45px;">Prot</div>
                        <div style="width: 45px;">Yaƒü</div>
                    </div>
                    
                    <!-- G√ºn makrolarƒ± - tek satƒ±r kompakt -->
                    <div class="day-macros-compact">
                        <div style="flex: 1; font-weight: 600;">Toplam</div>
                        <div style="width: 50px; text-align: center;">${Math.round(macros.kalori)}</div>
                        <div style="width: 45px; text-align: center;">${Math.round(macros.karb)}g</div>
                        <div style="width: 45px; text-align: center;">${Math.round(macros.protein)}g</div>
                        <div style="width: 45px; text-align: center;">${Math.round(macros.yag)}g</div>
                    </div>
                    
                    <div class="meals-list">
                        ${mealsHtml}
                    </div>
                </div>
            `;
        }

        // Open Add Day Modal
        function openAddDayModal() {
            // √ñnce hafta dolu mu kontrol et
            const currentWeek = weeks[currentWeekIndex];
            
            // Eƒüer haftada 7 g√ºn varsa yeni hafta a√ß
            if (currentWeek.days.length >= 7) {
                // Yeni hafta bilgilerini hesapla
                const nextWeekNumber = weeks.length + 1;
                const lastWeek = weeks[weeks.length - 1];
                let nextStartDate = new Date();
                
                if (lastWeek && lastWeek.startDate) {
                    nextStartDate = new Date(lastWeek.startDate);
                    nextStartDate.setDate(nextStartDate.getDate() + 7);
                }
                
                // Biti≈ü tarihini hesapla (ba≈ülangƒ±√ß + 6 g√ºn)
                const nextEndDate = new Date(nextStartDate);
                nextEndDate.setDate(nextEndDate.getDate() + 6);
                
                // Tarih formatla (3-9 Kasƒ±m 2025)
                const startDay = nextStartDate.getDate();
                const endDay = nextEndDate.getDate();
                const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                                   'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
                const month = monthNames[nextStartDate.getMonth()];
                const year = nextStartDate.getFullYear();
                
                const dateRange = `${startDay}-${endDay} ${month} ${year}`;
                const message = `Bu haftanƒ±n g√ºnleri tamamlanmƒ±≈ü (7 g√ºn). Yeni bir hafta (${nextWeekNumber}. hafta - ${dateRange}) olu≈üturmak ister misiniz?`;
                
                const confirmNewWeek = confirm(message);
                if (confirmNewWeek) {
                    addNewWeek();
                    // Yeni hafta olu≈üturulduktan sonra modal'ƒ± a√ß
                    setTimeout(() => {
                        openAddDayModalAfterWeekCheck();
                    }, 100);
                    return;
                } else {
                    return; // ƒ∞ptal edildi
                }
            }
            
            openAddDayModalAfterWeekCheck();
        }

        // Hafta kontrol√º sonrasƒ± modal a√ßma
        function openAddDayModalAfterWeekCheck() {
            const modal = document.getElementById('addDayModal');
            modal.classList.add('active');
            modal.style.display = 'flex'; // Modal'ƒ± g√∂r√ºn√ºr yap
            
            // Se√ßimleri sƒ±fƒ±rla
            selectedTemplates = [];
            
            // Akƒ±llƒ± filtreleri sƒ±fƒ±rla
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            if (wantedInput) wantedInput.value = '';
            if (unwantedInput) unwantedInput.value = '';
            
            // Diyet t√ºr√º ve kalori filtrelerini hasta ayarlarƒ±ndan doldur
            initializeDietAndCalorieFilters();

            // Load filtered templates
            loadDayTemplates();
        }
        
        // Diyet t√ºr√º ve kalori filtrelerini ba≈ülat
        function initializeDietAndCalorieFilters() {
            // Diyet t√ºrleri dropdown'unu doldur
            const dietTypeSelect = document.getElementById('templateDietTypeFilter');
            if (dietTypeSelect) {
                // window.diyetTurleri'ni kullan (sabloncu.html ile senkron)
                const diyetTurleri = window.diyetTurleri || [
                    { id: 'eliminasyonlu_ketojenik', name: 'Eliminasyonlu Ketojenik' },
                    { id: 'ketojenik', name: 'Ketojenik' },
                    { id: 'dusuk_karb', name: 'D√º≈ü√ºk Karbonhidrat' },
                    { id: 'akdeniz', name: 'Akdeniz Diyeti' }
                ];
                
                console.log('üîç Diyet t√ºrleri y√ºkleniyor:', diyetTurleri);
                
                // GENEL se√ßeneƒüini en √ºste ekle
                dietTypeSelect.innerHTML = '<option value="">üåê Genel (T√ºm√º)</option>' + 
                    diyetTurleri.map(dt => 
                        `<option value="${dt.id}">${dt.name || dt.ad}</option>`
                    ).join('');
                
                // Default diyet t√ºr√ºn√º belirle: √ñNCE haftanƒ±n diyet t√ºr√º, SONRA hasta ayarƒ±
                let currentDietType = '';
                
                // √ñnce aktif haftanƒ±n diyet t√ºr√ºn√º kontrol et
                const currentWeek = weeks[currentWeekIndex];
                if (currentWeek && currentWeek.dietType) {
                    currentDietType = currentWeek.dietType;
                    console.log('‚úÖ Haftanƒ±n diyet t√ºr√º kullanƒ±lƒ±yor:', currentDietType);
                } else {
                    // Hafta diyet t√ºr√º yoksa hasta ayarƒ±ndan al
                    currentDietType = document.getElementById('dietType')?.value || settings.dietType || 'eliminasyonlu_ketojenik';
                    console.log('‚ÑπÔ∏è Hasta ayarƒ±ndan diyet t√ºr√º alƒ±ndƒ±:', currentDietType);
                }
                
                dietTypeSelect.value = currentDietType;
                
                console.log('‚úÖ Diyet t√ºr√º dropdown dolduruldu, default:', currentDietType);
            }
            
            // Hedef kaloriyi hasta ayarlarƒ±ndan al
            const targetCalInput = document.getElementById('templateTargetCalories');
            if (targetCalInput) {
                const targetCal = parseInt(document.getElementById('targetCalories')?.value) || 
                                parseInt(settings?.targetCalories) || 
                                parseInt(patientData?.settings?.targetCalories) || 
                                1500;
                targetCalInput.value = targetCal;
            }
            
            // Kalori toleransƒ±nƒ± √ñNCE hastadan, SONRA admin settings'den al
            const calorieToleranceInput = document.getElementById('calorieToleranceInput');
            if (calorieToleranceInput) {
                let currentTolerance = null;
                
                // 1. Hasta ayarlarƒ±ndan dene
                if (patientData?.settings?.calorieTolerance) {
                    currentTolerance = parseInt(patientData.settings.calorieTolerance);
                } 
                // 2. Settings modal'dan dene
                else if (document.getElementById('calorieTolerance')?.value) {
                    currentTolerance = parseInt(document.getElementById('calorieTolerance').value);
                }
                // 3. Global settings'den dene
                else if (settings?.calorieTolerance) {
                    currentTolerance = parseInt(settings.calorieTolerance);
                }
                // 4. Admin settings'den al
                else if (window.appSettings?.calorieTolerancePercent) {
                    currentTolerance = parseInt(window.appSettings.calorieTolerancePercent);
                }
                // 5. Default
                else {
                    currentTolerance = 10;
                }
                
                calorieToleranceInput.value = currentTolerance;
            }
            
            // Min-Max kalori deƒüerlerini hesapla ve doldur
            updateCalorieRangeFromTarget();
        }
        
        // Kalori aralƒ±ƒüƒ±nƒ± toleransa g√∂re hesapla ve g√∂ster
        function updateCalorieRange() {
            const targetCalories = parseInt(document.getElementById('targetCalories')?.value) || 
                                 parseInt(document.getElementById('templateTargetCalories')?.value) || 
                                 settings.targetCalories || 1500;
            const tolerance = parseInt(document.getElementById('calorieToleranceInput')?.value) || 10;
            
            const minCalories = Math.round(targetCalories * (1 - tolerance / 100));
            const maxCalories = Math.round(targetCalories * (1 + tolerance / 100));
            
            const minInput = document.getElementById('minCalorieInput');
            const maxInput = document.getElementById('maxCalorieInput');
            
            if (minInput) minInput.value = minCalories;
            if (maxInput) maxInput.value = maxCalories;
        }
        
        // Hedef kaloriden kalori aralƒ±ƒüƒ±nƒ± hesapla
        function updateCalorieRangeFromTarget() {
            const targetInput = document.getElementById('templateTargetCalories');
            const toleranceInput = document.getElementById('calorieToleranceInput');
            
            if (!targetInput || !toleranceInput) return;
            
            const targetCalories = parseInt(targetInput.value) || 1500;
            const tolerance = parseInt(toleranceInput.value) || 10;
            
            const minCalories = Math.round(targetCalories * (1 - tolerance / 100));
            const maxCalories = Math.round(targetCalories * (1 + tolerance / 100));
            
            const minInput = document.getElementById('minCalorieInput');
            const maxInput = document.getElementById('maxCalorieInput');
            
            if (minInput) minInput.value = minCalories;
            if (maxInput) maxInput.value = maxCalories;
            
            // ≈ûablonlarƒ± filtrele
            applyDietAndCalorieFilter();
        }
        
        // Diyet t√ºr√º ve kalori filtrelerini uygula
        function applyDietAndCalorieFilter() {
            // ≈ûablonlarƒ± yeniden y√ºkle (filtreleme loadDayTemplates i√ßinde yapƒ±lƒ±yor)
            loadDayTemplates();
        }
        
        // Kalori toleransƒ±nƒ± hastaya kaydet
        async function saveCalorieToleranceToPatient() {
            const newTolerance = parseInt(document.getElementById('calorieToleranceInput')?.value);
            
            if (!newTolerance || newTolerance < 0 || newTolerance > 50) {
                showToast('‚ö†Ô∏è Ge√ßerli bir tolerans deƒüeri girin (0-50)', 'error');
                return;
            }
            
            // Settings objesini g√ºncelle
            settings.calorieTolerance = newTolerance;
            
            // Hasta verisini g√ºncelle
            if (!patientData.settings) patientData.settings = {};
            patientData.settings.calorieTolerance = newTolerance;
            
            // Settings modal'daki input'u da g√ºncelle
            const settingsToleranceInput = document.getElementById('calorieTolerance');
            if (settingsToleranceInput) {
                settingsToleranceInput.value = newTolerance;
            }
            
            // GitHub'a kaydet
            try {
                await savePatientData();
                showToast('‚úÖ Kalori toleransƒ± kaydedildi: ' + newTolerance + '%', 'success');
                
                // Kalori aralƒ±ƒüƒ±nƒ± yeniden hesapla
                updateCalorieRange();
                
                // ≈ûablonlarƒ± yeniden filtrele
                loadDayTemplates();
            } catch (error) {
                console.error('Kalori toleransƒ± kaydetme hatasƒ±:', error);
                showToast('‚ùå Kalori toleransƒ± kaydedilemedi', 'error');
            }
        }

        // Open Auto Week Plan Modal
        function openAutoWeekPlanModal() {
            // Hafta numarasƒ±nƒ± al
            const weekNumber = (activeWeekIndex >= 0 && activeWeekIndex < weeks.length) 
                ? weeks[activeWeekIndex].weekNumber 
                : (currentWeekIndex + 1);
            
            // Label'ƒ± g√ºncelle
            const autoPlanDietTypeLabel = document.getElementById('autoPlanDietTypeLabel');
            if (autoPlanDietTypeLabel) {
                autoPlanDietTypeLabel.innerHTML = `Diyet Tipi <span style="color: #999; font-size: 11px; font-weight: normal;">(${weekNumber}. hafta i√ßin)</span>`;
            }
            
            // Hasta bilgilerini FORM inputlarƒ±ndan al (settings modal'daki veriler)
            const weightInput = document.getElementById('patientWeight');
            const heightInput = document.getElementById('patientHeight');
            const activityInput = document.getElementById('activityLevel');
            const dislikedFoodsInput = document.getElementById('dislikedFoods');
            
            // Hasta kayƒ±t bilgilerinden de al
            const personalInfo = patientData?.personalInfo || {};
            
            // Aktif haftanƒ±n diyet t√ºr√ºn√º al - √ñNCELƒ∞K BURADA!
            let smartDietType = 'ketojenik'; // Varsayƒ±lan
            if (weeks && weeks.length > 0 && activeWeekIndex >= 0 && activeWeekIndex < weeks.length) {
                const activeWeek = weeks[activeWeekIndex];
                if (activeWeek.dietType) {
                    // Haftanƒ±n kendi diyet t√ºr√º varsa onu kullan
                    smartDietType = activeWeek.dietType;
                } else if (activeWeek.weekNumber) {
                    // Hafta numarasƒ±na g√∂re akƒ±llƒ± default
                    smartDietType = getDefaultDietTypeForWeek(activeWeek.weekNumber);
                }
            }
            
            console.log('üéØ Otomatik Plan - Akƒ±llƒ± diyet t√ºr√º:', smartDietType, '(Hafta:', weekNumber, ')');
            
            // Hafta bazƒ±nda kayƒ±tlƒ± ayarlarƒ± kontrol et (varsa y√ºkle)
            const weekSettings = patientData?.weekSettings?.[weekNumber] || null;
            
            if (weekSettings) {
                console.log('üíæ Hafta ayarlarƒ± bulundu, y√ºkleniyor:', weekSettings);
                // Kayƒ±tlƒ± ayarlarƒ± kullan
                document.getElementById('autoPlanWeight').value = weekSettings.weight || personalInfo.weight || 70;
                document.getElementById('autoPlanTargetWeight').value = weekSettings.targetWeight || '';
                document.getElementById('autoPlanHeight').value = weekSettings.height || personalInfo.height || 170;
                document.getElementById('autoPlanActivity').value = weekSettings.activity || 3;
                document.getElementById('autoPlanGoalPct').value = weekSettings.goalPct || 0;
                document.getElementById('autoPlanDietType').value = weekSettings.dietType || smartDietType;
                document.getElementById('autoPlanDislikedFoods').value = weekSettings.dislikedFoods?.join(', ') || '';
            } else {
                console.log('‚ÑπÔ∏è Hafta ayarlarƒ± bulunamadƒ±, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor');
                // Modal'a doldur (√∂ncelik: personalInfo > varsayƒ±lan)
                document.getElementById('autoPlanWeight').value = weightInput?.value || personalInfo.weight || 70;
                document.getElementById('autoPlanTargetWeight').value = personalInfo.targetWeight || '';
                document.getElementById('autoPlanHeight').value = heightInput?.value || personalInfo.height || 170;
                document.getElementById('autoPlanActivity').value = activityInput?.value || personalInfo.activityLevel || settings.activityLevel || '3';
                document.getElementById('autoPlanGoalPct').value = '0'; // Varsayƒ±lan: s√ºrd√ºrme
                document.getElementById('autoPlanDietType').value = smartDietType;
                document.getElementById('autoPlanDislikedFoods').value = dislikedFoodsInput?.value || (settings.dislikedFoods || []).join(', ');
            }
            
            // Hedef kaloriyi hesapla ve g√∂ster
            updateAutoPlanCalories();
            
            // Modal'ƒ± a√ß
            document.getElementById('autoWeekPlanModal').classList.add('active');
            document.getElementById('autoWeekPlanModal').style.display = 'flex';
        }

        // Kilo Projeksiyonu Hesaplama Fonksiyonu (sabloncu.html'den uyarlandƒ±)
        function computeWeightLossPlan(startWeight, targetWeight, options = {}) {
            const maxWeeks = options.maxWeeks ?? 200;
            const tolerance = options.tolerance ?? 0.05;
            const decimals = options.decimals ?? 2;
            const baseRate = Math.max(0.0001, options.baseRate ?? 0.01); // %1 default haftalƒ±k kayƒ±p
            const round = (num) => Number.isFinite(num) ? Number(num.toFixed(decimals)) : num;
            
            const activityLevel = Number.isFinite(options.activityLevel) ? Math.round(options.activityLevel) : null;
            const activityMap = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };
            let activityMultiplier = Number.isFinite(options.activityMultiplier) 
                ? options.activityMultiplier 
                : (activityMap[activityLevel] ?? 1.0);
            
            if (!Number.isFinite(activityMultiplier) || activityMultiplier <= 0) activityMultiplier = 1.0;
            activityMultiplier = Math.min(Math.max(activityMultiplier, 0.3), 2.5);
            
            const rawGoalPct = Number.isFinite(options.goalPct) ? options.goalPct : 0;
            const goalAdjustmentFactor = 1 + (rawGoalPct / 100);
            const safeGoalAdjustment = goalAdjustmentFactor > 0 ? goalAdjustmentFactor : 0.1;
            
            const result = {
                valid: false,
                reason: null,
                weeks: 0,
                plan: [],
                totalLoss: 0,
                finalWeight: Number.isFinite(targetWeight) ? round(targetWeight) : null,
                reached: false,
                meta: {
                    baseRate,
                    activityLevel: activityLevel ?? null,
                    activityMultiplier,
                    goalPct: rawGoalPct,
                    goalAdjustment: safeGoalAdjustment,
                    weeklyPercent: null
                }
            };
            
            if (!Number.isFinite(startWeight) || startWeight <= 0) {
                result.reason = 'invalid-start';
                return result;
            }
            if (!Number.isFinite(targetWeight) || targetWeight <= 0) {
                result.reason = 'invalid-target';
                return result;
            }
            if (targetWeight >= startWeight - tolerance) {
                result.reason = 'no-loss';
                result.valid = true;
                result.finalWeight = round(startWeight);
                result.totalLoss = 0;
                return result;
            }

            const effectiveBaseRate = Math.min(Math.max(baseRate * activityMultiplier, 0.0005), 0.25);
            const baseRetention = 1 - effectiveBaseRate;
            let baseWeeksEstimate = Math.log(targetWeight / startWeight) / Math.log(baseRetention);
            
            if (!Number.isFinite(baseWeeksEstimate) || baseWeeksEstimate <= 0) {
                baseWeeksEstimate = Math.abs((startWeight - targetWeight) / (startWeight * effectiveBaseRate));
            }
            
            const adjustedWeeksEstimate = Math.max(baseWeeksEstimate * safeGoalAdjustment, 1);
            let desiredWeeks = Math.min(maxWeeks, Math.max(1, Math.round(adjustedWeeksEstimate)));
            if (desiredWeeks === 0) desiredWeeks = 1;
            
            if (Math.round(adjustedWeeksEstimate) > maxWeeks) {
                result.reason = 'max-weeks';
            }
            
            const retentionPerWeek = Math.pow(targetWeight / startWeight, 1 / desiredWeeks);
            const effectiveRate = 1 - retentionPerWeek;
            const weeklyPercent = Math.max(0, effectiveRate * 100);
            
            result.meta.weeklyPercent = weeklyPercent;

            let prev = startWeight;
            for (let week = 1; week <= desiredWeeks; week++) {
                let next = prev * retentionPerWeek;
                const remainingWeeks = desiredWeeks - week;
                if (remainingWeeks <= 0 || next <= targetWeight + tolerance) {
                    next = targetWeight;
                }
                const weeklyLoss = prev - next;
                result.plan.push({
                    week,
                    weight: round(next),
                    weeklyLoss: round(weeklyLoss),
                    cumulativeLoss: round(startWeight - next)
                });
                prev = next;
            }
            
            result.weeks = result.plan.length;
            result.totalLoss = round(startWeight - prev);
            result.finalWeight = round(prev);
            result.valid = true;
            
            if (Math.abs(prev - targetWeight) <= tolerance) {
                result.reached = true;
            }
            
            return result;
        }

        // Hedef kaloriyi hesapla ve g√∂ster
        function updateAutoPlanCalories() {
            const weight = parseFloat(document.getElementById('autoPlanWeight').value) || 70;
            const targetWeight = parseFloat(document.getElementById('autoPlanTargetWeight').value) || 0;
            const height = parseFloat(document.getElementById('autoPlanHeight').value) || 170;
            const activity = parseInt(document.getElementById('autoPlanActivity').value) || 3;
            const dietType = document.getElementById('autoPlanDietType').value || 'ketojenik';
            const goalPct = parseInt(document.getElementById('autoPlanGoalPct').value) || 0;
            
            console.log('üìä Kalori Hesaplama:', { weight, targetWeight, height, activity, dietType, goalPct });
            
            // Admin settings'i localStorage'dan √ßek veya GitHub'dan y√ºkle
            let adminSettings = null;
            try {
                const settingsStr = localStorage.getItem('app_settings');
                if (settingsStr) {
                    adminSettings = JSON.parse(settingsStr);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Admin settings y√ºklenemedi, varsayƒ±lan form√ºl kullanƒ±lacak');
            }
            
            // Diyet form√ºl√ºn√º admin_settings'ten al, yoksa varsayƒ±lan
            const dietFormulas = adminSettings?.dietFormulas || {
                ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                akdeniz: { carb: 0.6, protein: 0.8, fat: 1.0 }
            };
            
            // Aktivite √ßarpanƒ± (admin_settings'ten al, yoksa varsayƒ±lan)
            const activityMultipliers = adminSettings?.dietFormulas?.activityMultipliers || {
                1: 0.8,  // Hareketsiz
                2: 0.9,  // Az Aktif
                3: 1.0,  // Orta Aktif
                4: 1.1,  // √áok Aktif
                5: 1.2   // S√ºper Aktif
            };
            
            const activityMultiplier = activityMultipliers[activity] || 1.0;
            
            // Diyet tipine g√∂re form√ºl se√ß
            // 1. eliminasyonlu_ veya eliminasyonlu- √∂nekini kaldƒ±r
            // 2. dusuk_karb ‚Üí lowcarb, akdeniz ‚Üí lowcarb normalize et
            let normalizedDietType = dietType.replace('eliminasyonlu_', '').replace('eliminasyonlu-', '');
            if (normalizedDietType === 'dusuk_karb') {
                normalizedDietType = 'lowcarb';
            } else if (normalizedDietType === 'akdeniz') {
                normalizedDietType = 'lowcarb'; // Akdeniz diyeti lowcarb ile aynƒ± form√ºl√º kullanƒ±r
            }
            
            const dietFormula = dietFormulas[normalizedDietType] || dietFormulas.ketojenik;
            
            console.log('üîç Diyet se√ßimi:', { dietType, normalizedDietType, formula: dietFormula });
            
            // Hedef y√ºzdesi ile kalori ayarlamasƒ± (goalPct: -30 ile +20 arasƒ±)
            const goalMultiplier = 1 + (goalPct / 100);
            
            console.log('‚öôÔ∏è Form√ºl:', { activityMultiplier, dietFormula, goalMultiplier });
            
            // Aktivite √ßarpanƒ± + hedef y√ºzdesi ile makro hesaplama
            const protein = Math.round(weight * dietFormula.protein * activityMultiplier * goalMultiplier);
            const carb = Math.round(weight * dietFormula.carb * activityMultiplier * goalMultiplier);
            const fat = Math.round(weight * dietFormula.fat * activityMultiplier * goalMultiplier);
            
            // Kalori hesaplama: (P*4) + (K*4) + (Y*9)
            const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            
            console.log('üéØ Hedef:', { protein, carb, fat, targetCalories });
                
                // Kalori ve makrolarƒ± g√∂ster
                document.getElementById('autoPlanTargetCalories').textContent = targetCalories + ' kcal';
                document.getElementById('autoPlanProtein').textContent = protein + 'g';
                document.getElementById('autoPlanCarb').textContent = carb + 'g';
                document.getElementById('autoPlanFat').textContent = fat + 'g';
            
            // Kilo Projeksiyonu Hesaplama ve G√∂sterme
            const projectionContainer = document.getElementById('weightProjectionContainer');
            const summaryEl = document.getElementById('weightProjectionSummary');
            const listEl = document.getElementById('weightProjectionList');
            
            if (weight > 0 && targetWeight > 0 && targetWeight < weight) {
                // Projeksiyon hesapla
                const plan = computeWeightLossPlan(weight, targetWeight, {
                    activityLevel: activity,
                    goalPct: goalPct,
                    maxWeeks: 52 // Maksimum 1 yƒ±l g√∂ster
                });
                
                if (plan.valid && plan.weeks > 0) {
                    const weeksText = plan.weeks === 1 ? '1 hafta' : `${plan.weeks} hafta`;
                    
                    summaryEl.innerHTML = 
                        `<strong>Ba≈ülangƒ±√ß:</strong> ${weight.toFixed(1)} kg ‚Üí <strong>Hedef:</strong> ${targetWeight.toFixed(1)} kg<br>` +
                        `<strong>Tahmini S√ºre:</strong> ${weeksText} ¬∑ <strong>Toplam Kayƒ±p:</strong> ${plan.totalLoss.toFixed(1)} kg`;
                    
                    // ƒ∞lk 10 haftayƒ± detaylƒ± g√∂ster
                    const maxDisplay = Math.min(10, plan.plan.length);
                    let listHTML = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">';
                    
                    for (let i = 0; i < maxDisplay; i++) {
                        const item = plan.plan[i];
                        listHTML += `
                            <div style="padding: 4px 6px; background: ${i % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 3px;">
                                <span style="font-weight: 600;">${item.week}. hafta:</span> ${item.weight.toFixed(1)} kg
                            </div>
                        `;
                    }
                    
                    listHTML += '</div>';
                    
                    if (plan.plan.length > maxDisplay) {
                        const last = plan.plan[plan.plan.length - 1];
                        listHTML += `<div style="margin-top: 6px; font-size: 10px; color: #888; text-align: center;">... ${plan.plan.length}. haftada ${last.weight.toFixed(1)} kg</div>`;
                    }
                    
                    listEl.innerHTML = listHTML;
                    projectionContainer.style.display = 'block';
                } else {
                    projectionContainer.style.display = 'none';
                }
            } else {
                projectionContainer.style.display = 'none';
            }
        }

        // Otomatik haftalƒ±k plan olu≈ütur
        async function generateAutoWeekPlan() {
            // üóìÔ∏è G√úN ADLARƒ± (Fonksiyon genelinde kullanƒ±lacak)
            const gunAdlari = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
            
            const weight = parseFloat(document.getElementById('autoPlanWeight').value);
            const targetWeight = parseFloat(document.getElementById('autoPlanTargetWeight').value) || 0;
            const height = parseFloat(document.getElementById('autoPlanHeight').value);
            const activity = parseInt(document.getElementById('autoPlanActivity').value);
            const dietType = document.getElementById('autoPlanDietType').value;
            const goalPct = parseInt(document.getElementById('autoPlanGoalPct').value) || 0;
            const dislikedFoods = document.getElementById('autoPlanDislikedFoods').value
                .split(',')
                .map(f => f.trim())
                .filter(f => f.length > 0);
            
            // Hafta numarasƒ±nƒ± al
            const weekNumber = (activeWeekIndex >= 0 && activeWeekIndex < weeks.length) 
                ? weeks[activeWeekIndex].weekNumber 
                : (currentWeekIndex + 1);
            
            // Hafta ayarlarƒ±nƒ± kaydet (weekSettings objesi)
            if (!patientData.weekSettings) {
                patientData.weekSettings = {};
            }
            
            // Hedef kaloriyi admin settings form√ºl√ºyle hesapla (goalPct dahil)
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activity] || 1.0;
            const dietFormula = appSettings?.dietFormulas?.[dietType] || appSettings?.dietFormulas?.ketojenik;
            const goalMultiplier = 1 + (goalPct / 100);
            
            let targetCalories, calculatedMacros;
            if (dietFormula) {
                // Aktivite √ßarpanƒ± + hedef y√ºzdesi dahil
                const protein = weight * dietFormula.protein * activityMultiplier * goalMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier * goalMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier * goalMultiplier;
                targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
                calculatedMacros = {
                    protein: Math.round(protein),
                    carb: Math.round(carb),
                    fat: Math.round(fat)
                };
            } else {
                targetCalories = Math.round(weight * 22 * activityMultiplier * goalMultiplier);
                calculatedMacros = null;
            }
            
            // Kilo projeksiyonu hesapla (varsa)
            let weightProjection = null;
            if (targetWeight > 0 && targetWeight < weight) {
                const plan = computeWeightLossPlan(weight, targetWeight, {
                    activityLevel: activity,
                    goalPct: goalPct,
                    maxWeeks: 52
                });
                if (plan.valid && plan.weeks > 0) {
                    weightProjection = {
                        estimatedWeeks: plan.weeks,
                        totalLoss: plan.totalLoss,
                        weeklyAverage: (plan.totalLoss / plan.weeks).toFixed(2),
                        weeklyPercent: plan.meta.weeklyPercent.toFixed(2)
                    };
                }
            }
            
            patientData.weekSettings[weekNumber] = {
                // Kullanƒ±cƒ± girdileri
                weight: weight,
                targetWeight: targetWeight,
                height: height,
                activity: activity,
                dietType: dietType,
                goalPct: goalPct,
                dislikedFoods: dislikedFoods,
                
                // Hesaplanan deƒüerler (analiz i√ßin)
                calculated: {
                    targetCalories: targetCalories,
                    macros: calculatedMacros,
                    projection: weightProjection
                },
                
                // Metadata
                savedAt: new Date().toISOString(),
                updatedBy: 'patient' // veya 'admin' (role'e g√∂re)
            };
            
            console.log('üíæ Hafta ayarlarƒ± kaydedildi:', patientData.weekSettings[weekNumber]);
            
            console.log('üéØ Hedef Kalori:', targetCalories, '(GoalPct:', goalPct + '%)');
            console.log('üìä Toplam ≈ûablon:', dayTemplates.length);
            
            // üîç Mevcut haftada manuel eklenmi≈ü g√ºnleri kontrol et
            const currentWeek = weeks[currentWeekIndex];
            const existingDays = currentWeek.days || [];
            
            if (existingDays.length > 0) {
                // Manuel g√ºnler var - kullanƒ±cƒ±ya sor
                const lastDay = existingDays[existingDays.length - 1];
                const lastDate = new Date(lastDay.date);
                const dayNames = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
                const lastDayName = dayNames[lastDate.getDay()];
                
                const confirmMessage = `üìÖ Bu haftada ${existingDays.length} g√ºn manuel eklenmi≈ü (Son: ${lastDayName}).\n\n` +
                    `üîÑ T√ºm haftayƒ± yeniden planlayayƒ±m mƒ±?\n` +
                    `   (Mevcut g√ºnler silinir, 7 g√ºnl√ºk yeni plan olu≈üturulur)\n\n` +
                    `‚úÖ Sadece eksik g√ºnleri tamamlayayƒ±m mƒ±?\n` +
                    `   (${lastDayName} sonrasƒ± Pazar'a kadar olan g√ºnler eklenir)\n\n` +
                    `"OK" = Yeniden Planla | "ƒ∞ptal" = Eksik G√ºnleri Tamamla`;
                
                const shouldReset = confirm(confirmMessage);
                
                if (shouldReset) {
                    // Yeniden planlama - mevcut g√ºnleri temizle
                    console.log('üîÑ Hafta yeniden planlanƒ±yor - mevcut g√ºnler temizleniyor...');
                    currentWeek.days = [];
                } else {
                    // Eksik g√ºnleri tamamlama
                    console.log('‚úÖ Eksik g√ºnler tamamlanƒ±yor...');
                }
            }
            
            // Son N haftada kullanƒ±lan ≈üablonlarƒ± topla (N = admin ayarlarƒ±ndan)
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            // Mevcut hafta dahil, son N haftayƒ± kontrol et
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(day => {
                        if (day.templateId) {
                            recentlyUsedTemplateIds.add(day.templateId);
                        }
                    });
                }
            }
            
            console.log(`üìÖ Son ${templateReuseWeeks} haftada kullanƒ±lan ≈üablon sayƒ±sƒ±: ${recentlyUsedTemplateIds.size}`);
            
            // Diyet t√ºr√ºn√º normalize et (hem _ hem - destekle, akƒ±llƒ± e≈üle≈ütirme)
            const normalizeDietType = (dt) => {
                if (!dt) return '';
                const lower = dt.toLowerCase().replace(/[_-]/g, ''); // alt √ßizgi ve tire kaldƒ±r
                
                // Ketojenik varyantlarƒ±
                if (lower.includes('eliminasyonlu') && lower.includes('keto')) return 'eliminasyonlu_ketojenik';
                if (lower.includes('keto')) return 'ketojenik';
                
                // D√º≈ü√ºk karb varyantlarƒ± (dusuk_carb, dusuk_karb, lowcarb hepsi aynƒ±)
                if (lower.includes('dusuk') || lower.includes('d√º≈ü√ºk') || lower === 'lowcarb' || lower.includes('carb') || lower.includes('karb')) return 'dusuk_karb';
                
                // Akdeniz
                if (lower.includes('akdeniz') || lower.includes('mediterranean')) return 'akdeniz';
                
                return dt.toLowerCase().replace(/[-]/g, '_'); // Fallback: tire -> alt √ßizgi
            };
            const normalizedDietType = normalizeDietType(dietType);
            
            console.log(`üîç Se√ßili diyet t√ºr√º: "${dietType}" ‚Üí normalize: "${normalizedDietType}"`);
            
            // ≈ûablonlarƒ± filtrele
            // Diyet t√ºr√º uyumluluk matrisi:
            // - eliminasyonlu_ketojenik: SADECE eliminasyonlu ketojenik ≈üablonlar
            // - ketojenik: SADECE ketojenik ≈üablonlar
            // - dusuk_karb: SADECE d√º≈ü√ºk karbonhidratlƒ± ≈üablonlar
            // - akdeniz: SADECE akdeniz ≈üablonlar
            const compatibilityMap = {
                'eliminasyonlu_ketojenik': ['eliminasyonlu_ketojenik'],
                'ketojenik': ['ketojenik'],
                'dusuk_karb': ['dusuk_karb', 'dusuk_carb', 'lowcarb'], // √áe≈üitli yazƒ±m varyantlarƒ±
                'akdeniz': ['akdeniz', 'mediterranean']
            };
            const allowedDietTypes = compatibilityMap[normalizedDietType] || [normalizedDietType];
            
            console.log(`üçΩÔ∏è Se√ßili diyet: ${normalizedDietType}, Uyumlu diyet t√ºrleri: ${allowedDietTypes.join(', ')}`);
            
            let availableTemplates = dayTemplates.filter(template => {
                // Son N haftada kullanƒ±lmƒ±≈ü mƒ±?
                if (recentlyUsedTemplateIds.has(template.id)) {
                    return false;
                }
                
                // Diyet tipi kontrol√º - SADECE se√ßili diyet tipine uygun ≈üablonlar
                if (template.dietType) {
                    const normalizedTemplateDiet = normalizeDietType(template.dietType);
                    if (!allowedDietTypes.includes(normalizedTemplateDiet)) {
                        console.log(`‚ùå ≈ûablon atlandƒ±: "${template.name || template.id}" (≈ûablon diyet: ${template.dietType} ‚Üí ${normalizedTemplateDiet}, ƒ∞stenen: ${allowedDietTypes.join(', ')})`);
                        return false;
                    }
                } else {
                    // Diyet tipi belirtilmemi≈ü ≈üablonlarƒ± atla
                    console.log(`‚ö†Ô∏è ≈ûablon atlandƒ±: "${template.name || template.id}" (Diyet tipi yok)`);
                    return false;
                }
                
                // ƒ∞stenmeyen yemekler - sadece varsa kontrol et
                if (dislikedFoods.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => {
                            const foodName = yemek.foodName || yemek.originalText || '';
                            return dislikedFoods.some(disliked => 
                                foodName.toLowerCase().includes(disliked.toLowerCase())
                            );
                        })
                    );
                    if (hasDislikedFood) return false;
                }
                
                return true;
            });
            
            console.log(`‚úÖ Filtrelenmi≈ü ≈ûablon (Son ${templateReuseWeeks} hafta hari√ß):`, availableTemplates.length);
            
            // Eƒüer kullanƒ±labilir ≈üablon kalmadƒ±ysa, t√ºm ≈üablonlarƒ± kullan (ba≈üa d√∂n)
            if (availableTemplates.length === 0) {
                console.log('‚ö†Ô∏è Kullanƒ±lmamƒ±≈ü ≈üablon kalmadƒ±, t√ºm ≈üablonlarƒ± kullanƒ±ma a√ßƒ±yoruz...');
                
                availableTemplates = dayTemplates.filter(template => {
                    // Sadece diyet tipi ve istenmeyen yemek kontrol√º
                    if (template.dietType) {
                        const normalizedTemplateDiet = normalizeDietType(template.dietType);
                        if (!allowedDietTypes.includes(normalizedTemplateDiet)) {
                            return false;
                        }
                    } else {
                        // Diyet tipi belirtilmemi≈ü ≈üablonlarƒ± atla
                        return false;
                    }
                    
                    if (dislikedFoods.length > 0 && template.ogunler) {
                        const hasDislikedFood = template.ogunler.some(ogun => 
                            ogun.yemekler && ogun.yemekler.some(yemek => {
                                const foodName = yemek.foodName || yemek.originalText || '';
                                return dislikedFoods.some(disliked => 
                                    foodName.toLowerCase().includes(disliked.toLowerCase())
                                );
                            })
                        );
                        if (hasDislikedFood) return false;
                    }
                    
                    return true;
                });
                
                console.log(`‚úÖ T√ºm uygun ≈üablonlar (${normalizedDietType}): ${availableTemplates.length}`);
                
                if (availableTemplates.length === 0) {
                    showToast(`‚ö†Ô∏è "${dietType}" diyet tipi i√ßin uygun men√º bulunamadƒ±. L√ºtfen ba≈üka bir diyet tipi se√ßin veya ≈üablon ar≈üivinde "${dietType}" ≈üablonlarƒ± ekleyin.`, 'error');
                    return;
                }
            } else {
                console.log(`‚úÖ Kullanƒ±labilir ≈üablon sayƒ±sƒ± (${normalizedDietType}, son ${appSettings?.templateReuseWeeks || 4} hafta hari√ß): ${availableTemplates.length}`);
            }
            
            // ‚ú® GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û KADEMELI MUTLAK DEƒûER ARTI≈ûLI SIRALAMA ‚ú®
            // Hedef: -10, +20, +25, -30, +35, +50, -55 ≈üeklinde kademeli artƒ±≈ü
            // Yani mutlak deƒüer olarak fark k√º√ß√ºkten b√ºy√ºƒüe, ama pozitif/negatif alternatifli
            
            // 1. Her ≈üablonun fark bilgilerini hesapla
            const templatesWithDiff = availableTemplates.map(template => {
                const kalori = template.totalMacros?.kalori || 0;
                const diff = kalori - targetCalories; // Pozitif: hedefin √ºst√ºnde, Negatif: hedefin altƒ±nda
                const absDiff = Math.abs(diff);
                return {
                    template: template,
                    diff: diff,
                    absDiff: absDiff,
                    kalori: kalori
                };
            });
            
            // 2. Hedefin altƒ± ve √ºst√º olarak ayƒ±r
            const belowTarget = templatesWithDiff.filter(t => t.diff < 0).sort((a, b) => a.absDiff - b.absDiff);
            const aboveTarget = templatesWithDiff.filter(t => t.diff >= 0).sort((a, b) => a.absDiff - b.absDiff);
            
            console.log(`üìä Hedefin altƒ±: ${belowTarget.length} ≈üablon (${belowTarget.slice(0,3).map(t => `${t.diff}kcal`).join(', ')}...)`);
            console.log(`üìä Hedefin √ºst√º: ${aboveTarget.length} ≈üablon (${aboveTarget.slice(0,3).map(t => `+${t.diff}kcal`).join(', ')}...)`);
            
            // 3. Zigzag birle≈ütirme - mutlak deƒüer artan ≈üekilde, alternatifli
            const zigzagSorted = [];
            let belowIndex = 0, aboveIndex = 0;
            let preferBelow = belowTarget.length > 0; // ƒ∞lk √∂ncelik negatif olana
            
            while (belowIndex < belowTarget.length || aboveIndex < aboveTarget.length) {
                if (preferBelow && belowIndex < belowTarget.length) {
                    zigzagSorted.push(belowTarget[belowIndex]);
                    belowIndex++;
                    preferBelow = false; // Sonraki sefere pozitif
                } else if (!preferBelow && aboveIndex < aboveTarget.length) {
                    zigzagSorted.push(aboveTarget[aboveIndex]);
                    aboveIndex++;
                    preferBelow = true; // Sonraki sefere negatif
                } else if (belowIndex < belowTarget.length) {
                    // Pozitif kalmadƒ±, negatif ekle
                    zigzagSorted.push(belowTarget[belowIndex]);
                    belowIndex++;
                } else {
                    // Negatif kalmadƒ±, pozitif ekle
                    zigzagSorted.push(aboveTarget[aboveIndex]);
                    aboveIndex++;
                }
            }
            
            // 4. Sonu√ß listesine aktar
            availableTemplates = zigzagSorted.map(item => item.template);
            
            console.log('‚ú® KADEMELI ZIGZAG SIRALAMA:');
            availableTemplates.slice(0, Math.min(10, availableTemplates.length)).forEach((t, i) => {
                const diff = (t.totalMacros?.kalori || 0) - targetCalories;
                const sign = diff >= 0 ? '+' : '';
                console.log(`  ${i+1}. ${t.name}: ${sign}${diff} kcal (hedef: ${targetCalories})`);
            });
            
            // üìÖ YENƒ∞ TAKVIM MANTIGI: Pazartesi-Pazar Sistemi
            // (gunAdlari zaten fonksiyon ba≈üƒ±nda tanƒ±mlƒ±)
            
            // Ba≈ülangƒ±√ß tarihini belirle
            let startDate = new Date();
            
            if (existingDays.length > 0) {
                // Mevcut g√ºnler var - √ñNCE EKSƒ∞K G√úNLERƒ∞ DOLDUR
                // Mevcut g√ºnlerin tarihlerini map'le
                const existingDates = new Set(existingDays.map(d => d.date));
                
                // Pazartesi-Pazar haftasƒ±nƒ± belirle (ilk g√ºn√ºn tarihinden)
                const firstDayDate = new Date(existingDays[0].date);
                const firstDayOfWeek = firstDayDate.getDay(); // 0=Pazar, 1=Pazartesi
                
                // Pazartesi'ye git (geriye doƒüru)
                const weekStart = new Date(firstDayDate);
                const daysToMonday = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // Pazar'daysa 6 g√ºn geriye
                weekStart.setDate(weekStart.getDate() - daysToMonday);
                
                console.log('üìÖ Hafta ba≈ülangƒ±cƒ± (Pazartesi):', weekStart.toLocaleDateString('tr-TR'));
                
                // Eksik g√ºnleri bul (Pazartesi-Pazar arasƒ±)
                const missingDays = [];
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date(weekStart);
                    checkDate.setDate(checkDate.getDate() + i);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    if (!existingDates.has(dateStr)) {
                        missingDays.push({
                            date: dateStr,
                            dayName: gunAdlari[checkDate.getDay()],
                            dayIndex: i
                        });
                    }
                }
                
                if (missingDays.length > 0) {
                    console.log(`üîç Eksik g√ºnler bulundu (${missingDays.length}):`, missingDays.map(d => d.dayName).join(', '));
                    
                    // ƒ∞lk eksik g√ºnden ba≈üla
                    startDate = new Date(missingDays[0].date);
                    var totalDays = missingDays.length;
                    var fillMissingDays = true; // Eksik g√ºnleri dolduruyoruz flag'i
                } else {
                    // Hafta tamam - yeni hafta ba≈ülat
                    console.log('‚úÖ Mevcut hafta tam (Pazartesi-Pazar), yeni hafta ba≈ülatƒ±lacak');
                    
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6); // Pazar
                    
                    startDate = new Date(weekEnd);
                    startDate.setDate(startDate.getDate() + 1); // Pazartesi (yeni hafta)
                    
                    var totalDays = 7; // Tam yeni hafta
                    var fillMissingDays = false;
                }
            } else {
                // Hafta bo≈ü - bug√ºnden ba≈üla
                const today = new Date();
                const todayDayOfWeek = today.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
                
                console.log('üìÖ Bug√ºn:', today.toLocaleDateString('tr-TR'), '-', gunAdlari[todayDayOfWeek]);
                
                if (todayDayOfWeek === 1) {
                    // Pazartesi - sadece 7 g√ºn
                    startDate = today;
                    var totalDays = 7;
                    console.log('‚úÖ Pazartesi ba≈ülangƒ±cƒ± - 7 g√ºn eklenecek (Pazartesi ‚Üí Pazar)');
                } else {
                    // Diƒüer g√ºnler - bir sonraki Pazar'a kadar + 7 g√ºn
                    startDate = today;
                    
                    // Pazar'a kadar ka√ß g√ºn var?
                    const daysUntilSunday = todayDayOfWeek === 0 ? 0 : 7 - todayDayOfWeek;
                    var totalDays = daysUntilSunday + 7; // Bu haftanƒ±n kalanƒ± + tam yeni hafta
                    
                    console.log(`‚úÖ ${gunAdlari[todayDayOfWeek]} ba≈ülangƒ±cƒ± - ${daysUntilSunday} + 7 = ${totalDays} g√ºn eklenecek (${gunAdlari[todayDayOfWeek]} ‚Üí Pazar + Pazartesi ‚Üí Pazar)`);
                }
                var fillMissingDays = false;
            }
            
            console.log('üìä Eklenecek G√ºn Sayƒ±sƒ±:', totalDays);
            console.log('üìÖ Ba≈ülangƒ±√ß Tarihi:', startDate.toLocaleDateString('tr-TR'), '-', gunAdlari[startDate.getDay()]);
            
            if (totalDays === 0) {
                showToast('‚úÖ Hafta zaten tamamlanmƒ±≈ü!', 'success');
                return;
            }
            
            // üöÄ LAZY LOADING: Se√ßilen ≈üablonlarƒ±n tam verilerini y√ºkle
            // availableTemplates ≈üu an sadece metadata i√ßeriyor (id, name, dietType, totalMacros, filename)
            // Ger√ßek ogunler ve foods verisi i√ßin full template'leri y√ºklemeliyiz
            
            // Check if TemplateManager is available (new system)
            if (typeof TemplateManager !== 'undefined' && availableTemplates.length > 0 && availableTemplates[0].filename) {
                console.log('‚è≥ Se√ßilen ≈üablonlar y√ºkleniyor (YENƒ∞ Sƒ∞STEM - Lazy Loading)...');
                showToast('‚è≥ Men√ºler y√ºkleniyor...', 'info');
                
                const selectedTemplateFilenames = availableTemplates.slice(0, totalDays).map(t => t.filename);
                console.log('üì• Y√ºklenecek dosyalar:', selectedTemplateFilenames);
                
                try {
                    // Paralel y√ºkleme - 7 template'i aynƒ± anda y√ºkle (hƒ±zlƒ±!)
                    const fullTemplates = await TemplateManager.loadTemplates(selectedTemplateFilenames);
                    console.log('‚úÖ Tam ≈üablonlar y√ºklendi:', fullTemplates.length);
                    
                    // availableTemplates'i full data ile deƒüi≈ütir
                    availableTemplates = fullTemplates;
                } catch (error) {
                    console.error('‚ùå ≈ûablonlar y√ºklenirken hata:', error);
                    showToast('‚ùå Men√ºler y√ºklenemedi: ' + error.message, 'error');
                    return;
                }
            } else {
                // ESKƒ∞ Sƒ∞STEM: ≈ûablonlar zaten tam veri ile y√ºkl√º (fallback)
                console.log('‚úÖ ≈ûablonlar zaten y√ºkl√º (ESKƒ∞ Sƒ∞STEM - Full Data)');
            }
            
            // G√ºnleri olu≈ütur
            // (gunAdlari zaten fonksiyon ba≈üƒ±nda tanƒ±mlƒ±)
            const newDays = [];
            for (let i = 0; i < totalDays && i < availableTemplates.length; i++) {
                const template = availableTemplates[i];
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + i);
                
                // ≈ûablon verilerini tam olarak kopyala
                const dayData = {
                    date: dayDate.toISOString().split('T')[0],
                    gunAdi: gunAdlari[dayDate.getDay()],
                    templateId: template.id,
                    templateName: template.name,
                    meals: template.ogunler ? JSON.parse(JSON.stringify(template.ogunler)) : [],
                    totalMacros: template.totalMacros ? JSON.parse(JSON.stringify(template.totalMacros)) : {
                        kalori: 0,
                        protein: 0,
                        karb: 0,
                        yag: 0
                    }
                };
                
                console.log(`üìù G√ºn ${i+1}:`, dayDate.toLocaleDateString('tr-TR'), '-', dayData.gunAdi, '-', template.name, '-', template.totalMacros?.kalori, 'kcal');
                
                newDays.push(dayData);
            }
            
            // Mevcut haftaya ekle
            currentWeek.days.push(...newDays);
            
            // Modal'larƒ± kapat
            closeModal('autoWeekPlanModal');
            closeModal('addDayModal');
            
            // Sayfayƒ± yenile
            renderWeekContent();
            
            // Verileri kaydet (hafta ayarlarƒ± dahil)
            saveWeeks();
            
            // Patient data'yƒ± da kaydet (weekSettings i√ßin)
            try {
                await savePatientData();
                console.log('üíæ Patient data kaydedildi (weekSettings dahil)');
            } catch (error) {
                console.error('‚ùå Patient data kaydetme hatasƒ±:', error);
            }
            
            // Bildirim g√∂ster
            showToast(`‚ú® ${newDays.length} g√ºnl√ºk otomatik plan olu≈üturuldu! Hedef: ${targetCalories} kcal`, 'success');
        }

        // Global variables for sorting
        let currentSortField = null;
        let currentSortDirection = null;
        let filteredTemplates = [];

        // Load Day Templates with Filters
        async function loadDayTemplates() {
            const tableContainer = document.getElementById('dayTemplateTable');
            tableContainer.innerHTML = '<div style="padding: 20px; text-align: center;">≈ûablonlar y√ºkleniyor...</div>';

            // Aktif haftada kullanƒ±lan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            // üöÄ LAZY LOADING: dayTemplates sadece metadata ise, full data y√ºkle
            let templatesForFiltering = dayTemplates;
            
            // √ñnce dayTemplates'in i√ßeriƒüini kontrol et
            const needsFullData = dayTemplates.length > 0 && !dayTemplates[0].ogunler;
            
            console.log('loadDayTemplates baslat ildi:', {
                dayTemplatesCount: dayTemplates.length,
                hasTemplateManager: typeof TemplateManager !== 'undefined',
                needsFullData: needsFullData,
                firstTemplateHasOgunler: dayTemplates[0]?.ogunler ? 'VAR' : 'YOK',
                firstTemplateHasFilename: dayTemplates[0]?.filename ? 'VAR' : 'YOK'
            });
            
            if (needsFullData) {
                console.log('‚è≥ Tam veri y√ºklemesi gerekiyor...');
                
                // √ñNCE: TemplateManager ile dene
                if (typeof TemplateManager !== 'undefined') {
                    console.log('TemplateManager mevcut, index-based loading kullaniliyor');
                    try {
                        const filenames = dayTemplates.map(t => t.filename).filter(f => f);
                        console.log('Yuklenecek dosya sayisi:', filenames.length, '/', dayTemplates.length);
                        console.log('Ilk 5 filename:', filenames.slice(0, 5));
                        
                        if (filenames.length > 0) {
                            console.log('TemplateManager.loadTemplates baslatiliyor...');
                            templatesForFiltering = await TemplateManager.loadTemplates(filenames);
                            console.log('TemplateManager basarili:', templatesForFiltering.length, 'sablon yuklendi');
                            
                            // Kontrol: Gercekten ogun bilgisi var mi?
                            const hasOgunler = templatesForFiltering.length > 0 && templatesForFiltering[0]?.ogunler && templatesForFiltering[0].ogunler.length > 0;
                            console.log('Yukleme sonucu:', {
                                count: templatesForFiltering.length,
                                firstHasOgunler: hasOgunler ? 'VAR' : 'YOK',
                                ogunlerCount: templatesForFiltering[0]?.ogunler?.length || 0
                            });
                            
                            if (!hasOgunler && templatesForFiltering.length === 0) {
                                console.error('Hicbir sablon yuklenemedi!');
                                throw new Error('Hicbir sablon yuklenemedi');
                            }
                            
                            if (!hasOgunler && templatesForFiltering.length > 0) {
                                console.error('Yuklenen sablonlarda ogun bilgisi eksik!');
                                throw new Error('Yuklenen sablonlarda ogun bilgisi yok');
                            }
                            
                            // Global dayTemplates'i guncelle
                            dayTemplates = templatesForFiltering;
                            console.log('Global dayTemplates guncellendi:', dayTemplates.length, 'sablon');
                        } else {
                            throw new Error('Filename listesi bos');
                        }
                    } catch (error) {
                        console.error('‚ùå TemplateManager hatasƒ±:', error);
                        console.log('ÔøΩ Fallback: gun-sablonlari-2025-10-25.json y√ºklenecek');
                        templatesForFiltering = templatesForFiltering || [];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è loadDayTemplates: Tam veri y√ºklemeye gerek yok -', 
                    dayTemplates.length === 0 ? '≈üablon yok' :
                    dayTemplates[0]?.ogunler ? '≈üablonlar zaten tam veri i√ßeriyor' :
                    'bilinmeyen durum');
            }

            // Filter templates based on settings
            filteredTemplates = templatesForFiltering.filter(template => {
                // Diyet t√ºr√º filtresi - YENƒ∞: Modal'daki dropdown'dan al
                const selectedDietType = document.getElementById('templateDietTypeFilter')?.value;
                
                // Eƒüer "Genel" se√ßiliyse (value='') diyet t√ºr√ºne g√∂re filtreleme yapma
                if (selectedDietType && template.dietType) {
                    // ID normalle≈ütirme: farklƒ± formatlardaki ID'leri birbirine √ßevir
                    const normalizeDietId = (id) => {
                        if (!id) return '';
                        const lower = id.toLowerCase().replace(/[_-]/g, ''); // alt √ßizgi ve tire kaldƒ±r
                        
                        // Ketojenik varyantlarƒ±
                        if (lower.includes('eliminasyonlu') && lower.includes('keto')) return 'eliminasyonlu_ketojenik';
                        if (lower.includes('keto')) return 'ketojenik';
                        
                        // D√º≈ü√ºk karb varyantlarƒ±
                        if (lower.includes('dusuk') || lower.includes('d√º≈ü√ºk') || lower === 'lowcarb') return 'dusuk_karb';
                        
                        // Akdeniz
                        if (lower.includes('akdeniz') || lower.includes('mediterranean')) return 'akdeniz';
                        
                        return id; // Normalize edilemezse olduƒüu gibi d√∂n
                    };
                    
                    const normalizedSelected = normalizeDietId(selectedDietType);
                    const normalizedTemplate = normalizeDietId(template.dietType);
                    
                    console.log('üîç Diyet t√ºr√º e≈üle≈ütirme:', { 
                        selected: selectedDietType, 
                        template: template.dietType,
                        normalizedSelected,
                        normalizedTemplate,
                        match: normalizedTemplate === normalizedSelected
                    });
                    
                    if (normalizedTemplate !== normalizedSelected) {
                        return false;
                    }
                }

                // Kalori filtresi - YENƒ∞: Modal'daki input'lardan al
                const calories = template.totalMacros?.kalori || 0;
                
                const minCaloriesInput = parseInt(document.getElementById('minCalorieInput')?.value) || 0;
                const maxCaloriesInput = parseInt(document.getElementById('maxCalorieInput')?.value) || 999999;
                
                if (minCaloriesInput > 0 && calories < minCaloriesInput) {
                    return false;
                }
                
                if (maxCaloriesInput > 0 && maxCaloriesInput < 999999 && calories > maxCaloriesInput) {
                    return false;
                }

                // Disliked foods filter (ESKƒ∞ - kalƒ±yor)
                const dislikedFoodsValue = document.getElementById('dislikedFoods')?.value || '';
                const dislikedFoodsList = dislikedFoodsValue
                    .split(',')
                    .map(f => f.trim().toLowerCase())
                    .filter(f => f);
                    
                if (dislikedFoodsList.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => 
                            dislikedFoodsList.some(disliked => 
                                yemek.foodName.toLowerCase().includes(disliked)
                            )
                        )
                    );
                    if (hasDislikedFood) return false;
                }

                return true;
            });
            
            // Filtreleme istatistiƒüini g√ºncelle
            const filteredCountEl = document.getElementById('filteredTemplateCount');
            if (filteredCountEl) {
                filteredCountEl.textContent = filteredTemplates.length;
            }
            
            const totalCountEl = document.getElementById('totalTemplateCount');
            if (totalCountEl) {
                totalCountEl.textContent = dayTemplates.length;
            }

            if (filteredTemplates.length === 0) {
                tableContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Filtrelerinize uygun ≈üablon bulunamadƒ±</div>';
                return;
            }
            
            // Hesaplanan tolerans ve hedef kaloriyi kullanarak filtre bilgisini g√ºncelle
            const inputMin = parseInt(document.getElementById('minCalories')?.value) || 0;
            const inputMax = parseInt(document.getElementById('maxCalories')?.value) || 0;

            // Tolerans: hasta ayarƒ± varsa onu kullan, yoksa input veya admin default
            let tolerancePercent = parseInt(document.getElementById('calorieTolerancePercent')?.value);
            if (!tolerancePercent || isNaN(tolerancePercent)) {
                tolerancePercent = (patientData && patientData.settings && patientData.settings.calorieTolerancePercent) || appSettings?.calorieTolerancePercent || 5;
            }

            // Hedef kaloriyi belirle: input varsa kullan, yoksa hasta bilgileri ve form√ºl √ºzerinden hesapla
            let targetCalories = parseInt(document.getElementById('targetCalories')?.value) || 0;
            if (!targetCalories || targetCalories === 0) {
                const weight = parseFloat((patientData && patientData.personalInfo && patientData.personalInfo.weight) || document.getElementById('patientWeight')?.value) || 70;
                const activityLevel = parseInt((patientData && patientData.personalInfo && patientData.personalInfo.activityLevel) || document.getElementById('activityLevel')?.value) || 3;
                const dietType = document.getElementById('dietType')?.value || (settings && settings.dietType) || 'ketojenik';
                const dietFormula = (appSettings && appSettings.dietFormulas && appSettings.dietFormulas[dietType]) || (appSettings && appSettings.dietFormulas && appSettings.dietFormulas['ketojenik']) || { protein: 0.8, carb: 0.3, fat: 1.2 };
                const activityMultiplier = (appSettings && appSettings.dietFormulas && appSettings.dietFormulas.activityMultipliers && appSettings.dietFormulas.activityMultipliers[activityLevel]) || 1.0;
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            }

            const tol = (tolerancePercent || 5) / 100;
            const computedMin = Math.round(targetCalories * (1 - tol));
            const computedMax = Math.round(targetCalories * (1 + tol));

            const minCal = inputMin > 0 ? inputMin : computedMin;
            const maxCal = inputMax > 0 ? inputMax : computedMax;

            // G√ºncelleme: filtre istatistiklerini kullanƒ±cƒ±ya g√∂ster
            const statsEl = document.getElementById('filterStats');
            if (statsEl) {
                statsEl.textContent = `${filteredTemplates.length}/${dayTemplates.length} (Kalori Toleransƒ± (%${tolerancePercent}))`;
            }

            // Render table (async - lazy loading i√ßerir)
            await renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Render template table (with lazy loading for full template data)
        async function renderTemplateTable(templates, usedTemplateIds) {
            const tableContainer = document.getElementById('dayTemplateTable');
            const isAdmin = window.isUserAdmin();
            
            console.log('üîç renderTemplateTable ba≈ülatƒ±ldƒ±:', {
                templateCount: templates.length,
                firstTemplate: templates[0],
                hasOgunler: templates[0]?.ogunler ? 'VAR' : 'YOK',
                hasFilename: templates[0]?.filename ? 'VAR' : 'YOK',
                firstTemplateKeys: templates[0] ? Object.keys(templates[0]) : []
            });
            
            // üöÄ CRITICAL: ≈ûablonlarda ogunler yoksa tam veri y√ºkle
            let fullTemplates = templates;
            const needsFullData = templates.length > 0 && !templates[0].ogunler;
            
            if (needsFullData) {
                console.log('‚è≥ renderTemplateTable: √ñƒü√ºn bilgisi yok, tam veri y√ºklenecek...');
                
                // √ñNCE: TemplateManager ile dene
                if (typeof TemplateManager !== 'undefined' && templates[0]?.filename) {
                    console.log('‚úÖ TemplateManager kullanƒ±lacak');
                    const filenames = templates.map(t => t.filename).filter(f => f);
                    console.log('üìÅ Y√ºklenecek dosyalar:', filenames.length, 'dosya');
                    
                    try {
                        fullTemplates = await TemplateManager.loadTemplates(filenames);
                        console.log('‚úÖ TemplateManager ile y√ºklendi:', fullTemplates.length, '≈üablon');
                        console.log('üîç ƒ∞lk ≈üablonun ogunler:', fullTemplates[0]?.ogunler ? `${fullTemplates[0].ogunler.length} √∂ƒü√ºn` : 'YOK');
                    } catch (error) {
                        console.error('‚ùå TemplateManager hatasƒ±:', error);
                        fullTemplates = null; // Fallback i√ßin null yap
                    }
                }
                
                // FALLBACK: TemplateManager ba≈üarƒ±sƒ±z olduysa veya yoksa
                if (!fullTemplates || fullTemplates.length === 0 || !fullTemplates[0].ogunler) {
                    console.log('üîÑ FALLBACK: gun-sablonlari-2025-10-25.json y√ºklenecek');
                    try {
                        const fallbackResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/gun-sablonlari-2025-10-25.json?t=' + Date.now());
                        const fallbackData = await fallbackResponse.json();
                        const allTemplates = fallbackData.templates || [];
                        
                        // Sadece istenen template ID'leri bul
                        const requestedIds = new Set(templates.map(t => t.id));
                        fullTemplates = allTemplates.filter(t => requestedIds.has(t.id));
                        
                        console.log('‚úÖ FALLBACK ba≈üarƒ±lƒ±:', fullTemplates.length, '≈üablon bulundu');
                        console.log('üîç ƒ∞lk ≈üablonun ogunler:', fullTemplates[0]?.ogunler ? `${fullTemplates[0].ogunler.length} √∂ƒü√ºn` : 'YOK');
                    } catch (fallbackError) {
                        console.error('‚ùå FALLBACK hatasƒ±:', fallbackError);
                        fullTemplates = templates; // Metadata ile devam et
                    }
                }
            } else {
                console.log('‚úÖ renderTemplateTable: ≈ûablonlar zaten tam veri i√ßeriyor veya ≈üablon yok');
            }
            
            // Sƒ±ralama ok i≈üaretlerini belirle
            const getSortIcon = (field) => {
                if (currentSortField === field) {
                    return currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc';
                }
                return 'sortable';
            };
            
            let tableHTML = `
                <table class="template-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;" class="${getSortIcon('menu')}" onclick="toggleSort('menu')">Men√ºler</th>
                            <th style="width: 45%;">√ñƒü√ºnler</th>
                            <th style="width: 10%;" class="${getSortIcon('calories')}" onclick="toggleSort('calories')">Kalori</th>
                            <th style="width: 10%;" class="${getSortIcon('karb')}" onclick="toggleSort('karb')">Karb (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('protein')}" onclick="toggleSort('protein')">Protein (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('yag')}" onclick="toggleSort('yag')">Yaƒü (g)</th>
                            ${isAdmin ? '<th style="width: 8%;">ƒ∞≈ülem</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            fullTemplates.forEach((template, index) => {
                const macros = template.totalMacros || {};
                const isUsed = usedTemplateIds.has(template.id);
                const isSelected = selectedTemplates.some(st => st.templateId === template.id);
                
                // Yemek listesini olu≈ütur (√∂ƒü√ºnlere g√∂re)
                let mealsHTML = '';
                if (template.ogunler && Array.isArray(template.ogunler) && template.ogunler.length > 0) {
                    const mealsList = template.ogunler.map((ogun, ogunIndex) => {
                        // Yemek listesini olu≈ütur
                        let foodNames = '';
                        if (ogun.yemekler && Array.isArray(ogun.yemekler) && ogun.yemekler.length > 0) {
                            foodNames = ogun.yemekler.map(y => {
                                // Yemek adƒ±nƒ± bul (foodName, name, originalText sƒ±rasƒ±yla)
                                return y.foodName || y.name || y.originalText || '?';
                            }).join(', ');
                        } else {
                            foodNames = '(Yemek bilgisi yok)';
                        }
                        
                        // √ñƒü√ºn adƒ±nƒ± al (ogunAdi veya mealName)
                        let mealDisplayName = ogun.ogunAdi || ogun.mealName || '√ñƒü√ºn';
                        
                        // ƒ∞lk harfi b√ºy√ºk yap
                        mealDisplayName = mealDisplayName.charAt(0).toUpperCase() + mealDisplayName.slice(1);
                        
                        return `<strong>${mealDisplayName}:</strong> ${foodNames}`;
                    }).join('<br>');
                    mealsHTML = mealsList;
                } else {
                    // √ñƒü√ºn bilgisi yok - daha detaylƒ± hata mesajƒ±
                    mealsHTML = '<em style="color: #999;">√ñƒü√ºn bilgisi y√ºklenemedi</em>';
                    console.warn('‚ö†Ô∏è ≈ûablonda √∂ƒü√ºn bulunamadƒ±:', {
                        templateId: template.id,
                        templateName: template.name,
                        hasOgunler: !!template.ogunler,
                        ogunlerType: typeof template.ogunler,
                        ogunlerIsArray: Array.isArray(template.ogunler),
                        ogunlerLength: template.ogunler?.length,
                        templateKeys: Object.keys(template),
                        fullTemplate: template
                    });
                }
                
                // Row classes
                let rowClass = '';
                if (isSelected) rowClass += ' selected';
                if (isUsed) rowClass += ' used-template';
                
                // Admin d√ºzenle butonu
                const adminActionBtn = isAdmin ? `
                    <td style="text-align: center;">
                        <button class="btn-admin-edit" onclick="event.stopPropagation(); openTemplateEditModal('${template.id}')" title="≈ûablonu D√ºzenle">
                            ‚úèÔ∏è
                        </button>
                    </td>
                ` : '';
                
                tableHTML += `
                    <tr class="${rowClass}" data-template-id="${template.id}" onclick="selectTemplate('${template.id}')" style="cursor: pointer;">
                        <td>${template.name || `≈ûablon ${index + 1}`}</td>
                        <td class="meal-cell">${mealsHTML || 'Yemek bilgisi yok'}</td>
                        <td style="text-align: center;">${Math.round(macros.kalori || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.karb || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.protein || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.yag || 0)}</td>
                        ${adminActionBtn}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            
            // Total count'u g√ºncelle
            const totalElement = document.getElementById('totalCount');
            if (totalElement) {
                totalElement.textContent = templates.length;
            }
            
            // Akƒ±llƒ± filtreyi uygula (varsa)
            applySmartFilter();
        }

        // Akƒ±llƒ± filtreleme fonksiyonu
        function applySmartFilter() {
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            
            if (!wantedInput || !unwantedInput) return;
            
            const wantedText = wantedInput.value.trim().toLowerCase();
            const unwantedText = unwantedInput.value.trim().toLowerCase();
            
            // Virg√ºlle ayrƒ±lmƒ±≈ü kelimeleri al
            const wantedKeywords = wantedText ? wantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            const unwantedKeywords = unwantedText ? unwantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            
            const rows = document.querySelectorAll('.template-table tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const mealCell = row.querySelector('.meal-cell');
                if (!mealCell) return;
                
                const mealText = mealCell.textContent.toLowerCase();
                let shouldShow = true;
                
                // Pozitif filtreleme: T√úM istenen kelimeleri i√ßermeli
                if (wantedKeywords.length > 0) {
                    const hasAllKeywords = wantedKeywords.every(keyword => mealText.includes(keyword));
                    if (!hasAllKeywords) {
                        shouldShow = false;
                    }
                }
                
                // Negatif filtreleme: Hƒ∞√áBƒ∞R istenmeyen kelimeyi i√ßermemeli
                if (shouldShow && unwantedKeywords.length > 0) {
                    const hasAnyUnwanted = unwantedKeywords.some(keyword => mealText.includes(keyword));
                    if (hasAnyUnwanted) {
                        shouldShow = false;
                    }
                }
                
                // Satƒ±rƒ± g√∂ster/gizle
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // ƒ∞statistiƒüi g√ºncelle
            const statsElement = document.getElementById('visibleCount');
            const totalElement = document.getElementById('totalCount');
            if (statsElement) {
                statsElement.textContent = visibleCount;
            }
            if (totalElement) {
                totalElement.textContent = rows.length;
            }
        }

        // Toggle sort - ba≈ülƒ±ƒüa tƒ±klandƒ±ƒüƒ±nda sƒ±ralama y√∂n√ºn√º deƒüi≈ütir
        function toggleSort(field) {
            // Aynƒ± alana tekrar tƒ±klanƒ±rsa y√∂n√º deƒüi≈ütir, farklƒ± alana tƒ±klanƒ±rsa artan sƒ±ralama yap
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            sortTemplates(field, currentSortDirection);
        }

        // Sort templates
        function sortTemplates(field, direction) {
            currentSortField = field;
            currentSortDirection = direction;
            
            const sortedTemplates = [...filteredTemplates].sort((a, b) => {
                let aValue, bValue;
                
                switch(field) {
                    case 'menu':
                        // Men√º adƒ±ndan sayƒ±yƒ± √ßƒ±kar (√∂rn: "Men√º 15" -> 15)
                        const aMatch = (a.name || '').match(/Men√º\s*(\d+)/i);
                        const bMatch = (b.name || '').match(/Men√º\s*(\d+)/i);
                        aValue = aMatch ? parseInt(aMatch[1]) : 999999; // E≈üle≈ümeyen en sonda
                        bValue = bMatch ? parseInt(bMatch[1]) : 999999;
                        break;
                    case 'calories':
                        aValue = a.totalMacros?.kalori || 0;
                        bValue = b.totalMacros?.kalori || 0;
                        break;
                    case 'karb':
                        aValue = a.totalMacros?.karb || 0;
                        bValue = b.totalMacros?.karb || 0;
                        break;
                    case 'protein':
                        aValue = a.totalMacros?.protein || 0;
                        bValue = b.totalMacros?.protein || 0;
                        break;
                    case 'yag':
                        aValue = a.totalMacros?.yag || 0;
                        bValue = b.totalMacros?.yag || 0;
                        break;
                }
                
                if (direction === 'asc') {
                    return aValue - bValue;
                } else {
                    return bValue - aValue;
                }
            });
            
            // Aktif haftada kullanƒ±lan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(sortedTemplates, usedTemplateIds);
        }

        // Reset sorting
        function resetTemplates() {
            currentSortField = null;
            currentSortDirection = null;
            
            // Aktif haftada kullanƒ±lan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Multiple template selection
        let selectedTemplates = []; // Array of {templateId, order}

        function selectTemplate(templateId) {
            const template = dayTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            // Zaten se√ßili mi kontrol et
            const existingIndex = selectedTemplates.findIndex(st => st.templateId === templateId);
            
            if (existingIndex !== -1) {
                // Se√ßimi kaldƒ±r
                selectedTemplates.splice(existingIndex, 1);
            } else {
                // Se√ßime ekle
                selectedTemplates.push({
                    templateId: templateId,
                    template: template,
                    order: selectedTemplates.length + 1
                });
            }
            
            // UI'yi g√ºncelle
            updateTemplateSelectionUI();
        }

        function updateTemplateSelectionUI() {
            // Tablo satƒ±rlarƒ±nƒ± g√ºncelle
            const rows = document.querySelectorAll('.template-table tbody tr');
            rows.forEach(row => {
                const templateId = row.getAttribute('data-template-id');
                const isSelected = selectedTemplates.some(st => st.templateId === templateId);
                
                if (isSelected) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
            
            // Kaydet butonunu g√∂ster/gizle
            const saveBtn = document.getElementById('saveMultipleDaysBtn');
            if (selectedTemplates.length > 0) {
                saveBtn.style.display = 'block';
                saveBtn.textContent = `${selectedTemplates.length} G√ºn√º Kaydet`;
            } else {
                saveBtn.style.display = 'none';
            }
        }

        function updateSelectedTemplatesBand() {
            // Bu fonksiyon artƒ±k kullanƒ±lmƒ±yor ama uyumluluk i√ßin bo≈ü bƒ±rakƒ±lƒ±yor
        }

        function removeSelectedTemplate(index) {
            selectedTemplates.splice(index, 1);
            updateTemplateSelectionUI();
        }

        // Old single selection function - kept for compatibility
        let selectedTemplateId = null;

        function selectTemplateSingle(templateId) {
            selectedTemplateId = templateId;
            
            // Update UI
            const items = document.querySelectorAll('.template-item');
            items.forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // Save Day to Week
        async function saveDayToWeek() {
            if (!selectedTemplateId) {
                showToast('L√ºtfen bir ≈üablon se√ßin', 'error');
                return;
            }

            const dayName = document.getElementById('daySelect').value;
            const dayDate = document.getElementById('dayDate').value;
            let template = dayTemplates.find(t => t.id === selectedTemplateId);

            if (!template) {
                showToast('≈ûablon bulunamadƒ±', 'error');
                return;
            }

            // üîÑ YENƒ∞ Sƒ∞STEM: Metadata-only template ise full data'yƒ± lazy load et
            if (template.filename && !template.ogunler && typeof TemplateManager !== 'undefined') {
                try {
                    console.log('‚è≥ ≈ûablon detaylarƒ± y√ºkleniyor (lazy loading):', template.filename);
                    const fullTemplates = await TemplateManager.loadTemplates([template.filename]);
                    if (fullTemplates && fullTemplates.length > 0) {
                        template = fullTemplates[0];
                        console.log('‚úÖ Full data y√ºklendi:', template.name);
                    } else {
                        showToast('≈ûablon detaylarƒ± y√ºklenemedi!', 'error');
                        return;
                    }
                } catch (err) {
                    console.error('‚ùå Lazy load hatasƒ±:', err);
                    showToast('≈ûablon y√ºklenirken hata olu≈ütu!', 'error');
                    return;
                }
            }

            // Kullanƒ±cƒ±nƒ±n se√ßtiƒüi g√ºn adƒ±nƒ± kullan (≈üablonun g√ºn adƒ±nƒ± deƒüil)
            const newDay = {
                id: Date.now(),
                gunAdi: dayName,  // Kullanƒ±cƒ±nƒ±n se√ßtiƒüi g√ºn
                date: dayDate,
                templateId: template.id,
                templateName: template.name,
                totalCalories: template.totalCalories || 0,
                totalMacros: template.totalMacros || {},
                ogunler: template.ogunler || []
            };

            // Pazartesi g√ºn√º eklendiyse √ñNCE yeni hafta kontrol√º yap
            const shouldCreateNewWeek = checkShouldCreateNewWeek(dayName);
            
            if (shouldCreateNewWeek) {
                // Yeni hafta olu≈ütur ve Pazartesi'yi oraya ekle
                const created = promptNewWeekCreation();
                if (created) {
                    // Yeni haftaya ekle
                    weeks[activeWeekIndex].days.push(newDay);
                    saveWeeks();
                    renderWeekContent();
                    closeModal('addDayModal');
                    showToast('G√ºn yeni haftaya eklendi');
                    return;
                }
            }

            // Normal akƒ±≈ü - mevcut haftaya ekle
            weeks[activeWeekIndex].days.push(newDay);
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast('G√ºn eklendi');
        }

        // Save Multiple Days to Week
        async function saveMultipleDaysToWeek() {
            if (selectedTemplates.length === 0) {
                showToast('L√ºtfen en az bir ≈üablon se√ßin', 'error');
                return;
            }

            // üîÑ YENƒ∞ Sƒ∞STEM: Metadata-only templates varsa √∂nce full data'yƒ± lazy load et
            const needsLazyLoad = selectedTemplates.some(st => st.template && st.template.filename && !st.template.ogunler);
            
            if (needsLazyLoad && typeof TemplateManager !== 'undefined') {
                try {
                    console.log('‚è≥ Se√ßili ≈üablonlar i√ßin full data y√ºkleniyor (lazy loading)...');
                    const filenames = selectedTemplates
                        .filter(st => st.template && st.template.filename)
                        .map(st => st.template.filename);
                    
                    if (filenames.length > 0) {
                        const fullTemplates = await TemplateManager.loadTemplates(filenames);
                        
                        // selectedTemplates i√ßindeki template objesini full data ile deƒüi≈ütir
                        selectedTemplates.forEach(st => {
                            if (st.template && st.template.filename) {
                                const fullTemplate = fullTemplates.find(ft => ft.id === st.template.id);
                                if (fullTemplate) {
                                    st.template = fullTemplate;
                                }
                            }
                        });
                        
                        console.log('‚úÖ Full data y√ºklendi:', fullTemplates.length, '≈üablon');
                    }
                } catch (err) {
                    console.error('‚ùå Lazy load hatasƒ±:', err);
                    showToast('≈ûablon detaylarƒ± y√ºklenemedi!', 'error');
                    return;
                }
            }

            const currentWeek = weeks[currentWeekIndex];
            let startDate = new Date();
            
            // Ba≈ülangƒ±√ß tarihini belirle
            if (currentWeek.days.length > 0) {
                const lastDay = currentWeek.days[currentWeek.days.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
            } else if (currentWeek.startDate) {
                startDate = new Date(currentWeek.startDate);
            }

            const dayNames = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
            let addedCount = 0;
            let currentWeekForAdding = currentWeekIndex;
            
            // Se√ßilen ≈üablonlarƒ± sƒ±rayla ekle
            for (let i = 0; i < selectedTemplates.length; i++) {
                const st = selectedTemplates[i];
                const template = st.template;
                
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayName = dayNames[date.getDay()];
                const dateStr = date.toISOString().split('T')[0];
                
                const newDay = {
                    id: Date.now() + i,
                    gunAdi: dayName,
                    date: dateStr,
                    templateId: template.id,
                    templateName: template.name,
                    totalCalories: template.totalCalories || 0,
                    totalMacros: template.totalMacros || {},
                    ogunler: template.ogunler || []
                };
                
                // üîÑ Yeni eklenen g√ºn√ºn t√ºm yemekleri i√ßin rotation state'lerini sƒ±fƒ±rla
                if (newDay.ogunler && Array.isArray(newDay.ogunler)) {
                    newDay.ogunler.forEach(ogun => {
                        if (ogun.yemekler && Array.isArray(ogun.yemekler)) {
                            ogun.yemekler.forEach(food => {
                                const foodNameNormalized = normalizeText(food.foodName || '');
                                const rotationKey = `foodRotation_${foodNameNormalized}`;
                                const alternativesKey = `foodAlternatives_${foodNameNormalized}`;
                                localStorage.removeItem(rotationKey);
                                localStorage.removeItem(alternativesKey);
                            });
                        }
                    });
                }
                
                // Pazartesi g√ºn√º m√º ve yeni hafta gerekli mi kontrol et
                if (dayName === 'Pazartesi' && i > 0) {
                    const shouldCreateNewWeek = checkShouldCreateNewWeekForDate(currentWeekForAdding);
                    
                    if (shouldCreateNewWeek) {
                        // Yeni hafta olu≈ütur (sessizce, confirm sorma)
                        const newWeekCreated = createNewWeekSilently(date);
                        if (newWeekCreated) {
                            currentWeekForAdding = weeks.length - 1;
                        }
                    }
                }
                
                weeks[currentWeekForAdding].days.push(newDay);
                addedCount++;
            }
            
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast(`${addedCount} g√ºn ba≈üarƒ±yla eklendi`);
            
            // Se√ßimleri temizle
            selectedTemplates = [];
        }

        // Check if new week should be created for specific week index
        function checkShouldCreateNewWeekForDate(weekIndex) {
            const targetWeek = weeks[weekIndex];
            
            // ƒ∞lk hafta mƒ±?
            if (weekIndex === 0) {
                const firstMondayIndex = targetWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                if (firstMondayIndex === -1) return false;
                
                const daysAfterFirstMonday = targetWeek.days.length - firstMondayIndex;
                if (daysAfterFirstMonday < 7) return false;
                
                return true;
            }
            
            return true;
        }

        // Create new week silently (without confirm)
        function createNewWeekSilently(startDate) {
            const weekNumber = weeks.length + 1;
            
            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            return true;
        }

        // Refresh Day Template - Kullanƒ±lmamƒ±≈ü ≈üablonlardan en yakƒ±n kalorili olanƒ± se√ß
        async function refreshDayTemplate(dayIndex) {
            const currentWeek = weeks[currentWeekIndex];
            const day = currentWeek.days[dayIndex];
            
            if (!day) {
                showToast('G√ºn bulunamadƒ±', 'error');
                return;
            }
            
            // Hasta verilerinden bilgileri √ßek (patientData.settings'den)
            const weight = patientData?.personalInfo?.weight || 70;
            const activityLevel = patientData?.personalInfo?.activity || 3;
            const dietType = patientData?.settings?.dietType || 'ketojenik';
            
            // Admin ayarlarƒ±ndan form√ºl al
            const dietFormula = appSettings?.dietFormulas?.[dietType] || { protein: 0.8, carb: 0.3, fat: 1.2 };
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activityLevel] || 1.0;
            
            const protein = weight * dietFormula.protein * activityMultiplier;
            const carb = weight * dietFormula.carb * activityMultiplier;
            const fat = weight * dietFormula.fat * activityMultiplier;
            const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            
            // Son N haftada kullanƒ±lan ≈üablonlarƒ± topla
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(d => {
                        if (d.templateId) {
                            recentlyUsedTemplateIds.add(d.templateId);
                        }
                    });
                }
            }
            
            // üîß Normalizasyon fonksiyonu (generateAutoWeekPlan ile aynƒ±)
            const normalizeDietType = (dt) => {
                if (!dt) return '';
                const lower = dt.toLowerCase().replace(/[_-]/g, '');
                if (lower.includes('eliminasyonlu') && lower.includes('keto')) return 'eliminasyonlu_ketojenik';
                if (lower.includes('keto')) return 'ketojenik';
                if (lower.includes('dusuk') || lower.includes('d√º≈ü√ºk') || lower === 'lowcarb') return 'dusuk_carb';
                if (lower.includes('akdeniz') || lower.includes('mediterranean')) return 'akdeniz';
                return dt.toLowerCase().replace(/[-_]/g, '_');
            };
            
            // Diyet t√ºr√º uyumluluk matrisi (generateAutoWeekPlan ile aynƒ±)
            const normalizedDietType = normalizeDietType(dietType);
            const compatibilityMap = {
                'eliminasyonlu_ketojenik': ['eliminasyonlu_ketojenik', 'ketojenik'],
                'ketojenik': ['ketojenik', 'eliminasyonlu_ketojenik'],
                'dusuk_carb': ['dusuk_carb', 'ketojenik', 'eliminasyonlu_ketojenik'],
                'akdeniz': ['akdeniz']
            };
            const allowedDietTypes = compatibilityMap[normalizedDietType] || [normalizedDietType];
            
            console.log(`üîÑ Refresh - Diyet: ${normalizedDietType}, Uyumlu: ${allowedDietTypes.join(', ')}`);
            
            // Kullanƒ±lmamƒ±≈ü ≈üablonlarƒ± filtrele
            let unusedTemplates = dayTemplates.filter(t => {
                // Son N haftada kullanƒ±lmƒ±≈ü mƒ±?
                if (recentlyUsedTemplateIds.has(t.id)) {
                    return false;
                }
                // Diyet tipi uyumlu mu? (Normalizasyon ile)
                if (t.dietType) {
                    const normalizedTemplateDiet = normalizeDietType(t.dietType);
                    if (!allowedDietTypes.includes(normalizedTemplateDiet)) {
                        return false;
                    }
                }
                return true;
            });
            
            console.log(`üîÑ Refresh - ${unusedTemplates.length} kullanƒ±lmamƒ±≈ü ≈üablon bulundu`);
            
            // Eƒüer kullanƒ±lmamƒ±≈ü ≈üablon kalmadƒ±ysa, t√ºm ≈üablonlarƒ± kullan (ba≈üa d√∂n)
            if (unusedTemplates.length === 0) {
                console.log('‚ö†Ô∏è Refresh i√ßin kullanƒ±lmamƒ±≈ü ≈üablon kalmadƒ±, t√ºm ≈üablonlarƒ± kullanƒ±ma a√ßƒ±yoruz...');
                
                unusedTemplates = dayTemplates.filter(t => {
                    // Sadece diyet tipi kontrol√º (normalizasyon ile)
                    if (t.dietType) {
                        const normalizedTemplateDiet = normalizeDietType(t.dietType);
                        if (!allowedDietTypes.includes(normalizedTemplateDiet)) {
                            return false;
                        }
                    }
                    return true;
                });
                
                console.log(`üîÑ Refresh - T√ºm ≈üablonlar: ${unusedTemplates.length} uyumlu ≈üablon`);
                
                if (unusedTemplates.length === 0) {
                    showToast('Diyet tipine uygun ≈üablon bulunamadƒ±', 'error');
                    return;
                }
            }
            
            // ‚ú® GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û ZIGZAG SIRALAMA (generateAutoWeekPlan ile aynƒ± mantƒ±k)
            // 1. Her ≈üablonun fark bilgilerini hesapla
            const templatesWithDiff = unusedTemplates.map(template => {
                const kalori = template.totalMacros?.kalori || 0;
                const diff = kalori - targetCalories;
                const absDiff = Math.abs(diff);
                return {
                    template: template,
                    diff: diff,
                    absDiff: absDiff,
                    kalori: kalori
                };
            });
            
            // 2. Hedefin altƒ± ve √ºst√º olarak ayƒ±r
            const belowTarget = templatesWithDiff.filter(t => t.diff < 0).sort((a, b) => a.absDiff - b.absDiff);
            const aboveTarget = templatesWithDiff.filter(t => t.diff >= 0).sort((a, b) => a.absDiff - b.absDiff);
            
            // 3. Zigzag birle≈ütirme
            const zigzagSorted = [];
            let belowIndex = 0, aboveIndex = 0;
            let preferBelow = belowTarget.length > 0;
            
            while (belowIndex < belowTarget.length || aboveIndex < aboveTarget.length) {
                if (preferBelow && belowIndex < belowTarget.length) {
                    zigzagSorted.push(belowTarget[belowIndex]);
                    belowIndex++;
                    preferBelow = false;
                } else if (!preferBelow && aboveIndex < aboveTarget.length) {
                    zigzagSorted.push(aboveTarget[aboveIndex]);
                    aboveIndex++;
                    preferBelow = true;
                } else if (belowIndex < belowTarget.length) {
                    zigzagSorted.push(belowTarget[belowIndex]);
                    belowIndex++;
                } else {
                    zigzagSorted.push(aboveTarget[aboveIndex]);
                    aboveIndex++;
                }
            }
            
            // 4. Sonu√ß listesine aktar
            unusedTemplates = zigzagSorted.map(item => item.template);
            
            console.log(`üìä Refresh - Kademeli zigzag sƒ±ralama (Hedef: ${targetCalories} kcal):`,
                unusedTemplates.slice(0, 10).map((t, i) => {
                    const diff = (t.totalMacros?.kalori || 0) - targetCalories;
                    const sign = diff >= 0 ? '+' : '';
                    return `${i + 1}. ${t.name}: ${sign}${diff} kcal`;
                })
            );
            
            // Mevcut ≈üablonun alternatifler listesindeki index'ini bul
            if (!day.refreshIndex) {
                day.refreshIndex = 0; // ƒ∞lk tƒ±klama
            }
            
            // 10 alternatif d√∂ng√ºs√º (sƒ±rayla ge√ß)
            const totalAlternatives = Math.min(10, unusedTemplates.length);
            day.refreshIndex = (day.refreshIndex + 1) % totalAlternatives;
            
            // D√∂ng√ºsel se√ßim (10'dan fazla ≈üablon varsa tekrar ba≈üa d√∂n)
            const templateIndex = day.refreshIndex % unusedTemplates.length;
            const newTemplateMetadata = unusedTemplates[templateIndex];
            
            const calorieDiff = Math.abs((newTemplateMetadata.totalMacros?.kalori || 0) - targetCalories);
            console.log(`üîÑ Refresh (${day.refreshIndex + 1}/10): Hedef ${targetCalories} kcal, Se√ßilen: ${newTemplateMetadata.name} (${newTemplateMetadata.totalMacros?.kalori} kcal, Fark: ${calorieDiff} kcal)`);
            
            let newTemplate;
            
            // Check if TemplateManager is available and template has filename (new system)
            if (typeof TemplateManager !== 'undefined' && newTemplateMetadata.filename) {
                // üöÄ LAZY LOADING: Se√ßilen tek ≈üablonun tam verisini y√ºkle
                console.log('‚è≥ Yeni men√º y√ºkleniyor (YENƒ∞ Sƒ∞STEM - Lazy Loading)...', newTemplateMetadata.filename);
                showToast('‚è≥ Yeni men√º y√ºkleniyor...', 'info');
                
                try {
                    newTemplate = await TemplateManager.loadTemplate(newTemplateMetadata.filename);
                    console.log('‚úÖ Tam ≈üablon y√ºklendi:', newTemplate.name);
                } catch (error) {
                    console.error('‚ùå ≈ûablon y√ºklenirken hata:', error);
                    showToast('‚ùå Men√º y√ºklenemedi: ' + error.message, 'error');
                    return;
                }
            } else {
                // ESKƒ∞ Sƒ∞STEM: Metadata zaten tam veri (fallback)
                console.log('‚úÖ ≈ûablon zaten y√ºkl√º (ESKƒ∞ Sƒ∞STEM - Full Data)');
                newTemplate = newTemplateMetadata;
            }
            
            // G√ºn√º g√ºncelle
            day.templateId = newTemplate.id;
            day.templateName = newTemplate.name;
            day.meals = newTemplate.ogunler ? JSON.parse(JSON.stringify(newTemplate.ogunler)) : [];
            day.ogunler = day.meals; // Geriye d√∂n√ºk uyumluluk
            day.totalMacros = newTemplate.totalMacros ? JSON.parse(JSON.stringify(newTemplate.totalMacros)) : {
                kalori: 0,
                protein: 0,
                karb: 0,
                yag: 0
            };
            
            // Kaydet ve g√∂ster
            saveWeeks();
            renderWeekContent();
            showToast(`${day.gunAdi}: ${newTemplate.name} (${day.refreshIndex + 1}/10)`, 'success');
            
            console.log(`üîÑ ${day.gunAdi} g√ºncellendi: ${newTemplate.name} (${newTemplate.totalMacros?.kalori} kcal)`);
        }

        // Delete Day - G√ºn√º sil
        async function deleteDay(dayIndex) {
            const currentWeek = weeks[currentWeekIndex];
            const day = currentWeek.days[dayIndex];
            
            if (!day) {
                showToast('G√ºn bulunamadƒ±', 'error');
                return;
            }
            
            // Onay iste
            const confirmDelete = confirm(`"${day.gunAdi}" g√ºn√ºn√º silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`);
            
            if (!confirmDelete) {
                console.log('‚ùå Silme i≈ülemi iptal edildi');
                return;
            }
            
            // G√ºn√º sil
            currentWeek.days.splice(dayIndex, 1);
            
            console.log(`üóëÔ∏è ${day.gunAdi} silindi`);
            
            // Kaydet ve g√∂ster
            await saveWeeks();
            
            renderWeekContent();
            showToast(`${day.gunAdi} g√ºn√º silindi`, 'success');
        }

        // Check Should Create New Week
        function checkShouldCreateNewWeek(dayName) {
            // Pazartesi g√ºn√º m√º?
            if (dayName !== 'Pazartesi') return false;
            
            const currentWeek = weeks[currentWeekIndex];
            
            // ƒ∞lk hafta mƒ±?
            if (currentWeekIndex === 0) {
                // ƒ∞lk haftada: ƒ∞lk Pazartesi'den sonra 7 g√ºn (Pazartesi-Pazar) tamamlanmƒ±≈ü mƒ± kontrol et
                
                // ƒ∞lk Pazartesi'nin index'ini bul
                const firstMondayIndex = currentWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                
                if (firstMondayIndex === -1) {
                    // Hen√ºz hi√ß Pazartesi yok (bu eklenen ilk Pazartesi)
                    // Yeni hafta a√ßma
                    return false;
                }
                
                // ƒ∞lk Pazartesi'den sonraki g√ºn sayƒ±sƒ±
                const daysAfterFirstMonday = currentWeek.days.length - firstMondayIndex;
                
                // ƒ∞lk Pazartesi'den sonra 7 g√ºn tamamlandƒ± mƒ±? (Pazartesi dahil)
                if (daysAfterFirstMonday < 7) {
                    // Hen√ºz 7 g√ºn tamamlanmadƒ±, yeni hafta a√ßma
                    return false;
                }
                
                // 7 g√ºn tamamlandƒ± ve ≈üimdi ikinci Pazartesi geldi - yeni hafta sor
                return true;
            }
            
            // ƒ∞lk haftadan sonraki haftalar i√ßin: Her Pazartesi yeni hafta
            return true;
        }

        // Prompt New Week Creation
        function promptNewWeekCreation() {
            const currentWeek = weeks[currentWeekIndex];
            const nextWeekNumber = weeks.length + 1;
            
            // Son eklenen g√ºn√ºn tarihini al (hen√ºz eklenmedi, bu y√ºzden son g√ºn bir √∂nceki)
            const lastDay = currentWeek.days[currentWeek.days.length - 1];
            const lastDate = new Date(lastDay.date);
            
            // Bir sonraki Pazartesi (bir g√ºn sonrasƒ±)
            const nextMonday = new Date(lastDate);
            nextMonday.setDate(nextMonday.getDate() + 1);
            
            // Bir sonraki Pazar (6 g√ºn sonra)
            const nextSunday = new Date(nextMonday);
            nextSunday.setDate(nextSunday.getDate() + 6);
            
            // T√ºrk√ße tarih formatƒ±
            const startStr = formatDateTurkish(nextMonday);
            const endStr = formatDateTurkish(nextSunday);
            
            const message = `${nextWeekNumber}. hafta eklenecek (${startStr} - ${endStr}). Eklemek ister misiniz?`;
            
            if (confirm(message)) {
                addNewWeekFromDate(nextMonday);
                return true; // Yeni hafta olu≈üturuldu
            }
            return false; // ƒ∞ptal edildi
        }

        // Add New Week From Specific Date
        function addNewWeekFromDate(startDate) {
            const weekNumber = weeks.length + 1;

            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            renderWeekContent();
            showToast('Yeni hafta eklendi');
        }

        // Format Date Turkish
        function formatDateTurkish(date) {
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                           'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Modal Functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
        }

        function openSettings() {
            // Aktif hafta tabƒ±nƒ±n numarasƒ±nƒ± ve diyet t√ºr√ºn√º al
            const activeWeek = weeks[currentWeekIndex];
            const weekNumber = currentWeekIndex + 1;
            
            // Hafta numarasƒ±na g√∂re default diyet t√ºr√º
            let suggestedDiet = 'ketojenik'; // Varsayƒ±lan
            
            if (weekNumber >= 1 && weekNumber <= 2) {
                suggestedDiet = 'eliminasyonlu-ketojenik';
            } else if (weekNumber >= 3 && weekNumber <= 9) {
                suggestedDiet = 'ketojenik';
            } else if (weekNumber >= 10 && weekNumber <= 13) {
                suggestedDiet = 'lowcarb';
            } else if (weekNumber >= 14) {
                suggestedDiet = 'ketojenik';
            }
            
            // √ñncelik: Haftanƒ±n kendi diyet t√ºr√º > √ñnerilen diyet > Mevcut ayar
            if (activeWeek && activeWeek.dietType) {
                settings.dietType = activeWeek.dietType; // Hafta zaten bir diyet t√ºr√ºne sahip
            } else if (!settings.dietType || settings.dietType === '') {
                settings.dietType = suggestedDiet; // Kullanƒ±cƒ± hi√ß ayar yapmamƒ±≈üsa √∂neriyi kullan
            }
            
            // Label'ƒ± g√ºncelle
            const dietTypeLabel = document.getElementById('dietTypeLabel');
            if (dietTypeLabel) {
                dietTypeLabel.innerHTML = `Diyet T√ºr√º <span style="color: #999; font-size: 12px; font-weight: normal;">(${weekNumber}. hafta i√ßin)</span>`;
            }
            
            applySettingsToForm();
            
            // Modal'ƒ± a√ß
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex';
            }
            
            console.log(`üìã ${weekNumber}. hafta i√ßin ayarlar a√ßƒ±ldƒ±. Diyet t√ºr√º:`, settings.dietType);
        }

        // Download All Data (for GitHub upload)
        function downloadAllData() {
            if (!currentPatient) {
                showToast('Hasta bilgisi bulunamadƒ±', 'error');
                return;
            }

            // Download both settings and weeks
            NutritionDataManager.downloadAllData(
                currentPatient.id,
                currentPatient.name,
                { settings: settings },
                weeks
            );

            showToast('Veriler indirildi! L√ºtfen nutrition/ klas√∂r√ºne y√ºkleyin.');
        }

        // Logout
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                PatientAuth.logout();
                window.location.href = 'login.html';
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        // Bug√ºn√ºn tarihi mi kontrol et
        function isTodayDate(dateString) {
            if (!dateString) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const checkDate = new Date(dateString);
            checkDate.setHours(0, 0, 0, 0);
            
            return checkDate.getTime() === today.getTime();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        /**
         * üîî ≈ûablon d√ºzenleme modalƒ± i√ßin √∂zel bildirim
         * Modal i√ßinde kƒ±sa s√ºreliƒüine g√∂r√ºn√ºr, fade-out animasyonuyla kaybolur
         * @param {string} message - Bildirim mesajƒ±
         * @param {string} type - success, error, warning, info
         */
        function showTemplateEditNotification(message, type = 'success') {
            // Bildirim container'ƒ± olu≈ütur (yoksa)
            let notifContainer = document.getElementById('templateEditNotifContainer');
            if (!notifContainer) {
                notifContainer = document.createElement('div');
                notifContainer.id = 'templateEditNotifContainer';
                notifContainer.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    z-index: 10002;
                    pointer-events: none;
                `;
                document.body.appendChild(notifContainer);
            }
            
            // Renk se√ßimi
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            
            // Bildirim elementi
            const notif = document.createElement('div');
            notif.style.cssText = `
                background: ${colors[type] || colors.success};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                opacity: 0;
                transform: translateX(100px);
                transition: all 0.3s ease;
                pointer-events: auto;
            `;
            notif.textContent = message;
            
            notifContainer.appendChild(notif);
            
            // Fade-in animasyonu
            setTimeout(() => {
                notif.style.opacity = '1';
                notif.style.transform = 'translateX(0)';
            }, 10);
            
            // 2 saniye sonra fade-out ve kaldƒ±r
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(100px)';
                
                setTimeout(() => {
                    notif.remove();
                }, 300);
            }, 2000);
        }

        // ========================================
        // ADMIN MATCHING MODAL FONKSƒ∞YONLARI
        // ========================================

        // Admin kontrol√º
        function checkAdminPermission() {
            // AdminAuth varsa session kontrol√º yap
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession) {
                const session = AdminAuth.getSession();
                if (session && session.username) {
                    console.log('‚úÖ Admin kullanƒ±cƒ±:', session.username);
                    return true;
                }
            }
            return false;
        }

        // ========================================
        // ADMIN FONKSƒ∞YONLARI
        // ========================================

        // Admin yetkisi kontrol√º
        function checkAdminPermission() {
            // 1. window.currentPatient kontrol√º (ana sistem)
            if (window.currentPatient && window.currentPatient.isAdmin === true) {
                console.log('üëë Admin kullanƒ±cƒ± (currentPatient):', window.currentPatient.name || 'Bilinmeyen');
                return true;
            }
            
            // 2. PatientAuth session kontrol√º
            if (typeof PatientAuth !== 'undefined' && PatientAuth.getSession) {
                const session = PatientAuth.getSession();
                if (session && session.isAdmin === true) {
                    console.log('üëë Admin kullanƒ±cƒ± (PatientAuth session):', session.username);
                    return true;
                }
            }
            
            // 3. localStorage'dan session kontrol√º
            try {
                const sessionStr = localStorage.getItem('patient_session');
                if (sessionStr) {
                    const session = JSON.parse(sessionStr);
                    if (session.isAdmin === true) {
                        console.log('üëë Admin kullanƒ±cƒ± (localStorage session):', session.username);
                        return true;
                    }
                }
            } catch (e) {
                console.warn('Session kontrol√º ba≈üarƒ±sƒ±z:', e);
            }
            
            // 4. AdminAuth y√ºkl√º m√º? (yedek kontrol)
            if (typeof AdminAuth !== 'undefined' && AdminAuth.getSession) {
                const session = AdminAuth.getSession();
                if (session && session.username) {
                    console.log('üëë Admin oturum bulundu (AdminAuth):', session.username);
                    return true;
                }
            }
            
            // 5. Fallback: localStorage'dan role kontrol√º (eski sistem)
            try {
                const userRole = localStorage.getItem('userRole');
                if (userRole === 'admin') {
                    console.log('üëë Admin (localStorage role)');
                    return true;
                }
            } catch (e) {
                console.warn('localStorage role kontrol√º ba≈üarƒ±sƒ±z:', e);
            }
            
            console.log('‚ùå Admin yetkisi bulunamadƒ±');
            return false;
        }

        // Admin butonunu g√∂ster/gizle
        function initAdminUI() {
            const isAdmin = checkAdminPermission();
            const adminBtn = document.getElementById('adminMatchingBtn');
            
            if (isAdmin && adminBtn) {
                adminBtn.style.display = 'inline-block';
                console.log('üëë Admin UI aktif');
            } else {
                console.log('üë§ Normal kullanƒ±cƒ± - Admin √∂zellikleri gizli');
            }
            
            // üîê Admin √∂zelliklerini g√∂ster/gizle (yemek satƒ±rlarƒ±ndaki ‚öôÔ∏è ikonlarƒ±)
            toggleAdminFeatures();
        }

        // Admin modal a√ß
        function openAdminMatchingModal(foodName = '', foodData = {}) {
            if (!checkAdminPermission()) {
                showToast('‚ùå Bu √∂zellik sadece admin kullanƒ±cƒ±lar i√ßindir!', 'error');
                return;
            }

            // 6 TABLI ADMIN MODAL'I A√á (adminFoodModal)
            const modal = document.getElementById('adminFoodModal');
            if (!modal) {
                console.error('‚ùå adminFoodModal bulunamadƒ±!');
                return;
            }

            // Global currentFoodName'i set et
            currentFoodName = foodName;
            
            // Modal ba≈ülƒ±ƒüƒ±na yemek adƒ±nƒ± yaz
            const modalFoodName = document.getElementById('modal_food_name');
            if (modalFoodName) {
                modalFoodName.textContent = foodName;
            }
            
            // T√úM TABLARA YEMEK ADINI DOLDUR
            const manuelYemekAdi = document.getElementById('admin_manuel_yemek_adi');
            const yasakYemekAdi = document.getElementById('admin_yasak_yemek_adi');
            const dbYemekAdi = document.getElementById('admin_db_yemek_adi');
            const dbYasakYemekAdi = document.getElementById('admin_db_yasak_yemek_adi');
            const dbEkleYemekAdi = document.getElementById('admin_db_ekle_yemek_adi');
            
            if (manuelYemekAdi) manuelYemekAdi.value = foodName;
            if (yasakYemekAdi) yasakYemekAdi.value = foodName;
            if (dbYemekAdi) dbYemekAdi.value = foodName;
            if (dbYasakYemekAdi) dbYasakYemekAdi.value = foodName;
            if (dbEkleYemekAdi) dbEkleYemekAdi.value = foodName;
            
            // VERITABANINA EKLE SEKMESINI DEFAULT OLARAK DOLDUR
            const safeSetValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value || '';
            };
            const safeSetChecked = (id, checked) => {
                const el = document.getElementById(id);
                if (el) el.checked = checked || false;
            };
            
            // Men√º kartƒ±ndan gelen makrolarƒ± doldur
            safeSetValue('admin_db_ekle_protein', foodData.protein || 0);
            safeSetValue('admin_db_ekle_karb', foodData.carbs || foodData.karbonhidrat || 0);
            safeSetValue('admin_db_ekle_yag', foodData.fat || foodData.yag || 0);
            
            // Kalori otomatik hesapla
            if (typeof calculateKaloriForAddFood === 'function') {
                calculateKaloriForAddFood();
            }
            
            // DEFAULT DEƒûERLER
            safeSetValue('admin_db_ekle_min', 1);
            safeSetValue('admin_db_ekle_max', 1);
            safeSetValue('admin_db_ekle_step', 1);
            safeSetValue('admin_db_ekle_portion', 1);
            safeSetValue('admin_db_ekle_portion2', 1);
            safeSetValue('admin_db_ekle_season_min', 1);
            safeSetValue('admin_db_ekle_season_max', 12);
            
            // Kategori ve Rol men√º kartƒ±ndan geliyorsa doldur, yoksa bo≈ü bƒ±rak
            safeSetValue('admin_db_ekle_kategori', foodData.category || '');
            safeSetValue('admin_db_ekle_rol', foodData.role || '');
            
            // Diƒüer alanlarƒ± temizle/varsayƒ±lan yap
            safeSetValue('admin_db_ekle_tags', '');
            safeSetValue('admin_db_ekle_compat', '');
            safeSetValue('admin_db_ekle_incompat', '');
            safeSetValue('admin_db_ekle_notes', '');
            
            // Checkboxlarƒ± temizle
            safeSetChecked('admin_mealType_breakfast', false);
            safeSetChecked('admin_mealType_lunch', false);
            safeSetChecked('admin_mealType_dinner', false);
            safeSetChecked('admin_dietType_ketojenik', false);
            safeSetChecked('admin_dietType_akdeniz', false);
            safeSetChecked('admin_dietType_vegan', false);
            safeSetChecked('admin_dietType_glutensiz', false);
            safeSetChecked('admin_keto', false);
            safeSetChecked('admin_lowcarb', false);
            safeSetChecked('admin_portionFixed', false);
            safeSetChecked('admin_fillerLunch', false);
            safeSetChecked('admin_fillerDinner', false);
            safeSetChecked('admin_reversedSeason', false);
            
            // VERITABANINA EKLE TAB'INI AKTƒ∞F YAP
            switchAdminTab('db-ekle');
            
            // MODAL'I A√á
            modal.style.display = 'block';
            
            console.log('‚úÖ Admin Food Modal a√ßƒ±ldƒ± - Veritabanƒ±na Ekle tab aktif - Yemek:', foodName);
        }

        // Admin modal kapat
        function closeAdminMatchingModal() {
            const modal = document.getElementById('adminMatchingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Tab deƒüi≈ütir (5 TAB MODAL i√ßin)
        function switchAdminTab(tabName) {
            console.log('üîÑ Tab deƒüi≈ütir:', tabName);
            
            // T√ºm tab i√ßeriklerini gizle
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // T√ºm tab butonlarƒ±nƒ± pasif yap
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#ccc';
                btn.style.color = '#666';
            });
            
            // Se√ßili tab'ƒ± g√∂ster
            const tabId = `admin-tab-${tabName}`;
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                console.log(`‚úÖ Tab i√ßeriƒüi g√∂steriliyor: ${tabId}`);
                tabContent.style.display = 'block';
            } else {
                console.error(`‚ùå Tab i√ßeriƒüi bulunamadƒ±: ${tabId}`);
            }
            
            // Se√ßili butonun stilini g√ºncelle
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (tabName === 'manuel') {
                    activeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                } else if (tabName === 'yasak') {
                    activeBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
                } else if (tabName === 'db-eslestirme') {
                    activeBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)';
                } else if (tabName === 'db-yasak') {
                    activeBtn.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                } else if (tabName === 'db-ekle') {
                    activeBtn.style.background = 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)';
                } else if (tabName === 'github-settings') {
                    activeBtn.style.background = 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)';
                }
                activeBtn.style.color = 'white';
            }
            
            // Tab'a √∂zel render fonksiyonlarƒ±nƒ± √ßaƒüƒ±r
            setTimeout(() => {
                if (tabName === 'manuel') {
                    console.log('üìù Manuel e≈üle≈ütirme tab\'ƒ± render ediliyor...');
                    renderTarifManuelTab();
                } else if (tabName === 'yasak') {
                    console.log('üö´ Yasak kurallarƒ± tab\'ƒ± render ediliyor...');
                    renderTarifYasakTab();
                } else if (tabName === 'db-eslestirme') {
                    console.log('üçΩÔ∏è Veritabanƒ± e≈üle≈ütirme tab\'ƒ± render ediliyor...');
                    renderYemekEslestirmeTab();
                } else if (tabName === 'db-yasak') {
                    console.log('‚õî Veritabanƒ± yasaklarƒ± tab\'ƒ± render ediliyor...');
                    renderYemekYasakTab();
                }
            }, 100);
        }

        // Placeholder render fonksiyonlarƒ± (sonra doldurulacak)
        function renderTarifManuelTab() {
            console.log('üé¨ renderTarifManuelTab √ßaƒürƒ±ldƒ±');
            
            // ‚úÖ DOƒûRU DIV: admin-tab-manuel (statik HTML modal i√ßinde)
            const content = document.getElementById('admin-tab-manuel');
            if (!content) {
                console.error('‚ùå admin-tab-manuel div bulunamadƒ±!');
                return;
            }
            
            console.log('‚úÖ admin-tab-manuel div bulundu, i√ßerik render ediliyor...');
            
            // Se√ßili yemek adƒ±nƒ± al
            const foodName = window.selectedFoodForAdmin?.foodName || currentFoodName || '';
            
            // ÔøΩ HER TAB A√áILI≈ûINDA G√úNCEL VERƒ∞Yƒ∞ YENƒ∞LE (GitHub'dan y√ºklenmi≈ü son hali)
            console.log('üîÑ Manuel e≈üle≈ütirmeler g√ºncelleniyor (GitHub son hali)...');
            
            // Manuel e≈üle≈ütirmeler varsa kullan, yoksa otomatik e≈üle≈üenleri bul
            if (manuelEslestirmeler[foodName]) {
                // GitHub'dan y√ºklenmi≈ü manuel e≈üle≈ütirme var
                const manuelData = manuelEslestirmeler[foodName];
                manualMatches[foodName] = (typeof manuelData === 'object' && manuelData.kartlar) 
                    ? manuelData.kartlar 
                    : (Array.isArray(manuelData) ? manuelData : []);
                console.log('‚úÖ GitHub\'dan manuel e≈üle≈ütirme y√ºklendi:', manualMatches[foodName]);
            } else if (!manualMatches[foodName]) {
                // GitHub'da yok ve local state'de de yok ‚Üí Otomatik e≈üle≈üenleri bul
                console.log('üîç Otomatik e≈üle≈üen kartlar aranƒ±yor:', foodName);
                
                const autoMatchedCards = findTarifKartlari(foodName);
                
                if (autoMatchedCards && autoMatchedCards.length > 0) {
                    manualMatches[foodName] = autoMatchedCards.map(card => {
                        const fileName = typeof card === 'string' 
                            ? card 
                            : (card.file || card.name || '');
                        
                        return fileName.match(/\.(jpg|jpeg|png)$/i) 
                            ? fileName 
                            : `${fileName}.jpg`;
                    }).filter(Boolean);
                    
                    console.log('‚úÖ Otomatik e≈üle≈üen kartlar y√ºklendi:', manualMatches[foodName]);
                } else {
                    manualMatches[foodName] = [];
                    console.log('‚ÑπÔ∏è Otomatik e≈üle≈üme bulunamadƒ±');
                }
            } else {
                console.log('‚ÑπÔ∏è Local state\'de manuel e≈üle≈ütirmeler var:', manualMatches[foodName]);
            }
            
            // HTML render
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üìù Manuel E≈üle≈ütirme (Tarif Kartlarƒ±)</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        Men√º kartƒ±ndaki "<strong>${foodName}</strong>" yemeƒüini tarif kartlarƒ±yla e≈üle≈ütirin.
                        <br><small>üí° ƒ∞pucu: "dom √ßor" yazarak "domates √ßorbasƒ±" kartƒ±nƒ± bulabilirsiniz.</small>
                    </p>
                    
                    <!-- Se√ßili Tarif Kartlarƒ± Listesi -->
                    <div class="selected-tarif-list" id="selectedTarifList">
                        <div class="selected-tarif-list-title">
                            ‚úÖ Se√ßili Tarif Kartlarƒ±
                        </div>
                        <div class="selected-tarif-tags" id="selectedTarifTags">
                            <span class="selected-tarif-empty">Hen√ºz kart se√ßilmedi. A≈üaƒüƒ±daki kartlardan tƒ±klayarak se√ßin.</span>
                        </div>
                    </div>
                    
                    <!-- Search Input -->
                    <div class="tarif-search-container">
                        <input type="text" 
                               class="tarif-search-input" 
                               id="tarifSearchInput" 
                               placeholder="üîç Tarif kartƒ± ara... (√∂rn: dom √ßor, kuru fas)"
                               oninput="searchTarifCards(this.value)"
                               autocomplete="off">
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">
                            üí° ƒ∞pucu: Kƒ±saltmalar kullanabilirsiniz (dom √ßor, √ßor dom, vs.)
                        </p>
                    </div>
                    
                    <!-- Tarif Kartlarƒ± Grid -->
                    <div class="tarif-grid" id="tarifCardsGrid">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Tarif kartlarƒ± y√ºkleniyor...
                        </div>
                    </div>
                    
                    <!-- Kaydet Butonu -->
                    <div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button onclick="saveManualMatches()" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            üíæ E≈üle≈ütirmeyi Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            console.log('‚úÖ HTML render edildi, ≈üimdi tarif kartlarƒ± y√ºklenecek...');
            
            // Tarif kartlarƒ±nƒ± y√ºkle ve render et
            loadAndRenderTarifCards();
        }

        function renderTarifYasakTab() {
            console.log('üé¨ renderTarifYasakTab √ßaƒürƒ±ldƒ±');
            
            const content = document.getElementById('admin-tab-yasak');
            if (!content) {
                console.error('‚ùå admin-tab-yasak div bulunamadƒ±!');
                return;
            }
            
            console.log('‚úÖ admin-tab-yasak div bulundu, i√ßerik render ediliyor...');
            
            // üîÑ HER TAB A√áILI≈ûINDA G√úNCEL VERƒ∞Yƒ∞ YENƒ∞LE (GitHub'dan y√ºklenmi≈ü son hali)
            console.log('üîÑ Yasak kurallarƒ± g√ºncelleniyor (GitHub son hali)...');
            
            // Yemek adƒ±nƒ± temizle (eslestirme.html mantƒ±ƒüƒ± ile aynƒ± key'i kullan)
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G')
                .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                .trim();
            
            // GitHub'dan y√ºklenmi≈ü yasak kurallarƒ±nƒ± al (hem orijinal hem temizlenmi≈ü key ile)
            let yasakData = eslesmemeKurallari[currentFoodName] || eslesmemeKurallari[lowercaseSpaced];
            let currentBanned = [];
            
            if (yasakData && typeof yasakData === 'object' && !Array.isArray(yasakData)) {
                // GitHub format: { orijinalMetin, yasakliKartlar, eklemeTarihi }
                currentBanned = yasakData.yasakliKartlar || yasakData.kartlar || [];
                console.log('‚úÖ GitHub\'dan yasak kuralƒ± y√ºklendi:', currentBanned);
            } else if (Array.isArray(yasakData)) {
                // Eski format: direkt array
                currentBanned = yasakData;
                console.log('‚úÖ Eski formatta yasak kuralƒ± y√ºklendi:', currentBanned);
            } else {
                console.log('‚ÑπÔ∏è Yasak kuralƒ± bulunamadƒ±');
            }
            
            // Local state'i g√ºncelle (array olarak sakla)
            eslesmemeKurallari[currentFoodName] = currentBanned;
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #f44336; font-size: 20px;">
                        üö´ Yasak Tarif Kartlarƒ±
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> i√ßin <strong>yanlƒ±≈ü</strong> e≈üle≈üecek tarif kartlarƒ±nƒ± se√ßin
                    </p>
                    
                    <!-- Se√ßili Yasak Kartlar (Badge'ler) -->
                    <div id="selectedBannedTags" style="min-height: 50px; background: #fff3f3; border: 2px dashed #f44336; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input -->
                    <input 
                        type="text" 
                        id="bannedSearchInput" 
                        placeholder="üîç Tarif kartƒ± ara..." 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #f44336; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchBannedCards(this.value)"
                    />
                    
                    <!-- Tarif Kartlarƒ± Grid -->
                    <div id="bannedCardsGrid" class="tarif-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveBannedMatches()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    üíæ Yasak Kurallarƒ±nƒ± Kaydet
                </button>
            `;
            
            console.log('‚úÖ HTML render edildi, ≈üimdi yasak kartlarƒ± y√ºklenecek...');
            
            // Tarif kartlarƒ±nƒ± y√ºkle ve render et
            loadAndRenderBannedCards();
        }

        // ========================================
        // TAB 3: YEMEK VERƒ∞TABANI MANUEL E≈ûLE≈ûTƒ∞RME
        // ========================================
        function renderYemekEslestirmeTab() {
            console.log('üé¨ renderYemekEslestirmeTab √ßaƒürƒ±ldƒ±');
            
            const content = document.getElementById('admin-tab-db-eslestirme');
            if (!content) {
                console.error('‚ùå admin-tab-db-eslestirme div bulunamadƒ±!');
                return;
            }
            
            // üîÑ GitHub'dan y√ºklenmi≈ü manuel e≈üle≈ütirmeleri al
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                .trim();
            
            let currentManuelMatch = null;
            if (yemekVeritabaniEslestirme[currentFoodName]) {
                currentManuelMatch = yemekVeritabaniEslestirme[currentFoodName];
            } else if (yemekVeritabaniEslestirme[lowercaseSpaced]) {
                currentManuelMatch = yemekVeritabaniEslestirme[lowercaseSpaced];
            }
            
            // √ñnceden e≈üle≈ütirilmi≈ü yemekler (ARRAY formatƒ± - yeni sistem)
            let previousMatchedFoods = [];
            if (currentManuelMatch) {
                // YENƒ∞ FORMAT: hedefYemekler (array)
                if (Array.isArray(currentManuelMatch.hedefYemekler)) {
                    previousMatchedFoods = currentManuelMatch.hedefYemekler;
                    console.log(`‚úÖ GitHub'dan manuel e≈üle≈ütirmeler y√ºklendi (${previousMatchedFoods.length} yemek):`, previousMatchedFoods);
                }
                // ESKƒ∞ FORMAT: hedefYemek (string) - geriye d√∂n√ºk uyumluluk
                else if (currentManuelMatch.hedefYemek) {
                    previousMatchedFoods = [currentManuelMatch.hedefYemek];
                    console.log('‚úÖ GitHub\'dan manuel e≈üle≈ütirme y√ºklendi (eski format):', currentManuelMatch.hedefYemek);
                }
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea; font-size: 20px;">
                        üçΩÔ∏è Yemek Veritabanƒ± Manuel E≈üle≈ütirme (√áOK SE√áƒ∞MLƒ∞)
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> i√ßin <strong>food_list.json</strong>'da hangi yemekler kullanƒ±lsƒ±n?
                        <br><small style="color: #999;">üí° Birden fazla yemek se√ßerseniz, haftalƒ±k men√ºde <strong>sƒ±rayla</strong> rotasyon yapƒ±lƒ±r.</small>
                    </p>
                    
                    <!-- Se√ßili Yemekler (√áOK SE√áƒ∞MLƒ∞ - Checkboxlar ile) -->
                    <div id="selectedFoodMatch" style="min-height: 80px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border: 2px dashed #667eea; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input (Akƒ±llƒ± Fuzzy Search) -->
                    <input 
                        type="text" 
                        id="foodDbSearchInput" 
                        placeholder="üîç Yemek ara... (√∂rn: mer √ßor ‚Üí Mercimek √áorbasƒ±)" 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchFoodDatabase(this.value)"
                    />
                    
                    <!-- Yemek Listesi (food_list.json) - CHECKBOX ile √ßoklu se√ßim -->
                    <div id="foodDatabaseList" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Yemekler y√ºkleniyor...
                        </div>
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveYemekEslestirme()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    üíæ Manuel E≈üle≈ütirmeleri Kaydet
                </button>
            `;
            
            console.log('‚úÖ HTML render edildi, ≈üimdi yemek veritabanƒ± y√ºklenecek...');
            
            // food_list.json y√ºkle ve render et (ARRAY parametresi)
            loadAndRenderFoodDatabase(previousMatchedFoods);
        }
        
        // ========================================
        // TAB 4: YEMEK VERƒ∞TABANI YASAKLARI
        // ========================================
        function renderYemekYasakTab() {
            console.log('üé¨ renderYemekYasakTab √ßaƒürƒ±ldƒ±');
            
            const content = document.getElementById('admin-tab-db-yasak');
            if (!content) {
                console.error('‚ùå admin-tab-db-yasak div bulunamadƒ±!');
                return;
            }
            
            // üîÑ GitHub'dan y√ºklenmi≈ü yasak kurallarƒ±nƒ± al
            const cleanedName = currentFoodName
                .replace(/\s*\([^)]*\)/g, '')
                .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '')
                .trim();
            
            const lowercaseSpaced = cleanedName.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                .trim();
            
            let currentYasakData = null;
            if (yemekVeritabaniYasaklar[currentFoodName]) {
                currentYasakData = yemekVeritabaniYasaklar[currentFoodName];
            } else if (yemekVeritabaniYasaklar[lowercaseSpaced]) {
                currentYasakData = yemekVeritabaniYasaklar[lowercaseSpaced];
            }
            
            // √ñnceden yasaklanmƒ±≈ü yemekler
            let previousBannedFoods = [];
            if (currentYasakData && currentYasakData.yasaklananYemekler) {
                previousBannedFoods = currentYasakData.yasaklananYemekler;
                console.log('‚úÖ GitHub\'dan yasak kurallarƒ± y√ºklendi:', previousBannedFoods);
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #ff9800; font-size: 20px;">
                        üö´ Yemek Veritabanƒ± Yasaklarƒ±
                    </h3>
                    <p style="color: #666; font-size: 14px; margin: 0 0 20px 0;">
                        <strong>${currentFoodName}</strong> i√ßin <strong>food_list.json</strong>'da hangi yemekler kullanƒ±lmasƒ±n?
                        <br><small style="color: #999;">‚ö†Ô∏è Se√ßtiƒüiniz yemekler, bu men√º kartƒ± i√ßin asla kullanƒ±lmayacak.</small>
                    </p>
                    
                    <!-- Se√ßili Yasak Yemekler (√áoklu Se√ßim - Badge'ler) -->
                    <div id="selectedBannedFoods" style="min-height: 80px; background: #fff8e1; border: 2px dashed #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    
                    <!-- Arama Input (Akƒ±llƒ± Fuzzy Search) -->
                    <input 
                        type="text" 
                        id="foodBanSearchInput" 
                        placeholder="üîç Yasak yemek ara... (√∂rn: kab √ßek ‚Üí Kabak √áekirdekli Kraker)" 
                        style="width: 100%; padding: 12px 15px; border: 2px solid #ff9800; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
                        oninput="searchBannedFoods(this.value)"
                    />
                    
                    <!-- Yemek Listesi (food_list.json - √áoklu Se√ßim) -->
                    <div id="foodBanList" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Yemekler y√ºkleniyor...
                        </div>
                    </div>
                </div>
                
                <!-- Kaydet Butonu -->
                <button onclick="saveYemekYasaklar()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                    üíæ Yasak Kurallarƒ±nƒ± Kaydet
                </button>
            `;
            
            console.log('‚úÖ HTML render edildi, ≈üimdi yasak yemekler y√ºklenecek...');
            
            // food_list.json y√ºkle ve render et
            loadAndRenderBannedFoods(previousBannedFoods);
        }

        // ========================================
        // TAB 1: TARƒ∞F KARTLARI - AKILLI SEARCH FONKSƒ∞YONLARI
        // ========================================
        
        // Tarif kartlarƒ±nƒ± y√ºkle ve render et
        async function loadAndRenderTarifCards() {
            console.log('üì• loadAndRenderTarifCards ba≈üladƒ±');
            
            try {
                // ‚úÖ GitHub Raw URL kullan (CORS hatasƒ± √∂nlemek i√ßin)
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json?t=' + Date.now());
                console.log('üì° Fetch response:', response.status, response.ok);
                
                if (!response.ok) throw new Error('Tarif listesi y√ºklenemedi');
                
                const tarifList = await response.json();
                console.log('üìã Tarif listesi alƒ±ndƒ±:', tarifList.length, 'item');
                
                // Global array'e kaydet
                tarifKartlari = tarifList.map(item => {
                    // String mi object mi kontrol et
                    const fileName = typeof item === 'string' ? item : (item.file || item.name || item);
                    
                    // Dosya adƒ±ndan isim √ßƒ±kar: "domates_corbasi.jpg" ‚Üí "domates √ßorbasƒ±"
                    const displayName = fileName.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return {
                        file: fileName,  // "kabak_sote.jpg" (alt √ßizgili, uzantƒ±lƒ±)
                        name: displayName,  // "kabak sote" (bo≈üluklu, uzantƒ±sƒ±z - g√∂r√ºnt√ºleme i√ßin)
                        tags: (typeof item === 'object' && item.tags) ? item.tags : [],
                        imagePath: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${fileName}` // ‚úÖ GitHub Raw URL
                    };
                });
                
                console.log('‚úÖ tarifKartlari global array:', tarifKartlari.length, 'kart');
                console.log('üìã ƒ∞lk 3 kart:', tarifKartlari.slice(0, 3).map(t => t.name));
                
                // ƒ∞lk render (se√ßililer √ºstte)
                renderTarifKartlari(tarifKartlari);
                
            } catch (error) {
                console.error('‚ùå Tarif kartlarƒ± y√ºklenirken hata:', error);
                const grid = document.getElementById('tarifCardsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            ‚ùå Tarif kartlarƒ± y√ºklenemedi!<br>
                            <small>${error.message}</small>
                        </div>
                    `;
                } else {
                    console.error('‚ùå Grid element bulunamadƒ±!');
                }
            }
        }
        
        // Fuzzy search - "dom √ßor" ‚Üí "domates √ßorbasƒ±"
        function searchTarifCards(query) {
            if (!query || query.trim() === '') {
                // Bo≈üsa t√ºm kartlarƒ± g√∂ster (se√ßililer √ºstte)
                renderTarifKartlari(tarifKartlari);
                return;
            }
            
            const normalizedQuery = normalizeTr(query);
            const queryTokens = normalizedQuery.split(/\s+/).filter(t => t.length > 0);
            
            // Fuzzy match: Her query token'ƒ± tarif adƒ±nda var mƒ±?
            const filtered = tarifKartlari.filter(tarif => {
                const normalizedName = normalizeTr(tarif.name);
                
                // T√ºm query token'larƒ± tarif adƒ±nda olmalƒ±
                return queryTokens.every(token => {
                    // Token tam e≈üle≈üme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kƒ±saltma: "dom" ‚Üí "domates", "√ßor" ‚Üí "√ßorbasƒ±"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderTarifKartlari(filtered);
        }
        
        // Tarif kartlarƒ±nƒ± ekranda g√∂ster (se√ßililer √ºstte)
        function renderTarifKartlari(tarifler) {
            console.log('üîç renderTarifKartlari √ßaƒürƒ±ldƒ±:', {
                tariflerCount: tarifler?.length,
                currentFoodName: currentFoodName,
                gridElement: document.getElementById('tarifCardsGrid')
            });
            
            const grid = document.getElementById('tarifCardsGrid');
            if (!grid) {
                console.error('‚ùå Grid element bulunamadƒ±! ID: tarifCardsGrid');
                return;
            }
            
            if (!tarifler || tarifler.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; grid-column: 1 / -1;">
                        üîç E≈üle≈üen tarif bulunamadƒ±
                    </div>
                `;
                return;
            }
            
            // Se√ßili kartlar √ºstte, se√ßili olmayanlar altta
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º (GitHub JSON format: {kartlar: [...], guncellemeTarihi: ...})
            let currentMatchData = manualMatches[currentFoodName] || [];
            const currentMatches = Array.isArray(currentMatchData) 
                ? currentMatchData 
                : (currentMatchData.kartlar || []);
            
            console.log('ÔøΩ Mevcut e≈üle≈ütirmeler (array):', currentMatches);
            console.log('üîç DEBUG - currentFoodName:', currentFoodName);
            
            const sorted = [...tarifler].sort((a, b) => {
                const aSelected = currentMatches.includes(a.file);
                const bSelected = currentMatches.includes(b.file);
                console.log(`üîç DEBUG - Kart: "${a.file}", selected: ${aSelected}`);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return 0;
            });
            
            console.log('‚úÖ Render ediliyor:', sorted.length, 'kart');
            
            grid.innerHTML = sorted.map(tarif => {
                const isSelected = currentMatches.includes(tarif.file);
                return `
                    <div class="tarif-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleTarifSelection('${tarif.file.replace(/'/g, "\\'")}')">
                        <img src="${tarif.imagePath}" 
                             alt="${tarif.name}"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-size=\\'14\\'%3E${tarif.name.slice(0,2)}%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarif.name}</div>
                    </div>
                `;
            }).join('');
            
            console.log('‚úÖ Grid innerHTML set edildi');
            
            // Se√ßili kartlarƒ± g√ºncelle (YENI!)
            updateSelectedTarifList();
        }
        
        // Kart se√ßim toggle
        function toggleTarifSelection(tarifName) {
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            if (!manualMatches[currentFoodName]) {
                manualMatches[currentFoodName] = [];
            }
            
            // GitHub format ise array'e √ßevir
            let currentArray = Array.isArray(manualMatches[currentFoodName])
                ? manualMatches[currentFoodName]
                : (manualMatches[currentFoodName].kartlar || []);
            
            const index = currentArray.indexOf(tarifName);
            
            if (index === -1) {
                // Ekle
                currentArray.push(tarifName);
            } else {
                // √áƒ±kar
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet (array formatƒ±nda)
            manualMatches[currentFoodName] = currentArray;
            
            // Search input deƒüerini koru
            const searchInput = document.getElementById('tarifSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            // Yeniden render (search varsa filtrelenmi≈ü, yoksa tam liste)
            if (currentQuery) {
                searchTarifCards(currentQuery);
            } else {
                renderTarifKartlari(tarifKartlari);
            }
            
            // Se√ßili kartlarƒ± g√ºncelle (YENI!)
            updateSelectedTarifList();
        }
        
        // Se√ßili tarif kartlarƒ± listesini g√ºncelle (YENI FONKSIYON!)
        function updateSelectedTarifList() {
            const container = document.getElementById('selectedTarifTags');
            if (!container) return;
            
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            let selectedData = manualMatches[currentFoodName] || [];
            const selectedCards = Array.isArray(selectedData) 
                ? selectedData 
                : (selectedData.kartlar || []);
            
            if (selectedCards.length === 0) {
                container.innerHTML = '<span class="selected-tarif-empty">Hen√ºz kart se√ßilmedi. A≈üaƒüƒ±daki kartlardan tƒ±klayarak se√ßin.</span>';
            } else {
                container.innerHTML = selectedCards.filter(Boolean).map(cardFile => {
                    // Dosya adƒ±ndan okunabilir isim olu≈ütur: "kabak_sote.jpg" ‚Üí "kabak sote"
                    const displayName = (cardFile || '').replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return `
                        <span class="selected-tarif-tag">
                            ${displayName}
                            <span class="remove-icon" onclick="removeManualMatch('${(cardFile || '').replace(/'/g, "\\'")}')">√ó</span>
                        </span>
                    `;
                }).join('');
            }
        }
        
        // Manuel e≈üle≈ütirme sil (badge √ó butonu)
        function removeManualMatch(matchName) {
            if (!manualMatches[currentFoodName]) return;
            
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            let currentArray = Array.isArray(manualMatches[currentFoodName])
                ? manualMatches[currentFoodName]
                : (manualMatches[currentFoodName].kartlar || []);
            
            const index = currentArray.indexOf(matchName);
            if (index !== -1) {
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet
            manualMatches[currentFoodName] = currentArray;
            
            // Se√ßili kartlarƒ± g√ºncelle
            updateSelectedTarifList();
            
            // Grid'i yeniden render et (selected state'i g√ºncelle)
            const searchInput = document.getElementById('tarifSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            if (currentQuery) {
                searchTarifCards(currentQuery);
            } else {
                renderTarifKartlari(tarifKartlari);
            }
        }
        
        // ========================================
        // GITHUB KAYIT FONKSƒ∞YONLARI
        // ========================================
        
        /**
         * Dosyayƒ± GitHub'a kaydet (PUT API)
         * @param {string} filePath - Dosya yolu (√∂rn: 'data/manuel_eslestirmeler.json')
         * @param {string} content - Dosya i√ßeriƒüi (JSON.stringify ile)
         * @param {string} commitMessage - Commit mesajƒ±
         */
        async function saveToGitHub(filePath, content, commitMessage) {
            const GITHUB_TOKEN = localStorage.getItem('github_token');
            
            if (!GITHUB_TOKEN) {
                throw new Error('GitHub token bulunamadƒ±! L√ºtfen Admin Modal > Tab 6\'dan token girin.');
            }
            
            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const BRANCH = 'main';
            
            try {
                // 1. Mevcut dosyanƒ±n SHA'sƒ±nƒ± al (g√ºncelleme i√ßin gerekli)
                const getUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    console.log(`‚úÖ Dosya SHA alƒ±ndƒ±: ${sha.slice(0, 7)}`);
                }
                
                // 2. ƒ∞√ßeriƒüi Base64'e √ßevir (‚úÖ T√úRK√áE KARAKTER KORUYAN)
                const contentBase64 = encodeBase64UTF8(content);
                
                // 3. Dosyayƒ± GitHub'a kaydet (PUT)
                const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: contentBase64,
                        sha: sha, // G√ºncelleme i√ßin gerekli (yoksa null olur - yeni dosya)
                        branch: BRANCH
                    })
                });
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub kayƒ±t hatasƒ±: ${errorData.message}`);
                }
                
                const result = await putResponse.json();
                console.log('‚úÖ GitHub\'a kaydedildi:', result.commit.sha.slice(0, 7));
                
                return result;
                
            } catch (error) {
                console.error('‚ùå saveToGitHub hatasƒ±:', error);
                throw error;
            }
        }
        
        // Manuel e≈üle≈ütirmeleri kaydet
        async function saveManualMatches() {
            if (!currentFoodName) {
                alert('‚ùå Men√º kartƒ± se√ßilmedi!');
                return;
            }
            
            const matches = manualMatches[currentFoodName] || [];
            
            // üîç Otomatik e≈üle≈üen kartlarƒ± kontrol et
            const autoMatchedCards = findTarifKartlari(currentFoodName);
            const autoMatchedNames = autoMatchedCards.map(card => card.name);
            
            // Otomatik e≈üle≈üenlerle kar≈üƒ±la≈ütƒ±r
            const isSameAsAuto = 
                matches.length === autoMatchedNames.length &&
                matches.every(m => autoMatchedNames.includes(m)) &&
                autoMatchedNames.every(a => matches.includes(a));
            
            if (isSameAsAuto) {
                alert(`‚ÑπÔ∏è Se√ßilen kartlar otomatik e≈üle≈üenlerle aynƒ±.\n\nManuel kayƒ±t yapƒ±lmadƒ± (zaten otomatik e≈üle≈üiyor).`);
                return;
            }
            
            if (matches.length === 0) {
                // Kullanƒ±cƒ± t√ºm kartlarƒ± kaldƒ±rmƒ±≈ü - bu da bir manuel se√ßim
                const confirmDelete = confirm(`‚ö†Ô∏è Hi√ß kart se√ßilmedi.\n\n"${currentFoodName}" i√ßin t√ºm e≈üle≈ütirmeleri kaldƒ±rmak istediƒüinizi onaylƒ±yor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // ‚úÖ FIX: Mevcut manuel_eslestirmeler.json'u G√úVENLƒ∞ ≈üekilde y√ºkle
                let eslestirmeler = {};
                
                try {
                    console.log('üì• Mevcut e≈üle≈ütirmeler GitHub\'dan y√ºkleniyor...');
                    const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json?t=' + Date.now());
                    
                    if (currentData.ok) {
                        const jsonData = await currentData.json();
                        eslestirmeler = jsonData.eslestirmeler || jsonData;
                        console.log(`‚úÖ Mevcut e≈üle≈ütirmeler y√ºklendi: ${Object.keys(eslestirmeler).length} adet`);
                    } else {
                        console.warn(`‚ö†Ô∏è GitHub dosyasƒ± bulunamadƒ± (${currentData.status}), yeni dosya olu≈üturulacak`);
                    }
                } catch (fetchErr) {
                    console.warn('‚ö†Ô∏è GitHub fetch hatasƒ± (yeni dosya olu≈üturulacak):', fetchErr.message);
                }
                
                // G√ºncelle veya ekle
                if (matches.length === 0) {
                    // Bo≈ü e≈üle≈ütirme: Sil
                    delete eslestirmeler[currentFoodName];
                    console.log(`üóëÔ∏è E≈üle≈ütirme silindi: ${currentFoodName}`);
                } else {
                    // ‚úÖ Yeni e≈üle≈ütirme: MEVCUT VERƒ∞Yƒ∞ KORUYARAK EKLE/G√úNCELLE
                    eslestirmeler[currentFoodName] = {
                        kartlar: matches,
                        guncellemeTarihi: new Date().toISOString()
                    };
                    console.log(`üíæ E≈üle≈ütirme kaydedildi: ${currentFoodName} ‚Üí [${matches.join(', ')}]`);
                    console.log(`üìä Toplam e≈üle≈ütirme sayƒ±sƒ±: ${Object.keys(eslestirmeler).length}`);
                }
                
                // GitHub'a kaydet (data/manuel_eslestirmeler.json)
                await saveToGitHub(
                    'data/manuel_eslestirmeler.json',
                    JSON.stringify({ eslestirmeler }, null, 2),
                    `Manuel e≈üle≈ütirme ${matches.length === 0 ? 'silindi' : 'g√ºncellendi'}: ${currentFoodName} (${matches.length} tarif)`
                );
                
                // Global state'i g√ºncelle
                manuelEslestirmeler = eslestirmeler;
                
                alert(`‚úÖ ${matches.length} tarif e≈üle≈ütirildi ve GitHub'a kaydedildi!\n\n${matches.join('\n')}`);
                
                // ‚úÖ SAYFAYI Dƒ∞NAMƒ∞K OLARAK YENƒ∞LE (deƒüi≈üiklik anƒ±nda g√∂r√ºns√ºn)
                console.log('üîÑ Manuel e≈üle≈ütirme kaydedildi, sayfa yenileniyor...');
                renderWeekContent(); // Haftalƒ±k men√ºy√º yenile
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                alert('‚ùå Kaydetme sƒ±rasƒ±nda hata:\n' + error.message);
            }
        }

        // ========================================
        // üö´ YASAK KARTLAR FONKSƒ∞YONLARI (TAB 2)
        // ========================================

        // Yasak kartlarƒ± y√ºkle ve render et
        async function loadAndRenderBannedCards() {
            console.log('üì• loadAndRenderBannedCards ba≈üladƒ±');
            
            // Tarif kartlarƒ± zaten loadTarifKartlari() ile y√ºklendi
            if (tarifKartlari.length === 0) {
                console.warn('‚ö†Ô∏è Tarif kartlarƒ± hen√ºz y√ºklenmemi≈ü, y√ºkleniyor...');
                await loadTarifKartlari();
            }
            
            console.log('üìã Tarif kartlarƒ± hazƒ±r:', tarifKartlari.length);
            
            // Yasak kartlarƒ± render et
            renderBannedKartlari(tarifKartlari);
            
            // Se√ßili yasak kartlarƒ± g√ºncelle
            updateSelectedBannedList();
        }

        // Yasak kartlarƒ±nƒ± grid'e render et
        function renderBannedKartlari(tarifler) {
            const grid = document.getElementById('bannedCardsGrid');
            if (!grid) {
                console.error('‚ùå bannedCardsGrid bulunamadƒ±!');
                return;
            }
            
            // Se√ßili kartlar √ºstte, se√ßili olmayanlar altta
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            let currentBannedData = eslesmemeKurallari[currentFoodName] || [];
            const currentBanned = Array.isArray(currentBannedData) 
                ? currentBannedData 
                : (currentBannedData.kartlar || currentBannedData.yasakKartlar || []);
            
            console.log('üìã Mevcut yasaklar (array):', currentBanned);
            
            const sorted = [...tarifler].sort((a, b) => {
                const aBanned = currentBanned.includes(a.file);
                const bBanned = currentBanned.includes(b.file);
                if (aBanned && !bBanned) return -1;
                if (!aBanned && bBanned) return 1;
                return 0;
            });
            
            grid.innerHTML = sorted.map(tarif => {
                const isBanned = currentBanned.includes(tarif.file);
                return `
                    <div class="tarif-item ${isBanned ? 'selected' : ''}" 
                         style="border-color: ${isBanned ? '#f44336' : '#ddd'}"
                         onclick="toggleBannedSelection('${tarif.file.replace(/'/g, "\\'")}')">
                        <img src="${tarif.imagePath}" 
                             alt="${tarif.name}"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-size=\\'14\\'%3E${tarif.name.slice(0,2)}%3C/text%3E%3C/svg%3E'">
                        <div class="tarif-name">${tarif.name}</div>
                    </div>
                `;
            }).join('');
        }

        // Yasak kart se√ßim toggle
        function toggleBannedSelection(tarifName) {
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            if (!eslesmemeKurallari[currentFoodName]) {
                eslesmemeKurallari[currentFoodName] = [];
            }
            
            // GitHub format ise array'e √ßevir
            let currentArray = Array.isArray(eslesmemeKurallari[currentFoodName])
                ? eslesmemeKurallari[currentFoodName]
                : (eslesmemeKurallari[currentFoodName].kartlar || eslesmemeKurallari[currentFoodName].yasakKartlar || []);
            
            const index = currentArray.indexOf(tarifName);
            
            if (index === -1) {
                // Ekle
                currentArray.push(tarifName);
            } else {
                // √áƒ±kar
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet (array formatƒ±nda)
            eslesmemeKurallari[currentFoodName] = currentArray;
            
            // Search input deƒüerini koru
            const searchInput = document.getElementById('bannedSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            // Grid'i yeniden render et
            if (currentQuery) {
                searchBannedCards(currentQuery);
            } else {
                renderBannedKartlari(tarifKartlari);
            }
            
            // Se√ßili kartlarƒ± g√ºncelle
            updateSelectedBannedList();
        }

        // Yasak kartlarƒ± ara
        function searchBannedCards(query) {
            if (!query || query.trim() === '') {
                renderBannedKartlari(tarifKartlari);
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            const filtered = tarifKartlari.filter(tarif => 
                tarif.name.toLowerCase().includes(lowerQuery)
            );
            
            renderBannedKartlari(filtered);
        }

        // Se√ßili yasak kartlarƒ± listesini g√ºncelle
        function updateSelectedBannedList() {
            const container = document.getElementById('selectedBannedTags');
            if (!container) return;
            
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            let bannedData = eslesmemeKurallari[currentFoodName] || [];
            const bannedCards = Array.isArray(bannedData) 
                ? bannedData 
                : (bannedData.kartlar || bannedData.yasakKartlar || []);
            
            if (bannedCards.length === 0) {
                container.innerHTML = '<span class="selected-tarif-empty">Hen√ºz yasak kart se√ßilmedi. A≈üaƒüƒ±daki kartlardan tƒ±klayarak yasak olarak i≈üaretleyin.</span>';
            } else {
                container.innerHTML = bannedCards.filter(Boolean).map(cardFile => {
                    const displayName = (cardFile || '').replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
                    
                    return `
                        <span class="selected-tarif-tag" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">
                            ${displayName}
                            <span class="remove-icon" onclick="removeBannedMatch('${(cardFile || '').replace(/'/g, "\\'")}')">√ó</span>
                        </span>
                    `;
                }).join('');
            }
        }

        // Yasak e≈üle≈ütirme sil (badge √ó butonu)
        function removeBannedMatch(matchName) {
            if (!eslesmemeKurallari[currentFoodName]) return;
            
            // ‚úÖ Object ‚Üí Array d√∂n√º≈ü√ºm√º
            let currentArray = Array.isArray(eslesmemeKurallari[currentFoodName])
                ? eslesmemeKurallari[currentFoodName]
                : (eslesmemeKurallari[currentFoodName].kartlar || eslesmemeKurallari[currentFoodName].yasakKartlar || []);
            
            const index = currentArray.indexOf(matchName);
            if (index !== -1) {
                currentArray.splice(index, 1);
            }
            
            // Geri kaydet
            eslesmemeKurallari[currentFoodName] = currentArray;
            
            // Se√ßili kartlarƒ± g√ºncelle
            updateSelectedBannedList();
            
            // Grid'i yeniden render et
            const searchInput = document.getElementById('bannedSearchInput');
            const currentQuery = searchInput ? searchInput.value : '';
            
            if (currentQuery) {
                searchBannedCards(currentQuery);
            } else {
                renderBannedKartlari(tarifKartlari);
            }
        }

        // Yasak kurallarƒ±nƒ± GitHub'a kaydet
        async function saveBannedMatches() {
            if (!currentFoodName) {
                alert('‚ùå Men√º kartƒ± se√ßilmedi!');
                return;
            }
            
            // Local'deki se√ßili yasak kartlarƒ± al
            let banned = eslesmemeKurallari[currentFoodName];
            
            // ‚úÖ Object formatƒ±ndaysa array'e √ßevir
            if (banned && typeof banned === 'object' && !Array.isArray(banned)) {
                banned = banned.yasakliKartlar || banned.kartlar || [];
            }
            
            banned = banned || [];
            
            if (banned.length === 0) {
                const confirmDelete = confirm(`‚ö†Ô∏è Hi√ß yasak kart se√ßilmedi.\n\n"${currentFoodName}" i√ßin t√ºm yasak kurallarƒ±nƒ± kaldƒ±rmak istediƒüinizi onaylƒ±yor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut eslesmeme_kurallari.json'u GitHub'dan y√ºkle
                const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json?t=' + Date.now());
                let currentData = {};
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // ‚úÖ eslestirme.html ile aynƒ± fallback sistemi
                    if (data.kurallar && data.kurallar.eslesmemeKurallari) {
                        currentData = data.kurallar.eslesmemeKurallari;
                    } else if (data.kurallar) {
                        currentData = data.kurallar;
                    } else if (data.eslesmemeKurallari) {
                        currentData = data.eslesmemeKurallari;
                    } else {
                        currentData = data;
                    }
                }
                
                // Yemek adƒ±nƒ± temizle (eslestirme.html mantƒ±ƒüƒ±)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '') // Parantez i√ßlerini kaldƒ±r
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '') // Miktar √∂n eklerini kaldƒ±r
                    .trim();
                
                const lowercaseSpaced = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G')
                    .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                    .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                    .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                    .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                    .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                    .trim();
                
                console.log(`üíæ Kaydedilecek key: "${lowercaseSpaced}" (orijinal: "${currentFoodName}")`);
                
                // Mevcut t√ºm kurallarƒ± koru
                let updatedEslesmemeKurallari = { ...currentData };
                
                if (banned.length === 0) {
                    // Yasak kart yoksa sil
                    delete updatedEslesmemeKurallari[lowercaseSpaced];
                    console.log(`üóëÔ∏è Yasak kuralƒ± silindi: ${lowercaseSpaced}`);
                } else {
                    // Yeni yasak kuralƒ± ekle (eslestirme.html formatƒ±)
                    updatedEslesmemeKurallari[lowercaseSpaced] = {
                        orijinalMetin: currentFoodName,
                        yasakliKartlar: banned,
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`‚úÖ Yasak kuralƒ± eklendi: ${lowercaseSpaced} ‚Üí ${banned.length} kart`);
                }
                
                // ‚úÖ eslestirme.html ile AYNI FORMAT (nested structure)
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    kurallar: {
                        version: "1.0",
                        sonGuncelleme: new Date().toISOString(),
                        eslesmemeKurallari: updatedEslesmemeKurallari
                    }
                }, null, 2);
                
                const commitMsg = banned.length === 0 
                    ? `Yasak kuralƒ± silindi: ${currentFoodName}`
                    : `E≈üle≈üme yasaƒüƒ±: ${currentFoodName} ‚õî ${banned.join(', ')}`;
                
                // GitHub'a kaydet
                await saveToGitHub('data/eslesmeme_kurallari.json', jsonContent, commitMsg);
                
                console.log('‚úÖ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i g√ºncelle (object formatƒ±nda tut - eslestirme.html mantƒ±ƒüƒ±)
                if (banned.length === 0) {
                    delete eslesmemeKurallari[lowercaseSpaced];
                } else {
                    eslesmemeKurallari[lowercaseSpaced] = {
                        orijinalMetin: currentFoodName,
                        yasakliKartlar: banned,
                        eklemeTarihi: new Date().toISOString()
                    };
                }
                
                // ‚úÖ SAYFAYI Dƒ∞NAMƒ∞K OLARAK YENƒ∞LE (deƒüi≈üiklik anƒ±nda g√∂r√ºns√ºn)
                console.log('üîÑ Yasak kurallarƒ± kaydedildi, sayfa yenileniyor...');
                renderWeekContent(); // Haftalƒ±k men√ºy√º yenile
                
                alert(`‚úÖ Yasak kurallarƒ± kaydedildi!\n\n${banned.length} yasak kart: ${banned.join(', ')}`);
                
            } catch (error) {
                console.error('‚ùå Yasak kurallarƒ± kaydedilirken hata:', error);
                alert(`‚ùå Kaydetme hatasƒ±:\n\n${error.message}`);
            }
        }

        // ========================================
        // TAB 3 & TAB 4: YEMEK VERƒ∞TABANI FONKSƒ∞YONLARI
        // ========================================

        // Global state - Tab 3 & 4 (√úSTTE TANINLI - m√ºkerrer tanƒ±m silindi)

        // ========================================
        // TAB 3: Yemek Veritabanƒ± Manuel E≈üle≈ütirme
        // ========================================

        async function loadAndRenderFoodDatabase(previousMatchedFoods = []) {
            console.log('üì• loadAndRenderFoodDatabase ba≈üladƒ±');
            
            // foodData y√ºklenmi≈ü mi kontrol et
            if (foodData.length === 0) {
                console.log('üì• foodData y√ºkleniyor...');
                await loadFoodData();
            }
            
            // √ñnceki se√ßimleri set et (ARRAY formatƒ±)
            if (previousMatchedFoods && Array.isArray(previousMatchedFoods)) {
                selectedFoodMatches = previousMatchedFoods;
            } else if (previousMatchedFoods) {
                // Geriye d√∂n√ºk uyumluluk: String ise array'e √ßevir
                selectedFoodMatches = [previousMatchedFoods];
            }
            
            // T√ºm yemekleri g√∂ster
            renderFoodDatabaseList(foodData);
            updateSelectedFoodMatches();
        }

        // Yemek veritabanƒ± arama (akƒ±llƒ± fuzzy search)
        function searchFoodDatabase(query) {
            if (!query || query.trim() === '') {
                // Bo≈ü arama: T√ºm yemekleri g√∂ster
                renderFoodDatabaseList(foodData);
                return;
            }
            
            const tokens = query.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            
            const filtered = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                return tokens.every(token => {
                    // Token tam e≈üle≈üme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kƒ±saltma: "mer" ‚Üí "mercimek", "√ßor" ‚Üí "√ßorbasƒ±"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderFoodDatabaseList(filtered);
        }

        // Yemekleri listele (se√ßili en √ºstte, CHECKBOX ile √ßoklu se√ßim)
        function renderFoodDatabaseList(foods) {
            const list = document.getElementById('foodDatabaseList');
            if (!list) return;
            
            if (!foods || foods.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        üîç E≈üle≈üen yemek bulunamadƒ±
                    </div>
                `;
                return;
            }
            
            // Se√ßili yemekler √ºstte
            const sorted = [...foods].sort((a, b) => {
                const aSelected = selectedFoodMatches.includes(a.name);
                const bSelected = selectedFoodMatches.includes(b.name);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return a.name.localeCompare(b.name, 'tr');
            });
            
            list.innerHTML = sorted.map(food => {
                const isSelected = selectedFoodMatches.includes(food.name);
                return `
                    <div class="food-db-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleFoodMatch('${food.name.replace(/'/g, "\\'")}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                               style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"
                               onclick="event.stopPropagation(); toggleFoodMatch('${food.name.replace(/'/g, "\\'")}')">
                        <div style="flex: 1;">
                            <strong style="color: ${isSelected ? '#667eea' : '#333'}; font-size: 14px;">${food.name}</strong>
                            <br><small style="color: #999; font-size: 12px;">
                                ${food.calories || 0} kcal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Checkbox toggle (Tab 4 ile aynƒ± mantƒ±k - √ßoklu se√ßim)
        function toggleFoodMatch(foodName) {
            const index = selectedFoodMatches.indexOf(foodName);
            if (index === -1) {
                selectedFoodMatches.push(foodName); // Ekle
            } else {
                selectedFoodMatches.splice(index, 1); // √áƒ±kar
            }
            updateSelectedFoodMatches();
            
            // Arama input deƒüerini koru
            const searchInput = document.getElementById('foodDbSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            
            // Listeyi g√ºncelle (se√ßililer √ºste √ßƒ±ksƒ±n)
            searchFoodDatabase(searchValue || '');
        }

        // T√ºm se√ßimleri temizle
        window.clearFoodMatches = function() {
            selectedFoodMatches = [];
            updateSelectedFoodMatches();
            
            // Listeyi yenile
            const searchInput = document.getElementById('foodDbSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            searchFoodDatabase(searchValue || '');
        };

        // Se√ßili yemekleri g√ºncelle (√ßoklu badge g√∂sterimi - Tab 4 ile aynƒ± mantƒ±k)
        function updateSelectedFoodMatches() {
            const container = document.getElementById('selectedFoodMatch');
            if (!container) return;
            
            if (selectedFoodMatches.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <span style="font-size: 14px;">Hen√ºz yemek se√ßilmedi</span>
                        <br><small style="font-size: 12px;">A≈üaƒüƒ±dan bir veya birden fazla yemek se√ßin</small>
                    </div>
                `;
            } else {
                const badgesHtml = selectedFoodMatches.map(name => `
                    <span class="food-match-badge" style="display: inline-block; background: #667eea; color: white; padding: 8px 12px; border-radius: 20px; margin: 5px; font-size: 13px;">
                        ‚úÖ ${name}
                    </span>
                `).join('');
                
                container.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #667eea; font-size: 14px;">
                                üìå Se√ßili Yemekler (${selectedFoodMatches.length})
                            </strong>
                            <button onclick="clearFoodMatches()" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ‚ùå T√ºm√ºn√º Temizle
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${badgesHtml}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <small style="color: #999; font-size: 11px;">
                                ‚ÑπÔ∏è Rotasyon Modu: <strong style="color: #667eea;">Sƒ±ralƒ±</strong> (1‚Üí2‚Üí3‚Üí1...)
                                <br>Men√º olu≈ütururken sistem yukarƒ±daki yemekleri sƒ±rayla kullanacak.
                            </small>
                        </div>
                    </div>
                `;
            }
        }

        // Kaydet: Tab 3 - Yemek Veritabanƒ± E≈üle≈ütirme (ARRAY formatƒ± + rotasyonModu)
        async function saveYemekEslestirme() {
            if (!currentFoodName) {
                alert('‚ùå Men√º kartƒ± se√ßilmedi!');
                return;
            }
            
            if (selectedFoodMatches.length === 0) {
                const confirmDelete = confirm(`‚ö†Ô∏è Hi√ß yemek se√ßilmedi.\n\n"${currentFoodName}" i√ßin manuel e≈üle≈ütirmeyi kaldƒ±rmak istediƒüinizi onaylƒ±yor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut yemek_veritabani_eslestirme.json'u y√ºkle
                const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_eslestirme.json?t=' + Date.now())
                    .then(r => r.ok ? r.json() : { eslestirmeler: {} })
                    .catch(() => ({ eslestirmeler: {} }));
                
                const eslestirmeler = currentData.eslestirmeler || currentData;
                
                // Key normalizasyonu (eslestirme.html mantƒ±ƒüƒ±)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '')
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '')
                    .trim();
                
                const normalizedKey = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                    .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                    .trim();
                
                console.log(`üíæ Kaydedilecek key: "${normalizedKey}" (orijinal: "${currentFoodName}")`);
                
                // G√ºncelle veya sil
                if (selectedFoodMatches.length === 0) {
                    delete eslestirmeler[normalizedKey];
                    console.log(`üóëÔ∏è Manuel e≈üle≈ütirme silindi: ${normalizedKey}`);
                } else {
                    eslestirmeler[normalizedKey] = {
                        orijinalMetin: currentFoodName,
                        hedefYemekler: selectedFoodMatches, // ‚úÖ ARRAY formatƒ±
                        rotasyonModu: 'sirayla', // ‚úÖ Sƒ±ralƒ± rotasyon (default)
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`‚úÖ Manuel e≈üle≈ütirme eklendi: ${normalizedKey} ‚Üí [${selectedFoodMatches.join(', ')}]`);
                }
                
                // GitHub'a kaydet
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    eslestirmeler: eslestirmeler
                }, null, 2);
                
                const commitMsg = selectedFoodMatches.length > 0
                    ? `Yemek e≈üle≈ütirme: ${currentFoodName} ‚Üí ${selectedFoodMatches.length} alternatif`
                    : `Yemek e≈üle≈ütirme silindi: ${currentFoodName}`;
                
                await saveToGitHub('data/yemek_veritabani_eslestirme.json', jsonContent, commitMsg);
                
                console.log('‚úÖ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i g√ºncelle
                yemekVeritabaniEslestirme = eslestirmeler;
                
                // Sayfa yenile
                console.log('üîÑ Yemek e≈üle≈ütirme kaydedildi, sayfa yenileniyor...');
                renderWeekContent();
                
                alert(selectedFoodMatches.length > 0
                    ? `‚úÖ Manuel e≈üle≈ütirme kaydedildi!\n\n${currentFoodName} ‚Üí ${selectedFoodMatches.length} alternatif yemek\n\n${selectedFoodMatches.join('\n')}\n\n‚öôÔ∏è Rotasyon: Sƒ±ralƒ± (1‚Üí2‚Üí3‚Üí1...)`
                    : `‚úÖ Manuel e≈üle≈ütirme kaldƒ±rƒ±ldƒ±!\n\n${currentFoodName}`
                );
                
            } catch (error) {
                console.error('‚ùå Kaydetme hatasƒ±:', error);
                alert(`‚ùå Kaydetme hatasƒ±:\n\n${error.message}`);
            }
        }

        // ========================================
        // TAB 4: Yemek Veritabanƒ± Yasaklarƒ±
        // ========================================

        async function loadAndRenderBannedFoods(previousBannedFoods = []) {
            console.log('üì• loadAndRenderBannedFoods ba≈üladƒ±');
            
            // foodData y√ºklenmi≈ü mi kontrol et
            if (foodData.length === 0) {
                console.log('üì• foodData y√ºkleniyor...');
                await loadFoodData();
            }
            
            // √ñnceki se√ßimleri set et
            selectedBannedFoods = previousBannedFoods || [];
            
            // T√ºm yemekleri g√∂ster
            renderBannedFoodsList(foodData);
            updateSelectedBannedFoods();
        }

        // Yasak yemek arama (akƒ±llƒ± fuzzy search)
        function searchBannedFoods(query) {
            if (!query || query.trim() === '') {
                // Bo≈ü arama: T√ºm yemekleri g√∂ster
                renderBannedFoodsList(foodData);
                return;
            }
            
            const tokens = query.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            
            const filtered = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                return tokens.every(token => {
                    // Token tam e≈üle≈üme
                    if (normalizedName.includes(token)) return true;
                    
                    // Token kƒ±saltma: "kab" ‚Üí "kabak", "√ßek" ‚Üí "√ßekirdekli"
                    const words = normalizedName.split(/\s+/);
                    return words.some(word => word.startsWith(token) && token.length >= 2);
                });
            });
            
            renderBannedFoodsList(filtered);
        }

        // Yasak yemekleri listele (se√ßililer en √ºstte + checkbox)
        function renderBannedFoodsList(foods) {
            const list = document.getElementById('foodBanList');
            if (!list) return;
            
            if (!foods || foods.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        üîç E≈üle≈üen yemek bulunamadƒ±
                    </div>
                `;
                return;
            }
            
            // Se√ßililer √ºstte
            const sorted = [...foods].sort((a, b) => {
                const aSelected = selectedBannedFoods.includes(a.name);
                const bSelected = selectedBannedFoods.includes(b.name);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return a.name.localeCompare(b.name, 'tr');
            });
            
            list.innerHTML = sorted.map(food => {
                const isSelected = selectedBannedFoods.includes(food.name);
                return `
                    <div class="food-ban-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleBannedFood('${food.name.replace(/'/g, "\\'")}')">
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''}
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;"
                               onclick="event.stopPropagation(); toggleBannedFood('${food.name.replace(/'/g, "\\'")}')">
                        <div style="flex: 1;">
                            <strong style="color: ${isSelected ? '#f44336' : '#333'}; font-size: 14px;">${food.name}</strong>
                            <br><small style="color: #999; font-size: 12px;">
                                ${food.calories || 0} kcal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Yasak yemek toggle (checkbox mantƒ±ƒüƒ±)
        function toggleBannedFood(foodName) {
            const index = selectedBannedFoods.indexOf(foodName);
            
            if (index === -1) {
                // Ekle
                selectedBannedFoods.push(foodName);
            } else {
                // √áƒ±kar
                selectedBannedFoods.splice(index, 1);
            }
            
            updateSelectedBannedFoods();
            
            // Arama input deƒüerini koru
            const searchInput = document.getElementById('foodBanSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            
            // Listeyi g√ºncelle (se√ßililer √ºste √ßƒ±ksƒ±n)
            searchBannedFoods(searchValue || '');
        }

        // Se√ßili yasak yemekleri g√ºncelle (√ºst kƒ±sƒ±m - badge'ler)
        function updateSelectedBannedFoods() {
            const container = document.getElementById('selectedBannedFoods');
            if (!container) return;
            
            if (selectedBannedFoods.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <span style="font-size: 14px;">Hen√ºz yasak yemek se√ßilmedi</span>
                        <br><small style="font-size: 12px;">A≈üaƒüƒ±dan bir veya birden fazla yemek se√ßin</small>
                    </div>
                `;
            } else {
                const badgesHtml = selectedBannedFoods.map(foodName => `
                    <span class="banned-food-badge" 
                          style="display: inline-block; background: white; border: 2px solid #f44336; color: #f44336; padding: 8px 12px; border-radius: 20px; margin: 5px; font-size: 13px; font-weight: 500;">
                        üö´ ${foodName}
                    </span>
                `).join('');
                
                container.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #ff9800; font-size: 14px;">
                                üö´ Yasaklƒ± Yemekler (${selectedBannedFoods.length})
                            </strong>
                            <button onclick="clearAllBannedFoods()" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ‚ùå T√ºm√ºn√º Temizle
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${badgesHtml}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <small style="color: #999; font-size: 11px;">
                                ‚ö†Ô∏è Bu yemekler "${currentFoodName}" i√ßin asla kullanƒ±lmayacak.
                            </small>
                        </div>
                    </div>
                `;
            }
        }
        
        // T√ºm yasak yemekleri temizle
        window.clearAllBannedFoods = function() {
            selectedBannedFoods = [];
            updateSelectedBannedFoods();
            
            // Listeyi yenile
            const searchInput = document.getElementById('foodBanSearchInput');
            const searchValue = searchInput ? searchInput.value : '';
            searchBannedFoods(searchValue || '');
        };

        // Kaydet: Tab 4 - Yemek Veritabanƒ± Yasaklarƒ±
        async function saveYemekYasaklar() {
            if (!currentFoodName) {
                alert('‚ùå Men√º kartƒ± se√ßilmedi!');
                return;
            }
            
            if (selectedBannedFoods.length === 0) {
                const confirmDelete = confirm(`‚ö†Ô∏è Hi√ß yasak yemek se√ßilmedi.\n\n"${currentFoodName}" i√ßin yasak kurallarƒ±nƒ± kaldƒ±rmak istediƒüinizi onaylƒ±yor musunuz?`);
                if (!confirmDelete) return;
            }
            
            try {
                // Mevcut yemek_veritabani_yasaklar.json'u y√ºkle
                const currentData = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/yemek_veritabani_yasaklar.json?t=' + Date.now())
                    .then(r => r.ok ? r.json() : { yasaklar: {} })
                    .catch(() => ({ yasaklar: {} }));
                
                const yasaklar = currentData.yasaklar || currentData;
                
                // Key normalizasyonu (eslestirme.html mantƒ±ƒüƒ±)
                const cleanedName = currentFoodName
                    .replace(/\s*\([^)]*\)/g, '')
                    .replace(/^\d+\s*(gr|gram|adet|dilim|porsiyon|su bardaƒüƒ±|kase|ml|lt)\s*/i, '')
                    .trim();
                
                const normalizedKey = cleanedName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                    .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                    .trim();
                
                console.log(`üíæ Kaydedilecek key: "${normalizedKey}" (orijinal: "${currentFoodName}")`);
                
                // G√ºncelle veya sil
                if (selectedBannedFoods.length === 0) {
                    delete yasaklar[normalizedKey];
                    console.log(`üóëÔ∏è Yasak kuralƒ± silindi: ${normalizedKey}`);
                } else {
                    yasaklar[normalizedKey] = {
                        orijinalMetin: currentFoodName,
                        yasaklananYemekler: selectedBannedFoods,
                        eklemeTarihi: new Date().toISOString()
                    };
                    console.log(`‚úÖ Yasak kuralƒ± eklendi: ${normalizedKey} ‚Üí ${selectedBannedFoods.length} yemek`);
                }
                
                // GitHub'a kaydet
                const jsonContent = JSON.stringify({
                    version: "1.0",
                    sonGuncelleme: new Date().toISOString(),
                    yasaklar: yasaklar
                }, null, 2);
                
                const commitMsg = selectedBannedFoods.length > 0
                    ? `Yemek yasaklarƒ±: ${currentFoodName} ‚õî ${selectedBannedFoods.join(', ')}`
                    : `Yemek yasaklarƒ± silindi: ${currentFoodName}`;
                
                await saveToGitHub('data/yemek_veritabani_yasaklar.json', jsonContent, commitMsg);
                
                console.log('‚úÖ GitHub\'a kaydedildi:', currentFoodName);
                
                // Local state'i g√ºncelle
                yemekVeritabaniYasaklar = yasaklar;
                
                // Sayfa yenile
                console.log('üîÑ Yemek yasaklarƒ± kaydedildi, sayfa yenileniyor...');
                renderWeekContent();
                
                alert(selectedBannedFoods.length > 0
                    ? `‚úÖ Yasak kurallarƒ± kaydedildi!\n\n${selectedBannedFoods.length} yasak yemek:\n${selectedBannedFoods.join('\n')}`
                    : `‚úÖ Yasak kurallarƒ± kaldƒ±rƒ±ldƒ±!\n\n${currentFoodName}`
                );
                
            } catch (error) {
                console.error('‚ùå Kaydetme hatasƒ±:', error);
                alert(`‚ùå Kaydetme hatasƒ±:\n\n${error.message}`);
            }
        }

        // ========================================
        // üîç ROL & KATEGORƒ∞ UYUMSUZLUK KONTROL ARACI
        // ========================================
        
        /**
         * T√ºm haftalardaki yemeklerin rol/kategori deƒüerlerini food_list.json ile kar≈üƒ±la≈ütƒ±r
         * Console'dan √ßaƒüƒ±rƒ±labilir: checkRoleCategoryMismatches()
         */
        window.checkRoleCategoryMismatches = async function() {
            console.log('=== üîç ROL & KATEGORƒ∞ UYUMSUZLUK KONTROL√ú ===');
            
            // food_list.json y√ºklenmemi≈üse y√ºkle
            if (!foodData || foodData.length === 0) {
                console.log('üì• food_list.json y√ºkleniyor...');
                await loadFoodData();
            }
            
            const mismatches = [];
            const missing = [];
            const correct = [];
            
            // T√ºm haftalarƒ± tara
            weeks.forEach((week, wIdx) => {
                week.days.forEach((day, dIdx) => {
                    const meals = day.meals || day.ogunler || [];
                    meals.forEach((meal, mIdx) => {
                        const foods = meal.yemekler || [];
                        foods.forEach((food, fIdx) => {
                            const foodName = food.foodName || food.name;
                            if (!foodName) return;
                            
                            // food_list.json'da bul
                            const dbFood = findFoodInDatabase(foodName);
                            
                            if (!dbFood) {
                                // Veritabanƒ±nda yok
                                missing.push({
                                    location: `Hafta ${wIdx + 1} > ${day.name} > ${meal.ogunAdi || meal.name}`,
                                    foodName: foodName,
                                    menuRole: food.role || '(bo≈ü)',
                                    menuCategory: food.category || '(bo≈ü)'
                                });
                            } else {
                                // Veritabanƒ±nda var - kar≈üƒ±la≈ütƒ±r
                                const roleMatch = (food.role || '') === (dbFood.role || '');
                                const categoryMatch = (food.category || '') === (dbFood.category || '');
                                
                                if (!roleMatch || !categoryMatch) {
                                    // Uyumsuzluk var
                                    mismatches.push({
                                        location: `Hafta ${wIdx + 1} > ${day.name} > ${meal.ogunAdi || meal.name}`,
                                        foodName: foodName,
                                        menuRole: food.role || '(bo≈ü)',
                                        dbRole: dbFood.role || '(bo≈ü)',
                                        roleMatch: roleMatch ? '‚úÖ' : '‚ùå',
                                        menuCategory: food.category || '(bo≈ü)',
                                        dbCategory: dbFood.category || '(bo≈ü)',
                                        categoryMatch: categoryMatch ? '‚úÖ' : '‚ùå',
                                        weekIdx: wIdx,
                                        dayIdx: dIdx,
                                        mealIdx: mIdx,
                                        foodIdx: fIdx
                                    });
                                } else {
                                    // Her ≈üey uyumlu
                                    correct.push({ foodName, location: `Hafta ${wIdx + 1} > ${day.name}` });
                            }
                            }
                        });
                    });
                });
            });
            
            console.log('\nüìä SONU√áLAR:');
            console.log(`‚úÖ Uyumlu yemekler: ${correct.length}`);
            console.log(`‚ùå Uyumsuz yemekler: ${mismatches.length}`);
            console.log(`‚ö†Ô∏è Veritabanƒ±nda bulunamayan: ${missing.length}`);
            
            if (mismatches.length > 0) {
                console.log('\n‚ùå UYUMSUZLUKLAR:');
                console.table(mismatches);
            }
            
            if (missing.length > 0) {
                console.log('\n‚ö†Ô∏è VERƒ∞TABANINDA BULUNAMAYAN:');
                console.table(missing);
            }
            
            // Otomatik d√ºzeltme fonksiyonu
            window.fixAllRoleCategoryMismatches = function() {
                console.log('üîß T√ºm uyumsuzluklar d√ºzeltiliyor...');
                
                let fixedCount = 0;
                mismatches.forEach(mismatch => {
                    const week = weeks[mismatch.weekIdx];
                    const day = week.days[mismatch.dayIdx];
                    const meal = (day.meals || day.ogunler)[mismatch.mealIdx];
                    const food = meal.yemekler[mismatch.foodIdx];
                    
                    const dbFood = findFoodInDatabase(mismatch.foodName);
                    if (dbFood) {
                        food.role = dbFood.role || '';
                        food.category = dbFood.category || '';
                        fixedCount++;
                    }
                });
                
                console.log(`‚úÖ ${fixedCount} uyumsuzluk d√ºzeltildi!`);
                renderWeekContent();
                
                // Hafta verilerini kaydet
                saveWeeks(); // ‚úÖ Doƒüru fonksiyon adƒ±
            };
            
            if (mismatches.length > 0) {
                console.log('\nüí° T√ºm uyumsuzluklarƒ± otomatik d√ºzeltmek i√ßin: fixAllRoleCategoryMismatches()');
            }
        };

        // ========================================
        // ADMIN FONKSƒ∞YONLARI SONU
        // ========================================

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
        
        // Admin UI'yi ba≈ülat (biraz gecikmeyle - AdminAuth y√ºklensin diye)
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(initAdminUI, 500);
        });
        
        // ‚úÖ Bildirim izni i√ßin prompt (ilk a√ßƒ±lƒ±≈üta)
        window.addEventListener('DOMContentLoaded', () => {
            // 2 saniye bekle (sayfa tamamen y√ºklensin)
            setTimeout(async () => {
                if ('Notification' in window && Notification.permission === 'default') {
                    try {
                        console.log('üîî Bildirim izni isteniyor (patient)...');
                        const permission = await Notification.requestPermission();
                        console.log('üìù Bildirim izni sonucu:', permission);
                        
                        if (permission === 'granted') {
                            console.log('‚úÖ Bildirim izni verildi! OneSignal push subscription olu≈üturulacak.');
                        } else {
                            console.log('‚ùå Bildirim izni reddedildi veya ertelendi.');
                        }
                    } catch (error) {
                        console.error('‚ùå Bildirim izni hatasƒ±:', error);
                    }
                }
            }, 2000);
        });
    
    </script>
    <script>
        // Check if PatientAuth is loaded
        if (typeof PatientAuth === 'undefined') {
            console.error('‚ùå PatientAuth y√ºklenemedi!');
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545;">Kimlik doƒürulama sistemi y√ºklenemedi</h3>
                    <p>L√ºtfen sayfayƒ± yenileyin veya giri≈ü sayfasƒ±na d√∂n√ºn.</p>
                    <button onclick="window.location.href='login.html'" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Giri≈ü Sayfasƒ±na D√∂n
                    </button>
                </div>
            `;
        }

        // PDF Modal Functions
        function openPdfModal(pdfUrl) {
            const modal = document.getElementById('pdfModal');
            const imgViewer = document.getElementById('pdfImageViewer');
            const iframeViewer = document.getElementById('pdfIframeViewer');
            const errorMessage = document.getElementById('pdfErrorMessage');
            const directLink = document.getElementById('pdfDirectLink');
            
            // Reset viewers
            imgViewer.style.display = 'none';
            iframeViewer.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Dosya uzantƒ±sƒ±nƒ± kontrol et
            const fileExt = pdfUrl.toLowerCase().split('.').pop().split('?')[0];
            
            if (fileExt === 'jpg' || fileExt === 'jpeg' || fileExt === 'png' || fileExt === 'gif' || fileExt === 'webp') {
                // Resim dosyasƒ± - direkt g√∂ster
                imgViewer.src = pdfUrl;
                imgViewer.style.display = 'block';
            } else if (fileExt === 'pdf') {
                // PDF dosyasƒ± - iframe ile deneme (GitHub raw PDF'ler genelde √ßalƒ±≈ümaz)
                // √ñnce iframe dene, y√ºklenemezse hata mesajƒ± g√∂ster
                iframeViewer.src = pdfUrl;
                iframeViewer.style.display = 'block';
                
                // 2 saniye sonra y√ºkleme kontrol√º
                setTimeout(() => {
                    // Eƒüer iframe y√ºklenmediyse hata mesajƒ± g√∂ster
                    try {
                        // iframe contentDocument eri≈üilebilir mi kontrol et
                        const iframeDoc = iframeViewer.contentDocument || iframeViewer.contentWindow.document;
                        if (!iframeDoc) throw new Error('Cannot access iframe');
                    } catch (error) {
                        // GitHub X-Frame-Options engeli - hata mesajƒ± g√∂ster
                        iframeViewer.style.display = 'none';
                        errorMessage.style.display = 'block';
                        directLink.href = pdfUrl;
                    }
                }, 2000);
            } else {
                // Bilinmeyen format - direkt link g√∂ster
                errorMessage.style.display = 'block';
                directLink.href = pdfUrl;
            }
            
            // Modal'ƒ± g√∂ster
            modal.style.display = 'block';
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const imgViewer = document.getElementById('pdfImageViewer');
            const iframeViewer = document.getElementById('pdfIframeViewer');
            
            modal.style.display = 'none';
            imgViewer.src = '';
            iframeViewer.src = '';
        }

        // Mobil Versiyon Toggle Functions
        function openMobileVersion() {
            const mobileContainer = document.getElementById('mobileIframeContainer');
            const mainContainer = document.getElementById('mainContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const btnBack = document.getElementById('btnBack');
            
            // iframe URL'ini set et - lokal dosya
            mobileIframe.src = 'mobil_versiyon_v1.html';
            
            // Ana i√ßeriƒüi gizle, mobil versiyonu g√∂ster
            mainContainer.style.display = 'none';
            mobileContainer.style.display = 'block';
            btnBack.style.display = 'flex';
            
            console.log('ÔøΩ Alternatif yemek arama sayfasƒ± a√ßƒ±ldƒ±');
        }

        function closeMobileVersion() {
            const mobileContainer = document.getElementById('mobileIframeContainer');
            const mainContainer = document.getElementById('mainContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const btnBack = document.getElementById('btnBack');
            
            // iframe'i temizle
            mobileIframe.src = '';
            
            // Mobil versiyonu gizle, ana i√ßeriƒüi g√∂ster
            mobileContainer.style.display = 'none';
            mainContainer.style.display = 'flex';
            btnBack.style.display = 'none';
            
            console.log('‚óÄ Ana sayfaya d√∂n√ºld√º');
        }
    </script>

    <!-- üîß ADMIN YEMEK E≈ûLE≈ûTƒ∞RME MODALI (5 TAB) -->
    <div id="adminFoodModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 12px; max-height: 90vh; overflow-y: auto;">
            
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #FF6B6B; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 24px; font-weight: 700;">
                    <span id="modal_food_name"></span>
                </h2>
                <button onclick="closeAdminFoodModal()" style="background: #f44336; color: white; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; border-radius: 6px;">‚úñ Kapat</button>
            </div>

            <!-- Tab Navigation -->
            <div class="admin-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 5px; flex-wrap: wrap;">
                <button class="admin-tab-btn active" data-tab="manuel" onclick="switchAdminTab('manuel')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    üìù Manuel E≈üle≈ütirme
                </button>
                <button class="admin-tab-btn" data-tab="yasak" onclick="switchAdminTab('yasak')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    üö´ E≈üle≈üme Yasaklarƒ±
                </button>
                <button class="admin-tab-btn" data-tab="db-eslestirme" onclick="switchAdminTab('db-eslestirme')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    üçΩÔ∏è Yemek Veritabanƒ± E≈üle≈ütirme
                </button>
                <button class="admin-tab-btn" data-tab="db-yasak" onclick="switchAdminTab('db-yasak')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    ‚õî Yemek Veritabanƒ± Yasaklarƒ±
                </button>
                <button class="admin-tab-btn" data-tab="db-ekle" onclick="switchAdminTab('db-ekle')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    ‚ûï Veritabanƒ±na Ekle
                </button>
                <button class="admin-tab-btn" data-tab="github-settings" onclick="switchAdminTab('github-settings')" style="flex: 1; min-width: 150px; padding: 12px; border: none; background: #ccc; color: #666; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 13px; font-weight: 600; transition: all 0.3s;">
                    üîë GitHub Token
                </button>
            </div>

            <!-- Tab 1: Manuel E≈üle≈ütirme (Tarif Kartlarƒ±) -->
            <div id="admin-tab-manuel" class="admin-tab-content" style="display: block;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìù Manuel E≈üle≈ütirme (Tarif Kartlarƒ±)</h3>
                <p style="color: #666; margin-bottom: 20px;">Men√º kartƒ±ndaki yemek adƒ±nƒ±, tarif kartlarƒ±ndaki bir yemekle manuel olarak e≈üle≈ütirin.</p>
                
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Men√º Kartƒ±ndaki Yemek Adƒ±:</label>
                    <input type="text" id="admin_manuel_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Tarif Kartƒ±ndaki Yemek Adƒ± (E≈üle≈ütirilecek):</label>
                    <input type="text" id="admin_manuel_tarif_adi" placeholder="√ñrn: Kuru Fasulye" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveManuelEslestirme()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        üíæ Manuel E≈üle≈ütirmeyi Kaydet
                    </button>
                </div>
                
                <!-- Mevcut E≈üle≈ütirmeler -->
                <div id="admin_manuel_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Manuel E≈üle≈ütirmeler:</h4>
                    <p style="color: #999;">Y√ºkleniyor...</p>
                </div>
            </div>

            <!-- Tab 2: E≈üle≈üme Yasaklarƒ± (Tarif Kartlarƒ±) -->
            <div id="admin-tab-yasak" class="admin-tab-content" style="display: none;">
                <h3 style="color: #f44336; margin-bottom: 15px;">üö´ E≈üle≈üme Yasaklarƒ± (Tarif Kartlarƒ±)</h3>
                <p style="color: #666; margin-bottom: 20px;">Men√º kartƒ±ndaki yemek adƒ±nƒ±n, tarif kartlarƒ±ndaki belirli yemeklerle e≈üle≈ümesini yasaklayƒ±n.</p>
                
                <div style="background: #fff3f3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Men√º Kartƒ±ndaki Yemek Adƒ±:</label>
                    <input type="text" id="admin_yasak_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Yasaklanacak Tarif Kartƒ± Adƒ±:</label>
                    <input type="text" id="admin_yasak_tarif_adi" placeholder="√ñrn: Mercimek √áorbasƒ±" style="width: 100%; padding: 12px; border: 2px solid #f44336; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveYasakKurali()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        üö´ Yasak Kuralƒ±nƒ± Kaydet
                    </button>
                </div>
                
                <div id="admin_yasak_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Yasak Kurallarƒ±:</h4>
                    <p style="color: #999;">Y√ºkleniyor...</p>
                </div>
            </div>

            <!-- Tab 3: Yemek Veritabanƒ± E≈üle≈ütirme -->
            <div id="admin-tab-db-eslestirme" class="admin-tab-content" style="display: none;">
                <h3 style="color: #4caf50; margin-bottom: 15px;">üçΩÔ∏è Yemek Veritabanƒ± E≈üle≈ütirme</h3>
                <p style="color: #666; margin-bottom: 20px;">Men√º kartƒ±ndaki yemek adƒ±nƒ±, food_list.json veritabanƒ±ndaki bir yemekle e≈üle≈ütirin.</p>
                
                <div style="background: #f1f8f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Men√º Kartƒ±ndaki Yemek Adƒ±:</label>
                    <input type="text" id="admin_db_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Veritabanƒ±ndaki Yemek Adƒ± (food_list.json):</label>
                    <input type="text" id="admin_db_eslestirme_adi" placeholder="√ñrn: Kuru Fasulye (Zeytinyaƒülƒ±)" style="width: 100%; padding: 12px; border: 2px solid #4caf50; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveDbEslestirme()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        üíæ Veritabanƒ± E≈üle≈ütirmesini Kaydet
                    </button>
                </div>
                
                <div id="admin_db_eslestirme_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Veritabanƒ± E≈üle≈ütirmeleri:</h4>
                    <p style="color: #999;">Y√ºkleniyor...</p>
                </div>
            </div>

            <!-- Tab 4: Yemek Veritabanƒ± Yasaklarƒ± -->
            <div id="admin-tab-db-yasak" class="admin-tab-content" style="display: none;">
                <h3 style="color: #ff9800; margin-bottom: 15px;">‚õî Yemek Veritabanƒ± Yasaklarƒ±</h3>
                <p style="color: #666; margin-bottom: 20px;">Men√º kartƒ±ndaki yemek adƒ±nƒ±n, food_list.json veritabanƒ±ndaki belirli yemeklerle e≈üle≈ümesini yasaklayƒ±n.</p>
                
                <div style="background: #fff8e1; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Men√º Kartƒ±ndaki Yemek Adƒ±:</label>
                    <input type="text" id="admin_db_yasak_yemek_adi" readonly style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; background: #fff; margin-bottom: 20px;">
                    
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Yasaklanacak Veritabanƒ± Yemek Adƒ±:</label>
                    <input type="text" id="admin_db_yasak_adi" placeholder="√ñrn: Mercimek √áorbasƒ± (Zeytinyaƒülƒ±)" style="width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 6px; font-size: 16px; margin-bottom: 20px;">
                    
                    <button onclick="saveDbYasakKurali()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600;">
                        ‚õî Veritabanƒ± Yasak Kuralƒ±nƒ± Kaydet
                    </button>
                </div>
                
                <div id="admin_db_yasak_mevcut_list" style="background: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-top: 0; color: #333;">Mevcut Veritabanƒ± Yasak Kurallarƒ±:</h4>
                    <p style="color: #999;">Y√ºkleniyor...</p>
                </div>
            </div>

            <!-- Tab 5: Veritabanƒ±na Ekle -->
            <div id="admin-tab-db-ekle" class="admin-tab-content" style="display: none;">
                <form id="addFoodForm" onsubmit="event.preventDefault(); saveYeniYemek();" style="max-height: 70vh; overflow-y: auto; padding-right: 15px;">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yemek Adƒ± *</label>
                        <input type="text" id="admin_db_ekle_yemek_adi" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; background: #fff;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kalori (kcal) *</label>
                            <input type="number" id="admin_db_ekle_kalori" min="0" step="0.1" readonly required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; background: #f0f0f0; cursor: not-allowed;" title="Otomatik hesaplanƒ±r: (Karb√ó4) + (Protein√ó4) + (Yaƒü√ó9)">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Protein (g) *</label>
                            <input type="number" id="admin_db_ekle_protein" min="0" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Karbonhidrat (g) *</label>
                            <input type="number" id="admin_db_ekle_karb" min="0" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yaƒü (g) *</label>
                            <input type="number" id="admin_db_ekle_yag" min="0" step="0.1" required oninput="calculateKaloriForAddFood()" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kategori *</label>
                            <select id="admin_db_ekle_kategori" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                                <option value="">-- Kategori Se√ßin --</option>
                                <option value="KAHVALTI">KAHVALTI</option>
                                <option value="√ñƒûLEN">√ñƒûLEN</option>
                                <option value="AK≈ûAM">AK≈ûAM</option>
                                <option value="KURUYEMƒ∞≈ûLER">KURUYEMƒ∞≈ûLER</option>
                                <option value="√áORBALAR">√áORBALAR</option>
                                <option value="SALATALAR">SALATALAR</option>
                                <option value="ANA YEMEKLER">ANA YEMEKLER</option>
                                <option value="TOSTLAR">TOSTLAR</option>
                                <option value="TATLILAR">TATLILAR</option>
                                <option value="ƒ∞√áECEKLER">ƒ∞√áECEKLER</option>
                                <option value="ATI≈ûTIRILMALIKLAR">ATI≈ûTIRILMALIKLAR</option>
                                <option value="EKMEKLER">EKMEKLER</option>
                                <option value="Pƒ∞LAVLAR">Pƒ∞LAVLAR</option>
                                <option value="Dƒ∞ƒûER">Dƒ∞ƒûER</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rol *</label>
                            <select id="admin_db_ekle_rol" required style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                                <option value="">-- Rol Se√ßin --</option>
                                <option value="mainDish">Ana Yemek (mainDish)</option>
                                <option value="sideDish">Yan Yemek (sideDish)</option>
                                <option value="drink">ƒ∞√ßecek (drink)</option>
                                <option value="supplement">Takviye (supplement)</option>
                                <option value="snack">Atƒ±≈ütƒ±rmalƒ±k (snack)</option>
                                <option value="soup">√áorba (soup)</option>
                                <option value="salad">Salata (salad)</option>
                                <option value="bread">Ekmek (bread)</option>
                                <option value="dessert">Tatlƒ± (dessert)</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">√ñƒü√ºn Tipi (Birden fazla se√ßilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_breakfast" value="breakfast">
                                üåÖ Kahvaltƒ±
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_lunch" value="lunch">
                                ‚òÄÔ∏è √ñƒüle
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_mealType_dinner" value="dinner">
                                üåô Ak≈üam
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porsiyon √áarpanƒ±</label>
                        <input type="number" id="admin_db_ekle_portion" min="0" step="0.1" value="1" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Diyet Tipleri (Birden fazla se√ßilebilir)</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_ketojenik" value="ketojenik">
                                ü•ó Ketojenik
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_akdeniz" value="akdeniz">
                                üåä Akdeniz
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_vegan" value="vegan">
                                üå± Vegan
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_dietType_glutensiz" value="glutensiz">
                                üåæ Glutensiz
                            </label>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Min Miktar</label>
                            <input type="number" id="admin_db_ekle_min" min="0" step="0.1" placeholder="Minimum porsiyon" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Max Miktar</label>
                            <input type="number" id="admin_db_ekle_max" min="0" step="0.1" placeholder="Maksimum porsiyon" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Adƒ±m (Step)</label>
                            <input type="number" id="admin_db_ekle_step" min="0" step="0.1" placeholder="Artƒ±≈ü miktarƒ±" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porsiyon √áarpanƒ±</label>
                            <input type="number" id="admin_db_ekle_portion2" min="0" step="0.1" value="1" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Sezon Ba≈ülangƒ±√ß (Ay)</label>
                            <input type="number" id="admin_db_ekle_season_min" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Sezon Biti≈ü (Ay)</label>
                            <input type="number" id="admin_db_ekle_season_max" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">üè∑Ô∏è √ñzel √ñzellikler</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_keto">
                                ü•ó Keto
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_lowcarb">
                                üìâ D√º≈ü√ºk Karb
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_portionFixed">
                                üîí Porsiyon Sabit
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_fillerLunch">
                                üçΩÔ∏è √ñƒüle Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_fillerDinner">
                                üåô Ak≈üam Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="admin_reversedSeason">
                                üîÑ Ters Sezon
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">üè∑Ô∏è Etiketler (Tags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="admin_db_ekle_tags" placeholder="√∂r: domates, meyve, salata" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">‚úÖ Uyumluluk Etiketleri (compatibilityTags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="admin_db_ekle_compat" placeholder="√∂r: tavuk, zeytinyaƒüƒ±" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">‚ùå Uyumsuzluk Etiketleri (incompatibilityTags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="admin_db_ekle_incompat" placeholder="√∂r: s√ºt, peynir" style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">üìù Notlar</label>
                        <textarea id="admin_db_ekle_notes" placeholder="Ek bilgiler, √∂zel notlar..." style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="closeAdminFoodModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            ƒ∞ptal
                        </button>
                        <button type="submit" style="flex: 2; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            üíæ Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab 6: GitHub Token Ayarlarƒ± -->
            <div id="admin-tab-github-settings" class="admin-tab-content" style="display: none;">
                <h3 style="color: #2196f3; margin-bottom: 15px;">üîë GitHub Token Ayarlarƒ±</h3>
                <p style="color: #666; margin-bottom: 20px;">food_list.json'a yemek eklemek/d√ºzenlemek i√ßin GitHub Personal Access Token gereklidir.</p>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìö Token Nasƒ±l Alƒ±nƒ±r?</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #555;">
                        <li>GitHub'da <a href="https://github.com/settings/tokens" target="_blank" style="color: #2196f3; text-decoration: underline;">Settings ‚Üí Developer Settings ‚Üí Personal Access Tokens</a> sayfasƒ±na gidin</li>
                        <li>"Generate new token" (Classic) butonuna tƒ±klayƒ±n</li>
                        <li>Token adƒ±: "Lipodem Takip Paneli"</li>
                        <li>Yetki se√ßimi: <strong>repo</strong> (t√ºm repo yetkisi)</li>
                        <li>"Generate token" butonuna tƒ±klayƒ±n</li>
                        <li>Token'ƒ± kopyalayƒ±p a≈üaƒüƒ±ya yapƒ±≈ütƒ±rƒ±n</li>
                    </ol>
                    <p style="margin: 10px 0 0 0; font-size: 13px; color: #ff6b6b;">
                        ‚ö†Ô∏è <strong>√ñnemli:</strong> Token sadece bir kez g√∂sterilir! Kopyalamayƒ± unutmayƒ±n!
                    </p>
                </div>
                
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">GitHub Personal Access Token:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="password" id="github_token_input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="flex: 1; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; font-family: monospace;">
                        <button onclick="toggleTokenVisibility()" style="background: #6c757d; color: white; border: none; padding: 12px 20px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            ÔøΩÔ∏è G√∂ster
                        </button>
                    </div>
                    
                    <div id="token_status" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                        <!-- Token durumu buraya gelecek -->
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveGithubToken()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            üíæ Token'ƒ± Kaydet
                        </button>
                        <button onclick="testGithubToken()" style="flex: 1; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            üß™ Token'ƒ± Test Et
                        </button>
                        <button onclick="clearGithubToken()" style="background: #f44336; color: white; border: none; padding: 15px 20px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                            üóëÔ∏è Temizle
                        </button>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üîí G√ºvenlik Notu</h4>
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        Token tarayƒ±cƒ±nƒ±zƒ±n localStorage'ƒ±nda saklanƒ±r. Sadece sizin bilgisayarƒ±nƒ±zda kalƒ±r, sunucuya g√∂nderilmez. 
                        Yine de token'ƒ±nƒ±zƒ± kimseyle payla≈ümayƒ±n ve d√ºzenli olarak yenileyin.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ÔøΩüîß ADMIN MODAL FONKSƒ∞YONLARI
        
        // GitHub Token Fonksiyonlarƒ±
        function toggleTokenVisibility() {
            const input = document.getElementById('github_token_input');
            const btn = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà Gizle';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è G√∂ster';
            }
        }
        
        function saveGithubToken() {
            const token = document.getElementById('github_token_input').value.trim();
            
            if (!token) {
                showTokenStatus('‚ö†Ô∏è L√ºtfen token girin!', 'error');
                return;
            }
            
            // Token formatƒ± kontrol√º (ghp_ ile ba≈ülamalƒ±)
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showTokenStatus('‚ö†Ô∏è Ge√ßersiz token formatƒ±! Token "ghp_" veya "github_pat_" ile ba≈ülamalƒ±dƒ±r.', 'error');
                return;
            }
            
            // localStorage'a kaydet
            try {
                localStorage.setItem('github_token', token);
                showTokenStatus('‚úÖ Token ba≈üarƒ±yla kaydedildi!', 'success');
                console.log('‚úÖ GitHub token kaydedildi');
            } catch (error) {
                showTokenStatus('‚ùå Token kaydedilemedi: ' + error.message, 'error');
                console.error('‚ùå Token kaydetme hatasƒ±:', error);
            }
        }
        
        async function testGithubToken() {
            const token = localStorage.getItem('github_token');
            
            if (!token) {
                showTokenStatus('‚ö†Ô∏è √ñnce token kaydedin!', 'error');
                return;
            }
            
            showTokenStatus('üîÑ Token test ediliyor...', 'info');
            
            try {
                // GitHub API'ye basit bir istek at
                const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showTokenStatus(`‚úÖ Token ge√ßerli! Repo eri≈üimi ba≈üarƒ±lƒ±.\n\nRepo: ${data.full_name}\nSon g√ºncelleme: ${new Date(data.updated_at).toLocaleString('tr-TR')}`, 'success');
                } else if (response.status === 401) {
                    showTokenStatus('‚ùå Token ge√ßersiz veya s√ºresi dolmu≈ü!', 'error');
                } else if (response.status === 404) {
                    showTokenStatus('‚ùå Repo bulunamadƒ±! Token\'ƒ±n repo eri≈üim yetkisi var mƒ± kontrol edin.', 'error');
                } else {
                    showTokenStatus(`‚ùå Test ba≈üarƒ±sƒ±z: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showTokenStatus('‚ùå Test hatasƒ±: ' + error.message, 'error');
                console.error('‚ùå Token test hatasƒ±:', error);
            }
        }
        
        function clearGithubToken() {
            if (confirm('üóëÔ∏è GitHub token\'ƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!')) {
                localStorage.removeItem('github_token');
                document.getElementById('github_token_input').value = '';
                showTokenStatus('‚úÖ Token silindi!', 'success');
                console.log('üóëÔ∏è GitHub token silindi');
            }
        }
        
        function showTokenStatus(message, type) {
            const statusDiv = document.getElementById('token_status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            // Renk ayarlarƒ±
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            }
            
            // 5 saniye sonra gizle (success/info i√ßin)
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Sayfa y√ºklendiƒüinde mevcut token'ƒ± g√∂ster
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                document.getElementById('github_token_input').value = savedToken;
                showTokenStatus('‚ÑπÔ∏è Kayƒ±tlƒ± token bulundu. Test edebilir veya deƒüi≈ütirebilirsiniz.', 'info');
            }
        });
        
        // ‚ùå ESKƒ∞ switchAdminTab fonksiyonu KALDIRILDI (line 5512'deki yeni versiyonu kullan)
        // √á√ºnk√º renderTarifManuelTab() gibi fonksiyonlarƒ± √ßaƒüƒ±rmƒ±yordu!
        
        function closeAdminFoodModal() {
            const modal = document.getElementById('adminFoodModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // üíæ KAYDETME FONKSƒ∞YONLARI (Placeholder - GitHub API ile entegre edilecek)
        
        function saveManuelEslestirme() {
            const menuYemek = document.getElementById('admin_manuel_yemek_adi').value;
            const tarifYemek = document.getElementById('admin_manuel_tarif_adi').value;
            
            if (!tarifYemek.trim()) {
                alert('‚ö†Ô∏è L√ºtfen tarif kartƒ±ndaki yemek adƒ±nƒ± girin!');
                return;
            }
            
            console.log('üìù Manuel E≈üle≈ütirme:', { menuYemek, tarifYemek });
            alert('‚úÖ Manuel e≈üle≈ütirme kaydedildi!\n\n' + 
                  'Men√º: ' + menuYemek + '\n' + 
                  'Tarif: ' + tarifYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/manuel_eslestirmeler.json'a kaydet
        }
        
        function saveYasakKurali() {
            const menuYemek = document.getElementById('admin_yasak_yemek_adi').value;
            const tarifYemek = document.getElementById('admin_yasak_tarif_adi').value;
            
            if (!tarifYemek.trim()) {
                alert('‚ö†Ô∏è L√ºtfen yasaklanacak tarif kartƒ± adƒ±nƒ± girin!');
                return;
            }
            
            console.log('üö´ Yasak Kuralƒ±:', { menuYemek, tarifYemek });
            alert('‚úÖ Yasak kuralƒ± kaydedildi!\n\n' +
                  'Men√º: ' + menuYemek + '\n' +
                  'Yasak Tarif: ' + tarifYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/eslesmeme_kurallari.json'a kaydet
        }
        
        function saveDbEslestirme() {
            const menuYemek = document.getElementById('admin_db_yemek_adi').value;
            const dbYemek = document.getElementById('admin_db_eslestirme_adi').value;
            
            if (!dbYemek.trim()) {
                alert('‚ö†Ô∏è L√ºtfen veritabanƒ±ndaki yemek adƒ±nƒ± girin!');
                return;
            }
            
            console.log('üçΩÔ∏è Veritabanƒ± E≈üle≈ütirme:', { menuYemek, dbYemek });
            alert('‚úÖ Veritabanƒ± e≈üle≈ütirmesi kaydedildi!\n\n' +
                  'Men√º: ' + menuYemek + '\n' +
                  'Veritabanƒ±: ' + dbYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/yemek_veritabani_eslestirme.json'a kaydet
        }
        
        function saveDbYasakKurali() {
            const menuYemek = document.getElementById('admin_db_yasak_yemek_adi').value;
            const dbYemek = document.getElementById('admin_db_yasak_adi').value;
            
            if (!dbYemek.trim()) {
                alert('‚ö†Ô∏è L√ºtfen yasaklanacak veritabanƒ± yemek adƒ±nƒ± girin!');
                return;
            }
            
            console.log('‚õî Veritabanƒ± Yasak Kuralƒ±:', { menuYemek, dbYemek });
            alert('‚úÖ Veritabanƒ± yasak kuralƒ± kaydedildi!\n\n' +
                  'Men√º: ' + menuYemek + '\n' +
                  'Yasak Veritabanƒ±: ' + dbYemek + '\n\n' +
                  '(GitHub API entegrasyonu eklenecek)');
            
            // TODO: GitHub API ile data/yemek_veritabani_yasaklar.json'a kaydet
        }
        
        // Kalori otomatik hesaplama (Tab 5 i√ßin)
        function calculateKaloriForAddFood() {
            const protein = parseFloat(document.getElementById('admin_db_ekle_protein').value) || 0;
            const karb = parseFloat(document.getElementById('admin_db_ekle_karb').value) || 0;
            const yag = parseFloat(document.getElementById('admin_db_ekle_yag').value) || 0;
            
            // Kalori = (Protein √ó 4) + (Karb √ó 4) + (Yaƒü √ó 9)
            const kalori = (protein * 4) + (karb * 4) + (yag * 9);
            
            document.getElementById('admin_db_ekle_kalori').value = kalori.toFixed(1);
        }
        
        function saveYeniYemek() {
            // T√ºm form verilerini topla
            const yemekAdi = document.getElementById('admin_db_ekle_yemek_adi').value;
            const kalori = parseFloat(document.getElementById('admin_db_ekle_kalori').value);
            const protein = parseFloat(document.getElementById('admin_db_ekle_protein').value);
            const karb = parseFloat(document.getElementById('admin_db_ekle_karb').value);
            const yag = parseFloat(document.getElementById('admin_db_ekle_yag').value);
            const kategori = document.getElementById('admin_db_ekle_kategori').value;
            const rol = document.getElementById('admin_db_ekle_rol').value;
            
            // Zorunlu alanlarƒ± kontrol et (0 deƒüerine izin ver - bazƒ± yemekler doƒüal olarak 0 protein/karb/yaƒü i√ßerir)
            if (!yemekAdi || kalori === undefined || isNaN(kalori) || 
                protein === undefined || isNaN(protein) || 
                karb === undefined || isNaN(karb) || 
                yag === undefined || isNaN(yag) || 
                !kategori || !rol) {
                alert('‚ö†Ô∏è L√ºtfen zorunlu alanlarƒ± doldurun (Yemek Adƒ±, Makrolar, Kategori, Rol)!');
                return;
            }
            
            // √ñƒü√ºn tipleri
            const mealTypes = [];
            if (document.getElementById('admin_mealType_breakfast').checked) mealTypes.push('breakfast');
            if (document.getElementById('admin_mealType_lunch').checked) mealTypes.push('lunch');
            if (document.getElementById('admin_mealType_dinner').checked) mealTypes.push('dinner');
            
            // Diyet tipleri
            const dietTypes = [];
            if (document.getElementById('admin_dietType_ketojenik').checked) dietTypes.push('ketojenik');
            if (document.getElementById('admin_dietType_akdeniz').checked) dietTypes.push('akdeniz');
            if (document.getElementById('admin_dietType_vegan').checked) dietTypes.push('vegan');
            if (document.getElementById('admin_dietType_glutensiz').checked) dietTypes.push('glutensiz');
            
            // √ñzel √∂zellikler
            const ozelOzellikler = {
                keto: document.getElementById('admin_keto').checked,
                lowcarb: document.getElementById('admin_lowcarb').checked,
                portionFixed: document.getElementById('admin_portionFixed').checked,
                fillerLunch: document.getElementById('admin_fillerLunch').checked,
                fillerDinner: document.getElementById('admin_fillerDinner').checked,
                isReversedSeason: document.getElementById('admin_reversedSeason').checked
            };
            
            // Etiketler
            const tags = document.getElementById('admin_db_ekle_tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            const compatibilityTags = document.getElementById('admin_db_ekle_compat').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            const incompatibilityTags = document.getElementById('admin_db_ekle_incompat').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            
            // Sezon range
            const seasonMin = parseInt(document.getElementById('admin_db_ekle_season_min').value);
            const seasonMax = parseInt(document.getElementById('admin_db_ekle_season_max').value);
            const seasonRange = (seasonMin && seasonMax) ? `[${seasonMin},${seasonMax}]` : undefined;
            
            // Yeni yemek objesi olu≈ütur (food_list.json formatƒ±nda - TAM PARAMETRELER)
            const yeniYemek = {
                name: yemekAdi,
                category: kategori,
                calories: kalori,
                protein: protein,
                carbs: karb,
                fat: yag,
                multiplier: parseFloat(document.getElementById('admin_db_ekle_portion').value) || 1,
                role: rol
            };
            
            // Opsiyonel parametreler - sadece dolu olanlarƒ± ekle
            const minQuantity = parseFloat(document.getElementById('admin_db_ekle_min').value);
            if (!isNaN(minQuantity) && minQuantity > 0) yeniYemek.minQuantity = minQuantity;
            
            const maxQuantity = parseFloat(document.getElementById('admin_db_ekle_max').value);
            if (!isNaN(maxQuantity) && maxQuantity > 0) yeniYemek.maxQuantity = maxQuantity;
            
            const step = parseFloat(document.getElementById('admin_db_ekle_step').value);
            if (!isNaN(step) && step > 0) yeniYemek.step = step;
            
            // √ñƒü√ºn tipleri (bo≈ü array bile ekle - JSON formatƒ± i√ßin gerekli)
            yeniYemek.mealType = mealTypes;
            
            // Diyet tipleri (bo≈ü array bile ekle)
            if (dietTypes.length > 0) yeniYemek.dietTypes = dietTypes;
            
            // Boolean √∂zellikler (her zaman ekle - JSON formatƒ± i√ßin gerekli)
            yeniYemek.keto = ozelOzellikler.keto;
            yeniYemek.lowcarb = ozelOzellikler.lowcarb;
            yeniYemek.portionFixed = ozelOzellikler.portionFixed;
            yeniYemek.fillerLunch = ozelOzellikler.fillerLunch;
            yeniYemek.fillerDinner = ozelOzellikler.fillerDinner;
            yeniYemek.isReversedSeason = ozelOzellikler.isReversedSeason;
            
            // Etiketler (bo≈ü array bile ekle - JSON formatƒ± i√ßin gerekli)
            yeniYemek.tags = tags;
            yeniYemek.compatibilityTags = compatibilityTags;
            yeniYemek.incompatibilityTags = incompatibilityTags;
            
            // Sezon range (varsa ekle)
            if (seasonRange) yeniYemek.seasonRange = seasonRange;
            
            // Notlar (varsa ekle)
            const notes = document.getElementById('admin_db_ekle_notes').value.trim();
            if (notes) yeniYemek.notes = notes;
            
            console.log('‚ûï Yeni Yemek (food_list.json formatƒ±):', JSON.stringify(yeniYemek, null, 2));
            
            // GitHub API ile kaydet
            saveFoodToGitHub(yeniYemek);
        }
        
        // GitHub'a yemek kaydetme fonksiyonu
        async function saveFoodToGitHub(yemekObj) {
            try {
                const GITHUB_TOKEN = localStorage.getItem('github_token');
                if (!GITHUB_TOKEN) {
                    alert('‚ö†Ô∏è GitHub token bulunamadƒ±!\n\nL√ºtfen √∂nce GitHub token\'ƒ±nƒ±zƒ± ayarlayƒ±n.');
                    return;
                }
                
                const OWNER = 'mustafasacar35';
                const REPO = 'lipodem-takip-paneli';
                const BRANCH = 'main';
                const FILE_PATH = 'food_list.json';
                
                // 1. Mevcut dosyayƒ± √ßek
                console.log('üì• food_list.json √ßekiliyor...');
                const getResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!getResponse.ok) {
                    throw new Error(`Dosya √ßekilemedi: ${getResponse.status} ${getResponse.statusText}`);
                }
                
                const fileData = await getResponse.json();
                const currentContent = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
                const currentJson = JSON.parse(currentContent);
                
                // 2. Yemeƒüi kategoriye ekle veya g√ºncelle
                console.log('üîç Kategori bulunuyor:', yemekObj.category);
                
                let categoryFound = false;
                let foodUpdated = false;
                
                // Kategorilerde ara
                for (let cat of currentJson.categories) {
                    if (cat.name === yemekObj.category) {
                        categoryFound = true;
                        
                        // Aynƒ± isimde yemek var mƒ± kontrol et
                        const existingIndex = cat.items.findIndex(item => item.name === yemekObj.name);
                        
                        if (existingIndex !== -1) {
                            // G√úNCELLEME
                            cat.items[existingIndex] = yemekObj;
                            foodUpdated = true;
                            console.log('‚úèÔ∏è Mevcut yemek g√ºncellendi:', yemekObj.name);
                        } else {
                            // YENƒ∞ EKLEME
                            cat.items.push(yemekObj);
                            console.log('‚ûï Yeni yemek kategoriye eklendi:', yemekObj.name);
                        }
                        break;
                    }
                }
                
                // Kategori yoksa yeni kategori olu≈ütur
                if (!categoryFound) {
                    console.log('üÜï Yeni kategori olu≈üturuluyor:', yemekObj.category);
                    currentJson.categories.push({
                        name: yemekObj.category,
                        items: [yemekObj]
                    });
                }
                
                // 3. Metadata g√ºncelle
                currentJson.lastUpdated = new Date().toISOString();
                
                // 4. JSON'u string'e √ßevir (‚úÖ T√úRK√áE KARAKTER KORUYAN)
                const updatedContent = JSON.stringify(currentJson, null, 2);
                const encodedContent = encodeBase64UTF8(updatedContent);
                
                // 5. GitHub'a commit et
                console.log('üíæ GitHub\'a kaydediliyor...');
                const commitMessage = foodUpdated 
                    ? `Yemek g√ºncellendi: ${yemekObj.name}`
                    : `Yeni yemek eklendi: ${yemekObj.name}`;
                
                const putResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: commitMessage,
                            content: encodedContent,
                            sha: fileData.sha,
                            branch: BRANCH
                        })
                    }
                );
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub commit ba≈üarƒ±sƒ±z: ${putResponse.status} - ${errorData.message}`);
                }
                
                const commitData = await putResponse.json();
                console.log('‚úÖ GitHub\'a kaydedildi:', commitData.commit.sha);
                
                // ‚úÖ Ba≈üarƒ± mesajƒ± (toast - daha az invasive)
                showToast(`‚úÖ ${foodUpdated ? 'Yemek g√ºncellendi' : 'Yeni yemek eklendi'}: ${yemekObj.name}`, 'success');
                
                // üîÑ foodData'yƒ± ANINDA yenile (GitHub'dan deƒüil, local'de g√ºncelle - daha hƒ±zlƒ±)
                await updateLocalFoodData(yemekObj);
                
                // üóëÔ∏è MANUEL E≈ûLE≈ûTƒ∞RMEYƒ∞ Sƒ∞L (artƒ±k gerekli deƒüil - yemek veritabanƒ±nda)
                await removeManualMapping(yemekObj.name);
                
                // üé® Render'ƒ± ANINDA g√ºncelle (kullanƒ±cƒ± deƒüi≈üikliƒüi g√∂rs√ºn)
                renderWeekContent();
                
                // üìã selectedFoodForAdmin varsa (men√º kartƒ±ndan a√ßƒ±ldƒ±ysa) o kartƒ± da g√ºncelle
                if (window.selectedFoodForAdmin) {
                    const { weekIndex, dayIndex, mealIndex, foodIndex } = window.selectedFoodForAdmin;
                    updateFoodInMenu(weekIndex, dayIndex, mealIndex, foodIndex, yemekObj);
                }
                
                // üö™ Modal'ƒ± kapat
                closeAdminFoodModal();
                
            } catch (error) {
                console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
                alert(`‚ùå Kaydetme ba≈üarƒ±sƒ±z!\n\n${error.message}\n\nL√ºtfen GitHub token\'ƒ±nƒ±zƒ± kontrol edin.`);
            }
        }
        
        /**
         * üîÑ Local foodData'yƒ± g√ºncelle (GitHub'dan yeniden y√ºklemeden)
         * Performance optimization - ANINDA g√ºncelleme i√ßin
         */
        async function updateLocalFoodData(yemekObj) {
            try {
                // foodData'da ara
                const existingIndex = foodData.findIndex(f => 
                    normalizeTr(f.name) === normalizeTr(yemekObj.name)
                );
                
                if (existingIndex !== -1) {
                    // G√úNCELLEME - mevcut yemeƒüi deƒüi≈ütir
                    foodData[existingIndex] = { ...foodData[existingIndex], ...yemekObj };
                    console.log('üîÑ Local foodData g√ºncellendi:', yemekObj.name);
                } else {
                    // YENƒ∞ EKLEME - array'e ekle
                    foodData.push(yemekObj);
                    console.log('‚ûï Local foodData\'ya eklendi:', yemekObj.name);
                }
                
                console.log(`‚úÖ Local foodData g√ºncel (${foodData.length} yemek)`);
            } catch (error) {
                console.warn('‚ö†Ô∏è Local foodData g√ºncellenemedi, GitHub\'dan y√ºklenecek:', error);
                // Fallback: GitHub'dan yeniden y√ºkle
                foodData = [];
                await loadFoodData();
            }
        }
        
        /**
         * üóëÔ∏è Manuel e≈üle≈ütirmeyi sil (yemek veritabanƒ±na eklendikten sonra)
         * @param {string} foodName - Silinecek yemek adƒ±
         */
        async function removeManualMapping(foodName) {
            try {
                const GITHUB_TOKEN = localStorage.getItem('github_token');
                if (!GITHUB_TOKEN) {
                    console.warn('‚ö†Ô∏è GitHub token yok, manuel e≈üle≈ütirme silinemedi');
                    return;
                }
                
                const OWNER = 'mustafasacar35';
                const REPO = 'lipodem-takip-paneli';
                const BRANCH = 'main';
                const FILE_PATH = 'data/yemek_veritabani_eslestirme.json';
                
                // 1. Mevcut dosyayƒ± √ßek
                console.log('üì• yemek_veritabani_eslestirme.json √ßekiliyor...');
                const getResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!getResponse.ok) {
                    console.warn('‚ö†Ô∏è yemek_veritabani_eslestirme.json bulunamadƒ±');
                    return;
                }
                
                const fileData = await getResponse.json();
                const currentContent = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
                const currentJson = JSON.parse(currentContent);
                
                // 2. Yemeƒüi sil (case-insensitive kar≈üƒ±la≈ütƒ±rma)
                const normalizedFoodName = normalizeTr(foodName);
                const initialCount = Object.keys(currentJson).length;
                
                let deleted = false;
                for (let key in currentJson) {
                    if (normalizeTr(key) === normalizedFoodName) {
                        delete currentJson[key];
                        deleted = true;
                        console.log('üóëÔ∏è Manuel e≈üle≈ütirme silindi:', key);
                        break;
                    }
                }
                
                if (!deleted) {
                    console.log('‚ÑπÔ∏è Manuel e≈üle≈ütirme bulunamadƒ±:', foodName);
                    return;
                }
                
                const finalCount = Object.keys(currentJson).length;
                console.log(`üìä E≈üle≈ütirme sayƒ±sƒ±: ${initialCount} ‚Üí ${finalCount}`);
                
                // 3. JSON'u string'e √ßevir (T√úRK√áE KARAKTER KORUYAN)
                const updatedContent = JSON.stringify(currentJson, null, 2);
                const encodedContent = encodeBase64UTF8(updatedContent);
                
                // 4. GitHub'a commit et
                console.log('üíæ GitHub\'a kaydediliyor...');
                const commitMessage = `Manuel e≈üle≈ütirme silindi: ${foodName} (artƒ±k veritabanƒ±nda)`;
                
                const putResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: commitMessage,
                            content: encodedContent,
                            sha: fileData.sha,
                            branch: BRANCH
                        })
                    }
                );
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub commit ba≈üarƒ±sƒ±z: ${putResponse.status} - ${errorData.message}`);
                }
                
                const commitData = await putResponse.json();
                console.log('‚úÖ Manuel e≈üle≈ütirme GitHub\'dan silindi:', commitData.commit.sha);
                
                // 5. Local yemekVeritabaniEslestirme'yi g√ºncelle
                if (window.yemekVeritabaniEslestirme) {
                    for (let key in window.yemekVeritabaniEslestirme) {
                        if (normalizeTr(key) === normalizedFoodName) {
                            delete window.yemekVeritabaniEslestirme[key];
                            console.log('üîÑ Local e≈üle≈ütirme silindi:', key);
                            break;
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Manuel e≈üle≈ütirme silinemedi:', error);
                // Hata durumunda devam et - kritik deƒüil
            }
        }
        
        /**
         * üé® Men√º kartƒ±nda yemeƒüi ANINDA g√ºncelle (render beklemeden)
         * Kullanƒ±cƒ± deƒüi≈üikliƒüi hemen g√∂rs√ºn
         */
        function updateFoodInMenu(weekIndex, dayIndex, mealIndex, foodIndex, yemekObj) {
            try {
                const week = weeks[weekIndex];
                if (!week) return;
                
                const day = week.days[dayIndex];
                if (!day) return;
                
                const meal = (day.meals || day.ogunler || [])[mealIndex];
                if (!meal) return;
                
                const food = (meal.yemekler || [])[foodIndex];
                if (!food) return;
                
                // Yemek bilgilerini g√ºncelle (SADECE makrolarƒ± - isim deƒüi≈ümez)
                food.calories = yemekObj.calories || food.calories || 0;
                food.kalori = yemekObj.calories || food.kalori || 0;
                food.protein = yemekObj.protein || food.protein || 0;
                food.carbs = yemekObj.carbs || food.carbs || 0;
                food.karbonhidrat = yemekObj.carbs || food.karbonhidrat || 0;
                food.fat = yemekObj.fat || food.fat || 0;
                food.yag = yemekObj.fat || food.yag || 0;
                food.category = yemekObj.category || food.category;
                food.role = yemekObj.role || food.role;
                
                // eslesenYemek objesi varsa (foodData'dan geliyorsa) g√ºncelle
                if (food.eslesenYemek) {
                    food.eslesenYemek = { ...food.eslesenYemek, ...yemekObj };
                }
                
                console.log('üé® Men√º kartƒ± g√ºncellendi:', {
                    weekIndex, dayIndex, mealIndex, foodIndex,
                    yemek: food.foodName || food.name,
                    yeniMakrolar: {
                        kalori: food.calories,
                        protein: food.protein,
                        karb: food.carbs,
                        yag: food.fat
                    }
                });
                
                // Render'ƒ± tetikle (deƒüi≈üiklikler g√∂r√ºns√ºn)
                renderWeekContent();
                
            } catch (error) {
                console.error('‚ùå Men√º kartƒ± g√ºncellenemedi:', error);
                // Fallback: Full render yap
                renderWeekContent();
            }
        }
        
        // ========================================
        // üìù TEMPLATE EDIT MODAL FUNCTIONS
        // ========================================
        
        let currentEditingTemplate = null; // D√ºzenlenmekte olan ≈üablon
        
        /**
         * ≈ûablon d√ºzenleme modalƒ±nƒ± a√ß
         * @param {string} templateId - D√ºzenlenecek ≈üablon ID
         */
        window.openTemplateEditModal = async function(templateId) {
            const templateMetadata = dayTemplates.find(t => t.id === templateId);
            if (!templateMetadata) {
                alert('‚ùå ≈ûablon bulunamadƒ±!');
                return;
            }
            
            // üîç DEBUG - Check if we have metadata or full template
            console.log('üîç DEBUG - templateMetadata:', templateMetadata);
            console.log('üîç DEBUG - Has filename?', !!templateMetadata.filename);
            console.log('üîç DEBUG - Has ogunler?', !!templateMetadata.ogunler);
            
            // If template only has metadata (no ogunler), load full template
            let template = templateMetadata;
            if (!templateMetadata.ogunler && templateMetadata.filename) {
                try {
                    console.log('üì• Loading full template from:', templateMetadata.filename);
                    template = await TemplateManager.loadTemplate(templateMetadata.filename);
                    console.log('‚úÖ Full template loaded:', template);
                } catch (error) {
                    console.error('‚ùå Failed to load full template:', error);
                    alert('‚ùå ≈ûablon y√ºklenemedi: ' + error.message);
                    return;
                }
            }
            
            currentEditingTemplate = JSON.parse(JSON.stringify(template)); // Deep copy
            
            // Modal'ƒ± g√∂ster
            const modal = document.getElementById('templateEditModal');
            if (modal) {
                // ≈ûablon adƒ±nƒ± g√∂ster
                document.getElementById('templateEditName').textContent = template.name || 'ƒ∞simsiz ≈ûablon';
                
                // √ñƒü√ºnleri render et
                renderTemplateEditContent();
                
                // üîë Token'ƒ± otomatik y√ºkle (varsa)
                const savedToken = localStorage.getItem('github_token');
                const tokenInput = document.getElementById('templateGithubToken');
                if (savedToken && tokenInput) {
                    tokenInput.value = savedToken;
                    console.log('‚úÖ GitHub token otomatik y√ºklendi');
                }
                
                modal.style.display = 'block';
                console.log('üìù Template edit modal a√ßƒ±ldƒ±:', templateId);
            } else {
                alert('‚ö†Ô∏è Template edit modal y√ºklenemedi!');
            }
        };
        
        /**
         * ≈ûablon d√ºzenleme modalƒ±nƒ± kapat
         */
        window.closeTemplateEditModal = function() {
            const modal = document.getElementById('templateEditModal');
            if (modal) {
                modal.style.display = 'none';
                currentEditingTemplate = null;
            }
        };
        
        /**
         * üîë GitHub Token y√∂netimi - ≈ûablon modalƒ± i√ßin
         */
        window.toggleTemplateTokenVisibility = function() {
            const tokenInput = document.getElementById('templateGithubToken');
            if (!tokenInput) return;
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
            } else {
                tokenInput.type = 'password';
            }
        };
        
        window.loadTemplateTokenFromStorage = function() {
            const token = localStorage.getItem('github_token');
            const tokenInput = document.getElementById('templateGithubToken');
            
            if (token) {
                tokenInput.value = token;
                alert('‚úÖ Token localStorage\'dan y√ºklendi!');
            } else {
                alert('‚ö†Ô∏è localStorage\'da github_token bulunamadƒ±!\n\nL√ºtfen token girin ve tarayƒ±cƒ±nƒ±zda kaydedin.');
            }
        };
        
        /**
         * ≈ûablon i√ßeriƒüini render et (√∂ƒü√ºnler + yemekler)
         */
        function renderTemplateEditContent() {
            if (!currentEditingTemplate) return;
            
            const container = document.getElementById('templateEditContent');
            if (!container) return;
            
            let html = '';
            
            // üîç DEBUG - ≈ûablon veri yapƒ±sƒ±nƒ± kontrol et
            console.log('üîç DEBUG - currentEditingTemplate:', currentEditingTemplate);
            console.log('üîç DEBUG - currentEditingTemplate.ogunler:', currentEditingTemplate.ogunler);
            console.log('üîç DEBUG - √ñƒü√ºn sayƒ±sƒ±:', (currentEditingTemplate.ogunler || []).length);
            
            // √ñƒü√ºnleri d√∂ng√ºyle i≈üle
            (currentEditingTemplate.ogunler || []).forEach((ogun, ogunIndex) => {
                const ogunAdi = ogun.ogunAdi || ogun.mealName || `√ñƒü√ºn ${ogunIndex + 1}`;
                const yemekler = ogun.yemekler || [];
                
                // √ñƒü√ºn toplamlarƒ±nƒ± hesapla
                const ogunTotals = yemekler.reduce((acc, y) => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                    return acc;
                }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
                
                html += `
                    <div class="template-edit-ogun" style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">
                            üçΩÔ∏è ${ogunAdi.charAt(0).toUpperCase() + ogunAdi.slice(1)}
                            <span style="float: right; font-size: 13px; font-weight: normal; color: #666;">
                                ${Math.round(ogunTotals.kalori)} kcal | 
                                P: ${Math.round(ogunTotals.protein)}g | 
                                K: ${Math.round(ogunTotals.karb)}g | 
                                Y: ${Math.round(ogunTotals.yag)}g
                            </span>
                        </h4>
                        
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #e3f2fd;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Yemek Adƒ±</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 80px;">Kalori</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Protein</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Karb</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 70px;">Yaƒü</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 180px;">ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                yemekler.forEach((yemek, yemekIndex) => {
                    const isFirst = yemekIndex === 0;
                    const isLast = yemekIndex === yemekler.length - 1;
                    
                    html += `
                        <tr style="background: white;">
                            <td style="padding: 8px; border: 1px solid #ddd;">${yemek.foodName || 'ƒ∞simsiz Yemek'}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.calories || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.protein || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.carbs || 0)}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${Math.round(yemek.fat || 0)}</td>
                            <td style="padding: 6px; text-align: center; border: 1px solid #ddd;">
                                <button onclick="editTemplateFood(${ogunIndex}, ${yemekIndex})" style="background: #2196F3; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 12px;" title="D√ºzenle">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteTemplateFood(${ogunIndex}, ${yemekIndex})" style="background: #f44336; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 4px; font-size: 12px;" title="Sil">
                                    üóëÔ∏è
                                </button>
                                <button onclick="moveTemplateFoodUp(${ogunIndex}, ${yemekIndex})" ${isFirst ? 'disabled' : ''} style="background: ${isFirst ? '#ccc' : '#ff9800'}; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: ${isFirst ? 'not-allowed' : 'pointer'}; border-radius: 4px; font-size: 12px;" title="Yukarƒ± Ta≈üƒ±">
                                    ‚¨ÜÔ∏è
                                </button>
                                <button onclick="moveTemplateFoodDown(${ogunIndex}, ${yemekIndex})" ${isLast ? 'disabled' : ''} style="background: ${isLast ? '#ccc' : '#ff9800'}; color: white; border: none; padding: 4px 8px; margin: 2px; cursor: ${isLast ? 'not-allowed' : 'pointer'}; border-radius: 4px; font-size: 12px;" title="A≈üaƒüƒ± Ta≈üƒ±">
                                    ‚¨áÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    // Araya satƒ±r ekleme butonu (son satƒ±r hari√ß)
                    if (!isLast) {
                        html += `
                            <tr style="background: #f0f0f0;">
                                <td colspan="6" style="padding: 4px; text-align: center; border: 1px solid #ddd;">
                                    <button onclick="insertTemplateFoodBetween(${ogunIndex}, ${yemekIndex})" style="background: #4CAF50; color: white; border: none; padding: 4px 12px; cursor: pointer; border-radius: 4px; font-size: 11px;" title="Araya Yemek Ekle">
                                        ‚ûï Araya Ekle
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            // G√ºn toplamlarƒ±
            const gunTotals = (currentEditingTemplate.ogunler || []).reduce((acc, ogun) => {
                (ogun.yemekler || []).forEach(y => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                });
                return acc;
            }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            
            // Makro kaloriler (protein: 4 kcal/g, karb: 4 kcal/g, yaƒü: 9 kcal/g)
            const proteinKcal = gunTotals.protein * 4;
            const karbKcal = gunTotals.karb * 4;
            const yagKcal = gunTotals.yag * 9;
            const totalMacroKcal = proteinKcal + karbKcal + yagKcal;
            
            // Y√ºzde oranlarƒ±
            const proteinPercent = totalMacroKcal > 0 ? ((proteinKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            const karbPercent = totalMacroKcal > 0 ? ((karbKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            const yagPercent = totalMacroKcal > 0 ? ((yagKcal / totalMacroKcal) * 100).toFixed(1) : 0;
            
            html += `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üìä G√ºnl√ºk Toplam</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">KALORI</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.kalori)} <span style="font-size: 14px; font-weight: normal;">kcal</span></div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #f44336;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">PROTEIN</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.protein)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${proteinPercent}% ‚Ä¢ ${Math.round(proteinKcal)} kcal</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #2196F3;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">KARBONHIDRAT</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.karb)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${karbPercent}% ‚Ä¢ ${Math.round(karbKcal)} kcal</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #4CAF50;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 4px;">YAƒû</div>
                            <div style="font-size: 20px; font-weight: 700; color: #333;">${Math.round(gunTotals.yag)} <span style="font-size: 14px; font-weight: normal;">g</span></div>
                            <div style="font-size: 11px; color: #999;">${yagPercent}% ‚Ä¢ ${Math.round(yagKcal)} kcal</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        /**
         * Yemek satƒ±rƒ±nƒ± sil
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.deleteTemplateFood = async function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler) return;
            
            const yemekAdi = ogun.yemekler[yemekIndex]?.foodName || 'Bu yemek';
            
            if (confirm(`üóëÔ∏è "${yemekAdi}" silinecek. Emin misiniz?`)) {
                // 1Ô∏è‚É£ Veriyi sil
                ogun.yemekler.splice(yemekIndex, 1);
                
                // 2Ô∏è‚É£ Eƒüer √∂ƒü√ºn bo≈üaldƒ±ysa, √∂ƒü√ºn√º de sil
                if (ogun.yemekler.length === 0) {
                    currentEditingTemplate.ogunler.splice(ogunIndex, 1);
                    showTemplateEditNotification('üóëÔ∏è √ñƒü√ºn bo≈üaldƒ± ve silindi', 'warning');
                }
                
                // 3Ô∏è‚É£ Modal'ƒ± ANINDA g√ºncelle
                renderTemplateEditContent();
                
                // 4Ô∏è‚É£ Render ve JSON'ƒ± g√ºncelle
                await syncTemplateChangesToWeeks();
                
                // 5Ô∏è‚É£ Bildirim g√∂ster
                showTemplateEditNotification('üóëÔ∏è Silindi: ' + yemekAdi, 'success');
                
                console.log('üóëÔ∏è Yemek silindi:', yemekAdi);
            }
        };
        
        /**
         * Yemeƒüi yukarƒ± ta≈üƒ±
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.moveTemplateFoodUp = async function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate || yemekIndex === 0) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler) return;
            
            // 1Ô∏è‚É£ Array'de yer deƒüi≈ütir
            const temp = ogun.yemekler[yemekIndex];
            ogun.yemekler[yemekIndex] = ogun.yemekler[yemekIndex - 1];
            ogun.yemekler[yemekIndex - 1] = temp;
            
            // 2Ô∏è‚É£ Modal'ƒ± ANINDA g√ºncelle
            renderTemplateEditContent();
            
            // 3Ô∏è‚É£ Render ve JSON'ƒ± g√ºncelle
            await syncTemplateChangesToWeeks();
            
            // 4Ô∏è‚É£ Bildirim g√∂ster
            showTemplateEditNotification('‚¨ÜÔ∏è Yemek yukarƒ± ta≈üƒ±ndƒ±', 'success');
            
            console.log('‚¨ÜÔ∏è Yemek yukarƒ± ta≈üƒ±ndƒ±');
        };
        
        /**
         * Yemeƒüi a≈üaƒüƒ± ta≈üƒ±
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.moveTemplateFoodDown = async function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun || !ogun.yemekler || yemekIndex === ogun.yemekler.length - 1) return;
            
            // 1Ô∏è‚É£ Array'de yer deƒüi≈ütir
            const temp = ogun.yemekler[yemekIndex];
            ogun.yemekler[yemekIndex] = ogun.yemekler[yemekIndex + 1];
            ogun.yemekler[yemekIndex + 1] = temp;
            
            // 2Ô∏è‚É£ Modal'ƒ± ANINDA g√ºncelle
            renderTemplateEditContent();
            
            // 3Ô∏è‚É£ Render ve JSON'ƒ± g√ºncelle
            await syncTemplateChangesToWeeks();
            
            // 4Ô∏è‚É£ Bildirim g√∂ster
            showTemplateEditNotification('‚¨áÔ∏è Yemek a≈üaƒüƒ± ta≈üƒ±ndƒ±', 'success');
            
            console.log('‚¨áÔ∏è Yemek a≈üaƒüƒ± ta≈üƒ±ndƒ±');
        };
        
        /**
         * ƒ∞ki yemek arasƒ±na yeni yemek ekle
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} afterIndex - Hangi yemekten sonra eklenecek
         */
        window.insertTemplateFoodBetween = function(ogunIndex, afterIndex) {
            if (!currentEditingTemplate) return;
            
            // Yemek ekleme popup'ƒ±nƒ± a√ß
            openFoodSearchPopup(ogunIndex, afterIndex + 1, 'insert');
        };
        
        /**
         * Yemeƒüi d√ºzenle
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        // Global state for food editing
        let currentEditingFoodState = {
            ogunIndex: null,
            yemekIndex: null,
            originalFoodName: null,
            originalFood: null
        };
        
        /**
         * Yemek d√ºzenleme modalƒ±nƒ± a√ß
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         */
        window.editTemplateFood = function(ogunIndex, yemekIndex) {
            if (!currentEditingTemplate) return;
            
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            if (!ogun) return;
            
            const food = ogun.yemekler[yemekIndex];
            if (!food) return;
            
            const foodName = food.foodName || food.name || 'ƒ∞simsiz Yemek';
            
            // Global state'i kaydet
            currentEditingFoodState = {
                ogunIndex,
                yemekIndex,
                originalFoodName: foodName,
                originalFood: JSON.parse(JSON.stringify(food)) // Deep copy
            };
            
            // food_list.json'da bu yemeƒüi bul (zenginle≈ütirilmi≈ü veriler i√ßin)
            const dbFood = findFoodInDatabase(foodName);
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
            document.getElementById('editFoodModalTitle').textContent = foodName;
            
            // Formlarƒ± doldur
            document.getElementById('editFoodName').value = foodName;
            
            if (dbFood) {
                // ‚úÖ VERƒ∞TABANINDA VAR - T√úM PARAMETRELERƒ∞ DOLDUR
                console.log('‚úÖ Yemek veritabanƒ±nda bulundu:', dbFood.name);
                document.getElementById('editFoodCalories').value = dbFood.calories || 0;
                document.getElementById('editFoodProtein').value = dbFood.protein || 0;
                document.getElementById('editFoodCarbs').value = dbFood.carbs || 0;
                document.getElementById('editFoodFat').value = dbFood.fat || 0;
                document.getElementById('editFoodCategory').value = dbFood.category || '';
                document.getElementById('editFoodRole').value = dbFood.role || '';
                
                // √ñƒü√ºn tipleri
                const mealTypes = dbFood.mealType || dbFood.mealTypes || [];
                document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
                document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
                document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
                
                // Porsiyon
                document.getElementById('editFoodPortion').value = dbFood.portionMultiplier || dbFood.multiplier || 1;
                
                // Diyet tipleri
                const dietTypes = dbFood.dietTypes || [];
                document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
                document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
                document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
                document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
                
                // Min/Max/Step
                document.getElementById('editFoodMin').value = dbFood.minQuantity || '';
                document.getElementById('editFoodMax').value = dbFood.maxQuantity || '';
                document.getElementById('editFoodStep').value = dbFood.step || '';
                
                // Sezon
                if (dbFood.seasonRange) {
                    try {
                        const season = JSON.parse(dbFood.seasonRange);
                        document.getElementById('editFoodSeasonMin').value = season[0] || '';
                        document.getElementById('editFoodSeasonMax').value = season[1] || '';
                    } catch (e) {
                        document.getElementById('editFoodSeasonMin').value = '';
                        document.getElementById('editFoodSeasonMax').value = '';
                    }
                } else {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
                
                // √ñzel √∂zellikler
                document.getElementById('editFoodKeto').checked = dbFood.keto || false;
                document.getElementById('editFoodLowCarb').checked = dbFood.lowcarb || false;
                document.getElementById('editFoodPortionFixed').checked = dbFood.portionFixed || false;
                document.getElementById('editFoodFillerLunch').checked = dbFood.fillerLunch || false;
                document.getElementById('editFoodFillerDinner').checked = dbFood.fillerDinner || false;
                document.getElementById('editFoodReversedSeason').checked = dbFood.isReversedSeason || false;
                
                // Etiketler
                document.getElementById('editFoodTags').value = (dbFood.tags || []).join(', ');
                document.getElementById('editFoodCompat').value = (dbFood.compatibilityTags || []).join(', ');
                document.getElementById('editFoodIncompat').value = (dbFood.incompatibilityTags || []).join(', ');
                
                // Notlar
                document.getElementById('editFoodNotes').value = dbFood.notes || '';
            } else {
                // ‚ö†Ô∏è VERƒ∞TABANINDA YOK - ≈ûablondaki deƒüerleri doldur
                console.log('‚ö†Ô∏è Yemek veritabanƒ±nda bulunamadƒ±, ≈üablon deƒüerleri kullanƒ±lƒ±yor');
                document.getElementById('editFoodCalories').value = food.calories || food.kalori || 0;
                document.getElementById('editFoodProtein').value = food.protein || 0;
                document.getElementById('editFoodCarbs').value = food.carbs || food.karbonhidrat || 0;
                document.getElementById('editFoodFat').value = food.fat || food.yag || 0;
                document.getElementById('editFoodCategory').value = food.category || '';
                document.getElementById('editFoodRole').value = food.role || '';
                
                // Diƒüer t√ºm alanlarƒ± sƒ±fƒ±rla
                document.getElementById('editMealType_breakfast').checked = false;
                document.getElementById('editMealType_lunch').checked = false;
                document.getElementById('editMealType_dinner').checked = false;
                document.getElementById('editFoodPortion').value = 1;
                document.getElementById('editDietType_ketojenik').checked = false;
                document.getElementById('editDietType_akdeniz').checked = false;
                document.getElementById('editDietType_vegan').checked = false;
                document.getElementById('editDietType_glutensiz').checked = false;
                document.getElementById('editFoodMin').value = '';
                document.getElementById('editFoodMax').value = '';
                document.getElementById('editFoodStep').value = '';
                document.getElementById('editFoodSeasonMin').value = '';
                document.getElementById('editFoodSeasonMax').value = '';
                document.getElementById('editFoodKeto').checked = false;
                document.getElementById('editFoodLowCarb').checked = false;
                document.getElementById('editFoodPortionFixed').checked = false;
                document.getElementById('editFoodFillerLunch').checked = false;
                document.getElementById('editFoodFillerDinner').checked = false;
                document.getElementById('editFoodReversedSeason').checked = false;
                document.getElementById('editFoodTags').value = '';
                document.getElementById('editFoodCompat').value = '';
                document.getElementById('editFoodIncompat').value = '';
                document.getElementById('editFoodNotes').value = '';
            }
            
            // food_list.json kaydetme checkbox'ƒ± varsayƒ±lan kapalƒ±
            document.getElementById('saveFoodToDatabase').checked = false;
            
            // Modalƒ± g√∂ster
            document.getElementById('templateFoodEditModal').style.display = 'block';
        };
        
        /**
         * Yemek d√ºzenleme modalƒ±nƒ± kapat
         */
        window.closeTemplateFoodEditModal = function() {
            document.getElementById('templateFoodEditModal').style.display = 'none';
            currentEditingFoodState = { ogunIndex: null, yemekIndex: null, originalFoodName: null, originalFood: null };
            
            // Arama dropdown'unu kapat
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * Yemek arama (akƒ±llƒ± search - dropdown)
         * @param {string} query - Arama terimi
         */
        window.searchFoodForEdit = function(query) {
            const resultsContainer = document.getElementById('editFoodSearchResults');
            if (!resultsContainer) return;
            
            // Bo≈ü arama - dropdown'u gizle
            if (!query || query.trim().length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Fuzzy search (normalizeTr kullanarak)
            const normalizedQuery = normalizeTr(query);
            const tokens = tokenize(query);
            
            let matches = foodData.filter(food => {
                const normalizedName = normalizeTr(food.name);
                
                // 1. Tam e≈üle≈üme
                if (normalizedName === normalizedQuery) return true;
                
                // 2. ƒ∞√ßeriyor mu?
                if (normalizedName.includes(normalizedQuery)) return true;
                
                // 3. Token bazlƒ± e≈üle≈üme
                const foodTokens = tokenize(food.name);
                return tokens.some(t => foodTokens.some(ft => ft.includes(t) || t.includes(ft)));
            });
            
            // ƒ∞lk 10 sonucu g√∂ster
            matches = matches.slice(0, 10);
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">Sonu√ß bulunamadƒ±</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± render et
            let html = '';
            matches.forEach(food => {
                html += `
                    <div onclick="selectFoodForEdit('${food.name.replace(/'/g, "\\'")}')" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${food.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${Math.round(food.calories || 0)} kcal | 
                            P: ${Math.round(food.protein || 0)}g | 
                            K: ${Math.round(food.carbs || 0)}g | 
                            Y: ${Math.round(food.fat || 0)}g
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        };
        
        /**
         * Arama sonucundan yemek se√ß
         * @param {string} foodName - Se√ßilen yemek adƒ±
         */
        window.selectFoodForEdit = function(foodName) {
            // Formu yeni yemeƒüin bilgileriyle doldur
            const dbFood = findFoodInDatabase(foodName);
            
            if (dbFood) {
                document.getElementById('editFoodName').value = dbFood.name;
                document.getElementById('editFoodCalories').value = dbFood.calories || 0;
                document.getElementById('editFoodProtein').value = dbFood.protein || 0;
                document.getElementById('editFoodCarbs').value = dbFood.carbs || 0;
                document.getElementById('editFoodFat').value = dbFood.fat || 0;
                document.getElementById('editFoodCategory').value = dbFood.category || '';
                document.getElementById('editFoodRole').value = dbFood.role || '';
                
                // √ñƒü√ºn tipleri
                const mealTypes = dbFood.mealType || dbFood.mealTypes || [];
                document.getElementById('editMealType_breakfast').checked = mealTypes.includes('breakfast');
                document.getElementById('editMealType_lunch').checked = mealTypes.includes('lunch');
                document.getElementById('editMealType_dinner').checked = mealTypes.includes('dinner');
                
                // Porsiyon
                document.getElementById('editFoodPortion').value = dbFood.portionMultiplier || dbFood.multiplier || 1;
                
                // Diyet tipleri
                const dietTypes = dbFood.dietTypes || [];
                document.getElementById('editDietType_ketojenik').checked = dietTypes.includes('ketojenik');
                document.getElementById('editDietType_akdeniz').checked = dietTypes.includes('akdeniz');
                document.getElementById('editDietType_vegan').checked = dietTypes.includes('vegan');
                document.getElementById('editDietType_glutensiz').checked = dietTypes.includes('glutensiz');
                
                // Min/Max/Step
                document.getElementById('editFoodMin').value = dbFood.minQuantity || '';
                document.getElementById('editFoodMax').value = dbFood.maxQuantity || '';
                document.getElementById('editFoodStep').value = dbFood.step || '';
                
                // Sezon
                if (dbFood.seasonRange) {
                    try {
                        const season = JSON.parse(dbFood.seasonRange);
                        document.getElementById('editFoodSeasonMin').value = season[0] || '';
                        document.getElementById('editFoodSeasonMax').value = season[1] || '';
                    } catch (e) {
                        document.getElementById('editFoodSeasonMin').value = '';
                        document.getElementById('editFoodSeasonMax').value = '';
                    }
                } else {
                    document.getElementById('editFoodSeasonMin').value = '';
                    document.getElementById('editFoodSeasonMax').value = '';
                }
                
                // √ñzel √∂zellikler
                document.getElementById('editFoodKeto').checked = dbFood.keto || false;
                document.getElementById('editFoodLowCarb').checked = dbFood.lowcarb || false;
                document.getElementById('editFoodPortionFixed').checked = dbFood.portionFixed || false;
                document.getElementById('editFoodFillerLunch').checked = dbFood.fillerLunch || false;
                document.getElementById('editFoodFillerDinner').checked = dbFood.fillerDinner || false;
                document.getElementById('editFoodReversedSeason').checked = dbFood.isReversedSeason || false;
                
                // Etiketler
                document.getElementById('editFoodTags').value = (dbFood.tags || []).join(', ');
                document.getElementById('editFoodCompat').value = (dbFood.compatibilityTags || []).join(', ');
                document.getElementById('editFoodIncompat').value = (dbFood.incompatibilityTags || []).join(', ');
                
                // Notlar
                document.getElementById('editFoodNotes').value = dbFood.notes || '';
            }
            
            // Dropdown'u kapat
            document.getElementById('editFoodSearchResults').style.display = 'none';
        };
        
        /**
         * D√ºzenlenen yemeƒüi kaydet
         * 3 SENARYO:
         * A) Aynƒ± yemek + parametre deƒüi≈üikliƒüi ‚Üí food_list.json + ≈üablon g√ºncelle
         * B) Farklƒ± yemek se√ßimi ‚Üí Sadece ≈üablonu deƒüi≈ütir
         * C) Farklƒ± yemek + parametre deƒüi≈üikliƒüi ‚Üí food_list.json + ≈üablon g√ºncelle
         */
        window.saveEditedTemplateFood = async function() {
            const { ogunIndex, yemekIndex, originalFoodName, originalFood } = currentEditingFoodState;
            
            if (ogunIndex === null || yemekIndex === null) return;
            
            // Formdan T√úM deƒüerleri al
            const newFoodName = document.getElementById('editFoodName').value.trim();
            const newCalories = parseFloat(document.getElementById('editFoodCalories').value) || 0;
            const newProtein = parseFloat(document.getElementById('editFoodProtein').value) || 0;
            const newCarbs = parseFloat(document.getElementById('editFoodCarbs').value) || 0;
            const newFat = parseFloat(document.getElementById('editFoodFat').value) || 0;
            const newCategory = document.getElementById('editFoodCategory').value.trim();
            const newRole = document.getElementById('editFoodRole').value.trim();
            
            // √ñƒü√ºn tipleri
            const newMealTypes = [];
            if (document.getElementById('editMealType_breakfast').checked) newMealTypes.push('breakfast');
            if (document.getElementById('editMealType_lunch').checked) newMealTypes.push('lunch');
            if (document.getElementById('editMealType_dinner').checked) newMealTypes.push('dinner');
            
            // Porsiyon
            const newPortion = parseFloat(document.getElementById('editFoodPortion').value) || 1;
            
            // Diyet tipleri
            const newDietTypes = [];
            if (document.getElementById('editDietType_ketojenik').checked) newDietTypes.push('ketojenik');
            if (document.getElementById('editDietType_akdeniz').checked) newDietTypes.push('akdeniz');
            if (document.getElementById('editDietType_vegan').checked) newDietTypes.push('vegan');
            if (document.getElementById('editDietType_glutensiz').checked) newDietTypes.push('glutensiz');
            
            // Min/Max/Step
            const newMin = document.getElementById('editFoodMin').value.trim();
            const newMax = document.getElementById('editFoodMax').value.trim();
            const newStep = document.getElementById('editFoodStep').value.trim();
            
            // Sezon
            const newSeasonMin = document.getElementById('editFoodSeasonMin').value.trim();
            const newSeasonMax = document.getElementById('editFoodSeasonMax').value.trim();
            const newSeasonRange = (newSeasonMin && newSeasonMax) ? JSON.stringify([parseInt(newSeasonMin), parseInt(newSeasonMax)]) : '';
            
            // √ñzel √∂zellikler
            const newKeto = document.getElementById('editFoodKeto').checked;
            const newLowCarb = document.getElementById('editFoodLowCarb').checked;
            const newPortionFixed = document.getElementById('editFoodPortionFixed').checked;
            const newFillerLunch = document.getElementById('editFoodFillerLunch').checked;
            const newFillerDinner = document.getElementById('editFoodFillerDinner').checked;
            const newReversedSeason = document.getElementById('editFoodReversedSeason').checked;
            
            // Etiketler
            const newTags = document.getElementById('editFoodTags').value.split(',').map(t => t.trim()).filter(t => t);
            const newCompat = document.getElementById('editFoodCompat').value.split(',').map(t => t.trim()).filter(t => t);
            const newIncompat = document.getElementById('editFoodIncompat').value.split(',').map(t => t.trim()).filter(t => t);
            
            // Notlar
            const newNotes = document.getElementById('editFoodNotes').value.trim();
            
            const saveToDB = document.getElementById('saveFoodToDatabase').checked;
            
            if (!newFoodName) {
                alert('‚ö†Ô∏è Yemek adƒ± bo≈ü olamaz!');
                return;
            }
            
            // ƒ∞sim normalizasyonu
            const originalNormalized = normalizeTr(originalFoodName);
            const newNormalized = normalizeTr(newFoodName);
            const isSameFood = originalNormalized === newNormalized;
            
            // Parametre deƒüi≈üikliƒüi var mƒ±?
            const hasParameterChange = 
                newCalories !== (originalFood.calories || originalFood.kalori || 0) ||
                newProtein !== (originalFood.protein || 0) ||
                newCarbs !== (originalFood.carbs || originalFood.karbonhidrat || 0) ||
                newFat !== (originalFood.fat || originalFood.yag || 0);
            
            console.log('üîç Kaydetme senaryosu:', {
                isSameFood,
                hasParameterChange,
                saveToDB,
                originalFoodName,
                newFoodName
            });
            
            // Yeni yemek objesi (T√úM parametrelerle)
            const updatedFood = {
                foodName: newFoodName,
                name: newFoodName,
                calories: newCalories,
                kalori: newCalories,
                protein: newProtein,
                carbs: newCarbs,
                karbonhidrat: newCarbs,
                fat: newFat,
                yag: newFat,
                category: newCategory,
                role: newRole,
                mealType: newMealTypes,
                mealTypes: newMealTypes,
                portionMultiplier: newPortion,
                multiplier: newPortion,
                dietTypes: newDietTypes,
                minQuantity: newMin,
                maxQuantity: newMax,
                step: newStep,
                seasonRange: newSeasonRange,
                keto: newKeto,
                lowcarb: newLowCarb,
                portionFixed: newPortionFixed,
                fillerLunch: newFillerLunch,
                fillerDinner: newFillerDinner,
                isReversedSeason: newReversedSeason,
                tags: newTags,
                compatibilityTags: newCompat,
                incompatibilityTags: newIncompat,
                notes: newNotes
            };
            
            // üìù ≈ûablonu g√ºncelle (HER ZAMAN)
            currentEditingTemplate.ogunler[ogunIndex].yemekler[yemekIndex] = updatedFood;
            
            // üîÑ ANINDA modal'ƒ± g√ºncelle (kullanƒ±cƒ± deƒüi≈üikliƒüi g√∂rs√ºn)
            renderTemplateEditContent();
            
            // üîî Bildirim g√∂ster (modal i√ßinde)
            showTemplateEditNotification('‚úèÔ∏è Yemek g√ºncellendi!', 'success');
            
            // üîÑ Render ve JSON'ƒ± senkronize et
            await syncTemplateChangesToWeeks();
            
            // üìä SENARYO KONTROL√ú
            if (isSameFood && hasParameterChange && saveToDB) {
                // SENARYO A: Aynƒ± yemek + parametre deƒüi≈üikliƒüi + DB kayƒ±t istendi
                console.log('‚úÖ SENARYO A: food_list.json + ≈üablon g√ºncelleniyor');
                await updateFoodInDatabase(newFoodName, updatedFood);
                showToast('‚úÖ Yemek ve food_list.json g√ºncellendi!');
            } else if (!isSameFood && !hasParameterChange) {
                // SENARYO B: Farklƒ± yemek se√ßimi (parametre deƒüi≈üikliƒüi yok)
                console.log('‚úÖ SENARYO B: Sadece ≈üablon g√ºncellendi');
                showToast('‚úÖ ≈ûablonda yemek deƒüi≈ütirildi!');
            } else if (!isSameFood && hasParameterChange && saveToDB) {
                // SENARYO C: Farklƒ± yemek + parametre deƒüi≈üikliƒüi + DB kayƒ±t istendi
                console.log('‚úÖ SENARYO C: Yeni yemek parametreleri food_list.json\'a kaydediliyor');
                await updateFoodInDatabase(newFoodName, updatedFood);
                showToast('‚úÖ Yeni yemek food_list.json\'a kaydedildi!');
            } else {
                // Diƒüer durumlar: Sadece ≈üablon g√ºncellendi
                console.log('‚úÖ Sadece ≈üablon g√ºncellendi');
                showToast('‚úÖ ≈ûablonda deƒüi≈üiklik kaydedildi!');
            }
            
            // Modalƒ± kapat
            closeTemplateFoodEditModal();
        };
        
        /**
         * food_list.json'da yemek g√ºncelle (GitHub API)
         * @param {string} foodName - Yemek adƒ±
         * @param {object} foodData - Yemek parametreleri
         */
        async function updateFoodInDatabase(foodName, updatedFoodData) {
            try {
                console.log('üìù food_list.json g√ºncelleme ba≈üladƒ±:', foodName);
                
                // GitHub token kontrol√º
                const GITHUB_TOKEN = localStorage.getItem('github_token');
                if (!GITHUB_TOKEN) {
                    throw new Error('GitHub token bulunamadƒ±! L√ºtfen Admin Modal > Tab 6\'dan token girin.');
                }
                
                const REPO_OWNER = 'mustafasacar35';
                const REPO_NAME = 'lipodem-takip-paneli';
                const FILE_PATH = 'food_list.json';
                const BRANCH = 'main';
                
                // 1Ô∏è‚É£ Mevcut food_list.json'u GitHub'dan √ßek
                const getUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`food_list.json okunamadƒ±: ${getResponse.status}`);
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // 2Ô∏è‚É£ Base64'ten decode et ve parse et
                const decoded = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
                const foodList = JSON.parse(decoded);
                
                console.log('‚úÖ food_list.json y√ºklendi, kategoriler:', foodList.categories.length);
                
                // 3Ô∏è‚É£ Yemeƒüi bul ve g√ºncelle (categories array i√ßinde items)
                let foodFound = false;
                const normalizedSearchName = normalizeTr(foodName);
                
                for (const category of foodList.categories) {
                    if (!category.items || !Array.isArray(category.items)) continue;
                    
                    const foodIndex = category.items.findIndex(f => 
                        normalizeTr(f.name) === normalizedSearchName
                    );
                    
                    if (foodIndex !== -1) {
                        // Yemek bulundu - t√ºm parametreleri g√ºncelle
                        const existingFood = category.items[foodIndex];
                        
                        category.items[foodIndex] = {
                            ...existingFood,
                            name: updatedFoodData.name,
                            calories: updatedFoodData.calories,
                            protein: updatedFoodData.protein,
                            carbs: updatedFoodData.carbs,
                            fat: updatedFoodData.fat,
                            category: updatedFoodData.category,
                            role: updatedFoodData.role,
                            keto: updatedFoodData.keto,
                            lowcarb: updatedFoodData.lowcarb,
                            portionFixed: updatedFoodData.portionFixed,
                            fillerLunch: updatedFoodData.fillerLunch,
                            fillerDinner: updatedFoodData.fillerDinner
                        };
                        
                        foodFound = true;
                        console.log(`‚úÖ Yemek g√ºncellendi: "${foodName}" (Kategori: ${category.name})`);
                        break;
                    }
                }
                
                if (!foodFound) {
                    console.warn(`‚ö†Ô∏è Yemek food_list.json'da bulunamadƒ±: "${foodName}"`);
                    console.warn('üí° Yemek eklemek i√ßin Admin Modal > Tab 5\'i kullanƒ±n');
                    return; // Yemek yoksa ekleme yapma (g√ºvenlik)
                }
                
                // 4Ô∏è‚É£ JSON'u Base64'e √ßevir (‚úÖ T√úRK√áE KARAKTER KORUYAN)
                const updatedContent = JSON.stringify(foodList, null, 2);
                const contentBase64 = encodeBase64UTF8(updatedContent);
                
                // 5Ô∏è‚É£ GitHub'a commit et
                const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
                const commitMessage = `üîÑ Yemek g√ºncellendi: ${foodName} (≈ûablon d√ºzenleme)`;
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: contentBase64,
                        sha: sha,
                        branch: BRANCH
                    })
                });
                
                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(`GitHub commit hatasƒ±: ${errorData.message}`);
                }
                
                const result = await putResponse.json();
                console.log('‚úÖ food_list.json GitHub\'a kaydedildi:', result.commit.sha.slice(0, 7));
                
                // 6Ô∏è‚É£ Lokal foodData cache'ini g√ºncelle (sayfa yenilenmeden)
                const foodInCache = foodData.find(f => normalizeTr(f.name) === normalizedSearchName);
                if (foodInCache) {
                    Object.assign(foodInCache, {
                        name: foodData.name,
                        calories: foodData.calories,
                        protein: foodData.protein,
                        carbs: foodData.carbs,
                        fat: foodData.fat,
                        category: foodData.category,
                        role: foodData.role,
                        keto: foodData.keto,
                        lowcarb: foodData.lowcarb,
                        portionFixed: foodData.portionFixed,
                        fillerLunch: foodData.fillerLunch,
                        fillerDinner: foodData.fillerDinner
                    });
                    console.log('‚úÖ Lokal cache g√ºncellendi');
                }
                
            } catch (error) {
                console.error('‚ùå food_list.json g√ºncellenemedi:', error);
                alert(`‚ö†Ô∏è food_list.json g√ºncellenemedi:\n${error.message}\n\n≈ûablon deƒüi≈üikliƒüi kaydedildi ama veritabanƒ± g√ºncellenmedi.`);
                throw error;
            }
        }
        
        /**
         * ≈ûablon deƒüi≈üikliklerini weeks array'ine ve GitHub template'ine senkronize et
         * Template √ºzerinde yapƒ±lan deƒüi≈üiklikler renderda anƒ±nda g√∂r√ºns√ºn ve kalƒ±cƒ± olsun
         */
        async function syncTemplateChangesToWeeks() {
            if (!currentEditingTemplate) return;
            
            const templateId = currentEditingTemplate.id;
            
            // Makrolarƒ± yeniden hesapla
            recalculateTemplateMacros();
            
            // üîÑ foods array'ini ogunler'den yeniden olu≈ütur (geriye d√∂n√ºk uyumluluk)
            currentEditingTemplate.foods = [];
            (currentEditingTemplate.ogunler || []).forEach(ogun => {
                (ogun.yemekler || []).forEach(yemek => {
                    currentEditingTemplate.foods.push({
                        foodName: yemek.foodName || yemek.name,
                        originalText: yemek.originalText || yemek.foodName || yemek.name,
                        ogunTipi: ogun.ogunAdi || ogun.mealName,
                        calories: yemek.calories || yemek.kalori || 0,
                        protein: yemek.protein || 0,
                        carbs: yemek.carbs || yemek.karbonhidrat || 0,
                        fat: yemek.fat || yemek.yag || 0
                    });
                });
            });
            
            console.log(`‚úÖ foods array yeniden olu≈üturuldu: ${currentEditingTemplate.foods.length} yemek`);
            
            // 1Ô∏è‚É£ Template'i dayTemplates array'inde g√ºncelle (metadata)
            const templateIndex = dayTemplates.findIndex(t => t.id === templateId);
            if (templateIndex !== -1) {
                // Metadata g√ºncelle
                dayTemplates[templateIndex].totalMacros = {
                    kalori: currentEditingTemplate.totalCalories || 0,
                    protein: currentEditingTemplate.totalProtein || 0,
                    karb: currentEditingTemplate.totalCarbs || 0,
                    yag: currentEditingTemplate.totalFat || 0
                };
                
                // Eƒüer full template y√ºkl√ºyse onu da g√ºncelle
                if (dayTemplates[templateIndex].ogunler) {
                    dayTemplates[templateIndex].ogunler = JSON.parse(JSON.stringify(currentEditingTemplate.ogunler || []));
                    dayTemplates[templateIndex].foods = JSON.parse(JSON.stringify(currentEditingTemplate.foods || []));
                }
            }
            
            // 2Ô∏è‚É£ T√ºm haftalarda bu template'i kullanan g√ºnleri bul ve g√ºncelle
            let updatedCount = 0;
            
            weeks.forEach((week, weekIndex) => {
                week.days.forEach((day, dayIndex) => {
                    if (day.templateId === templateId) {
                        // G√ºn√º g√ºncelle - deep copy ile
                        day.meals = JSON.parse(JSON.stringify(currentEditingTemplate.ogunler || []));
                        day.ogunler = day.meals; // Geriye d√∂n√ºk uyumluluk
                        
                        // Total macros'u g√ºncelle
                        day.totalMacros = {
                            kalori: currentEditingTemplate.totalCalories || 0,
                            protein: currentEditingTemplate.totalProtein || 0,
                            karb: currentEditingTemplate.totalCarbs || 0,
                            yag: currentEditingTemplate.totalFat || 0
                        };
                        
                        updatedCount++;
                        console.log(`‚úÖ G√ºn g√ºncellendi: Hafta ${weekIndex + 1}, ${day.gunAdi}`);
                    }
                });
            });
            
            if (updatedCount > 0) {
                // 3Ô∏è‚É£ Haftalƒ±k veriyi kaydet (localStorage + GitHub)
                await saveWeeks();
                
                // 4Ô∏è‚É£ Render'ƒ± g√ºncelle
                renderWeekContent();
                
                console.log(`üîÑ ${updatedCount} g√ºn senkronize edildi ve render g√ºncellendi`);
            }
            
            // 5Ô∏è‚É£ Template'i GitHub'a kaydet (templates/day_XXX.json)
            try {
                const token = localStorage.getItem('github_token');
                if (token && currentEditingTemplate.filename) {
                    console.log('üíæ Template GitHub\'a kaydediliyor:', currentEditingTemplate.filename);
                    await TemplateManager.saveTemplate(currentEditingTemplate, token);
                    console.log('‚úÖ Template ba≈üarƒ±yla GitHub\'a kaydedildi');
                    showToast('‚úÖ ≈ûablon kalƒ±cƒ± olarak kaydedildi!', 'success');
                } else if (!token) {
                    console.warn('‚ö†Ô∏è GitHub token bulunamadƒ±, template sadece haftalƒ±k plana kaydedildi');
                    showToast('‚ö†Ô∏è Token yok: Deƒüi≈üiklikler sadece haftalƒ±k plana kaydedildi', 'warning');
                } else {
                    console.warn('‚ö†Ô∏è Template filename yok, GitHub\'a kayƒ±t yapƒ±lamadƒ±');
                }
            } catch (error) {
                console.error('‚ùå Template GitHub\'a kaydedilemedi:', error);
                showToast('‚ö†Ô∏è Template GitHub\'a kaydedilemedi: ' + error.message, 'warning');
            }
        }
        
        /**
         * ≈ûablon makrolarƒ±nƒ± yeniden hesapla
         * currentEditingTemplate i√ßindeki t√ºm √∂ƒü√ºnlerin yemeklerini toplayarak
         * toplam kalori, protein, karbonhidrat, yaƒü hesaplar
         */
        function recalculateTemplateMacros() {
            if (!currentEditingTemplate || !currentEditingTemplate.ogunler) return;
            
            let totalCalories = 0;
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            
            currentEditingTemplate.ogunler.forEach(ogun => {
                if (ogun.yemekler && Array.isArray(ogun.yemekler)) {
                    ogun.yemekler.forEach(yemek => {
                        totalCalories += parseFloat(yemek.calories || yemek.kalori || 0);
                        totalProtein += parseFloat(yemek.protein || 0);
                        totalCarbs += parseFloat(yemek.carbs || yemek.karbonhidrat || 0);
                        totalFat += parseFloat(yemek.fat || yemek.yag || 0);
                    });
                }
            });
            
            // ≈ûablon objesine hem yeni hem eski formatta kaydet (uyumluluk i√ßin)
            currentEditingTemplate.totalCalories = Math.round(totalCalories);
            currentEditingTemplate.totalProtein = Math.round(totalProtein);
            currentEditingTemplate.totalCarbs = Math.round(totalCarbs);
            currentEditingTemplate.totalFat = Math.round(totalFat);
            
            // totalMacros objesi (template sisteminde kullanƒ±lan format)
            currentEditingTemplate.totalMacros = {
                kalori: Math.round(totalCalories),
                protein: Math.round(totalProtein),
                karb: Math.round(totalCarbs),
                yag: Math.round(totalFat)
            };
            
            console.log('üìä Makrolar yeniden hesaplandƒ±:', {
                kalori: currentEditingTemplate.totalCalories,
                protein: currentEditingTemplate.totalProtein,
                karb: currentEditingTemplate.totalCarbs,
                yag: currentEditingTemplate.totalFat
            });
        }
        
        // ========================================
        // üóëÔ∏è ESKƒ∞ YOL: Food Search Popup (Deprecated - Yeni sistem: templateFoodEditModal)
        // ========================================
        
        // Food search popup state
        let foodSearchState = {
            ogunIndex: null,
            yemekIndex: null,
            mode: null // 'edit' veya 'insert'
        };
        
        /**
         * Yemek arama popup'ƒ±nƒ± a√ß
         * @param {number} ogunIndex - √ñƒü√ºn indexi
         * @param {number} yemekIndex - Yemek indexi
         * @param {string} mode - 'edit' veya 'insert'
         */
        function openFoodSearchPopup(ogunIndex, yemekIndex, mode) {
            foodSearchState = { ogunIndex, yemekIndex, mode };
            
            // Popup'ƒ± g√∂ster
            const popup = document.getElementById('foodSearchPopup');
            if (popup) {
                // Search input'u temizle
                document.getElementById('templateFoodSearch').value = '';
                document.getElementById('templateFoodSearchResults').innerHTML = '<p style="color: #666; text-align: center;">Yemek aramak i√ßin yukarƒ±ya yazƒ±n...</p>';
                
                popup.style.display = 'block';
                
                // Auto-focus search input
                setTimeout(() => {
                    document.getElementById('templateFoodSearch').focus();
                }, 100);
            }
        }
        
        /**
         * Yemek arama popup'ƒ±nƒ± kapat
         */
        window.closeFoodSearchPopup = function() {
            const popup = document.getElementById('foodSearchPopup');
            if (popup) {
                popup.style.display = 'none';
                foodSearchState = { ogunIndex: null, yemekIndex: null, mode: null };
            }
        };
        
        /**
         * Yemek ara (fuzzy search)
         * @param {string} query - Arama terimi
         */
        window.searchTemplateFoods = function(query) {
            const resultsContainer = document.getElementById('templateFoodSearchResults');
            if (!resultsContainer) return;
            
            // Bo≈ü arama
            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = '<p style="color: #666; text-align: center;">En az 2 karakter girin...</p>';
                return;
            }
            
            // foodData y√ºklenmemi≈üse
            if (!foodData || foodData.length === 0) {
                resultsContainer.innerHTML = '<p style="color: #f44336; text-align: center;">‚ö†Ô∏è Yemek veritabanƒ± y√ºklenmedi!</p>';
                return;
            }
            
            const queryNorm = normalizeTr(query.trim());
            const queryTokens = tokenize(query);
            
            // Fuzzy search ile e≈üle≈üenleri bul
            let matches = [];
            
            foodData.forEach(food => {
                const foodNorm = normalizeTr(food.name);
                const foodTokens = tokenize(food.name);
                
                let score = 0;
                
                // 1. Tam e≈üle≈üme
                if (foodNorm === queryNorm) {
                    score = 1000;
                }
                // 2. Substring e≈üle≈üme
                else if (foodNorm.includes(queryNorm) || queryNorm.includes(foodNorm)) {
                    score = 900;
                }
                // 3. Token e≈üle≈üme
                else {
                    const setFood = new Set(foodTokens);
                    let overlap = 0;
                    
                    queryTokens.forEach(t => {
                        if (setFood.has(t)) overlap++;
                        else {
                            // Partial token match (ba≈ülangƒ±√ß e≈üle≈ümesi)
                            for (const ft of foodTokens) {
                                if (ft.startsWith(t) || t.startsWith(ft)) {
                                    overlap += 0.5;
                                    break;
                            }
                            }
                        }
                    });
                    
                    if (overlap > 0) {
                        score = overlap * 100;
                    }
                }
                
                if (score > 0) {
                    matches.push({ food, score });
                }
            });
            
            // Skorlara g√∂re sƒ±rala
            matches.sort((a, b) => b.score - a.score);
            
            // ƒ∞lk 20 sonucu g√∂ster
            matches = matches.slice(0, 20);
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<p style="color: #ff9800; text-align: center;">‚ùå E≈üle≈üen yemek bulunamadƒ±</p>';
                return;
            }
            
            // Sonu√ßlarƒ± render et
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            matches.forEach(({ food, score }) => {
                html += `
                    <div onclick="selectFoodFromSearch('${food.name.replace(/'/g, "\\'")}') "style="padding: 10px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; background: white; transition: all 0.2s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${food.name}</div>
                        <div style="font-size: 12px; color: #666; display: flex; gap: 15px;">
                            <span>üî• ${Math.round(food.calories || 0)} kcal</span>
                            <span>ü•© P: ${Math.round(food.protein || 0)}g</span>
                            <span>üçû K: ${Math.round(food.carbs || 0)}g</span>
                            <span>üßà Y: ${Math.round(food.fat || 0)}g</span>
                        </div>
                        ${food.category ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">üìÇ ${food.category}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        };
        
        /**
         * Arama sonu√ßlarƒ±ndan yemek se√ß
         * @param {string} foodName - Se√ßilen yemek adƒ±
         */
        window.selectFoodFromSearch = async function(foodName) {
            if (!currentEditingTemplate || foodSearchState.ogunIndex === null) return;
            
            // Yemeƒüi foodData'dan bul
            const food = foodData.find(f => f.name === foodName);
            if (!food) {
                alert('‚ùå Yemek bulunamadƒ±!');
                return;
            }
            
            const { ogunIndex, yemekIndex, mode } = foodSearchState;
            const ogun = currentEditingTemplate.ogunler[ogunIndex];
            
            if (!ogun || !ogun.yemekler) {
                alert('‚ùå √ñƒü√ºn bulunamadƒ±!');
                return;
            }
            
            // Yeni yemek objesi olu≈ütur
            const newFood = {
                foodName: food.name,
                calories: food.calories || 0,
                protein: food.protein || 0,
                carbs: food.carbs || 0,
                fat: food.fat || 0,
                eslesenYemek: food // Orijinal food objesi
            };
            
            if (mode === 'edit') {
                // Mevcut yemeƒüi deƒüi≈ütir
                ogun.yemekler[yemekIndex] = newFood;
                console.log('‚úèÔ∏è Yemek g√ºncellendi:', foodName);
                
                // üîî Bildirim g√∂ster
                showTemplateEditNotification('‚úèÔ∏è Yemek g√ºncellendi: ' + foodName, 'success');
            } else if (mode === 'insert') {
                // Belirtilen pozisyona ekle
                ogun.yemekler.splice(yemekIndex, 0, newFood);
                console.log('‚ûï Yemek eklendi:', foodName, 'Pozisyon:', yemekIndex);
                
                // üîî Bildirim g√∂ster
                showTemplateEditNotification('‚ûï Yemek eklendi: ' + foodName, 'success');
            }
            
            // üîÑ Render ve JSON'ƒ± g√ºncelle
            await syncTemplateChangesToWeeks();
            
            // üîÑ Popup'ƒ± kapat ve modal'ƒ± ANINDA g√ºncelle
            closeFoodSearchPopup();
            renderTemplateEditContent();
        };
        
        /**
         * Kaydet modalƒ±nƒ± a√ß
         */
        window.openSaveTemplateModal = function() {
            const modal = document.getElementById('saveTemplateModal');
            if (modal) {
                // Mevcut ≈üablon adƒ±nƒ± g√∂ster
                const currentName = currentEditingTemplate?.name || 'ƒ∞simsiz ≈ûablon';
                document.getElementById('saveTemplateCurrentName').textContent = currentName;
                
                // Otomatik ≈üablon adƒ± √∂ner (yeni ≈üablon i√ßin)
                const nextNumber = getNextTemplateNumber();
                document.getElementById('saveTemplateNewName').value = `Men√º ${nextNumber}`;
                
                // Default: √úzerine yaz
                document.getElementById('saveMode_overwrite').checked = true;
                document.getElementById('newNameContainer').style.display = 'none';
                
                modal.style.display = 'block';
            }
        };
        
        /**
         * Kaydet modalƒ±nƒ± kapat
         */
        window.closeSaveTemplateModal = function() {
            const modal = document.getElementById('saveTemplateModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        /**
         * Save mode deƒüi≈ütiƒüinde (radio button)
         */
        window.toggleSaveMode = function() {
            const overwriteMode = document.getElementById('saveMode_overwrite').checked;
            const newNameContainer = document.getElementById('newNameContainer');
            
            if (newNameContainer) {
                newNameContainer.style.display = overwriteMode ? 'none' : 'block';
            }
        };
        
        /**
         * Sonraki ≈üablon numarasƒ±nƒ± bul
         * @returns {number} - Sonraki ≈üablon numarasƒ±
         */
        function getNextTemplateNumber() {
            if (!dayTemplates || dayTemplates.length === 0) return 1;
            
            // Mevcut ≈üablon adlarƒ±ndan en b√ºy√ºk numarayƒ± bul
            let maxNumber = 0;
            
            dayTemplates.forEach(template => {
                const name = template.name || '';
                // "Men√º 21", "Menu 5" gibi formatlarƒ± yakala
                const match = name.match(/(?:Men√º|Menu)\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > maxNumber) maxNumber = num;
                }
            });
            
            return maxNumber + 1;
        }
        
        /**
         * ≈ûablonu kaydet (GitHub'a yaz)
         */
        window.saveTemplate = async function() {
            if (!currentEditingTemplate) {
                alert('‚ùå D√ºzenlenen ≈üablon bulunamadƒ±!');
                return;
            }
            
            const overwriteMode = document.getElementById('saveMode_overwrite').checked;
            let templateName;
            let isNewTemplate = false;
            
            if (overwriteMode) {
                // √úzerine yaz
                templateName = currentEditingTemplate.name;
            } else {
                // Yeni ≈üablon
                templateName = document.getElementById('saveTemplateNewName').value.trim();
                
                if (!templateName) {
                    alert('‚ö†Ô∏è L√ºtfen yeni ≈üablon adƒ±nƒ± girin!');
                    return;
                }
                
                // Yeni ID olu≈ütur
                currentEditingTemplate.id = `day_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                currentEditingTemplate.name = templateName;
                isNewTemplate = true;
            }
            
            // Total macros'u g√ºncelle
            const gunTotals = (currentEditingTemplate.ogunler || []).reduce((acc, ogun) => {
                (ogun.yemekler || []).forEach(y => {
                    acc.kalori += y.calories || 0;
                    acc.protein += y.protein || 0;
                    acc.karb += y.carbs || 0;
                    acc.yag += y.fat || 0;
                });
                return acc;
            }, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            
            currentEditingTemplate.totalCalories = gunTotals.kalori;
            currentEditingTemplate.totalMacros = gunTotals;
            
            console.log('üíæ ≈ûablon GitHub\'a kaydediliyor:', currentEditingTemplate);
            
            // GitHub'a kaydet
            try {
                await saveTemplateToGitHub(currentEditingTemplate, isNewTemplate);
                
                // ‚úÖ Ba≈üarƒ± mesajƒ±
                showToast(`‚úÖ ≈ûablon kaydedildi: ${templateName}`, 'success');
                
                // üìä ≈ûablonlarƒ± yeniden y√ºkle
                await loadDayTemplates();
                
                // üîÑ Haftalƒ±k i√ßeriƒüi yenile (render'daki deƒüi≈üiklikleri g√∂ster)
                renderWeekContent();
                
                // üö™ Modal'larƒ± kapat
                closeSaveTemplateModal();
                closeTemplateEditModal();
                
                // üìã Template listesini yenile
                renderTemplateTable(dayTemplates, new Set());
                
                console.log('‚úÖ ≈ûablon ba≈üarƒ±yla kaydedildi ve render g√ºncellendi');
                
            } catch (error) {
                console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
                alert(`‚ùå Kaydetme ba≈üarƒ±sƒ±z!\n\n${error.message}\n\nL√ºtfen GitHub token'ƒ±nƒ±zƒ± kontrol edin.`);
            }
        };
        
        /**
         * ≈ûablonu GitHub'a kaydet (gun-sablonlari.json)
         * @param {Object} template - Kaydedilecek ≈üablon
         * @param {boolean} isNew - Yeni ≈üablon mu?
         */
        async function saveTemplateToGitHub(template, isNew) {
            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const FILE_PATH = 'gun-sablonlari-2025-10-25.json';
            const BRANCH = 'main';
            
            // üîë GitHub token kontrol√º (√∂nce modal'dan, sonra localStorage'dan)
            let token = document.getElementById('templateGithubToken')?.value?.trim();
            
            if (!token) {
                // Fallback: localStorage'dan dene
                token = localStorage.getItem('github_token');
            }
            
            if (!token) {
                throw new Error('‚ùå GitHub token bulunamadƒ±!\n\nL√ºtfen modal altƒ±ndaki alana token girin veya localStorage\'a github_token ekleyin.');
            }
            
            // Token'ƒ± localStorage'a kaydet (gelecek kullanƒ±mlar i√ßin)
            localStorage.setItem('github_token', token);
            console.log('‚úÖ GitHub token localStorage\'a kaydedildi');
            
            // Mevcut dosyayƒ± √ßek
            const getResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getResponse.ok) {
                throw new Error(`Dosya okunamadƒ±: ${getResponse.status} ${getResponse.statusText}`);
            }
            
            const fileData = await getResponse.json();
            const currentContent = decodeBase64UTF8(fileData.content.replace(/\n/g, ''));
            const currentData = JSON.parse(currentContent);
            
            // üîß FIX: ogunler array'indeki deƒüi≈üiklikleri foods array'ine SENKRONIZE ET
            // Bu sayede modal'da silinen yemekler JSON'dan da silinir
            if (template.ogunler && Array.isArray(template.ogunler)) {
                template.foods = [];
                template.ogunler.forEach(ogun => {
                    if (ogun.yemekler && Array.isArray(ogun.yemekler)) {
                        ogun.yemekler.forEach(yemek => {
                            // Her yemeƒüi foods array'ine ekle (ogunTipi bilgisiyle)
                            template.foods.push({
                                ...yemek,
                                ogunTipi: ogun.ogunAdi || ogun.originalTitle || '√∂ƒüle'
                            });
                        });
                    }
                });
                console.log(`‚úÖ foods array senkronize edildi: ${template.foods.length} yemek`);
            }
            
            // ≈ûablonlarƒ± g√ºncelle
            if (isNew) {
                // Yeni ≈üablon ekle
                currentData.templates.push(template);
                currentData.totalCount = currentData.templates.length;
            } else {
                // Mevcut ≈üablonu g√ºncelle
                const index = currentData.templates.findIndex(t => t.id === template.id);
                if (index === -1) {
                    throw new Error('G√ºncellenecek ≈üablon bulunamadƒ±!');
                }
                currentData.templates[index] = template;
            }
            
            // Export date g√ºncelle
            currentData.exportDate = new Date().toISOString();
            
            // JSON'a √ßevir (pretty print)
            const newContent = JSON.stringify(currentData, null, 2);
            
            // ‚úÖ T√úRK√áE KARAKTER KORUYAN ENCODING
            const newContentBase64 = encodeBase64UTF8(newContent);
            
            // GitHub'a g√∂nder
            const commitMessage = isNew 
                ? `Yeni ≈üablon eklendi: ${template.name}` 
                : `≈ûablon g√ºncellendi: ${template.name}`;
            
            const putResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: newContentBase64,
                    sha: fileData.sha,
                    branch: BRANCH
                })
            });
            
            if (!putResponse.ok) {
                const errorData = await putResponse.json();
                throw new Error(`GitHub commit ba≈üarƒ±sƒ±z: ${errorData.message || putResponse.statusText}`);
            }
            
            const commitData = await putResponse.json();
            console.log('‚úÖ GitHub commit ba≈üarƒ±lƒ±:', commitData.commit.sha);
        }
    </script>
    
    <!-- üìù TEMPLATE EDIT MODAL -->
    <div id="templateEditModal" class="modal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
        <div class="modal-content" style="background-color: #fff; margin: 2% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1000px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 20px;">üìù ≈ûablon D√ºzenle: <span id="templateEditName">-</span></h3>
                <button onclick="closeTemplateEditModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 6px; transition: all 0.2s;">
                    ‚úñ Kapat
                </button>
            </div>
            
            <!-- Modal Body -->
            <div id="templateEditContent" style="padding: 20px; max-height: 600px; overflow-y: auto;">
                <!-- √ñƒü√ºnler ve yemekler buraya gelecek -->
            </div>
            
            <!-- Modal Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px;">
                <!-- GitHub Token Giri≈üi -->
                <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #856404;">
                        üîë GitHub Token <span style="color: #dc3545;">*</span>
                        <span style="font-weight: normal; font-size: 12px; color: #666;">(≈ûablonu kaydetmek i√ßin gerekli)</span>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input 
                            type="password" 
                            id="templateGithubToken" 
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                        />
                        <button 
                            onclick="toggleTemplateTokenVisibility()" 
                            style="background: #6c757d; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            üëÅÔ∏è G√∂ster
                        </button>
                        <button 
                            onclick="loadTemplateTokenFromStorage()" 
                            style="background: #17a2b8; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 6px; font-size: 14px;">
                            üíæ Y√ºkle
                        </button>
                    </div>
                    <small style="color: #856404; display: block; margin-top: 5px;">
                        üí° Token localStorage'da kayƒ±tlƒ± deƒüilse <a href="https://github.com/settings/tokens" target="_blank" style="color: #007bff;">GitHub</a>'dan olu≈üturun
                    </small>
                </div>
                
                <!-- Butonlar -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeTemplateEditModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        ‚ùå ƒ∞ptal
                    </button>
                    <button onclick="openSaveTemplateModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        üíæ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÔøΩ YEMEK D√úZENLEME MODALI -->
    <div id="templateFoodEditModal" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 2% auto; padding: 0; border-radius: 12px; width: 95%; max-width: 900px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); max-height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 18px;">‚úèÔ∏è Yemek D√ºzenle: <span id="editFoodModalTitle">-</span></h3>
            </div>
            
            <!-- Body - Scrollable -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Yemek Adƒ± + Akƒ±llƒ± Search -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        üçΩÔ∏è Yemek Adƒ± <span style="color: #FF6B6B;">*</span>
                    </label>
                    <div style="position: relative;">
                        <input type="text" id="editFoodName" placeholder="Yemek adƒ± yazƒ±n veya arayƒ±n..." oninput="searchFoodForEdit(this.value)" autocomplete="off" style="width: 100%; padding: 12px; font-size: 15px; border: 2px solid #FF6B6B; border-radius: 8px; box-sizing: border-box;">
                        <!-- Arama sonu√ßlarƒ± dropdown -->
                        <div id="editFoodSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #FF6B6B; border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    <p style="margin: 6px 0 0 0; font-size: 12px; color: #666;">üí° ƒ∞sim deƒüi≈ütirerek ba≈üka yemek se√ßebilirsiniz</p>
                </div>
                
                <!-- Makrolar -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">‚ö° Kalori (kcal) *</label>
                        <input type="number" id="editFoodCalories" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">ü•© Protein (g) *</label>
                        <input type="number" id="editFoodProtein" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">üåæ Karbonhidrat (g) *</label>
                        <input type="number" id="editFoodCarbs" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">üßà Yaƒü (g) *</label>
                        <input type="number" id="editFoodFat" step="0.1" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                </div>
                
                <!-- Kategori & Rol -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">üìÇ Kategori *</label>
                        <select id="editFoodCategory" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Kategori Se√ßin --</option>
                            <option value="KAHVALTI">KAHVALTI</option>
                            <option value="√ñƒûLEN">√ñƒûLEN</option>
                            <option value="AK≈ûAM">AK≈ûAM</option>
                            <option value="KURUYEMƒ∞≈ûLER">KURUYEMƒ∞≈ûLER</option>
                            <option value="√áORBALAR">√áORBALAR</option>
                            <option value="SALATALAR">SALATALAR</option>
                            <option value="ANA YEMEKLER">ANA YEMEKLER</option>
                            <option value="TOSTLAR">TOSTLAR</option>
                            <option value="TATLILAR">TATLILAR</option>
                            <option value="ƒ∞√áECEKLER">ƒ∞√áECEKLER</option>
                            <option value="ATI≈ûTIRILMALIKLAR">ATI≈ûTIRILMALIKLAR</option>
                            <option value="EKMEKLER">EKMEKLER</option>
                            <option value="Pƒ∞LAVLAR">Pƒ∞LAVLAR</option>
                            <option value="Dƒ∞ƒûER">Dƒ∞ƒûER</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">üé≠ Rol *</label>
                        <select id="editFoodRole" required style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                            <option value="">-- Rol Se√ßin --</option>
                            <option value="mainDish">Ana Yemek (mainDish)</option>
                            <option value="sideDish">Yan Yemek (sideDish)</option>
                            <option value="drink">ƒ∞√ßecek (drink)</option>
                            <option value="supplement">Takviye (supplement)</option>
                            <option value="snack">Atƒ±≈ütƒ±rmalƒ±k (snack)</option>
                            <option value="soup">√áorba (soup)</option>
                            <option value="salad">Salata (salad)</option>
                            <option value="bread">Ekmek (bread)</option>
                            <option value="dessert">Tatlƒ± (dessert)</option>
                        </select>
                    </div>
                </div>
                
                <!-- √ñƒü√ºn Tipi -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">‚è∞ √ñƒü√ºn Tipi (Birden fazla se√ßilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_breakfast" value="breakfast" style="width: 18px; height: 18px;">
                            üåÖ Kahvaltƒ±
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_lunch" value="lunch" style="width: 18px; height: 18px;">
                            ‚òÄÔ∏è √ñƒüle
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editMealType_dinner" value="dinner" style="width: 18px; height: 18px;">
                            üåô Ak≈üam
                        </label>
                    </div>
                </div>
                
                <!-- Porsiyon √áarpanƒ± -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">üìè Porsiyon √áarpanƒ±</label>
                    <input type="number" id="editFoodPortion" step="0.1" value="1" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <!-- Diyet Tipleri -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ü•ë Diyet Tipleri (Birden fazla se√ßilebilir)</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_ketojenik" value="ketojenik" style="width: 18px; height: 18px;">
                            ü•ó Ketojenik
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_akdeniz" value="akdeniz" style="width: 18px; height: 18px;">
                            üåä Akdeniz
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_vegan" value="vegan" style="width: 18px; height: 18px;">
                            üå± Vegan
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="editDietType_glutensiz" value="glutensiz" style="width: 18px; height: 18px;">
                            üåæ Glutensiz
                        </label>
                    </div>
                </div>
                
                <!-- Geli≈ümi≈ü Ayarlar (Collapsible) -->
                <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">‚öôÔ∏è Geli≈ümi≈ü Ayarlar</summary>
                    
                    <!-- Min/Max/Step -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Min Miktar</label>
                            <input type="number" id="editFoodMin" step="0.1" placeholder="Min porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Max Miktar</label>
                            <input type="number" id="editFoodMax" step="0.1" placeholder="Max porsiyon" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Adƒ±m (Step)</label>
                            <input type="number" id="editFoodStep" step="0.1" placeholder="Artƒ±≈ü miktarƒ±" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- Sezon -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Ba≈ülangƒ±√ß (Ay)</label>
                            <input type="number" id="editFoodSeasonMin" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">Sezon Biti≈ü (Ay)</label>
                            <input type="number" id="editFoodSeasonMax" min="1" max="12" placeholder="1-12" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <!-- √ñzel √ñzellikler -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #666; font-size: 13px;">üè∑Ô∏è √ñzel √ñzellikler</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodKeto" style="width: 16px; height: 16px;">
                                ü•ó Keto
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodLowCarb" style="width: 16px; height: 16px;">
                                üìâ D√º≈ü√ºk Karb
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodPortionFixed" style="width: 16px; height: 16px;">
                                üîí Porsiyon Sabit
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerLunch" style="width: 16px; height: 16px;">
                                üçΩÔ∏è √ñƒüle Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodFillerDinner" style="width: 16px; height: 16px;">
                                üåô Ak≈üam Dolgu
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="editFoodReversedSeason" style="width: 16px; height: 16px;">
                                üîÑ Ters Sezon
                            </label>
                        </div>
                    </div>
                    
                    <!-- Etiketler -->
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">üè∑Ô∏è Etiketler (Tags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="editFoodTags" placeholder="√∂r: domates, meyve, salata" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">‚úÖ Uyumluluk Etiketleri (compatibilityTags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="editFoodCompat" placeholder="√∂r: tavuk, zeytinyaƒüƒ±" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">‚ùå Uyumsuzluk Etiketleri (incompatibilityTags) - virg√ºlle ayƒ±rƒ±n</label>
                        <input type="text" id="editFoodIncompat" placeholder="√∂r: s√ºt, peynir" style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #666; font-size: 13px;">üìù Notlar</label>
                        <textarea id="editFoodNotes" placeholder="Ek bilgiler, √∂zel notlar..." style="width: 100%; padding: 8px; font-size: 13px; border: 2px solid #2196f3; border-radius: 6px; box-sizing: border-box; min-height: 60px; resize: vertical;"></textarea>
                    </div>
                </details>
            </div>
            
            <!-- Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 10px; justify-content: space-between; flex-shrink: 0; border-top: 1px solid #ddd;">
                <button onclick="closeTemplateFoodEditModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    ‚ùå ƒ∞ptal
                </button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; cursor: pointer;">
                        <input type="checkbox" id="saveFoodToDatabase" style="width: 16px; height: 16px;">
                        <span>üíæ food_list.json'a da kaydet</span>
                    </label>
                    <button onclick="saveEditedTemplateFood()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                        ‚úÖ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÔøΩüîç FOOD SEARCH POPUP -->
    <div id="foodSearchPopup" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
            <!-- Popup Header -->
            <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">üîç Yemek Ara</h3>
                <button onclick="closeFoodSearchPopup()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; font-size: 14px; cursor: pointer; border-radius: 4px;">
                    ‚úñ Kapat
                </button>
            </div>
            
            <!-- Search Input -->
            <div style="padding: 15px 20px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                <input type="text" id="templateFoodSearch" placeholder="Yemek adƒ± yazƒ±n (√∂rn: mercimek √ßorbasƒ±)" oninput="searchTemplateFoods(this.value)" style="width: 100%; padding: 12px; font-size: 15px; border: 2px solid #4CAF50; border-radius: 8px; box-sizing: border-box;">
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">üí° ƒ∞pucu: "mer √ßor" gibi kƒ±saltmalar da √ßalƒ±≈üƒ±r</p>
            </div>
            
            <!-- Search Results -->
            <div id="templateFoodSearchResults" style="padding: 15px 20px; min-height: 200px; max-height: 450px; overflow-y: auto;">
                <p style="color: #666; text-align: center;">Yemek aramak i√ßin yukarƒ±ya yazƒ±n...</p>
            </div>
        </div>
    </div>
    
    <!-- üíæ SAVE TEMPLATE MODAL -->
    <div id="saveTemplateModal" class="modal" style="display: none; position: fixed; z-index: 10003; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fff; margin: 10% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 550px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0;">
                <h3 style="margin: 0; font-size: 18px;">üíæ ≈ûablonu Kaydet</h3>
            </div>
            
            <!-- Body -->
            <div style="padding: 25px;">
                <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                    Mevcut ≈üablon: <strong id="saveTemplateCurrentName">-</strong>
                </p>
                
                <!-- Kayƒ±t se√ßenekleri -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Option 1: √úzerine Yaz -->
                    <label style="display: flex; align-items: start; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                        <input type="radio" name="saveMode" id="saveMode_overwrite" onchange="toggleSaveMode()" checked style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">üìù Mevcut ≈ûablonu G√ºncelle</div>
                            <div style="font-size: 13px; color: #666;">Deƒüi≈üiklikler mevcut ≈üablonun √ºzerine yazƒ±lacak</div>
                        </div>
                    </label>
                    
                    <!-- Option 2: Yeni ≈ûablon -->
                    <label style="display: flex; align-items: start; gap: 12px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'">
                        <input type="radio" name="saveMode" id="saveMode_new" onchange="toggleSaveMode()" style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">‚ú® Yeni ≈ûablon Olarak Kaydet</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 10px;">Mevcut ≈üablon korunacak, yeni ≈üablon olu≈üturulacak</div>
                            
                            <!-- Yeni ≈üablon adƒ± input (hidden by default) -->
                            <div id="newNameContainer" style="display: none;">
                                <input type="text" id="saveTemplateNewName" placeholder="√ñrn: Men√º 21" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #4CAF50; border-radius: 6px; box-sizing: border-box;">
                                <p style="margin: 6px 0 0 0; font-size: 11px; color: #999;">üí° Sƒ±ra numarasƒ± otomatik √∂nerildi</p>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="background: #f5f5f5; padding: 15px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSaveTemplateModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    ‚ùå ƒ∞ptal
                </button>
                <button onclick="saveTemplate()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; border-radius: 6px; font-weight: 600;">
                    üíæ Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- PDF/Tarif Kartƒ± Modal -->
    <div id="pdfModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 0; border: none; width: 90%; max-width: 900px; border-radius: 12px; max-height: 95vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700;">üìñ Tarif Kartƒ±</h3>
                <button onclick="closePdfModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: all 0.2s;">
                    ‚úñ Kapat
                </button>
            </div>
            
            <!-- PDF Viewer -->
            <div style="height: calc(95vh - 80px); background: #f0f0f0;">
                <img id="pdfImageViewer" src="" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                <iframe id="pdfIframeViewer" src="" style="width: 100%; height: 100%; border: none; display: none;"></iframe>
                <div id="pdfErrorMessage" style="display: none; padding: 40px; text-align: center; color: #666;">
                    <p style="font-size: 16px; margin-bottom: 15px;">‚ö†Ô∏è Tarif kartƒ± bu pencerede g√∂r√ºnt√ºlenemiyor.</p>
                    <a id="pdfDirectLink" href="" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        üîó Yeni Sekmede A√ß
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Service Worker Kaydƒ± -->
    <script>
        /**
         * üìÑ PDF Export - Haftalƒ±k beslenme planƒ±nƒ± PDF olarak indir
         */
        async function exportWeekToPDF() {
            showToast('PDF hazƒ±rlanƒ±yor...', 'info');
            
            try {
                const week = weeks[currentWeekIndex];
                if (!week || !week.days || week.days.length === 0) {
                    showToast('Bu haftada plan yok!', 'error');
                    return;
                }
                
                // jsPDF k√ºt√ºphanesi lazy load
                if (typeof jspdf === 'undefined') {
                    showToast('PDF k√ºt√ºphanesi y√ºkleniyor...', 'info');
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // T√ºrk√ße karakter √ßevirici
                function toASCII(str) {
                    if (!str) return '';
                    const charMap = {
                        '√ß': 'c', '√á': 'C', 'ƒü': 'g', 'ƒû': 'G',
                        'ƒ±': 'i', 'I': 'I', 'ƒ∞': 'I', 'i': 'i',
                        '√∂': 'o', '√ñ': 'O', '≈ü': 's', '≈û': 'S',
                        '√º': 'u', '√ú': 'U'
                    };
                    return str.split('').map(char => charMap[char] || char).join('');
                }
                
                // G√ºn isimleri
                const dayNames = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
                const mealNames = { 
                    sabah: 'Sabah', 
                    'ara √∂ƒü√ºn': 'Ara Ogun',
                    'ara ogun': 'Ara Ogun',
                    ara: 'Ara Ogun', 
                    √∂ƒüle: 'Oglen',
                    oƒüle: 'Oglen',
                    ogle: 'Oglen',
                    ƒ∞kindi: 'Ikindi',
                    ikindi: 'Ikindi', 
                    ak≈üam: 'Aksam',
                    aksam: 'Aksam'
                };
                
                // Logo ekleme (saƒü √ºst k√∂≈üe)
                try {
                    const logoImg = new Image();
                    logoImg.src = 'logo.png';
                    await new Promise((resolve, reject) => {
                        logoImg.onload = resolve;
                        logoImg.onerror = reject;
                        setTimeout(reject, 2000);
                    });
                    doc.addImage(logoImg, 'PNG', 170, 8, 30, 30);
                } catch (e) {
                    console.warn('Logo yuklenemedi:', e);
                }
                
                // Hasta adƒ± ve soyadƒ±nƒ± al (birden fazla kaynaktan)
                let firstName = currentPatient.personalInfo?.name || 
                               patientData?.personalInfo?.name || 
                               currentPatient.name || 
                               'Hasta';
                let lastName = currentPatient.personalInfo?.surname || 
                              patientData?.personalInfo?.surname || 
                              '';
                
                // Ba≈ülƒ±k - Hasta adƒ± soyadƒ± (sol) ve hafta numarasƒ± (saƒüda, logodan a≈üaƒüƒ±da)
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(70, 130, 180);
                const fullName = toASCII(`${firstName} ${lastName}`.trim());
                doc.text(fullName, 15, 15);
                
                doc.setFontSize(14);
                doc.setTextColor(100, 100, 100);
                doc.text(`${currentWeekIndex + 1}. Hafta`, 15, 22);
                
                // Ba≈ülƒ±k altƒ± √ßizgi (logodan 5mm √∂nce bitsin - logo 170mm'de ba≈ülƒ±yor)
                doc.setDrawColor(70, 130, 180);
                doc.setLineWidth(0.8);
                doc.line(15, 26, 165, 26);
                
                let yPos = 34;
                
                // Her g√ºn i√ßin
                for (let dayIndex = 0; dayIndex < week.days.length; dayIndex++) {
                    const day = week.days[dayIndex];
                    const dayName = dayNames[dayIndex] || `Gun ${dayIndex + 1}`;
                    
                    // G√ºn√ºn toplam y√ºksekliƒüini hesapla (kompakt)
                    let dayHeight = 12;
                    const ogunlerForHeight = day.meals || day.ogunler || [];
                    if (ogunlerForHeight && ogunlerForHeight.length > 0) {
                        ogunlerForHeight.forEach(ogun => {
                            if (ogun.yemekler && ogun.yemekler.length > 0) {
                                dayHeight += 6; // √ñƒü√ºn ba≈ülƒ±ƒüƒ±
                                dayHeight += ogun.yemekler.length * 5; // Yemekler (kompakt)
                            }
                        });
                    }
                    
                    // Sayfaya sƒ±ƒümƒ±yorsa yeni sayfaya ge√ß
                    if (yPos + dayHeight > 270) {
                        doc.addPage();
                        yPos = 20;
                        
                        // Yeni sayfada da logo ekle
                        try {
                            const logoImg = new Image();
                            logoImg.src = 'logo.png';
                            await new Promise((resolve, reject) => {
                                logoImg.onload = resolve;
                                logoImg.onerror = () => resolve();
                                setTimeout(() => resolve(), 1000);
                            });
                            doc.addImage(logoImg, 'PNG', 170, 8, 30, 30);
                        } catch (e) {
                            console.warn('Logo yuklenemedi:', e);
                        }
                    }
                    
                    // G√ºn kutusu √ßer√ßevesi ba≈ülangƒ±√ß
                    const boxStartY = yPos;
                    
                    // G√ºn ba≈ülƒ±ƒüƒ± (kalori g√∂sterme)
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(70, 130, 180);
                    doc.text(dayName, 20, yPos + 4);
                    yPos += 8;
                    
                    // G√ºn ba≈ülƒ±ƒüƒ± altƒ± ince √ßizgi
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(20, yPos, 190, yPos);
                    yPos += 3;
                    
                    // √ñƒü√ºnler - meals veya ogunler array'inden al
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    const ogunler = day.meals || day.ogunler || [];
                    
                    if (ogunler && ogunler.length > 0) {
                        ogunler.forEach((ogun, ogunIndex) => {
                            if (ogun.yemekler && ogun.yemekler.length > 0) {
                                // √ñƒü√ºn ba≈ülƒ±ƒüƒ±
                                const ogunAdi = ogun.ogunAdi || ogun.name || 'Ogun';
                                const displayName = mealNames[ogunAdi.toLowerCase()] || toASCII(ogunAdi);
                                
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(50, 50, 50);
                                doc.text(`${displayName}:`, 22, yPos);
                                yPos += 5;
                                
                                // Yemekler
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(40, 40, 40);
                                ogun.yemekler.forEach((food, foodIndex) => {
                                    let foodName = (food.foodName || food.name || 'Bilinmeyen');
                                    foodName = toASCII(foodName); // T√ºrk√ße karakterleri √ßevir
                                    
                                    // ƒ∞lk harfi b√ºy√ºk yap
                                    if (foodName.length > 0) {
                                        foodName = foodName.charAt(0).toUpperCase() + foodName.slice(1);
                                    }
                                    
                                    // Uzun metinleri kes ve satƒ±r sar (max 145mm geni≈ülik)
                                    const lines = doc.splitTextToSize(`‚Ä¢ ${foodName}`, 145);
                                    lines.forEach((line, lineIndex) => {
                                        if (yPos > 270) {
                                            doc.addPage();
                                            yPos = 20;
                                        }
                                        doc.text(line, 26, yPos);
                                        yPos += 4.5;
                                    });
                                });
                                
                                yPos += 1; // √ñƒü√ºnler arasƒ± minimal bo≈üluk
                            }
                        });
                    }
                    
                    // G√ºn kutusu √ßer√ßevesi biti≈ü
                    const boxEndY = yPos + 1;
                    doc.setDrawColor(180, 180, 180);
                    doc.setLineWidth(0.4);
                    doc.rect(18, boxStartY, 174, boxEndY - boxStartY);
                    
                    yPos = boxEndY + 4; // G√ºnler arasƒ± minimal bo≈üluk
                }
                
                // Alt bilgi - Her sayfanƒ±n sonuna
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(120, 120, 120);
                    doc.text('Gunluk 5000 adim yurumeye ozen gosterin.', 105, 282, { align: 'center' });
                    doc.text('Yaklasik 2 litreye yakin su icmeye calisin.', 105, 287, { align: 'center' });
                }
                
                // PDF'i indir - dosya adƒ±nda da ad soyad
                let firstNameFile = currentPatient.personalInfo?.name || patientData?.personalInfo?.name || currentPatient.name || 'Hasta';
                let lastNameFile = currentPatient.personalInfo?.surname || patientData?.personalInfo?.surname || '';
                const fullNameFile = toASCII(`${firstNameFile} ${lastNameFile}`.trim());
                const fileName = `${fullNameFile}_Hafta${currentWeekIndex + 1}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('PDF indirildi!', 'success');
            } catch (error) {
                console.error('PDF export hatasƒ±:', error);
                showToast('PDF olu≈üturulamadƒ±!', 'error');
            }
        }
        
        // Service Worker ve PWA Kurulumu  
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // GitHub Pages i√ßin relative path + cache bypass
                const swPath = './service-worker.js?v=' + Date.now();
                navigator.serviceWorker.register(swPath)
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker v12 kaydedildi:', registration.scope);
                        
                        // iOS Safe Area kontrol√º
                        const safeAreaTop = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top');
                        console.log('üì± iOS Safe Area Top:', safeAreaTop || 'Yok');
                    })
                    .catch(function(error) {
                        console.log('‚ùå Service Worker kayƒ±t hatasƒ±:', error);
                    });
            });
        }

        // PWA y√ºkleme promptunu yakalama
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Otomatik banner'ƒ± engelle
            e.preventDefault();
            deferredPrompt = e;
            
            // ƒ∞steƒüe baƒülƒ±: √ñzel install butonu g√∂sterebilirsiniz
            console.log('üí´ PWA y√ºklenebilir durumda');
            
            // Otomatik olarak install prompt g√∂ster (iPhone i√ßin)
            if (window.DeviceMotionEvent !== undefined && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS cihaz
                setTimeout(() => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                            console.log('‚úÖ PWA y√ºklemesi kabul edildi');
                            } else {
                            console.log('‚ùå PWA y√ºklemesi reddedildi');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 2000);
            }
        });

        // PWA ba≈üarƒ±yla y√ºklendiƒüinde
        window.addEventListener('appinstalled', (evt) => {
            console.log('üéâ PWA ba≈üarƒ±yla y√ºklendi!');
        });

        // Offline/Online durumu kontrol et
        window.addEventListener('online', () => {
            console.log('üåê ƒ∞nternet baƒülantƒ±sƒ± aktif');
        });
        
        window.addEventListener('offline', () => {
            console.log('üì± Offline modda √ßalƒ±≈üƒ±yor');
        });
    </script>
    
    <!-- Food Selector Modal -->
    <div id="foodSelectorModal" class="food-selector-modal">
        <div class="food-selector-iframe-container">
            <button class="modal-close-btn" onclick="closeFoodSelectorModal()">√ó</button>
            <iframe id="foodSelectorIframe" class="food-selector-iframe" src=""></iframe>
        </div>
    </div>

    <!-- Add/Edit Week Modal -->
    <div class="modal" id="addWeekModal">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="addWeekModalTitle" style="font-size: 18px;">üìÖ Yeni Hafta Ekle</h3>
                <button class="modal-close" onclick="closeModal('addWeekModal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <!-- Kompakt Grid Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 13px; margin-bottom: 4px;">Hafta No</label>
                        <input type="number" id="weekNumberInput" min="1" placeholder="Otomatik" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 13px; margin-bottom: 4px;">Diyet T√ºr√º</label>
                        <select id="weekDietTypeInput" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="eliminasyonlu_ketojenik">Elim. Keto</option>
                            <option value="ketojenik">Ketojenik</option>
                            <option value="dusuk_karb">D√º≈ü√ºk Karb</option>
                            <option value="akdeniz">Akdeniz</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 13px; margin-bottom: 4px;">Tarih Aralƒ±ƒüƒ±</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="date" id="weekStartDateInput" style="flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateWeekEndDate(); renderWeekCalendar()">
                        <span style="color: #666; font-size: 12px;">‚Üí</span>
                        <input type="date" id="weekEndDateInput" style="flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="renderWeekCalendar()">
                    </div>
                    
                    <!-- Kompakt G√∂rsel Takvim -->
                    <div id="weekCalendarContainer" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <!-- Takvim JavaScript ile render edilecek -->
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button class="btn-secondary" onclick="closeModal('addWeekModal')" style="flex: 1; padding: 10px; font-size: 14px;">ƒ∞ptal</button>
                <button class="btn-primary" onclick="saveWeekFromModal()" style="flex: 2; padding: 10px; font-size: 14px;" id="saveWeekBtn">
                    ‚úÖ Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- CHAT WIDGET -->
    <div id="chatWidget">
        <button id="chatButton" onclick="toggleChat()">
            üí¨ Mesajlar
            <span class="badge" id="unreadBadge" style="display: none;">0</span>
        </button>
        
        <div id="chatBox">
            <div class="chat-header">
                <h3>üë®‚Äç‚öïÔ∏è Y√∂netici Mesajlarƒ±</h3>
                <button class="chat-close" onclick="toggleChat()">‚úï</button>
            </div>
            
            <div id="chatMessages">
                <div class="no-messages">
                    Hen√ºz mesaj yok.<br>
                    Y√∂neticinize mesaj g√∂nderin!
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Y√∂netici yazƒ±yor...
            </div>
            
            <div class="chat-input-area">
                <button id="emojiButton" onclick="toggleEmojiPicker()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 0 10px;">
                    üòä
                </button>
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                    onkeypress="if(event.key==='Enter') sendMessage()"
                >
                <button id="sendButton" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
            
            <!-- Emoji Picker -->
            <div id="emojiPicker" style="display: none; position: absolute; bottom: 60px; left: 10px; background: white; border: 1px solid #ddd; border-radius: 10px; padding: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000;">
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;">
                    <button onclick="insertEmoji('üòä')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üòä</button>
                    <button onclick="insertEmoji('üòÇ')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üòÇ</button>
                    <button onclick="insertEmoji('‚ù§Ô∏è')" style="border: none; background: none; font-size: 24px; cursor: pointer;">‚ù§Ô∏è</button>
                    <button onclick="insertEmoji('üëç')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üëç</button>
                    <button onclick="insertEmoji('üôè')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üôè</button>
                    <button onclick="insertEmoji('üòç')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üòç</button>
                    <button onclick="insertEmoji('üò¢')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üò¢</button>
                    <button onclick="insertEmoji('üò°')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üò°</button>
                    <button onclick="insertEmoji('üéâ')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üéâ</button>
                    <button onclick="insertEmoji('üí™')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üí™</button>
                    <button onclick="insertEmoji('ü§î')" style="border: none; background: none; font-size: 24px; cursor: pointer;">ü§î</button>
                    <button onclick="insertEmoji('üò¥')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üò¥</button>
                    <button onclick="insertEmoji('üî•')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üî•</button>
                    <button onclick="insertEmoji('‚ú®')" style="border: none; background: none; font-size: 24px; cursor: pointer;">‚ú®</button>
                    <button onclick="insertEmoji('üåü')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üåü</button>
                    <button onclick="insertEmoji('üíØ')" style="border: none; background: none; font-size: 24px; cursor: pointer;">üíØ</button>
                </div>
            </div>
        </div>
    </div>

<script>
// Emoji Picker Toggle
function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

// Emoji Ekle
function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    input.value += emoji;
    input.focus();
    document.getElementById('emojiPicker').style.display = 'none';
}

// Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    const emojiBtn = document.getElementById('emojiButton');
    if (picker && !picker.contains(e.target) && e.target !== emojiBtn) {
        picker.style.display = 'none';
    }
});

// üîî Bildirim popup'ƒ±nƒ± manuel tetikle (test i√ßin)
async function testNotificationPrompt() {
    console.log('üß™ Bildirim testi ba≈ülatƒ±lƒ±yor...');
    
    // OneSignal SDK'nƒ±n y√ºklenmesini bekle (max 10 saniye)
    let attempts = 0;
    const maxAttempts = 20;
    
    while (!((typeof OneSignal !== 'undefined') || (window.parent && typeof window.parent.OneSignal !== 'undefined')) && attempts < maxAttempts) {
        console.log(`‚è≥ OneSignal SDK bekleniyor... (${attempts + 1}/${maxAttempts})`);
        await new Promise(resolve => setTimeout(resolve, 500));
        attempts++;
    }
    
    const OS = (typeof OneSignal !== 'undefined') ? OneSignal : (window.parent && window.parent.OneSignal ? window.parent.OneSignal : undefined);
    if (!OS) {
        // √úst pencereye prompt isteƒüi g√∂nder (iOS'ta iframe izin kƒ±sƒ±tƒ±)
        try {
            if (window.top && window.top !== window.self) {
                console.log('üì§ √úst pencereye OneSignal prompt isteƒüi g√∂nderiliyor...');
                window.top.postMessage({ type: 'onesignal:prompt' }, '*');
                return;
            }
        } catch (e) {}
        alert('‚ùå OneSignal SDK y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.');
        return;
    }
    
    console.log('‚úÖ OneSignal SDK hazƒ±r (current/parent)');
    
    try {
        // Mevcut izin durumu
        const permission = await OS.Notifications.permission;
        console.log('üì± Mevcut izin:', permission);
        
        if (permission === 'granted') {
            alert('‚úÖ Bildirim izni zaten verilmi≈ü!');
            return;
        }
        
        // Slidedown prompt'u tetikle
        console.log('üîî Slidedown prompt tetikleniyor...');
        await OS.Slidedown.promptPush();
        
        console.log('‚úÖ Popup g√∂sterildi');
        
    } catch (error) {
        console.error('‚ùå Bildirim test hatasƒ±:', error);
        alert('‚ö†Ô∏è Hata: ' + error.message);
    }
}

// ========================================
// üìä VERƒ∞TABANI KONTROL MODAL FONKSƒ∞YONLARI
// ========================================

/**
 * Veritabanƒ± kontrol modalƒ±nƒ± a√ß
 */
async function openDatabaseCheckModal() {
    if (!checkAdminPermission()) {
        showToast('‚ùå Bu √∂zellik sadece admin kullanƒ±cƒ±lar i√ßindir!', 'error');
        return;
    }
    
    const modal = document.getElementById('databaseCheckModal');
    if (modal) {
        modal.style.display = 'block';
        
        // Y√ºkleniyor mesajƒ± g√∂ster
        const container = document.getElementById('databaseCheckList');
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div><div style="font-size: 18px;">≈ûablon ar≈üivi y√ºkleniyor...</div></div>';
        }
        
        // GitHub'dan t√ºm ≈üablonlarƒ± y√ºkle
        await loadAllTemplatesForDatabaseCheck();
        
        // Liste render et
        renderDatabaseCheckList();
        
        console.log('üìä Veritabanƒ± kontrol modalƒ± a√ßƒ±ldƒ±');
    }
}

/**
 * GitHub'dan t√ºm ≈üablon ar≈üivini y√ºkle (veritabanƒ± kontrol√º i√ßin)
 */
async function loadAllTemplatesForDatabaseCheck() {
    try {
        // Eƒüer dayTemplates zaten dolu ise, onlarƒ± kullan
        if (window.dayTemplates && window.dayTemplates.length > 0) {
            console.log(`‚úÖ Mevcut dayTemplates kullanƒ±lƒ±yor: ${window.dayTemplates.length} ≈üablon metadata`);
            
            // TemplateManager ile tam ≈üablonlarƒ± y√ºkle
            if (typeof TemplateManager !== 'undefined') {
                console.log('üì• ≈ûablon detaylarƒ± TemplateManager ile y√ºkleniyor...');
                
                // T√ºm ≈üablon dosya adlarƒ±nƒ± topla
                const filenames = window.dayTemplates
                    .filter(t => t.filename)
                    .map(t => t.filename);
                
                console.log(`üìã ${filenames.length} ≈üablon dosyasƒ± y√ºklenecek`);
                
                // Tam ≈üablonlarƒ± y√ºkle (lazy loading)
                const fullTemplates = await TemplateManager.loadTemplates(filenames);
                
                window.allTemplateArchive = fullTemplates;
                console.log(`‚úÖ ${fullTemplates.length} ≈üablon tam verisi y√ºklendi`);
                return;
            }
        }
        
        // Fallback: GitHub'dan templates/index.json'ƒ± y√ºkle ve t√ºm ≈üablonlarƒ± √ßek
        console.log('üì• Fallback: GitHub\'dan templates klas√∂r√º y√ºkleniyor...');
        
        // 1Ô∏è‚É£ √ñnce index.json'ƒ± y√ºkle (metadata)
        const indexUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/templates/index.json?t=' + Date.now();
        const indexResponse = await fetch(indexUrl);
        if (!indexResponse.ok) {
            throw new Error(`Index.json y√ºklenemedi: HTTP ${indexResponse.status}`);
        }
        
        const indexData = await indexResponse.json();
        const templateMetadata = indexData.templates || [];
        console.log(`‚úÖ ${templateMetadata.length} ≈üablon metadata y√ºklendi`);
        
        // 2Ô∏è‚É£ Her bir ≈üablon dosyasƒ±nƒ± y√ºkle
        const templatePromises = templateMetadata.map(async (meta) => {
            if (!meta.filename) return null;
            
            const templateUrl = `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/templates/${meta.filename}?t=${Date.now()}`;
            try {
                const response = await fetch(templateUrl);
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è ${meta.filename} y√ºklenemedi`);
                    return null;
                }
                const templateData = await response.json();
                return {
                    ...templateData,
                    metadata: meta // Metadata'yƒ± da ekle
                };
            } catch (error) {
                console.warn(`‚ö†Ô∏è ${meta.filename} parse hatasƒ±:`, error);
                return null;
            }
        });
        
        const allTemplates = await Promise.all(templatePromises);
        window.allTemplateArchive = allTemplates.filter(t => t !== null);
        console.log(`‚úÖ ${window.allTemplateArchive.length} ≈üablon tam verisi y√ºklendi`);
        
    } catch (error) {
        console.error('‚ùå ≈ûablon ar≈üivi y√ºklenemedi:', error);
        window.allTemplateArchive = [];
        showToast('‚ö†Ô∏è ≈ûablon ar≈üivi y√ºklenemedi, sadece render verileri g√∂sterilecek', 'warning');
    }
}

/**
 * Veritabanƒ± kontrol modalƒ±nƒ± kapat
 */
function closeDatabaseCheckModal() {
    const modal = document.getElementById('databaseCheckModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * T√ºm yemekleri tara ve veritabanƒ±nda olmayanlarƒ± listele
 */
function renderDatabaseCheckList() {
    const container = document.getElementById('databaseCheckList');
    if (!container) return;
    
    // T√ºm yemekleri topla
    const allFoods = new Map(); // foodName -> { count, weeks, days, meals, macros, hasMapping }
    
    // 1Ô∏è‚É£ RENDER'DAKƒ∞ YEMEKLER (weeks - men√º)
    weeks.forEach((week, weekIdx) => {
        week.days.forEach((day, dayIdx) => {
            const meals = day.meals || day.ogunler || [];
            meals.forEach((meal, mealIdx) => {
                const foods = meal.yemekler || [];
                foods.forEach((food) => {
                    const foodName = food.foodName || food.name || 'ƒ∞simsiz Yemek';
                    const cleanName = foodName.trim();
                    
                    if (!allFoods.has(cleanName)) {
                        allFoods.set(cleanName, {
                            count: 0,
                            weeks: new Set(),
                            days: new Set(),
                            meals: new Set(),
                            sources: new Set(), // 'render' veya 'template'
                            macros: {
                                protein: food.protein || 0,
                                carbs: food.carbs || food.karbonhidrat || 0,
                                fat: food.fat || food.yag || 0,
                                calories: food.calories || food.kalori || 0
                            },
                            category: food.category || '',
                            role: food.role || '',
                            hasMapping: !!getFoodDatabaseMapping(cleanName),
                            isInDatabase: isFoodInDatabase(cleanName)
                        });
                    }
                    
                    const foodInfo = allFoods.get(cleanName);
                    foodInfo.count++;
                    foodInfo.weeks.add(weekIdx + 1);
                    foodInfo.days.add(dayIdx + 1);
                    foodInfo.meals.add(meal.ogunAdi || '√ñƒü√ºn');
                    foodInfo.sources.add('render');
                });
            });
        });
    });
    
    // 2Ô∏è‚É£ ≈ûABLON AR≈ûƒ∞Vƒ∞NDEKƒ∞ YEMEKLER (GitHub'dan y√ºklenen t√ºm ≈üablonlar)
    if (window.allTemplateArchive && Array.isArray(window.allTemplateArchive)) {
        console.log(`üìö ≈ûablon ar≈üivi taranƒ±yor: ${window.allTemplateArchive.length} ≈üablon`);
        
        window.allTemplateArchive.forEach((template) => {
            // ≈ûablonun tam verisi y√ºkl√º m√º kontrol et
            const meals = template.ogunler || template.meals || [];
            meals.forEach((meal) => {
                const foods = meal.yemekler || meal.foods || [];
                foods.forEach((food) => {
                    const foodName = food.foodName || food.name || 'ƒ∞simsiz Yemek';
                    const cleanName = foodName.trim();
                    
                    if (!allFoods.has(cleanName)) {
                        allFoods.set(cleanName, {
                            count: 0,
                            weeks: new Set(),
                            days: new Set(),
                            meals: new Set(),
                            sources: new Set(),
                            templates: new Set(), // Hangi ≈üablonlarda kullanƒ±lƒ±yor
                            macros: {
                                protein: food.protein || 0,
                                carbs: food.carbs || food.karbonhidrat || 0,
                                fat: food.fat || food.yag || 0,
                                calories: food.calories || food.kalori || 0
                            },
                            category: food.category || '',
                            role: food.role || '',
                            hasMapping: !!getFoodDatabaseMapping(cleanName),
                            isInDatabase: isFoodInDatabase(cleanName)
                        });
                    }
                    
                    const foodInfo = allFoods.get(cleanName);
                    foodInfo.count++;
                    foodInfo.meals.add(meal.ogunAdi || meal.mealName || '√ñƒü√ºn');
                    foodInfo.sources.add('template');
                    
                    // ≈ûablon bilgisini ekle
                    if (!foodInfo.templates) foodInfo.templates = new Set();
                    foodInfo.templates.add(template.name || template.id || 'ƒ∞simsiz ≈ûablon');
                });
            });
        });
    } else {
        console.warn('‚ö†Ô∏è ≈ûablon ar≈üivi y√ºklenmedi, sadece render verileri g√∂steriliyor');
    }
    
    console.log(`üìä Toplam ${allFoods.size} farklƒ± yemek tarandƒ± (render + t√ºm ≈üablon ar≈üivi)`);
    
    // Filtreleme ayarlarƒ±
    const filterType = document.getElementById('dbCheckFilter')?.value || 'all';
    
    // Filtrelenmi≈ü liste
    const filteredFoods = Array.from(allFoods.entries()).filter(([name, info]) => {
        if (filterType === 'missing') {
            return !info.isInDatabase && !info.hasMapping;
        } else if (filterType === 'mapped') {
            return info.hasMapping && !info.isInDatabase;
        }
        return !info.isInDatabase; // 'all' - hem eksik hem e≈üle≈ütirmeli
    });
    
    // Sƒ±ralama: √ñnce veritabanƒ±nda yok, sonra e≈üle≈ütirmeli
    filteredFoods.sort((a, b) => {
        const aScore = (!a[1].isInDatabase && !a[1].hasMapping) ? 2 : (a[1].hasMapping ? 1 : 0);
        const bScore = (!b[1].isInDatabase && !b[1].hasMapping) ? 2 : (b[1].hasMapping ? 1 : 0);
        return bScore - aScore || b[1].count - a[1].count;
    });
    
    if (filteredFoods.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                <h3 style="color: #28a745; margin-bottom: 10px;">Harika! T√ºm yemekler veritabanƒ±nda</h3>
                <p>Kontrol edilecek yemek bulunamadƒ±.</p>
            </div>
        `;
        return;
    }
    
    // ƒ∞statistikler hesapla
    const stats = {
        total: filteredFoods.length,
        missing: filteredFoods.filter(([, info]) => !info.isInDatabase && !info.hasMapping).length,
        mapped: filteredFoods.filter(([, info]) => info.hasMapping && !info.isInDatabase).length,
        totalUsage: filteredFoods.reduce((sum, [, info]) => sum + info.count, 0)
    };
    
    // HTML render
    let html = `
        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <strong style="font-size: 20px;">${stats.total} Yemek</strong> kontrol edilmeli
                </div>
                <div style="font-size: 13px; opacity: 0.9;">
                    Toplam kullanƒ±m: <strong>${stats.totalUsage}</strong> kez
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px;">
                <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700;">${stats.missing}</div>
                    <div style="font-size: 12px; opacity: 0.9;">‚ö†Ô∏è Veritabanƒ±nda Yok</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700;">${stats.mapped}</div>
                    <div style="font-size: 12px; opacity: 0.9;">‚úÖ E≈üle≈ütirilmi≈ü</div>
                </div>
            </div>
        </div>
    `;
    
    filteredFoods.forEach(([foodName, info]) => {
        const isNotInDb = !info.isInDatabase && !info.hasMapping;
        const badgeColor = isNotInDb ? '#dc3545' : '#28a745';
        const badgeText = isNotInDb ? '‚ö†Ô∏è' : '‚úÖ';
        const badgeTitle = isNotInDb ? 'Veritabanƒ±nda Yok' : 'E≈üle≈üti';
        
        // Kompakt g√∂r√ºn√ºm - ≈üablon listesi gibi
        html += `
            <div style="background: white; border-left: 4px solid ${badgeColor}; border-radius: 6px; padding: 10px 12px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;">
                <!-- Rozet -->
                <div style="flex-shrink: 0;">
                    <span style="display: inline-block; width: 28px; height: 28px; background: ${badgeColor}; color: white; border-radius: 50%; text-align: center; line-height: 28px; font-size: 14px;" title="${badgeTitle}">
                        ${badgeText}
                    </span>
                </div>
                
                <!-- Yemek Bilgileri -->
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${foodName}
                    </div>
                    <div style="display: flex; gap: 8px; font-size: 11px; color: #666; flex-wrap: wrap;">
                        <span>üìç ${info.count}√ó</span>
                        <span>üìÖ ${info.weeks.size} hafta</span>
                        <span style="color: #f39c12;">${Math.round(info.macros.calories)} kcal</span>
                        <span style="color: #4caf50;">${Math.round(info.macros.protein)}g P</span>
                        <span style="color: #ff9800;">${Math.round(info.macros.carbs)}g C</span>
                        <span style="color: #e91e63;">${Math.round(info.macros.fat)}g F</span>
                    </div>
                </div>
                
                <!-- Ayar Butonu -->
                <div style="flex-shrink: 0;">
                    <button onclick="openAdminMatchingModalFromCheck('${foodName.replace(/'/g, "\\'")}', ${JSON.stringify(info.macros).replace(/"/g, '&quot;')}, '${info.category || ''}', '${info.role || ''}')" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px; border-radius: 6px; width: 36px; height: 36px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); transition: transform 0.2s;" 
                            onmouseover="this.style.transform='scale(1.1)'" 
                            onmouseout="this.style.transform='scale(1)'"
                            title="D√ºzenle">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

/**
 * Database check modal'dan admin modal a√ß
 */
function openAdminMatchingModalFromCheck(foodName, macros, category = '', role = '') {
    // Database modal'ƒ± kapat (z-index √ßakƒ±≈ümasƒ±nƒ± √∂nlemek i√ßin)
    closeDatabaseCheckModal();
    
    // Admin modal'ƒ± a√ß
    openAdminMatchingModal(foodName, {
        protein: macros.protein,
        carbs: macros.carbs,
        fat: macros.fat,
        category: category,
        role: role
    });
}

/**
 * Filtre deƒüi≈ütiƒüinde listeyi yenile
 */
function filterDatabaseCheck() {
    renderDatabaseCheckList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìè V√úCUT √ñL√á√úMLERƒ∞ Sƒ∞STEMƒ∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MEASUREMENT_FIELDS = [
    { key: 'boyun', label: 'Boyun (cm)' },
    { key: 'omuz', label: 'Omuz (cm)' },
    { key: 'gogus', label: 'G√∂ƒü√ºs (cm)' },
    { key: 'bel', label: 'Bel (cm)' },
    { key: 'karin', label: 'Karƒ±n (cm)' },
    { key: 'kalca', label: 'Kal√ßa (cm)' },
    { key: 'sagKol', label: 'Saƒü Kol (cm)' },
    { key: 'solKol', label: 'Sol Kol (cm)' },
    { key: 'sagUyluk', label: 'Saƒü Uyluk (cm)' },
    { key: 'solUyluk', label: 'Sol Uyluk (cm)' },
    { key: 'sagBaldir', label: 'Saƒü Baldƒ±r (cm)' },
    { key: 'solBaldir', label: 'Sol Baldƒ±r (cm)' },
    { key: 'kilo', label: 'Kilo (kg)' }
];
let currentMeasurementWeekIndex = -1;

// √ñl√ß√ºm modalƒ±nƒ± a√ß
function openMeasurementsModal(weekIndex) {
    // weekIndex verilmediyse aktif hafta kullan
    if (weekIndex === undefined || weekIndex === null) {
        weekIndex = activeWeekIndex;
    }
    
    currentMeasurementWeekIndex = weekIndex;
    const week = weeks[weekIndex];
    
    if (!week) {
        showToast('‚ùå Hafta bulunamadƒ±', 'error');
        return;
    }
    
    // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
    document.getElementById('measurementModalWeek').textContent = `${week.weekNumber}. Hafta`;
    
    // √ñl√ß√ºmleri y√ºkle
    loadMeasurementsTable();
    
    // Modalƒ± g√∂ster
    document.getElementById('measurementsModal').classList.add('active');
    document.getElementById('measurementsModal').style.display = 'flex';
    
    // üì± Mobil i√ßin: Modal a√ßƒ±ldƒ±ktan sonra saƒüa scroll (son s√ºtunlar g√∂r√ºns√ºn)
    setTimeout(() => {
        const container = document.getElementById('measurementsTableContainer');
        if (container) {
            // Saƒüa scroll - son eklenen √∂l√ß√ºm s√ºtunlarƒ± ve fark s√ºtunu g√∂r√ºns√ºn
            container.scrollLeft = container.scrollWidth;
        }
    }, 100);
}

// √ñl√ß√ºm modalƒ±nƒ± kapat
function closeMeasurementsModal() {
    document.getElementById('measurementsModal').classList.remove('active');
    document.getElementById('measurementsModal').style.display = 'none';
}

// √ñl√ß√ºmleri tabloya y√ºkle (TRANSPOZ - Satƒ±rlar: √ñl√ß√ºm noktalarƒ±, S√ºtunlar: Tarihler)
function loadMeasurementsTable() {
    if (!patientData.measurements) {
        patientData.measurements = [];
    }
    
    const week = weeks[currentMeasurementWeekIndex];
    const thead = document.getElementById('measurementsHeader');
    const tbody = document.getElementById('measurementsBody');
    const tfoot = document.getElementById('measurementsFooter');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    tfoot.innerHTML = '';
    
    // Sƒ±ralƒ± √∂l√ß√ºmler (eskiden yeniye)
    const sortedMeasurements = [...patientData.measurements].sort((a, b) => 
        new Date(a.tarih) - new Date(b.tarih)
    );
    
    // Eƒüer hi√ß √∂l√ß√ºm yoksa bo≈ü satƒ±r ekle
    if (sortedMeasurements.length === 0) {
        addMeasurementRow();
        return;
    }
    
    // HEADER OLU≈ûTUR (Tarihler)
    const headerTr = document.createElement('tr');
    headerTr.style.cssText = 'background: #9b59b6; color: white;';
    
    let headerHtml = `
        <th style="padding: 12px; min-width: 120px; position: sticky; left: 0; background: #9b59b6; z-index: 2; border-right: 2px solid white;">
            √ñl√ß√ºm Noktasƒ±
        </th>
    `;
    
    sortedMeasurements.forEach((measurement, index) => {
        const date = new Date(measurement.tarih);
        const dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
        const isCurrentWeek = measurement.hafta === `${week.weekNumber}. Hafta`;
        
        headerHtml += `
            <th style="padding: 8px; min-width: 80px; border-right: 1px solid white; background: ${isCurrentWeek ? '#8e44ad' : '#9b59b6'};">
                <div style="font-size: 11px; font-weight: 600;">${dateStr}</div>
                <div style="font-size: 9px; opacity: 0.9; margin-top: 2px;">${measurement.hafta || ''}</div>
                <button onclick="deleteMeasurementColumn(${index})" 
                    style="background: rgba(231,76,60,0.9); color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-top: 4px;">
                    üóëÔ∏è
                </button>
            </th>
        `;
    });
    
    // FARK S√úTUNU (en saƒüda, sticky)
    if (sortedMeasurements.length >= 2) {
        headerHtml += `
            <th style="padding: 8px; min-width: 90px; position: sticky; right: 0; background: #27ae60; z-index: 2; border-left: 2px solid white;">
                <div style="font-size: 11px; font-weight: 600;">FARK</div>
                <div style="font-size: 9px; opacity: 0.9; margin-top: 2px;">ƒ∞lk ‚Üí Son</div>
            </th>
        `;
    }
    
    headerTr.innerHTML = headerHtml;
    thead.appendChild(headerTr);
    
    // TRANSPOZ TABLO: Her √∂l√ß√ºm noktasƒ± bir satƒ±r
    MEASUREMENT_FIELDS.forEach(field => {
        const tr = document.createElement('tr');
        tr.style.cssText = 'border-bottom: 1px solid #e0e0e0;';
        
        // ƒ∞lk s√ºtun: √ñl√ß√ºm noktasƒ± adƒ± (sticky)
        let html = `
            <td style="padding: 10px 12px; font-weight: 600; color: #2c3e50; border-right: 2px solid #9b59b6; position: sticky; left: 0; background: #f8f9fa; z-index: 1; min-width: 120px;">
                ${field.label}
            </td>
        `;
        
        // Her tarih i√ßin deƒüer s√ºtunu
        sortedMeasurements.forEach((measurement, index) => {
            const value = measurement[field.key] || '';
            const isCurrentWeek = measurement.hafta === `${week.weekNumber}. Hafta`;
            
            html += `
                <td style="padding: 6px; text-align: center; border-right: 1px solid #e0e0e0; background: ${isCurrentWeek ? '#f4ecf7' : 'white'}; min-width: 80px;">
                    <input type="number" 
                        step="0.1" 
                        value="${value}" 
                        placeholder="-"
                        data-index="${index}"
                        data-field="${field.key}"
                        onchange="updateMeasurementValue(${index}, '${field.key}', this.value)" 
                        style="width: 65px; border: 1px solid #d0d0d0; padding: 5px; border-radius: 4px; text-align: center; font-size: 12px;">
                </td>
            `;
        });
        
        // FARK S√úTUNU (en saƒüda her satƒ±r i√ßin)
        if (sortedMeasurements.length >= 2) {
            const first = sortedMeasurements[0];
            const last = sortedMeasurements[sortedMeasurements.length - 1];
            const diff = (last[field.key] || 0) - (first[field.key] || 0);
            const color = diff < 0 ? '#27ae60' : (diff > 0 ? '#e74c3c' : '#95a5a6');
            const prefix = diff > 0 ? '+' : '';
            
            html += `
                <td style="padding: 8px; text-align: center; border-left: 2px solid #27ae60; position: sticky; right: 0; background: #e8f5e9; z-index: 1; min-width: 90px;">
                    <div style="color: ${color}; font-weight: 700; font-size: 13px;">
                        ${prefix}${diff.toFixed(1)}
                    </div>
                </td>
            `;
        }
        
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });
    
    // FARK SATIRI KALDIRILDI - Artƒ±k saƒüda s√ºtun olarak var
}

// √ñl√ß√ºm s√ºtununu sil (tarih/hafta sil)
function deleteMeasurementColumn(index) {
    if (confirm('Bu tarihteki t√ºm √∂l√ß√ºmleri silmek istediƒüinizden emin misiniz?')) {
        patientData.measurements.splice(index, 1);
        loadMeasurementsTable();
        showToast('‚úÖ √ñl√ß√ºm silindi', 'success');
    }
}

// √ñl√ß√ºm deƒüerini g√ºncelle
function updateMeasurementValue(index, field, value) {
    if (patientData.measurements[index]) {
        patientData.measurements[index][field] = value;
    }
}

// Yeni √∂l√ß√ºm satƒ±rƒ± ekle
function addMeasurementRow() {
    const week = weeks[currentMeasurementWeekIndex];
    const today = new Date().toISOString().split('T')[0];
    
    const newMeasurement = {
        tarih: today,
        hafta: `${week.weekNumber}. Hafta`,
        kilo: '',
        boyun: '',
        omuz: '',
        gogus: '',
        bel: '',
        karin: '',
        kalca: '',
        sagKol: '',
        solKol: '',
        sagUyluk: '',
        solUyluk: '',
        sagBaldir: '',
        solBaldir: ''
    };
    
    patientData.measurements.push(newMeasurement);
    loadMeasurementsTable();
}

// √ñl√ß√ºm√º g√ºncelle
// √ñl√ß√ºmleri kaydet
async function saveMeasurements() {
    try {
        // √ñnce tabloyu yenile (fark satƒ±rƒ±nƒ± g√∂ster)
        loadMeasurementsTable();
        
        await savePatientData();
        
        // Hafta tabƒ±ndaki sayƒ±yƒ± g√ºncelle
        const week = weeks[currentMeasurementWeekIndex];
        const weekMeasurements = patientData.measurements.filter(m => m.hafta === `${week.weekNumber}. Hafta`);
        const countEl = document.getElementById(`measurementCount_${currentMeasurementWeekIndex}`);
        if (countEl) {
            countEl.textContent = weekMeasurements.length > 0 ? `${weekMeasurements.length} kayƒ±t` : 'Kayƒ±t yok';
        }
        
        showToast('‚úÖ √ñl√ß√ºmler kaydedildi', 'success');
    } catch (error) {
        console.error('√ñl√ß√ºm kaydetme hatasƒ±:', error);
        showToast('‚ùå √ñl√ß√ºmler kaydedilemedi', 'error');
    }
}

// √ñl√ß√ºm grafiƒüini g√∂ster
function showMeasurementChart() {
    if (!patientData.measurements || patientData.measurements.length < 2) {
        showToast('‚ùå Grafik olu≈üturmak i√ßin en az 2 √∂l√ß√ºm gerekli', 'error');
        return;
    }
    
    // Grafik modalƒ±nƒ± g√∂ster
    document.getElementById('measurementChartModal').classList.add('active');
    document.getElementById('measurementChartModal').style.display = 'flex';
    
    // Grafik √ßiz (Chart.js ile - basit versiyon)
    drawMeasurementChart();
}

// Grafik modalƒ±nƒ± kapat
function closeMeasurementChart() {
    document.getElementById('measurementChartModal').classList.remove('active');
    document.getElementById('measurementChartModal').style.display = 'none';
}

// Grafik √ßiz (Chart.js olmadan basit canvas kullanƒ±mƒ±)
function drawMeasurementChart() {
    const canvas = document.getElementById('measurementChart');
    const ctx = canvas.getContext('2d');
    
    // Canvas boyutlarƒ±nƒ± ayarla
    canvas.width = canvas.offsetWidth;
    canvas.height = 400;
    
    // Sƒ±ralƒ± √∂l√ß√ºmler
    const sortedMeasurements = [...patientData.measurements].sort((a, b) => 
        new Date(a.tarih) - new Date(b.tarih)
    );
    
    // Temizle
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Basit kilo grafiƒüi √ßiz
    const weights = sortedMeasurements.map(m => parseFloat(m.kilo) || 0).filter(w => w > 0);
    
    if (weights.length === 0) {
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Kilo verisi bulunamadƒ±', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const maxWeight = Math.max(...weights);
    const minWeight = Math.min(...weights);
    const range = maxWeight - minWeight || 1;
    
    const padding = 40;
    const graphWidth = canvas.width - (padding * 2);
    const graphHeight = canvas.height - (padding * 2);
    
    // √áizgi √ßiz
    ctx.strokeStyle = '#9b59b6';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    weights.forEach((weight, index) => {
        const x = padding + (index / (weights.length - 1)) * graphWidth;
        const y = padding + graphHeight - ((weight - minWeight) / range) * graphHeight;
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // Noktalar √ßiz
    weights.forEach((weight, index) => {
        const x = padding + (index / (weights.length - 1)) * graphWidth;
        const y = padding + graphHeight - ((weight - minWeight) / range) * graphHeight;
        
        ctx.fillStyle = '#8e44ad';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        
        // Beyaz kenar ekle
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Deƒüer etiketleri
        ctx.fillStyle = '#2c3e50';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(weight.toFixed(1) + 'kg', x, y - 12);
    });
    
    // Ba≈ülƒ±k
    ctx.fillStyle = '#2c3e50';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Kilo Deƒüi≈üimi Grafiƒüi', canvas.width / 2, 20);
    
    // Y ekseni √ßizgisi ve etiketleri
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();
    
    // X ekseni √ßizgisi
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();
}

</script>

    <!-- üìä Veritabanƒ± Kontrol Modalƒ± -->
    <div id="databaseCheckModal" class="modal" style="display: none; position: fixed; z-index: 10005; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 0; border: none; width: 95%; max-width: 1400px; border-radius: 15px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-radius: 15px 15px 0 0;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">üìä Veritabanƒ± Kontrol√º</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">T√ºm yemekleri kontrol edin ve d√ºzenleyin</p>
                </div>
                <button onclick="closeDatabaseCheckModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; font-size: 20px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: all 0.3s;">
                    ‚úñ
                </button>
            </div>

            <!-- Filtre B√∂l√ºm√º -->
            <div style="padding: 20px 30px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <label style="font-weight: 600; color: #555;">Filtrele:</label>
                    <select id="dbCheckFilter" onchange="filterDatabaseCheck()" style="padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="all">T√ºm√º (Veritabanƒ±nda Yok + E≈üle≈ütirmeli)</option>
                        <option value="missing">Sadece Veritabanƒ±nda Yok (‚ö†Ô∏è)</option>
                        <option value="mapped">Sadece E≈üle≈ütirmeli (‚úÖ)</option>
                    </select>
                    <button onclick="renderDatabaseCheckList()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üîÑ Yenile
                    </button>
                </div>
            </div>

            <!-- Liste B√∂l√ºm√º -->
            <div id="databaseCheckList" style="flex: 1; overflow-y: auto; padding: 20px 30px; background: #f5f7fa;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                    <p>Y√ºkleniyor...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- V√ºcut √ñl√ß√ºmleri Modalƒ± -->
    <div id="measurementsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: #f8f9fa; color: #2c3e50; border-bottom: 3px solid #9b59b6;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: #e8daef; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">üìè</div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">V√ºcut √ñl√ß√ºmleri</h3>
                        <p id="measurementModalWeek" style="margin: 4px 0 0 0; font-size: 13px; color: #7f8c8d;"></p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeMeasurementsModal()" style="color: #95a5a6;">&times;</button>
            </div>
            
            <div style="padding: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="addMeasurementRow()" style="padding: 10px 16px; background: #27ae60; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(39,174,96,0.2);">‚ûï Yeni Satƒ±r</button>
                    <button onclick="saveMeasurements()" style="padding: 10px 16px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(52,152,219,0.2);">üíæ Kaydet</button>
                    <button onclick="showMeasurementChart()" style="padding: 10px 16px; background: #9b59b6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(155,89,182,0.2);">üìä Grafik</button>
                </div>
                
                <div id="measurementsTableContainer" style="overflow-x: auto; border-radius: 8px; border: 1px solid #e0e0e0; max-width: 100%;">
                    <table id="measurementsTable" style="width: auto; border-collapse: collapse; font-size: 12px; table-layout: auto;">
                        <thead id="measurementsHeader">
                            <!-- Header dinamik olu≈üturulacak -->
                        </thead>
                        <tbody id="measurementsBody"></tbody>
                        <tfoot id="measurementsFooter"></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- √ñl√ß√ºm Grafiƒüi Modalƒ± -->
    <div id="measurementChartModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: #f8f9fa; color: #2c3e50; border-bottom: 3px solid #9b59b6;">
                <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">üìä V√ºcut √ñl√ß√ºmleri Grafiƒüi</h3>
                <button class="modal-close" onclick="closeMeasurementChart()" style="color: #95a5a6;">&times;</button>
            </div>
            
            <div style="padding: 20px;">
                <canvas id="measurementChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

</body>
</html>




