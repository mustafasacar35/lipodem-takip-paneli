<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Beslenme Planım">
    <meta name="application-name" content="Beslenme Planım">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png">

    <title>Beslenme Planım - Lipodem Takip</title>
    
    <!-- Nutrition Data Manager -->
    <script src="nutrition_data_manager.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .patient-info h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .patient-info p {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Tabs Container */
        .tabs-wrapper {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px;
            flex: 1;
        }

        .tabs-container::-webkit-scrollbar {
            height: 6px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .tab {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }

        .tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102,126,234,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab-close {
            margin-left: auto;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0.8;
        }

        .tab-close:hover {
            opacity: 1;
            background: rgba(255,255,255,0.5);
        }

        .btn-add-week {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .btn-add-week:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .week-content {
            display: none;
        }

        .week-content.active {
            display: block;
        }

        /* Week Header */
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .week-info h3 {
            color: #667eea;
            font-size: 22px;
            margin-bottom: 5px;
        }

        .week-info p {
            color: #666;
            font-size: 14px;
        }

        .week-stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-box .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-box .value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-top: 3px;
        }

        /* Day Cards */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
        }

        .day-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .day-date {
            font-size: 12px;
            color: #666;
        }

        .btn-refresh-day {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .btn-refresh-day:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.5);
        }

        .btn-refresh-day:active {
            transform: rotate(180deg) scale(0.95);
        }

        .day-macros {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .macro {
            flex: 1;
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .macro .label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }

        .macro .value {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-top: 2px;
        }

        .meals-list {
            margin-top: 10px;
        }

        .meal-item {
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .meal-item-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .meal-item-content {
            padding: 10px;
        }

        .meal-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .meal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .meal-table thead {
            background: #f8f9fa;
        }

        .meal-table th {
            padding: 6px 4px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .meal-table td {
            padding: 6px 4px;
            color: #666;
            border-bottom: 1px solid #f1f3f5;
        }

        .meal-table tbody tr:last-child td {
            border-bottom: none;
        }

        .meal-table tbody tr:hover {
            background: #f8f9fa;
        }

        .meal-foods {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }

        .btn-add-day {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-add-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Template Selection */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .template-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-item:hover {
            border-color: #667eea;
            background: #e7f0ff;
        }

        .template-item.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-item.used-template {
            background: #d4edda;
            border-color: #28a745;
        }

        .template-item.used-template:hover {
            background: #c3e6cb;
            border-color: #28a745;
        }

        .template-item.used-template.selected {
            border-color: #0dcaf0;
            background: #cff4fc;
            color: #055160;
        }

        .template-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .template-macros {
            font-size: 11px;
            opacity: 0.8;
        }

        .btn-sort {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-sort:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-sort:active {
            transform: translateY(0);
        }

        .template-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .template-table th,
        .template-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: left;
        }

        .template-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .template-table th:hover {
            background: #5568d3;
        }

        .template-table th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
            font-size: 0.8em;
        }

        .template-table th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        .template-table th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        .template-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-table tbody tr:hover {
            background: #f8f9fa;
        }

        .template-table tbody tr.selected {
            background: #cff4fc;
            border-left: 4px solid #0dcaf0;
        }

        .template-table tbody tr.used-template {
            background: #d4edda;
        }

        .template-table .meal-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .template-selected-days {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 11px;
            font-weight: 600;
        }

        .template-item:not(.selected) .template-selected-days {
            border-top-color: #dee2e6;
            color: #0d6efd;
        }

        /* Selected Templates Band */
        #selectedTemplatesBand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .selected-day-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #055160;
            background: #cff4fc;
            border: 2px solid #0dcaf0;
            position: relative;
        }

        .selected-day-badge .order-number {
            background: rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .selected-day-badge .remove-badge {
            background: rgba(255, 255, 255, 0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .selected-day-badge .remove-badge:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            .tabs-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            .days-grid {
                grid-template-columns: 1fr;
            }

            .week-stats {
                flex-direction: column;
                gap: 10px;
            }

            .header-right {
                flex-direction: column;
                gap: 5px;
            }

            .btn-header {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Message */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            animation: slideInUp 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="patient-info">
                <h2 id="headerPatientName">Yükleniyor...</h2>
                <p id="patientStats">Beslenme Programı</p>
            </div>
        </div>
        <div class="header-right">
            <button class="btn-header" onclick="downloadAllData()">
                💾 Verileri İndir
            </button>
            <button class="btn-header" onclick="openSettings()">
                ⚙️ Ayarlar
            </button>
            <button class="btn-header" onclick="logout()">
                🚪 Çıkış
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tabs -->
        <div class="tabs-wrapper">
            <div class="tabs-container" id="tabsContainer">
                <!-- Tabs will be generated here -->
            </div>
            <button class="btn-add-week" onclick="addNewWeek()">
                ➕ Yeni Hafta Ekle
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <div class="loading">
                <div class="spinner"></div>
                <p>Yükleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Add Day Modal -->
    <div class="modal" id="addDayModal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Gün Ekle (Çoklu Seçim Yapabilirsiniz)</h3>
                <button class="modal-close" onclick="closeModal('addDayModal')">&times;</button>
            </div>
            
            <!-- Otomatik Haftalık Planlama Butonu -->
            <div style="margin-bottom: 20px;">
                <button 
                    onclick="openAutoWeekPlanModal()" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';"
                >
                    <span style="font-size: 24px;">🤖</span>
                    <span>OTOMATIK HAFTALIK PLAN OLUŞTUR</span>
                    <span style="font-size: 24px;">✨</span>
                </button>
                <small style="display: block; text-align: center; color: #666; margin-top: 8px;">
                    Hedef kaloriye en uygun menülerle otomatik haftalık plan oluşturur
                </small>
            </div>
            
            <!-- Akıllı Arama Filtreleri -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #28a745;">
                            ✅ İstenen Yemekler (virgülle ayırın)
                        </label>
                        <input 
                            type="text" 
                            id="wantedFoodsFilter" 
                            placeholder="örn: lupin, poğaça" 
                            style="width: 100%; padding: 8px; border: 2px solid #28a745; border-radius: 6px;"
                            oninput="applySmartFilter()"
                        >
                        <small style="color: #666; display: block; margin-top: 3px;">
                            Tüm kelimeleri içeren yemekleri gösterir
                        </small>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #dc3545;">
                            ❌ İstenmeyen Yemekler (virgülle ayırın)
                        </label>
                        <input 
                            type="text" 
                            id="unwantedFoodsFilter" 
                            placeholder="örn: zeytin, peynir" 
                            style="width: 100%; padding: 8px; border: 2px solid #dc3545; border-radius: 6px;"
                            oninput="applySmartFilter()"
                        >
                        <small style="color: #666; display: block; margin-top: 3px;">
                            Bu kelimeleri içeren yemekleri gizler
                        </small>
                    </div>
                </div>
                <div id="filterStats" style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px; font-size: 13px; color: #666;">
                    <span id="visibleCount">0</span> / <span id="totalCount">0</span> menü gösteriliyor
                </div>
            </div>
            
            <!-- Menü Tablosu -->
            <div class="form-group">
                <div id="dayTemplateTable" style="overflow-x: auto;">
                    <!-- Table will be loaded here -->
                </div>
            </div>
            <button class="btn-primary" onclick="saveMultipleDaysToWeek()" id="saveMultipleDaysBtn" style="display: none;">Seçilen Günleri Kaydet</button>
        </div>
```
    </div>

    <!-- Auto Week Plan Modal -->
    <div class="modal" id="autoWeekPlanModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>🤖 Otomatik Haftalık Plan</h3>
                <button class="modal-close" onclick="closeModal('autoWeekPlanModal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <p style="margin: 0; color: #1976d2; font-size: 14px;">
                    ℹ️ Bu özellik, hedef kaloriye en uygun menüleri seçerek otomatik olarak haftalık plan oluşturur. 
                    Mevcut haftaya kalan günler + tam 1 hafta doldurulur.
                </p>
            </div>
            
            <!-- Hasta Bilgileri Önizleme ve Düzenleme -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea;">👤 Hasta Bilgileri</h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Kilo (kg)</label>
                        <input type="number" id="autoPlanWeight" placeholder="70" step="0.1" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Boy (cm)</label>
                        <input type="number" id="autoPlanHeight" placeholder="170" step="1" oninput="updateAutoPlanCalories()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Aktivite Seviyesi</label>
                        <select id="autoPlanActivity" onchange="updateAutoPlanCalories()">
                            <option value="1">Hareketsiz</option>
                            <option value="2">Az Hareketli</option>
                            <option value="3" selected>Orta Hareketli</option>
                            <option value="4">Çok Hareketli</option>
                            <option value="5">Profesyonel Sporcu</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Diyet Tipi</label>
                        <select id="autoPlanDietType" onchange="updateAutoPlanCalories()">
                            <option value="eliminasyonlu-ketojenik">Eliminasyonlu Ketojenik</option>
                            <option value="ketojenik" selected>Ketojenik</option>
                            <option value="lowcarb">Low Carb</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>İstenmeyen Yemekler (virgülle ayırın)</label>
                    <input type="text" id="autoPlanDislikedFoods" placeholder="örn: zeytin, peynir">
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 2px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #667eea;">🎯 Hedef Kalori:</span>
                        <span id="autoPlanTargetCalories" style="font-size: 24px; font-weight: 700; color: #667eea;">0</span>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Menüler bu hedef kaloriye en yakın olanlardan seçilecek
                    </small>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" onclick="closeModal('autoWeekPlanModal')" style="flex: 1;">İptal</button>
                <button class="btn-primary" onclick="generateAutoWeekPlan()" style="flex: 2;">
                    ✨ Otomatik Plan Oluştur
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Hasta Ayarları</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <!-- Kişisel Bilgiler -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">👤 Kişisel Bilgiler</h4>
                
                <!-- Ad, Soyad -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Ad *</label>
                        <input type="text" id="patientName" placeholder="örn: Ayşe" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Soyad *</label>
                        <input type="text" id="patientSurname" placeholder="örn: Yılmaz" required>
                    </div>
                </div>
                
                <!-- Yaş, Cinsiyet -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Yaş *</label>
                        <input type="number" id="patientAge" placeholder="örn: 35" min="1" max="150" required>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Cinsiyet *</label>
                        <select id="patientGender" required>
                            <option value="">Seçiniz</option>
                            <option value="Kadın">Kadın</option>
                            <option value="Erkek">Erkek</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Kilo, Boy -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>Kilo (kg) *</label>
                        <input type="number" id="patientWeight" placeholder="örn: 70" step="0.1" min="20" max="300" required oninput="calculateBMI(); updateMacroDisplay();">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Boy (cm) *</label>
                        <input type="number" id="patientHeight" placeholder="örn: 170" min="50" max="250" required oninput="calculateBMI()">
                    </div>
                </div>
                
                <!-- BMI, Aktivite -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>BMI (otomatik hesaplanır)</label>
                        <input type="text" id="patientBMI" readonly style="background: #f5f5f5; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label>Aktivite Seviyesi *</label>
                        <select id="patientActivity" onchange="updateMacroDisplay()" required>
                            <option value="1">1 - Hareketsiz</option>
                            <option value="2">2 - Az Hareketli</option>
                            <option value="3" selected>3 - Orta Hareketli</option>
                            <option value="4">4 - Çok Hareketli</option>
                            <option value="5">5 - Son Derece Aktif</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Kullanıcı Adı ve Şifre -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 16px;">🔐 Giriş Bilgileri</h4>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Kullanıcı Adı (değiştirilemez)</label>
                    <input type="text" id="patientUsername" readonly style="background: #f5f5f5; cursor: not-allowed;">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label>Yeni Şifre (opsiyonel)</label>
                    <input type="password" id="patientPassword" placeholder="Boş bırakılırsa değişmez" minlength="4">
                    <small style="color: #6c757d; font-size: 12px;">En az 4 karakter. Boş bırakılırsa mevcut şifreniz korunur.</small>
                </div>
            </div>

            <!-- Beslenme Ayarları -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">🍽️ Beslenme Ayarları</h4>
                
                <div class="form-group">
                    <label>Diyet Türü</label>
                    <select id="dietType" onchange="updateMacroDisplay()">
                        <option value="">Tümü</option>
                        <option value="eliminasyonlu-ketojenik">Eliminasyonlu Ketojenik</option>
                        <option value="ketojenik">Ketojenik</option>
                        <option value="lowcarb">Düşük Karbonhidrat</option>
                        <option value="mediterranean">Akdeniz Diyeti</option>
                        <option value="vegan">Vegan</option>
                    </select>
                </div>

                <!-- Önerilen Makro Hesaplaması -->
                <div id="macroDisplay" style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 14px;">📊 Önerilen Makrolar</h4>
                    <div id="macroDetails" style="font-size: 13px; color: #333;"></div>
                </div>

                <div class="form-group">
                    <label>
                        Kalori Toleransı (%)
                        <span style="color: #666; font-size: 12px; display: block;">Şablon filtrelemede ±% sapma oranı (admin varsayılanı: <span id="adminDefaultTolerance">5</span>%)</span>
                    </label>
                    <input type="number" id="calorieTolerancePercent" placeholder="örn: 10" min="0" max="50" step="1" oninput="updateToleranceInfo()">
                </div>

                <div class="form-group">
                    <label>
                        Hedef Kalori (günlük)
                        <span id="toleranceInfo" style="color: #666; font-size: 12px; display: block;">Min ve Max otomatik ±%5 tolerans ile ayarlanır</span>
                    </label>
                    <input type="number" id="targetCalories" placeholder="örn: 1000" oninput="updateCalorieRange()">
                </div>

                <div class="form-group">
                    <label>Günlük Kalori Hedefi (Min)</label>
                    <input type="number" id="minCalories" placeholder="Otomatik hesaplanır" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Günlük Kalori Hedefi (Max)</label>
                    <input type="number" id="maxCalories" placeholder="Otomatik hesaplanır" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Sevmediğim Yemekler (virgülle ayırın)</label>
                    <textarea id="dislikedFoods" rows="4" placeholder="örn: ıspanak, patlıcan, enginar"></textarea>
                </div>
            </div>

            <button class="btn-primary" onclick="saveSettings()">💾 Kaydet</button>
        </div>
    </div>    <!-- Toast Message -->
    <div class="toast" id="toast"></div>

    <script>
        // Global Variables
        let currentPatient = null;
        let patientData = null; // Hasta bilgileri (kilo, aktivite vs)
        let weeks = [];
        let currentWeekIndex = 0;
        let activeWeekIndex = 0;
        let dayTemplates = [];
        let mealTemplates = [];
        let settings = {
            dietType: 'ketojenik', // Varsayılan ketojenik
            targetCalories: 1000,
            minCalories: 950,
            maxCalories: 1050,
            dislikedFoods: [],
            personalInfo: {
                weight: 70,
                height: 170,
                age: 35,
                activity: 3
            }
        };
        let appSettings = null; // Admin ayarlarından gelecek diyet formülleri

        // Makro Hesaplama Fonksiyonu
        function calculateMacros(weight, dietType, activityLevel) {
            if (!appSettings || !appSettings.dietFormulas) {
                console.warn('⚠️ Diyet formülleri yüklenmedi, varsayılan değerler kullanılıyor');
                // Varsayılan değerler
                const defaultFormulas = {
                    ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                    lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                    activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                };
                return calculateMacrosWithFormula(weight, dietType, activityLevel, defaultFormulas);
            }
            
            return calculateMacrosWithFormula(weight, dietType, activityLevel, appSettings.dietFormulas);
        }

        function calculateMacrosWithFormula(weight, dietType, activityLevel, formulas) {
            // Diyet türüne göre formülü seç
            let formula;
            if (dietType === 'ketojenik') {
                formula = formulas.ketojenik;
            } else if (dietType === 'lowcarb') {
                formula = formulas.lowcarb;
            } else {
                console.warn('⚠️ Bilinmeyen diyet türü:', dietType);
                return null;
            }

            // Aktivite çarpanını al
            const activityMultiplier = formulas.activityMultipliers[activityLevel] || 1.0;

            // Gram hesapla
            const carbGrams = weight * formula.carb;
            const proteinGrams = weight * formula.protein;
            const fatGrams = weight * formula.fat;

            // Kalori hesapla (karbonhidrat: 4 kcal/g, protein: 4 kcal/g, yağ: 9 kcal/g)
            const carbCal = carbGrams * 4;
            const proteinCal = proteinGrams * 4;
            const fatCal = fatGrams * 9;
            const totalBaseCal = carbCal + proteinCal + fatCal;

            // Aktivite çarpanını uygula
            const totalCal = totalBaseCal * activityMultiplier;

            return {
                carb: Math.round(carbGrams),
                protein: Math.round(proteinGrams),
                fat: Math.round(fatGrams),
                calories: Math.round(totalCal),
                activityMultiplier: activityMultiplier
            };
        }

        // Admin ayarlarını GitHub'dan yükle
        async function loadAdminSettings() {
            try {
                const response = await fetch('settings/config.json', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    appSettings = data;
                    console.log('✅ Admin ayarları yüklendi:', appSettings);
                } else {
                    console.warn('⚠️ Admin ayarları yüklenemedi, varsayılan değerler kullanılacak');
                    appSettings = {
                        calorieTolerancePercent: 5,
                        dietFormulas: {
                            ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                            lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                            activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                        }
                    };
                }
            } catch (error) {
                console.warn('⚠️ Admin ayarları yüklenirken hata:', error);
                appSettings = {
                    calorieTolerancePercent: 5,
                    dietFormulas: {
                        ketojenik: { carb: 0.3, protein: 0.8, fat: 1.2 },
                        lowcarb: { carb: 0.6, protein: 0.8, fat: 1.0 },
                        activityMultipliers: { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 }
                    }
                };
            }
        }

        // Initialize
        async function init() {
            console.log('🚀 Başlatılıyor...');
            
            // Admin ayarlarını yükle
            await loadAdminSettings();
            
            // Check if PatientAuth is available
            if (typeof PatientAuth === 'undefined') {
                console.error('❌ PatientAuth bulunamadı!');
                showErrorPage('Kimlik doğrulama sistemi yüklenemedi');
                return;
            }

            // Check if user is logged in
            const session = PatientAuth.getSession();
            if (!session) {
                console.warn('⚠️ Session bulunamadı, giriş sayfasına yönlendiriliyor');
                window.location.href = 'login.html';
                return;
            }

            console.log('✅ Session bulundu:', session);

            // Set current patient info
            currentPatient = {
                id: session.patientId || session.id,
                name: session.name || 'Hasta',
                username: session.username || ''
            };

            // Header'ı hemen güncelle (loadPatientData detaylı bilgi yüklenince tekrar güncelleyecek)
            document.getElementById('headerPatientName').textContent = currentPatient.name;

            // Hasta bilgilerini yükle (kilo, aktivite vs) - header'daki ad burada güncellenir
            await loadPatientData();

            // Load templates
            await loadTemplates();

            // Load data from GitHub (with localStorage cache fallback)
            await loadDataFromGitHub();

            // Render UI
            renderTabs();
            renderWeekContent();
        }

        // Show error page
        function showErrorPage(message) {
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">${message}</h3>
                    <p style="color: #666; margin-bottom: 20px;">Lütfen sayfayı yenileyin veya giriş sayfasına dönün.</p>
                    <button onclick="window.location.href='login.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Giriş Sayfasına Dön
                    </button>
                </div>
            `;
        }

        // Hasta bilgilerini yükle (hastalar/ klasöründen)
        async function loadPatientData() {
            try {
                // currentPatient.id zaten patient_ öneki içeriyor, temizle
                const cleanId = currentPatient.id.replace(/^patient_/i, '');
                const patientFileName = `hastalar/patient_${cleanId}.json`;
                
                console.log('🔍 Hasta verisi yükleniyor:', patientFileName);
                
                // Önce localStorage'dan kontrol et
                const cachedDataKey = `patient_data_${cleanId}`;
                const cachedData = localStorage.getItem(cachedDataKey);
                let cachedPatientData = cachedData ? JSON.parse(cachedData) : null;
                
                // GitHub'dan da çek ve karşılaştır (cache bypass için timestamp)
                const timestamp = new Date().getTime();
                const response = await fetch(`${patientFileName}?t=${timestamp}`);
                
                if (response.ok) {
                    const githubPatientData = await response.json();
                    
                    // updatedAt tarihlerine göre hangisi daha yeni?
                    const cachedDate = cachedPatientData?.updatedAt ? new Date(cachedPatientData.updatedAt).getTime() : 0;
                    const githubDate = githubPatientData?.updatedAt ? new Date(githubPatientData.updatedAt).getTime() : 0;
                    
                    if (githubDate > cachedDate) {
                        // GitHub'daki daha yeni
                        patientData = githubPatientData;
                        localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                        console.log('✅ Hasta bilgileri GitHub\'dan yüklendi (daha güncel):', patientData);
                    } else if (cachedPatientData) {
                        // LocalStorage'daki daha yeni veya aynı
                        patientData = cachedPatientData;
                        console.log('✅ Hasta bilgileri localStorage\'dan yüklendi (daha güncel):', patientData);
                    } else {
                        // Cache yok, GitHub'dan al
                        patientData = githubPatientData;
                        localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                        console.log('✅ Hasta bilgileri GitHub\'dan yüklendi:', patientData);
                    }
                } else if (cachedPatientData) {
                    // GitHub'da yok ama localStorage'da var
                    patientData = cachedPatientData;
                    console.log('✅ Hasta bilgileri localStorage\'dan yüklendi (GitHub yok):', patientData);
                } else {
                    console.warn('⚠️ Hasta dosyası bulunamadı, varsayılan değerler kullanılacak');
                    patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                }
                
                // Header'daki hasta adını güncelle
                const fullName = patientData.personalInfo?.name && patientData.personalInfo?.surname
                    ? `${patientData.personalInfo.name} ${patientData.personalInfo.surname}`
                    : patientData.personalInfo?.name || currentPatient.name || 'Hasta';
                document.getElementById('headerPatientName').textContent = fullName;
                    
            } catch (error) {
                console.error('❌ Hasta bilgileri yüklenirken hata:', error);
                patientData = { personalInfo: { weight: 70, height: 170, age: 35, activity: 3, activityLevel: 3 } };
                // Hata durumunda da header'ı güncelle
                document.getElementById('headerPatientName').textContent = currentPatient.name || 'Hasta';
            }
        }

        // Makro gösterimini güncelle
        function updateMacroDisplay() {
            const dietType = document.getElementById('dietType').value;
            const macroDisplay = document.getElementById('macroDisplay');
            const macroDetails = document.getElementById('macroDetails');

            if (!dietType || (dietType !== 'ketojenik' && dietType !== 'lowcarb' && dietType !== 'eliminasyonlu-ketojenik')) {
                macroDisplay.style.display = 'none';
                return;
            }

            // Form'dan güncel değerleri al - eğer form boşsa patientData'dan çek
            let weight = parseFloat(document.getElementById('patientWeight').value);
            let activity = parseInt(document.getElementById('patientActivity').value);
            
            // Eğer form değerleri boşsa, patientData'dan çek
            if (!weight && patientData?.personalInfo?.weight) {
                weight = patientData.personalInfo.weight;
                document.getElementById('patientWeight').value = weight;
            }
            if (!activity && patientData?.personalInfo?.activity) {
                activity = patientData.personalInfo.activity;
                document.getElementById('patientActivity').value = activity;
            }
            
            // Hala değer yoksa varsayılanları kullan
            weight = weight || 70;
            activity = activity || 3;

            // Eliminasyonlu ketojenik için ketojenik formülünü kullan
            const calcDietType = dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : dietType;
            const macros = calculateMacros(weight, calcDietType, activity);

            if (macros) {
                macroDetails.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>Kilo:</strong> ${weight} kg | <strong>Aktivite:</strong> Seviye ${activity} (×${macros.activityMultiplier})
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Karbonhidrat</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.carb}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Protein</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.protein}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Yağ</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.fat}g</div>
                        </div>
                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="color: #999; font-size: 11px; margin-bottom: 3px;">Kalori</div>
                            <div style="font-weight: 600; color: #667eea;">${macros.calories} kcal</div>
                        </div>
                    </div>
                `;
                macroDisplay.style.display = 'block';
                
                // Hesaplanan kaloriyi hedef kalori alanına yaz ve min/max'ı otomatik hesaplat
                document.getElementById('targetCalories').value = macros.calories;
                updateCalorieRange();
            } else {
                macroDisplay.style.display = 'none';
            }
        }

        // Hedef kaloriden min/max hesapla
        function updateCalorieRange() {
            const targetCalories = parseInt(document.getElementById('targetCalories').value) || 0;
            
            if (targetCalories > 0) {
                // Hasta kendi toleransını belirlediyse onu kullan, yoksa admin varsayılanını kullan
                let tolerancePercent = parseInt(document.getElementById('calorieTolerancePercent').value);
                if (!tolerancePercent || tolerancePercent < 0) {
                    tolerancePercent = appSettings?.calorieTolerancePercent || 5;
                }
                
                const tolerance = tolerancePercent / 100;
                
                const minCalories = Math.round(targetCalories * (1 - tolerance));
                const maxCalories = Math.round(targetCalories * (1 + tolerance));
                
                document.getElementById('minCalories').value = minCalories;
                document.getElementById('maxCalories').value = maxCalories;
                
                // Tolerans bilgisini güncelle
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ±%${tolerancePercent} tolerans ile ayarlanır`;
            } else {
                document.getElementById('minCalories').value = '';
                document.getElementById('maxCalories').value = '';
            }
        }

        // Tolerans değeri değiştiğinde bilgilendirme güncelle
        function updateToleranceInfo() {
            updateCalorieRange(); // Min/max'ı yeniden hesapla
        }

        // Load Data from GitHub
        async function loadDataFromGitHub() {
            console.log('🔄 GitHub\'dan veriler yükleniyor...');
            
            try {
                // Try to load from GitHub
                const settingsData = await NutritionDataManager.loadPatientSettings(currentPatient.id);
                const weeksData = await NutritionDataManager.loadPatientWeeks(currentPatient.id);

                // Update settings
                if (settingsData && settingsData.settings) {
                    settings = settingsData.settings;
                    // Cache to localStorage
                    NutritionDataManager.saveSettingsToCache(currentPatient.id, settingsData);
                } else {
                    // Try cache
                    const cachedSettings = NutritionDataManager.loadSettingsFromCache(currentPatient.id);
                    if (cachedSettings && cachedSettings.settings) {
                        settings = cachedSettings.settings;
                        console.log('💾 Ayarlar önbellekten yüklendi');
                    }
                }

                // Update weeks
                if (weeksData && weeksData.weeks) {
                    weeks = weeksData.weeks;
                    // Cache to localStorage
                    NutritionDataManager.saveWeeksToCache(currentPatient.id, weeksData);
                } else {
                    // Try cache
                    const cachedWeeks = NutritionDataManager.loadWeeksFromCache(currentPatient.id);
                    if (cachedWeeks && cachedWeeks.weeks) {
                        weeks = cachedWeeks.weeks;
                        console.log('💾 Haftalar önbellekten yüklendi');
                    } else {
                        // Create default first week
                        const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                        weeks = defaultWeeksData.weeks;
                    }
                }

                // Apply settings to form if modal is open
                applySettingsToForm();

                console.log('✅ Veriler başarıyla yüklendi');
                showToast('Veriler yüklendi');

            } catch (error) {
                console.error('❌ GitHub\'dan veri yüklenirken hata:', error);
                
                // Fallback to cache
                const cachedSettings = NutritionDataManager.loadSettingsFromCache(currentPatient.id);
                const cachedWeeks = NutritionDataManager.loadWeeksFromCache(currentPatient.id);

                if (cachedSettings && cachedSettings.settings) {
                    settings = cachedSettings.settings;
                }

                if (cachedWeeks && cachedWeeks.weeks) {
                    weeks = cachedWeeks.weeks;
                } else {
                    const defaultWeeksData = NutritionDataManager.getDefaultWeeks(currentPatient.id);
                    weeks = defaultWeeksData.weeks;
                }

                showToast('Önbellekten yüklendi', 'warning');
            }
        }

        // Load Templates from JSON
        async function loadTemplates() {
            try {
                console.log('📥 Şablonlar GitHub\'dan yükleniyor...');

                // Load day templates from GitHub
                const dayResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/gun-sablonlari-2025-10-25.json');
                const dayData = await dayResponse.json();
                dayTemplates = dayData.templates || [];

                // Load meal templates from GitHub
                const mealResponse = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/ogun-sablonlari-2025-09-25-2025-10-25%20(1).json');
                const mealData = await mealResponse.json();
                mealTemplates = mealData.templates || [];

                console.log('✅ Şablonlar yüklendi:', {
                    gunSablonlari: dayTemplates.length,
                    ogunSablonlari: mealTemplates.length
                });
            } catch (error) {
                console.error('❌ Şablonlar yüklenemedi:', error);
                showToast('Şablonlar yüklenemedi. Lütfen sayfayı yenileyin.', 'error');
                
                // Show error in UI
                const contentArea = document.getElementById('contentArea');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #dc3545; margin-bottom: 15px;">⚠️ Şablonlar Yüklenemedi</h3>
                            <p style="color: #666; margin-bottom: 20px;">Beslenme şablonları GitHub'dan yüklenemedi. Bu sayfa local file sisteminde çalışmaz.</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                                <strong>Çözüm:</strong><br>
                                1. Dosyaları bir web sunucusunda çalıştırın (XAMPP, WAMP, vb.)<br>
                                2. Ya da GitHub Pages'de deploy edin<br>
                                3. Ya da VS Code Live Server extension kullanın
                            </div>
                            <button onclick="location.reload()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                🔄 Sayfayı Yenile
                            </button>
                            <br><br>
                            <a href="mobil_versiyon_v1.html" style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; display: inline-block; margin-top: 10px;">
                                🍽️ Alternatif Yemeklere Git
                            </a>
                        </div>
                    `;
                }
            }
        }

        // Load Settings (for form display)
        function applySettingsToForm() {
            if (document.getElementById('dietType')) {
                // Hasta verilerinden bilgileri çek (patientData global olarak loadPatientData ile yüklendi)
                const personalInfo = patientData?.personalInfo || {};
                
                // Kişisel bilgiler - patientData'dan çek
                document.getElementById('patientName').value = personalInfo.name || '';
                document.getElementById('patientSurname').value = personalInfo.surname || '';
                document.getElementById('patientAge').value = personalInfo.age || 35;
                document.getElementById('patientGender').value = personalInfo.gender || '';
                document.getElementById('patientWeight').value = personalInfo.weight || 70;
                document.getElementById('patientHeight').value = personalInfo.height || 170;
                document.getElementById('patientActivity').value = personalInfo.activity || 3;
                
                // Aktivite seviyesi - personalInfo'dan veya settings'den al
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    activityLevelInput.value = personalInfo.activityLevel || settings.activityLevel || 3;
                }
                
                // Kullanıcı adı (readonly)
                const session = JSON.parse(localStorage.getItem('patient_session') || '{}');
                document.getElementById('patientUsername').value = session.username || '';
                
                // BMI hesapla
                calculateBMI();
                
                // Admin varsayılan toleransı göster
                const adminDefaultTolerance = appSettings?.calorieTolerancePercent || 5;
                document.getElementById('adminDefaultTolerance').textContent = adminDefaultTolerance;
                
                // Hasta kendi toleransını belirlediyse onu göster, yoksa admin varsayılanını kullan
                const patientTolerance = settings.calorieTolerancePercent || adminDefaultTolerance;
                document.getElementById('calorieTolerancePercent').value = patientTolerance;
                
                // Tolerans bilgisini göster
                document.getElementById('toleranceInfo').textContent = `Min ve Max otomatik ±%${patientTolerance} tolerans ile ayarlanır`;
                
                // Diyet ayarları - settings objesinden çek
                document.getElementById('dietType').value = settings.dietType || 'ketojenik';
                document.getElementById('targetCalories').value = settings.targetCalories || 1000;
                document.getElementById('minCalories').value = settings.minCalories || 950;
                document.getElementById('maxCalories').value = settings.maxCalories || 1050;
                document.getElementById('dislikedFoods').value = (settings.dislikedFoods || []).join(', ');
                
                // Makro gösterimini güncelle
                updateMacroDisplay();
            }
        }

        // BMI Hesaplama
        function calculateBMI() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const height = parseFloat(document.getElementById('patientHeight').value);
            
            if (weight > 0 && height > 0) {
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
                document.getElementById('patientBMI').value = bmi;
            } else {
                document.getElementById('patientBMI').value = '';
            }
        }

        // Save Settings - GitHub'a otomatik kaydet
        async function saveSettings() {
            const newSettings = {
                dietType: document.getElementById('dietType').value,
                calorieTolerancePercent: parseInt(document.getElementById('calorieTolerancePercent').value) || (appSettings?.calorieTolerancePercent || 5),
                targetCalories: parseInt(document.getElementById('targetCalories').value) || 1000,
                minCalories: parseInt(document.getElementById('minCalories').value) || 950,
                maxCalories: parseInt(document.getElementById('maxCalories').value) || 1050,
                dislikedFoods: document.getElementById('dislikedFoods').value
                    .split(',')
                    .map(f => f.trim().toLowerCase())
                    .filter(f => f),
                personalInfo: {
                    name: document.getElementById('patientName').value.trim(),
                    surname: document.getElementById('patientSurname').value.trim(),
                    age: parseInt(document.getElementById('patientAge').value) || 35,
                    gender: document.getElementById('patientGender').value,
                    weight: parseFloat(document.getElementById('patientWeight').value) || 70,
                    height: parseFloat(document.getElementById('patientHeight').value) || 170,
                    activity: parseInt(document.getElementById('patientActivity').value) || 3
                },
                password: document.getElementById('patientPassword').value.trim(), // Şifre varsa kaydet
                allergies: settings.allergies || [],
                preferences: settings.preferences || {
                    vegetarian: false,
                    vegan: false,
                    glutenFree: false,
                    dairyFree: false
                },
                activityLevel: settings.activityLevel || 'moderate',
                targetWeight: settings.targetWeight || 0,
                currentWeight: settings.currentWeight || 0,
                height: settings.height || 0,
                age: settings.age || 0,
                gender: settings.gender || ''
            };

            settings = newSettings;
            
            // patientData'yı da güncelle
            if (patientData) {
                patientData.personalInfo = {
                    ...patientData.personalInfo,
                    ...newSettings.personalInfo
                };
                
                // Aktivite seviyesi ekle
                const activityLevelInput = document.getElementById('activityLevel');
                if (activityLevelInput) {
                    patientData.personalInfo.activityLevel = parseInt(activityLevelInput.value) || 3;
                }

                patientData.settings = newSettings;
                
                // localStorage'a kaydet (anında senkronizasyon için)
                const cleanId = currentPatient.id.replace(/^patient_/i, '');
                const cachedDataKey = `patient_data_${cleanId}`;
                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));
                console.log('💾 Ayarlar localStorage\'a kaydedildi');
            }

            try {
                // GitHub'a kaydet (çoklu cihaz erişimi için)
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-settings';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patientId: currentPatient.id,
                        settings: newSettings
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('✅ Ayarlar GitHub\'a kaydedildi');
                    showToast('✅ Ayarlar kaydedildi! (GitHub + LocalStorage)');
                    setTimeout(() => closeModal('settingsModal'), 500);
                } else {
                    console.warn('⚠️ GitHub kayıt hatası (beklenen):', result.error);
                    showToast('✅ Ayarlar LocalStorage\'a kaydedildi (GitHub bağlantı sorunu)', 'success');
                    setTimeout(() => closeModal('settingsModal'), 1500);
                }
            } catch (error) {
                console.warn('⚠️ GitHub bağlantı hatası (beklenen - LocalStorage çalışıyor)');
                showToast('✅ Ayarlar LocalStorage\'a kaydedildi (GitHub bağlantı sorunu)', 'success');
                setTimeout(() => closeModal('settingsModal'), 1500);
            }
        }

        // Load Weeks - removed, now using loadDataFromGitHub()

        // Save Weeks - GitHub'a otomatik kaydet
        async function saveWeeks() {
            try {
                // 1. LocalStorage'a kaydet (anında senkronizasyon için)
                const cachedDataKey = `patient_data_${currentPatient.id}`;
                patientData.weeks = weeks;
                localStorage.setItem(cachedDataKey, JSON.stringify(patientData));

                // 2. GitHub'a kaydet (çoklu cihaz erişimi için)
                const apiUrl = 'https://lipodem-takip-paneli.vercel.app/api/update-weeks';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patientId: currentPatient.id,
                        weeks: weeks
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('✅ Haftalık planlar GitHub\'a kaydedildi');
                    // showToast('✅ Haftalık planlar kaydedildi! (GitHub + LocalStorage)');
                } else {
                    console.warn('⚠️ GitHub kayıt hatası (beklenen):', result.error);
                    // showToast('✅ Haftalık planlar LocalStorage\'a kaydedildi', 'success');
                }
            } catch (error) {
                console.warn('⚠️ GitHub bağlantı hatası (beklenen - LocalStorage çalışıyor)');
                // showToast('✅ Haftalık planlar LocalStorage\'a kaydedildi', 'success');
            }
        }

        // Add New Week
        function addNewWeek() {
            const weekNumber = weeks.length + 1;
            const lastWeek = weeks[weeks.length - 1];
            
            // Yeni hafta her zaman Pazartesi'den başlamalı
            let startDate = new Date();
            if (lastWeek && lastWeek.days.length > 0) {
                // Son haftanın son gününden sonraki Pazartesi'yi bul
                const lastDay = lastWeek.days[lastWeek.days.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
                
                // Pazartesi'ye kadar ilerle
                while (startDate.getDay() !== 1) { // 1 = Pazartesi
                    startDate.setDate(startDate.getDate() + 1);
                }
            } else if (lastWeek && lastWeek.startDate) {
                startDate = new Date(lastWeek.startDate);
                startDate.setDate(startDate.getDate() + 7);
                
                // Pazartesi'ye ayarla
                while (startDate.getDay() !== 1) {
                    startDate.setDate(startDate.getDate() + 1);
                }
            } else {
                // İlk hafta: Bir sonraki Pazartesi
                while (startDate.getDay() !== 1) {
                    startDate.setDate(startDate.getDate() + 1);
                }
            }

            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            renderWeekContent();
            showToast('Yeni hafta eklendi');
        }

        // Remove Week
        function removeWeek(index) {
            if (weeks.length === 1) {
                showToast('En az bir hafta bulunmalıdır', 'error');
                return;
            }

            if (confirm('Bu haftayı silmek istediğinizden emin misiniz?')) {
                weeks.splice(index, 1);
                saveWeeks();
                
                if (currentWeekIndex >= weeks.length) {
                    currentWeekIndex = weeks.length - 1;
                }
                if (activeWeekIndex >= weeks.length) {
                    activeWeekIndex = weeks.length - 1;
                }
                
                renderTabs();
                renderWeekContent();
                showToast('Hafta silindi');
            }
        }

        // Render Tabs
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            weeks.forEach((week, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === activeWeekIndex ? 'active' : ''}`;
                tab.innerHTML = `
                    <span onclick="switchWeek(${index})">${week.name}</span>
                    ${weeks.length > 1 ? `<button class="tab-close" onclick="event.stopPropagation(); removeWeek(${index})">&times;</button>` : ''}
                `;
                container.appendChild(tab);
            });
        }

        // Switch Week
        function switchWeek(index) {
            currentWeekIndex = index;
            activeWeekIndex = index;
            renderTabs();
            renderWeekContent();
        }

        // Render Week Content
        function renderWeekContent() {
            const contentArea = document.getElementById('contentArea');
            const week = weeks[activeWeekIndex];
            
            // currentWeekIndex'i senkronize tut
            currentWeekIndex = activeWeekIndex;

            if (!week) {
                contentArea.innerHTML = '<div class="empty-state"><h3>Hafta bulunamadı</h3></div>';
                return;
            }

            // Calculate totals
            const totalCalories = week.days.reduce((sum, day) => sum + (day.totalCalories || 0), 0);
            const avgCalories = week.days.length > 0 ? Math.round(totalCalories / week.days.length) : 0;

            let html = `
                <div class="week-header">
                    <div class="week-info">
                        <h3>${week.name}</h3>
                        <p>Başlangıç: ${formatDate(week.startDate)}</p>
                    </div>
                    <div class="week-stats">
                        <div class="stat-box">
                            <div class="label">Toplam Gün</div>
                            <div class="value">${week.days.length}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Ort. Kalori</div>
                            <div class="value">${avgCalories}</div>
                        </div>
                    </div>
                </div>
            `;

            if (week.days.length === 0) {
                html += `
                    <div class="empty-state">
                        <h3>Henüz gün eklenmemiş</h3>
                        <p>Beslenme programınızı oluşturmaya başlamak için gün ekleyin</p>
                    </div>
                `;
            } else {
                html += '<div class="days-grid">';
                week.days.forEach((day, dayIndex) => {
                    html += renderDayCard(day, dayIndex);
                });
                html += '</div>';
            }

            html += `<button class="btn-add-day" onclick="openAddDayModal()">➕ Gün Ekle</button>`;

            contentArea.innerHTML = html;
        }

        // Render Day Card
        function renderDayCard(day, dayIndex) {
            const macros = day.totalMacros || { kalori: 0, protein: 0, karb: 0, yag: 0 };
            
            // Öğünleri meals veya ogunler'den al
            const ogunler = day.meals || day.ogunler || [];
            
            let mealsHtml = '';
            if (ogunler && ogunler.length > 0) {
                ogunler.forEach(meal => {
                    // Öğün makrolarını hesapla
                    let ogunKalori = 0;
                    let ogunProtein = 0;
                    let ogunKarb = 0;
                    let ogunYag = 0;
                    
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach(food => {
                            ogunKalori += food.calories || food.kalori || 0;
                            ogunProtein += food.protein || 0;
                            ogunKarb += food.carbs || food.karb || 0;
                            ogunYag += food.fat || food.yag || 0;
                        });
                    }
                    
                    // Günlük kalori içindeki yüzde hesapla
                    const gunlukKalori = macros.kalori || 1;
                    const ogunYuzde = gunlukKalori > 0 ? Math.round((ogunKalori / gunlukKalori) * 100) : 0;
                    
                    // Öğün kartı - üst bant ile
                    mealsHtml += `
                        <div class="meal-item">
                            <div class="meal-item-header">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <span style="font-weight: 600;">${meal.ogunAdi}</span>
                                    <span style="font-size: 11px; opacity: 0.9;">
                                        ${Math.round(ogunKalori)} kcal 
                                        (P: ${Math.round(ogunProtein)}g, K: ${Math.round(ogunKarb)}g, Y: ${Math.round(ogunYag)}g) 
                                        • ${ogunYuzde}% günlük
                                    </span>
                                </div>
                            </div>
                            <div class="meal-item-content">
                                <table class="meal-table">
                                    <thead>
                                        <tr>
                                            <th>Yemek</th>
                                            <th>Kalori</th>
                                            <th>Karb</th>
                                            <th>Protein</th>
                                            <th>Yağ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Yemek satırları
                    if (meal.yemekler && meal.yemekler.length > 0) {
                        meal.yemekler.forEach(food => {
                            // JSON'dan gelen alanlar: calories, protein, carbs, fat
                            const kalori = food.calories || food.kalori || 0;
                            const protein = food.protein || 0;
                            const karb = food.carbs || food.karb || 0;
                            const yag = food.fat || food.yag || 0;
                            
                            mealsHtml += `
                                <tr>
                                    <td>${food.foodName || 'İsimsiz Yemek'}</td>
                                    <td>${Math.round(kalori)}</td>
                                    <td>${Math.round(karb)}g</td>
                                    <td>${Math.round(protein)}g</td>
                                    <td>${Math.round(yag)}g</td>
                                </tr>
                            `;
                        });
                    } else {
                        mealsHtml += `
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">Yemek yok</td>
                            </tr>
                        `;
                    }
                    
                    mealsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }

            return `
                <div class="day-card">
                    <div class="day-header">
                        <div class="day-name">${day.gunAdi || 'Gün'}</div>
                        <div class="day-date">${formatDate(day.date)}</div>
                        <button class="btn-refresh-day" onclick="refreshDayTemplate(${dayIndex})" title="Farklı şablon ile değiştir">
                            🔄
                        </button>
                    </div>
                    <div class="day-macros">
                        <div class="macro">
                            <div class="label">Kalori</div>
                            <div class="value">${macros.kalori}</div>
                        </div>
                        <div class="macro">
                            <div class="label">Protein</div>
                            <div class="value">${macros.protein}g</div>
                        </div>
                        <div class="macro">
                            <div class="label">Karb</div>
                            <div class="value">${macros.karb}g</div>
                        </div>
                        <div class="macro">
                            <div class="label">Yağ</div>
                            <div class="value">${macros.yag}g</div>
                        </div>
                    </div>
                    <div class="meals-list">
                        ${mealsHtml}
                    </div>
                </div>
            `;
        }

        // Open Add Day Modal
        function openAddDayModal() {
            // Önce hafta dolu mu kontrol et
            const currentWeek = weeks[currentWeekIndex];
            
            // Eğer haftada 7 gün varsa yeni hafta aç
            if (currentWeek.days.length >= 7) {
                // Yeni hafta bilgilerini hesapla
                const nextWeekNumber = weeks.length + 1;
                const lastWeek = weeks[weeks.length - 1];
                let nextStartDate = new Date();
                
                if (lastWeek && lastWeek.startDate) {
                    nextStartDate = new Date(lastWeek.startDate);
                    nextStartDate.setDate(nextStartDate.getDate() + 7);
                }
                
                // Bitiş tarihini hesapla (başlangıç + 6 gün)
                const nextEndDate = new Date(nextStartDate);
                nextEndDate.setDate(nextEndDate.getDate() + 6);
                
                // Tarih formatla (3-9 Kasım 2025)
                const startDay = nextStartDate.getDate();
                const endDay = nextEndDate.getDate();
                const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                                   'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                const month = monthNames[nextStartDate.getMonth()];
                const year = nextStartDate.getFullYear();
                
                const dateRange = `${startDay}-${endDay} ${month} ${year}`;
                const message = `Bu haftanın günleri tamamlanmış (7 gün). Yeni bir hafta (${nextWeekNumber}. hafta - ${dateRange}) oluşturmak ister misiniz?`;
                
                const confirmNewWeek = confirm(message);
                if (confirmNewWeek) {
                    addNewWeek();
                    // Yeni hafta oluşturulduktan sonra modal'ı aç
                    setTimeout(() => {
                        openAddDayModalAfterWeekCheck();
                    }, 100);
                    return;
                } else {
                    return; // İptal edildi
                }
            }
            
            openAddDayModalAfterWeekCheck();
        }

        // Hafta kontrolü sonrası modal açma
        function openAddDayModalAfterWeekCheck() {
            const modal = document.getElementById('addDayModal');
            modal.classList.add('active');
            
            // Seçimleri sıfırla
            selectedTemplates = [];
            
            // Akıllı filtreleri sıfırla
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            if (wantedInput) wantedInput.value = '';
            if (unwantedInput) unwantedInput.value = '';

            // Load filtered templates
            loadDayTemplates();
        }

        // Open Auto Week Plan Modal
        function openAutoWeekPlanModal() {
            // Hasta bilgilerini FORM inputlarından al (settings modal'daki veriler)
            const weightInput = document.getElementById('patientWeight');
            const heightInput = document.getElementById('patientHeight');
            const activityInput = document.getElementById('activityLevel');
            const dietTypeInput = document.getElementById('dietType');
            const dislikedFoodsInput = document.getElementById('dislikedFoods');
            
            // Hasta kayıt bilgilerinden de al
            const personalInfo = patientData?.personalInfo || {};
            
            // Modal'a doldur (öncelik: form input > personalInfo > varsayılan)
            document.getElementById('autoPlanWeight').value = weightInput?.value || personalInfo.weight || 70;
            document.getElementById('autoPlanHeight').value = heightInput?.value || personalInfo.height || 170;
            document.getElementById('autoPlanActivity').value = activityInput?.value || personalInfo.activityLevel || settings.activityLevel || '3';
            document.getElementById('autoPlanDietType').value = dietTypeInput?.value || settings.dietType || 'ketojenik';
            document.getElementById('autoPlanDislikedFoods').value = dislikedFoodsInput?.value || (settings.dislikedFoods || []).join(', ');
            
            // Hedef kaloriyi hesapla ve göster
            updateAutoPlanCalories();
            
            // Modal'ı aç
            document.getElementById('autoWeekPlanModal').classList.add('active');
        }

        // Hedef kaloriyi hesapla ve göster
        function updateAutoPlanCalories() {
            const weight = parseFloat(document.getElementById('autoPlanWeight').value) || 70;
            const height = parseFloat(document.getElementById('autoPlanHeight').value) || 170;
            const activity = parseInt(document.getElementById('autoPlanActivity').value) || 3;
            const dietType = document.getElementById('autoPlanDietType').value || 'ketojenik';
            
            console.log('📊 Kalori Hesaplama:', { weight, height, activity, dietType });
            
            // Admin settings'teki formülü kullan
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activity] || 1.0;
            const dietFormula = appSettings?.dietFormulas?.[dietType] || appSettings?.dietFormulas?.ketojenik;
            
            console.log('⚙️ Formül:', { activityMultiplier, dietFormula });
            
            if (dietFormula) {
                // Aktivite çarpanını da dahil et
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                
                // Kalori hesaplama: (P*4) + (K*4) + (Y*9)
                const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
                
                console.log('🎯 Hedef Kalori:', targetCalories);
                
                document.getElementById('autoPlanTargetCalories').textContent = targetCalories + ' kcal';
            } else {
                // Fallback basit hesaplama
                const targetCalories = Math.round(weight * 22 * activityMultiplier);
                document.getElementById('autoPlanTargetCalories').textContent = targetCalories + ' kcal';
            }
        }

        // Otomatik haftalık plan oluştur
        async function generateAutoWeekPlan() {
            const weight = parseFloat(document.getElementById('autoPlanWeight').value);
            const height = parseFloat(document.getElementById('autoPlanHeight').value);
            const activity = parseInt(document.getElementById('autoPlanActivity').value);
            const dietType = document.getElementById('autoPlanDietType').value;
            const dislikedFoods = document.getElementById('autoPlanDislikedFoods').value
                .split(',')
                .map(f => f.trim())
                .filter(f => f.length > 0);
            
            // Hedef kaloriyi admin settings formülüyle hesapla
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activity] || 1.0;
            const dietFormula = appSettings?.dietFormulas?.[dietType] || appSettings?.dietFormulas?.ketojenik;
            
            let targetCalories;
            if (dietFormula) {
                // Aktivite çarpanını da dahil et
                const protein = weight * dietFormula.protein * activityMultiplier;
                const carb = weight * dietFormula.carb * activityMultiplier;
                const fat = weight * dietFormula.fat * activityMultiplier;
                targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            } else {
                targetCalories = Math.round(weight * 22 * activityMultiplier);
            }
            
            console.log('🎯 Hedef Kalori:', targetCalories);
            console.log('📊 Toplam Şablon:', dayTemplates.length);
            
            // 🔍 Mevcut haftada manuel eklenmiş günleri kontrol et
            const currentWeek = weeks[currentWeekIndex];
            const existingDays = currentWeek.days || [];
            
            if (existingDays.length > 0) {
                // Manuel günler var - kullanıcıya sor
                const lastDay = existingDays[existingDays.length - 1];
                const lastDate = new Date(lastDay.date);
                const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                const lastDayName = dayNames[lastDate.getDay()];
                
                const confirmMessage = `📅 Bu haftada ${existingDays.length} gün manuel eklenmiş (Son: ${lastDayName}).\n\n` +
                    `🔄 Tüm haftayı yeniden planlayayım mı?\n` +
                    `   (Mevcut günler silinir, 7 günlük yeni plan oluşturulur)\n\n` +
                    `✅ Sadece eksik günleri tamamlayayım mı?\n` +
                    `   (${lastDayName} sonrası Pazar'a kadar olan günler eklenir)\n\n` +
                    `"OK" = Yeniden Planla | "İptal" = Eksik Günleri Tamamla`;
                
                const shouldReset = confirm(confirmMessage);
                
                if (shouldReset) {
                    // Yeniden planlama - mevcut günleri temizle
                    console.log('🔄 Hafta yeniden planlanıyor - mevcut günler temizleniyor...');
                    currentWeek.days = [];
                } else {
                    // Eksik günleri tamamlama
                    console.log('✅ Eksik günler tamamlanıyor...');
                }
            }
            
            // Son N haftada kullanılan şablonları topla (N = admin ayarlarından)
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            // Mevcut hafta dahil, son N haftayı kontrol et
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(day => {
                        if (day.templateId) {
                            recentlyUsedTemplateIds.add(day.templateId);
                        }
                    });
                }
            }
            
            console.log(`📅 Son ${templateReuseWeeks} haftada kullanılan şablon sayısı: ${recentlyUsedTemplateIds.size}`);
            
            // Şablonları filtrele
            const dietTypeFilter = dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : dietType;
            
            let availableTemplates = dayTemplates.filter(template => {
                // Son N haftada kullanılmış mı?
                if (recentlyUsedTemplateIds.has(template.id)) {
                    return false;
                }
                
                // Diyet tipi kontrolü - template.dietType undefined olabilir
                if (template.dietType && template.dietType !== dietTypeFilter) {
                    return false;
                }
                
                // İstenmeyen yemekler - sadece varsa kontrol et
                if (dislikedFoods.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => {
                            const foodName = yemek.foodName || yemek.originalText || '';
                            return dislikedFoods.some(disliked => 
                                foodName.toLowerCase().includes(disliked.toLowerCase())
                            );
                        })
                    );
                    if (hasDislikedFood) return false;
                }
                
                return true;
            });
            
            console.log(`✅ Filtrelenmiş Şablon (Son ${templateReuseWeeks} hafta hariç):`, availableTemplates.length);
            
            // Eğer kullanılabilir şablon kalmadıysa, tüm şablonları kullan (başa dön)
            if (availableTemplates.length === 0) {
                console.log('⚠️ Kullanılmamış şablon kalmadı, tüm şablonları kullanıma açıyoruz...');
                
                availableTemplates = dayTemplates.filter(template => {
                    // Sadece diyet tipi ve istenmeyen yemek kontrolü
                    if (template.dietType && template.dietType !== dietTypeFilter) {
                        return false;
                    }
                    
                    if (dislikedFoods.length > 0 && template.ogunler) {
                        const hasDislikedFood = template.ogunler.some(ogun => 
                            ogun.yemekler && ogun.yemekler.some(yemek => {
                                const foodName = yemek.foodName || yemek.originalText || '';
                                return dislikedFoods.some(disliked => 
                                    foodName.toLowerCase().includes(disliked.toLowerCase())
                                );
                            })
                        );
                        if (hasDislikedFood) return false;
                    }
                    
                    return true;
                });
                
                console.log('✅ Tüm uygun şablonlar:', availableTemplates.length);
                
                if (availableTemplates.length === 0) {
                    showToast('⚠️ Uygun menü bulunamadı. İstenmeyen yemekleri azaltmayı deneyin.', 'error');
                    return;
                }
            }
            
            // Hedef kaloriye göre mutlak değer farkıyla sırala (GÜNCEL hedef kaloriye göre)
            availableTemplates.sort((a, b) => {
                const diffA = Math.abs((a.totalMacros?.kalori || 0) - targetCalories);
                const diffB = Math.abs((b.totalMacros?.kalori || 0) - targetCalories);
                return diffA - diffB;
            });
            
            // Başlangıç tarihini belirle
            let startDate = new Date();
            
            if (existingDays.length > 0) {
                // Mevcut günler var - son günden sonraki günü başlat
                const lastDay = existingDays[existingDays.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
            } else if (currentWeek.startDate) {
                // Haftanın başlangıç tarihinden başla
                startDate = new Date(currentWeek.startDate);
            }
            
            console.log('📅 Başlangıç Tarihi:', startDate.toLocaleDateString('tr-TR'));
            console.log('📅 Gün:', ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][startDate.getDay()]);
            console.log('📊 Mevcut haftada gün sayısı:', existingDays.length);
            
            // Gün sayısı hesaplama
            const currentDayOfWeek = startDate.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
            
            let totalDays;
            if (existingDays.length === 0) {
                // Hafta boş - ilk hafta kuralı
                if (currentDayOfWeek === 1) {
                    // Pazartesi - tam hafta
                    totalDays = 7;
                    console.log('✅ Pazartesi başlangıcı - 7 gün eklenecek');
                } else {
                    // Diğer günler - o haftanın kalanı + tam hafta
                    const daysUntilMonday = currentDayOfWeek === 0 ? 1 : (8 - currentDayOfWeek);
                    totalDays = daysUntilMonday + 7;
                    console.log(`✅ ${['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][currentDayOfWeek]} başlangıcı - ${daysUntilMonday} + 7 = ${totalDays} gün eklenecek`);
                }
            } else {
                // Mevcut günler var - kullanıcı "eksik günleri tamamla" seçmiş
                // Son günden Pazar'a kadar olan günleri ekle
                const lastDayOfWeek = (startDate.getDay() + 6) % 7; // Cumartesi için 6
                if (currentDayOfWeek === 0) {
                    // Pazar'dayız, hafta tamamlandı
                    totalDays = 0;
                    console.log('✅ Hafta zaten tamamlanmış (Pazar)');
                } else {
                    // Pazar'a kadar kalan günler
                    totalDays = 7 - currentDayOfWeek;
                    console.log(`✅ Eksik günler tamamlanıyor - ${totalDays} gün eklenecek (${['', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][currentDayOfWeek]} → Pazar)`);
                }
            }
            
            console.log('📊 Eklenecek Gün Sayısı:', totalDays);
            
            if (totalDays === 0) {
                showToast('✅ Hafta zaten tamamlanmış!', 'success');
                return;
            }
            
            // Günleri oluştur
            const gunAdlari = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            const newDays = [];
            for (let i = 0; i < totalDays && i < availableTemplates.length; i++) {
                const template = availableTemplates[i];
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + i);
                
                // Şablon verilerini tam olarak kopyala
                const dayData = {
                    date: dayDate.toISOString().split('T')[0],
                    gunAdi: gunAdlari[dayDate.getDay()],
                    templateId: template.id,
                    templateName: template.name,
                    meals: template.ogunler ? JSON.parse(JSON.stringify(template.ogunler)) : [],
                    totalMacros: template.totalMacros ? JSON.parse(JSON.stringify(template.totalMacros)) : {
                        kalori: 0,
                        protein: 0,
                        karb: 0,
                        yag: 0
                    }
                };
                
                console.log(`📝 Gün ${i+1}:`, dayDate.toLocaleDateString('tr-TR'), '-', dayData.gunAdi, '-', template.name, '-', template.totalMacros?.kalori, 'kcal');
                
                newDays.push(dayData);
            }
            
            // Mevcut haftaya ekle
            currentWeek.days.push(...newDays);
            
            // Modal'ları kapat
            closeModal('autoWeekPlanModal');
            closeModal('addDayModal');
            
            // Sayfayı yenile
            renderWeekContent();
            
            // Verileri kaydet
            saveWeeks();
            
            // Bildirim göster
            showToast(`✨ ${newDays.length} günlük otomatik plan oluşturuldu! Hedef: ${targetCalories} kcal`, 'success');
        }

        // Global variables for sorting
        let currentSortField = null;
        let currentSortDirection = null;
        let filteredTemplates = [];

        // Load Day Templates with Filters
        function loadDayTemplates() {
            const tableContainer = document.getElementById('dayTemplateTable');
            tableContainer.innerHTML = '<div style="padding: 20px; text-align: center;">Şablonlar yükleniyor...</div>';

            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }

            // Filter templates based on settings
            filteredTemplates = dayTemplates.filter(template => {
                // Diet type filter (eliminasyonlu-ketojenik ve ketojenik aynı kabul edilir)
                if (settings.dietType && template.dietType) {
                    const settingsDiet = settings.dietType === 'eliminasyonlu-ketojenik' ? 'ketojenik' : settings.dietType;
                    if (template.dietType !== settingsDiet) {
                        return false;
                    }
                }

                // Calorie filter - min ve max aralığını kullan
                const calories = template.totalMacros?.kalori || 0;
                
                if (settings.minCalories > 0 && calories < settings.minCalories) {
                    return false;
                }
                
                if (settings.maxCalories > 0 && settings.maxCalories < 9999 && calories > settings.maxCalories) {
                    return false;
                }

                // Disliked foods filter
                if (settings.dislikedFoods.length > 0 && template.ogunler) {
                    const hasDislikedFood = template.ogunler.some(ogun => 
                        ogun.yemekler && ogun.yemekler.some(yemek => 
                            settings.dislikedFoods.some(disliked => 
                                yemek.foodName.toLowerCase().includes(disliked)
                            )
                        )
                    );
                    if (hasDislikedFood) return false;
                }

                return true;
            });

            if (filteredTemplates.length === 0) {
                tableContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Filtrelerinize uygun şablon bulunamadı</div>';
                return;
            }

            // Render table
            renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Render template table
        function renderTemplateTable(templates, usedTemplateIds) {
            const tableContainer = document.getElementById('dayTemplateTable');
            
            // Sıralama ok işaretlerini belirle
            const getSortIcon = (field) => {
                if (currentSortField === field) {
                    return currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc';
                }
                return 'sortable';
            };
            
            let tableHTML = `
                <table class="template-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Menüler</th>
                            <th style="width: 45%;">Öğünler</th>
                            <th style="width: 10%;" class="${getSortIcon('calories')}" onclick="toggleSort('calories')">Kalori</th>
                            <th style="width: 10%;" class="${getSortIcon('karb')}" onclick="toggleSort('karb')">Karb (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('protein')}" onclick="toggleSort('protein')">Protein (g)</th>
                            <th style="width: 10%;" class="${getSortIcon('yag')}" onclick="toggleSort('yag')">Yağ (g)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            templates.forEach((template, index) => {
                const macros = template.totalMacros || {};
                const isUsed = usedTemplateIds.has(template.id);
                const isSelected = selectedTemplates.some(st => st.templateId === template.id);
                
                // Yemek listesini oluştur (öğünlere göre)
                let mealsHTML = '';
                if (template.ogunler && template.ogunler.length > 0) {
                    const mealsList = template.ogunler.map(ogun => {
                        const foodNames = ogun.yemekler ? ogun.yemekler.map(y => y.foodName || y.originalText || '?').join(', ') : '';
                        return `<strong>${ogun.mealName || 'Öğün'}:</strong> ${foodNames}`;
                    }).join('<br>');
                    mealsHTML = mealsList;
                }
                
                // Row classes
                let rowClass = '';
                if (isSelected) rowClass += ' selected';
                if (isUsed) rowClass += ' used-template';
                
                tableHTML += `
                    <tr class="${rowClass}" data-template-id="${template.id}" onclick="selectTemplate('${template.id}')" style="cursor: pointer;">
                        <td>${template.name || `Şablon ${index + 1}`}</td>
                        <td class="meal-cell">${mealsHTML || 'Yemek bilgisi yok'}</td>
                        <td style="text-align: center;">${Math.round(macros.kalori || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.karb || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.protein || 0)}</td>
                        <td style="text-align: center;">${Math.round(macros.yag || 0)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            
            // Total count'u güncelle
            const totalElement = document.getElementById('totalCount');
            if (totalElement) {
                totalElement.textContent = templates.length;
            }
            
            // Akıllı filtreyi uygula (varsa)
            applySmartFilter();
        }

        // Akıllı filtreleme fonksiyonu
        function applySmartFilter() {
            const wantedInput = document.getElementById('wantedFoodsFilter');
            const unwantedInput = document.getElementById('unwantedFoodsFilter');
            
            if (!wantedInput || !unwantedInput) return;
            
            const wantedText = wantedInput.value.trim().toLowerCase();
            const unwantedText = unwantedInput.value.trim().toLowerCase();
            
            // Virgülle ayrılmış kelimeleri al
            const wantedKeywords = wantedText ? wantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            const unwantedKeywords = unwantedText ? unwantedText.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];
            
            const rows = document.querySelectorAll('.template-table tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const mealCell = row.querySelector('.meal-cell');
                if (!mealCell) return;
                
                const mealText = mealCell.textContent.toLowerCase();
                let shouldShow = true;
                
                // Pozitif filtreleme: TÜM istenen kelimeleri içermeli
                if (wantedKeywords.length > 0) {
                    const hasAllKeywords = wantedKeywords.every(keyword => mealText.includes(keyword));
                    if (!hasAllKeywords) {
                        shouldShow = false;
                    }
                }
                
                // Negatif filtreleme: HİÇBİR istenmeyen kelimeyi içermemeli
                if (shouldShow && unwantedKeywords.length > 0) {
                    const hasAnyUnwanted = unwantedKeywords.some(keyword => mealText.includes(keyword));
                    if (hasAnyUnwanted) {
                        shouldShow = false;
                    }
                }
                
                // Satırı göster/gizle
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // İstatistiği güncelle
            const statsElement = document.getElementById('visibleCount');
            const totalElement = document.getElementById('totalCount');
            if (statsElement) {
                statsElement.textContent = visibleCount;
            }
            if (totalElement) {
                totalElement.textContent = rows.length;
            }
        }

        // Toggle sort - başlığa tıklandığında sıralama yönünü değiştir
        function toggleSort(field) {
            // Aynı alana tekrar tıklanırsa yönü değiştir, farklı alana tıklanırsa artan sıralama yap
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            sortTemplates(field, currentSortDirection);
        }

        // Sort templates
        function sortTemplates(field, direction) {
            currentSortField = field;
            currentSortDirection = direction;
            
            const sortedTemplates = [...filteredTemplates].sort((a, b) => {
                let aValue, bValue;
                
                switch(field) {
                    case 'calories':
                        aValue = a.totalMacros?.kalori || 0;
                        bValue = b.totalMacros?.kalori || 0;
                        break;
                    case 'karb':
                        aValue = a.totalMacros?.karb || 0;
                        bValue = b.totalMacros?.karb || 0;
                        break;
                    case 'protein':
                        aValue = a.totalMacros?.protein || 0;
                        bValue = b.totalMacros?.protein || 0;
                        break;
                    case 'yag':
                        aValue = a.totalMacros?.yag || 0;
                        bValue = b.totalMacros?.yag || 0;
                        break;
                }
                
                if (direction === 'asc') {
                    return aValue - bValue;
                } else {
                    return bValue - aValue;
                }
            });
            
            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(sortedTemplates, usedTemplateIds);
        }

        // Reset sorting
        function resetTemplates() {
            currentSortField = null;
            currentSortDirection = null;
            
            // Aktif haftada kullanılan template ID'leri
            const usedTemplateIds = new Set();
            const activeWeek = weeks[currentWeekIndex];
            if (activeWeek && activeWeek.days) {
                activeWeek.days.forEach(day => {
                    if (day.templateId) {
                        usedTemplateIds.add(day.templateId);
                    }
                });
            }
            
            renderTemplateTable(filteredTemplates, usedTemplateIds);
        }

        // Multiple template selection
        let selectedTemplates = []; // Array of {templateId, order}

        function selectTemplate(templateId) {
            const template = dayTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            // Zaten seçili mi kontrol et
            const existingIndex = selectedTemplates.findIndex(st => st.templateId === templateId);
            
            if (existingIndex !== -1) {
                // Seçimi kaldır
                selectedTemplates.splice(existingIndex, 1);
            } else {
                // Seçime ekle
                selectedTemplates.push({
                    templateId: templateId,
                    template: template,
                    order: selectedTemplates.length + 1
                });
            }
            
            // UI'yi güncelle
            updateTemplateSelectionUI();
        }

        function updateTemplateSelectionUI() {
            // Tablo satırlarını güncelle
            const rows = document.querySelectorAll('.template-table tbody tr');
            rows.forEach(row => {
                const templateId = row.getAttribute('data-template-id');
                const isSelected = selectedTemplates.some(st => st.templateId === templateId);
                
                if (isSelected) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
            
            // Kaydet butonunu göster/gizle
            const saveBtn = document.getElementById('saveMultipleDaysBtn');
            if (selectedTemplates.length > 0) {
                saveBtn.style.display = 'block';
                saveBtn.textContent = `${selectedTemplates.length} Günü Kaydet`;
            } else {
                saveBtn.style.display = 'none';
            }
        }

        function updateSelectedTemplatesBand() {
            // Bu fonksiyon artık kullanılmıyor ama uyumluluk için boş bırakılıyor
        }

        function removeSelectedTemplate(index) {
            selectedTemplates.splice(index, 1);
            updateTemplateSelectionUI();
        }

        // Old single selection function - kept for compatibility
        let selectedTemplateId = null;

        function selectTemplateSingle(templateId) {
            selectedTemplateId = templateId;
            
            // Update UI
            const items = document.querySelectorAll('.template-item');
            items.forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // Save Day to Week
        function saveDayToWeek() {
            if (!selectedTemplateId) {
                showToast('Lütfen bir şablon seçin', 'error');
                return;
            }

            const dayName = document.getElementById('daySelect').value;
            const dayDate = document.getElementById('dayDate').value;
            const template = dayTemplates.find(t => t.id === selectedTemplateId);

            if (!template) {
                showToast('Şablon bulunamadı', 'error');
                return;
            }

            // Kullanıcının seçtiği gün adını kullan (şablonun gün adını değil)
            const newDay = {
                id: Date.now(),
                gunAdi: dayName,  // Kullanıcının seçtiği gün
                date: dayDate,
                templateId: template.id,
                templateName: template.name,
                totalCalories: template.totalCalories || 0,
                totalMacros: template.totalMacros || {},
                ogunler: template.ogunler || []
            };

            // Pazartesi günü eklendiyse ÖNCE yeni hafta kontrolü yap
            const shouldCreateNewWeek = checkShouldCreateNewWeek(dayName);
            
            if (shouldCreateNewWeek) {
                // Yeni hafta oluştur ve Pazartesi'yi oraya ekle
                const created = promptNewWeekCreation();
                if (created) {
                    // Yeni haftaya ekle
                    weeks[activeWeekIndex].days.push(newDay);
                    saveWeeks();
                    renderWeekContent();
                    closeModal('addDayModal');
                    showToast('Gün yeni haftaya eklendi');
                    return;
                }
            }

            // Normal akış - mevcut haftaya ekle
            weeks[activeWeekIndex].days.push(newDay);
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast('Gün eklendi');
        }

        // Save Multiple Days to Week
        function saveMultipleDaysToWeek() {
            if (selectedTemplates.length === 0) {
                showToast('Lütfen en az bir şablon seçin', 'error');
                return;
            }

            const currentWeek = weeks[currentWeekIndex];
            let startDate = new Date();
            
            // Başlangıç tarihini belirle
            if (currentWeek.days.length > 0) {
                const lastDay = currentWeek.days[currentWeek.days.length - 1];
                startDate = new Date(lastDay.date);
                startDate.setDate(startDate.getDate() + 1);
            } else if (currentWeek.startDate) {
                startDate = new Date(currentWeek.startDate);
            }

            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            let addedCount = 0;
            let currentWeekForAdding = currentWeekIndex;
            
            // Seçilen şablonları sırayla ekle
            for (let i = 0; i < selectedTemplates.length; i++) {
                const st = selectedTemplates[i];
                const template = st.template;
                
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayName = dayNames[date.getDay()];
                const dateStr = date.toISOString().split('T')[0];
                
                const newDay = {
                    id: Date.now() + i,
                    gunAdi: dayName,
                    date: dateStr,
                    templateId: template.id,
                    templateName: template.name,
                    totalCalories: template.totalCalories || 0,
                    totalMacros: template.totalMacros || {},
                    ogunler: template.ogunler || []
                };
                
                // Pazartesi günü mü ve yeni hafta gerekli mi kontrol et
                if (dayName === 'Pazartesi' && i > 0) {
                    const shouldCreateNewWeek = checkShouldCreateNewWeekForDate(currentWeekForAdding);
                    
                    if (shouldCreateNewWeek) {
                        // Yeni hafta oluştur (sessizce, confirm sorma)
                        const newWeekCreated = createNewWeekSilently(date);
                        if (newWeekCreated) {
                            currentWeekForAdding = weeks.length - 1;
                        }
                    }
                }
                
                weeks[currentWeekForAdding].days.push(newDay);
                addedCount++;
            }
            
            saveWeeks();
            renderWeekContent();
            closeModal('addDayModal');
            showToast(`${addedCount} gün başarıyla eklendi`);
            
            // Seçimleri temizle
            selectedTemplates = [];
        }

        // Check if new week should be created for specific week index
        function checkShouldCreateNewWeekForDate(weekIndex) {
            const targetWeek = weeks[weekIndex];
            
            // İlk hafta mı?
            if (weekIndex === 0) {
                const firstMondayIndex = targetWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                if (firstMondayIndex === -1) return false;
                
                const daysAfterFirstMonday = targetWeek.days.length - firstMondayIndex;
                if (daysAfterFirstMonday < 7) return false;
                
                return true;
            }
            
            return true;
        }

        // Create new week silently (without confirm)
        function createNewWeekSilently(startDate) {
            const weekNumber = weeks.length + 1;
            
            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            return true;
        }

        // Refresh Day Template - Kullanılmamış şablonlardan en yakın kalorili olanı seç
        function refreshDayTemplate(dayIndex) {
            const currentWeek = weeks[currentWeekIndex];
            const day = currentWeek.days[dayIndex];
            
            if (!day) {
                showToast('Gün bulunamadı', 'error');
                return;
            }
            
            // Hedef kalori hesapla (hasta bilgilerinden)
            const weightInput = document.getElementById('patientWeight');
            const activityInput = document.getElementById('activityLevel');
            const dietTypeInput = document.getElementById('dietType');
            
            const weight = parseFloat(weightInput?.value) || 70;
            const activityLevel = parseInt(activityInput?.value) || 3;
            const dietType = dietTypeInput?.value || 'ketojenik';
            
            // Admin ayarlarından formül al
            const dietFormula = appSettings?.dietFormulas?.[dietType] || { protein: 0.8, carb: 0.3, fat: 1.2 };
            const activityMultiplier = appSettings?.dietFormulas?.activityMultipliers?.[activityLevel] || 1.0;
            
            const protein = weight * dietFormula.protein * activityMultiplier;
            const carb = weight * dietFormula.carb * activityMultiplier;
            const fat = weight * dietFormula.fat * activityMultiplier;
            const targetCalories = Math.round((protein * 4) + (carb * 4) + (fat * 9));
            
            // Son N haftada kullanılan şablonları topla
            const templateReuseWeeks = appSettings?.templateReuseWeeks || 4;
            const recentlyUsedTemplateIds = new Set();
            
            const startWeekIndex = Math.max(0, currentWeekIndex - templateReuseWeeks + 1);
            for (let i = startWeekIndex; i <= currentWeekIndex; i++) {
                if (weeks[i] && weeks[i].days) {
                    weeks[i].days.forEach(d => {
                        if (d.templateId) {
                            recentlyUsedTemplateIds.add(d.templateId);
                        }
                    });
                }
            }
            
            // Kullanılmamış şablonları filtrele
            let unusedTemplates = dayTemplates.filter(t => {
                // Son N haftada kullanılmış mı?
                if (recentlyUsedTemplateIds.has(t.id)) {
                    return false;
                }
                // Diyet tipi uygun mu?
                if (t.dietType && t.dietType !== dietType) {
                    return false;
                }
                return true;
            });
            
            // Eğer kullanılmamış şablon kalmadıysa, tüm şablonları kullan (başa dön)
            if (unusedTemplates.length === 0) {
                console.log('⚠️ Refresh için kullanılmamış şablon kalmadı, tüm şablonları kullanıma açıyoruz...');
                
                unusedTemplates = dayTemplates.filter(t => {
                    // Sadece diyet tipi kontrolü
                    if (t.dietType && t.dietType !== dietType) {
                        return false;
                    }
                    return true;
                });
                
                if (unusedTemplates.length === 0) {
                    showToast('Diyet tipine uygun şablon bulunamadı', 'error');
                    return;
                }
            }
            
            // GÜNCEL hedef kaloriye göre en yakından en uzağa sırala
            unusedTemplates.sort((a, b) => {
                const diffA = Math.abs((a.totalMacros?.kalori || 0) - targetCalories);
                const diffB = Math.abs((b.totalMacros?.kalori || 0) - targetCalories);
                return diffA - diffB;
            });
            
            // En yakın şablonu al
            const newTemplate = unusedTemplates[0];
            
            console.log(`🔄 Refresh: Hedef ${targetCalories} kcal, Seçilen: ${newTemplate.name} (${newTemplate.totalMacros?.kalori} kcal, Fark: ${Math.abs((newTemplate.totalMacros?.kalori || 0) - targetCalories)} kcal)`);
            
            // Günü güncelle
            day.templateId = newTemplate.id;
            day.templateName = newTemplate.name;
            day.meals = newTemplate.ogunler ? JSON.parse(JSON.stringify(newTemplate.ogunler)) : [];
            day.ogunler = day.meals; // Geriye dönük uyumluluk
            day.totalMacros = newTemplate.totalMacros ? JSON.parse(JSON.stringify(newTemplate.totalMacros)) : {
                kalori: 0,
                protein: 0,
                karb: 0,
                yag: 0
            };
            
            // Kaydet ve göster
            saveWeeks();
            renderWeekContent();
            showToast(`${day.gunAdi} için yeni şablon: ${newTemplate.name}`, 'success');
            
            console.log(`🔄 ${day.gunAdi} güncellendi: ${newTemplate.name} (${newTemplate.totalMacros?.kalori} kcal)`);
        }

        // Check Should Create New Week
        function checkShouldCreateNewWeek(dayName) {
            // Pazartesi günü mü?
            if (dayName !== 'Pazartesi') return false;
            
            const currentWeek = weeks[currentWeekIndex];
            
            // İlk hafta mı?
            if (currentWeekIndex === 0) {
                // İlk haftada: İlk Pazartesi'den sonra 7 gün (Pazartesi-Pazar) tamamlanmış mı kontrol et
                
                // İlk Pazartesi'nin index'ini bul
                const firstMondayIndex = currentWeek.days.findIndex(d => d.gunAdi === 'Pazartesi');
                
                if (firstMondayIndex === -1) {
                    // Henüz hiç Pazartesi yok (bu eklenen ilk Pazartesi)
                    // Yeni hafta açma
                    return false;
                }
                
                // İlk Pazartesi'den sonraki gün sayısı
                const daysAfterFirstMonday = currentWeek.days.length - firstMondayIndex;
                
                // İlk Pazartesi'den sonra 7 gün tamamlandı mı? (Pazartesi dahil)
                if (daysAfterFirstMonday < 7) {
                    // Henüz 7 gün tamamlanmadı, yeni hafta açma
                    return false;
                }
                
                // 7 gün tamamlandı ve şimdi ikinci Pazartesi geldi - yeni hafta sor
                return true;
            }
            
            // İlk haftadan sonraki haftalar için: Her Pazartesi yeni hafta
            return true;
        }

        // Prompt New Week Creation
        function promptNewWeekCreation() {
            const currentWeek = weeks[currentWeekIndex];
            const nextWeekNumber = weeks.length + 1;
            
            // Son eklenen günün tarihini al (henüz eklenmedi, bu yüzden son gün bir önceki)
            const lastDay = currentWeek.days[currentWeek.days.length - 1];
            const lastDate = new Date(lastDay.date);
            
            // Bir sonraki Pazartesi (bir gün sonrası)
            const nextMonday = new Date(lastDate);
            nextMonday.setDate(nextMonday.getDate() + 1);
            
            // Bir sonraki Pazar (6 gün sonra)
            const nextSunday = new Date(nextMonday);
            nextSunday.setDate(nextSunday.getDate() + 6);
            
            // Türkçe tarih formatı
            const startStr = formatDateTurkish(nextMonday);
            const endStr = formatDateTurkish(nextSunday);
            
            const message = `${nextWeekNumber}. hafta eklenecek (${startStr} - ${endStr}). Eklemek ister misiniz?`;
            
            if (confirm(message)) {
                addNewWeekFromDate(nextMonday);
                return true; // Yeni hafta oluşturuldu
            }
            return false; // İptal edildi
        }

        // Add New Week From Specific Date
        function addNewWeekFromDate(startDate) {
            const weekNumber = weeks.length + 1;

            const newWeek = {
                id: Date.now(),
                name: `${weekNumber}. Hafta`,
                weekNumber: weekNumber,
                startDate: startDate.toISOString().split('T')[0],
                days: []
            };

            weeks.push(newWeek);
            saveWeeks();
            currentWeekIndex = weeks.length - 1;
            activeWeekIndex = weeks.length - 1;
            
            renderTabs();
            renderWeekContent();
            showToast('Yeni hafta eklendi');
        }

        // Format Date Turkish
        function formatDateTurkish(date) {
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                           'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openSettings() {
            // Hafta numarasına göre otomatik diyet türü öner
            const weekNumber = currentWeekIndex + 1;
            let suggestedDiet = 'ketojenik'; // Varsayılan
            
            if (weekNumber >= 1 && weekNumber <= 2) {
                suggestedDiet = 'eliminasyonlu-ketojenik';
            } else if (weekNumber >= 3 && weekNumber <= 9) {
                suggestedDiet = 'ketojenik';
            } else if (weekNumber >= 10 && weekNumber <= 14) {
                suggestedDiet = 'lowcarb';
            }
            
            // Eğer kullanıcı daha önce ayar yapmamışsa, öneriyi kullan
            if (!settings.dietType || settings.dietType === '') {
                settings.dietType = suggestedDiet;
            }
            
            applySettingsToForm();
            document.getElementById('settingsModal').classList.add('active');
            
            // Hafta bazlı öneriyi göster
            if (weekNumber <= 14) {
                console.log(`📋 ${weekNumber}. hafta için önerilen diyet: ${suggestedDiet}`);
            }
        }

        // Download All Data (for GitHub upload)
        function downloadAllData() {
            if (!currentPatient) {
                showToast('Hasta bilgisi bulunamadı', 'error');
                return;
            }

            // Download both settings and weeks
            NutritionDataManager.downloadAllData(
                currentPatient.id,
                currentPatient.name,
                { settings: settings },
                weeks
            );

            showToast('Veriler indirildi! Lütfen nutrition/ klasörüne yükleyin.');
        }

        // Logout
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                PatientAuth.logout();
                window.location.href = 'login.html';
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="auth.js"></script>
    <script>
        // Check if PatientAuth is loaded
        if (typeof PatientAuth === 'undefined') {
            console.error('❌ PatientAuth yüklenemedi!');
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545;">Kimlik doğrulama sistemi yüklenemedi</h3>
                    <p>Lütfen sayfayı yenileyin veya giriş sayfasına dönün.</p>
                    <button onclick="window.location.href='login.html'" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Giriş Sayfasına Dön
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
